<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–ö–∏–° –ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Telegram WebApp JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg-main: #f4f5f7;
            --bg-card: #ffffff;
            --accent: #007aff;
            --accent-soft: #e5f0ff;
            --border-subtle: #e5e7eb;
            --text-main: #111827;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --success: #16a34a;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-soft: 0 12px 32px rgba(15, 23, 42, 0.12);
            --shadow-tiny: 0 2px 10px rgba(15, 23, 42, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        button, input, select, textarea {
            font-family: inherit;
        }

        .app-shell {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom, #f9fafb, #edf1f7);
        }

        /* TOP SAFE AREA (–¥–ª—è iOS) */
        .safe-top {
            height: env(safe-area-inset-top);
        }

        /* HEADER */
        .header {
            padding: 16px 16px 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .emblem {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: #ffffff;
            box-shadow: var(--shadow-tiny);
            background-image: url('gerb-karaganda.png'); /* –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –≥–µ—Ä–±—É */
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .header-text {
            flex: 1;
        }

        .header-title {
            font-size: 15px;
            font-weight: 600;
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .current-role-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .current-role-value {
            font-size: 12px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .pill-ghost {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 4px 10px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.9);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .pill-ghost span.icon {
            font-size: 13px;
        }

        /* MAIN CONTENT AREA */
        .main {
            flex: 1;
            padding: 4px 12px 80px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* HOMESCREEN BUTTON GRID */
        .grid-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        @media (min-width: 400px) {
            .grid-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }

        .tile-button {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 14px 12px;
            box-shadow: var(--shadow-tiny);
            border: 1px solid rgba(209, 213, 219, 0.8);
            display: flex;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
        }

        .tile-button:active {
            transform: scale(0.97);
            box-shadow: 0 4px 18px rgba(15, 23, 42, 0.16);
        }

        .tile-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tile-icon {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-soft);
            font-size: 15px;
        }

        .tile-title {
            font-size: 13px;
            font-weight: 600;
        }

        .tile-caption {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* CARDS / LISTS */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px 12px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(229, 231, 235, 0.9);
        }

        .card-title-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
            gap: 8px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #e5e7eb;
            color: #374151;
        }

        /* TASKS LIST */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-card {
            background: #ffffff;
            border-radius: var(--radius-md);
            padding: 10px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-tiny);
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
        }

        .task-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .task-title {
            font-size: 13px;
            font-weight: 500;
        }

        .task-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .badge-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-status.new {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .badge-status.in_progress {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-status.done {
            background: #ecfdf3;
            color: #166534;
        }

        .badge-status.overdue {
            background: #fef2f2;
            color: #b91c1c;
        }

        .badge-deadline {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #f3f4f6;
            color: #374151;
        }

        /* FILTER ROW */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .input, .select, .textarea {
            font-size: 13px;
            padding: 7px 9px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            background: #ffffff;
            width: 100%;
        }

        .textarea {
            resize: vertical;
            min-height: 70px;
        }

        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(59,130,246,0.35);
        }

        label.field-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .field-group {
            margin-bottom: 10px;
        }

        /* BUTTONS */
        .btn {
            border-radius: 999px;
            border: none;
            padding: 9px 14px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            background: var(--accent);
            color: #ffffff;
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
        }

        .btn.secondary {
            background: #ffffff;
            color: var(--text-main);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-tiny);
        }

        .btn.ghost {
            background: transparent;
            color: var(--text-muted);
            border: none;
            box-shadow: none;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        }

        .btn[disabled] {
            opacity: 0.5;
            box-shadow: none;
            cursor: default;
        }

        /* BOTTOM NAVBAR */
        .bottom-nav-wrapper {
            position: fixed;
            bottom: env(safe-area-inset-bottom);
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            padding: 0 8px 6px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .bottom-nav {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(229, 231, 235, 0.9);
            padding: 4px 4px 2px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-item {
            flex: 1;
            border-radius: 999px;
            padding: 4px 4px 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            cursor: pointer;
        }

        .nav-item span.icon {
            font-size: 18px;
        }

        .nav-item span.label {
            font-size: 10px;
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.08);
        }

        .nav-item.active span.label {
            color: var(--accent);
            font-weight: 500;
        }

        /* MODALS (iOS-style sheets) */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.28);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 50;
        }

        .modal-backdrop.visible {
            display: flex;
        }

        .modal-sheet {
            width: 100%;
            max-width: 480px;
            background: #f9fafb;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -12px 34px rgba(15, 23, 42, 0.45);
            padding: 10px 14px 16px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
        }

        .modal-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .modal-close {
            border-radius: 999px;
            border: none;
            background: #e5e7eb;
            width: 26px;
            height: 26px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* FULLSCREEN ROLE MODAL */
        .role-modal-fullscreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom, #ffffff, #e5edff);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
            padding: 24px 18px 18px;
            z-index: 60;
        }

        .role-modal-fullscreen.visible {
            display: flex;
        }

        .role-logo {
            width: 70px;
            height: 70px;
            border-radius: 24px;
            margin: 0 auto 14px;
            background: #ffffff;
            box-shadow: 0 16px 42px rgba(37, 99, 235, 0.35);
            background-image: url('gerb-karaganda.png'); /* –≥–µ—Ä–± */
            background-size: cover;
            background-position: center;
        }

        .role-title {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .role-subtitle {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .role-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 14px 12px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(209, 213, 219, 0.85);
        }

        .role-helper {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        /* TABLE BUILDER */
        .table-builder {
            background: #ffffff;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            padding: 8px;
            margin-top: 4px;
        }

        .table-builder-header {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }

        .table-builder-title {
            font-size: 12px;
            font-weight: 500;
        }

        .table-builder-actions {
            display: flex;
            gap: 4px;
        }

        .btn-mini {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: #f9fafb;
            cursor: pointer;
        }

        .btn-mini:active {
            transform: translateY(1px);
        }

        .columns-config {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 6px;
        }

        .column-config-row {
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr) auto;
            gap: 4px;
            align-items: center;
        }

        .column-config-row small {
            font-size: 10px;
            color: var(--text-muted);
        }

        .btn-icon-small {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .table-preview-wrapper {
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            overflow: auto;
            max-height: 220px;
        }

        table.builder-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 100%;
            font-size: 11px;
        }

        .builder-table th,
        .builder-table td {
            border: 1px solid #e5e7eb;
            padding: 4px;
            text-align: left;
        }

        .builder-table th {
            background: #f9fafb;
            font-weight: 500;
        }

        .builder-input {
            width: 100%;
            border: none;
            font-size: 11px;
            padding: 2px 3px;
            background: transparent;
        }

        .builder-input:focus {
            outline: none;
            background: #eef2ff;
        }

        .builder-footer {
            background: #f3f4f6;
        }

        .sum-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* AI / EVENTS / SECTIONS / RESULTS */
        .pill-switch {
            display: inline-flex;
            padding: 3px;
            background: #e5e7eb;
            border-radius: 999px;
            gap: 3px;
            margin-bottom: 8px;
        }

        .pill-switch button {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            font-size: 11px;
            background: transparent;
            cursor: pointer;
        }

        .pill-switch button.active {
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.18);
        }

        .list-simple {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .list-item-simple {
            background: #ffffff;
            border-radius: var(--radius-md);
            padding: 8px 10px;
            border: 1px solid var(--border-subtle);
        }

        .list-item-title {
            font-size: 13px;
            font-weight: 500;
        }

        .list-item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* CHAT-like for AI */
        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .ai-chip {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            background: #ffffff;
        }

        .ai-chat-window {
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            padding: 8px;
            background: #ffffff;
            max-height: 260px;
            overflow-y: auto;
            font-size: 12px;
        }

        .ai-msg {
            margin-bottom: 6px;
        }

        .ai-msg-user {
            text-align: right;
        }

        .ai-msg-user span {
            display: inline-block;
            background: #dbeafe;
            border-radius: 999px;
            padding: 4px 8px;
        }

        .ai-msg-bot span {
            display: inline-block;
            background: #f3f4f6;
            border-radius: 999px;
            padding: 4px 8px;
        }

        .ai-input-row {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .ai-input-row input {
            flex: 1;
        }

        /* PROFILE */
        .profile-list {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .profile-row span.label {
            color: var(--text-muted);
        }

        .helper-text {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* SMALL TEXTS */
        .muted-small {
            font-size: 11px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
<div class="app-shell">
    <div class="safe-top"></div>

    <!-- HEADER -->
    <header class="header">
        <div class="emblem"></div>
        <div class="header-text">
            <div class="header-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–ö–∏–° –ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</div>
            <div class="header-subtitle">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Ä—É—á–µ–Ω–∏–π –∏ –ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å</div>
            <div class="current-role-label">
                –í—Ö–æ–¥ –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:
                <span class="current-role-value" id="headerCurrentRole">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="pill-ghost" id="btnOpenProfileFromHeader">
                <span class="icon">üë§</span>
                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- HOME SCREEN -->
        <section id="screen-home" class="screen active">
            <div class="card">
                <div class="card-title-row">
                    <div>
                        <div class="card-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                        <div class="card-subtitle">–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º</div>
                    </div>
                    <div class="chip" id="chipRoleSummary">–†–æ–ª—å: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
                </div>
                <div class="grid-buttons">
                    <div class="tile-button" id="btnOpenNewTask">
                        <div class="tile-header">
                            <div class="tile-icon">üìù</div>
                            <div class="tile-title">–°–æ–∑–¥–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏–µ</div>
                        </div>
                        <div class="tile-caption">–° —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è, –¥–µ–¥–ª–∞–π–Ω–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã</div>
                    </div>

                    <div class="tile-button" id="btnGotoTasksScreen">
                        <div class="tile-header">
                            <div class="tile-icon">üìã</div>
                            <div class="tile-title">–ü–æ—Ä—É—á–µ–Ω–∏—è –∏ –æ—Ç—á—ë—Ç—ã</div>
                        </div>
                        <div class="tile-caption">–†–µ–µ—Å—Ç—Ä –ø–æ—Ä—É—á–µ–Ω–∏–π –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º</div>
                    </div>

                    <div class="tile-button" id="btnGotoAiScreen">
                        <div class="tile-header">
                            <div class="tile-icon">ü§ñ</div>
                            <div class="tile-title">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
                        </div>
                        <div class="tile-caption">–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞—Å–µ–ª–µ–Ω–∏—è –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                    </div>

                    <div class="tile-button" id="btnGotoEventsScreen">
                        <div class="tile-header">
                            <div class="tile-icon">üìÖ</div>
                            <div class="tile-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
                        </div>
                        <div class="tile-caption">–ö–∞–ª–µ–Ω–¥–∞—Ä—å, —Å–µ–∫—Ü–∏–∏, —Ç—Ä–µ–Ω–µ—Ä—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
                    </div>

                    <div class="tile-button" id="btnGotoProfileScreen">
                        <div class="tile-header">
                            <div class="tile-icon">‚öôÔ∏è</div>
                            <div class="tile-title">–ü—Ä–æ—Ñ–∏–ª—å –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</div>
                        </div>
                        <div class="tile-caption">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
                    </div>

                    <div class="tile-button" id="btnGuestInfo">
                        <div class="tile-header">
                            <div class="tile-icon">üë•</div>
                            <div class="tile-title">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ—Å—Ç—è</div>
                        </div>
                        <div class="tile-caption">–î–ª—è –Ω–∞—Å–µ–ª–µ–Ω–∏—è: —Å–µ–∫—Ü–∏–∏, —Å–æ–æ—Ä—É–∂–µ–Ω–∏—è, —Å–ø–æ—Ä—Ç</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TASKS SCREEN -->
        <section id="screen-tasks" class="screen">
            <div class="card">
                <div class="card-title-row">
                    <div>
                        <div class="card-title">–†–µ–µ—Å—Ç—Ä –ø–æ—Ä—É—á–µ–Ω–∏–π</div>
                        <div class="card-subtitle">–ü–æ—Ä—É—á–µ–Ω–∏—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</div>
                    </div>
                    <button class="btn secondary" id="btnNewTaskFromTasks">‚ûï –ü–æ—Ä—É—á–µ–Ω–∏–µ</button>
                </div>

                <div class="filter-row">
                    <select class="select" id="filterStatus">
                        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="new">–ù–æ–≤–æ–µ</option>
                        <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="done">–ò—Å–ø–æ–ª–Ω–µ–Ω–æ</option>
                        <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
                    </select>
                    <input class="input" id="filterText" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –ø–æ—Ä—É—á–µ–Ω–∏—è..." />
                </div>

                <div class="tasks-list" id="tasksList">
                    <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>
                <div class="muted-small" style="margin-top:8px;">
                    –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏—è –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ì–æ—Å—Ç–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
                </div>
            </div>
        </section>

        <!-- EVENTS / SECTIONS / RESULTS -->
        <section id="screen-events" class="screen">
            <div class="card">
                <div class="card-title-row">
                    <div>
                        <div class="card-title">–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –∂–∏–∑–Ω—å —Ä–µ–≥–∏–æ–Ω–∞</div>
                        <div class="card-subtitle">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Å–µ–∫—Ü–∏–∏, —Ç—Ä–µ–Ω–µ—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</div>
                    </div>
                </div>

                <div class="pill-switch">
                    <button id="tabEvents" class="active">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</button>
                    <button id="tabSections">–°–µ–∫—Ü–∏–∏ –∏ —Ç—Ä–µ–Ω–µ—Ä—ã</button>
                    <button id="tabResults">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                </div>

                <!-- EVENTS -->
                <div id="eventsPanel">
                    <div class="list-simple" id="eventsList">
                        <!-- –¥–µ–º–æ-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
                    </div>
                </div>

                <!-- SECTIONS -->
                <div id="sectionsPanel" style="display:none;">
                    <div class="list-simple" id="sectionsList">
                        <!-- –¥–µ–º–æ-—Å–µ–∫—Ü–∏–∏ -->
                    </div>
                </div>

                <!-- RESULTS -->
                <div id="resultsPanel" style="display:none;">
                    <div class="list-simple" id="resultsList">
                        <!-- –¥–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                    </div>
                </div>
            </div>
        </section>

        <!-- AI SCREEN -->
        <section id="screen-ai" class="screen">
            <div class="card">
                <div class="card-title-row">
                    <div>
                        <div class="card-title">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
                        <div class="card-subtitle">–í–æ–ø—Ä–æ—Å—ã –ø–æ —Å–ø–æ—Ä—Ç—É, –æ–±—ä–µ–∫—Ç–∞–º –∏ –ø—Ä–æ–µ–∫—Ç–∞–º –æ–±–ª–∞—Å—Ç–∏</div>
                    </div>
                </div>

                <div class="ai-suggestions">
                    <div class="ai-chip" data-q="–°–∫–æ–ª—å–∫–æ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π –≤ –æ–±–ª–∞—Å—Ç–∏?">–°–∫–æ–ª—å–∫–æ —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π –≤ –æ–±–ª–∞—Å—Ç–∏?</div>
                    <div class="ai-chip" data-q="–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–µ–∫—Ç —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞?">–°—Ç–∞–¥–∏—è —Å–ø–æ—Ä—Ç–∫–ª–∞—Å—Ç–µ—Ä–∞?</div>
                    <div class="ai-chip" data-q="–ö–∞–∫–∏–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –µ—Å—Ç—å –¥–ª—è –¥–µ—Ç–µ–π?">–°–µ–∫—Ü–∏–∏ –¥–ª—è –¥–µ—Ç–µ–π</div>
                    <div class="ai-chip" data-q="–ß—Ç–æ —Å–µ–π—á–∞—Å —Å—Ç—Ä–æ–∏—Ç—Å—è –≤ —Å—Ñ–µ—Ä–µ —Å–ø–æ—Ä—Ç–∞?">–ß—Ç–æ —Å—Ç—Ä–æ–∏—Ç—Å—è?</div>
                    <div class="ai-chip" data-q="–ì–¥–µ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –¥–≤–æ—Ä–µ—Ü —Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ —Å—Ç–∞–¥–∏–æ–Ω —Ä—è–¥–æ–º?">–ë–ª–∏–∂–∞–π—à–∏–µ –æ–±—ä–µ–∫—Ç—ã</div>
                </div>

                <div class="ai-chat-window" id="aiChat">
                    <div class="ai-msg ai-msg-bot"><span>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –§–ö–∏–° –ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã—à–µ.</span></div>
                </div>

                <div class="ai-input-row">
                    <input class="input" id="aiInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ —Å–ø–æ—Ä—Ç—É, –æ–±—ä–µ–∫—Ç–∞–º, —Å–µ–∫—Ü–∏—è–º..." />
                    <button class="btn" id="aiSendBtn">‚û§</button>
                </div>
                <div class="muted-small" style="margin-top:4px;">
                    –í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤–∞—à —Å–µ—Ä–≤–µ—Ä –∏ –ò–ò-–º–æ–¥–µ–ª—å —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
                </div>
            </div>
        </section>

        <!-- PROFILE SCREEN -->
        <section id="screen-profile" class="screen">
            <div class="card">
                <div class="card-title-row">
                    <div>
                        <div class="card-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                        <div class="card-subtitle">–î–æ–ª–∂–Ω–æ—Å—Ç—å, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</div>
                    </div>
                </div>

                <div class="profile-list">
                    <div class="profile-row">
                        <span class="label">–ò–º—è (–∏–∑ Telegram)</span>
                        <span id="profileName">‚Äì</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å</span>
                        <span id="profileRole">‚Äì</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</span>
                        <span id="profileOrg">‚Äì</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞</span>
                        <span id="profileAccess">‚Äì</span>
                    </div>
                </div>

                <div style="margin-top:12px; display:flex; flex-direction:column; gap:6px;">
                    <button class="btn secondary" id="btnChangeRole">–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</button>
                    <button class="btn ghost" id="btnResetToGuest">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                </div>
                <div class="helper-text" style="margin-top:8px;">
                    –°–º–µ–Ω–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å. –ì–æ—Å—Ç—å –≤–∏–¥–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã (–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Å–µ–∫—Ü–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã).
                </div>
            </div>
        </section>
    </main>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav-wrapper">
        <nav class="bottom-nav">
            <div class="nav-item active" data-screen="home">
                <span class="icon">üè†</span>
                <span class="label">–ì–ª–∞–≤–Ω–∞—è</span>
            </div>
            <div class="nav-item" data-screen="tasks">
                <span class="icon">üìù</span>
                <span class="label">–ü–æ—Ä—É—á–µ–Ω–∏—è</span>
            </div>
            <div class="nav-item" data-screen="events">
                <span class="icon">üìÖ</span>
                <span class="label">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</span>
            </div>
            <div class="nav-item" data-screen="ai">
                <span class="icon">ü§ñ</span>
                <span class="label">–ò–ò</span>
            </div>
            <div class="nav-item" data-screen="profile">
                <span class="icon">üë§</span>
                <span class="label">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </div>
        </nav>
    </div>
</div>

<!-- FULLSCREEN ROLE MODAL -->
<div class="role-modal-fullscreen" id="roleModal">
    <div class="role-logo"></div>
    <div class="role-title">–í—ã–±–æ—Ä –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
    <div class="role-subtitle">–î–ª—è —Ä–∞–±–æ—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å. –î–ª—è –Ω–∞—Å–µ–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å.</div>

    <div class="role-form">
        <div class="field-group">
            <div class="role-helper">–î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
            <select class="select" id="roleSelect">
                <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </select>
        </div>

        <div class="field-group">
            <div class="role-helper">–ü–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è / –æ—Ç–¥–µ–ª —Å–ø–æ—Ä—Ç–∞</div>
            <select class="select" id="orgSelect">
                <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </select>
        </div>

        <div class="field-group">
            <button class="btn" id="btnConfirmRole">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
        <div class="helper-text">
            –ï—Å–ª–∏ –≤—ã –Ω–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å ¬´–ì–æ—Å—Ç—å¬ª. –í—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Å–µ–∫—Ü–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤.
        </div>
    </div>
</div>

<!-- MODALS (BOTTOM SHEETS) -->
<div class="modal-backdrop" id="modalNewTaskBackdrop">
    <div class="modal-sheet">
        <div class="modal-header">
            <div>
                <div class="modal-title">–ù–æ–≤–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ</div>
                <div class="modal-subtitle">–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è, —Ç–µ–∫—Å—Ç, –¥–µ–¥–ª–∞–π–Ω –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—É</div>
            </div>
            <button class="modal-close" data-close="modalNewTaskBackdrop">‚úï</button>
        </div>

        <div class="field-group">
            <label class="field-label">–¢–∏–ø –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
            <div style="display:flex; gap:6px;">
                <button class="btn-mini" data-recipient-type="person" id="btnRecipientPerson">üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
                <button class="btn-mini" data-recipient-type="org" id="btnRecipientOrg">üèõ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</button>
            </div>
        </div>

        <div class="field-group" id="recipientPersonGroup">
            <label class="field-label" for="recipientPersonSelect">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
            <select class="select" id="recipientPersonSelect">
                <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </select>
        </div>

        <div class="field-group" id="recipientOrgGroup" style="display:none;">
            <label class="field-label" for="recipientOrgSelect">–ü–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
            <select class="select" id="recipientOrgSelect">
                <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </select>
        </div>

        <div class="field-group">
            <label class="field-label" for="taskText">–¢–µ–∫—Å—Ç –ø–æ—Ä—É—á–µ–Ω–∏—è</label>
            <textarea class="textarea" id="taskText" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Å—É—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏—è..."></textarea>
        </div>

        <div class="field-group">
            <label class="field-label" for="taskDeadline">–î–µ–¥–ª–∞–π–Ω</label>
            <input class="input" type="date" id="taskDeadline" />
            <div class="muted-small" id="deadlineCountdownText"></div>
        </div>

        <!-- TABLE BUILDER -->
        <div class="field-group">
            <label class="field-label">–¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <div class="table-builder">
                <div class="table-builder-header">
                    <div class="table-builder-title">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç–∞–±–ª–∏—Ü—ã</div>
                    <div class="table-builder-actions">
                        <button class="btn-mini" id="btnAddColumn">+ –∫–æ–ª–æ–Ω–∫–∞</button>
                        <button class="btn-mini" id="btnAddRow">+ —Å—Ç—Ä–æ–∫–∞</button>
                        <button class="btn-mini" id="btnClearTable">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <div class="columns-config" id="columnsConfig">
                    <!-- –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–ª–æ–Ω–æ–∫ -->
                </div>

                <div class="table-preview-wrapper">
                    <table class="builder-table" id="builderTable">
                        <!-- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                    </table>
                </div>

                <div class="muted-small" style="margin-top:4px;">
                    –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ç–æ–ª–±—Ü—ã –∏ —Å—Ç—Ä–æ–∫–∏, –º–µ–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫, –≤—ã–±–∏—Ä–∞—Ç—å —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–∫—Å—Ç, —á–∏—Å–ª–æ, –¥–∞—Ç–∞).
                    –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Å—á—ë—Ç —Å—É–º–º—ã –ø–æ —Å—Ç–æ–ª–±—Ü—É.
                </div>
            </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn secondary" data-close="modalNewTaskBackdrop">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn" id="btnSaveTask">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- TASK DETAILS MODAL -->
<div class="modal-backdrop" id="modalTaskDetailsBackdrop">
    <div class="modal-sheet">
        <div class="modal-header">
            <div>
                <div class="modal-title" id="taskDetailsTitle">–ü–æ—Ä—É—á–µ–Ω–∏–µ</div>
                <div class="modal-subtitle" id="taskDetailsMeta"></div>
            </div>
            <button class="modal-close" data-close="modalTaskDetailsBackdrop">‚úï</button>
        </div>

        <div class="field-group">
            <label class="field-label">–¢–µ–∫—Å—Ç –ø–æ—Ä—É—á–µ–Ω–∏—è</label>
            <div class="muted-small" id="taskDetailsText"></div>
        </div>

        <div class="field-group">
            <label class="field-label">–°—Ç–∞—Ç—É—Å</label>
            <select class="select" id="taskDetailsStatus">
                <option value="new">–ù–æ–≤–æ–µ</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ò—Å–ø–æ–ª–Ω–µ–Ω–æ</option>
                <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
            </select>
        </div>

        <div class="field-group">
            <label class="field-label">–¢–∞–±–ª–∏—Ü–∞</label>
            <div class="table-preview-wrapper">
                <table class="builder-table" id="taskDetailsTable">
                    <!-- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </table>
            </div>
            <div class="muted-small">
                –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
            </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn secondary" data-close="modalTaskDetailsBackdrop">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button class="btn" id="btnUpdateTaskStatus">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    // -------------
    // –î–ê–ù–ù–´–ï –†–û–õ–ï–ô –ò –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ô
    // -------------
    const roles = [
        { id: 'guest', label: '–ì–æ—Å—Ç—å (–Ω–∞—Å–µ–ª–µ–Ω–∏–µ)', person: '–ü—É–±–ª–∏—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', access: '–ü—É–±–ª–∏—á–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã: –ò–ò, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Å–µ–∫—Ü–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã' },

        { id: 'head', label: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', person: '–°–∞–ø–∏–µ–≤ –°.–ñ.', access: '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø: –ø–æ—Ä—É—á–µ–Ω–∏—è, –æ—Ç—á—ë—Ç—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å' },
        { id: 'deputy', label: '–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', person: '–ï—Å–∏–º—Ö–∞–Ω–æ–≤ –î.–ñ.', access: '–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏–π –≤ —Å–≤–æ–µ–π –∑–æ–Ω–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏' },
        { id: 'hr_main', label: '–ì–ª–∞–≤–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞–¥—Ä–æ–≤—ã–º –≤–æ–ø—Ä–æ—Å–∞–º', person: '–ñ–∞–∫–∞–µ–≤–∞ –ñ.–¢.', access: '–ö–∞–¥—Ä–æ–≤—ã–µ –ø–æ—Ä—É—á–µ–Ω–∏—è –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å' },
        { id: 'legal_main', label: '–ì–ª–∞–≤–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –æ—Ä–≥.-–ø—Ä–∞–≤–æ–≤–æ–π —Ä–∞–±–æ—Ç–µ', person: '–¢–∞–∫–∏—Ä–æ–≤–∞ –®.–†.', access: '–û—Ä–≥.-–ø—Ä–∞–≤–æ–≤—ã–µ –ø–æ—Ä—É—á–µ–Ω–∏—è, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è' },
        { id: 'eco_head', label: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è', person: '–ö—É–º–∏—Å–±–µ–∫ –ê.–ê.', access: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ä—É—á–µ–Ω–∏—è, –ª–∏–º–∏—Ç—ã, –æ—Ç—á—ë—Ç—ã' },
        { id: 'highsport_head', label: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ —Å–ø–æ—Ä—Ç–∞ –≤—ã—Å—à–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞', person: '–ù–æ–∫–∏–Ω –î.–ë.', access: '–ü–æ—Ä—É—á–µ–Ω–∏—è –ø–æ —Å–ø–æ—Ä—Ç—É –≤—ã—Å—à–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π' },
        { id: 'mass_head', label: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ —Ñ–∏–∑–∫—É–ª—å—Ç—É—Ä–Ω–æ-–º–∞—Å—Å–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã', person: '”ò—à—ñ—Ä–±–µ–∫ –ù.–ñ.', access: '–ü–æ—Ä—É—á–µ–Ω–∏—è –ø–æ –º–∞—Å—Å–æ–≤–æ–º—É —Å–ø–æ—Ä—Ç—É –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º' },

        { id: 'mass_spec_main', label: '–ì–ª–∞–≤–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ä–∞–∑–≤–∏—Ç–∏—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏ –∏–Ω–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Å–ø–æ—Ä—Ç–∞', person: '–¢–ª–µ—É–±–µ–∫–æ–≤ –†.–ú.', access: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –º–∞—Å—Å–æ–≤–æ–º—É –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–º—É —Å–ø–æ—Ä—Ç—É' },
        { id: 'infra_spec_main', label: '–ì–ª–∞–≤–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ä–∞–∑–≤–∏—Ç–∏—è —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã', person: '–£—Å–µ–Ω–±–µ–∫–æ–≤ –°.–°.', access: '–ü–æ—Ä—É—á–µ–Ω–∏—è –ø–æ –æ–±—ä–µ–∫—Ç–∞–º, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –ø–∞—Å–ø–æ—Ä—Ç–∞–º' },

        // –ü—Ä–∏–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        { id: 'infra_attached_kasenov', label: '–ü—Ä–∏–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ä–∞–∑–≤–∏—Ç–∏—è —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã', person: '–ö–∞—Å–µ–Ω–æ–≤ –ï.–ö.', access: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏–π –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ' },
        { id: 'infra_attached_zhapparova', label: '–ü—Ä–∏–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ä–∞–∑–≤–∏—Ç–∏—è —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã', person: '–ñ–∞–ø–ø–∞—Ä–æ–≤–∞ –ö.–¢.', access: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏–π –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ' },
        { id: 'nat_sport_attached', label: '–ü—Ä–∏–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ä–∞–∑–≤–∏—Ç–∏—è –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–æ–≤ —Å–ø–æ—Ä—Ç–∞', person: '–ï—Å–º–∞–≥–∞–º–±–µ—Ç–æ–≤ –ú.–ú.', access: '–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏–π –ø–æ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤–∏–¥–∞–º —Å–ø–æ—Ä—Ç–∞' },
    ];

    // –ü–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: 41 + 13 –æ—Ç–¥–µ–ª–æ–≤ —Å–ø–æ—Ä—Ç–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ = 54
    const orgs = [
        // 13 –æ—Ç–¥–µ–ª–æ–≤ —Å–ø–æ—Ä—Ç–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤
        { id: 'dept_karaganda', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –≥. –ö–∞—Ä–∞–≥–∞–Ω–¥–∞' },
        { id: 'dept_temirtau', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –≥. –¢–µ–º–∏—Ä—Ç–∞—É' },
        { id: 'dept_balkhash', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –≥. –ë–∞–ª—Ö–∞—à' },
        { id: 'dept_saran', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –≥. –°–∞—Ä–∞–Ω—å' },
        { id: 'dept_sakhtinsk', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –≥. –®–∞—Ö—Ç–∏–Ω—Å–∫' },
        { id: 'dept_priozersk', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –≥. –ü—Ä–∏–æ–∑–µ—Ä—Å–∫' },
        { id: 'dept_abai', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –ê–±–∞–π—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },
        { id: 'dept_aktogai', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –ê–∫—Ç–æ–≥–∞–π—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },
        { id: 'dept_bukhar', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –ë—É—Ö–∞—Ä-–∂—ã—Ä–∞—É—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },
        { id: 'dept_karkaraly', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –ö–∞—Ä–∫–∞—Ä–∞–ª–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },
        { id: 'dept_osakarov', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –û—Å–∞–∫–∞—Ä–æ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },
        { id: 'dept_nura', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –ù—É—Ä–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },
        { id: 'dept_shet', name: '–û—Ç–¥–µ–ª —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –∏ —Å–ø–æ—Ä—Ç–∞ –®–µ—Ç—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞' },

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:
        // 13 –û–°–î–Æ–®–û–†
        ...Array.from({ length: 13 }, (_, i) => ({
            id: `osdyushor_${i + 1}`,
            name: `–û–°–î–Æ–®–û–† ‚Ññ${i + 1}`
        })),
        // 8 –°–î–Æ–®–û–†
        ...Array.from({ length: 8 }, (_, i) => ({
            id: `sdyushor_${i + 1}`,
            name: `–°–î–Æ–®–û–† ‚Ññ${i + 1}`
        })),
        // 14 –î–Æ–°–®
        ...Array.from({ length: 14 }, (_, i) => ({
            id: `dyussh_${i + 1}`,
            name: `–î–Æ–°–® ‚Ññ${i + 1}`
        })),
        { id: 'osshikor', name: '–û–°–®–ò–ö–û–†' },
        { id: 'cpore', name: '–¶–ü–û–†' },
        { id: 'shvsm_olymp', name: '–®–í–°–ú –ø–æ –æ–ª–∏–º–ø–∏–π—Å–∫–∏–º –≤–∏–¥–∞–º —Å–ø–æ—Ä—Ç–∞' },
        { id: 'shvsm_non_olymp', name: '–®–í–°–ú –ø–æ –Ω–µ–æ–ª–∏–º–ø–∏–π—Å–∫–∏–º –≤–∏–¥–∞–º —Å–ø–æ—Ä—Ç–∞' },
        { id: 'center_mass_kids', name: '–¶–µ–Ω—Ç—Ä —Ä–∞–∑–≤–∏—Ç–∏—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏ –¥–µ—Ç—Å–∫–æ–≥–æ —Å–ø–æ—Ä—Ç–∞' },
        { id: 'fiz_disp', name: '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–Ω—ã–π –¥–∏—Å–ø–∞–Ω—Å–µ—Ä' },
    ];

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–¥–æ–ª–∂–Ω–æ—Å—Ç–∏) –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ä—É—á–µ–Ω–∏–π ‚Äî –±–µ—Ä–µ–º –∏–∑ roles, –∫—Ä–æ–º–µ –≥–æ—Å—Ç—è
    const staffRecipients = roles.filter(r => r.id !== 'guest').map(r => ({
        id: r.id,
        label: `${r.label} ‚Äì ${r.person}`
    }));

    // -------------
    // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // -------------
    let currentUser = {
        roleId: 'guest',
        orgId: orgs[0]?.id || null,
        name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram'
    };

    // –ú–∞—Å—Å–∏–≤ –ø–æ—Ä—É—á–µ–Ω–∏–π
    let tasks = [];

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏—è
    let tableBuilderState = {
        columns: [], // { id, title, type, sum }
        rows: []     // [ [value, value, ...], ... ]
    };

    let selectedTaskId = null;

    // -------------
    // –£–¢–ò–õ–ò–¢–´
    // -------------
    function $(id) {
        return document.getElementById(id);
    }

    function getRoleById(id) {
        return roles.find(r => r.id === id) || null;
    }

    function getOrgById(id) {
        return orgs.find(o => o.id === id) || null;
    }

    function saveUserToStorage() {
        try {
            localStorage.setItem('ufks_user', JSON.stringify(currentUser));
        } catch (e) {}
    }

    function loadUserFromStorage() {
        try {
            const raw = localStorage.getItem('ufks_user');
            if (raw) {
                const parsed = JSON.parse(raw);
                if (parsed && parsed.roleId && getRoleById(parsed.roleId)) {
                    currentUser = parsed;
                }
            }
        } catch (e) {}
    }

    function formatDateHuman(dateStr) {
        if (!dateStr) return '–ù–µ —É–∫–∞–∑–∞–Ω';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}.${month}.${year}`;
    }

    function computeDeadlineCountdown(dateStr) {
        if (!dateStr) return '';
        const deadline = new Date(dateStr);
        const now = new Date();
        if (isNaN(deadline.getTime())) return '';
        const diffMs = deadline - now;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor((diffMs / (1000 * 60 * 60)) % 24);

        if (diffMs < 0) {
            return `–°—Ä–æ–∫ –∏—Å—Ç—ë–∫ ${Math.abs(diffDays)} –¥–Ω. –Ω–∞–∑–∞–¥`;
        }
        return `–î–æ –¥–µ–¥–ª–∞–π–Ω–∞: ${diffDays} –¥–Ω. ${diffHours} —á.`;
    }

    function getStatusLabel(status) {
        switch (status) {
            case 'new': return '–ù–æ–≤–æ–µ';
            case 'in_progress': return '–í —Ä–∞–±–æ—Ç–µ';
            case 'done': return '–ò—Å–ø–æ–ª–Ω–µ–Ω–æ';
            case 'overdue': return '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
            default: return '‚Äî';
        }
    }

    // -------------
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–û–õ–ï–ô –ò –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ô
    // -------------
    function initRoleAndOrgSelects() {
        const roleSelect = $('roleSelect');
        const orgSelect = $('orgSelect');

        roleSelect.innerHTML = '';
        roles.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.id;
            opt.textContent = `${r.label} (${r.person})`;
            if (r.id === 'guest') {
                opt.textContent = '–ì–æ—Å—Ç—å (–Ω–∞—Å–µ–ª–µ–Ω–∏–µ)';
            }
            roleSelect.appendChild(opt);
        });

        orgSelect.innerHTML = '';
        orgs.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.id;
            opt.textContent = o.name;
            orgSelect.appendChild(opt);
        });

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π-—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const recipientPersonSelect = $('recipientPersonSelect');
        recipientPersonSelect.innerHTML = '';
        staffRecipients.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.label;
            recipientPersonSelect.appendChild(opt);
        });

        // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Ä—É—á–µ–Ω–∏—è
        const recipientOrgSelect = $('recipientOrgSelect');
        recipientOrgSelect.innerHTML = '';
        orgs.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.id;
            opt.textContent = o.name;
            recipientOrgSelect.appendChild(opt);
        });
    }

    // -------------
    // –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ï–ö–£–©–ï–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    // -------------
    function updateUserUI() {
        const role = getRoleById(currentUser.roleId) || getRoleById('guest');
        const org = getOrgById(currentUser.orgId) || orgs[0];

        $('headerCurrentRole').textContent = role.label;
        $('chipRoleSummary').textContent = `–†–æ–ª—å: ${role.label}`;
        $('profileRole').textContent = `${role.label}${role.person ? ' ‚Äî ' + role.person : ''}`;
        $('profileOrg').textContent = org ? org.name : '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
        $('profileAccess').textContent = role.access || '‚Äî';
        $('profileName').textContent = currentUser.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram';

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–æ—Å—Ç—É–ø—É (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –±–µ–∑ –∂–µ—Å—Ç–∫–æ–≥–æ –∑–∞–ø—Ä–µ—Ç–∞)
        const canCreateTasks = role.id !== 'guest';
        $('btnOpenNewTask').disabled = !canCreateTasks;
        $('btnNewTaskFromTasks').disabled = !canCreateTasks;

        // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –≥–æ—Å—Ç—è
        if (!canCreateTasks) {
            $('btnOpenNewTask').style.opacity = '0.6';
            $('btnNewTaskFromTasks').style.opacity = '0.6';
        } else {
            $('btnOpenNewTask').style.opacity = '1';
            $('btnNewTaskFromTasks').style.opacity = '1';
        }
    }

    // -------------
    // –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –≠–ö–†–ê–ù–ê–ú
    // -------------
    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screen = $('screen-' + screenId);
        if (screen) screen.classList.add('active');

        document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
            if (item.dataset.screen === screenId) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    function initBottomNav() {
        document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const screenId = item.dataset.screen;
                switchScreen(screenId);
            });
        });
    }

    // -------------
    // –ú–û–î–ê–õ–ö–ò (–û–ë–©–ï–ï)
    // -------------
    function openModal(id) {
        const el = $(id);
        if (el) el.classList.add('visible');
    }

    function closeModal(id) {
        const el = $(id);
        if (el) el.classList.remove('visible');
    }

    function initModalCloseButtons() {
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.close;
                if (target) closeModal(target);
            });
        });
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    backdrop.classList.remove('visible');
                }
            });
        });
    }

    // -------------
    // –†–û–õ–¨ –ü–†–ò –í–•–û–î–ï
    // -------------
    function showRoleModalIfNeeded() {
        const modal = $('roleModal');
        if (!currentUser.roleId) {
            modal.classList.add('visible');
        } else {
            // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
            const roleSelect = $('roleSelect');
            const orgSelect = $('orgSelect');
            if (roleSelect && getRoleById(currentUser.roleId)) {
                roleSelect.value = currentUser.roleId;
            }
            if (orgSelect && getOrgById(currentUser.orgId)) {
                orgSelect.value = currentUser.orgId;
            }
        }
    }

    function initRoleModal() {
        const modal = $('roleModal');
        const btnConfirm = $('btnConfirmRole');

        btnConfirm.addEventListener('click', () => {
            const roleId = $('roleSelect').value;
            const orgId = $('orgSelect').value;

            if (!roleId) return;
            const role = getRoleById(roleId) || getRoleById('guest');
            currentUser.roleId = role.id;
            currentUser.orgId = orgId || orgs[0].id;

            saveUserToStorage();
            updateUserUI();

            modal.classList.remove('visible');
        });
    }

    // -------------
    // –ö–ù–û–ü–ö–ò –ù–ê –ì–õ–ê–í–ù–û–ú –≠–ö–†–ê–ù–ï
    // -------------
    function initHomeButtons() {
        $('btnOpenNewTask').addEventListener('click', () => {
            const role = getRoleById(currentUser.roleId);
            if (role.id === 'guest') {
                alert('–°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏—è –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–µ–π –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å.');
                return;
            }
            resetNewTaskForm();
            openModal('modalNewTaskBackdrop');
        });

        $('btnGotoTasksScreen').addEventListener('click', () => {
            switchScreen('tasks');
        });

        $('btnGotoAiScreen').addEventListener('click', () => {
            switchScreen('ai');
        });

        $('btnGotoEventsScreen').addEventListener('click', () => {
            switchScreen('events');
        });

        $('btnGotoProfileScreen').addEventListener('click', () => {
            switchScreen('profile');
        });

        $('btnGuestInfo').addEventListener('click', () => {
            alert('–†–µ–∂–∏–º –≥–æ—Å—Ç—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –Ω–∞—Å–µ–ª–µ–Ω–∏—è: –¥–æ—Å—Ç—É–ø –∫ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º, —Å–µ–∫—Ü–∏—è–º –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ä—É—á–µ–Ω–∏—è–º–∏ –≤–æ–π–¥–∏—Ç–µ –ø–æ–¥ –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é.');
        });

        $('btnOpenProfileFromHeader').addEventListener('click', () => {
            switchScreen('profile');
        });

        $('btnNewTaskFromTasks').addEventListener('click', () => {
            const role = getRoleById(currentUser.roleId);
            if (role.id === 'guest') {
                alert('–°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏—è –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–µ–π –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å.');
                return;
            }
            resetNewTaskForm();
            openModal('modalNewTaskBackdrop');
        });
    }

    // -------------
    // –ü–†–û–§–ò–õ–¨
    // -------------
    function initProfileActions() {
        $('btnChangeRole').addEventListener('click', () => {
            $('roleModal').classList.add('visible');
        });

        $('btnResetToGuest').addEventListener('click', () => {
            currentUser.roleId = 'guest';
            currentUser.orgId = orgs[0]?.id || null;
            saveUserToStorage();
            updateUserUI();
            $('roleModal').classList.add('visible');
        });
    }

    // -------------
    // –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–ò–¢
    // -------------
    function initTelegram() {
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                currentUser.name = u.first_name + (u.last_name ? (' ' + u.last_name) : '');
            }
        }
    }

    // -------------
    // –ü–†–ò–ö–ê–ó–´ / –ü–û–†–£–ß–ï–ù–ò–Ø ‚Äî –†–ï–ù–î–ï–†
    // -------------
    function renderTasks() {
        const container = $('tasksList');
        const filterStatus = $('filterStatus').value;
        const filterText = $('filterText').value.toLowerCase();

        container.innerHTML = '';

        const filtered = tasks.filter(t => {
            if (filterStatus !== 'all' && t.status !== filterStatus) return false;
            if (filterText && !t.text.toLowerCase().includes(filterText)) return false;
            return true;
        });

        if (filtered.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'muted-small';
            empty.textContent = '–ü–æ—Ä—É—á–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.';
            container.appendChild(empty);
            return;
        }

        filtered.forEach(task => {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.dataset.id = task.id;

            const role = getRoleById(task.creatorRoleId);
            const recipientTitle = task.recipientType === 'person'
                ? staffRecipients.find(r => r.id === task.recipientId)?.label || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'
                : getOrgById(task.recipientId)?.name || '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è';

            const statusLabel = getStatusLabel(task.status);
            const countdown = computeDeadlineCountdown(task.deadline);

            const statusClassMap = {
                'new': 'new',
                'in_progress': 'in_progress',
                'done': 'done',
                'overdue': 'overdue'
            };

            card.innerHTML = `
                <div class="task-top-row">
                    <div class="task-title">${task.text || '(–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞)'}</div>
                    <span class="badge-status ${statusClassMap[task.status] || ''}">
                        ${statusLabel}
                    </span>
                </div>
                <div class="task-meta">
                    –ö–æ–º—É: ${recipientTitle}
                </div>
                <div class="task-meta">
                    –î–µ–¥–ª–∞–π–Ω: <span class="badge-deadline">${formatDateHuman(task.deadline)}</span>
                    ${countdown ? ' ¬∑ ' + countdown : ''}
                </div>
                <div class="task-meta">
                    –°–æ–∑–¥–∞–Ω–æ: ${role ? role.label : '‚Äî'}
                </div>
            `;

            card.addEventListener('click', () => {
                openTaskDetails(task.id);
            });

            container.appendChild(card);
        });
    }

    // -------------
    // –ù–û–í–û–ï –ü–û–†–£–ß–ï–ù–ò–ï ‚Äî –ö–û–ù–°–¢–†–£–ö–¢–û–† –¢–ê–ë–õ–ò–¶–´
    // -------------
    function resetTableBuilder() {
        tableBuilderState = {
            columns: [],
            rows: []
        };
        renderColumnsConfig();
        renderBuilderTable();
    }

    function addColumn() {
        const id = 'col_' + (tableBuilderState.columns.length + 1);
        tableBuilderState.columns.push({
            id,
            title: '–ö–æ–ª–æ–Ω–∫–∞ ' + tableBuilderState.columns.length,
            type: 'text',
            sum: false
        });
        // –î–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É
        tableBuilderState.rows.forEach(row => row.push(''));
        renderColumnsConfig();
        renderBuilderTable();
    }

    function removeColumn(colId) {
        const idx = tableBuilderState.columns.findIndex(c => c.id === colId);
        if (idx === -1) return;
        tableBuilderState.columns.splice(idx, 1);
        tableBuilderState.rows.forEach(row => row.splice(idx, 1));
        renderColumnsConfig();
        renderBuilderTable();
    }

    function addRow() {
        const colsCount = tableBuilderState.columns.length;
        const row = Array.from({ length: colsCount }, () => '');
        tableBuilderState.rows.push(row);
        renderBuilderTable();
    }

    function clearTable() {
        tableBuilderState.rows = [];
        tableBuilderState.columns = [];
        renderColumnsConfig();
        renderBuilderTable();
    }

    function renderColumnsConfig() {
        const container = $('columnsConfig');
        container.innerHTML = '';

        if (tableBuilderState.columns.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'muted-small';
            empty.textContent = '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–µ–π.';
            container.appendChild(empty);
            return;
        }

        tableBuilderState.columns.forEach((col, index) => {
            const row = document.createElement('div');
            row.className = 'column-config-row';

            row.innerHTML = `
                <div>
                    <input class="input" value="${col.title}" data-col-id="${col.id}" data-field="title" />
                    <small>–ö–æ–ª–æ–Ω–∫–∞ ${index + 1}</small>
                </div>
                <div>
                    <select class="select" data-col-id="${col.id}" data-field="type">
                        <option value="text"${col.type === 'text' ? ' selected' : ''}>–¢–µ–∫—Å—Ç</option>
                        <option value="number"${col.type === 'number' ? ' selected' : ''}>–ß–∏—Å–ª–æ (—Å —Å—É–º–º–æ–π)</option>
                        <option value="date"${col.type === 'date' ? ' selected' : ''}>–î–∞—Ç–∞</option>
                    </select>
                    <small class="sum-label">
                        <input type="checkbox" data-col-id="${col.id}" data-field="sum" ${col.sum ? 'checked' : ''} ${col.type !== 'number' ? 'disabled' : ''} />
                        &nbsp;–ò—Ç–æ–≥–æ –ø–æ –∫–æ–ª–æ–Ω–∫–µ
                    </small>
                </div>
                <button class="btn-icon-small" data-remove-col="${col.id}" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úï</button>
            `;

            container.appendChild(row);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º
        container.querySelectorAll('input[data-col-id][data-field="title"]').forEach(input => {
            input.addEventListener('input', () => {
                const col = tableBuilderState.columns.find(c => c.id === input.dataset.colId);
                if (col) {
                    col.title = input.value;
                    renderBuilderTable(); // –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
                }
            });
        });

        container.querySelectorAll('select[data-col-id][data-field="type"]').forEach(select => {
            select.addEventListener('change', () => {
                const col = tableBuilderState.columns.find(c => c.id === select.dataset.colId);
                if (col) {
                    col.type = select.value;
                    if (col.type !== 'number') {
                        col.sum = false;
                    }
                    renderColumnsConfig();
                    renderBuilderTable();
                }
            });
        });

        container.querySelectorAll('input[data-col-id][data-field="sum"]').forEach(ch => {
            ch.addEventListener('change', () => {
                const col = tableBuilderState.columns.find(c => c.id === ch.dataset.colId);
                if (col && col.type === 'number') {
                    col.sum = ch.checked;
                    renderBuilderTable();
                }
            });
        });

        container.querySelectorAll('button[data-remove-col]').forEach(btn => {
            btn.addEventListener('click', () => {
                removeColumn(btn.dataset.removeCol);
            });
        });
    }

    function renderBuilderTable() {
        const table = $('builderTable');
        table.innerHTML = '';

        if (tableBuilderState.columns.length === 0) {
            table.innerHTML = `
                <tbody>
                    <tr><td class="muted-small">–¢–∞–±–ª–∏—Ü–∞ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.</td></tr>
                </tbody>
            `;
            return;
        }

        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');
        tableBuilderState.columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col.title || '–ö–æ–ª–æ–Ω–∫–∞';
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        tableBuilderState.rows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tableBuilderState.columns.forEach((col, colIndex) => {
                const td = document.createElement('td');
                const input = document.createElement('input');
                input.className = 'builder-input';
                input.value = row[colIndex] || '';
                input.dataset.rowIndex = rowIndex;
                input.dataset.colIndex = colIndex;

                if (col.type === 'number') {
                    input.type = 'number';
                } else if (col.type === 'date') {
                    input.type = 'date';
                } else {
                    input.type = 'text';
                }

                input.addEventListener('input', () => {
                    let value = input.value;
                    if (col.type === 'number') {
                        // –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É, –Ω–æ –¥–ª—è —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ–º –ø–∞—Ä—Å–∏—Ç—å
                    }
                    tableBuilderState.rows[rowIndex][colIndex] = value;
                    renderFooterRow(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å—É–º–º—ã
                });

                td.appendChild(input);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);

        renderFooterRow();
    }

    function renderFooterRow() {
        const table = $('builderTable');
        // —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π tfoot
        const oldTfoot = table.querySelector('tfoot');
        if (oldTfoot) oldTfoot.remove();

        const hasColumnsWithSum = tableBuilderState.columns.some(c => c.type === 'number' && c.sum);
        if (!hasColumnsWithSum || tableBuilderState.rows.length === 0) return;

        const tfoot = document.createElement('tfoot');
        const tr = document.createElement('tr');
        tr.className = 'builder-footer';

        tableBuilderState.columns.forEach((col, colIndex) => {
            const td = document.createElement('td');
            if (col.type === 'number' && col.sum) {
                let sum = 0;
                tableBuilderState.rows.forEach(row => {
                    const val = parseFloat(row[colIndex]);
                    if (!isNaN(val)) sum += val;
                });
                td.textContent = sum.toLocaleString('ru-RU');
            } else if (colIndex === 0) {
                td.textContent = '–ò—Ç–æ–≥–æ';
            } else {
                td.textContent = '';
            }
            tr.appendChild(td);
        });

        tfoot.appendChild(tr);
        table.appendChild(tfoot);
    }

    function initTableBuilderControls() {
        $('btnAddColumn').addEventListener('click', () => {
            addColumn();
        });
        $('btnAddRow').addEventListener('click', () => {
            if (tableBuilderState.columns.length === 0) {
                addColumn();
            }
            addRow();
        });
        $('btnClearTable').addEventListener('click', () => {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª–Ω–æ—Å—Ç—å—é?')) {
                clearTable();
            }
        });
    }

    // -------------
    // –ù–û–í–û–ï –ü–û–†–£–ß–ï–ù–ò–ï ‚Äî –§–û–†–ú–ê
    // -------------
    let currentRecipientType = 'person'; // 'person' or 'org'

    function setRecipientType(type) {
        currentRecipientType = type;
        if (type === 'person') {
            $('recipientPersonGroup').style.display = 'block';
            $('recipientOrgGroup').style.display = 'none';
        } else {
            $('recipientPersonGroup').style.display = 'none';
            $('recipientOrgGroup').style.display = 'block';
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
        $('btnRecipientPerson').style.background = type === 'person' ? '#e5f0ff' : '#f9fafb';
        $('btnRecipientOrg').style.background = type === 'org' ? '#e5f0ff' : '#f9fafb';
    }

    function resetNewTaskForm() {
        setRecipientType('person');
        $('taskText').value = '';
        $('taskDeadline').value = '';
        $('deadlineCountdownText').textContent = '';
        resetTableBuilder();
    }

    function initNewTaskForm() {
        $('btnRecipientPerson').addEventListener('click', () => setRecipientType('person'));
        $('btnRecipientOrg').addEventListener('click', () => setRecipientType('org'));

        $('taskDeadline').addEventListener('change', () => {
            $('deadlineCountdownText').textContent = computeDeadlineCountdown($('taskDeadline').value);
        });

        $('btnSaveTask').addEventListener('click', () => {
            const role = getRoleById(currentUser.roleId);
            if (role.id === 'guest') {
                alert('–°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏—è –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è.');
                return;
            }

            const text = $('taskText').value.trim();
            const deadline = $('taskDeadline').value;
            let recipientId = null;

            if (currentRecipientType === 'person') {
                recipientId = $('recipientPersonSelect').value;
            } else {
                recipientId = $('recipientOrgSelect').value;
            }

            if (!text) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Ä—É—á–µ–Ω–∏—è.');
                return;
            }
            if (!deadline) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–¥–ª–∞–π–Ω.');
                return;
            }
            if (!recipientId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.');
                return;
            }

            const newTask = {
                id: 'task_' + (tasks.length + 1) + '_' + Date.now(),
                text,
                status: 'new',
                creatorRoleId: currentUser.roleId,
                recipientType: currentRecipientType,
                recipientId,
                deadline,
                createdAt: new Date().toISOString(),
                table: JSON.parse(JSON.stringify(tableBuilderState))
            };

            tasks.unshift(newTask);
            renderTasks();
            closeModal('modalNewTaskBackdrop');
        });
    }

    // -------------
    // –î–ï–¢–ê–õ–ò –ü–û–†–£–ß–ï–ù–ò–Ø
    // -------------
    function openTaskDetails(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        selectedTaskId = taskId;

        $('taskDetailsTitle').textContent = '–ü–æ—Ä—É—á–µ–Ω–∏–µ';
        const recipientTitle = task.recipientType === 'person'
            ? (staffRecipients.find(r => r.id === task.recipientId)?.label || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫')
            : (getOrgById(task.recipientId)?.name || '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è');

        $('taskDetailsMeta').textContent = `–ö–æ–º—É: ${recipientTitle} ¬∑ –î–µ–¥–ª–∞–π–Ω: ${formatDateHuman(task.deadline)}`;
        $('taskDetailsText').textContent = task.text;
        $('taskDetailsStatus').value = task.status;

        const table = $('taskDetailsTable');
        table.innerHTML = '';

        if (!task.table || !task.table.columns || task.table.columns.length === 0) {
            table.innerHTML = '<tbody><tr><td class="muted-small">–¢–∞–±–ª–∏—Ü–∞ –∫ –ø–æ—Ä—É—á–µ–Ω–∏—é –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞.</td></tr></tbody>';
        } else {
            const columns = task.table.columns;
            const rows = task.table.rows || [];

            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.title || '–ö–æ–ª–æ–Ω–∫–∞';
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            rows.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach((col, colIndex) => {
                    const td = document.createElement('td');
                    const val = row[colIndex] || '';
                    td.textContent = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            // –§—É—Ç–µ—Ä —Å —Å—É–º–º–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
            const hasColumnsWithSum = columns.some(c => c.type === 'number' && c.sum);
            if (hasColumnsWithSum && rows.length > 0) {
                const tfoot = document.createElement('tfoot');
                const tr = document.createElement('tr');
                tr.className = 'builder-footer';

                columns.forEach((col, colIndex) => {
                    const td = document.createElement('td');
                    if (col.type === 'number' && col.sum) {
                        let sum = 0;
                        rows.forEach(r => {
                            const val = parseFloat(r[colIndex]);
                            if (!isNaN(val)) sum += val;
                        });
                        td.textContent = sum.toLocaleString('ru-RU');
                    } else if (colIndex === 0) {
                        td.textContent = '–ò—Ç–æ–≥–æ';
                    }
                    tr.appendChild(td);
                });

                tfoot.appendChild(tr);
                table.appendChild(tfoot);
            }
        }

        openModal('modalTaskDetailsBackdrop');
    }

    function initTaskDetailsActions() {
        $('btnUpdateTaskStatus').addEventListener('click', () => {
            if (!selectedTaskId) return;
            const task = tasks.find(t => t.id === selectedTaskId);
            if (!task) return;

            task.status = $('taskDetailsStatus').value;
            renderTasks();
            closeModal('modalTaskDetailsBackdrop');
        });
    }

    // -------------
    // –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø / –°–ï–ö–¶–ò–ò / –†–ï–ó–£–õ–¨–¢–ê–¢–´ ‚Äî –î–ï–ú–û –î–ê–ù–ù–´–ï
    // -------------
    const demoEvents = [
        {
            title: '–û–±–ª–∞—Å—Ç–Ω–æ–π —Ç—É—Ä–Ω–∏—Ä –ø–æ —Ñ—É—Ç–±–æ–ª—É —Å—Ä–µ–¥–∏ —é–Ω–æ—à–µ–π',
            date: '2025-12-10',
            place: '–≥. –ö–∞—Ä–∞–≥–∞–Ω–¥–∞, —Å—Ç–∞–¥–∏–æ–Ω ¬´–®–∞—Ö—Ç—ë—Ä¬ª',
            org: '–û—Ç–¥–µ–ª –§–ö–∏–° –≥. –ö–∞—Ä–∞–≥–∞–Ω–¥–∞'
        },
        {
            title: '–§–µ—Å—Ç–∏–≤–∞–ª—å –º–∞—Å—Å–æ–≤–æ–≥–æ –±–µ–≥–∞ ¬´–ó–¥–æ—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å¬ª',
            date: '2025-12-20',
            place: '–≥. –¢–µ–º–∏—Ä—Ç–∞—É, –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è',
            org: '–û—Ç–¥–µ–ª –§–ö–∏–° –≥. –¢–µ–º–∏—Ä—Ç–∞—É'
        }
    ];

    const demoSections = [
        {
            sport: '–§—É—Ç–±–æ–ª',
            place: '–î–Æ–°–® ‚Ññ1 –≥. –ö–∞—Ä–∞–≥–∞–Ω–¥—ã',
            trainer: '–ò–≤–∞–Ω–æ–≤ –ê.–ê.',
            schedule: '–ü–Ω, –°—Ä, –ü—Ç ‚Äî 15:00'
        },
        {
            sport: '–ë–æ–∫—Å',
            place: '–û–°–î–Æ–®–û–† ‚Ññ3',
            trainer: '–°–µ—Ä–≥–µ–µ–≤ –ë.–ë.',
            schedule: '–í—Ç, –ß—Ç, –°–± ‚Äî 17:00'
        }
    ];

    const demoResults = [
        {
            athlete: '–ü–µ—Ç—Ä–æ–≤ –î.',
            org: '–®–í–°–ú –ø–æ –æ–ª–∏–º–ø–∏–π—Å–∫–∏–º –≤–∏–¥–∞–º —Å–ø–æ—Ä—Ç–∞',
            event: '–ß–µ–º–ø–∏–æ–Ω–∞—Ç –†–ö –ø–æ –ª—ë–≥–∫–æ–π –∞—Ç–ª–µ—Ç–∏–∫–µ',
            result: '1 –º–µ—Å—Ç–æ',
            date: '2025-11-01'
        },
        {
            athlete: '–°–∞–¥—ã–∫–æ–≤–∞ –ú.',
            org: '–¶–ü–û–†',
            event: '–ö—É–±–æ–∫ –ê–∑–∏–∏ –ø–æ —Ç–∞—ç–∫–≤–æ–Ω–¥–æ',
            result: '2 –º–µ—Å—Ç–æ',
            date: '2025-10-15'
        }
    ];

    function renderEventsSectionsResults() {
        const eventsList = $('eventsList');
        eventsList.innerHTML = '';
        demoEvents.forEach(e => {
            const item = document.createElement('div');
            item.className = 'list-item-simple';
            item.innerHTML = `
                <div class="list-item-title">${e.title}</div>
                <div class="list-item-meta">–î–∞—Ç–∞: ${formatDateHuman(e.date)} ¬∑ –ú–µ—Å—Ç–æ: ${e.place}</div>
                <div class="list-item-meta">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${e.org}</div>
            `;
            eventsList.appendChild(item);
        });

        const sectionsList = $('sectionsList');
        sectionsList.innerHTML = '';
        demoSections.forEach(s => {
            const item = document.createElement('div');
            item.className = 'list-item-simple';
            item.innerHTML = `
                <div class="list-item-title">${s.sport}</div>
                <div class="list-item-meta">–õ–æ–∫–∞—Ü–∏—è: ${s.place}</div>
                <div class="list-item-meta">–¢—Ä–µ–Ω–µ—Ä: ${s.trainer} ¬∑ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${s.schedule}</div>
            `;
            sectionsList.appendChild(item);
        });

        const resultsList = $('resultsList');
        resultsList.innerHTML = '';
        demoResults.forEach(r => {
            const item = document.createElement('div');
            item.className = 'list-item-simple';
            item.innerHTML = `
                <div class="list-item-title">${r.athlete}</div>
                <div class="list-item-meta">${r.event} ¬∑ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${r.result}</div>
                <div class="list-item-meta">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: ${r.org} ¬∑ –î–∞—Ç–∞: ${formatDateHuman(r.date)}</div>
            `;
            resultsList.appendChild(item);
        });
    }

    function initEventsTabs() {
        const tabEvents = $('tabEvents');
        const tabSections = $('tabSections');
        const tabResults = $('tabResults');

        function setPanel(panel) {
            $('eventsPanel').style.display = panel === 'events' ? 'block' : 'none';
            $('sectionsPanel').style.display = panel === 'sections' ? 'block' : 'none';
            $('resultsPanel').style.display = panel === 'results' ? 'block' : 'none';

            tabEvents.classList.toggle('active', panel === 'events');
            tabSections.classList.toggle('active', panel === 'sections');
            tabResults.classList.toggle('active', panel === 'results');
        }

        tabEvents.addEventListener('click', () => setPanel('events'));
        tabSections.addEventListener('click', () => setPanel('sections'));
        tabResults.addEventListener('click', () => setPanel('results'));
    }

    // -------------
    // –ò–ò-–ê–°–°–ò–°–¢–ï–ù–¢ (–î–ï–ú–û)
    // -------------
    function addAiMessage(from, text) {
        const chat = $('aiChat');
        const wrap = document.createElement('div');
        wrap.className = 'ai-msg ' + (from === 'user' ? 'ai-msg-user' : 'ai-msg-bot');
        const span = document.createElement('span');
        span.textContent = text;
        wrap.appendChild(span);
        chat.appendChild(wrap);
        chat.scrollTop = chat.scrollHeight;
    }

    function handleAiQuestion(q) {
        addAiMessage('user', q);

        // –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
        let answer = '–Ø —Å–æ—Ö—Ä–∞–Ω–∏–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å. –í –±–æ–µ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';

        const lower = q.toLowerCase();

        if (lower.includes('—Å–æ–æ—Ä—É–∂') || lower.includes('–æ–±—ä–µ–∫—Ç')) {
            answer = '–í –æ–±–ª–∞—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –±–æ–ª–µ–µ 400 —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π. –¢–æ—á–Ω–∞—è —Ü–∏—Ñ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ–∑ –ø–æ —Ä–∞–π–æ–Ω–∞–º –±—É–¥–µ—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.';
        } else if (lower.includes('–∫–ª–∞—Å—Ç–µ—Ä')) {
            answer = '–ü—Ä–æ–µ–∫—Ç ¬´–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä¬ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ –¥–∞–Ω–Ω—ã–º –æ—Ç–¥–µ–ª–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.';
        } else if (lower.includes('—Å–µ–∫—Ü') || lower.includes('—Ç—Ä–µ–Ω–µ—Ä')) {
            answer = '–í –æ–±–ª–∞—Å—Ç–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç —Å–µ–∫—Ü–∏–∏ –ø–æ —Ñ—É—Ç–±–æ–ª—É, –±–æ–∫—Å—É, –ª—ë–≥–∫–æ–π –∞—Ç–ª–µ—Ç–∏–∫–µ, –µ–¥–∏–Ω–æ–±–æ—Ä—Å—Ç–≤–∞–º –∏ –¥—Ä—É–≥–∏–º –≤–∏–¥–∞–º. –í —Ä–∞–∑–¥–µ–ª–µ ¬´–°–µ–∫—Ü–∏–∏ –∏ —Ç—Ä–µ–Ω–µ—Ä—ã¬ª –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞–π—Ç–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã.';
        } else if (lower.includes('—Å—Ç—Ä–æ–∏—Ç') || lower.includes('—Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫')) {
            answer = '–í–µ–¥—ë—Ç—Å—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä—è–¥–∞ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–ø–æ—Ä—Ç–∞. –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–º–æ–∂–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ —Ä–∞–π–æ–Ω–∞–º –∏ —Å—Ä–æ–∫–∞–º —Å–¥–∞—á–∏.';
        }

        setTimeout(() => {
            addAiMessage('bot', answer);
        }, 300);
    }

    function initAiAssistant() {
        document.querySelectorAll('.ai-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const q = chip.dataset.q || chip.textContent;
                handleAiQuestion(q);
            });
        });

        $('aiSendBtn').addEventListener('click', () => {
            const val = $('aiInput').value.trim();
            if (!val) return;
            $('aiInput').value = '';
            handleAiQuestion(val);
        });

        $('aiInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                $('aiSendBtn').click();
            }
        });
    }

    // -------------
    // INIT
    // -------------
    function initFilters() {
        $('filterStatus').addEventListener('change', renderTasks);
        $('filterText').addEventListener('input', renderTasks);
    }

    function initApp() {
        initTelegram();
        loadUserFromStorage();
        initRoleAndOrgSelects();
        initRoleModal();
        showRoleModalIfNeeded();
        updateUserUI();

        initBottomNav();
        initModalCloseButtons();
        initHomeButtons();
        initProfileActions();
        initTableBuilderControls();
        initNewTaskForm();
        initTaskDetailsActions();
        initEventsTabs();
        initAiAssistant();
        initFilters();

        renderTasks();
        renderEventsSectionsResults();
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
