<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiDCity</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-grad-1: #6f5bff;
  --bg-grad-2: #000;
  --bg-grad-3: #06122a;
  --accent1: #b37aff;
  --accent2: #7BFF5A;
  --gold: #f5c24a;
  --glass: rgba(255,255,255,0.035);
  --muted: rgba(255,255,255,0.62);
  --text: #ffffff;
  --radius:12px;
  --ui-font-size:14px;
  --primary-cta: linear-gradient(90deg,#ffd84d,#ffcf3b);
  --secondary-cta: linear-gradient(90deg,var(--accent1),var(--accent2));
}
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; font-family:-apple-system,BlinkMacSystemFont,"Inter","SF Pro Text","Helvetica Neue",Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  background:
    radial-gradient(700px 360px at 8% 8%, rgba(179,122,255,0.07), transparent 8%),
    linear-gradient(180deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 36%, var(--bg-grad-3) 100%);
  color:var(--text); padding:14px; display:flex; flex-direction:column; align-items:center; font-size:var(--ui-font-size);
}

/* Top header */
.header{ width:100%; max-width:920px; display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px; }
.brand{ display:flex; align-items:center; gap:8px; }
.brand h1{ margin:0; font-size:20px; font-weight:800; line-height:1; }
.brand .gid{ color:#fff; }
.brand .city{ color:var(--accent1); }
.city-display{ color:var(--muted); font-size:13px; }

/* main container */
.container{ width:100%; max-width:920px; border-radius:16px; padding:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 24px 48px rgba(0,0,0,0.55); position:relative; }

/* settings icon (top-right inside container) */
.settings-btn{
  position:absolute; top:12px; right:12px; width:40px; height:40px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); cursor:pointer;
  transition:transform .16s ease;
}
.settings-btn:hover{ transform:translateY(-3px); }

/* menu */
.menu-list{ display:grid; gap:10px; margin-top:6px; }
.menu-item{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03); cursor:pointer; }
.menu-item.special{ border-radius:6px; border:1px solid rgba(245,194,74,0.18); background: linear-gradient(180deg, rgba(245,194,74,0.05), rgba(0,0,0,0.02)); }
.menu-title{ font-weight:800; font-size:15px; }
.menu-sub{ color:var(--muted); font-weight:700; font-size:13px; }

/* screens and panels */
.screen{ position:fixed; inset:0; display:none; z-index:50; padding:18px; background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.72)); backdrop-filter: blur(6px); }
.screen.active{ display:block; }
.panel{ max-width:760px; margin:28px auto; border-radius:14px; padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(0,0,0,0.14)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 20px 48px rgba(0,0,0,0.6); transform-origin:center top; transition: transform .28s cubic-bezier(.2,.9,.22,1), opacity .22s ease; }

/* tabs compact */
.tabs{ display:flex; gap:8px; align-items:center; overflow:auto; padding-bottom:6px; margin-top:10px; }
.tab{ padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); color:var(--muted); font-weight:700; cursor:pointer; font-size:13px; white-space:nowrap; background:transparent; }
.tab.active{ color:#071; border-color: rgba(123,255,90,0.14); background: linear-gradient(90deg, rgba(123,255,90,0.05), rgba(179,122,255,0.03)); }
.tab.gold{ color:var(--gold); border-color: rgba(245,194,74,0.18); background: linear-gradient(90deg, rgba(245,194,74,0.06), rgba(255,255,255,0.01)); }

/* list cards compact */
.list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.card{ display:flex; gap:10px; padding:10px; border-radius:10px; align-items:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03); }
.card-left{ flex:0 0 44px; }
.avatar{ width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; box-shadow:0 8px 18px rgba(0,0,0,0.45); font-size:14px; }
.card-body{ flex:1; }
.card-top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.card-title{ font-weight:800; font-size:14px; }
.card-meta{ color:var(--muted); font-size:12px; margin-top:6px; }
.card-desc{ margin-top:8px; color:rgba(255,255,255,0.92); font-size:13px; }

/* buttons */
.btn{ padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer; border:none; display:inline-flex; align-items:center; justify-content:center; font-size:13px; }
.btn.primary{ background: var(--primary-cta); color:#111; box-shadow:0 8px 22px rgba(245,194,74,0.10); min-width:160px; }
.btn.secondary{ background: var(--secondary-cta); color:#041; min-width:120px; }
.btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); min-width:100px; }

/* forms */
.form-field{ margin-top:10px; }
.input, textarea, select{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text); font-size:13px; }
textarea{ min-height:120px; resize:vertical; }

/* city list vertical */
.city-list{ max-height:48vh; overflow:auto; margin-top:8px; display:flex; flex-direction:column; gap:8px; padding-right:6px; }
.city-item{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:rgba(255,255,255,0.01); cursor:pointer; color:var(--muted); font-weight:700; font-size:13px; }
.city-item.active{ background:linear-gradient(90deg, rgba(179,122,255,0.06), rgba(123,255,90,0.03)); color:#071; border-color: rgba(123,255,90,0.08); }

/* bid modal */
.modal-back{ position:fixed; inset:0; display:none; background: rgba(0,0,0,0.55); z-index:120; align-items:center; justify-content:center; }
.modal{ background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.16)); border:1px solid rgba(255,255,255,0.06); padding:12px; border-radius:10px; width:92%; max-width:420px; }
.modal.active{ display:flex; }

/* settings side panel */
.settings-panel{
  position:fixed; top:0; right:-420px; width:360px; height:100%; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.14)); border-left:1px solid rgba(255,255,255,0.04); box-shadow: -20px 0 60px rgba(0,0,0,0.6); transition:right .32s cubic-bezier(.2,.9,.22,1); z-index:130; padding:16px;
}
.settings-panel.open{ right:0; }
.setting-row{ margin-top:12px; display:flex; gap:8px; align-items:center; }

/* small screens */
@media(max-width:720px){
  .container{ padding:10px; }
  .settings-panel{ width:100%; right:-100%; }
  .settings-panel.open{ right:0; }
  .header{ padding:0 6px; }
  .brand h1{ font-size:18px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="brand"><h1><span class="gid">GiD</span><span class="city">City</span></h1></div>
  <div class="city-display" id="topCity">—</div>
</header>

<!-- MAIN -->
<main class="container" id="mainContainer">
  <div class="settings-btn" id="openSettings" title="Настройки" aria-label="Настройки">
    <!-- gear svg -->
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.7 1.7 0 0 0 .33 1.88l.02.02a2 2 0 0 1-2.82 2.82l-.02-.02A1.7 1.7 0 0 0 15 19.4a1.7 1.7 0 0 0-1.88.33l-.02.02a2 2 0 0 1-2.82-2.82l.02-.02A1.7 1.7 0 0 0 8.6 15 1.7 1.7 0 0 0 7.72 13.12l-.02-.02a2 2 0 0 1 2.82-2.82l.02.02A1.7 1.7 0 0 0 9 8.6 1.7 1.7 0 0 0 10.12 6.72l.02-.02a2 2 0 0 1 2.82 2.82l-.02.02A1.7 1.7 0 0 0 15 8.6a1.7 1.7 0 0 0 1.88-.33l.02-.02a2 2 0 0 1 2.82 2.82l-.02.02A1.7 1.7 0 0 0 19.4 11z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <div style="font-weight:800; font-size:16px">Меню</div>
  </div>

  <div id="menuList" class="menu-list"></div>
</main>

<!-- SCREENS: auth / city / role / find / create / mine / messenger / wallet -->
<section id="authScreen" class="screen" style="display:none">
  <div class="panel">
    <h2>Вход</h2>
    <form id="authForm" style="margin-top:10px;">
      <div class="form-field"><input id="authLogin" class="input" placeholder="Email или телефон" required /></div>
      <div class="form-field"><input id="authPass" class="input" placeholder="Пароль" type="password" required /></div>
      <div style="display:flex; gap:8px; margin-top:10px;"><button type="submit" class="btn primary">Войти</button><button type="button" id="regBtn" class="btn ghost">Регистрация</button></div>
      <div class="small" style="margin-top:8px">Данные сохраняются локально (демо).</div>
    </form>
  </div>
</section>

<section id="cityScreen" class="screen" style="display:none">
  <div class="panel">
    <h2>Выберите город</h2>
    <div class="form-field"><input id="citySearch" class="input" placeholder="Поиск города" /></div>
    <div class="city-list" id="cityList"></div>
    <div style="display:flex; gap:8px; margin-top:10px;"><button id="cityConfirm" class="btn primary">Подтвердить</button><button id="cityBack" class="btn ghost">Назад</button></div>
  </div>
</section>

<section id="roleScreen" class="screen" style="display:none">
  <div class="panel">
    <h2>Кем вы будете?</h2>
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
      <button id="roleUser" class="btn primary" style="background:linear-gradient(90deg,#7be495,#52c12d);">Пользователь</button>
      <button id="roleWorker" class="btn ghost">Исполнитель</button>
    </div>
  </div>
</section>

<section id="findScreen" class="screen" style="display:none">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Найти заказы</h2>
      <button class="btn ghost" onclick="closeScreen('findScreen')">← Назад</button>
    </div>
    <div class="tabs" id="findTabs">
      <div class="tab active" data-tab="all">Все заказы</div>
      <div class="tab gold" data-tab="spec">СПЕЦ. ЗАКАЗ</div>
      <div class="tab" data-tab="taxi">Такси</div>
      <div class="tab" data-tab="food">Доставка еды</div>
      <div class="tab" data-tab="more">Ещё</div>
    </div>
    <div style="display:flex; gap:8px; margin-top:10px;"><input id="searchInput" class="input" placeholder="Поиск..." /><button id="applySearch" class="btn primary">Поиск</button></div>
    <div class="list" id="findList"></div>
  </div>
</section>

<section id="createScreen" class="screen" style="display:none">
  <div class="panel" id="createPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Новый заказ</h2>
      <button class="btn ghost" onclick="closeScreen('createScreen')">← Назад</button>
    </div>
    <div class="tabs" id="createTabs" style="margin-top:8px;">
      <div class="tab gold active" data-val="СПЕЦ. ЗАКАЗ">СПЕЦ. ЗАКАЗ</div>
      <div class="tab" data-val="Такси">Такси</div>
      <div class="tab" data-val="Доставка еды">Доставка еды</div>
      <div class="tab" data-val="Курьер">Курьер</div>
    </div>
    <form id="createForm" style="margin-top:10px;">
      <div class="form-field"><textarea id="c-desc" class="input" placeholder="закажи любую услугу и мы найдем исполнителя"></textarea></div>
      <div class="form-field"><input id="c-budget" class="input" type="number" placeholder="Бюджет (₸)" required /></div>
      <div class="form-field"><input id="c-datetime" class="input" type="datetime-local" required /></div>
      <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
        <button class="btn primary" type="submit" id="orderNowBtn" style="min-width:220px;">ЗАКАЗАТЬ СЕЙЧАС</button>
        <button type="button" class="btn ghost" id="orderCancelBtn">Отмена</button>
        <div style="margin-left:auto; color:var(--muted); font-weight:800;" id="selectedCategory">СПЕЦ. ЗАКАЗ</div>
      </div>
    </form>
  </div>
</section>

<section id="mineScreen" class="screen" style="display:none">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h2 style="margin:0">Мои заказы</h2><button class="btn ghost" onclick="closeScreen('mineScreen')">← Назад</button></div>
    <div class="list" id="mineList" style="margin-top:10px;"></div>
  </div>
</section>

<section id="messengerScreen" class="screen" style="display:none">
  <div class="panel" style="display:flex; gap:12px;">
    <div style="width:260px;">
      <div style="display:flex; justify-content:space-between; align-items:center;"><h2 style="margin:0;font-size:16px">Мессенджер</h2><button class="btn ghost" onclick="closeScreen('messengerScreen')">← Назад</button></div>
      <div id="chatsList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
    </div>
    <div style="flex:1;">
      <div id="chatView" style="display:none; flex-direction:column;">
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="avatar" id="chatAvatar" style="width:40px;height:40px;"></div>
          <div>
            <div id="chatTitle" style="font-weight:800"></div>
            <div class="small" id="chatSub">Чат</div>
          </div>
        </div>
        <div id="messages" style="margin-top:10px; max-height:60vh; overflow:auto; padding-right:6px;"></div>
        <div style="display:flex; gap:8px; margin-top:8px;"><input id="messageInput" class="input" placeholder="Сообщение..." /><button id="sendMsgBtn" class="btn primary">Отправить</button></div>
      </div>
      <div id="noChat" class="small center" style="padding:24px;">Выберите чат слева</div>
    </div>
  </div>
</section>

<!-- BID modal -->
<div class="modal-back" id="bidModalWrap"><div class="modal" id="bidModal"><div style="font-weight:800">Предложить цену</div><div style="margin-top:8px"><input id="bidPrice" class="input" placeholder="Цена (₸)" type="number" /><input id="bidComment" class="input" placeholder="Комментарий" style="margin-top:8px" /><div style="display:flex; gap:8px; margin-top:8px;"><button id="sendBidBtn" class="btn primary">Отправить</button><button id="closeBidBtn" class="btn ghost">Отмена</button></div></div></div></div>

<!-- settings panel -->
<aside class="settings-panel" id="settingsPanel" aria-hidden="true">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div style="font-weight:800">Настройки</div>
    <button id="closeSettings" class="btn ghost" title="Закрыть">✕</button>
  </div>

  <div class="setting-row" style="margin-top:12px;"><div style="font-weight:700">Роль</div></div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button id="setRoleUser" class="btn primary" style="flex:1;background:linear-gradient(90deg,#7be495,#52c12d)">Пользователь</button>
    <button id="setRoleWorker" class="btn ghost" style="flex:1">Исполнитель</button>
  </div>

  <div class="setting-row"><div style="font-weight:700; margin-top:12px">Тема</div></div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button class="btn" data-theme="violet" style="flex:1; background:linear-gradient(90deg,var(--accent1),#8f7bff)">Фиолет</button>
    <button class="btn" data-theme="navy" style="flex:1; background:linear-gradient(90deg,#0b2540,#06122a); color:#fff">Тёмно-синяя</button>
  </div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button class="btn" data-theme="warm" style="flex:1; background:linear-gradient(90deg,#ffb86b,#ff7b6b)">Тёплая</button>
    <button id="resetTheme" class="btn ghost" style="flex:1">Сбросить</button>
  </div>

  <div class="setting-row"><div style="font-weight:700; margin-top:12px">Аккаунт</div></div>
  <div style="margin-top:8px"><button id="logoutBtn" class="btn ghost" style="width:100%">Выйти</button></div>
</aside>

<script>
/* Storage keys */
const LS_ORDERS='gid_orders_v6', LS_CHATS='gid_chats_v6', LS_WALLET='gid_wallet_v6', LS_PROFILE='gid_profile_v1', LS_CITY='gid_city_v1', LS_ROLE='gid_role_v1', LS_THEME='gid_theme_v1';

/* Simple store helpers */
const Store = {
  getOrders(){ try{return JSON.parse(localStorage.getItem(LS_ORDERS))||[];}catch(e){return[]} },
  setOrders(x){ localStorage.setItem(LS_ORDERS, JSON.stringify(x)); },
  addOrder(o){ const a=this.getOrders(); a.unshift(o); this.setOrders(a); return a; },
  updateOrder(id,fn){ const a=this.getOrders(); const i=a.findIndex(x=>x.id===id); if(i>-1){ fn(a[i]); this.setOrders(a);} return a; },
  deleteOrder(id){ const a=this.getOrders().filter(x=>x.id!==id); this.setOrders(a); return a; },
  getChats(){ try{return JSON.parse(localStorage.getItem(LS_CHATS))||[];}catch(e){return[]} },
  setChats(x){ localStorage.setItem(LS_CHATS, JSON.stringify(x)); },
  addChat(c){ const a=this.getChats(); a.unshift(c); this.setChats(a); return a; },
  updateChat(id,fn){ const a=this.getChats(); const i=a.findIndex(x=>x.id===id); if(i>-1){ fn(a[i]); this.setChats(a);} return a; },
  getWallet(){ try{return JSON.parse(localStorage.getItem(LS_WALLET))||{balance:0}}catch(e){return {balance:0}} },
  setWallet(w){ localStorage.setItem(LS_WALLET, JSON.stringify(w)); },
  getProfile(){ try{return JSON.parse(localStorage.getItem(LS_PROFILE))||null}catch(e){return null} },
  setProfile(p){ localStorage.setItem(LS_PROFILE, JSON.stringify(p)); },
  getCity(){ return localStorage.getItem(LS_CITY) || null; },
  setCity(c){ localStorage.setItem(LS_CITY, c); },
  getRole(){ return localStorage.getItem(LS_ROLE) || null; },
  setRole(r){ localStorage.setItem(LS_ROLE, r); },
  setTheme(t){ localStorage.setItem(LS_THEME, t); },
  getTheme(){ return localStorage.getItem(LS_THEME) || 'violet'; }
};

/* util */
function uid(){ return Math.random().toString(36).slice(2,9); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function initials(name){ if(!name) return '?'; const p=name.trim().split(/\s+/); return (p[0].slice(0,2)).toUpperCase(); }
function avatarStyle(name, el){ const h=Array.from(name||'').reduce((s,c)=> s + c.charCodeAt(0),0); const pal=['#b37aff','#8f7bff','#7BFF5A','#61e6ff','#ffaa6b']; const a=pal[h%pal.length], b=pal[(h+2)%pal.length]; el.style.background = `linear-gradient(135deg, ${a}, ${b})`; el.textContent = initials(name); }

/* seed sample data if empty */
if(!localStorage.getItem(LS_ORDERS)){
  Store.setOrders([
    { id:'o1', category:'Такси', city:'Алматы', budget:800, datetime: todayISO()+"T12:00", desc:'Поездка до аэропорта', ownerId:'owner_1', ownerName:'Айдар', bids:[], status:'open' },
    { id:'o2', category:'Доставка еды', city:'Астана', budget:1200, datetime: todayISO()+"T13:00", desc:'Доставка обеда', ownerId:'owner_2', ownerName:'Салтанат', bids:[], status:'open' }
  ]);
}

/* Elements */
const menuList = document.getElementById('menuList');
const topCity = document.getElementById('topCity');
const settingsBtn = document.getElementById('openSettings'), settingsPanel = document.getElementById('settingsPanel'), closeSettings = document.getElementById('closeSettings');
const authScreen = document.getElementById('authScreen'), cityScreen = document.getElementById('cityScreen'), roleScreen = document.getElementById('roleScreen');
const findScreen = document.getElementById('findScreen'), createScreen = document.getElementById('createScreen'), mineScreen = document.getElementById('mineScreen'), messengerScreen = document.getElementById('messengerScreen');

/* initial theme apply */
applyTheme(Store.getTheme());

/* Build menu according to role */
function buildMenu(){
  menuList.innerHTML='';
  const role = Store.getRole() || 'user';
  // define menu items depending on role
  const menuForUser = [
    {id:'create', title:'ЗАКАЗАТЬ', sub:'новое', special:true},
    {id:'wallet', title:'Кошелёк', sub:`₸ ${Store.getWallet().balance||0}`},
    {id:'messenger', title:'Мессенджер', sub:'Чаты'},
    {id:'mine', title:'Мои заказы', sub:'Ваши заявки'}
  ];
  const menuForWorker = [
    {id:'find', title:'Найти заказы', sub:`${Store.getOrders().filter(o=>o.status==='open').length}`},
    {id:'wallet', title:'Кошелёк', sub:`₸ ${Store.getWallet().balance||0}`},
    {id:'messenger', title:'Мессенджер', sub:'Чаты'},
    {id:'mine', title:'Мои заказы', sub:'Ваши заявки'}
  ];
  const items = role==='worker'? menuForWorker : menuForUser;
  items.forEach(it=>{
    const el = document.createElement('div'); el.className='menu-item' + (it.special? ' special':''); el.setAttribute('data-action', it.id);
    el.innerHTML = `<div class="menu-title">${it.title}</div><div class="menu-sub">${it.sub||''}</div>`;
    el.onclick = ()=> menuAction(it.id);
    menuList.appendChild(el);
  });
}

/* menu action handler */
function menuAction(action){
  if(action==='create'){ openScreen('createScreen'); }
  else if(action==='find'){ openScreen('findScreen'); renderFindList(); }
  else if(action==='wallet'){ openScreen('walletScreen'); }
  else if(action==='messenger'){ openScreen('messengerScreen'); refreshChats(); }
  else if(action==='mine'){ openScreen('mineScreen'); renderMineList(); }
}

/* Open/close screen helper */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.style.display='none'); const s=document.getElementById(id); if(s) s.style.display='block'; }
function closeScreen(id){ const s=document.getElementById(id); if(s) s.style.display='none'; }

/* AUTH flow */
document.getElementById('authForm').addEventListener('submit',(e)=>{
  e.preventDefault();
  const login = document.getElementById('authLogin').value.trim(), pass = document.getElementById('authPass').value.trim();
  if(!login || !pass){ alert('Введите логин и пароль'); return; }
  const profile = { id:'u_'+uid(), login, name: login.split('@')[0]||login, phone:'', createdAt:new Date().toISOString() };
  Store.setProfile(profile);
  // go to city
  openScreen('cityScreen'); renderCityList();
});
document.getElementById('regBtn').addEventListener('click', ()=> {
  const login = prompt('Email или телефон для регистрации:','user@example.com'); if(!login) return;
  const profile = { id:'u_'+uid(), login, name: login.split('@')[0]||login, phone:'', createdAt:new Date().toISOString() };
  Store.setProfile(profile);
  openScreen('cityScreen'); renderCityList();
});

/* CITY screen */
const CITIES = ["Алматы","Астана","Шымкент","Караганда","Актобе","Костанай","Павлодар","Усть-Каменогорск","Тараз","Кызылорда","Петропавловск","Семей","Атырау","Актау","Уральск"];
function renderCityList(filter=''){
  const list = document.getElementById('cityList'); list.innerHTML='';
  const q=(filter||'').toLowerCase();
  CITIES.filter(c=>c.toLowerCase().includes(q)).forEach(c=>{
    const el=document.createElement('div'); el.className='city-item'; el.textContent=c;
    if(Store.getCity()===c) el.classList.add('active');
    el.onclick = ()=> { document.querySelectorAll('.city-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); Store.setCity(c); };
    list.appendChild(el);
  });
}
document.getElementById('citySearch').addEventListener('input',(e)=> renderCityList(e.target.value));
document.getElementById('cityConfirm').addEventListener('click', ()=>{
  const c = Store.getCity();
  if(!c){ alert('Выберите город'); return; }
  topCity.textContent = c;
  // go to role select
  openScreen('roleScreen');
});
document.getElementById('cityBack').addEventListener('click', ()=> openScreen('authScreen'));

/* ROLE screen */
document.getElementById('roleUser').onclick = ()=> { Store.setRole('user'); applyRoleChange(); };
document.getElementById('roleWorker').onclick = ()=> { Store.setRole('worker'); applyRoleChange(); };

/* Apply role change and rebuild UI */
function applyRoleChange(){
  buildMenu();
  closeScreen('roleScreen'); closeScreen('cityScreen'); closeScreen('authScreen');
  // if desired: auto-open create/find depending on role
  // show main container (which is visible) and keep settings panel closed
  refreshAll();
}

/* INITIAL flow: if no profile -> show auth, else if no city -> city, else if no role -> role, else build menu */
function initialFlow(){
  const profile = Store.getProfile();
  if(!profile){ openScreen('authScreen'); return; }
  const city = Store.getCity();
  if(!city){ openScreen('cityScreen'); renderCityList(); return; }
  const role = Store.getRole();
  if(!role){ openScreen('roleScreen'); return; }
  // else normal
  buildMenu();
  topCity.textContent = city;
  refreshAll();
}

/* RENDER find list */
function renderFindList(){
  const list = document.getElementById('findList'); list.innerHTML='';
  const q = (document.getElementById('searchInput').value||'').toLowerCase().trim();
  const activeTab = document.querySelector('#findTabs .tab.active')?.getAttribute('data-tab') || 'all';
  let items = Store.getOrders().filter(o=> o.status==='open');
  if(activeTab==='spec') items = items.filter(o=> (o.category||'').toLowerCase().includes('спец'));
  if(activeTab==='taxi') items = items.filter(o=> (o.category||'').toLowerCase().includes('такси'));
  if(activeTab==='food') items = items.filter(o=> (o.category||'').toLowerCase().includes('доставка') || (o.category||'').toLowerCase().includes('еда'));
  if(q) items = items.filter(o=> (o.city||'').toLowerCase().includes(q) || (o.category||'').toLowerCase().includes(q) || (o.desc||'').toLowerCase().includes(q));
  if(items.length===0){ list.innerHTML = '<div style="color:var(--muted)">Ничего не найдено</div>'; return; }
  items.forEach(o=>{
    const card = document.createElement('div'); card.className='card';
    const left = document.createElement('div'); left.className='card-left';
    const av = document.createElement('div'); av.className='avatar'; avatarStyle(o.ownerName||o.ownerId||'Z', av);
    left.appendChild(av);
    const body = document.createElement('div'); body.className='card-body';
    const top = document.createElement('div'); top.className='card-top';
    const titleWrap = document.createElement('div');
    const title = document.createElement('div'); title.className='card-title'; title.textContent = `${o.category} • ${o.city}`;
    const meta = document.createElement('div'); meta.className='card-meta'; meta.textContent = `Дедлайн: ${o.datetime? o.datetime.replace('T',' '):''} • Заказчик: ${o.ownerName||'—'}`;
    titleWrap.appendChild(title); titleWrap.appendChild(meta);
    const price = document.createElement('div'); price.style.textAlign='right'; price.innerHTML = `<div style="font-weight:800; font-size:15px">₸ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>`;
    top.appendChild(titleWrap); top.appendChild(price);
    const desc = document.createElement('div'); desc.className='card-desc'; desc.textContent = o.desc || '';
    const ctaRow = document.createElement('div'); ctaRow.style.marginTop='8px';
    const bidBtn = document.createElement('button'); bidBtn.className='btn secondary'; bidBtn.textContent='Предложить цену';
    bidBtn.onclick = ()=> openBidModalForOrder(o.id);
    ctaRow.appendChild(bidBtn);
    body.appendChild(top); body.appendChild(desc); body.appendChild(ctaRow);
    card.appendChild(left); card.appendChild(body);
    list.appendChild(card);
  });
}

/* render mine list */
function renderMineList(){
  const list = document.getElementById('mineList'); list.innerHTML='';
  const profile = Store.getProfile();
  if(!profile){ list.innerHTML = '<div style="color:var(--muted)">Войдите в профиль</div>'; return; }
  const orders = Store.getOrders().filter(o=> o.ownerId === profile.id);
  if(orders.length===0){ list.innerHTML = '<div style="color:var(--muted)">Пока нет заказов</div>'; return; }
  orders.forEach(o=>{
    const card = document.createElement('div'); card.className='card';
    const left = document.createElement('div'); left.className='card-left';
    const av = document.createElement('div'); av.className='avatar'; avatarStyle(o.ownerName||'Вы', av);
    left.appendChild(av);
    const body = document.createElement('div'); body.className='card-body';
    const top = document.createElement('div'); top.className='card-top';
    const title = document.createElement('div'); title.className='card-title'; title.textContent = `${o.category} • ${o.city}`;
    const price = document.createElement('div'); price.style.textAlign='right'; price.innerHTML = `<div style="font-weight:800; font-size:15px">₸ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>`;
    top.appendChild(title); top.appendChild(price);
    const meta = document.createElement('div'); meta.className='card-meta'; meta.textContent = `Дедлайн: ${o.datetime||''} • Статус: ${o.status||'open'}`;
    const desc = document.createElement('div'); desc.className='card-desc'; desc.textContent = o.desc || '';
    const actions = document.createElement('div'); actions.style.marginTop='8px';
    const viewBids = document.createElement('button'); viewBids.className='btn secondary'; viewBids.textContent='Просмотр заявок'; viewBids.onclick = ()=> showBidsForOrder(o.id);
    actions.appendChild(viewBids);
    body.appendChild(top); body.appendChild(meta); body.appendChild(desc); body.appendChild(actions);
    card.appendChild(left); card.appendChild(body);
    list.appendChild(card);
  });
}

/* bids modal flow */
let currentBidOrderId = null;
const bidModalWrap = document.getElementById('bidModalWrap'), bidPrice = document.getElementById('bidPrice'), bidComment = document.getElementById('bidComment');
document.getElementById('closeBidBtn').onclick = ()=> { bidModalWrap.classList.remove('active'); currentBidOrderId=null; };
document.getElementById('sendBidBtn').onclick = ()=>{
  const price = Number(bidPrice.value||0), comment = bidComment.value||'', profile = Store.getProfile() || { id:'p_'+uid(), name:'Исполнитель' };
  if(!(price>0)){ alert('Укажите корректную цену'); return; }
  if(!currentBidOrderId){ alert('Нет заказа'); return; }
  Store.updateOrder(currentBidOrderId, (o)=>{ if(!Array.isArray(o.bids)) o.bids=[]; o.bids.push({ price, name: profile.name||profile.login||'Исполнитель', performerId: profile.id||('p_'+uid()), comment, createdAt:new Date().toISOString() }); });
  bidModalWrap.classList.remove('active'); currentBidOrderId=null; bidPrice.value=''; bidComment.value='';
  alert('Предложение отправлено ✅'); renderFindList();
};
function openBidModalForOrder(orderId){ currentBidOrderId = orderId; bidModalWrap.classList.add('active'); }

/* show bids and accept (owner) */
function showBidsForOrder(orderId){
  const order = Store.getOrders().find(o=>o.id===orderId);
  if(!order) return alert('Заказ не найден');
  openScreen('mineScreen');
  setTimeout(()=>{
    const panel = document.querySelector('#mineScreen .panel');
    // remove old block
    const old = panel.querySelector('.bids-block'); if(old) old.remove();
    const block = document.createElement('div'); block.className='bids-block'; block.style.marginTop='10px';
    block.innerHTML = `<div style="font-weight:800;margin-bottom:8px">Заявки</div>`;
    const bids = order.bids || [];
    if(!bids.length){ block.innerHTML += '<div style="color:var(--muted)">Пока нет заявок</div>'; panel.appendChild(block); return; }
    bids.forEach((b,idx)=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='8px 0';
      const av = document.createElement('div'); av.className='avatar'; av.style.width='40px'; av.style.height='40px'; avatarStyle(b.name||'И', av);
      const body = document.createElement('div'); body.style.flex='1'; body.innerHTML = `<div style="font-weight:800">${b.name} — ₸ ${b.price}</div><div style="color:var(--muted);font-size:13px">${b.comment||''}</div>`;
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
      const accept = document.createElement('button'); accept.className='btn primary'; accept.textContent='Принять'; accept.onclick = ()=> acceptBid(orderId, idx);
      const reject = document.createElement('button'); reject.className='btn ghost'; reject.textContent='Отклонить'; reject.onclick = ()=> { Store.updateOrder(orderId, (oo)=>{ oo.bids = (oo.bids||[]).filter((_,i)=>i!==idx); }); showBidsForOrder(orderId); };
      actions.appendChild(accept); actions.appendChild(reject);
      row.appendChild(av); row.appendChild(body); row.appendChild(actions);
      block.appendChild(row);
    });
    panel.appendChild(block);
  }, 160);
}

/* accept -> mark order and create chat */
function acceptBid(orderId, bidIndex){
  const order = Store.getOrders().find(o=>o.id===orderId);
  if(!order) return;
  const bid = (order.bids||[])[bidIndex];
  if(!bid) return;
  Store.updateOrder(orderId, (o)=>{ o.status='in_progress'; o.assigned={ performerId: bid.performerId, performerName: bid.name, price: bid.price }; });
  const chat = { id:'chat_'+uid(), orderId, title: `${order.category} • ${order.city}`, participants:[order.ownerId, bid.performerId], meta:{ ownerName: order.ownerName, performerName: bid.name }, messages:[{ from:'system', text:`Чат создан между ${order.ownerName||'Заказчик'} и ${bid.name}`, ts:new Date().toISOString() }] };
  Store.addChat(chat);
  renderFindList(); renderMineList(); refreshChats();
  openScreen('messengerScreen');
  setTimeout(()=> openChat(chat.id), 200);
  alert('Заявка принята — чат создан');
}

/* chat functions */
function refreshChats(){
  const list = document.getElementById('chatsList'); list.innerHTML=''; const chats = Store.getChats();
  if(!chats.length){ list.innerHTML = '<div style="color:var(--muted)">Пока нет чатов</div>'; return; }
  chats.forEach(c=>{ const el = document.createElement('div'); el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.style.padding='8px'; el.style.cursor='pointer'; const av=document.createElement('div'); av.className='avatar'; av.style.width='40px'; av.style.height='40px'; avatarStyle(c.meta?.performerName||c.meta?.ownerName||'Ч', av); const t=document.createElement('div'); t.innerHTML = `<div style="font-weight:800">${c.title}</div><div style="color:var(--muted);font-size:13px">${c.meta?.performerName||''}</div>`; el.appendChild(av); el.appendChild(t); el.onclick = ()=> openChat(c.id); list.appendChild(el); });
}
function openChat(chatId){ const chat = Store.getChats().find(c=>c.id===chatId); if(!chat) return; document.getElementById('chatView').style.display='flex'; document.getElementById('noChat').style.display='none'; document.getElementById('chatTitle').textContent = chat.title; avatarStyle(chat.meta?.performerName||chat.meta?.ownerName||'Ч', document.getElementById('chatAvatar')); const msgs = document.getElementById('messages'); msgs.innerHTML=''; (chat.messages||[]).forEach(m=>{ const d=document.createElement('div'); d.style.marginBottom='8px'; if(m.from==='system'){ d.style.color='var(--muted)'; d.style.textAlign='center'; d.textContent = m.text; } else if(m.from==='me'){ d.style.alignSelf='flex-end'; d.style.background='linear-gradient(180deg, rgba(123,255,90,0.06), rgba(123,255,90,0.03))'; d.style.padding='8px 12px'; d.style.borderRadius='10px'; d.textContent = m.text; } else { d.style.alignSelf='flex-start'; d.style.background='rgba(255,255,255,0.02)'; d.style.padding='8px 12px'; d.style.borderRadius='10px'; d.textContent = (m.fromName? m.fromName+': ':'') + m.text; } msgs.appendChild(d); }); msgs.scrollTop = msgs.scrollHeight; document.getElementById('sendMsgBtn').onclick = ()=> { const v=document.getElementById('messageInput').value.trim(); if(!v) return; Store.updateChat(chatId, (c)=>{ c.messages.push({ from:'me', text:v, ts:new Date().toISOString() }); }); document.getElementById('messageInput').value=''; openChat(chatId); };
}

/* create order submit */
document.getElementById('createForm').addEventListener('submit',(e)=>{ e.preventDefault(); const profile = Store.getProfile(); if(!profile){ alert('Сначала войдите'); openScreen('authScreen'); return; } const category = document.querySelector('#createTabs .tab.active')?.getAttribute('data-val')||'Другое'; const city = Store.getCity()||'—'; const budget = Number(document.getElementById('c-budget').value)||0; const datetime = document.getElementById('c-datetime').value || ''; const desc = document.getElementById('c-desc').value||''; if(!desc||!datetime){ alert('Заполните описание и дату'); return;} const order = { id:'o_'+uid(), category, city, budget, datetime, desc, ownerId:profile.id, ownerName:profile.name, bids:[], status:'open' }; Store.addOrder(order); alert('Заказ создан'); closeScreen('createScreen'); renderFindList(); renderMineList(); refreshAll(); });

/* tabs click handlers */
document.querySelectorAll('.tabs').forEach(tabWrap=>{ tabWrap.addEventListener('click', (e)=>{ const t=e.target.closest('.tab'); if(!t) return; tabWrap.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); if(tabWrap.id==='findTabs') renderFindList(); if(tabWrap.id==='createTabs') document.getElementById('selectedCategory').textContent = t.getAttribute('data-val') || t.textContent; }); });
document.getElementById('applySearch').onclick = ()=> renderFindList();

/* settings panel open/close */
settingsBtn.onclick = ()=> { settingsPanel.classList.add('open'); settingsPanel.setAttribute('aria-hidden','false'); };
closeSettings.onclick = ()=> { settingsPanel.classList.remove('open'); settingsPanel.setAttribute('aria-hidden','true'); };

/* settings: role switch */
document.getElementById('setRoleUser').onclick = ()=> { Store.setRole('user'); applyRoleChangeFromSettings(); };
document.getElementById('setRoleWorker').onclick = ()=> { Store.setRole('worker'); applyRoleChangeFromSettings(); };
function applyRoleChangeFromSettings(){ settingsPanel.classList.remove('open'); buildMenu(); refreshAll(); alert('Роль обновлена'); }

/* settings: theme */
document.querySelectorAll('.settings-panel [data-theme]').forEach(b=> b.addEventListener('click', (e)=>{ const t=e.currentTarget.getAttribute('data-theme'); Store.setTheme(t); applyTheme(t); }));
document.getElementById('resetTheme').onclick = ()=> { Store.setTheme('violet'); applyTheme('violet'); };
function applyTheme(name){
  // apply CSS variables for basic themes
  if(name==='violet'){ document.documentElement.style.setProperty('--bg-grad-1','#6f5bff'); document.documentElement.style.setProperty('--bg-grad-2','#000'); document.documentElement.style.setProperty('--bg-grad-3','#06122a'); document.documentElement.style.setProperty('--accent1','#b37aff'); document.documentElement.style.setProperty('--accent2','#7BFF5A'); }
  if(name==='navy'){ document.documentElement.style.setProperty('--bg-grad-1','#0b2540'); document.documentElement.style.setProperty('--bg-grad-2','#020815'); document.documentElement.style.setProperty('--bg-grad-3','#001029'); document.documentElement.style.setProperty('--accent1','#4fa3ff'); document.documentElement.style.setProperty('--accent2','#7be4ff'); }
  if(name==='warm'){ document.documentElement.style.setProperty('--bg-grad-1','#ff9f6b'); document.documentElement.style.setProperty('--bg-grad-2','#3b1a00'); document.documentElement.style.setProperty('--bg-grad-3','#20110a'); document.documentElement.style.setProperty('--accent1','#ffb86b'); document.documentElement.style.setProperty('--accent2','#ff7b6b'); }
  // save
  Store.setTheme(name);
}

/* logout */
document.getElementById('logoutBtn').onclick = ()=> { if(confirm('Выйти из аккаунта?')){ localStorage.removeItem(LS_PROFILE); localStorage.removeItem(LS_ROLE); initialFlow(); } };

/* open initial flow and menu */
function refreshAll(){ buildMenu(); topCity.textContent = Store.getCity() || '—'; renderFindList(); renderMineList(); refreshChats(); }
function initialFlow(){ const prof = Store.getProfile(); if(!prof){ openScreen('authScreen'); } else if(!Store.getCity()){ openScreen('cityScreen'); renderCityList(); } else if(!Store.getRole()){ openScreen('roleScreen'); } else { buildMenu(); topCity.textContent = Store.getCity(); } }
initialFlow();

/* small helpers to update lists after changes */
function refreshChats(){ refreshChats = refreshChats || (()=>{}); try{ refreshChats(); }catch(e){} }

/* open menus helper for non-role items: ensure permission */
function safeMenuAction(action){
  const role = Store.getRole();
  if(action==='find' && role!=='worker'){ alert('Функция "Найти заказы" доступна только исполнителям. В настройках можно сменить роль.'); return; }
  if(action==='create' && role!=='user'){ alert('Функция "ЗАКАЗАТЬ" доступна только пользователям. В настройках можно сменить роль.'); return; }
  menuAction(action);
}

/* replace menu click to safeMenuAction */
menuList.addEventListener('click', (e)=>{ const it = e.target.closest('.menu-item'); if(!it) return; const a = it.getAttribute('data-action'); safeMenuAction(a); });

/* small: show auth if no profile and reload on page load */
document.addEventListener('DOMContentLoaded', ()=> { /* ensure components rendered */ });

</script>
</body>
</html>
