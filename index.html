<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (—Å –∫–∞—Ä—Ç–æ–π)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg1:#5b2cff; --bg2:#0a0a0a; --panel:#0a0a0a; --accent:#ffd54a; --glass-bg:rgba(255,255,255,0.02); --glass-border:rgba(255,255,255,0.06);
    --text:#f2f2f2; --muted:rgba(242,242,242,0.62); --radius:12px; --gap:12px;
  }

  /* base layout */
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:linear-gradient(160deg,var(--bg1) 0%, #2b0b3a 40%, var(--bg2) 100%);color:var(--text);display:flex;align-items:center;justify-content:center;padding:12px;}
  .phone{width:380px;max-width:calc(100% - 24px);height:812px;border-radius:30px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.6);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));position:relative}
  /* header */
  .header{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;backdrop-filter: blur(6px);background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid var(--glass-border);position:relative;z-index:40}
  .title{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:50%;background:var(--glass-bg);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(91,44,255,0.12);border:1px solid var(--glass-border);overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .app-name{font-weight:900;font-size:18px;display:flex;gap:8px;align-items:center}
  .app-name small{font-weight:700;font-size:11px;color:var(--muted);display:none} /* —Å–ª–æ–≤–æ "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" —Å–∫—Ä—ã—Ç–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é */
  .header-center{display:flex;align-items:center;gap:8px}
  .calendar-btn{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);font-weight:700;cursor:pointer}
  .header-actions{display:flex;gap:8px;align-items:center; margin-right:6px;} /* —á—É—Ç—å –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É (—É–º–µ–Ω—å—à–∏–ª –ø—Ä–∞–≤—ã–π –æ—Ç—Å—Ç—É–ø) */
  .icon-btn{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--glass-bg);border:1px solid var(--glass-border);cursor:pointer;position:relative}
  .notif-badge{position:absolute;top:-6px;right:-6px;background:var(--accent);color:#081018;padding:4px 6px;border-radius:12px;font-weight:800;font-size:11px}

  /* content */
  .content{padding:12px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .city-block{display:flex;flex-direction:column}
  .city-name{font-weight:800;font-size:18px;margin:0}
  .city-sub{font-size:12px;color:var(--muted)}
  .center-area{display:flex;align-items:center;gap:12px}
  .weather{padding:6px 12px;border-radius:12px;background:var(--panel);border:1px solid var(--glass-border);font-weight:700;display:flex;align-items:center;gap:8px}
  .status-badge{font-size:12px;color:var(--muted);padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.01);border:1px solid var(--glass-border);cursor:pointer;min-width:70px;text-align:center} /* –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */

  /* tabs */
  .tabs{display:flex;gap:8px;margin-top:6px}
  .tab{flex:1;padding:8px;border-radius:12px;text-align:center;background:transparent;border:1px solid var(--glass-border);cursor:pointer;color:var(--muted);font-weight:800;transition:all 180ms}
  .tab.service-active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#081018;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25);background-color:var(--accent);font-weight:900}
  .tab.work-active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#081018;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25);background-color:#4cd964; font-weight:900}

  /* main card */
  .main-card{background:var(--panel);border-radius:14px;padding:12px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:10px;flex:1;min-height:240px;overflow:hidden}
  .menu-list{flex:1;display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px}
  .menu-item{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center;min-height:62px;cursor:pointer}
  .menu-item.gidchat{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,215,74,0.16)}
  .menu-item .left{display:flex;flex-direction:column}
  .menu-item .title{font-weight:900;font-size:16px}
  .menu-item .title.gidchat{font-size:18px;letter-spacing:0.6px}
  .menu-item .caption{font-size:12px;color:var(--muted)}
  footer{padding:8px 12px;border-top:1px solid rgba(255,255,255,0.02);font-size:12px;color:var(--muted);text-align:center}

  /* map collapse */
  .map-panel{border-radius:10px;border:1px solid var(--glass-border);overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));transition:all 280ms ease;position:relative}
  .map-header{display:flex;align-items:center;gap:8px;padding:8px}
  .map-toggle{flex:1;display:flex;align-items:center;gap:8px;cursor:pointer}
  .map-actions{display:flex;gap:6px}
  .map-body{height:260px}
  #map{height:100%}
  .map-expanded{height:340px}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal{width:100%;max-width:640px;background:linear-gradient(180deg,var(--panel),#070707);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:0 30px 80px rgba(0,0,0,0.7);max-height:90vh;overflow:auto}
  .modal.fullscreen{max-width:100%;width:100%;height:100%;max-height:100%;border-radius:0;padding:18px;display:flex;flex-direction:column}
  .modal .modal-body{flex:1;overflow:auto}
  label{font-size:13px;color:var(--muted);display:block;margin:6px 0 4px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  textarea{min-height:90px}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);font-weight:800;font-size:13px} /* —É–º–µ–Ω—å—à–∏–ª —à—Ä–∏—Ñ—Ç –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≥–ª–∞–≤–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
  .btn.primary{background:linear-gradient(90deg,var(--accent),#ffb347);color:#081018}
  .gidchat-holo{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg, rgba(255,215,74,0.08), rgba(255,255,255,0.02));border:1px solid rgba(255,215,74,0.22);box-shadow:0 10px 40px rgba(255,215,74,0.06);font-weight:900}

  /* theme previews in settings */
  .theme-swatch{width:36px;height:24px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);display:inline-block;margin-right:8px;vertical-align:middle}

  /* responsive */
  @media(max-width:420px){.phone{width:100%;height:100vh;border-radius:0}}
</style>
</head>
<body>
<div class="phone" role="application" aria-label="GiDCity prototype">
  <!-- HEADER -->
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview">G</div>
      <div>
        <div class="app-name"><span>GiDCity</span> <small>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small></div>
      </div>
    </div>

    <!-- calendar stays in header as requested -->
    <div class="header-center">
      <button class="calendar-btn" id="calendarBtn">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    </div>

    <div class="header-actions">
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="settings">‚öôÔ∏è</div>
      <!-- –£–±—Ä–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–≤–µ—Ä—Ö—É –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é ‚Äî —Ç–µ–ø–µ—Ä—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–≥–æ–¥—ã -->
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="top-row">
      <div class="city-block">
        <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
        <div class="city-sub" id="citySub">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
      </div>

      <!-- center area: only weather moved here (calendar left in header) -->
      <div class="center-area">
        <div class="weather" id="weatherBlock">‚Äî ¬∞C</div>

        <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä—è–¥–æ–º —Å –ø–æ–≥–æ–¥–æ–π (—Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–≥–æ–¥—ã) -->
        <div class="icon-btn" id="weatherNotifBtn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" aria-label="notifications">üîî<div class="notif-badge" id="weatherNotifCount">0</div></div>
      </div>

      <!-- right status as rectangular button (was "–û–Ω–ª–∞–π–Ω") -->
      <div class="status-badge" id="onlineBtn" role="button" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞">–û–Ω–ª–∞–π–Ω</div>
    </div>

    <div class="tabs">
      <div class="tab" id="tabServices">–£–°–õ–£–ì–ò</div>
      <div class="tab" id="tabWork">–†–ê–ë–û–¢–ê</div>
    </div>

    <div class="main-card" id="mainCard">
      <!-- –∫–∞—Ä—Ç–∞ —Ç–µ–ø–µ—Ä—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–æ–π.
           –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª: –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "—Ä–∞–±–æ—Ç–∞" –∫–∞—Ä—Ç–∞ ‚Äî –∫–Ω–æ–ø–∫–∞, –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è –º–æ–¥–∞–ª–∫—É —Å –∫–∞—Ä—Ç–æ–π.
           –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É" -->
      <div class="map-panel map-expanded" id="mapPanel" style="height:120px;overflow:hidden">
        <div class="map-header">
          <div class="map-toggle" id="mapToggle">
            <div style="font-weight:800">–ö–∞—Ä—Ç–∞ –≥–æ—Ä–æ–¥–∞</div>
            <div style="color:var(--muted);font-size:12px">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –≤ –º–æ–¥–∞–ª–∫–µ</div>
          </div>
          <div class="map-actions">
            <button class="btn" id="openMapModalBtn">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
          </div>
        </div>
        <div style="padding:8px;color:var(--muted);font-size:13px">–ö–ª–∏–∫–Ω–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É¬ª ‚Äî –º–∞—Ä—à—Ä—É—Ç –º–æ–∂–Ω–æ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –≤ –º–æ–¥–∞–ª–∫–µ.</div>
      </div>

      <!-- –º–µ–Ω—é (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ) -->
      <div>
        <div class="menu-list" id="menuList"></div>
      </div>
    </div>
  </div>

  <footer id="appFooter">GiDCity ‚Ä¢ –º–∞–∫–µ—Ç ‚Äî –∫–∞—Ä—Ç–∞: OpenRouteService</footer>
</div>

<!-- –º–æ–¥–∞–ª–∫–∏ -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalWindow" role="dialog" aria-modal="true">
    <div class="modal-body" id="modalContent"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<!-- –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===========================
   GiDCity Unified Prototype ‚Äî updated per user's requests
   - –í–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è:
     * –£–±—Ä–∞–Ω–∞ –≤–µ—Ä—Ö–Ω—è—è –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–≥–æ–¥—ã
     * GIDChat –æ—Ç–∫—Ä—ã—Ç –∫–∞–∫ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ (fullscreen) –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ª–∏—Å—Ç–∞–Ω–∏—è –ª–µ–Ω—Ç—ã
     * –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–≤–∞—Ç–∞—Ä + –∏–º—è + —Ñ–∞–º–∏–ª–∏—é (–µ—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∞ ‚Äî –ø–æ–∫–∞–∑–∞–Ω –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∏ "–ê–Ω–æ–Ω–∏–º")
     * –ö–Ω–æ–ø–∫–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"
     * –®—Ä–∏—Ñ—Ç –∫–Ω–æ–ø–æ–∫ —É–º–µ–Ω—å—à–µ–Ω (—Å–º. CSS)
   =========================== */

/* -------------------
   Configuration (unchanged keys)
   ------------------- */
const OPENROUTESERVICE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjcyZWNiZDAxMGJlNTRjY2E4NDQwYTVlYmM2N2U1NzdkIiwiaCI6Im11cm11cjY0In0=';
const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG';
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const USE_JSONBIN = true;
const PULL_INTERVAL_MS = 15000;

/* -------------------
   State
   ------------------- */
const appStateKey = 'gidcity_state_live_v3';
let state = {
  __updatedAt: new Date(0).toISOString(),
  user: null,
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance:0},
  reminders: []
};
function loadState(){ try{ const raw=localStorage.getItem(appStateKey); if(raw) Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); } }
function localSave(){ localStorage.setItem(appStateKey, JSON.stringify(state)); }

/* JSONBin sync helpers (unchanged) */
async function syncToJSONBin(){ if(!USE_JSONBIN) return; try{
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  state.__updatedAt = new Date().toISOString();
  const payload = {state, updatedAt: state.__updatedAt};
  const resp = await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY},body:JSON.stringify(payload)});
  if(!resp.ok) throw new Error('JSONBin save failed');
  return resp.json();
}catch(e){ console.warn('sync error', e); throw e; } }
async function loadFromJSONBin(){ if(!USE_JSONBIN) return null; try{
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const resp = await fetch(url,{headers:{'X-Master-Key':JSONBIN_KEY}});
  if(!resp.ok) throw new Error('JSONBin load failed');
  const data = await resp.json(); return data;
}catch(e){ console.warn(e); return null; } }

let pullTimer = null;
async function pullAndMerge(){ if(!USE_JSONBIN) return;
  try{
    const data = await loadFromJSONBin();
    if(data && data.record && data.record.state){
      const remoteUpdated = data.updatedAt || data.record.state.__updatedAt;
      if(remoteUpdated && new Date(remoteUpdated) > new Date(state.__updatedAt || 0)){
        state = data.record.state || state; if(data.updatedAt) state.__updatedAt = data.updatedAt; localSave(); renderAll(); setSyncStatus('—Å–∏–Ω—Ö—Ä. JSONBin');
      }
    }
  }catch(e){ console.warn('pull err', e); setSyncStatus('–æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä.'); }
}
function startPeriodicPull(){ if(pullTimer) clearInterval(pullTimer); if(USE_JSONBIN) pullTimer = setInterval(pullAndMerge, PULL_INTERVAL_MS); }

/* -------------------
   UI Refs & helpers
   ------------------- */
function el(id){ return document.getElementById(id); }
function setSyncStatus(txt){ const s = el('onlineBtn'); if(s) s.textContent = txt; }

/* -------------------
   Themes (—Ä–∞—Å—à–∏—Ä–∏–ª)
   ------------------- */
const THEMES = {
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π':{top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a', border:'rgba(255,255,255,0.06)', glass:'rgba(255,255,255,0.02)'},
  'gold':{top:'#3b2b14', bottom:'#0b0703', accent:'#ffd54a', border:'rgba(255,215,74,0.12)', glass:'rgba(255,215,74,0.03)'},
  'holo':{top:'#06103a', bottom:'#0b0033', accent:'#7bf0ff', border:'rgba(123,240,255,0.08)', glass:'rgba(123,240,255,0.03)'},
  'neon':{top:'#001219', bottom:'#060014', accent:'#ff3bff', border:'rgba(255,59,255,0.12)', glass:'rgba(255,59,255,0.03)'},
  'sunset':{top:'#ff7a59', bottom:'#2b0b3a', accent:'#ffd54a', border:'rgba(255,122,89,0.12)', glass:'rgba(255,122,89,0.03)'},
  'forest':{top:'#0b5d3a', bottom:'#02120a', accent:'#7fffd4', border:'rgba(127,255,212,0.08)', glass:'rgba(127,255,212,0.03)'}
};
function applyTheme(name){
  const t = THEMES[name] || THEMES['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  document.documentElement.style.setProperty('--bg1', t.top);
  document.documentElement.style.setProperty('--bg2', t.bottom);
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--glass-border', t.border);
  document.documentElement.style.setProperty('--glass-bg', t.glass);
  state.theme = name; localSave();
  updateTabsVisual();
}

/* -------------------
   Map (modal version; –æ—Å–Ω–æ–≤–Ω–æ–π map –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–∞–Ω–µ–ª–∏)
   ------------------- */
let map=null, fromMarker=null, toMarker=null, routeLayer=null, searchMarkers=[];
let modalMap = null, modalFrom=null, modalTo=null, modalRouteLayer=null;
const DEFAULT_CENTER = {lat:49.8062, lon:73.0851, zoom:13};

function initMapIfNeeded(){
  if(map) return;
  try{
    map = L.map('map').setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lon], DEFAULT_CENTER.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(map);
    map.on('click', e=>{
      if(map._setMode==='from'){ setFromPoint(e.latlng); map._setMode=null; }
      else if(map._setMode==='to'){ setToPoint(e.latlng); map._setMode=null; }
    });
  }catch(e){ console.warn('map init err', e); /* –∫–∞—Ä—Ç–∞ –ø–∞–Ω–µ–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ */ }
}
function initModalMapIfNeeded(){
  if(modalMap) return;
  try{
    // —Å–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä #modalMap –≤ –º–æ–¥–∞–ª–∫–µ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    modalMap = L.map('modalMap').setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lon], DEFAULT_CENTER.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(modalMap);
    modalMap.on('click', e=>{
      if(modalMap._setMode==='from'){ setModalFrom(e.latlng); modalMap._setMode=null; }
      else if(modalMap._setMode==='to'){ setModalTo(e.latlng); modalMap._setMode=null; }
    });
  }catch(e){ console.warn('modal map err', e); alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –≤ –º–æ–¥–∞–ª–∫–µ.'); }
}
function setFromPoint(latlng){ if(fromMarker) map.removeLayer(fromMarker); fromMarker = L.marker(latlng,{title:'A',draggable:true}).addTo(map).bindPopup('A ‚Äì –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ').openPopup(); fromMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); }); }
function setToPoint(latlng){ if(toMarker) map.removeLayer(toMarker); toMarker = L.marker(latlng,{title:'B',draggable:true}).addTo(map).bindPopup('B ‚Äì –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ').openPopup(); toMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); }); }
function setModalFrom(latlng){ if(modalFrom) modalMap.removeLayer(modalFrom); modalFrom = L.marker(latlng,{title:'A',draggable:true}).addTo(modalMap).bindPopup('A ‚Äì –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ').openPopup(); modalFrom.on('dragend', ()=>{ if(modalFrom && modalTo) buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng()); }); }
function setModalTo(latlng){ if(modalTo) modalMap.removeLayer(modalTo); modalTo = L.marker(latlng,{title:'B',draggable:true}).addTo(modalMap).bindPopup('B ‚Äì –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ').openPopup(); modalTo.on('dragend', ()=>{ if(modalFrom && modalTo) buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng()); }); }
function clearRoute(){ if(fromMarker){ map.removeLayer(fromMarker); fromMarker=null; } if(toMarker){ map.removeLayer(toMarker); toMarker=null; } if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } searchMarkers.forEach(m=>map.removeLayer(m)); searchMarkers=[]; }
function clearModalRoute(){ if(modalFrom){ modalMap.removeLayer(modalFrom); modalFrom=null; } if(modalTo){ modalMap.removeLayer(modalTo); modalTo=null; } if(modalRouteLayer){ modalMap.removeLayer(modalRouteLayer); modalRouteLayer=null; } }

async function geocode(query){
  try{
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${OPENROUTESERVICE_API_KEY}&text=${encodeURIComponent(query)}&size=5`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('geocode fail '+r.status);
    const data = await r.json();
    return (data.features||[]).map(f=>({label:f.properties.label, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0], props:f.properties}));
  }catch(e){ console.warn(e); return []; }
}

async function buildRoute(fromLatLng, toLatLng){
  try{
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?start=${fromLatLng.lng},${fromLatLng.lat}&end=${toLatLng.lng},${toLatLng.lat}&api_key=${OPENROUTESERVICE_API_KEY}`;
    let resp = await fetch(url);
    if(!resp.ok){
      resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{method:'POST',headers:{'Content-Type':'application/json','Authorization':OPENROUTESERVICE_API_KEY},body:JSON.stringify({coordinates:[[fromLatLng.lng,fromLatLng.lat],[toLatLng.lng,toLatLng.lat]]})});
      if(!resp.ok) throw new Error('routing fail ' + resp.status);
      const g = await resp.json(); renderRouteGeoJSON(g); return g;
    }
    const g = await resp.json(); renderRouteGeoJSON(g); return g;
  }catch(e){ console.warn(e); alert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + (e.message||e)); }
}
function renderRouteGeoJSON(g){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.geoJSON(g,{style:{color:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ffd54a',weight:5,opacity:0.9}}).addTo(map);
  if(routeLayer && routeLayer.getBounds) map.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
}
async function buildModalRoute(fromLatLng, toLatLng){
  try{
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?start=${fromLatLng.lng},${fromLatLng.lat}&end=${toLatLng.lng},${toLatLng.lat}&api_key=${OPENROUTESERVICE_API_KEY}`;
    let resp = await fetch(url);
    if(!resp.ok){
      resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{method:'POST',headers:{'Content-Type':'application/json','Authorization':OPENROUTESERVICE_API_KEY},body:JSON.stringify({coordinates:[[fromLatLng.lng,fromLatLng.lat],[toLatLng.lng,toLatLng.lat]]})});
      if(!resp.ok) throw new Error('routing fail ' + resp.status);
      const g = await resp.json(); renderModalRouteGeoJSON(g); return g;
    }
    const g = await resp.json(); renderModalRouteGeoJSON(g); return g;
  }catch(e){ console.warn(e); alert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + (e.message||e)); }
}
function renderModalRouteGeoJSON(g){
  if(modalRouteLayer) modalMap.removeLayer(modalRouteLayer);
  modalRouteLayer = L.geoJSON(g,{style:{color:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ffd54a',weight:5,opacity:0.9}}).addTo(modalMap);
  if(modalRouteLayer && modalRouteLayer.getBounds) modalMap.fitBounds(modalRouteLayer.getBounds(),{padding:[20,20]});
}

async function doMapSearch(q){
  if(!q) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å');
  const res = await geocode(q);
  if(!res.length){ alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  // –µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –¥–ª—è –º–æ–¥–∞–ª–∫–∏, —Ä–∞–±–æ—Ç–∞–µ–º —Å modalMap
  if(modalMap){
    searchMarkers.forEach(m=>modalMap.removeLayer(m)); searchMarkers=[];
    res.forEach(r=>{
      const mk = L.marker([r.lat,r.lon]).addTo(modalMap).bindPopup(`<strong>${r.label}</strong><div style="margin-top:6px"><button onclick="window.__setModalFrom(${r.lat},${r.lon})">A</button> <button onclick="window.__setModalTo(${r.lat},${r.lon})">B</button></div>`);
      searchMarkers.push(mk);
    });
    modalMap.fitBounds(L.featureGroup(searchMarkers).getBounds(),{padding:[20,20]});
  } else {
    alert('–ü–æ–∏—Å–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ä—Ç–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —ç—Ç–æ–π —Å–±–æ—Ä–∫–µ.');
  }
  return res;
}
window.__setFrom = (lat,lon)=>{ setFromPoint(L.latLng(lat,lon)); };
window.__setTo = (lat,lon)=>{ setToPoint(L.latLng(lat,lon)); };
window.__setModalFrom = (lat,lon)=>{ setModalFrom(L.latLng(lat,lon)); };
window.__setModalTo = (lat,lon)=>{ setModalTo(L.latLng(lat,lon)); };

/* -------------------
   Menu & Rendering (—É–¥–∞–ª–∏–ª –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è gid_order, –æ—Å—Ç–∞–≤–∏–ª "–ó–∞–∫–∞–∑–∞—Ç—å" –ø–µ—Ä–≤—ã–º)
   ------------------- */
function renderMenu(){
  const menuList = el('menuList'); menuList.innerHTML='';
  const active = el('tabServices').classList.contains('service-active') ? 'services' : 'work';
  const items = active==='services' ? [
    // 'GiD –ó–∞–∫–∞–∑' —É–¥–∞–ª—ë–Ω –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ—Ä–º—É "–ó–∞–∫–∞–∑–∞—Ç—å"
    {id:'order', title:'–ó–∞–∫–∞–∑–∞—Ç—å', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
    {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å / –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å'},
    {id:'citychat', title:'GIDChat', caption:'–õ–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ] : [
    {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫'},
    {id:'myOffers', title:'–ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏', caption:'–û—Ç–∫–ª–∏–∫–∏'},
    {id:'reports', title:'–û—Ç—á—ë—Ç—ã', caption:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'},
    {id:'settings', title:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', caption:'–ü—Ä–æ—Ñ–∏–ª—å –∏ —Ç–µ–º—ã'}
  ];
  items.forEach(it=>{
    const elDiv = document.createElement('div'); elDiv.className='menu-item'; elDiv.dataset.id=it.id;
    // special styling for GIDChat
    if(it.id==='citychat'){ elDiv.classList.add('gidchat'); elDiv.innerHTML = `<div class="left"><div class="title gidchat">GIDChat</div><div class="caption">–ë–æ–ª—å—à–∞—è –ª–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞</div></div><div class="gidchat-holo">OPEN</div>`; }
    else elDiv.innerHTML = `<div class="left"><div class="title">${it.title}</div><div class="caption">${it.caption}</div></div><div style="opacity:0.9">‚Ä∫</div>`;
    elDiv.addEventListener('click', ()=>onMenuClick(it.id));
    menuList.appendChild(elDiv);
  });
}

/* -------------------
   Modals & Special UI
   ------------------- */
function openModal(html, actionsHtml, opts={}){
  const mb = el('modalBackdrop'), mw = el('modalWindow');
  el('modalContent').innerHTML = html;
  el('modalActions').innerHTML = actionsHtml || '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>';
  if(opts.fullscreen){
    mw.classList.add('fullscreen');
  } else {
    mw.classList.remove('fullscreen');
  }
  // optional style tweaks
  if(opts.maxWidth) mw.style.maxWidth = opts.maxWidth;
  else mw.style.maxWidth = '';
  mb.style.display='flex'; mb.setAttribute('aria-hidden','false');
  // close handlers
  mb.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));
  mb.addEventListener('click', (e)=>{ if(e.target===mb) closeModal(); });
}
function closeModal(){ const mb = el('modalBackdrop'), mw = el('modalWindow'); mb.style.display='none'; mb.setAttribute('aria-hidden','true'); el('modalContent').innerHTML=''; el('modalActions').innerHTML=''; mw.classList.remove('fullscreen'); mw.style.maxWidth=''; }

/* GiD –ó–∞–∫–∞–∑ integrated into Order modal (–±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é) */
function openOrderModal(preselectCategory){
  const categories = ['–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º','–ú–∞—Å—Ç–µ—Ä','GiD –ó–∞–∫–∞–∑'];
  let html = `<div class="h"><strong>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</strong></div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="ordCat">${categories.map(c=>`<option>${c}</option>`).join('')}</select><div id="ordDynamic"></div><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input id="ordBudget" type="number" value="0">`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="ordCreate">–°–æ–∑–¥–∞—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ 
    if(preselectCategory){
      const sel = document.getElementById('ordCat');
      sel.value = preselectCategory;
    }
    populateDynamicFields(); 
    document.getElementById('ordCat').addEventListener('change', populateDynamicFields);
    document.getElementById('ordCreate').addEventListener('click', ()=>{
      const cat=document.getElementById('ordCat').value; const budget=document.getElementById('ordBudget').value; const dyn=captureDynamicFields();
      if(!dyn) return;
      // —Å–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É ‚Äî –µ—Å–ª–∏ —ç—Ç–æ GiD –ó–∞–∫–∞–∑, –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è –≤ –æ–±—â–∏–π servicesPosts –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—è–≤–∫–∞
      const newOrder = {id:Date.now(),cat,budget,dyn,created:new Date().toISOString(),author:state.user ? {avatar:state.user.avatar||null,name:state.user.name||'',surname:state.user.surname||''} : null};
      state.servicesPosts.unshift(newOrder); localSave(); addNotification('–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞: '+cat);
      // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–¥—Ä–µ—Å–∞ (–¥–µ–º–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –∞–≤—Ç–æ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞)
      if((dyn.from && dyn.to) || (dyn.addr && dyn.desc && cat==='GiD –ó–∞–∫–∞–∑')){
        openExecutionModal(newOrder);
      }
      closeModal();
    });
  },50);
}
function populateDynamicFields(){
  const cat=document.getElementById('ordCat').value; const cont=el('ordDynamic'); cont.innerHTML='';
  if(cat==='–¢–∞–∫—Å–∏'){ cont.innerHTML=`<label>–û—Ç–∫—É–¥–∞</label><input id="taxFrom"><label>–ö—É–¥–∞</label><input id="taxTo"><label>–ü–∞—Å—Å–∞–∂–∏—Ä—ã</label><input id="taxPax" type="number" value="1">`; }
  else if(cat==='–ö—É—Ä—å–µ—Ä'){ cont.innerHTML=`<label>–û—Ç–∫—É–¥–∞</label><input id="curFrom"><label>–ö—É–¥–∞</label><input id="curTo"><label>–í–µ—Å/–≥–∞–±–∞—Ä–∏—Ç—ã</label><input id="curSize">`; }
  else if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º'){ cont.innerHTML=`<label>–ê–¥—Ä–µ—Å</label><input id="homeAddr"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="homeDesc"></textarea><label>–§–æ—Ç–æ</label><input id="homeFile" type="file" accept="image/*">`; document.getElementById('homeFile')?.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; cont.dataset.file=await fileToBase64(f); }); }
  else if(cat==='–ú–∞—Å—Ç–µ—Ä'){ cont.innerHTML=`<label>–ê–¥—Ä–µ—Å</label><input id="mAddr"><label>–í–∏–¥ —Ä–∞–±–æ—Ç</label><input id="mType"><label>–í—Ä–µ–º—è</label><input id="mTime" type="time">`; }
  else { /* GiD –ó–∞–∫–∞–∑ - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ —É—Å–ª—É–≥ */ cont.innerHTML=`<label>–¢–∏–ø —É—Å–ª—É–≥–∏</label><select id="gidType"><option>–õ—é–±–∞—è</option><option>–ü–æ–∫—É–ø–∫–∞</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ü–æ–º–æ—â—å</option><option>–ú–∞—Å—Ç–µ—Ä</option></select><label>–ö—Ä–∏—Ç–µ—Ä–∏–∏ / –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</label><input id="gidCriteria" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ä–æ—á–Ω–æ, –±—é–¥–∂–µ—Ç –¥–æ 5000..."><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="gDesc"></textarea><label>–ê–¥—Ä–µ—Å</label><input id="gAddr">`; }
}
function captureDynamicFields(){
  const cat=document.getElementById('ordCat').value;
  if(cat==='–¢–∞–∫—Å–∏'){ const f=document.getElementById('taxFrom').value.trim(), t=document.getElementById('taxTo').value.trim(); if(!f||!t){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å–∞');return null;} return {from:f,to:t,pax:document.getElementById('taxPax').value}; }
  if(cat==='–ö—É—Ä—å–µ—Ä'){ const f=document.getElementById('curFrom').value.trim(), t=document.getElementById('curTo').value.trim(); if(!f||!t){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å–∞');return null;} return {from:f,to:t,size:document.getElementById('curSize').value}; }
  if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º'){ const a=document.getElementById('homeAddr').value.trim(), d=document.getElementById('homeDesc').value.trim(); if(!a||!d){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –æ–ø–∏—Å–∞–Ω–∏–µ');return null;} return {addr:a,desc:d,file:el('ordDynamic').dataset.file||null}; }
  if(cat==='–ú–∞—Å—Ç–µ—Ä'){ const a=document.getElementById('mAddr').value.trim(), ty=document.getElementById('mType').value.trim(); if(!a||!ty){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –≤–∏–¥ —Ä–∞–±–æ—Ç');return null;} return {addr:a,type:ty,time:document.getElementById('mTime').value}; }
  const d=document.getElementById('gDesc') ? document.getElementById('gDesc').value.trim() : ''; const a=document.getElementById('gAddr') ? document.getElementById('gAddr').value.trim() : '';
  if(cat==='GiD –ó–∞–∫–∞–∑'){ const type=document.getElementById('gidType').value, crit=document.getElementById('gidCriteria').value.trim(); if(!d||!a){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');return null;} return {type,criteria:crit,desc:d,addr:a}; }
  if(!d||!a){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');return null;} return {desc:d,addr:a};
}

/* Ads (–ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è–µ–º author: avatar + –∏–º—è —Ñ–∞–º–∏–ª–∏—è) */
function openAdsModal(){
  const html=`<div class="h"><strong>–û–±—ä—è–≤–ª–µ–Ω–∏–µ</strong></div><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="adTitle"><label>–¢–µ–∫—Å—Ç</label><textarea id="adText"></textarea>`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="publishAd">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ document.getElementById('publishAd').addEventListener('click', ()=>{ const t=el('adTitle').value.trim(), txt=el('adText').value.trim(); if(!t||!txt) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ'); const author = state.user ? {avatar: state.user.avatar||null, name: state.user.name||'', surname: state.user.surname||''} : null; state.cityPosts.unshift({id:Date.now(),title:t,text:txt,created:new Date().toISOString(),author}); localSave(); addNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'); closeModal(); }); },50);
}

/* City chat / GIDChat fullscreen (–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: fullscreen + –ø–æ—Å—Ç—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏) */
function openGIDChatFull(){
  // build posts with actions (likes/comments/repost)
  const postsHtml = (state.cityPosts||[]).map(p=>{
    // –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∞ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å –∞–≤–∞—Ç–∞—Ä–æ–º –∏ "–ê–Ω–æ–Ω–∏–º"
    const authorAvatar = p.author && p.author.avatar ? p.author.avatar : 'https://via.placeholder.com/36/333333/fff?text=U';
    const authorName = p.author && (p.author.name||p.author.surname) ? `${p.author.name||''} ${p.author.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    const author = `<div style="display:flex;align-items:center;gap:8px"><div style="width:36px;height:36px;border-radius:50%;overflow:hidden"><img src="${authorAvatar}" style="width:100%;height:100%;object-fit:cover"></div><div><div style="font-weight:800">${authorName}</div><div style="color:var(--muted);font-size:12px">${new Date(p.created).toLocaleString()}</div></div></div>`;
    const likesCount = p.likes ? p.likes.length : 0;
    const commentsCount = p.comments ? p.comments.length : 0;
    return `<div class="post" data-id="${p.id}" style="padding:12px;border-bottom:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);margin-bottom:8px;border-radius:8px">
      ${author}
      <div style="font-weight:700;margin-top:8px">${p.title || ''}</div>
      <div style="margin-top:8px">${p.text || p.text || ''}${p.dyn && p.dyn.desc ? '<div style="margin-top:6px;color:var(--muted)">'+(p.dyn.desc||'')+'</div>':''}</div>
      <div class="post-actions" style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <button class="btn btn-like" data-action="like">‚ù§ <span class="like-count">${likesCount}</span></button>
        <button class="btn btn-comment" data-action="comment">üí¨ <span class="comment-count">${commentsCount}</span></button>
        <button class="btn btn-repost" data-action="repost">‚§¥ –†–µ–ø–æ—Å—Ç</button>
      </div>
      <div class="post-interact" style="margin-top:8px;display:none"></div>
    </div>`}).join('')||'<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';

  const html = `<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px"><div style="font-weight:900;font-size:20px">GIDChat ‚Äî ${state.city}</div><div style="display:flex;gap:8px"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="newPostBtn">+ –ü–æ—Å—Ç</button></div></div><div style="flex:1;overflow:auto;display:flex;flex-direction:column" id="gidFeed">${postsHtml}</div>`;
  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
  openModal(html, '', {fullscreen:true});
  setTimeout(()=>{
    el('newPostBtn')?.addEventListener('click', ()=>{ openAdsModal(); });
    // delegate actions for posts: like/comment/repost
    const feed = el('gidFeed');
    feed.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const postDiv = btn.closest('.post');
      const id = Number(postDiv.dataset.id);
      const post = state.cityPosts.find(x => x.id === id);
      if(!post) return;
      const action = btn.getAttribute('data-action');
      if(action === 'like'){
        post.likes = post.likes || [];
        // toggle like by demo user (store phone as id if exists)
        const me = state.user ? (state.user.phone || 'me') : 'guest';
        const idx = post.likes.indexOf(me);
        if(idx === -1) post.likes.push(me); else post.likes.splice(idx,1);
        localSave(); renderGIDChatActions(postDiv, post);
      } else if(action === 'comment'){
        // show comments area
        openCommentsArea(postDiv, post);
      } else if(action === 'repost'){
        openRepostModal(post);
      }
    });
    // render initial counts
    Array.from(document.querySelectorAll('.post')).forEach(pd=>{
      const id = Number(pd.dataset.id);
      const p = state.cityPosts.find(x=>x.id===id);
      if(p) renderGIDChatActions(pd,p);
    });
  },60);
}

function renderGIDChatActions(postDiv, post){
  postDiv.querySelector('.like-count').textContent = (post.likes||[]).length;
  postDiv.querySelector('.comment-count').textContent = (post.comments||[]).length;
  // ensure post-interact hidden
  const interact = postDiv.querySelector('.post-interact');
  interact.style.display='none';
}

function openCommentsArea(postDiv, post){
  const container = postDiv.querySelector('.post-interact');
  container.style.display='block';
  // build comment list
  const listHtml = (post.comments||[]).map((c, idx)=>`<div style="padding:6px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.01)"><div style="font-weight:800">${c.authorName||'–ê–Ω–æ–Ω–∏–º'}</div><div style="color:var(--muted);font-size:12px">${new Date(c.ts).toLocaleString()}</div><div style="margin-top:6px">${c.text}</div><div style="margin-top:6px"><button class="btn reply-btn" data-idx="${idx}">–û—Ç–≤–µ—Ç–∏—Ç—å</button></div></div>`).join('')||'<div class="small">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
  container.innerHTML = `<div style="max-height:180px;overflow:auto;border:1px solid var(--glass-border);padding:8px;border-radius:8px">${listHtml}</div><div style="display:flex;gap:8px;margin-top:8px"><input placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="flex:1" class="comment-input"><button class="btn primary post-comment-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>`;
  // events
  container.querySelector('.post-comment-btn').onclick = ()=>{
    const txt = container.querySelector('.comment-input').value.trim();
    if(!txt) return alert('–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
    post.comments = post.comments || [];
    const authorName = state.user ? (state.user.name + ' ' + (state.user.surname||'')) : '–ì–æ—Å—Ç—å';
    post.comments.push({text:txt,authorName,ts:new Date().toISOString(),replies:[]});
    localSave();
    // rerender comments area
    openCommentsArea(postDiv, post);
    // update counts
    postDiv.querySelector('.comment-count').textContent = (post.comments||[]).length;
  };
  // reply buttons
  container.querySelectorAll('.reply-btn').forEach(b=>{
    b.onclick = ()=>{
      const idx = Number(b.dataset.idx);
      const replyText = prompt('–í–∞—à –æ—Ç–≤–µ—Ç:');
      if(!replyText) return;
      post.comments[idx].replies = post.comments[idx].replies || [];
      const authorName = state.user ? (state.user.name + ' ' + (state.user.surname||'')) : '–ì–æ—Å—Ç—å';
      post.comments[idx].replies.push({text:replyText,authorName,ts:new Date().toISOString()});
      localSave();
      openCommentsArea(postDiv, post);
    };
  });
}

function openLikesListModal(post){
  const likes = post.likes || [];
  const html = `<div class="h"><strong>–õ–∞–π–∫–∏ (${likes.length})</strong></div><div style="max-height:300px;overflow:auto">${likes.map(l=>(`<div style="padding:8px;border-bottom:1px solid var(--glass-border)">${l}</div>`)).join('')}</div>`;
  openModal(html,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>');
}

function openRepostModal(post){
  const html = `<div class="h"><strong>–†–µ–ø–æ—Å—Ç</strong></div><label>–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</label><input id="repostContact" placeholder="–ò–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"><label>–°–æ–æ–±—â–µ–Ω–∏–µ</label><textarea id="repostMsg">–†–µ–ø–æ—Å—Ç: ${post.title||'–ü–æ—Å—Ç'}</textarea>`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="sendRepost">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ el('sendRepost').addEventListener('click', ()=>{
    const to = el('repostContact').value.trim(); if(!to) return alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); closeModal(); alert('–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ' + to);
  }); },50);
}

/* Messenger & Wallet (preserved) */
function openMessenger(){ openModal('<div class="h"><strong>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</strong></div><div class="small">–°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ (–¥–µ–º–æ)</div>','<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>'); }
function openWallet(){ const html=`<div class="h"><strong>–ö–æ—à–µ–ª—ë–∫</strong></div><div style="font-size:24px;font-weight:900">${state.wallet.balance||0} ‚Ç∏</div>`; openModal(html,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>'); }

/* Settings with theme selection (added futures) */
function openSettingsModal(forceOpen){
  const cities = ['–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','–ù—É—Ä-–°—É–ª—Ç–∞–Ω','–ê–ª–º–∞—Ç—ã'];
  const themes = Object.keys(THEMES);
  const html = `<div class="h" style="display:flex;justify-content:space-between;align-items:center"><strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong><div style="font-size:12px;color:var(--muted)">–¢–µ–º–∞: <strong>${state.theme}</strong></div></div>
    <label>–ê–≤–∞—Ç–∞—Ä</label><button class="btn" id="uploadAvatar">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button><img id="avatarPreviewSmall" src="" style="width:44px;height:44px;border-radius:8px;margin-left:8px;vertical-align:middle">
    <label>–ò–º—è</label><input id="profileName"><label>–§–∞–º–∏–ª–∏—è</label><input id="profileSurname"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="profilePhone"><label>–ì–æ—Ä–æ–¥</label><select id="citySelect">${cities.map(c=>`<option>${c}</option>`).join('')}</select>
    <label>–¢–µ–º–∞</label><select id="themeSelect">${themes.map(t=>`<option>${t}</option>`).join('')}</select>
    <div style="margin-top:8px"><span class="theme-swatch" id="sw1" style="background:linear-gradient(90deg,#5b2cff,#2b0b3a)"></span><span class="theme-swatch" id="sw2" style="background:linear-gradient(90deg,#3b2b14,#0b0703)"></span><span class="theme-swatch" id="sw3" style="background:linear-gradient(90deg,#06103a,#0b0033)"></span><span class="theme-swatch" id="sw4" style="background:linear-gradient(90deg,#001219,#060014)"></span><span class="theme-swatch" id="sw5" style="background:linear-gradient(90deg,#ff7a59,#2b0b3a)"></span><span class="theme-swatch" id="sw6" style="background:linear-gradient(90deg,#0b5d3a,#02120a)"></span> ‚Äî –ø—Ä–∏–º–µ—Ä—ã —Ç–µ–º</div>
  `;
  const actions = '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{
    document.getElementById('profileName').value = state.user ? (state.user.name||'') : '';
    document.getElementById('profileSurname').value = state.user ? (state.user.surname||'') : '';
    document.getElementById('profilePhone').value = state.user ? (state.user.phone||'') : '';
    document.getElementById('avatarPreviewSmall').src = state.user && state.user.avatar ? state.user.avatar : 'https://via.placeholder.com/44/333333/fff?text=U';
    document.getElementById('uploadAvatar').addEventListener('click', ()=>{ const f=document.createElement('input'); f.type='file'; f.accept='image/*'; f.onchange=async e=>{ const file=e.target.files[0]; if(!file) return; const b=await fileToBase64(file); document.getElementById('avatarPreviewSmall').src=b; document.getElementById('avatarPreviewSmall').dataset.b64=b; }; f.click(); });
    document.getElementById('saveSettings').addEventListener('click', ()=>{
      const name=el('profileName').value.trim(), surname=el('profileSurname').value.trim();
      if(!name||!surname){ alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'); return; }
      state.user = state.user||{};
      state.user.name = name; state.user.surname = surname; state.user.phone = el('profilePhone').value.trim();
      const b64 = document.getElementById('avatarPreviewSmall').dataset ? document.getElementById('avatarPreviewSmall').dataset.b64 : null;
      if(b64) state.user.avatar = b64;
      state.city = el('citySelect').value;
      const chosenTheme = el('themeSelect').value || state.theme;
      applyTheme(chosenTheme); localSave(); closeModal(); renderAll();
    });
  },50);
}

/* Auth */
function openAuthModal(){
  const html=`<div class="h"><strong>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</strong></div><label>–ò–º—è</label><input id="authName"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="authPhone"><label>PIN (4 —Ü–∏—Ñ—Ä—ã)</label><input id="authPIN" maxlength="4">`;
  const actions = '<button class="btn" data-close>–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button><button class="btn primary" id="authSubmit">–í–æ–π—Ç–∏</button>';
  openModal(html, actions);
  setTimeout(()=>{ document.getElementById('authSubmit').addEventListener('click', ()=>{ const name=el('authName').value.trim(); const phone=el('authPhone').value.trim(); const pin=el('authPIN').value.trim(); if(!name||!phone||!/^\d{4}$/.test(pin)){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'); return; } state.user = state.user||{}; state.user.name=name; state.user.phone=phone; state.user.pin=pin; localSave(); addNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª: '+name); closeModal(); renderAll(); }); },50);
}

/* Notifications & helper */
function addNotification(text, meta={}){
  state.notifications.unshift({id:Date.now(), text, meta, ts:new Date().toISOString()}); localSave(); updateNotifCount();
}
function updateNotifCount(){ 
  const cnt = state.notifications.length || 0;
  // –æ–±—â–∏–π —Å—á—ë—Ç—á–∏–∫ —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–≥–æ–¥—ã
  if(el('weatherNotifCount')) el('weatherNotifCount').textContent = cnt;
  // –∏ —Å—Ç–∞—Ä—ã–π –≤–µ—Ä—Ö–Ω–∏–π (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –µ—Å—Ç—å) ‚Äî –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ–±–Ω–æ–≤–ª—è–µ–º
  if(el('notifCount')) el('notifCount').textContent = cnt;
}

/* City posts feed modal (–º–∞–ª–µ–Ω—å–∫–∞—è) ‚Äî —Ç–µ–ø–µ—Ä—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ª–∞–π–∫/–∫–æ–º–º–µ–Ω—Ç/—Ä–µ–ø–æ—Å—Ç */
function openCityChatModal(){
  const postsHtml = (state.cityPosts||[]).map(p=>{
    const authorAvatar = p.author && p.author.avatar ? p.author.avatar : 'https://via.placeholder.com/28/333333/fff?text=U';
    const authorName = p.author && (p.author.name||p.author.surname) ? `${p.author.name||''} ${p.author.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    const author = `<div style="display:flex;align-items:center;gap:8px"><div style="width:28px;height:28px;border-radius:50%;overflow:hidden"><img src="${authorAvatar}" style="width:100%;height:100%;object-fit:cover"></div><div><div style="font-weight:800;font-size:13px">${authorName}</div><div style="color:var(--muted);font-size:11px">${new Date(p.created).toLocaleString()}</div></div></div>`;
    const likesCount = p.likes ? p.likes.length : 0;
    const commentsCount = p.comments ? p.comments.length : 0;
    return `<div class="post-sm" data-id="${p.id}" style="padding:8px;border-bottom:1px solid var(--glass-border)"><div>${author}</div><div style="font-weight:700;margin-top:6px">${p.title||''}</div><div style="margin-top:6px">${p.text||''}</div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-like" data-action="like">‚ù§ <span class="like-count">${likesCount}</span></button><button class="btn btn-comment" data-action="comment">üí¨ <span class="comment-count">${commentsCount}</span></button><button class="btn btn-repost" data-action="repost">‚§¥</button></div><div class="post-interact" style="margin-top:8px;display:none"></div></div>`;
  }).join('')||'<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
  openModal(`<div class="h"><strong>City —á–∞—Ç ‚Äî ${state.city}</strong></div><div style="max-height:320px;overflow:auto">${postsHtml}</div>`,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>');
  setTimeout(()=>{
    const content = el('modalContent');
    content.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const postDiv = btn.closest('[data-id]');
      const id = Number(postDiv.dataset.id);
      const post = state.cityPosts.find(x=>x.id===id);
      if(!post) return;
      const action = btn.getAttribute('data-action');
      if(action==='like'){ post.likes = post.likes || []; const me = state.user ? (state.user.phone || 'me') : 'guest'; const idx = post.likes.indexOf(me); if(idx===-1) post.likes.push(me); else post.likes.splice(idx,1); localSave(); postDiv.querySelector('.like-count').textContent = (post.likes||[]).length; }
      if(action==='comment'){ openCommentsArea(postDiv, post); postDiv.querySelector('.comment-count').textContent = (post.comments||[]).length; }
      if(action==='repost'){ openRepostModal(post); }
    });
  },50);
}

/* helpers */
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* -------------------
   Menu click router
   ------------------- */
function onMenuClick(id){
  if(id==='order') openOrderModal();
  else if(id==='ads') openAdsModal();
  else if(id==='citychat') openGIDChatFull();
  else if(id==='messenger') openMessenger();
  else if(id==='wallet') openWallet();
  else if(id==='findJobs'){ /* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ */ openModal('<div class="h"><strong>–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã ‚Äî –¥–µ–º–æ</strong></div><div class="small">–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞—è–≤–æ–∫ (–¥–µ–º–æ)</div>','<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="execDemo">–í–∑—è—Ç—å –∑–∞–∫–∞–∑ –∏ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>'); setTimeout(()=>{ el('execDemo')?.addEventListener('click', ()=>{ // —Å–æ–∑–¥–∞–¥–∏–º demo order —Å A/B
    const demo = {id:Date.now(),cat:'–ö—É—Ä—å–µ—Ä',dyn:{from:'–û—Ç–∫—É–¥–∞ –ø—Ä–∏–º–µ—Ä',to:'–ö—É–¥–∞ –ø—Ä–∏–º–µ—Ä',fromCoords:{lat:49.8062,lon:73.0851},toCoords:{lat:49.815,lon:73.09}},created:new Date().toISOString(),author:state.user||null};
    state.servicesPosts.unshift(demo); localSave(); closeModal(); openExecutionModal(demo);
  }); },60); }
  else if(id==='myOffers') alert('–ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏ ‚Äî –¥–µ–º–æ');
  else if(id==='reports') alert('–û—Ç—á—ë—Ç—ã ‚Äî –¥–µ–º–æ');
  else if(id==='settings') openSettingsModal();
  else alert('–ù–∞–∂–∞—Ç–∞: '+id);
}

/* -------------------
   Execution modal (–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç –º–∞—Ä—à—Ä—É—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
   ------------------- */
function openExecutionModal(order){
  // order.dyn –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å fromCoords/toCoords (demo) or from/to strings
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</strong><div style="color:var(--muted);font-size:12px">${order.cat} ‚Ä¢ ${new Date(order.created).toLocaleString()}</div></div><div><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div></div>
    <div style="margin-top:8px">${order.dyn && order.dyn.desc ? `<div style="margin-bottom:8px">${order.dyn.desc}</div>` : ''}</div>
    <div style="margin-top:8px"><label>–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞</label><input id="modalMapSearch" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞"><div style="display:flex;gap:8px;margin-top:6px"><button class="btn" id="modalSetFrom">A</button><button class="btn" id="modalSetTo">B</button><button class="btn primary" id="modalRouteBtn">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button></div></div>
    <div id="modalMap" style="height:360px;border-radius:8px;margin-top:10px"></div>`;
  openModal(html, '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>', {fullscreen:false, maxWidth:'900px'});
  setTimeout(()=>{
    initModalMapIfNeeded(); modalMap.invalidateSize();
    // if order has coords, set and build route automatically
    if(order.dyn && order.dyn.fromCoords && order.dyn.toCoords){
      setModalFrom(L.latLng(order.dyn.fromCoords.lat, order.dyn.fromCoords.lon));
      setModalTo(L.latLng(order.dyn.toCoords.lat, order.dyn.toCoords.lon));
      buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng());
    }
    // wire controls
    el('modalSetFrom').addEventListener('click', ()=>{ modalMap._setMode='from'; alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (A)'); });
    el('modalSetTo').addEventListener('click', ()=>{ modalMap._setMode='to'; alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (B)'); });
    el('modalRouteBtn').addEventListener('click', ()=>{ if(!modalFrom||!modalTo) return alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫–∏ A –∏ B'); buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng()); });
    el('modalMapSearch').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doMapSearch(el('modalMapSearch').value.trim()); }});
  },200);
}

/* -------------------
   Render & misc
   ------------------- */
function renderAll(){
  el('cityName').textContent = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞';
  updateNotifCount();
  renderMenu();
  applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π');
  fetchWeather();
  // avatar preview (–∫—Ä—É–≥–ª—ã–π)
  if(state.user && state.user.avatar) el('avatarPreview').innerHTML = `<img src="${state.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
  setSyncStatus('–û–Ω–ª–∞–π–Ω');
  // ensure map visible (panel)
  setTimeout(()=>{ try{ initMapIfNeeded(); if(map) map.invalidateSize(); }catch(e){} },300);
}

/* -------------------
   Weather
   ------------------- */
async function fetchWeather(){
  try{
    const coords = {lat:49.8062,lon:73.0851};
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fail');
    const d = await r.json();
    if(d && d.current_weather) el('weatherBlock').textContent = `${Math.round(d.current_weather.temperature)} ¬∞C`;
  }catch(e){ el('weatherBlock').textContent='‚Äî ¬∞C'; }
}

/* -------------------
   Tabs visual update + events
   ------------------- */
function updateTabsVisual(){
  const s = el('tabServices'), w = el('tabWork');
  s.className = 'tab'; w.className = 'tab';
  if(s.dataset.active === '1') { s.classList.add('service-active'); }
  if(w.dataset.active === '1') { w.classList.add('work-active'); }
}
document.addEventListener('DOMContentLoaded', async ()=>{
  loadState();
  // default: services active
  el('tabServices').dataset.active = '1';
  renderAll();

  // JSONBin load
  if(USE_JSONBIN){
    try{
      const data = await loadFromJSONBin();
      if(data && data.record && data.record.state){ state = data.record.state; if(data.updatedAt) state.__updatedAt = data.updatedAt; localSave(); }
    }catch(e){ console.warn(e); }
  }
  startPeriodicPull();

  // UI bindings
  el('tabServices').addEventListener('click', ()=>{ el('tabServices').dataset.active='1'; el('tabWork').dataset.active='0'; updateTabsVisual(); renderMenu(); });
  el('tabWork').addEventListener('click', ()=>{ el('tabWork').dataset.active='1'; el('tabServices').dataset.active='0'; updateTabsVisual(); renderMenu(); });
  el('settingsBtn').addEventListener('click', ()=>openSettingsModal());
  el('calendarBtn').addEventListener('click', ()=>openCalendar());
  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —Ä—è–¥–æ–º —Å –ø–æ–≥–æ–¥–æ–π
  el('weatherNotifBtn').addEventListener('click', ()=>{ openNotifications(); });
  el('onlineBtn').addEventListener('click', ()=>{ openNotifications(); }); // –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ

  // open map modal button
  el('openMapModalBtn').addEventListener('click', ()=>{ 
    // –æ—Ç–∫—Ä–æ–µ–º –º–æ–¥–∞–ª–∫—É —Å –∫–∞—Ä—Ç–æ–π
    openModal('<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>–ö–∞—Ä—Ç–∞ ‚Äî –º–∞—Ä—à—Ä—É—Ç—ã</strong></div><div><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div></div><div style="margin-top:8px"><label>–ü–æ–∏—Å–∫</label><input id="modalMapSearchTop" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞"><div style="display:flex;gap:8px;margin-top:6px"><button class="btn" id="modalFindFrom">A</button><button class="btn" id="modalFindTo">B</button><button class="btn primary" id="modalRouteTopBtn">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button></div></div><div id="modalMap" style="height:420px;border-radius:8px;margin-top:10px"></div>', '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>', {fullscreen:false, maxWidth:'900px'});
    setTimeout(()=>{ initModalMapIfNeeded(); modalMap.invalidateSize(); el('modalMapSearchTop').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doMapSearch(el('modalMapSearchTop').value.trim()); }}); el('modalFindFrom').addEventListener('click', ()=>{ modalMap._setMode='from'; alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (A)'); }); el('modalFindTo').addEventListener('click', ()=>{ modalMap._setMode='to'; alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (B)'); }); el('modalRouteTopBtn').addEventListener('click', ()=>{ if(!modalFrom||!modalTo) return alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫–∏ A –∏ B'); buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng()); }); },200);
  });

  // map toggle on small preview (keeps old collapse behavior available but minimal)
  const mapToggle = el('mapToggle');
  mapToggle.addEventListener('click', ()=>{
    // –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–µ–º –∫–∞—Ä—Ç—É modal –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    el('openMapModalBtn').click();
  });

  // initial menu
  renderMenu();

  // auth if no user
  if(!state.user) setTimeout(()=>openAuthModal(), 600);
});

/* Calendar modal */
function openCalendar(){
  const html = `<div class="h"><strong>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</strong></div><label>–î–∞—Ç–∞</label><input type="date" id="calDate" value="${new Date().toISOString().slice(0,10)}"><label>–í—Ä–µ–º—è</label><input type="time" id="calTime" value="12:00"><label>–ó–∞–º–µ—Ç–∫–∞</label><input id="calNote"><div class="small">–î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ—è–≤–∏—Ç—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö.</div>`;
  // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –∫–Ω–æ–ø–∫—É –Ω–∞ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"
  openModal(html,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="addRem">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>');
  setTimeout(()=>{ el('addRem').addEventListener('click', ()=>{ const d=el('calDate').value, t=el('calTime').value, n=el('calNote').value; if(!d||!t) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'); state.notifications.unshift({id:Date.now(),text:`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${n||'–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}`,ts:new Date(d+'T'+t+':00').toISOString()}); localSave(); updateNotifCount(); closeModal(); }); },50);
}

/* Notifications list */
function openNotifications(){
  const listHtml = (state.notifications||[]).map(n=>`<div style="padding:8px;border-bottom:1px solid var(--glass-border)"><div class="small">${new Date(n.ts).toLocaleString()}</div><div style="margin-top:6px">${n.text}</div></div>`).join('')||'<div class="small">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  openModal(`<div class="h"><strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong></div><div style="max-height:360px;overflow:auto">${listHtml}</div>`,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button>');
  setTimeout(()=>{ el('clearNotifs').addEventListener('click', ()=>{ state.notifications=[]; localSave(); updateNotifCount(); closeModal(); }); },50);
}

/* helpers */
function updateNotifCount(){ 
  const cnt = state.notifications.length || 0;
  if(el('weatherNotifCount')) el('weatherNotifCount').textContent = cnt;
  if(el('notifCount')) el('notifCount').textContent = cnt;
}

</script>
</body>
</html>
