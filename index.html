<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiD City ‚Äî Prototype</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#060614; --bg-2:#0b0e1a; --bg-3:#0f1220;
  --surface:rgba(18,20,34,.88);
  --line:rgba(169,112,255,.12);
  --accent:#a970ff; --accent-2:#32ffd2; --accent-warn:#ffd84d;
  --text:#ffffff; --muted:#9aa6d9;
  --radius:16px; --shadow:0 14px 36px rgba(0,0,0,.5);
  --glass: rgba(255,255,255,.04);
  --ui-font:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:14px var(--ui-font); color:var(--text);
  background:
    radial-gradient(900px at 20% -10%, rgba(30,27,58,.24) 0%, transparent 70%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  padding:18px;
  display:flex; justify-content:center;
}
.wrapper{ width:100%; max-width:980px; display:flex; flex-direction:column; gap:12px; }

/* Header */
.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand{ display:flex; flex-direction:column; gap:6px; }
.brand h1{ margin:0; font-weight:900; font-size:20px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; color:transparent; }
.buildRow{ display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; }
#time{ font-weight:900; }

/* Role tabs */
.role-tabs{ display:flex; gap:10px; margin-top:6px; }
.role-tab{
  flex:1; text-align:center; padding:12px; border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line);
  font-weight:900; cursor:pointer; user-select:none;
}
.role-tab.active{ background:var(--accent-warn); color:#071018; box-shadow:0 8px 26px rgba(255,200,80,.06); }

/* Container & main menu */
.container{ border-radius:20px; padding:0; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden; }
.panel-top{ display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid rgba(255,255,255,.02); }
.panel-top h2{ margin:0; font-size:18px; font-weight:900; display:flex; gap:12px; align-items:center; }
.panel-top .right{ display:flex; gap:10px; align-items:center; color:var(--muted); }

/* menu layout */
.menu-grid{ display:flex; flex-direction:column; gap:12px; padding:18px; }
.menu-row{ display:flex; gap:10px; }
/* two big buttons row */
.menu-big{ display:flex; gap:10px; }
.menu-big .big-btn{ flex:1; padding:14px 18px; border-radius:14px; font-weight:900; cursor:pointer; text-align:center; border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); }
.menu-big .big-btn.active{ background:var(--accent-warn); color:#081018; box-shadow:0 8px 30px rgba(255,200,80,.06); }

/* menu buttons */
.menu-btn{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.12)); cursor:pointer; font-weight:900; }

/* glass main area */
.glass{ background:var(--glass); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,.02); backdrop-filter:blur(6px); }

/* category cards like screenshot */
.cat-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:6px; }
.cat-card{ background:linear-gradient(180deg, rgba(0,0,0,.4), rgba(255,255,255,.02)); border-radius:18px; padding:12px; min-height:120px; display:flex; flex-direction:column; gap:8px; border:1px solid rgba(255,255,255,.03); }
.cat-art{ height:72px; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:linear-gradient(135deg, rgba(0,0,0,.5), rgba(0,0,0,.35)); }
.cat-title{ font-weight:900; display:flex; justify-content:space-between; align-items:center; }

/* city composer (fixed at top of city screen) */
.city-thread-wrap{ position:relative; height:calc(60vh); display:flex; flex-direction:column; }
.city-composer-top{ position:sticky; top:18px; z-index:30; display:flex; gap:10px; align-items:center; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid rgba(255,255,255,.03); cursor:pointer; transition:all .18s; }
.city-composer-top.compact{ padding:6px 10px; transform:translateY(-4px) scale(.995); opacity:.94; }
.city-composer-top .avatar{ width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent),var(--accent-2)); font-weight:900; }
.city-composer-top .placeholder{ flex:1; color:var(--muted); padding:10px 12px; border-radius:10px; background:rgba(255,255,255,.02); }

/* post cards */
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border-radius:12px; padding:12px; margin-bottom:10px; border:1px solid rgba(255,255,255,.03); }
.post-top{ display:flex; gap:10px; align-items:center; }
.post-actions{ display:flex; gap:8px; margin-top:8px; align-items:center; }
.post-actions button{ background:transparent; border:none; color:var(--muted); cursor:pointer; font-weight:800; padding:6px 8px; border-radius:8px; }

/* message/chat */
.chat-layout{ display:flex; gap:12px; align-items:stretch; }
.chats-list{ flex:1; max-height:64vh; overflow:auto; }
.chat-window{ width:420px; border-left:1px solid rgba(255,255,255,.02); padding-left:12px; display:flex; flex-direction:column; gap:8px; }
.chat-top{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); }
.msgs{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:6px; }
.msg{ padding:10px 12px; border-radius:12px; max-width:78%; word-break:break-word; box-shadow:0 8px 20px rgba(0,0,0,.35); }
.msg.me{ align-self:flex-end; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#081018; font-weight:900; }
.msg.other{ align-self:flex-start; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.06)); color:var(--text); border:1px solid var(--line); }

/* common inputs & buttons */
.input, textarea, select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(12,16,36,.75); color:var(--text); outline:none; font-size:14px; }
textarea{ min-height:100px; resize:vertical; }
.btn{ appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:10px; font-weight:800; }
.btn-primary{ background:var(--accent-warn); color:#071018; font-weight:900; }

/* small responsive tweaks */
@media (max-width:900px){
  .chat-window{ display:none; }
  .cat-grid{ grid-template-columns:repeat(2,1fr); }
  .wrapper{ padding:12px; }
}
.footer-note{ text-align:center; font-size:11px; color:var(--muted); margin-top:8px; }
</style>
</head>
<body>
<div class="wrapper" id="app">
  <header class="header">
    <div class="brand">
      <h1>GiDCity</h1>
      <div class="buildRow">
        <div id="time">--:--</div>
        <div id="date" style="color:var(--muted)"></div>
        <div id="weather" style="color:var(--muted)"></div>
      </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="openSettingsBtn" class="btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="roleTabs" class="role-tabs"></div>

  <main class="container" role="main" aria-live="polite">
    <div class="panel-top">
      <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
      <div class="right"><div id="notifLabel" style="font-weight:900; cursor:pointer">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifBadge" style="display:none; margin-left:6px; background:#ff4f6a; padding:2px 6px; border-radius:999px; color:#fff; font-size:12px;">0</span></div></div>
    </div>

    <div class="menu-grid" id="menuGrid">
      <!-- two big buttons -->
      <div class="menu-big">
        <div id="roleBtnUser" class="big-btn">–°–§–ï–†–ê –£–°–õ–£–ì</div>
        <div id="roleBtnWorker" class="big-btn">–ü–û–î–†–ê–ë–û–¢–ö–ê</div>
      </div>

      <!-- main rows -->
      <div id="menuList" style="display:flex; flex-direction:column; gap:10px; padding-top:6px;">
        <!-- inserted by JS -->
      </div>
    </div>
  </main>

  <div class="footer-note">KASSEN Technology Inc</div>
</div>

<!-- =========== MODALS & SCREENS =========== -->
<!-- Settings -->
<section id="settingsModal" class="screen" style="display:none;">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div><button onclick="closeModal('settingsModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:12px; flex-direction:column;">
      <div style="font-weight:900">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (JSONBin)</div>
      <div style="display:flex; gap:8px; align-items:center">
        <label class="small">–ê–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</label>
        <input id="syncToggle" type="checkbox">
        <button id="syncNowBtn" class="btn btn-primary">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
      </div>

      <div style="margin-top:12px; font-weight:900">–¢–µ–º—ã</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn theme-btn" data-theme="violet">Violet</button>
        <button class="btn theme-btn" data-theme="navy">Navy</button>
        <button class="btn theme-btn" data-theme="emerald">Emerald</button>
        <button class="btn theme-btn" data-theme="sunset">Sunset</button>
        <button class="btn theme-btn" data-theme="mint">Mint</button>
        <button class="btn theme-btn" data-theme="peach">Peach</button>
        <button class="btn theme-btn" data-theme="rose">Rose</button>
        <button class="btn theme-btn" data-theme="amber">Amber</button>
      </div>

      <div style="margin-top:12px; font-weight:900">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div style="flex:1">
          <input id="pfName" class="input" placeholder="–ò–º—è">
          <input id="pfPhone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" style="margin-top:8px">
        </div>
        <div style="width:96px; text-align:center">
          <div id="pfAvatar" style="width:72px;height:72px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:26px;">ü§ñ</div>
          <div style="margin-top:8px"><button id="pfSave" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
      </div>

      <div style="margin-top:12px; font-weight:900">–ì–æ—Ä–æ–¥</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="citySelect" class="input" style="max-width:260px"></select>
        <button id="saveCityBtn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</section>

<!-- Create Order -->
<section id="createModal" class="screen" style="display:none;">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="display:flex; gap:8px; align-items:center;">
        <button onclick="closeModal('createModal')" class="btn">‚Üê –ù–∞–∑–∞–¥</button>
        <h3 style="margin:0">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</h3>
      </div>
      <div></div>
    </div>
    <div style="margin-top:12px;">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <button id="chooseCatBtn" class="btn">–í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        <span id="chosenCat" class="small" style="margin-left:8px"></span>
      </div>

      <form id="createForm">
        <textarea id="c-desc" class="input" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É (—á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –∞–¥—Ä–µ—Å, –ø–æ–∂–µ–ª–∞–Ω–∏—è)"></textarea>
        <div id="createExtraFields" style="margin-top:8px;"></div>

        <div style="display:flex; gap:8px; margin-top:8px; align-items:flex-end; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px"><label class="small">–î–µ–¥–ª–∞–π–Ω</label><input id="c-datetime" class="input" type="datetime-local"></div>
          <div style="width:160px"><label class="small">–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input id="c-budget" class="input" type="number" required></div>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
          <button id="submitOrderBtn" class="btn btn-primary" type="button">–ó–ê–ö–ê–ó–ê–¢–¨</button>
          <button class="btn" type="button" onclick="closeModal('createModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Category picker -->
<section id="catPickerModal" class="screen" style="display:none;">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
      <button onclick="closeModal('catPickerModal')" class="btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div style="margin-top:12px; max-height:60vh; overflow:auto;">
      <div id="catPickerList" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px;"></div>
    </div>
  </div>
</section>

<!-- Find / Mine / Ads / Messenger / City thread screens reuse modals below -->
<section id="findModal" class="screen" style="display:none;">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0" id="findTitle">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã</h3>
      <button onclick="closeModal('findModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="margin-top:12px;">
      <div style="display:flex; gap:8px; align-items:center;"><input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫..."><select id="filterCat" class="input" style="max-width:240px"></select><button id="applySearch" class="btn btn-primary">–§–∏–ª—å—Ç—Ä</button></div>
      <div id="findList" style="margin-top:12px; max-height:60vh; overflow:auto;"></div>
    </div>
  </div>
</section>

<section id="offerModal" class="screen" style="display:none;">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É</h3>
      <button onclick="closeModal('offerModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <form id="offerForm" style="margin-top:12px;">
      <div><label class="small">–¶–µ–Ω–∞ (‚Ç∏)</label><input id="offerPrice" class="input" type="number" required></div>
      <div style="margin-top:8px;"><label class="small">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><textarea id="offerComment" class="input"></textarea></div>
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;"><button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><button class="btn" type="button" onclick="closeModal('offerModal')">–û—Ç–º–µ–Ω–∞</button></div>
    </form>
  </div>
</section>

<section id="cityThreadModal" class="screen" style="display:none;">
  <div class="modal" style="width:100%; max-width:980px; height:88vh; overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px;">
      <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
      <button onclick="closeModal('cityThreadModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="height:calc(100% - 48px); display:flex; flex-direction:column;">
      <div id="cityComposerTop" class="city-composer-top"><div class="avatar" id="cityTopAvatar">–Ø</div><div class="placeholder" id="cityTopPlaceholder">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è...</div></div>
      <div id="cityScroll" style="overflow:auto; padding:12px; flex:1;"><div id="cityPosts"></div></div>
    </div>
  </div>
</section>

<section id="quickPostModal" class="screen" style="display:none;">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ª–µ–Ω—Ç–µ</h3>
      <button onclick="closeModal('quickPostModal')" class="btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div style="margin-top:12px;">
      <textarea id="quickPostText" class="input" placeholder="–û —á—ë–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å?"></textarea>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <input id="quickPostImage" type="file" accept="image/*">
        <div id="quickPostPreview"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="quickPostSend" class="btn btn-primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>
</section>

<section id="messengerModal" class="screen" style="display:none;">
  <div class="modal" style="width:100%; max-width:980px; height:88vh; overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px;">
      <h3 style="margin:0">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3>
      <div><button id="createChatBtn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button><button onclick="closeModal('messengerModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
    <div style="display:flex; gap:12px; height:calc(100% - 48px);">
      <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
        <div style="font-weight:900">–î–∏–∞–ª–æ–≥–∏</div>
        <div id="chatsList" style="overflow:auto; flex:1; padding-right:6px;"></div>
      </div>
      <div id="chatPane" style="width:420px; border-left:1px solid rgba(255,255,255,.02); padding-left:12px; display:flex; flex-direction:column;">
        <div id="chatWindowHeader" class="chat-top" style="display:none;"><div class="avatar" id="chatHeaderAvatar">–ë</div><div><div id="chatHeaderName" style="font-weight:900">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div><div class="small" id="chatHeaderSub">–ò–Ω—Ñ–æ</div></div></div>
        <div id="chatWindow" style="display:none; flex:1; flex-direction:column;">
          <div id="chatMsgs" class="msgs"></div>
          <div style="display:flex; gap:8px; margin-top:8px;"><input id="chatInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."><button id="chatSend" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
        </div>
        <div id="chatEmpty" style="display:flex; align-items:center; justify-content:center; flex:1; color:var(--muted);">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</div>
      </div>
    </div>
  </div>
</section>

<!-- Footer developer note (small) -->
<!-- End modals -->

<script>
/* =================== CONFIG / STORE =================== */
const JSONBIN = { ENABLED:true, BIN_ID:'6911fbe843b1c97be9a4dc97', KEY:'$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG', URL:id=>`https://api.jsonbin.io/v3/b/${id}` };
const LS = 'gid_v2_state';
const $ = id=>document.getElementById(id);
const uid = ()=>Math.random().toString(36).slice(2,9);
const nowISO = ()=>new Date().toISOString();

let STATE = {
  profile:{id:'u_me', name:'–í—ã', avatar:'ü§ñ'},
  city:'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  role:'user',
  theme:'violet',
  orders:[],
  feed:{},
  chats:[],
  notifs:[],
  sync:true
};

function loadLocal(){ try{ const s=localStorage.getItem(LS); if(s) Object.assign(STATE, JSON.parse(s)); }catch(e){ console.warn(e); } }
function saveLocal(){ try{ localStorage.setItem(LS, JSON.stringify(STATE)); }catch(e){ console.warn(e); } }
loadLocal();

/* categories & cities */
const CATS = ['–°–ü–ï–¶. –ó–ê–ö–ê–ó','–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–î–æ—Å—Ç–∞–≤–∫–∞','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º','–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç','–ü—Ä–æ—á–∏–µ'];
const CITYS = ['–ê–ª–º–∞—Ç—ã','–ê—Å—Ç–∞–Ω–∞','–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','–®—ã–º–∫–µ–Ω—Ç','–ê–∫—Ç–æ–±–µ','–ü–∞–≤–ª–æ–¥–∞—Ä','–¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω'];

/* theme map */
const THEMEMAP = {
  violet:['#a970ff','#32ffd2','#ffd84d'],
  navy:['#6aa7ff','#7ef3ff','#ffd84d'],
  emerald:['#33e09d','#b7ff78','#ffd84d'],
  sunset:['#ff6dab','#ffcc6d','#ffd84d'],
  mint:['#35e0c1','#a7ff83','#ffd84d'],
  peach:['#ff9e7a','#ffd36d','#ffd84d'],
  rose:['#ff6fa3','#ffc6e0','#ffd84d'],
  amber:['#ffb300','#ffd54f','#ffd84d']
};

/* apply theme */
function applyTheme(theme){
  if(theme) STATE.theme=theme;
  const arr=THEMEMAP[STATE.theme] || THEMEMAP['violet'];
  document.documentElement.style.setProperty('--accent', arr[0]);
  document.documentElement.style.setProperty('--accent-2', arr[1]);
  document.documentElement.style.setProperty('--accent-warn', arr[2]);
  saveLocal();
}
applyTheme(STATE.theme);

/* header time/weather */
async function updateDateWeather(){
  const now=new Date();
  $('time').textContent = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
  $('date').textContent = now.toLocaleDateString('ru-RU', { day:'numeric', month:'long', year:'numeric' });
  // try fetch weather (open-meteo) using city coords (fallback fixed)
  const coords = { '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞':{lat:49.8064, lon:73.0851}, '–ê–ª–º–∞—Ç—ã':{lat:43.2383, lon:76.9458}, '–ê—Å—Ç–∞–Ω–∞':{lat:51.1282, lon:71.4301} }[STATE.city] || {lat:49.8064, lon:73.0851};
  try{
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=auto`);
    if(r.ok){
      const j=await r.json();
      const t = Math.round(j.current_weather.temperature);
      $('weather').textContent = `üå§ ${t}¬∞C`;
    }
  }catch(e){ /* ignore */ }
}
updateDateWeather(); setInterval(updateDateWeather, 60000);

/* UI renderers */
function renderRoleTabs(){
  const wrap = $('roleTabs'); wrap.innerHTML='';
  const roles = [{k:'user', label:'–°–§–ï–†–ê –£–°–õ–£–ì'},{k:'worker', label:'–ü–û–î–†–ê–ë–û–¢–ö–ê'}];
  roles.forEach(r=>{
    const el = document.createElement('div'); el.className='role-tab'; el.textContent=r.label; if(STATE.role===r.k) el.classList.add('active');
    el.onclick = ()=>{ STATE.role=r.k; saveLocal(); updateRoleUI(); renderMenu(); };
    wrap.appendChild(el);
  });
}
function updateRoleUI(){
  // big buttons active state
  $('roleBtnUser').classList.toggle('active', STATE.role==='user');
  $('roleBtnWorker').classList.toggle('active', STATE.role==='worker');
}
function renderMenu(){
  const list = $('menuList'); list.innerHTML='';
  // role-specific entries
  if(STATE.role==='user'){
    list.appendChild(menuItem('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'));
    list.appendChild(menuItem('btnBook','–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨','–°–∫–æ—Ä–æ'));
    list.appendChild(menuItem('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    list.appendChild(menuItem('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏'));
    list.appendChild(menuItem('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    list.appendChild(menuItem('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–ü—É–±–ª–∏–∫—É–π—Ç–µ –∏ –∏—â–∏—Ç–µ'));
    list.appendChild(menuItem('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  } else {
    list.appendChild(menuItem('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π'));
    list.appendChild(menuItem('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    list.appendChild(menuItem('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏'));
    list.appendChild(menuItem('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    list.appendChild(menuItem('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–ü—É–±–ª–∏–∫—É–π—Ç–µ –∏ –∏—â–∏—Ç–µ'));
    list.appendChild(menuItem('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  }

  // wire events
  ['btnOrder','btnFind','btnCity','btnMine','btnMessenger','btnAds','btnWallet','btnBook'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.onclick = ()=>{
      switch(id){
        case 'btnOrder': openCreate(); break;
        case 'btnBook': alert('–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Å–∫–æ—Ä–æ'); break;
        case 'btnCity': openCityThread(); break;
        case 'btnFind': openFind(); break;
        case 'btnMine': openMine(); break;
        case 'btnMessenger': openMessenger(); break;
        case 'btnAds': alert('–û–±—ä—è–≤–ª–µ–Ω–∏—è ‚Äî –¥–µ–º–æ'); break;
        case 'btnWallet': alert('–ö–æ—à–µ–ª—ë–∫ ‚Äî –¥–µ–º–æ'); break;
      }
    };
  });
}

function menuItem(id,title,note){
  const el = document.createElement('div'); el.className='menu-btn'; el.id=id;
  el.innerHTML = `<div style="display:flex;flex-direction:column;align-items:flex-start"><div style="font-weight:900">${title}</div><div class="small" style="color:var(--muted)">${note||''}</div></div><div>‚Ä∫</div>`;
  return el;
}

/* initial menu wiring */
$('roleBtnUser').onclick = ()=>{ STATE.role='user'; saveLocal(); renderRoleTabs(); updateRoleUI(); renderMenu(); };
$('roleBtnWorker').onclick = ()=>{ STATE.role='worker'; saveLocal(); renderRoleTabs(); updateRoleUI(); renderMenu(); };

/* Notifications UI */
function refreshNotifBadge(){ const n = STATE.notifs.length; const b = $('notifBadge'); if(n>0){ b.style.display='inline-block'; b.textContent = n>99 ? '99+' : String(n); } else b.style.display='none'; }
$('notifLabel').addEventListener('click', ()=>{ // open settings notifications area for now
  openModal('settingsModal');
  alert('–û—Ç–∫—Ä–æ–π —Ä–∞–∑–¥–µ–ª –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–¥–µ–º–æ)'); 
});
refreshNotifBadge();

/* SETTINGS: populate */
function populateSettings(){
  const sel = $('citySelect'); sel.innerHTML='';
  CITYS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
  sel.value = STATE.city || CITYS[0];
  $('pfName').value = STATE.profile.name || '';
  $('pfPhone').value = STATE.profile.phone || '';
  $('pfAvatar').textContent = STATE.profile.avatar || 'ü§ñ';
  $('syncToggle').checked = !!STATE.sync;
}
$('openSettingsBtn').addEventListener('click', ()=>{ populateSettings(); openModal('settingsModal'); });

$('pfSave').addEventListener('click', ()=>{ STATE.profile.name = $('pfName').value.trim() || STATE.profile.name; STATE.profile.phone = $('pfPhone').value.trim() || STATE.profile.phone; saveLocal(); alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });
$('saveCityBtn').addEventListener('click', ()=>{ const v=$('citySelect').value; if(!v) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); STATE.city=v; saveLocal(); updateDateWeather(); alert('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });

document.querySelectorAll('.theme-btn').forEach(btn=>btn.addEventListener('click', ()=>{ applyTheme(btn.dataset.theme); }));

/* Create order flow */
function openCreate(){ $('chosenCat').textContent=''; $('createExtraFields').innerHTML=''; $('c-desc').value=''; $('c-budget').value=''; $('c-datetime').value = (new Date(Date.now()+30*60*1000)).toISOString().slice(0,16); openModal('createModal'); }
$('chooseCatBtn').addEventListener('click', ()=>{ renderCatPicker(); openModal('catPickerModal'); });

function renderCatPicker(){
  const list = $('catPickerList'); list.innerHTML='';
  CATS.forEach(c=>{
    const el = document.createElement('div'); el.className='cat-card';
    el.innerHTML = `<div class="cat-art"><svg width="140" height="80" viewBox="0 0 140 80" xmlns="http://www.w3.org/2000/svg"><rect width="140" height="80" rx="10" fill="rgba(255,255,255,0.02)"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#aab" font-size="14">${c}</text></svg></div><div class="cat-title"><span>${c}</span><span class="small" style="color:var(--muted)">–í—ã–±—Ä–∞—Ç—å</span></div>`;
    el.onclick = ()=>{ $('chosenCat').textContent = c; closeModal('catPickerModal'); renderCreateExtra(c); };
    list.appendChild(el);
  });
}
function renderCreateExtra(cat){
  const wrap = $('createExtraFields'); wrap.innerHTML='';
  if(cat==='–¢–∞–∫—Å–∏') wrap.innerHTML = `<div style="display:flex;gap:8px"><input id="f-from" class="input" placeholder="–û—Ç–∫—É–¥–∞"><input id="f-to" class="input" placeholder="–ö—É–¥–∞"></div>`;
  if(cat==='–ö—É—Ä—å–µ—Ä') wrap.innerHTML = `<div style="display:flex;gap:8px"><input id="f-pick" class="input" placeholder="–ó–∞–±—Ä–∞—Ç—å (–∞–¥—Ä–µ—Å)"><input id="f-drop" class="input" placeholder="–î–æ—Å—Ç–∞–≤–∏—Ç—å (–∞–¥—Ä–µ—Å)"></div>`;
  if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º') wrap.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><input class="input" id="f-area" placeholder="–†–∞–π–æ–Ω"><input class="input" id="f-rooms" placeholder="–ö–æ–º–Ω–∞—Ç"></div><div style="display:flex;gap:8px;margin-top:8px"><input class="input" id="f-square" placeholder="–ü–ª–æ—â–∞–¥—å (–º¬≤)"><input class="input" id="f-period" placeholder="–ü–µ—Ä–∏–æ–¥"></div>`;
  if(cat==='–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç') wrap.innerHTML = `<div style="display:flex;gap:8px"><input id="f-person" class="input" placeholder="–ö–æ–≥–æ –∏—â–µ–º (–Ω—è–Ω—è, –ø—Å–∏—Ö–æ–ª–æ–≥...)"><input id="f-details" class="input" placeholder="–ö—Ä–∞—Ç–∫–∏–µ –¥–µ—Ç–∞–ª–∏"></div>`;
}
$('submitOrderBtn').addEventListener('click', ()=>{ const cat = $('chosenCat').textContent || '–°–ü–ï–¶. –ó–ê–ö–ê–ó'; const desc = $('c-desc').value.trim(); const dt = $('c-datetime').value; const budget = Number($('c-budget').value || 0); if(!desc || !dt) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É'); const order = { id:'o_'+uid(), category:cat, desc, datetime:dt, budget, city:STATE.city, ownerId:STATE.profile.id, ownerName:STATE.profile.name, bids:[], status:'open', createdAt:nowISO() }; STATE.orders.unshift(order); saveLocal(); alert('–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'); closeModal('createModal'); });

/* Find orders (worker) */
function openFind(){ renderFind(); openModal('findModal'); }
function renderFind(){
  const sel = $('filterCat'); sel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>'; CATS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
  renderFindList();
}
function renderFindList(){
  const wrap = $('findList'); wrap.innerHTML = '';
  let items = STATE.orders.filter(o => o.status==='open' && (!o.city || o.city===STATE.city));
  const q = ($('searchInput').value||'').toLowerCase();
  const cat = $('filterCat').value;
  if(cat) items = items.filter(i=>i.category===cat);
  if(q) items = items.filter(i=>(i.category+' '+i.desc+' '+(i.ownerName||'')).toLowerCase().includes(q));
  if(!items.length){ wrap.innerHTML = '<div class="small">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const card = document.createElement('div'); card.className='post-card';
    card.innerHTML = `<div style="font-weight:900">${o.category} ‚Ä¢ ${o.city} ‚Ä¢ ‚Ç∏ ${Number(o.budget||0).toLocaleString('ru-RU')}</div><div class="small" style="margin-top:6px">–î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div><div style="margin-top:8px">${escapeHtml(o.desc)}</div><div class="post-actions"><button class="act" data-act="offer">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É</button></div>`;
    card.querySelector('[data-act="offer"]').addEventListener('click', ()=>{ $('offerModal').dataset.orderId = o.id; openModal('offerModal'); });
    wrap.appendChild(card);
  });
}
$('applySearch').addEventListener('click', renderFindList);

/* offer submit */
$('offerForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const price = Number($('offerPrice').value||0); if(!price) return alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É'); const comment = $('offerComment').value.trim();
  const orderId = $('offerModal').dataset.orderId; const order = STATE.orders.find(x=>x.id===orderId); if(!order) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const bid = { performerId: STATE.profile.id, name: STATE.profile.name, price, comment, createdAt: nowISO() };
  order.bids = order.bids || []; order.bids.push(bid);
  STATE.notifs.unshift({ id:'n_'+uid(), type:'bid', title:'–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', body:`–ù–∞ –≤–∞—à –∑–∞–∫–∞–∑ "${order.category}" –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ ‚Ç∏ ${price}`, ts:nowISO(), payload:{ orderId }});
  saveLocal(); closeModal('offerModal'); alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); refreshNotifBadge();
});

/* My orders (owner) */
function openMine(){ renderMine(); openModal('findModal'); $('findTitle').textContent = '–ú–æ–∏ –∑–∞–∫–∞–∑—ã'; }
function renderMine(){
  const wrap = $('findList'); wrap.innerHTML = '';
  const mine = STATE.orders.filter(o => o.ownerId === STATE.profile.id);
  if(!mine.length){ wrap.innerHTML = '<div class="small">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  mine.forEach(o=>{
    const card = document.createElement('div'); card.className='post-card';
    const bidsCount = (o.bids||[]).length;
    card.innerHTML = `<div style="font-weight:900">${o.category} ${bidsCount?(' ‚Ä¢ <span style="color:#ff9bb0">'+bidsCount+' –∑–∞—è–≤–æ–∫</span>'):''}</div><div class="small" style="margin-top:6px">–°—Ç–∞—Ç—É—Å: ${o.status} ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div><div style="margin-top:8px">${escapeHtml(o.desc)}</div>`;
    const actions = document.createElement('div'); actions.style.marginTop='8px';
    const viewBtn = document.createElement('button'); viewBtn.className='btn btn-primary'; viewBtn.textContent='–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏'; viewBtn.addEventListener('click', ()=> openBidsModal(o.id) );
    actions.appendChild(viewBtn); card.appendChild(actions); wrap.appendChild(card);
  });
}
function openBidsModal(orderId){
  const order = STATE.orders.find(x=>x.id===orderId); if(!order) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  // reuse catPickerList container to show bids
  const list = $('catPickerList'); list.innerHTML=''; order.bids = order.bids || [];
  if(!order.bids.length){ list.innerHTML = '<div class="small">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>'; openModal('catPickerModal'); return; }
  order.bids.forEach((b, idx)=>{
    const row = document.createElement('div'); row.className='post-card';
    row.innerHTML = `<div style="font-weight:900">${escapeHtml(b.name)} ‚Äî ‚Ç∏ ${Number(b.price).toLocaleString('ru-RU')}</div><div class="small" style="margin-top:6px">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–æ: ${new Date(b.createdAt).toLocaleString()}</div><div style="margin-top:8px">${escapeHtml(b.comment||'')}</div>`;
    const actions = document.createElement('div'); actions.style.marginTop='8px';
    const accept = document.createElement('button'); accept.className='btn btn-primary'; accept.textContent='–ü—Ä–∏–Ω—è—Ç—å';
    accept.addEventListener('click', ()=>{
      // create chat, set in_progress
      const chat = { id:'chat_'+uid(), orderId: order.id, title: order.category, participants: [order.ownerId, b.performerId], messages: [{ from:'system', text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω –ø–æ –∑–∞–∫–∞–∑—É', ts:nowISO() }] };
      STATE.chats.unshift(chat); order.status='in_progress';
      STATE.notifs.unshift({ id:'n_'+uid(), type:'accepted_owner', title:'–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É', body:`–û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å ${b.name}`, ts:nowISO(), payload:{ chatId: chat.id, orderId: order.id }});
      saveLocal(); renderChats(); openMessenger(); openChat(chat.id); closeModal('catPickerModal');
    });
    const decline = document.createElement('button'); decline.className='btn'; decline.textContent='–û—Ç–∫–∞–∑–∞—Ç—å';
    decline.addEventListener('click', ()=>{ order.bids.splice(idx,1); saveLocal(); openBidsModal(orderId); });
    actions.appendChild(accept); actions.appendChild(decline); row.appendChild(actions); list.appendChild(row);
  });
  openModal('catPickerModal');
}

/* City thread (posts) */
function openCityThread(){ renderCityPosts(); openModal('cityThreadModal'); }
function renderCityPosts(){
  const wrap = $('cityPosts'); wrap.innerHTML='';
  const posts = STATE.feed[STATE.city] || [];
  if(!posts.length){ wrap.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
  posts.forEach(p=>{
    const el = document.createElement('div'); el.className='post-card';
    const likes = Object.keys(p.likes?.byUser||{}).length;
    el.innerHTML = `<div class="post-top"><div class="avatar">${(p.authorName||'–ü')[0]}</div><div style="display:flex;flex-direction:column;"><div style="font-weight:900">${escapeHtml(p.authorName)}</div><div class="small">${new Date(p.ts).toLocaleString()}</div></div></div><div style="margin-top:8px; white-space:pre-wrap">${escapeHtml(p.text)}</div>${p.image?('<div style="margin-top:8px"><img src="'+p.image+'" style="max-width:100%;border-radius:8px"></div>') : ''}<div class="post-actions"><button class="act" data-act="like">‚ù§Ô∏è <span data-likecount>'+likes+'</span></button><button class="act" data-act="comment">üí¨</button><button class="act" data-act="repost">üîÅ</button></div><div class="comments" style="display:none; margin-top:8px"><div style="display:flex;gap:8px"><input class="input comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."><button class="btn btn-primary comment-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div><div class="comments-list" style="margin-top:8px"></div></div>`;
    wrap.appendChild(el);
    el.querySelector('[data-act="like"]').addEventListener('click', ()=>{ const me = STATE.profile.id; p.likes = p.likes || { byUser:{} }; if(p.likes.byUser[me]) delete p.likes.byUser[me]; else p.likes.byUser[me]=true; el.querySelector('[data-likecount]').textContent = Object.keys(p.likes.byUser||{}).length; saveLocal(); });
    el.querySelector('[data-act="comment"]').addEventListener('click', ()=>{ const c = el.querySelector('.comments'); c.style.display = c.style.display==='none' ? 'block' : 'none'; });
    el.querySelector('.comment-send').addEventListener('click', ()=>{ const input = el.querySelector('.comment-input'); const txt = input.value.trim(); if(!txt) return; p.comments = p.comments || []; p.comments.push({ id:'c_'+uid(), authorName:STATE.profile.name, text:txt, ts:nowISO() }); input.value=''; saveLocal(); const list = el.querySelector('.comments-list'); const node = document.createElement('div'); node.className='comment'; node.innerHTML = `<div style="font-weight:800">${escapeHtml(STATE.profile.name)}</div><div class="small">${new Date().toLocaleString()}</div><div style="margin-top:6px">${escapeHtml(txt)}</div>`; list.appendChild(node); });
    el.querySelector('[data-act="repost"]').addEventListener('click', ()=>alert('–†–µ–ø–æ—Å—Ç ‚Äî –¥–µ–º–æ'));
  });
}

/* Quick post flow */
$('cityTopPlaceholder').addEventListener('click', ()=>{ $('quickPostText').value=''; $('quickPostPreview').innerHTML=''; $('quickPostImage').value=''; openModal('quickPostModal'); });
$('quickPostImage').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  if(f.size > 6*1024*1024){ alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π'); return; }
  const r = new FileReader();
  r.onload = ()=>{ $('quickPostPreview').innerHTML = `<img src="${r.result}" style="max-width:100%; border-radius:8px">`; $('quickPostPreview').dataset.img = r.result; };
  r.readAsDataURL(f);
});
$('quickPostSend').addEventListener('click', ()=>{
  const text = $('quickPostText').value.trim(); const img = $('quickPostPreview').dataset.img || null;
  if(!text && !img) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
  const post = { id:'post_'+uid(), authorId:STATE.profile.id, authorName:STATE.profile.name, text, image:img, ts:nowISO(), likes:{byUser:{}}, comments:[] };
  (STATE.feed[STATE.city] = STATE.feed[STATE.city]||[]).unshift(post);
  saveLocal(); renderCityPosts(); closeModal('quickPostModal'); alert('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω');
});

/* composer compact on scroll */
let lastScroll = 0;
const cityScroll = $('cityScroll');
if(cityScroll){
  cityScroll.addEventListener('scroll', ()=>{
    const comp = $('cityComposerTop');
    const st = cityScroll.scrollTop;
    if(st > lastScroll + 10) comp.classList.add('compact');
    else if(st < lastScroll - 10) comp.classList.remove('compact');
    lastScroll = st;
  }, { passive:true });
}

/* Messenger */
function openMessenger(){ renderChats(); openModal('messengerModal'); }
function renderChats(){
  const wrap = $('chatsList'); wrap.innerHTML = '';
  if(!STATE.chats.length){ wrap.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>'; $('chatWindowHeader').style.display='none'; $('chatWindow').style.display='none'; $('chatEmpty').style.display='block'; return; }
  STATE.chats.forEach(c=>{
    const el = document.createElement('div'); el.className='post-card'; el.style.cursor='pointer';
    el.innerHTML = `<div style="font-weight:900">${escapeHtml(c.title||'–ß–∞—Ç')}</div><div class="small" style="margin-top:6px">${c.orderId?('–ó–∞–∫–∞–∑: '+c.orderId):'–î–∏–∞–ª–æ–≥'}</div>`;
    el.addEventListener('click', ()=> openChat(c.id));
    wrap.appendChild(el);
  });
}
function openChat(chatId){
  const chat = STATE.chats.find(c=>c.id===chatId); if(!chat) return;
  $('chatWindowHeader').style.display='flex'; $('chatWindow').style.display='flex'; $('chatEmpty').style.display='none';
  $('chatHeaderName').textContent = chat.title || '–î–∏–∞–ª–æ–≥';
  $('chatHeaderAvatar').textContent = (chat.title||'–ß')[0];
  const msgsWrap = $('chatMsgs'); msgsWrap.innerHTML = '';
  (chat.messages||[]).forEach(m=>{
    const d = document.createElement('div'); d.className = 'msg ' + ((m.from === STATE.profile.id)?'me':'other');
    if(m.from === 'system'){ d.style.fontStyle='italic'; d.style.color='var(--muted)'; d.textContent = m.text; }
    else { if(m.from === STATE.profile.id) d.innerHTML = `<div>${escapeHtml(m.text)}</div>`; else d.innerHTML = `<div style="font-weight:800;margin-bottom:6px">${escapeHtml(m.fromName||'')}</div><div>${escapeHtml(m.text)}</div>`; }
    msgsWrap.appendChild(d);
  });
  msgsWrap.scrollTop = msgsWrap.scrollHeight;
  $('chatSend').onclick = ()=>{ const v = $('chatInput').value.trim(); if(!v) return; const msg = { from: STATE.profile.id, fromName: STATE.profile.name, text: v, ts: nowISO() }; chat.messages = chat.messages||[]; chat.messages.push(msg); saveLocal(); $('chatInput').value=''; openChat(chatId); };
}

/* Create chat from picker */
$('createChatBtn').addEventListener('click', ()=> {
  const picker = $('catPickerList'); picker.innerHTML = '';
  // build contacts from orders/bids
  const users = new Map();
  STATE.orders.forEach(o=> { users.set(o.ownerId, o.ownerName||('user_'+o.ownerId)); (o.bids||[]).forEach(b=>users.set(b.performerId, b.name||('user_'+b.performerId))); });
  if(!users.size){ picker.innerHTML = '<div class="small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>'; openModal('catPickerModal'); return; }
  users.forEach((name, id)=>{
    const el = document.createElement('div'); el.className='post-card'; el.style.cursor='pointer';
    el.innerHTML = `<div style="font-weight:900">${escapeHtml(name)}</div><div class="small" style="margin-top:6px">${escapeHtml(id)}</div>`;
    el.addEventListener('click', ()=>{ const chat = { id:'chat_'+uid(), orderId:null, title:'–î–∏–∞–ª–æ–≥ —Å '+name, participants:[STATE.profile.id, id], messages:[{from:'system', text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω', ts:nowISO()}] }; STATE.chats.unshift(chat); saveLocal(); closeModal('catPickerModal'); renderChats(); openChat(chat.id); });
    picker.appendChild(el);
  });
  openModal('catPickerModal');
});

/* JSONBin sync */
async function loadCloud(){
  if(!JSONBIN.ENABLED) return;
  try{
    const res = await fetch(JSONBIN.URL(JSONBIN.BIN_ID), { headers: { 'X-Master-Key': JSONBIN.KEY } });
    if(!res.ok) throw new Error('GET '+res.status);
    const j = await res.json();
    const rec = j.record || {};
    if(Array.isArray(rec.orders)) STATE.orders = rec.orders;
    if(rec.feed) STATE.feed = rec.feed;
    if(Array.isArray(rec.chats)) STATE.chats = rec.chats;
    if(Array.isArray(rec.notifs)) STATE.notifs = rec.notifs;
    saveLocal(); renderCityPosts(); renderFindList(); renderChats(); refreshNotifBadge();
  }catch(e){ console.warn('cloud load error', e); }
}
async function saveCloud(){
  if(!JSONBIN.ENABLED) return;
  try{
    const payload = { orders: STATE.orders, feed: STATE.feed, chats: STATE.chats, notifs: STATE.notifs };
    await fetch(JSONBIN.URL(JSONBIN.BIN_ID), { method:'PUT', headers:{ 'Content-Type':'application/json','X-Master-Key':JSONBIN.KEY }, body: JSON.stringify(payload) });
  }catch(e){ console.warn('cloud save error', e); }
}
$('syncNowBtn').addEventListener('click', async ()=>{ try{ await loadCloud(); alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: '+(e.message||e)); }});
$('syncToggle').addEventListener('change', (e)=>{ STATE.sync = !!e.target.checked; saveLocal(); });

let __syncLock = false;
setInterval(async ()=>{
  if(STATE.sync && !__syncLock){ __syncLock=true; try{ await saveCloud(); await loadCloud(); }catch(e){} finally{ __syncLock=false; } }
}, 1000);

/* helpers */
function openModal(id){ const el = $(id); if(el) el.style.display='block'; }
function closeModal(id){ const el = $(id); if(el) el.style.display='none'; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[c])); }

/* init */
function initDemoData(){
  if(STATE.orders.length===0){
    STATE.orders = [
      { id:'o1', category:'–¢–∞–∫—Å–∏', city:'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', budget:1200, datetime:new Date().toISOString().slice(0,16), desc:'–ü–æ–µ–∑–¥–∫–∞ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç', ownerId:'u_owner1', ownerName:'–ê–π–¥–∞—Ä', bids:[], status:'open', createdAt: nowISO() },
      { id:'o2', category:'–î–æ—Å—Ç–∞–≤–∫–∞', city:'–ê—Å—Ç–∞–Ω–∞', budget:900, datetime:new Date().toISOString().slice(0,16), desc:'–î–æ—Å—Ç–∞–≤–∫–∞ –æ–±–µ–¥–∞', ownerId:'u_owner2', ownerName:'–°–∞–ª—Ç–∞–Ω–∞—Ç', bids:[], status:'open', createdAt: nowISO() }
    ];
  }
  saveLocal();
}
initDemoData();

/* initial UI render */
function initUI(){
  renderRoleTabs(); updateRoleUI(); renderMenu(); populateSettings();
  // set up menu big buttons text
  $('roleBtnUser').textContent = '–°–§–ï–†–ê –£–°–õ–£–ì'; $('roleBtnWorker').textContent = '–ü–û–î–†–ê–ë–û–¢–ö–ê';
}
initUI();

/* helpers to open flows */
function openCreate(){ openCreate(); } // wrapper (unused)
function openFind(){ openFind(); }
function openMine(){ openMine(); }
function openCityThread(){ openCityThread(); }
function openMessenger(){ openMessenger(); }

/* expose for debug */
window.GID = { STATE, saveLocal, loadCloud, saveCloud };

</script>
</body>
</html>
