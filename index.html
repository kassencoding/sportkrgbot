<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GiDCity ‚Äî Telegram Mini App</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22;
  --surface:rgba(20,24,40,.78); --glass:rgba(255,255,255,.08);
  --line:rgba(160,170,230,.28);
  --accent-a:#a970ff; --accent-b:#32ffd2;
  --gold:#ffd84d; --danger:#ff4f6a;
  --text:#ffffff; --text-muted:#9aa6d9; --text-invert:#0b0f18;
  --radius:16px; --shadow:0 16px 46px rgba(0,0,0,.45);
  --ui-font:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --ui-font-size:14px;
}
/* –¢–µ–º—ã */
html[data-theme="navy"]   { --accent-a:#6aa7ff; --accent-b:#7ef3ff; --line:rgba(120,170,255,.35) }
html[data-theme="emerald"]{ --accent-a:#33e09d; --accent-b:#b7ff78; --line:rgba(120,255,180,.30) }
html[data-theme="sunset"] { --accent-a:#ff6dab; --accent-b:#ffcc6d; --line:rgba(255,170,120,.30) }
html[data-theme="mint"]   { --accent-a:#35e0c1; --accent-b:#a7ff83; --line:rgba(140,255,200,.30) }
html[data-theme="rose"]   { --accent-a:#ff6fa3; --accent-b:#ffc6e0; --line:rgba(255,160,200,.30) }
html[data-theme="amber"]  { --accent-a:#ffb300; --accent-b:#ffd54f; --line:rgba(255,210,120,.32) }
html[data-theme="light"]  {
  --bg-1:#ffffff; --bg-2:#f6f7fb; --bg-3:#eef1f7;
  --text:#1a1a1a; --text-muted:#505b80; --text-invert:#ffffff;
  --surface:rgba(255,255,255,.9); --line:#dde3f0; --glass:rgba(0,0,0,.06);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; min-height:100vh; padding:12px; color:var(--text);
  font: var(--ui-font-size) var(--ui-font);
  background: linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
}
.wrapper{ max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:12px }

/* Header */
.header{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px }
.brand h1{ margin:0; font-weight:800; font-size:22px; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); -webkit-background-clip:text; color:transparent }
.header-sub{ font-size:13px; color:var(--text-muted) }
.header-right .btn{ margin-left:auto }

/* Role tabs (full width, 2 columns) */
.topbar{ display:flex; flex-direction:column; gap:10px }
.role-tabs{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
.role-tab{ padding:12px 14px; text-align:center; border-radius:12px; background:rgba(0,0,0,.15); border:1px solid var(--line); cursor:pointer; font-weight:900; }
.role-tab.active{ background:linear-gradient(180deg,#ffd84d,#ffcc33); color:#1a1a1a; border-color:#e6b800; box-shadow:0 6px 18px rgba(255,216,77,.25) }

/* Container */
.container{ border-radius:16px; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden }
.panel-top{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--glass) }
.panel-top h2{ margin:0; font-size:16px; font-weight:900; display:flex; align-items:center; gap:8px }
#notifBtn{ position:relative }
#notifBadge{ position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; border-radius:999px; padding:1px 6px; font-size:11px; font-weight:900; display:none }

/* Menu */
.menu-grid{ padding:12px; display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:10px }
.menu-btn{ display:flex; align-items:center; gap:10px; padding:12px; min-height:64px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12)); cursor:pointer }
.menu-btn .title{ font-weight:900 } .menu-btn .note{ font-size:12px; color:var(--text-muted) }

/* Inputs */
.input, textarea, select{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:rgba(12,16,36,.75); color:var(--text); font-size:14px; outline:none }
textarea{ min-height:120px; resize:vertical }
.field-label{ font-size:12px; color:var(--text-muted); font-weight:800; margin:0 0 4px 2px }
html[data-theme="light"] .input, html[data-theme="light"] textarea, html[data-theme="light"] select { background:#fff }

/* Buttons */
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; color:var(--text); padding:10px 14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18)); border:1px solid var(--line) }
.btn.primary{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:var(--text-invert) }
.btn.ghost{ background:transparent; border:1px dashed var(--line) }

/* Screens (modal) */
.screen{ position:fixed; inset:0; display:none; z-index:10; padding:10px; background:rgba(0,0,0,.45); backdrop-filter:blur(8px); align-items:flex-start; justify-content:center }
.screen.active{ display:flex }
.modal{ width:100%; max-width:900px; max-height:88vh; overflow:auto; background:var(--surface); border:1px solid var(--line); border-radius:14px; padding:14px }

/* City chat */
.city-composer{ position:sticky; top:10px; z-index:1; padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); display:flex; flex-direction:column; gap:8px; transition:all .2s ease }
.city-composer.compact{ padding:6px; backdrop-filter:saturate(0.9) blur(4px) }
.city-composer.compact textarea{ min-height:56px }
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; margin-bottom:10px }
.post-img{ width:100%; border-radius:10px; margin-top:6px; max-height:320px; object-fit:cover }
.post-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
.comment{ background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:10px; padding:8px; margin-top:6px }
.avatar{ width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; background:linear-gradient(135deg,var(--accent-a),var(--accent-b)); color:#fff }
.avatar img{ width:100%; height:100%; object-fit:cover; border-radius:50% }

/* Chips */
.chips{ display:flex; gap:8px; flex-wrap:wrap }
.chip{ padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.04); font-weight:800; cursor:pointer; user-select:none }
.chip.active{ background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); color:var(--text-invert); border-color:transparent }

/* Messenger */
.chat-list-empty{ padding:12px; border:1px dashed var(--line); border-radius:12px; text-align:center }
.msgs{ margin-top:8px; max-height:58vh; overflow:auto; padding-right:6px }
.msg-row{ margin:8px 0 } .msg-me{ text-align:right }
.msg-me .b{ display:inline-block; background:linear-gradient(90deg, rgba(169,112,255,.9), rgba(50,255,210,.9)); padding:8px 12px; border-radius:12px; color:#0a0f1e; font-weight:800; box-shadow:0 8px 26px rgba(50,200,200,.06); max-width:78%; word-break:break-word; }
.msg-other .b{ display:inline-block; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); padding:8px 12px; border-radius:12px; color:var(--text); max-width:78%; word-break:break-word; }

/* Welcome overlay */
#welcomeOverlay{ position:fixed; inset:0; display:none; z-index:50; align-items:center; justify-content:center; background:rgba(0,0,0,.6); backdrop-filter:blur(8px) }
#welcomeOverlay.active{ display:flex; animation:fadeIn .25s ease }
#welcomeCard{ background:var(--surface); border:1px solid var(--line); border-radius:18px; padding:22px; width:92%; max-width:560px; box-shadow:var(--shadow); transform:translateY(16px); animation:slideUp .35s ease both }
#welcomeTitle{ margin:0 0 8px 0; font-weight:900; font-size:18px; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); -webkit-background-clip:text; color:transparent; text-align:center }
#welcomeSub{ text-align:center; color:var(--text-muted) }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
@keyframes slideUp{ from{ transform:translateY(24px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1 id="logoText">GiDCity</h1>
      <div id="topCity" class="header-sub">–ì–æ—Ä–æ–¥: ‚Äî</div>
    </div>
    <div class="header-right">
      <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </header>

  <section class="topbar">
    <div id="roleTabs" class="role-tabs"></div>
  </section>

  <main class="container">
    <div class="panel-top">
      <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
      <button id="notifBtn" class="btn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è<span id="notifBadge">0</span></button>
    </div>
    <div id="menuGrid" class="menu-grid"></div>
  </main>
</div>

<!-- ===== WELCOME OVERLAY ===== -->
<div id="welcomeOverlay">
  <div id="welcomeCard">
    <h3 id="welcomeTitle">GiDCity-“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!</h3>
    <div id="welcomeSub">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GiDCity! üëã</div>
    <div style="display:flex; gap:8px; justify-content:center; margin-top:14px">
      <button id="welcomeOk" class="btn primary">–ù–∞—á–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- ===== CITY THREAD ===== -->
<section id="cityThreadScreen" class="screen"><div class="modal" id="cityThreadModal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
      <button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="cityScroll" style="margin-top:10px; max-height:74vh; overflow:auto; padding-right:4px">
      <div id="cityComposer" class="city-composer">
        <textarea id="cityPostText" class="input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—å—é..."></textarea>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <label class="btn">üì∑ –§–æ—Ç–æ<input type="file" id="cityPostImage" accept="image/*" style="display:none"></label>
          <button id="cityPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </div>
      <div id="cityPosts" style="margin-top:10px;"></div>
    </div>
  </div>
</div></section>

<!-- ===== CREATE ORDER ===== -->
<section id="createScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ó–ê–ö–ê–ó–ê–¢–¨</h3>
      <button onclick="closeScreen('createScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="createTabs" class="role-tabs" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–∞" style="margin-top:10px">
      <div class="role-tab active" data-val="–°–ü–ï–¶. –ó–ê–ö–ê–ó">–°–ü–ï–¶. –ó–ê–ö–ê–ó</div>
      <div class="role-tab" data-val="–¢–∞–∫—Å–∏">–¢–∞–∫—Å–∏</div>
      <div class="role-tab" data-val="–ö—É—Ä—å–µ—Ä">–ö—É—Ä—å–µ—Ä</div>
      <div class="role-tab" data-val="–î–æ—Å—Ç–∞–≤–∫–∞">–î–æ—Å—Ç–∞–≤–∫–∞</div>
      <div class="role-tab" data-val="–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)">–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º</div>
      <div class="role-tab" data-val="–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç">–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</div>
      <div class="role-tab" data-val="–ü—Ä–æ—á–∏–µ">–ü—Ä–æ—á–∏–µ</div>
      <div class="role-tab" data-val="–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å" data-disabled="1" title="–°–∫–æ—Ä–æ">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å (—Å–∫–æ—Ä–æ)</div>
    </div>

    <form id="createForm" style="margin-top:12px; display:grid; gap:10px;">
      <textarea id="c-desc" class="input" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É: —á—Ç–æ, –≥–¥–µ, —Å—Ä–æ–∫–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>

      <div>
        <div class="field-label">–ö—Ä–∏—Ç–µ—Ä–∏–∏</div>
        <div id="criteriaWrap" class="chips"></div>
      </div>

      <div id="createExtraFields"></div>

      <div class="form-stack" style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap">
        <div style="min-width:220px; flex:1">
          <label class="field-label" for="c-datetime">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
          <input id="c-datetime" class="input" type="datetime-local">
        </div>
        <div style="width:180px">
          <label class="field-label" for="c-budget">–ë—é–¥–∂–µ—Ç (‚Ç∏)</label>
          <input id="c-budget" class="input" type="number" placeholder="–ù–∞–ø—Ä. 10000" required>
        </div>
      </div>

      <div style="display:flex; gap:8px">
        <button class="btn primary" id="orderNowBtn" type="submit">–ó–ê–ö–ê–ó–ê–¢–¨</button>
        <button class="btn ghost" type="button" onclick="closeScreen('createScreen')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div></section>

<!-- ===== FIND ORDERS (worker) ===== -->
<section id="findScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´</h3>
      <button onclick="closeScreen('findScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button>
    </div>
    <div style="margin-top:10px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫...">
        <select id="filterCat" class="input" style="max-width:220px">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          <option>–°–ü–ï–¶. –ó–ê–ö–ê–ó</option><option>–¢–∞–∫—Å–∏</option><option>–ö—É—Ä—å–µ—Ä</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)</option><option>–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</option><option>–ü—Ä–æ—á–∏–µ</option>
        </select>
        <button id="applySearch" class="btn">–§–∏–ª—å—Ç—Ä</button>
      </div>
      <div id="findList" style="margin-top:12px"></div>
    </div>
  </div>
</div></section>

<!-- ===== MY ORDERS ===== -->
<section id="mineScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
      <button onclick="closeScreen('mineScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button>
    </div>
    <div id="mineList" style="margin-top:12px"></div>
  </div>
</div></section>

<!-- ===== MESSENGER LIST ===== -->
<section id="messengerScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3>
      <button onclick="closeScreen('messengerScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="chatsList" style="margin-top:12px"></div>
  </div>
</div></section>

<!-- ===== CHAT WINDOW ===== -->
<section id="chatWindow" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; align-items:center; gap:10px;">
      <div id="chatWinAvatar" class="avatar" style="width:32px; height:32px"></div>
      <div id="chatWinTitle" style="font-weight:900">–ß–∞—Ç</div>
      <div class="field-label" id="chatWinSub" style="margin-left:auto"></div>
      <button onclick="closeScreen('chatWindow')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="chatWinMsgs" class="msgs"></div>
    <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
      <input id="chatWinInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="chatWinSend" class="btn primary" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div></section>

<!-- ===== SETTINGS ===== -->
<section id="settingsModal" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="closeScreen('settingsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <div style="margin-top:10px; display:grid; gap:12px">
      <div>
        <div class="field-label">–ì–æ—Ä–æ–¥</div>
        <select id="citySelect" class="input"></select>
        <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
          <button id="saveCityBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="syncNowBtn" class="btn">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
          <div id="syncStatus" class="field-label" aria-live="polite"></div>
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <div style="flex:1; min-width:220px">
          <div class="field-label">–ò–º—è</div>
          <input id="profileName" class="input" placeholder="–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?">
        </div>
        <div style="flex:1; min-width:220px">
          <div class="field-label">–¢–µ–º–∞</div>
          <select id="themeSelect" class="input">
            <option value="violet">Violet</option>
            <option value="navy">Navy</option>
            <option value="emerald">Emerald</option>
            <option value="sunset">Sunset</option>
            <option value="mint">Mint</option>
            <option value="rose">Rose</option>
            <option value="amber">Amber</option>
            <option value="light">Light</option>
          </select>
        </div>
      </div>

      <div>
        <div class="field-label">–ê–≤–∞—Ç–∞—Ä</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" id="profilePhoto" accept="image/*" style="display:none"></label>
          <button id="pickEmojiBtn" class="btn">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
          <div id="avatarPreview" class="avatar" title="–ü—Ä–µ–≤—å—é"></div>
        </div>
        <div id="emojiPicker" style="display:none; margin-top:8px">
          <div class="chips" id="emojiGrid"></div>
        </div>
      </div>

      <div style="display:flex; gap:8px">
        <button id="saveProfileBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
    </div>
  </div>
</div></section>

<script>
/* ===== Telegram ===== */
const tg = window.Telegram?.WebApp;
if(tg){ tg.ready(); tg.expand(); }

/* ===== Storage (CloudStorage + fallback) ===== */
const AppStorage = {
  async set(key, value){
    if(tg && tg.CloudStorage){
      return new Promise(res=> tg.CloudStorage.setItem(key, JSON.stringify(value), ()=>res(true)));
    }
    localStorage.setItem(key, JSON.stringify(value)); return true;
  },
  async get(key, def=null){
    if(tg && tg.CloudStorage){
      return new Promise(res=> tg.CloudStorage.getItem(key, v=>{ if(!v) return res(def); try{res(JSON.parse(v))}catch(_){res(def)} }));
    }
    try{ const v=localStorage.getItem(key); return v?JSON.parse(v):def; }catch(_){ return def; }
  }
};

/* ===== JSONBin Sync (client-side demo) ===== */
const CLOUD = {
  ENABLED: true,                     // –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Å–∏–Ω–∫
  BIN_ID: 'YOUR_BIN_ID_HERE',        // <- –∑–∞–º–µ–Ω–∏
  KEY:    'YOUR_MASTER_KEY_HERE',    // <- –∑–∞–º–µ–Ω–∏
  POLL_MS: 8000
};
const CloudAPI = {
  url: id => `https://api.jsonbin.io/v3/b/${id}`,
  headers: key => ({ 'Content-Type':'application/json','X-Master-Key':key,'X-Bin-Versioning':'false' })
};
let __cloudLoading=false, __cloudSaving=false, __saveTimer=null;
async function loadCloud(){
  if(!CLOUD.ENABLED||__cloudLoading) return; __cloudLoading=true;
  try{
    $('syncStatus').textContent='–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞‚Ä¶';
    const r=await fetch(CloudAPI.url(CLOUD.BIN_ID),{headers:{'X-Master-Key':CLOUD.KEY}});
    if(!r.ok) throw new Error('GET '+r.status);
    const data=await r.json();
    const rec=data.record||{};
    if(Array.isArray(rec.orders)) STATE.orders = rec.orders;
    if(rec.feed) STATE.feed = rec.feed;
    if(rec.profile) STATE.profile = rec.profile;
    if(rec.theme) STATE.theme = rec.theme;
    await saveState();
    applyTheme(); applyMenu(); refreshNotif();
    if (document.getElementById('cityPosts')) renderCityPosts();
    if (document.getElementById('findList')) renderFindList();
    if (document.getElementById('mineList')) renderMineList();
    $('syncStatus').textContent='–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
  }catch(e){ console.warn('Cloud load error:', e); $('syncStatus').textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; }
  finally{ __cloudLoading=false; setTimeout(()=>{ $('syncStatus').textContent=''; },1800); }
}
async function saveCloud(){
  if(!CLOUD.ENABLED||__cloudSaving) return; __cloudSaving=true;
  try{
    $('syncStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ‚Ä¶';
    const payload={ orders:STATE.orders, feed:STATE.feed, profile:STATE.profile, theme:STATE.theme };
    const r=await fetch(CloudAPI.url(CLOUD.BIN_ID),{
      method:'PUT', headers: CloudAPI.headers(CLOUD.KEY), body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error('PUT '+r.status);
    $('syncStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
  }catch(e){ console.warn('Cloud save error:', e); $('syncStatus').textContent='–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'; }
  finally{ __cloudSaving=false; setTimeout(()=>{ $('syncStatus').textContent=''; },1600); }
}
function saveCloudDebounced(){ clearTimeout(__saveTimer); __saveTimer=setTimeout(saveCloud,700); }

/* ===== Keys & helpers ===== */
const KEYS={ CITY:'gid_city', ROLE:'gid_role', THEME:'gid_theme', PROFILE:'gid_profile', ORDERS:'gid_orders', NOTIFS:'gid_notifs', FEED:'gid_feed', CHATS:'gid_chats' };
const CITIES=['–ê–ª–º–∞—Ç—ã','–ê—Å—Ç–∞–Ω–∞','–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','–®—ã–º–∫–µ–Ω—Ç','–ê–∫—Ç–æ–±–µ','–¢–∞—Ä–∞–∑','–ü–∞–≤–ª–æ–¥–∞—Ä','–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫','–°–µ–º–µ–π','–ö—ã–∑—ã–ª–æ—Ä–¥–∞','–£—Ä–∞–ª—å—Å–∫','–ê—Ç—ã—Ä–∞—É','–ö–æ—Å—Ç–∞–Ω–∞–π','–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫','–≠–∫–∏–±–∞—Å—Ç—É–∑'];

const $=id=>document.getElementById(id);
const uid=()=>Math.random().toString(36).slice(2,9);
const nowISO=()=>new Date().toISOString();

/* ===== State ===== */
let STATE={
  city:'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  role:'user',
  theme:'violet',
  profile:null,
  orders:[],
  notifs:[],
  feed:{},
  chats:[]
};

/* ===== UI helpers ===== */
function applyTheme(){ document.documentElement.setAttribute('data-theme', STATE.theme); }
function displayName(){ return (STATE.profile?.name) || tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; }
function renderAvatar(el, prof){
  el.innerHTML=''; el.style.background=`linear-gradient(135deg,var(--accent-a),var(--accent-b))`;
  if(prof?.avatarType==='image' && prof?.avatarData){ const img=document.createElement('img'); img.src=prof.avatarData; el.appendChild(img); return; }
  if(prof?.avatarType==='emoji' && prof?.avatarData){ el.textContent=prof.avatarData; el.style.fontSize='22px'; return; }
  el.textContent=(displayName()[0]||'?').toUpperCase();
}
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }
function closeScreen(id){ $(id).classList.remove('active'); }
function pushNotif(n){ STATE.notifs.unshift(n); refreshNotif(); saveState(); }
function refreshNotif(){
  const n=STATE.notifs.length; const b=$('notifBadge');
  if(n>0){ b.style.display='inline-block'; b.textContent= n>99 ? '99+' : String(n); } else b.style.display='none';
}

/* ===== Roles / Settings ===== */
function setRoleTabs(){
  const wrap=$('roleTabs'); wrap.innerHTML='';
  [['user','–°–§–ï–†–ê –£–°–õ–£–ì'],['worker','–ü–û–î–†–ê–ë–û–¢–ö–ê']].forEach(([val,label])=>{
    const d=document.createElement('div'); d.className='role-tab'; d.dataset.role=val; d.textContent=label; if(STATE.role===val) d.classList.add('active'); wrap.appendChild(d);
  });
  wrap.onclick=(e)=>{ const t=e.target.closest('.role-tab'); if(!t) return; STATE.role=t.dataset.role; applyMenu(); saveState(); setRoleTabs(); };
}
function fillSettings(){
  const sel=$('citySelect'); sel.innerHTML=''; CITIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; if(c===STATE.city) o.selected=true; sel.appendChild(o); });
  $('profileName').value=STATE.profile?.name || '';
  $('themeSelect').value=STATE.theme;
  renderAvatar($('avatarPreview'), STATE.profile);
  const emojis=['ü•π','ü§©','üòè','ü§ñ','üòé','üòä','üòá','üòç','üß†','ü¶æ','üêº','ü¶Ñ','üéØ','üî•','üíô','üíú'];
  $('emojiGrid').innerHTML=''; emojis.forEach(e=>{ const ch=document.createElement('div'); ch.className='chip'; ch.textContent=e; ch.onclick=()=>{ STATE.profile=STATE.profile||{id:'u_'+uid(),name:displayName()}; STATE.profile.avatarType='emoji'; STATE.profile.avatarData=e; renderAvatar($('avatarPreview'), STATE.profile); saveState(); saveCloudDebounced(); }; $('emojiGrid').appendChild(ch); });
}

/* ===== Menu ===== */
function svgOrder(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18"/><path d="M7 3v4"/><path d="M17 3v4"/><rect x="3" y="7" width="18" height="14" rx="2"/></svg>'}
function svgCity(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21v-8a2 2 0 0 1 2-2h3v10"/><path d="M14 21V10h4v11"/><path d="M7 10V3h7v7"/></svg>'}
function svgFind(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="6"/><path d="M21 21l-4.35-4.35"/></svg>'}
function svgMsg(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'}
function svgWallet(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3v4"/><circle cx="18" cy="13" r="1"/></svg>'}
function menuBtn(id,title,note,svg){ const d=document.createElement('div'); d.id=id; d.className='menu-btn'; d.innerHTML=`<div class="left">${svg||svgOrder()}</div><div style="flex:1"><div class="title">${title}</div><div class="note">${note}</div></div>`; return d; }

function applyMenu(){
  $('topCity').textContent='–ì–æ—Ä–æ–¥: '+STATE.city;
  const grid=$('menuGrid'); grid.innerHTML='';
  if(STATE.role==='user'){ // –°–§–ï–†–ê –£–°–õ–£–ì ‚Äî –±–µ–∑ ¬´–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´¬ª
    grid.appendChild(menuBtn('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É',svgOrder()));
    grid.appendChild(menuBtn('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å',svgCity()));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏',svgOrder()));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏',svgMsg()));
    grid.appendChild(menuBtn('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–ü—É–±–ª–∏–∫—É–π—Ç–µ –∏ –∏—â–∏—Ç–µ',svgOrder()));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏',svgWallet()));
  }else{ // –ü–û–î–†–ê–ë–û–¢–ö–ê
    grid.appendChild(menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π',svgFind()));
    grid.appendChild(menuBtn('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å',svgCity()));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏',svgOrder()));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏',svgMsg()));
    grid.appendChild(menuBtn('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–ü—É–±–ª–∏–∫—É–π—Ç–µ –∏ –∏—â–∏—Ç–µ',svgOrder()));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏',svgWallet()));
  }
  const on=(id,fn)=>{ const el=$(id); if(el) el.onclick=fn; };
  on('btnCity',()=>{ openScreen('cityThreadScreen'); renderCityPosts(); });
  on('btnOrder',()=>{ presetDeadline(); openScreen('createScreen'); });
  on('btnFind',()=>{ openScreen('findScreen'); renderFindList(); });
  on('btnMine',()=>{ openScreen('mineScreen'); renderMineList(); });
  on('btnMessenger',()=>{ openScreen('messengerScreen'); renderChats(); });
  on('btnAds',()=> tg?.showAlert?.('–û–±—ä—è–≤–ª–µ–Ω–∏—è ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º –∞–ø–¥–µ–π—Ç–µ.'));
  on('btnWallet',()=> tg?.showAlert?.('–ö–æ—à–µ–ª—ë–∫ ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º –∞–ø–¥–µ–π—Ç–µ.'));
}

/* ===== Orders ===== */
const CRITERIA={
  '–°–ü–ï–¶. –ó–ê–ö–ê–ó':['–°—Ä–æ—á–Ω–æ','–°–µ–≥–æ–¥–Ω—è','–ó–∞–≤—Ç—Ä–∞','–û–Ω–ª–∞–π–Ω','–ù–∞ –≤—ã–µ–∑–¥–µ'],
  '–¢–∞–∫—Å–∏':['–ì–æ—Ä–æ–¥','–ú–µ–∂–≥–æ—Ä–æ–¥','–î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ','–ë–∞–≥–∞–∂'],
  '–ö—É—Ä—å–µ—Ä':['–°—Ä–æ—á–Ω–æ','–•—Ä—É–ø–∫–æ–µ','–î–æ 5 –∫–≥','–î–æ 20 –∫–≥'],
  '–î–æ—Å—Ç–∞–≤–∫–∞':['–ö—É–ø–∏—Ç—å –∏ –ø—Ä–∏–≤–µ–∑—Ç–∏','–ó–∞–±—Ä–∞—Ç—å –ø–æ—Å—ã–ª–∫—É'],
  '–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)':['–ê—Ä–µ–Ω–¥–∞','–ü—Ä–æ–¥–∞–∂–∞','1-–∫–æ–º–Ω','2-–∫–æ–º–Ω','3+'],
  '–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç':['–ù—è–Ω—è','–ü—Å–∏—Ö–æ–ª–æ–≥','–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫','–≠–ª–µ–∫—Ç—Ä–∏–∫','–†–µ–º–æ–Ω—Ç'],
  '–ü—Ä–æ—á–∏–µ':['–î–æ–≥–æ–≤–æ—Ä–∏–º—Å—è']
};
const EXTRA_FIELDS={
  '–¢–∞–∫—Å–∏':()=>`<div class="chips" id="taxiType"><div class="chip" data-v="–ì–æ—Ä–æ–¥">–ì–æ—Ä–æ–¥</div><div class="chip" data-v="–ú–µ–∂–≥–æ—Ä–æ–¥">–ú–µ–∂–≥–æ—Ä–æ–¥</div></div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
    <input class="input" id="f-from" placeholder="–û—Ç–∫—É–¥–∞">
    <input class="input" id="f-to" placeholder="–ö—É–¥–∞">
  </div>`,
  '–ö—É—Ä—å–µ—Ä':()=>`<div style="display:flex; gap:8px; flex-wrap:wrap">
    <input class="input" id="f-pick" placeholder="–ó–∞–±—Ä–∞—Ç—å (–∞–¥—Ä–µ—Å)">
    <input class="input" id="f-drop" placeholder="–î–æ—Å—Ç–∞–≤–∏—Ç—å (–∞–¥—Ä–µ—Å)">
  </div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
    <input class="input" id="f-weight" placeholder="–í–µ—Å (–∫–≥)">
    <input class="input" id="f-about" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
  </div>`,
  '–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç':()=>`<div style="display:flex; gap:8px; flex-wrap:wrap">
    <input class="input" id="f-who" placeholder="–ö–æ–≥–æ –∏—â–µ–º (–Ω—è–Ω—è, –ø—Å–∏—Ö–æ–ª–æ–≥, —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫‚Ä¶)">
    <input class="input" id="f-details" placeholder="–î–µ—Ç–∞–ª–∏">
  </div>`,
  '–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)':()=>`<div style="display:flex; gap:8px; flex-wrap:wrap">
    <select class="input" id="f-deal"><option>–ê—Ä–µ–Ω–¥–∞</option><option>–ü—Ä–æ–¥–∞–∂–∞</option></select>
    <input class="input" id="f-area" placeholder="–†–∞–π–æ–Ω">
    <input class="input" id="f-rooms" placeholder="–ö–æ–º–Ω–∞—Ç (1,2,3‚Ä¶)">
  </div>`
};
function setCriteria(cat){
  const wrap=$('criteriaWrap'); wrap.innerHTML='';
  (CRITERIA[cat]||[]).forEach(v=>{ const ch=document.createElement('div'); ch.className='chip'; ch.textContent=v; ch.dataset.val=v; ch.onclick=()=>ch.classList.toggle('active'); wrap.appendChild(ch); });
  $('createExtraFields').innerHTML=(EXTRA_FIELDS[cat]?.()||'');
}
document.getElementById('createTabs').addEventListener('click', e=>{
  const t=e.target.closest('.role-tab'); if(!t || t.dataset.disabled) return;
  document.querySelectorAll('#createTabs .role-tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); setCriteria(t.dataset.val||t.textContent);
});
function presetDeadline(){ const d=new Date(Date.now()+30*60*1000); $('c-datetime').value=d.toISOString().slice(0,16); }
$('createForm').addEventListener('submit', e=>{
  e.preventDefault();
  const cat=document.querySelector('#createTabs .role-tab.active')?.dataset.val||'–î—Ä—É–≥–æ–µ';
  const desc=$('c-desc').value.trim(), budget=Number($('c-budget').value||0), datetime=$('c-datetime').value||'';
  if(!desc || !datetime){ tg?.showAlert?.('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è'); return; }
  const crit=[...document.querySelectorAll('#criteriaWrap .chip.active')].map(x=>x.dataset.val);
  let extra='';
  if(cat==='–¢–∞–∫—Å–∏'){ const typeSel=[...document.querySelectorAll('#taxiType .chip.active')].map(x=>x.dataset.v).join('/')||'–ì–æ—Ä–æ–¥'; extra=`\n${typeSel} ‚Ä¢ ${($('f-from')?.value||'')} ‚Üí ${($('f-to')?.value||'')}`; }
  if(cat==='–ö—É—Ä—å–µ—Ä'){ extra=`\n${($('f-pick')?.value||'')} ‚Üí ${($('f-drop')?.value||'')} ‚Ä¢ –í–µ—Å: ${($('f-weight')?.value||'')} ‚Ä¢ ${($('f-about')?.value||'')}`; }
  if(cat==='–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'){ extra=`\n${($('f-who')?.value||'')} ‚Ä¢ ${($('f-details')?.value||'')}`; }
  if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)'){ extra=`\n${($('f-deal')?.value||'')} ‚Ä¢ –†–∞–π–æ–Ω: ${($('f-area')?.value||'')} ‚Ä¢ –ö–æ–º–Ω–∞—Ç: ${($('f-rooms')?.value||'')}`; }
  const me=STATE.profile || { id:'u_'+uid(), name:displayName(), avatarType:'emoji', avatarData:'ü§ñ' };
  const order={ id:'o_'+uid(), category:cat, desc:desc+(extra?('\n'+extra):''), criteria:crit, budget, datetime, city:STATE.city,
                ownerId:me.id, ownerName:me.name||displayName(), status:'open', bids:[], createdAt: nowISO() };
  STATE.orders.unshift(order);
  pushNotif({ id:'n_'+uid(), type:'created', title:'–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω', body:`–í–∞—à –∑–∞–∫–∞–∑ "${cat}" –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω`, ts:nowISO(), payload:{orderId:order.id} });
  saveState(); saveCloudDebounced();
  closeScreen('createScreen'); renderMineList(); openScreen('mineScreen');
});

/* ===== Find orders (worker) ===== */
function renderFindList(){
  const wrap=$('findList'); wrap.innerHTML='';
  const q=($('searchInput').value||'').toLowerCase().trim();
  const cat=$('filterCat').value||'';
  let items=STATE.orders.filter(o=>o.status==='open');
  if(STATE.city) items=items.filter(o=>o.city===STATE.city);
  if(q) items=items.filter(o=>[o.category,o.desc,o.city].join(' ').toLowerCase().includes(q));
  if(cat) items=items.filter(o=>o.category===cat);
  if(!items.length){ wrap.innerHTML='<div class="field-label" style="padding:10px">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const card=document.createElement('div'); card.className='post-card';
    card.innerHTML=`<div style="font-weight:900">${o.category} ‚Ä¢ ${o.city} ‚Ä¢ ‚Ç∏ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>
                    <div class="field-label" style="margin-top:6px">–î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div>
                    <div style="margin-top:6px; white-space:pre-wrap">${o.desc}</div>`;
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='8px';
    const bidBtn=document.createElement('button'); bidBtn.className='btn'; bidBtn.textContent='–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É';
    bidBtn.onclick=()=>{
      const price=prompt('–í–∞—à–∞ —Ü–µ–Ω–∞ (‚Ç∏):','10000'); if(!price) return;
      const comment=prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Å—Ä–æ–∫–∏/–¥–µ—Ç–∞–ª–∏):','–ì–æ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å')||'';
      const me=STATE.profile || {id:'u_'+uid(), name:displayName()};
      const bid={ price:Number(price), name:me.name||'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', performerId:me.id, comment, createdAt: nowISO() };
      const order=STATE.orders.find(x=>x.id===o.id); if(!order) return;
      (order.bids||(order.bids=[])).push(bid);
      pushNotif({ id:'n_'+uid(), type:'bid', title:'–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', body:`–ù–∞ –≤–∞—à –∑–∞–∫–∞–∑ "${order.category}" –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ ${price}‚Ç∏`, ts:nowISO(), payload:{orderId: order.id} });
      saveState(); saveCloudDebounced(); alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    };
    row.appendChild(bidBtn); card.appendChild(row); wrap.appendChild(card);
  });
}
$('applySearch').onclick=()=>renderFindList();

/* ===== My orders ===== */
function renderMineList(){
  const wrap=$('mineList'); wrap.innerHTML='';
  const meId=STATE.profile?.id;
  if(!meId){ wrap.innerHTML='<div class="field-label" style="padding:10px">–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –∏–º—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</div>'; return; }
  const items=STATE.orders.filter(o=>o.ownerId===meId);
  if(!items.length){ wrap.innerHTML='<div class="field-label" style="padding:10px">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const bidsCount=(o.bids||[]).length;
    const statusLabel=o.status==='open'?'–û—Ç–∫—Ä—ã—Ç':o.status==='in_progress'?'–í –ø—Ä–æ—Ü–µ—Å—Å–µ':o.status==='done'?'–ó–∞–≤–µ—Ä—à—ë–Ω':'–û—Ç–º–µ–Ω—ë–Ω';
    const card=document.createElement('div'); card.className='post-card';
    card.innerHTML=`<div style="font-weight:900">${o.category} ‚Ä¢ ${o.city} ${bidsCount?(' ‚Ä¢ <span style="color:#ff9bb0">'+bidsCount+' –∑–∞—è–≤–æ–∫</span>'):''}</div>
                    <div class="field-label" style="margin-top:6px">–°—Ç–∞—Ç—É—Å: ${statusLabel} ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div>
                    <div style="margin-top:6px; white-space:pre-wrap">${o.desc}</div>`;
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='8px';
    if(o.status==='open' && bidsCount){ const viewBtn=document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏'; viewBtn.onclick=()=>showBids(o.id); row.appendChild(viewBtn); }
    card.appendChild(row); wrap.appendChild(card);
  });
}
function showBids(orderId){
  const o=STATE.orders.find(x=>x.id===orderId); if(!o) return;
  const bids=o.bids||[]; if(!bids.length){ alert('–ó–∞—è–≤–æ–∫ –Ω–µ—Ç'); return; }
  const pick=prompt('–ó–∞—è–≤–∫–∏:\n'+bids.map((b,i)=>`${i+1}) ${b.name} ‚Äî ‚Ç∏ ${b.price}\n${b.comment}`).join('\n\n')+'\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è:');
  const idx=(Number(pick)||0)-1; if(idx<0||idx>=bids.length) return;
  const b=bids[idx];
  o.status='in_progress';
  // —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º
  const chat={ id:'chat_'+uid(), title:o.category, orderId:o.id, participants:[o.ownerId,b.performerId],
    meta:{context:`${o.category} ‚Ä¢ ${o.city}`, ownerName:o.ownerName, performerName:b.name},
    messages:[{from:'system',text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω –ø–æ –∑–∞–∫–∞–∑—É',ts:nowISO()}], unread: {[o.ownerId]:0,[b.performerId]:1} };
  STATE.chats.unshift(chat);
  saveState(); saveCloudDebounced();
  alert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ ‚Äî –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç');
  renderMineList(); openChatWindow(chat.id);
}

/* ===== Messenger ===== */
function uniqueContactsFromOrders(){
  const me=STATE.profile?.id;
  const map=new Map();
  STATE.orders.forEach(o=>{
    if(o.ownerId && o.ownerId!==me) map.set(o.ownerId, {id:o.ownerId, name:o.ownerName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'});
    (o.bids||[]).forEach(b=>{ if(b.performerId && b.performerId!==me) map.set(b.performerId, {id:b.performerId, name:b.name||'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'}); });
  });
  return [...map.values()];
}
function renderChats(){
  const wrap=$('chatsList'); wrap.innerHTML='';
  const chats=STATE.chats||[];
  if(!chats.length){
    const box=document.createElement('div'); box.className='chat-list-empty';
    box.innerHTML='<div>–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div><div style="margin-top:8px"><button id="createChatBtn" class="btn primary">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button></div>';
    wrap.appendChild(box);
    box.querySelector('#createChatBtn').onclick=()=>openCreateChatPicker();
    return;
  }
  chats.forEach(c=>{
    const row=document.createElement('div'); row.className='menu-btn'; row.style.cursor='pointer';
    const other=otherMeta(c);
    row.innerHTML=`<div class="avatar" id="av_${c.id}" style="width:28px;height:28px"></div>
                   <div style="flex:1"><div class="title">${escapeHtml(other.name)}</div>
                   <div class="note">${escapeHtml(c.meta?.context||'–ß–∞—Ç')}</div></div>`;
    row.onclick=()=>openChatWindow(c.id);
    wrap.appendChild(row);
    renderAvatar(document.getElementById('av_'+c.id), other);
  });
}
function openCreateChatPicker(){
  const list=uniqueContactsFromOrders();
  if(!list.length){ alert('–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–Ω—É–∂–Ω—ã –∑–∞–∫–∞–∑—ã/–æ—Ç–∫–ª–∏–∫–∏)'); return; }
  const pick=prompt('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:\n'+list.map((u,i)=>`${i+1}) ${u.name}`).join('\n')+'\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:');
  const idx=(Number(pick)||0)-1; if(idx<0||idx>=list.length) return;
  const u=list[idx];
  const me=STATE.profile||{id:'u_'+uid(), name:displayName()};
  const chat={ id:'chat_'+uid(), title:'–ß–∞—Ç', orderId:null, participants:[me.id, u.id],
    meta:{context:'–õ–∏—á–Ω—ã–π —á–∞—Ç', ownerName:me.name, performerName:u.name},
    messages:[{from:'system', text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω', ts:nowISO()}], unread:{[me.id]:0,[u.id]:1} };
  STATE.chats.unshift(chat); saveState(); saveCloudDebounced(); openChatWindow(chat.id);
}
function otherMeta(chat){
  const me=STATE.profile?.id; const otherId=(chat.participants||[]).find(p=>p!==me);
  return { id:otherId, name: (chat.meta?.performerName && chat.meta?.ownerName && (chat.meta.ownerId===me ? chat.meta.performerName : chat.meta.performerName)) || chat.meta?.performerName || chat.meta?.ownerName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' };
}
function openChatWindow(chatId){
  const chat=STATE.chats.find(c=>c.id===chatId); if(!chat){ alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  window.__currentChatId=chatId;
  const other=otherMeta(chat);
  renderAvatar($('chatWinAvatar'), other);
  $('chatWinTitle').textContent=other.name;
  $('chatWinSub').textContent=chat.meta?.context||'–ß–∞—Ç';
  const msgsEl=$('chatWinMsgs'); msgsEl.innerHTML='';
  (chat.messages||[]).forEach(m=>{
    if(m.from==='system'){ const d=document.createElement('div'); d.className='field-label'; d.style.textAlign='center'; d.textContent=m.text; msgsEl.appendChild(d); return; }
    const mine = (m.fromId? m.fromId===STATE.profile?.id : m.from==='me');
    const row=document.createElement('div'); row.className='msg-row'+(mine?' msg-me':' msg-other');
    const bubble=document.createElement('span'); bubble.className='b'; bubble.textContent=m.text||''; row.appendChild(bubble); msgsEl.appendChild(row);
  });
  $('chatWinSend').onclick=sendChatMessage;
  $('chatWinInput').onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChatMessage(); } };
  openScreen('chatWindow');
}
function sendChatMessage(){
  const input=$('chatWinInput'); const v=input.value.trim(); if(!v || !window.__currentChatId) return;
  const me=STATE.profile||{id:'u_'+uid(), name:'–í—ã'};
  const meId=me.id;
  const idx=STATE.chats.findIndex(c=>c.id===window.__currentChatId); if(idx<0) return;
  const chat=STATE.chats[idx];
  chat.messages.push({fromId:meId, text:v, ts: nowISO()});
  const other=(chat.participants||[]).find(p=>p!==meId); if(other){ chat.unread||(chat.unread={}); chat.unread[other]=(chat.unread[other]||0)+1; }
  STATE.chats[idx]=chat; saveState(); saveCloudDebounced(); $('chatWinInput').value=''; openChatWindow(chat.id);
}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

/* ===== City feed ===== */
function ensureFeed(){ if(!STATE.feed[STATE.city]) STATE.feed[STATE.city]=[]; return STATE.feed[STATE.city]; }
function renderCityPosts(){
  const wrap=$('cityPosts'); wrap.innerHTML='';
  const list=ensureFeed();
  if(!list.length){ wrap.innerHTML='<div class="field-label" style="padding:10px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
  list.forEach(p=>{
    const card=document.createElement('div'); card.className='post-card';
    const head=document.createElement('div'); head.style.display='flex'; head.style.gap='8px'; head.style.alignItems='center';
    const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, {avatarType:p.authorAvatarType, avatarData:p.authorAvatarData, name:p.authorName}); head.appendChild(av);
    const nm=document.createElement('div'); nm.style.fontWeight='900'; nm.textContent=p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; head.appendChild(nm);
    const tm=document.createElement('div'); tm.className='field-label'; tm.style.marginLeft='auto'; tm.textContent=new Date(p.ts).toLocaleString('ru-RU'); head.appendChild(tm);
    card.appendChild(head);

    const text=document.createElement('div'); text.style.marginTop='8px'; text.style.whiteSpace='pre-wrap'; text.textContent=p.text||''; card.appendChild(text);
    if(p.image){ const img=document.createElement('img'); img.src=p.image; img.className='post-img'; card.appendChild(img); }

    const actions=document.createElement('div'); actions.className='post-actions';
    const likeBtn=document.createElement('button'); likeBtn.className='btn'; likeBtn.innerHTML=`‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è (<span>${Object.keys(p.likes?.byUser||{}).length}</span>)`;
    likeBtn.onclick=()=>{ const me=STATE.profile?.id || 'u_demo'; p.likes||(p.likes={byUser:{}}); if(p.likes.byUser[me]) delete p.likes.byUser[me]; else p.likes.byUser[me]=true; likeBtn.querySelector('span').textContent=String(Object.keys(p.likes.byUser).length); saveState(); saveCloudDebounced(); };
    const cmtBtn=document.createElement('button'); cmtBtn.className='btn'; cmtBtn.textContent='üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å';
    actions.appendChild(likeBtn); actions.appendChild(cmtBtn); card.appendChild(actions);

    const cWrap=document.createElement('div'); cWrap.style.marginTop='8px'; cWrap.style.display='none';
    const cRow=document.createElement('div'); cRow.style.display='flex'; cRow.style.gap='8px'; cRow.style.alignItems='center';
    const cInput=document.createElement('input'); cInput.className='input'; cInput.placeholder='–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';
    const cSend=document.createElement('button'); cSend.className='btn primary'; cSend.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    cRow.appendChild(cInput); cRow.appendChild(cSend); cWrap.appendChild(cRow);
    const cList=document.createElement('div'); cWrap.appendChild(cList);
    card.appendChild(cWrap);

    cmtBtn.onclick=()=>{ cWrap.style.display=cWrap.style.display==='none'?'block':'none'; };
    cSend.onclick=()=>{ const txt=cInput.value.trim(); if(!txt) return;
      const me=STATE.profile||{name:displayName(), avatarType:'emoji', avatarData:'ü§ñ'};
      const c={ id:'c_'+uid(), authorName: me.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', authorAvatarType:me.avatarType, authorAvatarData:me.avatarData, text:txt, ts: nowISO() };
      (p.comments||(p.comments=[])).push(c);
      const row=document.createElement('div'); row.className='comment';
      row.innerHTML=`<div style="display:flex; gap:6px; align-items:center;"><div class="avatar" id="cav_${c.id}" style="width:20px;height:20px"></div><div style="font-weight:800">${c.authorName}</div><div class="field-label" style="margin-left:auto">${new Date(c.ts).toLocaleString('ru-RU')}</div></div><div style="margin-top:6px; white-space:pre-wrap">${c.text}</div>`;
      cList.appendChild(row);
      setTimeout(()=>{ const el=document.getElementById('cav_'+c.id); if(el) renderAvatar(el, {avatarType:c.authorAvatarType, avatarData:c.authorAvatarData, name:c.authorName}); },0);
      cInput.value=''; saveState(); saveCloudDebounced();
    };

    (p.comments||[]).forEach(c=>{
      const row=document.createElement('div'); row.className='comment';
      row.innerHTML=`<div style="display:flex; gap:6px; align-items:center;"><div class="avatar" id="cav_${c.id}" style="width:20px;height:20px"></div><div style="font-weight:800">${c.authorName||''}</div><div class="field-label" style="margin-left:auto">${new Date(c.ts).toLocaleString('ru-RU')}</div></div><div style="margin-top:6px; white-space:pre-wrap">${c.text||''}</div>`;
      cList.appendChild(row);
      setTimeout(()=>{ const el=document.getElementById('cav_'+c.id); if(el) renderAvatar(el, {avatarType:c.authorAvatarType, avatarData:c.authorAvatarData, name:c.authorName}); },0);
    });

    wrap.appendChild(card);
  });
}

/* Composer photo + shrink on scroll */
let __cityImg=null;
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id==='cityPostImage'){
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ __cityImg=r.result; tg?.showPopup?.({title:'–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ', message:'–ö –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', buttons:[{type:'ok'}]}); }; r.readAsDataURL(f);
  }
});
document.getElementById('cityPostSend').addEventListener('click',()=>{
  const text=$('cityPostText').value.trim(); if(!text && !__cityImg){ tg?.showAlert?.('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ'); return; }
  const me=STATE.profile || { id:'u_'+uid(), name: displayName(), avatarType:'emoji', avatarData:'ü§ñ' };
  const post={ id:'post_'+uid(), authorName: me.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', authorAvatarType:me.avatarType, authorAvatarData:me.avatarData, text, image: __cityImg||null, ts: nowISO(), likes:{byUser:{}}, comments:[] };
  const list=ensureFeed(); list.unshift(post);
  $('cityPostText').value=''; __cityImg=null; saveState(); saveCloudDebounced(); renderCityPosts();
});
const cityScroll=$('cityScroll'); const cityComposer=$('cityComposer');
if(cityScroll && cityComposer){
  cityScroll.addEventListener('scroll', ()=>{
    if(cityScroll.scrollTop>40) cityComposer.classList.add('compact'); else cityComposer.classList.remove('compact');
  });
}

/* ===== Settings actions ===== */
$('openSettings').onclick=()=>{ fillSettings(); openScreen('settingsModal'); };
$('saveCityBtn').onclick=()=>{ STATE.city=$('citySelect').value; saveState(); saveCloudDebounced(); applyMenu(); closeScreen('settingsModal'); };
$('syncNowBtn').onclick=()=>{ loadCloud(); };
$('themeSelect').addEventListener('change', e=>{ STATE.theme=e.target.value; applyTheme(); saveState(); saveCloudDebounced(); });
$('pickEmojiBtn').onclick=()=>{ const box=$('emojiPicker'); box.style.display= box.style.display==='none' ? 'block' : 'none'; };
$('profilePhoto').onchange=(ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ STATE.profile=STATE.profile||{id:'u_'+uid(), name:displayName()}; STATE.profile.avatarType='image'; STATE.profile.avatarData=r.result; renderAvatar($('avatarPreview'), STATE.profile); saveState(); saveCloudDebounced(); }; r.readAsDataURL(f); };
$('saveProfileBtn').onclick=()=>{ const nm=$('profileName').value.trim(); STATE.profile=STATE.profile||{id:'u_'+uid(), name:''}; if(nm) STATE.profile.name=nm; if(!STATE.profile.avatarType){ STATE.profile.avatarType='emoji'; STATE.profile.avatarData='ü§ñ'; } saveState(); saveCloudDebounced(); applyMenu(); closeScreen('settingsModal'); };

/* ===== Notifications button ===== */
$('notifBtn').onclick=()=>{ if(!STATE.notifs.length){ tg?.showAlert?.('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç'); return; } const first=STATE.notifs[0]; tg?.showPopup?.({title:first.title, message:first.body, buttons:[{type:'ok'}]}); };

/* ===== Persistence ===== */
async function saveState(){ await AppStorage.set(KEYS.CITY, STATE.city); await AppStorage.set(KEYS.ROLE, STATE.role); await AppStorage.set(KEYS.THEME, STATE.theme); await AppStorage.set(KEYS.PROFILE, STATE.profile); await AppStorage.set(KEYS.ORDERS, STATE.orders); await AppStorage.set(KEYS.NOTIFS, STATE.notifs); await AppStorage.set(KEYS.FEED, STATE.feed); await AppStorage.set(KEYS.CHATS, STATE.chats); }
async function loadState(){
  STATE.city   = await AppStorage.get(KEYS.CITY, STATE.city);
  STATE.role   = await AppStorage.get(KEYS.ROLE, STATE.role);
  STATE.theme  = await AppStorage.get(KEYS.THEME, STATE.theme);
  STATE.profile= await AppStorage.get(KEYS.PROFILE, STATE.profile);
  STATE.orders = await AppStorage.get(KEYS.ORDERS, STATE.orders);
  STATE.notifs = await AppStorage.get(KEYS.NOTIFS, STATE.notifs);
  STATE.feed   = await AppStorage.get(KEYS.FEED, STATE.feed);
  STATE.chats  = await AppStorage.get(KEYS.CHATS, STATE.chats);
}

/* ===== Welcome animation ===== */
function showWelcome(){ $('welcomeOverlay').classList.add('active'); }
$('welcomeOk').onclick=()=>{ $('welcomeOverlay').classList.remove('active'); }

/* ===== Init ===== */
async function init(){
  await loadState();
  if(!STATE.profile){
    const tgUser=tg?.initDataUnsafe?.user;
    STATE.profile={ id: tgUser?.id ? 'tg_'+tgUser.id : 'u_'+uid(), name: tgUser?.first_name || '', avatarType:'', avatarData:'' };
  }
  applyTheme(); setRoleTabs(); applyMenu(); refreshNotif();
  // Welcome overlay (–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —Å–µ—Å—Å–∏—é)
  if(!sessionStorage.getItem('gid_welcome_shown')){ showWelcome(); sessionStorage.setItem('gid_welcome_shown','1'); }
  // JSONBin: —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ + –ø–æ–ª–ª–∏–Ω–≥
  if(CLOUD.ENABLED){ await loadCloud(); setInterval(loadCloud, CLOUD.POLL_MS); }
}
init();
</script>
</body>
</html>
