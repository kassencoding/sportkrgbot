<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiD City ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22;
  --surface:rgba(20,24,40,.92);
  --line:rgba(160,170,230,.12);
  --accent:#a970ff;
  --accent2:#32ffd2;
  --gold:#ffd84d;
  --text:#ffffff;
  --muted:#9aa6d9;
  --radius:14px;
  --shadow:0 16px 46px rgba(0,0,0,.45);
  --ui-font:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font:14px var(--ui-font);
  color:var(--text);
  background: radial-gradient(900px at 20% -10%, rgba(30,27,58,.35) 0%, transparent 70%),
              linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Wrapper */
.wrapper{ max-width:1000px; margin:18px auto; padding:0 14px; display:flex; flex-direction:column; gap:12px; }

/* Glass base (keeps original elements intact) */
.container, .modal, .menu-btn, .post-card { 
  backdrop-filter: blur(6px);
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.12));
  border:1px solid var(--line);
  border-radius:12px;
}

/* Header */
.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand{ display:flex; gap:12px; align-items:center; }
.brand h1{ margin:0; font-size:20px; font-weight:900; color:var(--text); }
.current-city { font-size:13px; color:var(--muted); padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.02); margin-left:8px; }

/* Role tabs (flat icons, minimal) */
.role-tabs{ display:flex; gap:8px; margin-top:6px; }
.role-tab{ padding:10px 18px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); font-weight:900; cursor:pointer; user-select:none; min-width:260px; text-align:center; display:flex; align-items:center; gap:8px; justify-content:center; }
.role-tab .icon{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; }
.role-tab.active{ background:var(--gold); color:#081018; border-color:rgba(0,0,0,.08); }

/* Panel top */
.panel-top{ display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid rgba(255,255,255,.02) }
.panel-top h2{ margin:0; font-weight:900; font-size:18px; display:flex; gap:10px; align-items:center; }
/* time/date/weather moved below panel title */
.panel-meta{ margin-top:8px; display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; }

/* notification (flat) */
#panelNotif{ background:transparent; color:var(--accent); border-radius:8px; padding:6px 8px; border:none; cursor:pointer; display:inline-flex; align-items:center; gap:6px; font-weight:900; }
#panelNotif .badge{ background:#ff4f6a; color:#fff; padding:2px 6px; border-radius:999px; font-weight:900; font-size:11px; display:none; }

/* Menu grid */
.menu-grid{ display:grid; gap:10px; padding:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); align-items:stretch; }
.menu-btn{ display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; border:1px solid var(--line); cursor:pointer; justify-content:space-between; }
.menu-btn .title{ font-weight:900; }
.menu-btn .meta{ color:var(--muted); font-size:12px; }
/* flat icons: monochrome, no shadows */
.menu-btn .icon{ width:36px; height:36px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:transparent; font-weight:800; }
.menu-btn.dark{ background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.10)); color:var(--muted); border-color:rgba(255,255,255,.02); }

/* screen/modal */
.screen{ position:fixed; inset:0; display:none; z-index:90; align-items:flex-start; justify-content:center; padding:18px; background:rgba(0,0,0,.45); backdrop-filter:blur(6px); }
.screen.active{ display:flex; }
.modal{ width:100%; max-width:980px; max-height:88vh; overflow:auto; background:var(--surface); color:var(--text); border-radius:12px; border:1px solid var(--line); padding:14px; box-shadow:var(--shadow) }

/* inputs */
.input, textarea, select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(12,16,36,.75); color:var(--text); outline:none; font-size:14px; }
textarea{ min-height:120px; resize:vertical }
.btn{ padding:8px 12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); color:var(--text); font-weight:800; cursor:pointer; }
.btn.primary{ background: linear-gradient(90deg,var(--accent),var(--accent2)); color:#061018; border:none; }

/* glass actions (large buttons) */
.glass-actions{ display:flex; gap:12px; width:100%; }
.glass-btn{ flex:1; padding:12px 16px; border-radius:14px; font-weight:900; font-size:15px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.08)); border:1px solid var(--line); backdrop-filter: blur(6px); cursor:pointer; position:relative; overflow:hidden; }

/* file icon button (flat glass) */
.file-icon-btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); cursor:pointer; }

/* post card */
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.04); border-radius:12px; padding:12px; margin-bottom:10px; }
.post-top{ display:flex; gap:10px; align-items:center; }
.post-top .avatar{ width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:transparent; font-weight:800; }
.post-actions{ display:flex; gap:10px; margin-top:8px; align-items:center; justify-content:flex-end; }
.post-actions .act{ background:transparent; border:none; color:var(--muted); cursor:pointer; font-weight:800; padding:6px 8px; border-radius:8px; }

/* messenger */
.chat-screen{ display:flex; gap:12px; }
.chats-list{ flex:1; }
.chat-window{ width:420px; border-left:1px solid rgba(255,255,255,.02); padding-left:12px; display:flex; flex-direction:column; gap:8px; }
.chat-top{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); }
.msgs{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:6px; }
.msg{ padding:10px 12px; border-radius:12px; max-width:78%; word-break:break-word; box-shadow:0 8px 20px rgba(0,0,0,.35); }
.msg.me{ align-self:flex-end; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#081018; font-weight:900; }
.msg.other{ align-self:flex-start; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.06)); color:var(--text); border:1px solid var(--line); }

/* small */
.small{ font-size:12px; color:var(--muted) }
.footer-note{ text-align:center; font-size:11px; color:var(--muted); margin-top:6px }

/* scrollbars (neon minimal) but subtle */
::-webkit-scrollbar{ width:10px; height:10px }
::-webkit-scrollbar-track{ background:transparent }
::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(169,112,255,.14), rgba(50,255,210,.08)); border-radius:999px; border:2px solid rgba(0,0,0,.12) }

/* create order criteria scroll & tabs scroll */
#createExtraFields{ max-height:220px; overflow:auto; padding-right:6px; }
#createTabs{ max-height:160px; overflow:auto; padding-right:6px; display:flex; gap:8px; }

/* settings theme list and city select scrollers */
.theme-list{ max-height:220px; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:8px; }
#citySelect{ max-height:220px; }

/* role tabs width adjusted to match card size (not longer) */
.role-tab{ min-width:260px; }

/* booking darker with '–°–∫–æ—Ä–æ' description and right-aligned meta */
.menu-btn .meta{ text-align:right; width:120px; }
.menu-btn.dark .meta{ color:rgba(160,170,230,.38); }

/* action buttons in lists aligned right (already set via post-actions justify-content:flex-end) */

@media (max-width:900px){ .menu-grid{ grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); } .chat-window{ width:320px; display:none; } }
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiDCity</h1>
      <div class="current-city" id="currentCity">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="openSettings" class="menu-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="roleTabs" class="role-tabs"></div>

  <main class="container" role="main" aria-live="polite">
    <div class="panel-top">
      <div>
        <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
        <!-- time/date/weather —Ç–µ–ø–µ—Ä—å —Å–Ω–∏–∑—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
        <div class="panel-meta" id="panelMeta">
          <div id="time">‚Äî</div>
          <div id="date">‚Äî</div>
          <div id="weather">‚õÖ ‚Äî</div>
        </div>
      </div>
      <div id="panelControls"></div>
    </div>

    <div id="menuGrid" class="menu-grid"></div>
  </main>

  <div class="footer-note">KASSEN Technology Inc</div>
</div>

<!-- notifications modal -->
<section id="notificationsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
    <button onclick="closeScreen('notificationsModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="notificationsList" style="margin-top:12px; max-height:66vh; overflow:auto;"></div>
</div></section>

<!-- settings modal -->
<section id="settingsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <button onclick="closeScreen('settingsModal')" class="btn">–ù–∞–∑–∞–¥</button>
  </div>
  <div style="margin-top:12px; display:flex; gap:12px; flex-direction:column;">

    <div style="font-weight:900">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="profileName" class="input" placeholder="–ò–º—è" style="max-width:240px">
      <input id="profileAvatar" class="input" placeholder="–ê–≤–∞—Ç–∞—Ä (emoji)" style="width:120px">
      <button id="saveProfileBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div style="margin-top:12px; font-weight:900">–ì–æ—Ä–æ–¥</div>
    <select id="citySelect" class="input" style="max-width:320px"></select>

    <div style="margin-top:12px; font-weight:900">–¢–µ–º–∞</div>
    <div class="theme-list" id="themeList"></div>

    <div style="margin-top:12px; font-weight:900">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (JSONBin)</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <label class="small">–ê–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</label>
      <input id="syncToggle" type="checkbox">
      <button id="syncNowBtn" class="btn">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
    </div>
  </div>
</div></section>

<!-- create order modal -->
<section id="createScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</h3>
    <button onclick="closeScreen('createScreen')" class="btn">–ù–∞–∑–∞–¥</button>
  </div>
  <div style="margin-top:12px;">
    <div id="createTabs" class="create-tabs" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px"></div>
    <form id="createForm">
      <textarea id="c-desc" class="input" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É (—á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –∞–¥—Ä–µ—Å, —É—Å–ª–æ–≤–∏—è)"></textarea>
      <div id="createExtraFields" style="margin-top:8px;"></div>

      <div style="display:flex; gap:8px; margin-top:8px; align-items:flex-end; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px">
          <label class="small">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
          <input id="c-datetime" class="input" type="datetime-local">
        </div>
        <div style="flex:1; min-width:220px">
          <label class="small">–ë—é–¥–∂–µ—Ç (‚Ç∏)</label>
          <input id="c-budget" class="input" type="number" required>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
        <div style="width:100%;">
          <div class="glass-actions">
            <button id="submitOrderBtn" class="glass-btn" type="button">–ó–∞–∫–∞–∑–∞—Ç—å</button>
            <button id="cancelOrderBtn" class="glass-btn" type="button">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div></section>

<!-- find orders -->
<section id="findScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã</h3>
    <button onclick="closeScreen('findScreen')" class="btn">–ù–∞–∑–∞–¥</button>
  </div>
  <div style="margin-top:12px;">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫...">
      <select id="filterCat" class="input" style="max-width:240px"></select>
      <button id="applySearch" class="btn">–§–∏–ª—å—Ç—Ä</button>
    </div>
    <div id="findList" style="margin-top:12px; max-height:64vh; overflow:auto;"></div>
  </div>
</div></section>

<!-- offer modal -->
<section id="offerModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É</h3>
    <button onclick="closeScreen('offerModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <form id="offerForm" style="margin-top:12px;">
    <div><label class="small">–¶–µ–Ω–∞ (‚Ç∏)</label><input id="offerPrice" class="input" type="number" required></div>
    <div style="margin-top:8px;"><label class="small">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><textarea id="offerComment" class="input"></textarea></div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
      <button class="btn primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn" type="button" onclick="closeScreen('offerModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </form>
</div></section>

<!-- bids modal -->
<section id="bidsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 id="bidsTitle" style="margin:0">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
    <button onclick="closeScreen('bidsModal')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="bidsList" style="margin-top:12px; max-height:66vh; overflow:auto;"></div>
</div></section>

<!-- city thread -->
<section id="cityThreadScreen" class="screen"><div class="modal" style="width:100%; max-width:980px; height:88vh; overflow:hidden;">
  <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px;">
    <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
    <button onclick="closeScreen('cityThreadScreen')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div class="city-thread-wrap" style="height:calc(100% - 48px); display:flex; flex-direction:column;">
    <div class="city-composer-top">
      <div class="avatar" id="topComposerAvatar">–Ø</div>
      <div class="placeholder" id="topComposerPlaceholder">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è...</div>
      <div style="margin-left:auto"></div>
    </div>
    <div id="cityScroll" style="overflow:auto; padding:12px; flex:1;">
      <div id="cityPosts"></div>
    </div>
  </div>
</div></section>

<!-- quick post -->
<section id="quickPostModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ª–µ–Ω—Ç–µ</h3>
    <button onclick="closeScreen('quickPostModal')" class="btn">–û—Ç–º–µ–Ω–∞</button>
  </div>
  <div style="margin-top:12px;">
    <textarea id="quickPostText" class="input" placeholder="–û —á—ë–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å?"></textarea>
    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
      <input id="quickPostImage" type="file" accept="image/*" style="display:none">
      <button id="quickPostFileBtn" class="file-icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üìé</button>
      <div id="quickPostPreview" style="margin-top:8px; flex:1;"></div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="quickPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div></section>

<!-- messenger -->
<section id="messengerScreen" class="screen"><div class="modal" style="width:100%; max-width:980px; height:88vh; overflow:hidden;">
  <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px;">
    <h3 style="margin:0">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3>
    <div>
      <button id="createChatBtn" class="btn" style="background:transparent; color:var(--accent); font-weight:900; border-radius:10px;">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
      <button onclick="closeScreen('messengerScreen')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <div style="display:flex; height:calc(100% - 48px); gap:12px;">
    <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
      <div style="font-weight:900">–î–∏–∞–ª–æ–≥–∏</div>
      <div id="chatsList" style="overflow:auto; flex:1; padding-right:6px;"></div>
    </div>
    <div id="chatPane" style="width:420px; border-left:1px solid rgba(255,255,255,.02); padding-left:12px; display:flex; flex-direction:column;">
      <div id="chatWindowHeader" class="chat-top" style="display:none;">
        <div class="avatar" id="chatHeaderAvatar">–ë</div>
        <div>
          <div id="chatHeaderName" style="font-weight:900">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
          <div class="small" id="chatHeaderSub">–ò–Ω—Ñ–æ</div>
        </div>
      </div>
      <div id="chatWindow" style="display:none; flex:1; flex-direction:column;">
        <div id="chatMsgs" class="msgs"></div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input id="chatInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
          <button id="chatSend" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
      <div id="chatEmpty" style="display:flex; align-items:center; justify-content:center; flex:1; color:var(--muted);">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</div>
    </div>
  </div>
</div></section>

<!-- create chat picker -->
<section id="createChatScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç / –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
    <button onclick="closeScreen('createChatScreen')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="chatPicker" style="margin-top:12px; max-height:72vh; overflow:auto;"></div>
</div></section>

<script>
/* ======= Constants & state ======= */
const JSONBIN = { ENABLED: true, BIN_ID: '6911fbe843b1c97be9a4dc97', KEY: '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG', URL: id => `https://api.jsonbin.io/v3/b/${id}` };
const LS_KEY = 'gid_state_v11';
const $ = id => document.getElementById(id);
const uid = ()=> Math.random().toString(36).slice(2,9);
const nowISO = ()=> new Date().toISOString();

let STATE = {
  profile: { id:'u_me', name:'–í—ã', avatarType:'emoji', avatarData:'ü§ñ' },
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  role: 'user',
  theme: 'violet',
  orders: [],
  feed: {},
  chats: [],
  notifs: [],
  syncEnabled: true
};

/* load local */
function loadState(){ try{ const s = localStorage.getItem(LS_KEY); if(s) Object.assign(STATE, JSON.parse(s)); }catch(e){ console.warn(e); } }
function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(STATE)); }catch(e){ console.warn(e); } }
loadState();

/* city coords for weather */
const CITY_COORDS = {
  '–ê–ª–º–∞—Ç—ã': {lat:43.2383, lon:76.9450}, '–ê—Å—Ç–∞–Ω–∞': {lat:51.1605, lon:71.4704}, '–ù—É—Ä-–°—É–ª—Ç–∞–Ω':{lat:51.1605,lon:71.4704},
  '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞': {lat:49.8064, lon:73.0851}, '–®—ã–º–∫–µ–Ω—Ç': {lat:42.3417, lon:69.5901}, '–ê–∫—Ç–æ–±–µ': {lat:50.2839, lon:57.1669},
  '–ü–∞–≤–ª–æ–¥–∞—Ä':{lat:52.2860,lon:76.9759}, '–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫':{lat:49.9721,lon:82.6275}, '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫':{lat:53.2789,lon:69.3841},
  '–¢–∞—Ä–∞–∑':{lat:42.8975,lon:71.3661}, '–ö–æ—Å—Ç–∞–Ω–∞–π':{lat:53.2194,lon:63.6243}, '–°–µ–º–µ–π':{lat:50.4114,lon:80.2341},
  '–ö—ã–∑—ã–ª–æ—Ä–¥–∞':{lat:44.8518,lon:65.4826}, '–ê—Ç—ã—Ä–∞—É':{lat:47.0951,lon:51.9236}, '–ê–∫—Ç–∞—É':{lat:43.6500,lon:51.2000},
  '–¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω':{lat:45.0000,lon:78.3756}, '–¢–µ–º–∏—Ä—Ç–∞—É':{lat:50.0706,lon:72.9583}, '–ñ–µ–∑–∫–∞–∑–≥–∞–Ω':{lat:47.7772,lon:67.7063},
  '–≠–∫–∏–±–∞—Å—Ç—É–∑':{lat:51.7167,lon:75.3167}, '–ö–æ–∫—à–µ—Ç–∞—É':{lat:53.2833,lon:69.4000}, '–®–∞—Ö—Ç–∏–Ω—Å–∫':{lat:49.7847,lon:73.7722}
};

/* ===== header: date/time & weather (moved to panel) ===== */
async function updateDateTimeWeather(){
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
  $('time').textContent = hh;
  const dateStr = now.toLocaleDateString('ru-RU', { day:'numeric', month:'long', year:'numeric' });
  $('date').textContent = dateStr;
  $('currentCity').textContent = STATE.city || '‚Äî';
  try{
    const coords = CITY_COORDS[STATE.city] || CITY_COORDS['–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'];
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=auto`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fetch failed');
    const j = await r.json();
    if(j.current_weather){ const t = Math.round(j.current_weather.temperature); const icon = weatherIcon(j.current_weather.weathercode); $('weather').textContent = `${icon} ${t}¬∞C`; }
  }catch(e){ console.warn('weather error',e); $('weather').textContent = '‚õÖ ‚Äî'; }
}
function weatherIcon(code){ if(code>=0 && code<=3) return '‚òÄÔ∏è'; if(code>=45 && code<=48) return 'üå´Ô∏è'; if((code>=51 && code<=67) || (code>=80 && code<=82)) return 'üåßÔ∏è'; if(code>=71 && code<=77) return '‚ùÑÔ∏è'; if(code>=95) return '‚õàÔ∏è'; return '‚õÖ'; }
updateDateTimeWeather(); setInterval(updateDateTimeWeather, 60*1000);

/* ===== role tabs & menu ===== */
const ROLES = [{k:'user', label:'–°–§–ï–†–ê –£–°–õ–£–ì', icon:'üíº'}, {k:'worker', label:'–ü–û–î–†–ê–ë–û–¢–ö–ê', icon:'üîß'}];
function renderRoleTabs(){ const container = $('roleTabs'); container.innerHTML=''; ROLES.forEach(r=>{ const d = document.createElement('div'); d.className='role-tab'; d.innerHTML = `<span class="icon">${r.icon}</span><span>${r.label}</span>`; d.dataset.role=r.k; if(STATE.role===r.k) d.classList.add('active'); d.onclick = ()=>{ STATE.role=r.k; saveState(); renderRoleTabs(); renderMenu(); }; container.appendChild(d); }); }
renderRoleTabs();

function menuBtn(id,title,note,extra='', icon='‚≠ê'){ const el=document.createElement('div'); el.className='menu-btn '+extra; el.id=id; el.innerHTML = `<div style="display:flex;align-items:center;gap:12px;flex:1"><div class="icon">${icon}</div><div style="display:flex;flex-direction:column;flex:1;align-items:flex-start"><div class="title">${title}</div></div></div><div style="margin-left:12px" class="meta">${note||''}</div>`; return el; }

function renderMenu(){ const grid = $('menuGrid'); grid.innerHTML=''; if(STATE.role==='user'){ const orderBtn = menuBtn('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É','', '‚úö'); orderBtn.style.flexBasis='50%'; const bookBtn = menuBtn('btnBook','–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å','–°–∫–æ—Ä–æ','dark','üìÖ'); bookBtn.style.flexBasis='50%'; grid.appendChild(orderBtn); grid.appendChild(bookBtn); grid.appendChild(menuBtn('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å','','üí¨')); grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏','','üìÇ')); grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏','','‚úâÔ∏è')); grid.appendChild(menuBtn('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π','','üì¢')); grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏','','üí≥')); } else { const findBtn = menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π','','üîé'); findBtn.style.flexBasis='50%'; const cityBtn = menuBtn('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å','','üí¨'); cityBtn.style.flexBasis='50%'; grid.appendChild(findBtn); grid.appendChild(cityBtn); grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏','','üìÇ')); grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏','','‚úâÔ∏è')); grid.appendChild(menuBtn('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π','','üì¢')); grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏','','üí≥')); }

grid.querySelectorAll('.menu-btn').forEach(el=>{ el.onclick = ()=>{ const id = el.id; if(id==='btnOrder'){ initCreate(); openScreen('createScreen'); } if(id==='btnBook'){ alert('–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Å–∫–æ—Ä–æ'); } if(id==='btnCity'){ renderCity(); openScreen('cityThreadScreen'); } if(id==='btnMine'){ renderMine(); openScreen('bidsModal'); } if(id==='btnMessenger'){ renderChats(); openScreen('messengerScreen'); } if(id==='btnFind'){ renderFind(); openScreen('findScreen'); } if(id==='btnAds'){ alert('–û–±—ä—è–≤–ª–µ–Ω–∏—è ‚Äî –¥–µ–º–æ'); } if(id==='btnWallet'){ alert('–ö–æ—à–µ–ª—ë–∫ ‚Äî –¥–µ–º–æ'); } }; }); }
renderMenu();

/* panel notification */
function ensurePanelNotif(){ const parent = $('panelControls'); parent.innerHTML = `<button id="panelNotif" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">üîî <span class="badge" id="panelNotifBadge">0</span></button>`; $('panelNotif').addEventListener('click', ()=>{ renderNotifications(); openScreen('notificationsModal'); }); }
ensurePanelNotif();

/* ===== notifications ===== */
function refreshNotifBadge(){ const n = STATE.notifs.length; const b = $('panelNotifBadge'); if(n>0){ b.style.display='inline-block'; b.textContent = n>99?'99+':String(n);} else b.style.display='none'; }
function renderNotifications(){ const wrap = $('notificationsList'); wrap.innerHTML=''; if(!STATE.notifs.length){ wrap.innerHTML='<div class="small">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div>'; return; } STATE.notifs.forEach((n,idx)=>{ const el=document.createElement('div'); el.className='post-card'; el.innerHTML=`<div style="font-weight:900">${esc(n.title)}</div><div class="small" style="margin-top:6px">${new Date(n.ts).toLocaleString()}</div><div style="margin-top:8px">${esc(n.body||'')}</div>`; el.onclick=()=>{ alert(`${n.title}

${n.body||''}`); }; wrap.appendChild(el); }); }
refreshNotifBadge();

/* ===== create order ===== */
const CATS = ['–°–ü–ï–¶. –ó–ê–ö–ê–ó','–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–î–æ—Å—Ç–∞–≤–∫–∞','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º','–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç','–ü—Ä–æ—á–∏–µ'];
function initCreate(){ const wrap = $('createTabs'); wrap.innerHTML=''; CATS.forEach((c,i)=>{ const d=document.createElement('div'); d.className='role-tab'; d.textContent=c; d.dataset.cat=c; if(i===0) d.classList.add('active'); d.onclick=(()=>{ document.querySelectorAll('#createTabs .role-tab').forEach(x=>x.classList.remove('active')); d.classList.add('active'); renderCreateExtra(c); }); wrap.appendChild(d); }); renderCreateExtra(CATS[0]); }
function renderCreateExtra(cat){ const extra = $('createExtraFields'); extra.innerHTML=''; if(cat==='–¢–∞–∫—Å–∏') extra.innerHTML = '<div style="display:flex;gap:8px"><input id="f-from" class="input" placeholder="–û—Ç–∫—É–¥–∞"><input id="f-to" class="input" placeholder="–ö—É–¥–∞"></div>'; else if(cat==='–ö—É—Ä—å–µ—Ä') extra.innerHTML = '<div style="display:flex;gap:8px"><input id="f-pick" class="input" placeholder="–ó–∞–±—Ä–∞—Ç—å (–∞–¥—Ä–µ—Å)"><input id="f-drop" class="input" placeholder="–î–æ—Å—Ç–∞–≤–∏—Ç—å (–∞–¥—Ä–µ—Å)"></div>'; else if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º') extra.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><input class="input" id="f-area" placeholder="–†–∞–π–æ–Ω"><input class="input" id="f-rooms" placeholder="–ö–æ–º–Ω–∞—Ç (1,2...)"></div><div style="display:flex;gap:8px;margin-top:8px"><input class="input" id="f-square" placeholder="–ü–ª–æ—â–∞–¥—å (–º¬≤)"><input class="input" id="f-period" placeholder="–ü–µ—Ä–∏–æ–¥/–¥–∞—Ç—ã"></div>'; else if(cat==='–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç') extra.innerHTML = '<div style="display:flex;gap:8px"><input id="f-person" class="input" placeholder="–ö–æ–≥–æ –∏—â–µ–º (–Ω—è–Ω—è, –ø—Å–∏—Ö–æ–ª–æ–≥...)"><input id="f-details" class="input" placeholder="–ö—Ä–∞—Ç–∫–∏–µ –¥–µ—Ç–∞–ª–∏"></div>'; }

$('submitOrderBtn').addEventListener('click', ()=>{ const cat = document.querySelector('#createTabs .role-tab.active')?.dataset.cat || '–°–ü–ï–¶. –ó–ê–ö–ê–ó'; const desc = $('c-desc').value.trim(); const dt = $('c-datetime').value; const budget = Number($('c-budget').value||0); if(!desc || !dt) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è'); const order = { id:'o_'+uid(), category:cat, desc, datetime:dt, budget, city: STATE.city, ownerId: STATE.profile.id, ownerName: STATE.profile.name, bids:[], status:'open', createdAt: nowISO() }; STATE.orders.unshift(order); saveState(); alert('–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'); closeScreen('createScreen'); renderFindList(); });
$('cancelOrderBtn').addEventListener('click', ()=>{ closeScreen('createScreen'); });

/* ===== find orders ===== */
function renderFind(){ const sel = $('filterCat'); sel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>'; CATS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); renderFindList(); }
function renderFindList(){ const wrap = $('findList'); wrap.innerHTML=''; const q = ($('searchInput').value||'').toLowerCase(); const cat = $('filterCat').value; let items = STATE.orders.filter(o=>o.status==='open' && o.city===STATE.city); if(cat) items = items.filter(x=>x.category===cat); if(q) items = items.filter(o=> (o.category+' '+o.desc+' '+(o.ownerName||'')).toLowerCase().includes(q)); if(!items.length){ wrap.innerHTML = '<div class="small">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; } items.forEach(o=>{ const card = document.createElement('div'); card.className='post-card'; card.innerHTML = `<div class="post-top"><div class="avatar">${(o.ownerName||'–ü')[0]}</div><div style="display:flex;flex-direction:column;"><div style="font-weight:900">${esc(o.category)}</div><div class="small">${esc(o.ownerName)} ‚Ä¢ ${esc(o.city)} ‚Ä¢ ‚Ç∏ ${Number(o.budget||0).toLocaleString('ru-RU')}</div></div></div><div style="margin-top:8px; white-space:pre-wrap">${esc(o.desc)}</div><div class="post-actions"><button class="act" data-act="offer">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É</button></div>`; card.querySelector('[data-act="offer"]').addEventListener('click', ()=>{ $('offerModal').dataset.orderId = o.id; openScreen('offerModal'); }); wrap.appendChild(card); }); }
$('applySearch').addEventListener('click', renderFindList);

/* offer submit */
$('offerForm').addEventListener('submit', (e)=>{ e.preventDefault(); const price = Number($('offerPrice').value||0); if(!price) return alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É'); const comment = $('offerComment').value.trim(); const orderId = $('offerModal').dataset.orderId; const order = STATE.orders.find(x=>x.id===orderId); if(!order) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'); const bid = { performerId: STATE.profile.id, name: STATE.profile.name, price, comment, createdAt: nowISO() }; order.bids = order.bids||[]; order.bids.push(bid); STATE.notifs.unshift({ id:'n_'+uid(), type:'bid', title:'–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', body:`–ù–∞ –≤–∞—à –∑–∞–∫–∞–∑ "${order.category}" –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ ‚Ç∏ ${price}`, ts: nowISO(), payload:{orderId} }); saveState(); closeScreen('offerModal'); alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); renderFindList(); refreshNotifBadge(); });

/* ===== mine orders (owner) */
function renderMine(){ const wrap = $('bidsList'); wrap.innerHTML=''; const mine = STATE.orders.filter(o=>o.ownerId===STATE.profile.id); if(!mine.length){ wrap.innerHTML = '<div class="small">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; } mine.forEach(o=>{ const card = document.createElement('div'); card.className='post-card'; const bidsCount = (o.bids||[]).length; card.innerHTML = `<div style="font-weight:900">${esc(o.category)} ‚Ä¢ ${esc(o.city)} ${bidsCount?(' ‚Ä¢ <span style="color:#ff9bb0">'+bidsCount+' –∑–∞—è–≤–æ–∫</span>'):''}</div><div class="small" style="margin-top:6px">–°—Ç–∞—Ç—É—Å: ${esc(o.status)} ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div><div style="margin-top:8px">${esc(o.desc)}</div>`; const actions = document.createElement('div'); actions.style.marginTop='10px'; const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏'; viewBtn.addEventListener('click', ()=> openBidsModal(o.id) ); actions.appendChild(viewBtn); card.appendChild(actions); wrap.appendChild(card); }); }

function openBidsModal(orderId){ const order = STATE.orders.find(x=>x.id===orderId); if(!order) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω'); const list = $('bidsList'); list.innerHTML=''; if(!(order.bids && order.bids.length)){ list.innerHTML = '<div class="small">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>'; openScreen('bidsModal'); return; } order.bids.forEach((b, idx)=>{ const row = document.createElement('div'); row.className='post-card'; row.innerHTML = `<div style="font-weight:900">${esc(b.name)} ‚Äî ‚Ç∏ ${Number(b.price).toLocaleString('ru-RU')}</div><div class="small" style="margin-top:6px">${new Date(b.createdAt).toLocaleString()}</div><div style="margin-top:8px">${esc(b.comment||'')}</div>`; const actions = document.createElement('div'); actions.style.marginTop='8px'; const accept = document.createElement('button'); accept.className='btn primary'; accept.textContent='–ü—Ä–∏–Ω—è—Ç—å'; const decline = document.createElement('button'); decline.className='btn'; decline.textContent='–û—Ç–∫–∞–∑–∞—Ç—å'; accept.addEventListener('click', ()=>{ const chat = { id:'chat_'+uid(), orderId: order.id, title: order.category, participants:[order.ownerId, b.performerId], messages:[{from:'system',text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω –ø–æ –∑–∞–∫–∞–∑—É',ts:nowISO()}] }; STATE.chats.unshift(chat); order.status='in_progress'; STATE.notifs.unshift({ id:'n_'+uid(), type:'accepted_owner', title:'–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É', body:`–û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å ${b.name}`, ts:nowISO(), payload:{chatId:chat.id, orderId:order.id} }); saveState(); renderChats(); openChat(chat.id); closeScreen('bidsModal'); }); decline.addEventListener('click', ()=>{ order.bids.splice(idx,1); saveState(); openBidsModal(orderId); }); actions.appendChild(accept); actions.appendChild(decline); row.appendChild(actions); list.appendChild(row); }); $('bidsTitle').textContent = `–ó–∞—è–≤–∫–∏ ‚Äî ${order.category}`; openScreen('bidsModal'); }

/* ===== city thread & quick post ===== */
function renderCity(){ renderCityPosts(); }
function renderCityPosts(){ const wrap = $('cityPosts'); wrap.innerHTML=''; const posts = STATE.feed[STATE.city] || []; if(!posts.length){ wrap.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; } posts.forEach(p=>{ const el = document.createElement('div'); el.className='post-card'; const likesCount = Object.keys(p.likes?.byUser||{}).length; const commentsCount = (p.comments||[]).length; el.innerHTML = `<div class="post-top"><div class="avatar">${(p.authorName||'–ü')[0]}</div><div style="display:flex;flex-direction:column;"><div style="font-weight:900">${esc(p.authorName)}</div><div class="small">${new Date(p.ts).toLocaleString()}</div></div></div><div style="margin-top:8px; white-space:pre-wrap">${esc(p.text)}</div>${p.image?`<img class="post-img" src="${p.image}" alt="image" style="margin-top:8px;max-width:100%;border-radius:8px">`:''}<div class="post-actions"><button class="act" data-act="like">‚ù§Ô∏è <span data-likecount>${likesCount}</span></button><button class="act" data-act="comment">üí¨ <span data-commentcount>${commentsCount}</span></button><button class="act" data-act="repost">üîÅ</button></div><div class="comments" style="display:none; margin-top:8px;"><div style="display:flex;gap:8px;"><input class="input comment-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."><button class="btn primary comment-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div><div class="comments-list" style="margin-top:8px;"></div></div>`; wrap.appendChild(el);

    const likeBtn = el.querySelector('[data-act="like"]');
    likeBtn.addEventListener('click', ()=>{ const me = STATE.profile.id; p.likes = p.likes||{byUser:{}}; if(p.likes.byUser[me]) delete p.likes.byUser[me]; else p.likes.byUser[me]=true; el.querySelector('[data-likecount]').textContent = Object.keys(p.likes.byUser||{}).length; saveState(); });

    const commentBtn = el.querySelector('[data-act="comment"]'); const commentsBox = el.querySelector('.comments');
    commentBtn.addEventListener('click', ()=>{ commentsBox.style.display = commentsBox.style.display==='none'?'block':'none'; // toggle and allow users to read comments
      // populate existing comments list
      const listEl = el.querySelector('.comments-list'); listEl.innerHTML=''; (p.comments||[]).forEach(c=>{ const node = document.createElement('div'); node.className='comment'; node.innerHTML = `<div style="font-weight:800">${esc(c.authorName)}</div><div class="small">${new Date(c.ts).toLocaleString()}</div><div style="margin-top:6px">${esc(c.text)}</div>`; listEl.appendChild(node); });
    });

    const sendBtn = el.querySelector('.comment-send');
    sendBtn.addEventListener('click', ()=>{ const input = el.querySelector('.comment-input'); const txt = input.value.trim(); if(!txt) return; p.comments = p.comments||[]; p.comments.push({id:'c_'+uid(), authorName:STATE.profile.name, text:txt, ts:nowISO()}); input.value=''; saveState(); // update comment counter
      el.querySelector('[data-commentcount]').textContent = (p.comments||[]).length; // append to DOM list
      const list = el.querySelector('.comments-list'); const node = document.createElement('div'); node.className='comment'; node.innerHTML = `<div style="font-weight:800">${esc(STATE.profile.name)}</div><div class="small">${new Date().toLocaleString()}</div><div style="margin-top:6px">${esc(txt)}</div>`; list.appendChild(node);
    });

    el.querySelector('[data-act="repost"]').addEventListener('click', ()=>{ // repost to contacts: open picker and mark repostId
      $('createChatScreen').dataset.repostId = p.id; openRepostPicker(p);
    });
  }); }

/* quick post: keep user in city chat after posting */
$('topComposerPlaceholder').addEventListener('click', ()=>{ $('quickPostText').value=''; $('quickPostPreview').innerHTML=''; $('quickPostImage').value=''; openScreen('quickPostModal'); });
$('quickPostFileBtn').addEventListener('click', ()=>{ $('quickPostImage').click(); });
$('quickPostImage').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ $('quickPostPreview').innerHTML = `<img src="${r.result}" style="max-width:100%;border-radius:8px">`; $('quickPostPreview').dataset.img = r.result; }; r.readAsDataURL(f); });
$('quickPostSend').addEventListener('click', ()=>{ const text = $('quickPostText').value.trim(); const img = $('quickPostPreview').dataset.img || null; if(!text && !img) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ'); const post = { id:'post_'+uid(), authorId:STATE.profile.id, authorName:STATE.profile.name, text, image:img, ts: nowISO(), likes:{byUser:{}}, comments:[] }; (STATE.feed[STATE.city] = STATE.feed[STATE.city]||[]).unshift(post); saveState(); closeScreen('quickPostModal'); // explicitly ensure we return to city thread
  openScreen('cityThreadScreen'); renderCityPosts(); alert('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞'); });

/* open repost picker with contacts */
function openRepostPicker(post){ const picker = $('chatPicker'); picker.innerHTML=''; const users = new Map(); // build contacts from STATE.chats & orders
  STATE.chats.forEach(c=>{ c.participants.forEach(id=>{ if(id!==STATE.profile.id) users.set(id, c.title || id); }); });
  STATE.orders.forEach(o=>{ if(o.ownerId && o.ownerId!==STATE.profile.id) users.set(o.ownerId, o.ownerName||o.ownerId); (o.bids||[]).forEach(b=>{ if(b.performerId && b.performerId!==STATE.profile.id) users.set(b.performerId, b.name||b.performerId); }); });
  if(!users.size){ alert('–£ –≤–∞—Å –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è —Ä–µ–ø–æ—Å—Ç–∞'); return; }
  users.forEach((name,id)=>{ const el=document.createElement('div'); el.className='post-card'; el.style.cursor='pointer'; el.innerHTML = `<div style="font-weight:900">${esc(name)}</div><div class="small" style="margin-top:6px">${esc(id)}</div>`; el.addEventListener('click', ()=>{ // create or open chat and send repost message
      let chat = STATE.chats.find(ch=> ch.participants && ch.participants.includes(id) && ch.participants.includes(STATE.profile.id)); if(!chat){ chat = { id:'chat_'+uid(), orderId:null, title:'–ß–∞—Ç —Å '+name, participants:[STATE.profile.id, id], messages:[] }; STATE.chats.unshift(chat); }
      chat.messages = chat.messages||[]; chat.messages.push({ from: STATE.profile.id, fromName: STATE.profile.name, text: '–†–µ–ø–æ—Å—Ç: '+(post.text||'[–ø—É–±–ª–∏–∫–∞—Ü–∏—è]'), ts: nowISO() }); saveState(); closeScreen('createChatScreen'); renderChats(); openChat(chat.id); alert('–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç —Å '+name); }); picker.appendChild(el); }); openScreen('createChatScreen'); }

/* ===== messenger ===== */
function renderChats(){ const wrap = $('chatsList'); wrap.innerHTML=''; if(!STATE.chats.length){ wrap.innerHTML = '<div class="small">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'; $('chatWindow').style.display='none'; $('chatEmpty').style.display='block'; return; } STATE.chats.forEach(c=>{ const el=document.createElement('div'); el.className='post-card'; el.style.cursor='pointer'; el.innerHTML = `<div style="font-weight:900">${esc(c.title || '–ß–∞—Ç')}</div><div class="small" style="margin-top:6px">${c.orderId?('–ó–∞–∫–∞–∑: '+c.orderId):'–î–∏–∞–ª–æ–≥'}</div>`; el.addEventListener('click', ()=> openChat(c.id)); wrap.appendChild(el); }); }
function openChat(chatId){ const chat = STATE.chats.find(x=>x.id===chatId); if(!chat) return; $('chatWindowHeader').style.display='flex'; $('chatWindow').style.display='flex'; $('chatEmpty').style.display='none'; $('chatHeaderName').textContent = chat.title || '–ß–∞—Ç'; $('chatHeaderAvatar').textContent = (chat.title||'–ß')[0]; const msgsWrap = $('chatMsgs'); msgsWrap.innerHTML=''; (chat.messages||[]).forEach(m=>{ const d = document.createElement('div'); d.className = 'msg ' + ((m.from === STATE.profile.id)?'me':'other'); if(m.from === 'system'){ d.style.fontStyle='italic'; d.style.color='var(--muted)'; d.textContent = m.text; } else { if(m.from === STATE.profile.id) d.innerHTML = `<div>${esc(m.text)}</div>`; else d.innerHTML = `<div style="font-weight:800; margin-bottom:6px">${esc(m.fromName||'')}</div><div>${esc(m.text)}</div>`; } msgsWrap.appendChild(d); }); msgsWrap.scrollTop = msgsWrap.scrollHeight; $('chatSend').onclick = ()=>{ const v = $('chatInput').value.trim(); if(!v) return; const msg = { from: STATE.profile.id, fromName: STATE.profile.name, text: v, ts: nowISO() }; chat.messages = chat.messages||[]; chat.messages.push(msg); saveState(); $('chatInput').value=''; openChat(chatId); }; }

/* create chat picker simple */
$('createChatBtn').addEventListener('click', ()=>{ const picker = $('chatPicker'); picker.innerHTML=''; const users = new Map(); STATE.orders.forEach(o=>{ users.set(o.ownerId, o.ownerName||('user_'+o.ownerId)); (o.bids||[]).forEach(b=>users.set(b.performerId, b.name||('user_'+b.performerId))); }); if(!users.size){ picker.innerHTML = '<div class="small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>'; openScreen('createChatScreen'); return; } users.forEach((name,id)=>{ const el=document.createElement('div'); el.className='post-card'; el.style.cursor='pointer'; el.innerHTML = `<div style="font-weight:900">${esc(name)}</div><div class="small" style="margin-top:6px">${esc(id)}</div>`; el.addEventListener('click', ()=>{ const chat = { id:'chat_'+uid(), orderId:null, title:'–î–∏–∞–ª–æ–≥ —Å '+name, participants:[STATE.profile.id, id], messages:[{from:'system', text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω', ts:nowISO()}] }; STATE.chats.unshift(chat); saveState(); closeScreen('createChatScreen'); renderChats(); openChat(chat.id); }); picker.appendChild(el); }); openScreen('createChatScreen'); });

/* ===== JSONBin sync ===== */
async function loadCloud(){ if(!JSONBIN.ENABLED) return; try{ const res = await fetch(JSONBIN.URL(JSONBIN.BIN_ID), { headers:{ 'X-Master-Key': JSONBIN.KEY } }); if(!res.ok) throw new Error('GET failed '+res.status); const j = await res.json(); const rec = j.record || {}; if(Array.isArray(rec.orders)) STATE.orders = rec.orders; if(rec.feed) STATE.feed = rec.feed; if(Array.isArray(rec.chats)) STATE.chats = rec.chats; if(Array.isArray(rec.notifs)) STATE.notifs = rec.notifs; saveState(); renderCityPosts(); renderFindList(); renderChats(); }catch(e){ console.warn('cloud load error', e); } }
async function saveCloud(){ if(!JSONBIN.ENABLED) return; try{ const payload = { orders: STATE.orders, feed: STATE.feed, chats: STATE.chats, notifs: STATE.notifs, meta:{ts: nowISO()} }; const res = await fetch(JSONBIN.URL(JSONBIN.BIN_ID), { method:'PUT', headers:{ 'Content-Type':'application/json', 'X-Master-Key': JSONBIN.KEY }, body: JSON.stringify(payload) }); if(!res.ok) throw new Error('PUT failed '+res.status); }catch(e){ console.warn('cloud save error', e); } }
$('syncToggle').addEventListener('change', (e)=>{ STATE.syncEnabled = !!e.target.checked; saveState(); });
$('syncNowBtn').addEventListener('click', async ()=>{ try{ await loadCloud(); alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'); }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: '+(e.message||e)); } });
let __syncRunning = false; setInterval(async ()=>{ if(STATE.syncEnabled && !__syncRunning){ __syncRunning=true; try{ await saveCloud(); await loadCloud(); }catch(e){} finally{ __syncRunning=false; } } }, 1000);

/* ===== themes & settings population ===== */
const THEMES = [ {k:'violet', name:'Violet', accent:'#a970ff', accent2:'#32ffd2', line:'rgba(160,170,230,.12)'}, {k:'navy', name:'Navy', accent:'#6ea8ff', accent2:'#4dd0e1', line:'rgba(120,140,200,.12)'}, {k:'emerald', name:'Emerald', accent:'#00d084', accent2:'#32ffd2', line:'rgba(80,220,200,.12)'}, {k:'sunset', name:'Sunset', accent:'#ff7a59', accent2:'#ffd84d', line:'rgba(255,140,100,.12)'}, {k:'mint', name:'Mint', accent:'#6ef0c0', accent2:'#7bd3ff', line:'rgba(120,220,200,.12)'} ];
function applyTheme(theme){ document.documentElement.setAttribute('data-theme', theme.k); document.documentElement.style.setProperty('--accent', theme.accent); document.documentElement.style.setProperty('--accent2', theme.accent2); document.documentElement.style.setProperty('--line', theme.line); STATE.theme = theme.k; saveState(); }
function renderThemeList(){ const wrap = $('themeList'); wrap.innerHTML=''; THEMES.forEach(t=>{ const el = document.createElement('div'); el.className='theme-item'; el.innerHTML = `<div style="display:flex;gap:12px;align-items:center;width:100%"><div style="width:40px;height:28px;border-radius:8px;background:linear-gradient(90deg, ${t.accent}, ${t.accent2})"></div><div style="flex:1;display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${t.name}</div><button class="btn" data-theme="${t.k}">–í—ã–±—Ä–∞—Ç—å</button></div></div>`; el.querySelector('button').addEventListener('click', ()=> applyTheme(t)); wrap.appendChild(el); }); }
renderThemeList();

/* populate city select with all keys */
function populateCitySelect(){ const sel = $('citySelect'); sel.innerHTML=''; Object.keys(CITY_COORDS).forEach(c=>{ const o=document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); }); sel.value = STATE.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'; sel.addEventListener('change', ()=>{ STATE.city = sel.value; saveState(); $('currentCity').textContent = STATE.city; renderCityPosts(); updateDateTimeWeather(); }); }
populateCitySelect();

/* profile saving */
$('saveProfileBtn').addEventListener('click', ()=>{ const name = $('profileName').value.trim(); const avatar = $('profileAvatar').value.trim(); if(name) STATE.profile.name = name; if(avatar) STATE.profile.avatarData = avatar; saveState(); $('topComposerAvatar').textContent = STATE.profile.avatarData || (STATE.profile.name[0]||'–Ø'); alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });

/* ===== helpers & init ===== */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const el = document.getElementById(id); if(el) el.classList.add('active'); }
function closeScreen(id){ const el = document.getElementById(id); if(el) el.classList.remove('active'); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function init(){ // populate basic UI
  $('syncToggle').checked = !!STATE.syncEnabled; renderRoleTabs(); renderMenu(); renderCity(); refreshNotifBadge(); renderChats(); $('topComposerAvatar').textContent = STATE.profile.avatarData || (STATE.profile.name[0]||'–Ø'); // attach settings button
  $('openSettings').addEventListener('click', ()=>{ $('profileName').value = STATE.profile.name || ''; $('profileAvatar').value = STATE.profile.avatarData || ''; $('citySelect').value = STATE.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'; openScreen('settingsModal'); });
}
init();

/* expose for debug */
window.GIDCITY = { STATE, saveState, loadState, loadCloud, saveCloud };
</script>
</body>
</html>
