<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø (–∫–∞—Ä—Ç–∞ + –∑–∞—è–≤–∫–∏)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg-top:#5b2cff;
    --bg-bottom:#0a0a0a;
    --panel:#0a0a0a;
    --accent:#ffd54a;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.06);
    --text:#eaeef6;
    --muted:rgba(234,238,246,0.6);
    --radius:12px;
    --phone-w:380px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(160deg,var(--bg-top) 0%, #2b0b3a 40%, var(--bg-bottom) 100%);color:var(--text);display:flex;align-items:center;justify-content:center;padding:12px;}
  .phone{width:var(--phone-w);max-width:calc(100% - 24px);height:812px;border-radius:30px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.6);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));}
  .header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);position:relative;z-index:10}
  .logo{display:flex;align-items:center;gap:10px}
  .logo .pic{width:44px;height:44px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center}
  .app-title{font-weight:800;font-size:18px}
  .header-center{display:flex;align-items:center;gap:8px}
  .calendar-btn{padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);cursor:pointer;font-weight:700}
  .header-actions{display:flex;align-items:center;gap:8px}
  .icon-btn{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--glass);border:1px solid var(--glass-border);cursor:pointer;position:relative}
  .notif-badge{position:absolute;top:-6px;right:-6px;background:var(--accent);color:#081018;padding:4px 6px;border-radius:12px;font-weight:800;font-size:11px}
  .content{padding:12px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .city-block{display:flex;flex-direction:column}
  .city-name{font-weight:800;font-size:18px;margin:0}
  .city-sub{font-size:12px;color:var(--muted)}
  .weather{padding:6px 10px;border-radius:12px;background:var(--panel);border:1px solid var(--glass-border);font-weight:700}
  .tabs{display:flex;gap:8px;margin-top:6px}
  .tab{flex:1;padding:8px;border-radius:12px;text-align:center;background:transparent;border:1px solid var(--glass-border);cursor:pointer;color:var(--muted);font-weight:800}
  .tab.active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25)}
  .main-card{background:var(--panel);border-radius:14px;padding:12px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:10px;flex:1;min-height:300px;overflow:hidden}
  /* menu vertical */
  .menu-list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px}
  .menu-item{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center;min-height:62px;cursor:pointer}
  .menu-item .left{display:flex;flex-direction:column}
  .menu-item .title{font-weight:900;font-size:16px}
  .menu-item .caption{font-size:12px;color:var(--muted)}
  /* map block */
  #mapBlock{height:260px;border-radius:10px;overflow:hidden;border:1px solid var(--glass-border)}
  .map-controls{display:flex;gap:8px;margin-bottom:8px;align-items:center}
  .search{flex:1;display:flex;gap:8px}
  .search input{flex:1;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  .map-actions{display:flex;gap:6px}
  .small{font-size:12px;color:var(--muted)}
  footer{padding:8px 12px;border-top:1px solid rgba(255,255,255,0.02);font-size:12px;color:var(--muted);text-align:center}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal{width:100%;max-width:560px;background:linear-gradient(180deg,var(--panel),#070707);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:0 30px 80px rgba(0,0,0,0.7);max-height:90vh;overflow:auto}
  label{font-size:13px;color:var(--muted);display:block;margin:6px 0 4px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  textarea{min-height:90px}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);font-weight:800}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#ffb347);color:#081018}
  /* leafleft map container */
  #map{height:100%;width:100%}
  /* responsive tweak */
  @media(max-width:420px){ .phone{width:100%;height:100vh;border-radius:0} }
</style>
</head>
<body>
<div class="phone" role="application" aria-label="GiDCity prototype">
  <div class="header">
    <div class="logo">
      <div class="pic" id="avatarPreview">G</div>
      <div style="display:flex;flex-direction:column">
        <div class="app-title">GiDCity</div>
        <div class="small">–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
      </div>
    </div>

    <div class="header-center">
      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–º–µ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
      <button class="calendar-btn" id="calendarBtn">–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî –æ—Ç–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="header-actions">
      <!-- –ø–æ–≥–æ–¥–∞ -->
      <div class="weather" id="weatherBlock">‚Äî ¬∞C</div>
      <!-- —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
      <div class="icon-btn" id="notifBtn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
        üîî
        <div class="notif-badge" id="notifCount">0</div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="top-row">
      <div class="city-block">
        <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
        <div class="city-sub" id="citySub">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
      </div>
      <div class="small" id="syncText">—à–∞–±–ª–æ–Ω / –º–∞–∫–µ—Ç</div>
    </div>

    <div class="tabs" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
      <div class="tab active" id="tabServices">–£–°–õ–£–ì–ò</div>
      <div class="tab" id="tabWork">–†–ê–ë–û–¢–ê</div>
    </div>

    <div class="main-card" id="mainCard" role="region" aria-label="–ì–ª–∞–≤–Ω—ã–π –±–ª–æ–∫">
      <!-- –∫–∞—Ä—Ç–∞ (–≤–º–µ—Å—Ç–æ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" –¥–ª–∏–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏) -->
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="map-controls">
          <div class="search">
            <input type="text" id="mapSearch" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏">
            <button class="btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
          </div>
          <div class="map-actions">
            <button class="btn" id="setFromBtn" title="–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">A</button>
            <button class="btn" id="setToBtn" title="–û—Ç–º–µ—Ç–∏—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è">B</button>
            <button class="btn" id="routeBtn" title="–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
            <button class="btn" id="clearRoute">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </div>
        <div id="mapBlock"><div id="map"></div></div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="small">–ù–∞–π–¥–µ–Ω–æ: <span id="searchCount">0</span></div>
          <div class="small" style="margin-left:auto">–ö–∞—Ä—Ç–∞: OpenRouteService</div>
        </div>
      </div>

      <!-- –º–µ–Ω—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º —Å—Ç–æ–ª–±—Ü–æ–º -->
      <div style="margin-top:8px">
        <div class="menu-list" id="menuList" aria-label="–ú–µ–Ω—é">
          <!-- items inserted by JS -->
        </div>
      </div>
    </div>
  </div>

  <footer id="appFooter">GiDCity ‚Ä¢ –º–∞–∫–µ—Ç –ø—Ä–æ—Ç–æ—Ç–∏–ø ‚Äî –∫–∞—Ä—Ç–∞: OpenRouteService</footer>
</div>

<!-- –º–æ–¥–∞–ª–∫–∏ -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalWindow" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<!-- –ø–æ–¥–∫–ª—é—á–∞–µ–º Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===========================
   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ state
   =========================== */
const OPENROUTESERVICE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjcyZWNiZDAxMGJlNTRjY2E4NDQwYTVlYmM2N2U1NzdkIiwiaCI6Im11cm11cjY0In0='; // —Ç–≤–æ–π –∫–ª—é—á
const DEFAULT_CITY = {name:'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', lat:49.8062, lon:73.0851, zoom:13};

let state = JSON.parse(localStorage.getItem('gid_state_v2') || '{}') || {};
state = Object.assign({
  theme:'—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  user: null,
  notifications: [],
  servicesPosts: [],
  city: DEFAULT_CITY.name
}, state);

/* ==============
   Utility
   ============== */
function saveState(){ localStorage.setItem('gid_state_v2', JSON.stringify(state)); }
function el(id){ return document.getElementById(id); }
function setNotifCount(){ el('notifCount').textContent = state.notifications.length || 0; }

/* ==============
   Apply theme (simple)
   ============== */
function applyTheme(name){
  const themes = {
    '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π': {top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a', border:'rgba(255,255,255,0.06)'},
    '—Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π': {top:'#0b3d91', bottom:'#061428', accent:'#55d4ff', border:'rgba(255,255,255,0.06)'}
  };
  const t = themes[name] || themes['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  document.documentElement.style.setProperty('--bg-top', t.top);
  document.documentElement.style.setProperty('--bg-bottom', t.bottom);
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--glass-border', t.border);
  state.theme = name; saveState();
}

/* ==============
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (Leaflet) + ORS geocode & routing
   ============== */
let map, fromMarker=null, toMarker=null, routeLayer=null;
function initMap(){
  map = L.map('map', {zoomControl:true, preferCanvas:true}).setView([DEFAULT_CITY.lat, DEFAULT_CITY.lon], DEFAULT_CITY.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(map);

  // click handlers to set points when active mode chosen
  map.on('click', e=>{
    if(map._setMode === 'from'){ setFromPoint(e.latlng); map._setMode=null; return; }
    if(map._setMode === 'to'){ setToPoint(e.latlng); map._setMode=null; return; }
  });
}

/* –≥–µ–æ–∫–æ–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ ORS */
async function geocode(text){
  try{
    const q = encodeURIComponent(text);
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${OPENROUTESERVICE_API_KEY}&text=${q}&size=5`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('geocode error ' + r.status);
    const data = await r.json();
    return (data.features||[]).map(f=>({
      label: f.properties.label || f.properties.name || text,
      lat: f.geometry.coordinates[1],
      lon: f.geometry.coordinates[0],
      props: f.properties
    }));
  }catch(e){
    console.warn(e);
    return [];
  }
}

/* –ø—Ä–æ–ª–æ–∂–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç (driving-car) */
async function buildRoute(fromLatLng, toLatLng){
  try{
    const coords = `${fromLatLng.lng},${fromLatLng.lat}|${toLatLng.lng},${toLatLng.lat}`;
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${OPENROUTESERVICE_API_KEY}&start=${fromLatLng.lng},${fromLatLng.lat}&end=${toLatLng.lng},${toLatLng.lat}`;
    // ORS directions supports POST with coordinates array, but above quick usage uses GET start/end - if fails fallback to POST
    let resp = await fetch(url);
    if(!resp.ok){
      // try POST
      resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
        method:'POST',
        headers: {'Content-Type':'application/json','Authorization': OPENROUTESERVICE_API_KEY},
        body: JSON.stringify({coordinates:[[fromLatLng.lng,fromLatLng.lat],[toLatLng.lng,toLatLng.lat]]})
      });
      if(!resp.ok) throw new Error('routing failed ' + resp.status);
      const g = await resp.json();
      renderRouteGeoJSON(g);
      return g;
    }
    const g = await resp.json();
    renderRouteGeoJSON(g);
    return g;
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + (e.message||e));
    console.warn(e);
  }
}

/* –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç GeoJSON */
function renderRouteGeoJSON(g){
  if(routeLayer) map.removeLayer(routeLayer);
  // ORS geojson structure: features[0].geometry
  let geo = null;
  if(g && g.features && g.features.length) geo = g;
  else if(g && g.geometry) geo = {type:'FeatureCollection',features:[g]};
  if(!geo) return;
  routeLayer = L.geoJSON(geo, {style:{color: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#ffd54a', weight:4, opacity:0.9}}).addTo(map);
  map.fitBounds(routeLayer.getBounds(), {padding:[30,30]});
}

/* —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã */
function setFromPoint(latlng){
  if(fromMarker) map.removeLayer(fromMarker);
  fromMarker = L.marker(latlng,{title:'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (A)', draggable:true}).addTo(map).bindPopup('A: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ').openPopup();
  fromMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); });
}
function setToPoint(latlng){
  if(toMarker) map.removeLayer(toMarker);
  toMarker = L.marker(latlng,{title:'–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ (B)', draggable:true}).addTo(map).bindPopup('B: –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ').openPopup();
  toMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); });
}

/* –æ—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏ –º–∞—Ä–∫–µ—Ä—ã */
function clearRoute(){
  if(fromMarker){ map.removeLayer(fromMarker); fromMarker=null; }
  if(toMarker){ map.removeLayer(toMarker); toMarker=null; }
  if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
}

/* –ø–æ–∏—Å–∫ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–≤—Ä–µ–º–µ–Ω–Ω–æ –∫–∞–∫ –º–∞—Ä–∫–µ—Ä—ã –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ) */
let searchMarkers = [];
async function doSearch(query){
  el('searchCount').textContent = '...';
  const results = await geocode(query);
  // –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö
  searchMarkers.forEach(m=>map.removeLayer(m)); searchMarkers=[];
  if(!results.length){ el('searchCount').textContent = 0; alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  results.forEach((r,i)=>{
    const mk = L.marker([r.lat,r.lon]).addTo(map).bindPopup(`<strong>${r.label}</strong><div class="small">${(r.props && r.props.osm_type)||''}</div><div style="margin-top:6px"><button class="btn" onclick="window.__setFromFromSearch(${r.lat},${r.lon})">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (A)</button> <button class="btn primary" onclick="window.__setToFromSearch(${r.lat},${r.lon})">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ (B)</button></div>`);
    searchMarkers.push(mk);
  });
  map.fitBounds(L.featureGroup(searchMarkers).getBounds(), {padding:[30,30]});
  el('searchCount').textContent = results.length;
  return results;
}

/* –≤—ã–∑–æ–≤—ã –∏–∑ popup –∫–Ω–æ–ø–æ–∫ (–≥–ª–æ–±–∞–ª—å–Ω–æ) */
window.__setFromFromSearch = function(lat,lon){ setFromPoint(L.latLng(lat,lon)); }
window.__setToFromSearch = function(lat,lon){ setToPoint(L.latLng(lat,lon)); }

/* ==============
   UI: –º–µ–Ω—é, modals, –∑–∞—è–≤–∫–∏
   ============== */
const MENU_ITEMS_SERVICES = [
  {id:'gid_order', title:'GiD –ó–∞–∫–∞–∑', caption:'–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –±—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑'},
  {id:'order', title:'–ó–ê–ö–ê–ó–ê–¢–¨', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
  {id:'reserve', title:'–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨', caption:'—Å–∫–æ—Ä–æ...'},
  {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'},
  {id:'citychat', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞'},
  {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–¥–∏–∞–ª–æ–≥–∏'}
];
const MENU_ITEMS_WORK = [
  {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫'},
  {id:'myOffers', title:'–ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏', caption:'–°–ø–∏—Å–æ–∫'},
  {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'},
  {id:'reports', title:'–û—Ç—á—ë—Ç—ã', caption:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'}
];

function renderMenu(){
  const box = el('menuList'); box.innerHTML='';
  const active = el('tabServices').classList.contains('active') ? 'services' : 'work';
  const items = active==='services' ? MENU_ITEMS_SERVICES : MENU_ITEMS_WORK;
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='menu-item'; div.dataset.id=it.id;
    div.innerHTML = `<div class="left"><div class="title">${it.title}</div><div class="caption">${it.caption}</div></div><div style="opacity:0.9">‚Ä∫</div>`;
    div.addEventListener('click', ()=>onMenuClick(it.id));
    box.appendChild(div);
  });
}

/* –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ */
function openModal(html, actionsHtml){
  el('modalContent').innerHTML = html;
  el('modalActions').innerHTML = actionsHtml || '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>';
  el('modalBackdrop').style.display='flex'; el('modalBackdrop').setAttribute('aria-hidden','false');
  // bind close
  el('modalBackdrop').addEventListener('click', e=>{ if(e.target===el('modalBackdrop')) closeModal(); });
  el('modalBackdrop').querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));
}
function closeModal(){ el('modalBackdrop').style.display='none'; el('modalBackdrop').setAttribute('aria-hidden','true'); el('modalContent').innerHTML=''; el('modalActions').innerHTML=''; }

/* –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é */
function onMenuClick(id){
  if(id==='gid_order'){ openGiDOrder(); }
  else if(id==='order'){ openOrderModal(); }
  else if(id==='reserve'){ alert('–†–∞–∑–¥–µ–ª —Å–∫–æ—Ä–æ –¥–æ—Å—Ç—É–ø–µ–Ω (–º–∞–∫–µ—Ç).'); }
  else if(id==='ads'){ openAdsModal(); }
  else if(id==='citychat'){ openCityChat(); }
  else if(id==='messenger'){ openMessenger(); }
  else if(id==='findJobs'){ openFindJobs(); }
  else if(id==='wallet'){ openWallet(); }
  else alert('–ù–∞–∂–∞—Ç–∞: ' + id);
}

/* GiD –ó–∞–∫–∞–∑ ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –Ω–µ—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã) */
function openGiDOrder(){
  const html = `<div class="h"><strong>GiD –ó–∞–∫–∞–∑ ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π</strong></div>
    <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label><input id="gdesc" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å">
    <label>–ê–¥—Ä–µ—Å / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="gaddr" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥">
    <label>–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</label><input id="gtime" type="time">
    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="gphone" placeholder="+7...">
    <div style="margin-top:8px" class="small">–ü–æ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–¥–µ–º–æ).</div>`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="gidCreate">–°–æ–∑–¥–∞—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ document.getElementById('gidCreate').addEventListener('click', ()=>{
    const d = document.getElementById('gdesc').value.trim(), addr=document.getElementById('gaddr').value.trim(), time=document.getElementById('gtime').value, phone=document.getElementById('gphone').value.trim();
    if(!d || !addr) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');
    state.servicesPosts = state.servicesPosts || [];
    state.servicesPosts.unshift({id:Date.now(), type:'GiD', desc:d, addr, time, phone, created: new Date().toISOString()});
    saveState(); closeModal(); alert('GiD –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω (–¥–µ–º–æ).');
  }); },50);
}

/* –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–ª—è–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
function openOrderModal(){
  const categories = ['–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º','–ú–∞—Å—Ç–µ—Ä','GiD –ó–∞–∫–∞–∑'];
  const html = `<div class="h"><strong>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</strong></div>
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="ordCat">${categories.map(c=>`<option>${c}</option>`).join('')}</select>
    <div id="ordDynamic"></div>
    <div style="margin-top:8px"><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input id="ordBudget" type="number" value="0"></div>`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="ordCreate">–ó–∞–∫–∞–∑–∞—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ populateDynamicFields(); document.getElementById('ordCat').addEventListener('change', populateDynamicFields);
    document.getElementById('ordCreate').addEventListener('click', ()=>{
      const cat = document.getElementById('ordCat').value;
      const budget = document.getElementById('ordBudget').value;
      const dyn = captureDynamicFields();
      if(!dyn) return; // validation failed inside
      state.servicesPosts = state.servicesPosts || [];
      state.servicesPosts.unshift({id:Date.now(), cat, budget, dyn, created:new Date().toISOString()});
      saveState(); closeModal(); alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–¥–µ–º–æ).');
    });
  },50);
}
function populateDynamicFields(){
  const cat = document.getElementById('ordCat').value;
  const cont = el('ordDynamic'); cont.innerHTML='';
  if(cat==='–¢–∞–∫—Å–∏'){
    cont.innerHTML = `<label>–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label><input id="taxFrom"><label>–ê–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label><input id="taxTo"><label>–ö–æ–ª-–≤–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</label><input id="taxPax" type="number" value="1">`;
  } else if(cat==='–ö—É—Ä—å–µ—Ä'){
    cont.innerHTML = `<label>–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</label><input id="curFrom"><label>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label><input id="curTo"><label>–í–µ—Å/–≥–∞–±–∞—Ä–∏—Ç—ã</label><input id="curSize">`;
  } else if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º'){
    cont.innerHTML = `<label>–ê–¥—Ä–µ—Å</label><input id="homeAddr"><label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã/—É—Å–ª—É–≥–∏</label><textarea id="homeDesc"></textarea><label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</label><input id="homeFile" type="file" accept="image/*">`;
    document.getElementById('homeFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const b=await fileToBase64(f); cont.dataset.file=b; });
  } else if(cat==='–ú–∞—Å—Ç–µ—Ä'){
    cont.innerHTML = `<label>–ê–¥—Ä–µ—Å</label><input id="mAddr"><label>–¢–∏–ø —Ä–∞–±–æ—Ç</label><input id="mType"><label>–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</label><input id="mTime" type="time">`;
  } else { // GiD –ó–∞–∫–∞–∑
    cont.innerHTML = `<label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="gDesc"></textarea><label>–ê–¥—Ä–µ—Å</label><input id="gAddr">`;
  }
}
function captureDynamicFields(){
  const cat = document.getElementById('ordCat').value;
  if(cat==='–¢–∞–∫—Å–∏'){
    const from=document.getElementById('taxFrom').value.trim(), to=document.getElementById('taxTo').value.trim();
    if(!from||!to){ alert('–£–∫–∞–∂–∏—Ç–µ –æ–±–∞ –∞–¥—Ä–µ—Å–∞'); return null; }
    return {from,to,pax:document.getElementById('taxPax').value};
  } else if(cat==='–ö—É—Ä—å–µ—Ä'){
    const f=document.getElementById('curFrom').value.trim(), t=document.getElementById('curTo').value.trim();
    if(!f||!t){ alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å–∞'); return null; }
    return {from:f,to:t,size:document.getElementById('curSize').value};
  } else if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º'){
    const addr=document.getElementById('homeAddr').value.trim(), desc=document.getElementById('homeDesc').value.trim();
    if(!addr||!desc){ alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –æ–ø–∏—Å–∞–Ω–∏–µ'); return null; }
    return {addr,desc,file: (el('ordDynamic') && el('ordDynamic').dataset && el('ordDynamic').dataset.file) || null};
  } else if(cat==='–ú–∞—Å—Ç–µ—Ä'){
    const addr=document.getElementById('mAddr').value.trim(), type=document.getElementById('mType').value.trim();
    if(!addr||!type){ alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ —Ç–∏–ø —Ä–∞–±–æ—Ç'); return null; }
    return {addr,type,time:document.getElementById('mTime').value};
  } else {
    const d=document.getElementById('gDesc').value.trim(), a=document.getElementById('gAddr').value.trim();
    if(!d||!a){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å'); return null; }
    return {desc:d,addr:a};
  }
}

/* Ads modal */
function openAdsModal(){
  const html = `<div class="h"><strong>–ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</strong></div><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="adTitle"><label>–¢–µ–∫—Å—Ç</label><textarea id="adText"></textarea>`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="publishAd">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ document.getElementById('publishAd').addEventListener('click', ()=>{
    const t=document.getElementById('adTitle').value.trim(), txt=document.getElementById('adText').value.trim();
    if(!t||!txt) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
    state.cityPosts = state.cityPosts || []; state.cityPosts.unshift({id:Date.now(), title:t, text:txt, created:new Date().toISOString()});
    saveState(); closeModal(); alert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ (–¥–µ–º–æ).');
  }); },50);
}

/* City chat, messenger stubs */
function openCityChat(){ alert('–û—Ç–∫—Ä—ã—Ç—å City —á–∞—Ç ‚Äî –¥–µ–º–æ'); }
function openMessenger(){ alert('–û—Ç–∫—Ä—ã—Ç—å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä ‚Äî –¥–µ–º–æ'); }

/* Find jobs & wallet stubs */
function openFindJobs(){ alert('–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ ‚Äî –¥–µ–º–æ'); }
function openFindJobsModal(){ alert('–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã ‚Äî –¥–µ–º–æ'); }
function openWallet(){ alert('–ö–æ—à–µ–ª—ë–∫ ‚Äî –¥–µ–º–æ'); }

/* ==============
   Bind UI events
   ============== */
document.addEventListener('DOMContentLoaded', ()=>{
  applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π');
  // tabs
  el('tabServices').addEventListener('click', ()=>{ el('tabServices').classList.add('active'); el('tabWork').classList.remove('active'); renderMenu(); });
  el('tabWork').addEventListener('click', ()=>{ el('tabWork').classList.add('active'); el('tabServices').classList.remove('active'); renderMenu(); });
  renderMenu();

  // calendar modal
  el('calendarBtn').addEventListener('click', ()=>openCalendar());

  // map init
  initMap();

  // search button
  el('searchBtn').addEventListener('click', async ()=>{ const q=el('mapSearch').value.trim(); if(!q) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å'); await doSearch(q); });

  // set from/to btns
  el('setFromBtn').addEventListener('click', ()=>{ map._setMode='from'; alert('–ö–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (A)'); });
  el('setToBtn').addEventListener('click', ()=>{ map._setMode='to'; alert('–ö–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (B)'); });
  el('routeBtn').addEventListener('click', ()=>{ if(!fromMarker||!toMarker) return alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫–∏ A –∏ B'); buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); });
  el('clearRoute').addEventListener('click', ()=>{ clearRoute(); });

  // notif
  el('notifBtn').addEventListener('click', openNotifications);
  setNotifCount();

  // menu initial render
  renderMenu();

  // weather quick fetch (open-meteo)
  fetchWeather();

});

/* Calendar modal */
function openCalendar(){
  const html = `<div class="h"><strong>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</strong></div>
    <label>–î–∞—Ç–∞</label><input type="date" id="calDate" value="${new Date().toISOString().slice(0,10)}">
    <label>–í—Ä–µ–º—è</label><input type="time" id="calTime" value="12:00">
    <label>–ó–∞–º–µ—Ç–∫–∞</label><input id="calNote">
    <div class="small">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö (–ª–æ–∫–∞–ª—å–Ω–æ).</div>`;
  const actions = '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="addRem">–î–æ–±–∞–≤–∏—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ document.getElementById('addRem').addEventListener('click', ()=>{
    const d=el('calDate').value, t=el('calTime').value, note=el('calNote').value.trim();
    if(!d||!t) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
    state.notifications = state.notifications || [];
    state.notifications.unshift({id:Date.now(), text:`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${note||'–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}`, ts: new Date(d+'T'+t+':00').toISOString()});
    saveState(); setNotifCount(); closeModal(); alert('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
  }); },50);
}

/* Notifications modal */
function openNotifications(){
  const listHtml = (state.notifications||[]).map(n=>`<div style="padding:8px;border-bottom:1px solid var(--glass-border)"><div class="small">${new Date(n.ts||n.created||Date.now()).toLocaleString()}</div><div style="margin-top:6px">${n.text||''}</div></div>`).join('') || '<div class="small">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  const html = `<div class="h"><strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong></div><div style="max-height:320px;overflow:auto;margin-top:8px">${listHtml}</div>`;
  const actions = '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ el('clearNotifs').addEventListener('click', ()=>{ state.notifications=[]; saveState(); setNotifCount(); closeModal(); }); },50);
}

/* Weather fetch */
async function fetchWeather(){
  try{
    const lat=DEFAULT_CITY.lat, lon=DEFAULT_CITY.lon;
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fail');
    const d = await r.json();
    if(d && d.current_weather){ el('weatherBlock').textContent = `${Math.round(d.current_weather.temperature)} ¬∞C ¬∑ ${d.current_weather.weathercode}`; }
  }catch(e){ console.warn(e); el('weatherBlock').textContent='‚Äî ¬∞C'; }
}

/* helper file->base64 for file attachments */
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

/* DEBUG helpers - allow click of popup buttons (setFrom/fromSearch) works via global functions defined earlier */

/* Expose some globals for popups to use */
window.buildRoute = buildRoute;
window.setFromPoint = setFromPoint;
window.setToPoint = setToPoint;

/* End of script */
</script>
</body>
</html>
