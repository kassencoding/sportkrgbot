–ù–µ —Ç—Ä–æ–≥–∞—è –∫–æ–¥—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –Ω—É–∂–Ω—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å ‚Äú—Å–∏–Ω—Ö—Ä–∞–Ω–∏–∑–∞—Ü–∏–∏ –æ—à–∏–±–∫–∞‚Äù –Ω–∞ —Ñ–æ—Ç–æ. 
–ü–æ—Ç–æ–º —É–±–µ—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–æ–∑–ª–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å, –æ–Ω–∞ –∫–∞–∫ –±—É–¥—Ç–æ –º–µ—à–∞–µ—Ç. –ü–æ—Å—Ç–∞–≤—å –µ–µ –¥–ª–∏–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –Ω–∞–≤–µ—Ä—Ö –∫–Ω–æ–ø–∫–∏ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å. 
–ù–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è—è, –¥–æ–±–∞–≤—å –Ω–æ–≤—ã–µ –∫–æ–¥—ã —ç—Ç–∏ –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ –∫–æ—Ç–æ—Ä—ã–º —è –ø–∏—à—É! 
–ù–∞ —Ñ–æ—Ç–æ. –ü–æ—á–µ–º—É –≤–µ—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ —Ä–æ–≤–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä–µ, —Å–¥–µ–ª–∞–π –æ—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É, –ø–æ –±–æ–∫–∞–º –∏ —Å–Ω–∏–∑—É –°–¥–µ–ª–∞–π —á—Ç–æ–±—ã –æ–Ω–∞ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—Å—Ç–∞–ª–æ –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –æ–∫–æ—à–∫–∏ —á—Ç–æ–±—ã –∫—É–¥–∞ —Ç–æ –∑–∞ –∫—Ä–∞–π –Ω–µ —É—Ö–æ–¥–∏–ª–∏. 
–ú–∏–Ω–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–º–µ –∫–∞–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—ã–ª —Ä–æ–≤–Ω—ã–º –∏ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–º.
–í City —á–∞—Ç–µ –∫–æ–≥–¥–∞ –¥–µ–ª–∞–µ—à—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–æ–±–∞–≤—å –∫ –ø–æ—Å—Ç–∞–º ‚Äú–ª–∞–π–∫‚Äù, ‚Äú–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏‚Äù ( –ª—é–¥–∏ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –∏ –æ—Ç–≤–µ—á–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö). –ò —Ä–µ–ø–æ—Å—Ç—ã —á—Ç–æ–±—ã –º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º. 
–†–∞–∑–±–µ—Ä–∏—Å—å –≤ —á–µ–º –ø—Ä–∏—á–∏–Ω–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–Ω–æ–ø–∫–∏ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –±—ã–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –±–µ–∑ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏. 
–°–≤–µ—Ä—Ö—É –ø–æ —Å–µ—Ä–µ–¥–∏ —É–±–µ—Ä–∏ –≥–æ—Ä–æ–¥ (–æ–Ω–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è —Å —Ç–µ–º —á—Ç–æ –≤–Ω–∏–∑—É –∑–∞–≥–æ–ª–æ–≤–∫–∞) –∏ –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∫ –±—É–¥—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞ 1,5 —Å–µ–∫. –ø—Ä–∏ –≤—Ö–æ–¥–µ). –í–º–µ—Å—Ç–æ –Ω–∏—Ö –ø–æ—Å—Ç–∞–≤—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ—á–Ω—É—é —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É, –≤ –≤–∏–¥–µ ‚Äú–∫–Ω–æ–ø–∫–∏‚Äù –±–µ–∑ –∏–∫–æ–Ω–∫–∏) –∫–æ—Ç–æ—Ä–∞—è —Ä—è–¥–æ–º —Å ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–æ–π¬ª
–ü–æ–ª–æ—Å–∫–∏ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –º–æ–¥–∞–ª–æ–∫ –∏–ª–∏ –æ–∫–æ—à–∫–∞—Ö —Å–¥–µ–ª–∞–π —Ç–æ–∂–µ –ø–æ —Ü–≤–µ—Ç–∞ –∫–æ—Ç–æ—Ä–∞—è –≤—ã–±—Ä–∞–Ω–∞ –≤ —Ç–µ–º–∞—Ö. 
–¢–µ–º—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª—å–Ω–æ –º–µ–Ω—è—Ç—å —Ñ–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç. 
–ö–Ω–æ–ø–∫—É City —á–∞—Ç —Å–¥–µ–ª–∞–π —Ç–µ–º–Ω–æ –∑–µ–ª–µ–Ω—ã–º. –ê –∑–∞–∫–∞–∑–∞—Ç—å, –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã, –∑–∞–±—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–±—å—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ –∂–µ–ª—Ç—ã–º. –ù–µ —É–¥–∞–ª—è–π —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã —Ç–æ–ª—å–∫–æ –≤–Ω–æ—Å–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ñ–¥—É –ø–æ–ª–Ω—ã–π htmlüôèüèº –£–¥–∞—á–∏)

<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)</title>
<meta name="description" content="–ü—Ä–æ—Ç–æ—Ç–∏–ø –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è GiDCity ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–¥–∞–ª–∫–∏, –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ JSONBin (–¥–µ–º–æ).">
<style>
  /* ======================
     –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ ‚Äî —Å–∏–º–º–µ—Ç—Ä–∏—è –∏ —Ç–æ—á–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞
     ====================== */
  :root{
    --bg1: #5b2cff; /* default —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
    --bg2: #0a0a0a;
    --panel-bg: #0a0a0a;
    --accent: #ffd54a;
    --glass-bg: rgba(255,255,255,0.02);
    --glass-border: rgba(255,255,255,0.06);
    --text: #f2f2f2;
    --muted: rgba(242,242,242,0.62);
    --radius: 12px;
    --gap: 12px;
    --card-padding: 12px;
  }
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(160deg,var(--bg1) 0%, #2b0b3a 40%, var(--bg2) 100%);color:var(--text);-webkit-font-smoothing:antialiased;display:flex;align-items:center;justify-content:center;padding:12px;}
  /* phone frame */
  .phone{width:380px;max-width:calc(100% - 24px);height:812px;border-radius:30px;box-shadow:0 20px 60px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.03);overflow:hidden;position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.18));border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;}
  .header{padding:18px;display:flex;align-items:center;justify-content:space-between;gap:8px;backdrop-filter: blur(6px) saturate(120%);background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid rgba(255,255,255,0.03);}
  .title{display:flex;align-items:center;gap:12px;}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(91,44,255,0.15),0 1px 0 rgba(255,255,255,0.02) inset;border:1px solid var(--glass-border);position:relative;overflow:hidden;}
  .app-name{font-weight:800;font-size:20px;letter-spacing:0.6px;margin:0;}
  .subtitle{font-size:12px;color:var(--muted);margin-top:2px;}
  @keyframes title-glow{0%{text-shadow:0 0 0 rgba(255,255,255,0)}50%{text-shadow:0 0 18px rgba(91,44,255,0.75)}100%{text-shadow:0 0 0 rgba(255,255,255,0)}}
  .glow{animation:title-glow 2s infinite;}
  /* header center */
  .header-center{display:flex;flex-direction:column;align-items:center;gap:4px;}
  .header-center .city-label{font-size:14px;color:var(--muted);font-weight:700;}
  .header-center .greeting{font-size:12px;color:var(--muted);}
  .header-actions{display:flex;gap:8px;align-items:center;}
  .icon-btn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--glass-bg);border:1px solid var(--glass-border);backdrop-filter: blur(6px);cursor:pointer;}
  /* content */
  .content{padding:14px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto;}
  .city-row{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .city-block{display:flex;gap:12px;align-items:center;}
  .city-name{font-weight:700;font-size:18px;margin:0;}
  .weather{font-size:13px;color:var(--muted);background:var(--panel-bg);padding:8px 12px;border-radius:14px;border:1px solid var(--glass-border);min-width:120px;text-align:center;}
  /* toggle */
  .toggle{display:flex;gap:10px;background:var(--panel-bg);padding:8px;border-radius:14px;width:100%;border:1px solid var(--glass-border);}
  .toggle button{flex:1;padding:10px 6px;border-radius:10px;background:transparent;border:none;color:var(--muted);font-weight:800;cursor:pointer;}
  .toggle button.active{background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));color:var(--text);box-shadow:0 6px 18px rgba(0,0,0,0.4),0 0 12px rgba(255,205,95,0.06) inset;position:relative;}
  .toggle button.active::after{content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:40%;height:4px;border-radius:4px;background:var(--accent);box-shadow:0 6px 18px rgba(255,213,100,0.12);}
  /* main card */
  .main-card{margin-top:2px;background:var(--panel-bg);border-radius:18px;padding:12px;border:1px solid var(--glass-border);box-shadow:0 10px 30px rgba(0,0,0,0.45);min-height:240px;display:flex;gap:12px;align-items:flex-start;}
  .menu-list{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .menu-item{background:var(--panel-bg);padding:12px;border-radius:12px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:6px;min-height:78px;cursor:pointer;align-items:flex-start;justify-content:center;}
  .menu-item .caption{color:var(--muted);font-size:12px;}
  .menu-item .title{font-weight:900;font-size:16px;letter-spacing:0.6px;}
  .notifications-btn{width:72px;display:flex;flex-direction:column;align-items:center;gap:8px;}
  .notifications-btn .count{background:var(--accent);color:#111;font-weight:900;font-size:12px;padding:6px 8px;border-radius:12px;margin-top:4px;}
  /* footer */
  .footer{padding:10px 16px;text-align:center;font-size:11px;color:var(--muted);border-top:1px solid rgba(255,255,255,0.02);}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px;}
  .modal{width:100%;max-width:420px;border-radius:14px;background:linear-gradient(180deg,var(--panel-bg),#0b0b0b);border:1px solid var(--glass-border);padding:14px;box-shadow:0 30px 80px rgba(0,0,0,0.7);}
  .modal .h{font-weight:900;margin-bottom:8px;font-size:18px;}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px;}
  input[type="text"],input[type="tel"],input[type="password"],textarea,select,input[type="number"],input[type="date"],input[type="time"]{width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text);outline:none;}
  textarea{min-height:80px;resize:vertical;}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;}
  .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));color:var(--text);}
  .btn.primary{background:linear-gradient(90deg,#ffd54a,#ffb347);color:#111;}
  .small{font-size:13px;color:var(--muted);}
  .list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto;padding-right:6px;}
  .post{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);}
  .post .meta{font-size:12px;color:var(--muted);margin-bottom:6px;}
  .post-author{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
  .post-author img{width:36px;height:36px;border-radius:50%;object-fit:cover;}
  .post-author .author-name{font-weight:800;}
  .post-image{margin-top:8px;max-width:100%;border-radius:8px;display:block;}
  .attachment-thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--glass-border);}
  .required-note{color:#ffcc66;font-weight:700;margin-top:8px;}
  @media (max-width:420px){.phone{width:100%}}
  .hidden{display:none !important;}
  /* grid symmetry helpers: ensure even padding & centering */
  .centered{display:flex;align-items:center;justify-content:center;}
</style>
</head>
<body>

<!-- =========================
     –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤—Å–µ —á—Ç–æ –±—ã–ª–æ, –¥–æ–±–∞–≤–ª–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
     ========================= -->
<div class="phone" role="application" aria-label="GiDCity prototype">
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview" title="–ê–≤–∞—Ç–∞—Ä">
        <!-- –ª–æ–≥–æ—Ç–∏–ø -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="4" height="10" rx="1.2" fill="white" opacity="0.12"/>
          <rect x="9" y="4" width="4" height="13" rx="1.2" fill="white" opacity="0.12"/>
          <rect x="15" y="9" width="4" height="8" rx="1.2" fill="white" opacity="0.12"/>
          <circle cx="12" cy="3" r="3" fill="#ffd54a" opacity="0.9"/>
        </svg>
      </div>
      <div style="line-height:1;">
        <div class="app-name glow" id="appTitle">GiDCity</div>
        <div class="subtitle" id="subtitle">–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
      </div>
    </div>

    <div class="header-center">
      <div class="city-label" id="headerCityLabel">–≥–æ—Ä–æ–¥: –ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
      <div class="greeting" id="headerGreeting">GiDCity-“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!</div>
    </div>

    <div class="header-actions">
      <div class="icon-btn" id="calendarBtn" title="–ö–∞–ª–µ–Ω–¥–∞—Ä—å" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">üìÖ</div>
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
    </div>
  </div>

  <div class="content">
    <div class="city-row">
      <div class="city-block">
        <div>
          <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
          <div class="small" id="citySubtitle">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
        </div>
        <div class="weather" id="weatherBlock">‚Äî ¬∞C ¬∑ ‚Äî</div>
      </div>
      <div class="small">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: <span id="syncStatus">–ª–æ–∫–∞–ª—å–Ω–æ</span></div>
    </div>

    <div class="toggle" role="tablist" aria-label="–í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞">
      <button id="servicesBtn" class="active" aria-pressed="true">–£–°–õ–£–ì–ò</button>
      <button id="workBtn" aria-pressed="false">–†–ê–ë–û–¢–ê</button>
    </div>

    <div class="main-card" role="region" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
      <div class="menu-list" id="menuList"></div>

      <div class="notifications-btn">
        <div style="font-size:13px;color:var(--muted)">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="count" id="notifCount">0</div>
        <button class="btn" id="openNotifs">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="small">–®—Ä–∏—Ñ—Ç ‚Äî —Å—Ç–∏–ª—å iOS. –î–∏–∑–∞–π–Ω ‚Äî –º–∏–Ω–∏–º–∞–ª–∏–∑–º + —Ñ—É—Ç—É—Ä–∏–∑–º, –Ω–µ–æ–Ω –∏ —Å—Ç–µ–∫–ª–æ.</div>
  </div>

  <div class="footer">KASSEN Technology Inc.</div>
</div>

<!-- ---------------- MODALS ---------------- -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-hidden="true">
  <div class="modal" id="modalWindow" role="document" aria-modal="true"></div>
</div>

<!-- Auth modal -->
<div class="modal-backdrop" id="authBackdrop" style="display:flex;">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="h">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
    <div class="small">–î–ª—è –≤—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —á–µ—Ç—ã—Ä—ë—Ö–∑–Ω–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å (PIN)</div>
    <div style="height:10px"></div>

    <label for="authName">–ò–º—è</label>
    <input id="authName" type="text" placeholder="–í–∞—à–µ –∏–º—è">

    <label for="authPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
    <input id="authPhone" type="tel" placeholder="+7xxxxxxxxxx">

    <label for="authPIN">–ü–∞—Ä–æ–ª—å (4 —Ü–∏—Ñ—Ä—ã)</label>
    <input id="authPIN" type="password" maxlength="4" pattern="\d*" inputmode="numeric" placeholder="1234">

    <div class="modal-actions">
      <button class="btn" id="authSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button class="btn primary" id="authSubmit">–í–æ–π—Ç–∏</button>
    </div>

    <div style="height:10px"></div>
    <div class="small" style="color:#ffd54a">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</div>
  </div>
</div>

<!-- Hidden file inputs for media uploads (profile, chat, messenger, orders) -->
<input id="fileProfileAvatar" type="file" accept="image/*" class="hidden">
<input id="fileChatAttach" type="file" accept="image/*" class="hidden">
<input id="fileMessageAttach" type="file" accept="image/*" class="hidden">
<input id="fileOrderAttach" type="file" accept="image/*" class="hidden">

<script>
/* ================
   –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π JS: JSONBin sync (–∞–≤—Ç–æ), —Ç–µ–º—ã, –ø–æ–≥–æ–¥–∞, –º–µ–¥–∏–∞-–∞–ø–ª–æ–∞–¥, —Ç–æ—á–Ω–∞—è —Å–∏–º–º–µ—Ç—Ä–∏—è
   ================ */

/* ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è JSONBin (–æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ—é —Å—Ç—Ä–æ–∫—É) ---------- */
const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG';
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const USE_JSONBIN = true; // —Ç–µ–ø–µ—Ä—å –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è

/* ---------- –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ JSONBin –∏ localStorage) ---------- */
const appStateKey = 'gidcity_state_live_v1';
let state = {
  user: null,
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance: 0},
  reminders: []
};

/* ---------- –ö–∞—Ä—Ç–∞ –≥–æ—Ä–æ–¥ -> –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–¥–ª—è Open-Meteo) ---------- */
const CITY_COORDS = {
  "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞": {lat:49.8062, lon:73.0851},
  "–ù—É—Ä-–°—É–ª—Ç–∞–Ω": {lat:51.1605, lon:71.4704},
  "–ê–ª–º–∞—Ç—ã": {lat:43.2383, lon:76.9458},
  "–®—ã–º–∫–µ–Ω—Ç": {lat:42.3417, lon:69.5940},
  "–ê–∫—Ç–æ–±–µ": {lat:50.2839, lon:57.1660},
  "–ü–∞–≤–ª–æ–¥–∞—Ä": {lat:52.2867, lon:76.9679},
  "–ö–æ—Å—Ç–∞–Ω–∞–π": {lat:53.2148, lon:63.6248},
  "–ö—ã–∑—ã–ª–æ—Ä–¥–∞": {lat:44.8528, lon:65.4829},
  "–¢–∞—Ä–∞–∑": {lat:42.8972, lon:71.3667},
  "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫": {lat:54.8756, lon:69.1606},
  "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫": {lat:49.9721, lon:82.6157},
  "–ö–æ–∫—à–µ—Ç–∞—É": {lat:53.2823, lon:69.3937},
  "–°–µ–º–µ–π": {lat:50.4117, lon:80.2461},
  "–ê–∫—Ç–∞—É": {lat:43.6500, lon:51.2172},
  "–ê—Ç—ã—Ä–∞—É": {lat:47.1000, lon:51.8833},
  "–¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω": {lat:45.0117, lon:78.3783}
};

/* ---------- –¢–µ–º—ã: gradient top + black bottom ---------- */
const THEMES = {
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π': {top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a'},
  '—Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π': {top:'#0b3d91', bottom:'#061428', accent:'#55d4ff'},
  '–∫—Ä–∞—Å–Ω—ã–π': {top:'#ff416c', bottom:'#0a0a0a', accent:'#ffb37a'},
  '–æ—Ä–∞–Ω–∂–µ–≤—ã–π': {top:'#ff7a18', bottom:'#0a0a0a', accent:'#ffd54a'},
  '—Å–µ—Ä—ã–π': {top:'#6b6b6b', bottom:'#0a0a0a', accent:'#d0d0d0'},
  '–∑–µ–ª—ë–Ω—ã–π': {top:'#00b09b', bottom:'#0a0a0a', accent:'#a8ffcf'},
  '–±–µ–ª—ã–π': {top:'#ffffff', bottom:'#0a0a0a', accent:'#333333'},
  '–∂—ë–ª—Ç—ã–π': {top:'#ffd54a', bottom:'#0a0a0a', accent:'#111111'},
  '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π': {top:'#8b5e3c', bottom:'#0a0a0a', accent:'#ffd9b3'}
};

/* ---------- UI REFS ---------- */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalWindow = document.getElementById('modalWindow');
const authBackdrop = document.getElementById('authBackdrop');
const fileProfileAvatar = document.getElementById('fileProfileAvatar');
const fileChatAttach = document.getElementById('fileChatAttach');
const fileMessageAttach = document.getElementById('fileMessageAttach');
const fileOrderAttach = document.getElementById('fileOrderAttach');

/* ---------- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---------- */
function loadState(){
  const raw = localStorage.getItem(appStateKey);
  if(raw){
    try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn('parse state err', e); }
  }
}

/* ---------- –î–µ–±–∞—É–Ω—Å –∏ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ JSONBin ----------
   - –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ state –≤—ã–∑—ã–≤–∞–µ–º requestSave()
   - requestSave –≤—ã–ø–æ–ª–Ω—è–µ—Ç local save –∏ —á–µ—Ä–µ–∑ 1.2s –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ JSONBin
   - —Ç–∞–∫ –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã, –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å —Ç–µ–º –∂–µ Bin, –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—É—á–∞—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
*/
let saveTimer = null;
function requestSave(){
  // —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
  localStorage.setItem(appStateKey, JSON.stringify(state));
  document.getElementById('syncStatus').textContent = '–ª–æ–∫–∞–ª—å–Ω–æ';
  // debounce –¥–ª—è JSONBin
  if(!USE_JSONBIN) return;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{ syncToJSONBin().then(()=>{ document.getElementById('syncStatus').textContent = '—Å–∏–Ω—Ö—Ä. JSONBin'; }).catch(e=>{ document.getElementById('syncStatus').textContent = '–æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä.'; console.warn(e); }); }, 1200);
}

/* ---------- JSONBin —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (PUT whole state) ---------- */
async function syncToJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  const payload = {state, updatedAt: new Date().toISOString()};
  const resp = await fetch(url, {
    method: 'PUT',
    headers: {'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY},
    body: JSON.stringify(payload)
  });
  if(!resp.ok) throw new Error('JSONBin save failed');
  return resp.json();
}
async function loadFromJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const resp = await fetch(url, {headers:{'X-Master-Key':JSONBIN_KEY}});
  if(!resp.ok) throw new Error('JSONBin load failed');
  const data = await resp.json();
  if(data && data.record && data.record.state){
    state = data.record.state;
    localStorage.setItem(appStateKey, JSON.stringify(state));
    renderAll();
  }
  return data;
}

/* ---------- Helpers ---------- */
function addNotification(text, meta={}){
  state.notifications.unshift({id:Date.now(), text, meta, ts: new Date().toISOString()});
  requestSave();
  updateNotifCount();
}
function updateNotifCount(){ document.getElementById('notifCount').textContent = (state.notifications.length || 0); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Themes: applyTheme —Ä–∞–±–æ—Ç–∞–µ—Ç —Å THEMES –≤—ã—à–µ ---------- */
function applyTheme(name){
  const t = THEMES[name] || THEMES['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  document.documentElement.style.setProperty('--bg1', t.top);
  document.documentElement.style.setProperty('--bg2', t.bottom);
  document.documentElement.style.setProperty('--panel-bg', t.bottom);
  document.documentElement.style.setProperty('--accent', t.accent || '#ffd54a');
  // update header gradient too
  const phone = document.querySelector('.phone');
  phone.style.background = `linear-gradient(180deg, ${t.top} 0%, #2b0b3a 40%, ${t.bottom} 100%)`;
}

/* ---------- Weather: Open-Meteo (no key) ---------- */
async function fetchWeatherForCity(city){
  const coords = CITY_COORDS[city] || CITY_COORDS['–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'];
  if(!coords) return;
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fetch failed');
    const data = await r.json();
    if(data && data.current_weather){
      const temp = data.current_weather.temperature;
      const wc = mapWeatherCodeToText(data.current_weather.weathercode);
      document.getElementById('weatherBlock').textContent = `${Math.round(temp)} ¬∞C ¬∑ ${wc}`;
    }
  }catch(e){
    console.warn('weather error', e);
    document.getElementById('weatherBlock').textContent = '‚Äî ¬∞C ¬∑ ‚Äî';
  }
}
function mapWeatherCodeToText(code){
  // simplified mapping from Open-Meteo weathercode
  const map = {
    0:'—è—Å–Ω–æ', 1:'–º–∞–ª–æ–æ–±–ª–∞—á–Ω–æ', 2:'–æ–±–ª–∞—á–Ω–æ', 3:'–ø–∞—Å–º—É—Ä–Ω–æ',
    45:'—Ç—É–º–∞–Ω',48:'—à–ª–µ–π—Ñ—ã',51:'–º–æ—Ä–æ—Å—å',53:'–º–æ—Ä–æ—Å—å',55:'–º–æ–∫—Ä—ã–π —Å–Ω–µ–≥',
    61:'–Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å',63:'–¥–æ–∂–¥—å',65:'—Å–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
    71:'—Å–Ω–µ–≥',73:'—Å–Ω–µ–≥',75:'—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥',
    80:'–ª–∏–≤–µ–Ω—å',81:'–ª–∏–≤–µ–Ω—å',82:'—Å–∏–ª—å–Ω—ã–π –ª–∏–≤–µ–Ω—å'
  };
  return map[code] || '–Ω–µ–∏–∑–≤.';
}

/* ---------- Render menu items (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞) ---------- */
function renderMenuItems(){
  const menuList = document.getElementById('menuList');
  menuList.innerHTML = '';
  const activeSection = document.getElementById('servicesBtn').classList.contains('active') ? 'services' : 'work';

  const items = (activeSection === 'services') ? [
    {id:'order', title:'–ó–ê–ö–ê–ó–ê–¢–¨', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
    {id:'reserve', title:'–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨', caption:'—Å–∫–æ—Ä–æ...'},
    {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'},
    {id:'citychat', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ] : [
    {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫'},
    {id:'ads2', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'},
    {id:'citychat2', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger2', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet2', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'},
    {id:'spacer', title:'', caption:''}
  ];

  items.forEach(it=>{
    const el = document.createElement('div');
    el.className='menu-item';
    el.dataset.id = it.id;
    el.innerHTML = `<div style="width:100%;display:flex;justify-content:space-between;align-items:center;"><div><div class="title" style="font-weight:900">${it.title}</div><div class="caption">${it.caption}</div></div><div style="opacity:0.9">></div></div>`;
    if(it.id === 'spacer') el.style.visibility='hidden';
    el.addEventListener('click', ()=>onMenuClick(it.id, activeSection));
    menuList.appendChild(el);
  });
}

function renderAll(){
  document.getElementById('cityName').textContent = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞';
  document.getElementById('headerCityLabel').textContent = '–≥–æ—Ä–æ–¥: ' + (state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞');
  updateNotifCount();
  renderMenuItems();
  applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π');
  fetchWeatherForCity(state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞');
  // show avatar if exists
  if(state.user && state.user.avatar){
    document.getElementById('avatarPreview').innerHTML = `<img src="${state.user.avatar}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`;
  }
}

/* ---------- Events ---------- */
document.getElementById('servicesBtn').addEventListener('click', ()=>{
  document.getElementById('servicesBtn').classList.add('active'); document.getElementById('servicesBtn').setAttribute('aria-pressed','true');
  document.getElementById('workBtn').classList.remove('active'); document.getElementById('workBtn').setAttribute('aria-pressed','false');
  renderMenuItems();
});
document.getElementById('workBtn').addEventListener('click', ()=>{
  document.getElementById('workBtn').classList.add('active'); document.getElementById('workBtn').setAttribute('aria-pressed','true');
  document.getElementById('servicesBtn').classList.remove('active'); document.getElementById('servicesBtn').setAttribute('aria-pressed','false');
  renderMenuItems();
});
document.getElementById('calendarBtn').addEventListener('click', openCalendarModal);
document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
document.getElementById('openNotifs').addEventListener('click', openNotifications);
document.getElementById('authSubmit').addEventListener('click', doAuth);
document.getElementById('authSkip').addEventListener('click', ()=>{
  authBackdrop.style.display='none';
  // –µ—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏/—Ñ–∞–º–∏–ª–∏–∏ ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å
  loadState();
  renderAll();
  if(!state.user || !state.user.name || !state.user.surname) setTimeout(()=>openSettingsModal(true), 400);
});

/* ---------- menu click mapping (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏–∫—É) ---------- */
function onMenuClick(id, section){
  if(id === 'order'){ openOrderModal(); }
  else if(id === 'reserve'){ openReserveModal(); }
  else if(id === 'ads' || id === 'ads2'){ openAdsModal(); }
  else if(id === 'citychat' || id === 'citychat2'){ openCityChatModal(); }
  else if(id === 'messenger' || id === 'messenger2'){ openMessengerModal(); }
  else if(id === 'wallet' || id === 'wallet2'){ openWalletModal(); }
  else if(id === 'findJobs'){ openFindJobsModal(); }
}

/* ---------- Modal helpers ---------- */
function showModal(html){
  modalWindow.innerHTML = html;
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  modalWindow.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', hideModal));
}
function hideModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); modalWindow.innerHTML=''; }

/* ---------- Calendar / Reminders (–Ω–µ —Ç—Ä–æ–≥–∞–ª –ª–æ–≥–∏–∫—É) ---------- */
function openCalendarModal(){
  const modal = `
    <div class="h">–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî ${new Date().toLocaleString('ru',{month:'long', year:'numeric'})}</div>
    <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫—É ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</div>
    <div style="height:8px"></div>
    <label>–î–∞—Ç–∞</label><input type="date" id="remDate" value="${new Date().toISOString().slice(0,10)}">
    <label>–í—Ä–µ–º—è</label><input type="time" id="remTime" value="12:00">
    <label>–ó–∞–º–µ—Ç–∫–∞</label><input type="text" id="remNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–±—Ä–∞—Ç—å –ø–æ—Å—ã–ª–∫—É">
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="saveReminder">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button></div>
  `;
  showModal(modal);
  document.getElementById('saveReminder').addEventListener('click', ()=>{
    const d = document.getElementById('remDate').value;
    const t = document.getElementById('remTime').value;
    const note = document.getElementById('remNote').value || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ';
    if(!d || !t) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
    const dtISO = new Date(d + 'T' + t + ':00').toISOString();
    state.reminders.unshift({id:Date.now(), datetime:dtISO, note, read:false});
    addNotification('–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + note, {type:'reminder', when:dtISO});
    requestSave();
    hideModal();
    tryScheduleNotification(dtISO, note);
  });
}
function tryScheduleNotification(dtISO, text){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') Notification.requestPermission();
  const time = new Date(dtISO).getTime() - Date.now();
  if(time <= 60000 && time > -5000){
    if(Notification.permission === 'granted'){
      new Notification('GiDCity ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', {body:text});
    }
  } else {
    if(time > 0 && time < 1000*60*60*24*7){
      setTimeout(()=>{ if(Notification.permission === 'granted'){ new Notification('GiDCity ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', {body:text}); addNotification('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '+text); } }, time);
    }
  }
}

/* ---------- Settings modal (—Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –§–ò–û + –º–µ–¥–∏–∞–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞) ---------- */
function openSettingsModal(forceOpen){
  const icons = Object.keys(CITY_COORDS);
  const themeOptions = Object.keys(THEMES);
  const modal = `
    <div class="h">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="small">–ü—Ä–æ—Ñ–∏–ª—å (–ò–º—è –∏ –§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã)</div>
    <label>–ê–≤–∞—Ç–∞—Ä</label>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button class="btn" id="uploadAvatarBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button><img id="avatarPreviewSmall" src="" alt="avatar" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--glass-border)"></div>
    <label>–ò–º—è</label><input type="text" id="profileName" placeholder="–ò–º—è">
    <label>–§–∞–º–∏–ª–∏—è</label><input type="text" id="profileSurname" placeholder="–§–∞–º–∏–ª–∏—è">
    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="profilePhone" placeholder="+7...">
    <div style="height:8px"></div>
    <label>–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞</label><select id="citySelect">${icons.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
    <div style="height:8px"></div>
    <label>–¢–µ–º–∞</label><select id="themeSelect">${themeOptions.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div style="height:8px"></div>
    <div class="small required-note" id="requiredNote" style="display:none">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.</div>
  `;
  showModal(modal);

  // preload
  document.getElementById('profileName').value = (state.user && state.user.name) ? state.user.name : '';
  document.getElementById('profileSurname').value = (state.user && state.user.surname) ? state.user.surname : '';
  document.getElementById('profilePhone').value = (state.user && state.user.phone) ? state.user.phone : '';
  document.getElementById('citySelect').value = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞';
  document.getElementById('themeSelect').value = state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π';
  document.getElementById('avatarPreviewSmall').src = (state.user && state.user.avatar) ? state.user.avatar : 'https://via.placeholder.com/48/333333/ffffff?text=U';

  // avatar upload flow: open fileProfileAvatar
  document.getElementById('uploadAvatarBtn').addEventListener('click', ()=>{
    fileProfileAvatar.click();
  });
  fileProfileAvatar.onchange = async function(e){
    const f = e.target.files[0];
    if(!f) return;
    const b64 = await fileToBase64(f);
    document.getElementById('avatarPreviewSmall').src = b64;
    // store preview in field (will be saved when hitting Save)
    document.getElementById('avatarPreviewSmall').dataset.b64 = b64;
  };

  document.getElementById('saveSettings').addEventListener('click', ()=>{
    const avatarB64 = document.getElementById('avatarPreviewSmall').dataset ? document.getElementById('avatarPreviewSmall').dataset.b64 : null;
    const name = document.getElementById('profileName').value.trim();
    const surname = document.getElementById('profileSurname').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const city = document.getElementById('citySelect').value;
    const theme = document.getElementById('themeSelect').value;

    if(!name || !surname){
      document.getElementById('requiredNote').style.display='block';
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).');
      return;
    } else {
      document.getElementById('requiredNote').style.display='none';
    }

    state.user = state.user || {};
    if(avatarB64) state.user.avatar = avatarB64;
    state.user.name = name;
    state.user.surname = surname;
    state.user.phone = phone;
    state.city = city;
    state.theme = theme;
    // update UI
    if(state.user.avatar) document.getElementById('avatarPreview').innerHTML = `<img src="${state.user.avatar}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`;
    requestSave();
    hideModal();
    renderAll();
  });

  // if forced to open (e.g., after auth) and there is no name/surname -> keep modal open
  if(forceOpen && (!state.user || !state.user.name || !state.user.surname)){
    // do nothing, modal already open
  }
}

/* ---------- File to base64 helper ---------- */
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ---------- Notifications modal ---------- */
function openNotifications(){
  const list = state.notifications.map(n=>`<div class="post"><div class="meta">${new Date(n.ts).toLocaleString()}</div><div>${escapeHtml(n.text)}</div></div>`).join('') || '<div class="small">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  const modal = `<div class="h">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div class="list">${list}</div><div class="modal-actions"><button class="btn" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('clearNotifs').addEventListener('click', ()=>{
    state.notifications = [];
    requestSave();
    hideModal();
    renderAll();
  });
}

/* ---------- Order modal (–¥–æ–±–∞–≤–∏–ª –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–æ—Ç–æ) ---------- */
function openOrderModal(){
  const services = ['GiD –ó–∞–∫–∞–∑','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–¥–æ–º','–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–ú–∞—Å—Ç–µ—Ä/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'];
  const modal = `
    <div class="h">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</div>
    <label>–£—Å–ª—É–≥–∞</label>
    <select id="orderService">${services.map(s=>`<option>${s}</option>`).join('')}</select>
    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
    <textarea id="orderDesc" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É"></textarea>
    <div style="display:flex;gap:8px">
      <div style="flex:1"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="orderDeadline"></div>
      <div style="width:120px"><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input type="number" id="orderBudget" min="0" value="0"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button class="btn" id="attachOrderBtn">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <div id="orderAttachPreview"></div>
    </div>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="createOrder">–ó–∞–∫–∞–∑–∞—Ç—å</button></div>
  `;
  showModal(modal);
  document.getElementById('attachOrderBtn').addEventListener('click', ()=>{ fileOrderAttach.click(); });
  fileOrderAttach.onchange = async function(e){
    const f = e.target.files[0];
    if(!f) return;
    const b64 = await fileToBase64(f);
    document.getElementById('orderAttachPreview').innerHTML = `<img src="${b64}" style="width:72px;height:72px;border-radius:8px;object-fit:cover">`;
    document.getElementById('orderAttachPreview').dataset.b64 = b64;
  };

  document.getElementById('createOrder').addEventListener('click', ()=>{
    const svc = document.getElementById('orderService').value;
    const desc = document.getElementById('orderDesc').value.trim();
    const deadline = document.getElementById('orderDeadline').value;
    const budget = document.getElementById('orderBudget').value;
    const image = document.getElementById('orderAttachPreview').dataset ? document.getElementById('orderAttachPreview').dataset.b64 : null;
    if(!desc) return alert('–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É');
    const order = {id:Date.now(), svc, desc, deadline, budget, city:state.city, created: new Date().toISOString(), image};
    state.servicesPosts.unshift(order);
    addNotification('–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + svc, {type:'order', orderId:order.id});
    requestSave();
    hideModal();
    alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø).');
  });
}

/* ---------- Reserve modal (unchanged) ---------- */
function openReserveModal(){
  const modal = `<div class="h">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</div><div class="small">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∫ GiDCity</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
}

/* ---------- Ads modal (publishing announcements) ---------- */
function openAdsModal(){
  const cats = ['–í–∞–∫–∞–Ω—Å–∏–∏','–ë–∏–∑–Ω–µ—Å','–ê–∫—Ü–∏–∏','–ê—Ñ–∏—à–∞','–¢–æ–≤–∞—Ä—ã','–ü—Ä–æ–¥—É–∫—Ç—ã'];
  const modal = `<div class="h">–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥</div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="adsCat">${cats.map(c=>`<option>${c}</option>`).join('')}</select><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="adsTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"><label>–¢–µ–∫—Å—Ç</label><textarea id="adsText" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"></textarea><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="publishAds">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('publishAds').addEventListener('click', ()=>{
    const cat = document.getElementById('adsCat').value;
    const title = document.getElementById('adsTitle').value.trim();
    const text = document.getElementById('adsText').value.trim();
    if(!title || !text) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
    const authorName = state.user ? `${state.user.name || ''} ${state.user.surname || ''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    const authorAvatar = state.user && state.user.avatar ? state.user.avatar : null;
    const post = {id:Date.now(), cat, title, text, created: new Date().toISOString(), authorName, authorAvatar, city: state.city};
    state.cityPosts.unshift(post);
    requestSave();
    addNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ' + title);
    hideModal();
  });
}

/* ---------- City chat modal: —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –º–µ–¥–∏–∞—Ç–µ–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ —Å –∞–≤–∞—Ç–∞—Ä–æ–º (–∏–∑ state.user) ---------- */
function openCityChatModal(){
  const postsHtml = state.cityPosts.map(p=>{
    const author = p.authorName || (state.user ? `${state.user.name||''} ${state.user.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º');
    const avatar = p.authorAvatar || (state.user && state.user.avatar ? state.user.avatar : '');
    const imgHtml = p.image ? `<img src="${p.image}" class="post-image" alt="image">` : '';
    return `<div class="post"><div class="post-author"><img src="${avatar||'https://via.placeholder.com/36/333333/ffffff?text=U'}" alt="–∞–≤–∞—Ç–∞—Ä"><div class="author-name">${escapeHtml(author)}</div></div><div class="meta">${new Date(p.created).toLocaleString()}</div><div>${escapeHtml(p.text)}</div>${imgHtml}</div>`;
  }).join('') || '<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞—è</div>';
  const modal = `<div class="h">City —á–∞—Ç ‚Äî ${state.city}</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <div style="width:44px;height:44px;border-radius:10px;background:var(--glass-bg);display:flex;align-items:center;justify-content:center"><div style="font-weight:800;color:var(--muted)">${state.user && state.user.name ? state.user.name[0].toUpperCase() : 'U'}</div></div>
      <input id="cityPostText" type="text" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å..." style="flex:1">
      <button class="btn" id="attachImg">üìé</button>
    </div>
    <div id="attachedPreview" style="margin-bottom:8px"></div>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="publishCityPost">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
    <div style="height:10px"></div>
    <div class="list" id="cityPostsList">${postsHtml}</div>`;
  showModal(modal);

  // attach file input handler
  document.getElementById('attachImg').addEventListener('click', ()=>{ fileChatAttach.click(); });
  fileChatAttach.onchange = async function(e){
    const f = e.target.files[0];
    if(!f) return;
    const b64 = await fileToBase64(f);
    const preview = document.getElementById('attachedPreview');
    preview.innerHTML = `<img src="${b64}" style="max-width:120px;border-radius:8px">`;
    preview.dataset.b64 = b64;
  };

  document.getElementById('publishCityPost').addEventListener('click', ()=>{
    const text = document.getElementById('cityPostText').value.trim();
    const img = document.getElementById('attachedPreview') && document.getElementById('attachedPreview').dataset ? document.getElementById('attachedPreview').dataset.b64 : null;
    if(!text && !img) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const authorName = state.user ? `${state.user.name || ''} ${state.user.surname || ''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    const authorAvatar = state.user && state.user.avatar ? state.user.avatar : null;
    const post = { id: Date.now(), text, image: img || null, created: new Date().toISOString(), authorName, authorAvatar, city: state.city };
    state.cityPosts.unshift(post);
    requestSave();
    addNotification('–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ City —á–∞—Ç–µ');
    // update list live without closing modal
    const list = document.getElementById('cityPostsList');
    const newPostHtml = `<div class="post"><div class="post-author"><img src="${authorAvatar||'https://via.placeholder.com/36/333333/ffffff?text=U'}" alt="avatar"><div class="author-name">${escapeHtml(authorName)}</div></div><div class="meta">${new Date(post.created).toLocaleString()}</div><div>${escapeHtml(post.text)}</div>${post.image?`<img src="${post.image}" class="post-image">`:''}</div>`;
    list.insertAdjacentHTML('afterbegin', newPostHtml);
    // clear inputs
    document.getElementById('cityPostText').value = '';
    const preview = document.getElementById('attachedPreview');
    if(preview) { preview.innerHTML=''; delete preview.dataset.b64; }
  });
}

/* ---------- Messenger modal: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ---------- */
function openMessengerModal(){
  const chatsHtml = state.chats.map(c=>{
    const avatar = c.avatar || (state.user && state.user.avatar) || 'https://via.placeholder.com/36/333333/ffffff?text=C';
    return `<div class="post" data-chat-id="${c.id}" style="display:flex;gap:8px;align-items:center"><img src="${avatar}" style="width:44px;height:44px;border-radius:8px;object-fit:cover"><div style="flex:1"><div style="font-weight:800">${escapeHtml(c.name||c.contact||'–ö–æ–Ω—Ç–∞–∫—Ç')}</div><div class="small">${escapeHtml(c.last||'')}</div></div></div>`;
  }).join('') || '<div class="small">–°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –ø—É—Å—Ç</div>';
  const modal = `<div class="h">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div><div style="display:flex;gap:8px;margin-bottom:10px"><button class="btn" id="openContacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button><button class="btn" id="createChat">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button></div><div class="list" id="chatsList">${chatsHtml}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);

  // contacts listing
  document.getElementById('openContacts').addEventListener('click', ()=>{
    const contacts = state.chats.map(c => c.name || c.contact).filter(Boolean);
    const html = contacts.length ? contacts.map(c=>`<div class="post"><div class="meta">${escapeHtml(c)}</div></div>`).join('') : '<div class="small">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–µ—Ç</div>';
    showModal(`<div class="h">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="list">${html}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  });

  // create chat
  document.getElementById('createChat').addEventListener('click', ()=>{
    const name = prompt('–ò–º—è / –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞:');
    if(!name) return;
    // allow optional avatar upload
    const avatar = state.user && state.user.avatar ? state.user.avatar : null;
    state.chats.unshift({id:Date.now(), name, last:'–ù–æ–≤—ã–π —á–∞—Ç', avatar});
    requestSave();
    hideModal();
    openMessengerModal();
  });

  // allow clicking on a chat to open simple chat UI
  document.getElementById('chatsList').querySelectorAll('[data-chat-id]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id = el.dataset.chatId;
      openChatWindow(id);
    });
  });
}

/* ---------- Chat window (simple) ---------- */
function openChatWindow(chatId){
  const chat = state.chats.find(c=>String(c.id)===String(chatId));
  if(!chat) return alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const messages = chat.messages || [];
  const messagesHtml = messages.map(m=>`<div class="post"><div class="post-author"><img src="${m.avatar||'https://via.placeholder.com/36/333333/ffffff?text=U'}"><div class="author-name">${escapeHtml(m.name||'')}</div></div><div class="meta">${new Date(m.ts).toLocaleString()}</div><div>${escapeHtml(m.text)}</div>${m.image?`<img src="${m.image}" class="post-image">`:''}</div>`).join('') || '<div class="small">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  const modal = `<div class="h">${escapeHtml(chat.name || chat.contact)}</div>
    <div class="list" id="chatMessages">${messagesHtml}</div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px"><input id="chatMsgText" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1"><button class="btn" id="attachMsg">üìé</button><button class="btn primary" id="sendMsg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
    <div id="msgAttachPreview" style="margin-top:8px"></div>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);

  document.getElementById('attachMsg').addEventListener('click', ()=>{ fileMessageAttach.click(); });
  fileMessageAttach.onchange = async function(e){
    const f = e.target.files[0];
    if(!f) return;
    const b64 = await fileToBase64(f);
    document.getElementById('msgAttachPreview').innerHTML = `<img src="${b64}" style="max-width:120px;border-radius:8px">`;
    document.getElementById('msgAttachPreview').dataset.b64 = b64;
  };

  document.getElementById('sendMsg').addEventListener('click', ()=>{
    const text = document.getElementById('chatMsgText').value.trim();
    const image = document.getElementById('msgAttachPreview').dataset ? document.getElementById('msgAttachPreview').dataset.b64 : null;
    if(!text && !image) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const message = {name: state.user ? (state.user.name + ' ' + (state.user.surname||'')) : '–í—ã', text, ts: new Date().toISOString(), avatar: state.user && state.user.avatar ? state.user.avatar : null, image};
    chat.messages = chat.messages || [];
    chat.messages.push(message);
    chat.last = text || (image ? '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '');
    requestSave();
    // append to UI live
    const list = document.getElementById('chatMessages');
    const html = `<div class="post"><div class="post-author"><img src="${message.avatar||'https://via.placeholder.com/36/333333/ffffff?text=U'}"><div class="author-name">${escapeHtml(message.name)}</div></div><div class="meta">${new Date(message.ts).toLocaleString()}</div><div>${escapeHtml(message.text)}</div>${message.image?`<img src="${message.image}" class="post-image">`:''}</div>`;
    list.insertAdjacentHTML('beforeend', html);
    document.getElementById('chatMsgText').value='';
    const preview = document.getElementById('msgAttachPreview'); if(preview){ preview.innerHTML=''; delete preview.dataset.b64; }
  });
}

/* ---------- Wallet modal (unchanged) ---------- */
function openWalletModal(){
  const modal = `<div class="h">–ö–æ—à–µ–ª—ë–∫</div><div style="font-size:26px;font-weight:900">${state.wallet.balance || 0} ‚Ç∏</div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="walletTransfer">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button><button class="btn" id="walletTopup">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button><button class="btn" id="walletWithdraw">–°–Ω—è—Ç—å</button></div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('walletTopup').addEventListener('click', ()=>{
    const sum = parseInt(prompt('–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚Ç∏):')||'0',10);
    if(sum>0){ state.wallet.balance = (state.wallet.balance||0) + sum; requestSave(); alert('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'); hideModal(); openWalletModal(); }
  });
  document.getElementById('walletTransfer').addEventListener('click', ()=>{
    const to = prompt('–ö–æ–º—É (–Ω–æ–º–µ—Ä):');
    const sum = parseInt(prompt('–°—É–º–º–∞ (‚Ç∏):')||'0',10);
    if(!to || sum<=0) return;
    if((state.wallet.balance||0) < sum) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
    state.wallet.balance -= sum;
    requestSave();
    addNotification(`–ü–µ—Ä–µ–≤–æ–¥ ${sum}‚Ç∏ –Ω–∞ ${to}`);
    hideModal();
  });
  document.getElementById('walletWithdraw').addEventListener('click', ()=>{
    const sum = parseInt(prompt('–°—É–º–º–∞ —Å–Ω—è—Ç–∏—è (‚Ç∏):')||'0',10);
    if(sum>0 && (state.wallet.balance||0) >= sum){ state.wallet.balance -= sum; requestSave(); alert('–°–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ'); hideModal(); openWalletModal(); }
    else alert('–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è');
  });
}

/* ---------- Find jobs modal (unchanged) ---------- */
function openFindJobsModal(){
  const jobs = state.servicesPosts.map(o=>`<div class="post"><div class="meta">${o.svc} ¬∑ ${o.deadline || ''}</div><div style="font-weight:700">${escapeHtml(o.desc)}</div><div class="small">–ë—é–¥–∂–µ—Ç ${o.budget} ‚Ç∏</div><div style="margin-top:8px"><button class="btn" onclick="applyJob(${o.id})">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button></div>${o.image?`<img src="${o.image}" class="post-image">`:''}</div>`).join('') || '<div class="small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>';
  const modal = `<div class="h">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã</div><div class="small">–õ–µ–Ω—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–¥–µ–º–æ)</div><div style="height:8px"></div><div class="list">${jobs}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
}
window.applyJob = function(orderId){
  const budget = prompt('–í–∞—à –±—é–¥–∂–µ—Ç (‚Ç∏):','0');
  const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:','');
  const order = state.servicesPosts.find(o=>o.id == orderId);
  if(!order) return alert('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  addNotification(`–û—Ç–∫–ª–∏–∫ –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É (${order.svc}): ${budget}‚Ç∏ ‚Äî ${comment}`, {type:'proposal', orderId});
  requestSave();
  hideModal();
  alert('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¥–µ–º–æ).');
}

/* ---------- Auth flow: –ø—Ä–∏ –≤—Ö–æ–¥–µ —Ç—Ä–µ–±—É–µ—Ç –∏–º—è/—Ñ–∞–º–∏–ª–∏—é (–µ—Å–ª–∏ –Ω–µ—Ç) ---------- */
function doAuth(){
  const name = document.getElementById('authName').value.trim();
  const phone = document.getElementById('authPhone').value.trim();
  const pin = document.getElementById('authPIN').value.trim();
  if(!name || !phone || !/^\d{4}$/.test(pin)) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ 4-–∑–Ω–∞—á–Ω—ã–π PIN');
  state.user = state.user || {};
  state.user.name = name;
  state.user.phone = phone;
  state.user.pin = pin;
  requestSave();
  addNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª: ' + name);
  authBackdrop.style.display = 'none';
  renderAll();
  // —Å—Ä–∞–∑—É –ø–æ–ø—Ä–æ—Å–∏–º —Ñ–∞–º–∏–ª–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç
  if(!state.user.surname) setTimeout(()=>openSettingsModal(true), 300);
}

/* ---------- file -> base64 helper (–ø–æ–≤—Ç–æ—Ä—è–µ–º) ---------- */
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ---------- file input handlers, –≥–ª–æ–±–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ state.user –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞ ---------- */
fileProfileAvatar.onchange = async function(e){
  const f = e.target.files[0];
  if(!f) return;
  const b64 = await fileToBase64(f);
  // set in settings preview and immediate save
  state.user = state.user || {};
  state.user.avatar = b64;
  requestSave();
  document.getElementById('avatarPreview').innerHTML = `<img src="${b64}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`;
};

/* ---------- Initial load: try to load remote state, then fallback to local ---------- */
(async function init(){
  loadState();
  // try to load from JSONBin first so all users share data
  if(USE_JSONBIN){
    try{
      await loadFromJSONBin();
      console.log('state loaded from JSONBin');
    } catch(e){
      console.info('No remote state or error, using local state', e);
    }
  }
  renderAll();

  // Weather initial fetch
  if(state.city) fetchWeatherForCity(state.city);

  // If missing mandatory profile (surname/name) after auth or stored: force settings open
  if(state.user && (!state.user.name || !state.user.surname)){
    setTimeout(()=>openSettingsModal(true), 400);
  }

  // greeting animation sequence (–≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ)
  const headerGreeting = document.getElementById('headerGreeting');
  const greets = ['GiDCity-“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GiDCity!', '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!'];
  let idx = 0;
  setInterval(()=>{ idx = (idx+1) % greets.length; headerGreeting.textContent = greets[idx]; }, 2500);
})();

/* ---------- Close modal on backdrop click ---------- */
modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) hideModal(); });

/* ---------- Expose requestSave for other scripts (used earlier) ---------- */
window.requestSave = requestSave;

</script>
</body>
</html>