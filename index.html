<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø (—Å –∫–∞—Ä—Ç–æ–π –∏ JSONBin)</title>
<meta name="description" content="GiDCity prototype with JSONBin sync, OpenRouteService routing, media uploads.">
<!-- Leaflet CSS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
<style>
  :root{
    --bg1: #5b2cff;
    --bg2: #0a0a0a;
    --panel-bg: #0a0a0a;
    --accent: #ffd54a;
    --glass-bg: rgba(255,255,255,0.02);
    --glass-border: rgba(255,255,255,0.06);
    --text: #f2f2f2;
    --muted: rgba(242,242,242,0.62);
    --radius: 12px;
    --gap: 12px;
  }
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(160deg,var(--bg1) 0%, #2b0b3a 40%, var(--bg2) 100%);color:var(--text);-webkit-font-smoothing:antialiased;display:flex;align-items:center;justify-content:center;padding:12px;}
  .phone{width:380px;max-width:calc(100% - 24px);height:812px;border-radius:30px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.18));}
  /* fixed top header */
  .header{position:sticky;top:0;z-index:30;padding:14px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,0.03);}
  .title{display:flex;align-items:center;gap:12px;}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid var(--glass-border);}
  .app-name{font-weight:800;font-size:20px;margin:0;}
  .header-center{display:flex;flex-direction:column;align-items:center;gap:4px;}
  .header-actions{display:flex;gap:8px;align-items:center;}
  .icon-btn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--glass-bg);border:1px solid var(--glass-border);cursor:pointer;}
  .content{padding:12px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto;}
  .city-row{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .city-block{display:flex;gap:12px;align-items:center;}
  .city-name{font-weight:700;font-size:18px;margin:0;}
  .weather{font-size:13px;color:var(--muted);background:var(--panel-bg);padding:8px 12px;border-radius:14px;border:1px solid var(--glass-border);min-width:120px;text-align:center;}
  /* tabs simplified */
  .toggle{display:flex;gap:10px;background:var(--panel-bg);padding:8px;border-radius:14px;border:1px solid var(--glass-border);position:relative;}
  .toggle button{flex:1;padding:10px 8px;border-radius:10px;background:transparent;border:none;color:var(--muted);font-weight:800;cursor:pointer;}
  .toggle button.active{color:var(--text);}
  /* main card vertical list for symmetry */
  .main-card{margin-top:6px;background:var(--panel-bg);border-radius:14px;padding:12px;border:1px solid var(--glass-border);box-shadow:0 8px 20px rgba(0,0,0,0.45);display:flex;flex-direction:column;gap:12px;}
  .notif-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .notif-left{font-weight:800;font-size:16px;}
  .menu-list{display:flex;flex-direction:column;gap:10px;}
  .menu-item{background:rgba(255,255,255,0.01);padding:18px;border-radius:12px;border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
  .menu-item .title{font-weight:900;font-size:18px;}
  .menu-item .caption{color:var(--muted);font-size:13px}
  .footer{padding:12px;text-align:center;font-size:12px;color:var(--muted);border-top:1px solid rgba(255,255,255,0.02)}
  /* modal backdrop */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px;}
  .modal{width:100%;max-width:420px;border-radius:12px;background:linear-gradient(180deg,var(--panel-bg),#0b0b0b);border:1px solid var(--glass-border);padding:14px;box-shadow:0 30px 80px rgba(0,0,0,0.7);}
  .modal .h{font-weight:900;margin-bottom:8px;font-size:18px;}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text);outline:none;box-sizing:border-box;}
  .modal-actions{display:flex;gap:8px;justify-content:space-between;margin-top:12px;}
  .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));color:var(--text);}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#ffb347);color:#111;}
  .small{font-size:13px;color:var(--muted);}
  .post{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px;}
  .post-author{display:flex;align-items:center;gap:8px;}
  .post-author img{width:36px;height:36px;border-radius:50%;object-fit:cover;}
  .post-actions{display:flex;gap:12px;align-items:center;color:var(--muted);font-weight:700;}
  .map-container{height:240px;border-radius:12px;overflow:hidden;border:1px solid var(--glass-border)}
  /* small helpers */
  .hidden{display:none !important;}
  @media (max-width:420px){.phone{width:100%}}
</style>
</head>
<body>

<div class="phone" role="application" aria-label="GiDCity">
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview">
        <img id="avatarImg" src="https://via.placeholder.com/48/333333/fff?text=U" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:8px">
      </div>
      <div>
        <div class="app-name" id="appTitle">GiDCity</div>
        <div class="small">–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
      </div>
    </div>

    <div class="header-center" id="headerCenter">
      <!-- NOTE: greeting removed from persistent; kept minimal -->
      <div id="dateButton" class="icon-btn" style="padding:8px 12px;border-radius:18px;background:var(--panel-bg);font-weight:800">17 –Ω–æ—è–± 2025</div>
    </div>

    <div class="header-actions">
      <div class="icon-btn" id="calendarBtn" title="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">üìÖ</div>
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
    </div>
  </div>

  <div class="content">
    <div class="city-row">
      <div class="city-block">
        <div>
          <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
          <div class="small" id="citySubtitle">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
        </div>
        <div class="weather" id="weatherBlock">‚Äî ¬∞C ¬∑ ‚Äî</div>
      </div>
      <div class="small" id="syncSmall">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: –ª–æ–∫–∞–ª—å–Ω–æ</div>
    </div>

    <div class="toggle" role="tablist" aria-label="–í—ã–±–æ—Ä">
      <button id="servicesBtn" class="active">–£–°–õ–£–ì–ò</button>
      <button id="workBtn">–†–ê–ë–û–¢–ê</button>
    </div>

    <div class="main-card" role="region" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
      <!-- —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–≤–µ—Ä—Ö—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
      <div class="notif-row" id="notifRow">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="notif-left">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span class="small" style="margin-left:8px;color:var(--muted)">–ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</span></div>
          <div style="display:flex;gap:8px;align-items:center"><div id="notifDot" style="background:var(--accent);color:#111;padding:6px 10px;border-radius:14px;font-weight:800">0</div></div>
        </div>
        <div><button class="btn" id="openNotifs">–û—Ç–∫—Ä—ã—Ç—å</button></div>
      </div>

      <div class="menu-list" id="menuList" aria-live="polite">
        <!-- menu items are filled by JS -->
      </div>

      <!-- map preview fixed inside main card (optional) -->
      <div class="map-container" id="mapContainer"></div>
    </div>

    <div class="small" id="bottomNote">KASSEN Technology Inc.</div>
  </div>

  <div class="footer" id="footerSync">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: –ª–æ–∫–∞–ª—å–Ω–æ. (JSONBin)</div>
</div>

<!-- modals -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-hidden="true">
  <div class="modal" id="modalWindow" role="document" aria-modal="true"></div>
</div>

<!-- auth modal shown initially -->
<div class="modal-backdrop" id="authBackdrop" style="display:flex;">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="h">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
    <div class="small">–î–ª—è –≤—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ PIN (4 —Ü–∏—Ñ—Ä—ã)</div>
    <label for="authName">–ò–º—è</label>
    <input id="authName" type="text" placeholder="–í–∞—à–µ –∏–º—è">
    <label for="authPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
    <input id="authPhone" type="tel" placeholder="+7...">
    <label for="authPIN">PIN</label>
    <input id="authPIN" type="password" maxlength="4" inputmode="numeric" placeholder="1234">
    <div class="modal-actions">
      <!-- primary left, cancel right -->
      <button class="btn primary" id="authSubmit">–í–æ–π—Ç–∏</button>
      <button class="btn" id="authSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
    <div class="small" style="color:var(--accent);margin-top:8px">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</div>
  </div>
</div>

<!-- hidden file inputs -->
<input id="fileProfileAvatar" type="file" accept="image/*" class="hidden">
<input id="fileChatAttach" type="file" accept="image/*" class="hidden">
<input id="fileMessageAttach" type="file" accept="image/*" class="hidden">
<input id="fileOrderAttach" type="file" accept="image/*" class="hidden">

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   GiDCity enhanced script
   - JSONBin sync + periodic pull
   - OpenRouteService routing (ORS_API_KEY included)
   - Leaflet map for routes
   - UI changes requested
   ========================= */

/* ----- CONFIG (you provided the key) ----- */
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjcyZWNiZDAxMGJlNTRjY2E4NDQwYTVlYmM2N2U1NzdkIiwiaCI6Im11cm11cjY0In0=';
const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG';
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const PULL_INTERVAL_MS = 8000; // periodic pull every 8s (respect rate limits)

/* ----- App state ----- */
const appStateKey = 'gidcity_state_live_v2';
let state = {
  user: null,
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance:0},
  reminders: []
};

/* ----- City coords for weather and map ----- */
const CITY_COORDS = {
  "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞": {lat:49.8062, lon:73.0851},
  "–ù—É—Ä-–°—É–ª—Ç–∞–Ω": {lat:51.1605, lon:71.4704},
  "–ê–ª–º–∞—Ç—ã": {lat:43.2383, lon:76.9458}
  // add more if needed
};

/* ----- THEMES ----- */
const THEMES = {
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π': {top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a'},
  '—Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π': {top:'#0b3d91', bottom:'#061428', accent:'#55d4ff'},
  '–∫—Ä–∞—Å–Ω—ã–π': {top:'#ff416c', bottom:'#0a0a0a', accent:'#ffb37a'},
  '–æ—Ä–∞–Ω–∂–µ–≤—ã–π': {top:'#ff7a18', bottom:'#0a0a0a', accent:'#ffd54a'},
  '–∑–µ–ª—ë–Ω—ã–π': {top:'#00b09b', bottom:'#0a0a0a', accent:'#a8ffcf'}
};

/* ----- UI refs ----- */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalWindow = document.getElementById('modalWindow');
const authBackdrop = document.getElementById('authBackdrop');
const fileProfileAvatar = document.getElementById('fileProfileAvatar');
const fileChatAttach = document.getElementById('fileChatAttach');
const fileMessageAttach = document.getElementById('fileMessageAttach');
const fileOrderAttach = document.getElementById('fileOrderAttach');

const menuListEl = document.getElementById('menuList');
const notifDot = document.getElementById('notifDot');
const notifRow = document.getElementById('notifRow');
const mapContainer = document.getElementById('mapContainer');
const footerSync = document.getElementById('footerSync');
const syncSmall = document.getElementById('syncSmall');

/* --------- Helpers --------- */
function saveLocal(){ localStorage.setItem(appStateKey, JSON.stringify(state)); }
function loadLocal(){ const raw = localStorage.getItem(appStateKey); if(raw){ try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); } } }
function updateNotifCount(){ notifDot.textContent = (state.notifications.length || 0); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ----- JSONBin sync: save & load ----- */
let saveTimer = null;
function requestSave(){
  saveLocal();
  footerSync.textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: –ª–æ–∫–∞–ª—å–Ω–æ';
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{ syncToJSONBin().then(()=>{ footerSync.textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: —Å–∏–Ω—Ö—Ä. JSONBin'; }).catch(e=>{ footerSync.textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä.'; console.warn(e); }); }, 1200);
}

async function syncToJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  const payload = { state, updatedAt: new Date().toISOString() };
  const resp = await fetch(url, { method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY}, body: JSON.stringify(payload) });
  if(!resp.ok) throw new Error('JSONBin save failed');
  return resp.json();
}

let pulling = false;
async function loadFromJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const resp = await fetch(url, { headers: {'X-Master-Key': JSONBIN_KEY} });
  if(!resp.ok) throw new Error('JSONBin load failed');
  const data = await resp.json();
  if(data && data.record && data.record.state){
    state = data.record.state;
    saveLocal();
    renderAll();
  }
  return data;
}

/* periodic pull (to reduce conflicts) */
let pullIntervalHandle = null;
async function startPeriodicPull(ms = PULL_INTERVAL_MS){
  if(pullIntervalHandle) clearInterval(pullIntervalHandle);
  pullIntervalHandle = setInterval(async ()=>{
    if(pulling) return;
    pulling = true;
    try{
      await loadFromJSONBin();
      //console.log('pulled remote state');
    }catch(e){
      //console.warn('pull error', e);
    } finally { pulling = false; }
  }, ms);
}

/* ----- Themes apply ----- */
function applyTheme(name){
  const t = THEMES[name] || THEMES['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  document.documentElement.style.setProperty('--bg1', t.top);
  document.documentElement.style.setProperty('--bg2', t.bottom);
  document.documentElement.style.setProperty('--panel-bg', t.bottom);
  document.documentElement.style.setProperty('--accent', t.accent);
}

/* ----- Weather (open-meteo) ----- */
async function fetchWeatherForCity(city){
  const coords = CITY_COORDS[city] || CITY_COORDS['–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'];
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`;
    const r = await fetch(url);
    if(r.ok){
      const data = await r.json();
      if(data && data.current_weather){
        document.getElementById('weatherBlock').textContent = `${Math.round(data.current_weather.temperature)} ¬∞C ¬∑ ${mapWeatherCodeToText(data.current_weather.weathercode)}`;
      }
    }
  }catch(e){
    document.getElementById('weatherBlock').textContent = '‚Äî ¬∞C ¬∑ ‚Äî';
  }
}
function mapWeatherCodeToText(code){
  const map = {0:'—è—Å–Ω–æ',1:'–º–∞–ª–æ–æ–±–ª',2:'–æ–±–ª–∞—á–Ω–æ',3:'–ø–∞—Å–º—É—Ä–Ω–æ',45:'—Ç—É–º–∞–Ω',61:'–¥–æ–∂–¥—å',71:'—Å–Ω–µ–≥'};
  return map[code]||'–Ω–µ–∏–∑–≤.';
}

/* ----- Map & routing (Leaflet + ORS) ----- */
let map = null;
let routeLayer = null;
function initMap(){
  if(map) return;
  map = L.map('mapContainer', {zoomControl:false}).setView([49.8062,73.0851], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(map);
}
async function buildRoute(fromLatLon, toLatLon){
  if(!ORS_API_KEY) return alert('ORS key missing');
  const url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';
  const body = { coordinates: [ [fromLatLon[1], fromLatLon[0]], [toLatLon[1], toLatLon[0]] ] }; // ORS expects [lon,lat]
  try{
    const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': ORS_API_KEY }, body: JSON.stringify(body) });
    if(!r.ok) throw new Error('ors route failed');
    const geo = await r.json();
    if(routeLayer) routeLayer.remove();
    routeLayer = L.geoJSON(geo, { style:{ color:'#ffd54a', weight:5, opacity:0.9 } }).addTo(map);
    map.fitBounds(routeLayer.getBounds(), {padding:[20,20]});
    // extract distance/time from properties if present
    const summary = (geo.features && geo.features[0] && geo.features[0].properties && geo.features[0].properties.summary) || null;
    return summary;
  }catch(e){
    console.warn(e);
    return null;
  }
}

/* ----- Render menu as vertical list (symmetry) ----- */
function renderMenuItems(){
  menuListEl.innerHTML = '';
  const isServices = document.getElementById('servicesBtn').classList.contains('active');
  const items = isServices ? [
    {id:'order', title:'–ó–ê–ö–ê–ó–ê–¢–¨', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É', color:'gold'},
    {id:'reserve', title:'–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨', caption:'—Å–∫–æ—Ä–æ...', color:'gold'},
    {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π', color:'gold'},
    {id:'citychat', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ]:[
    {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫', color:'gold'},
    {id:'ads2', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π', color:'gold'},
    {id:'citychat2', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger2', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet2', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ];

  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'menu-item';
    el.dataset.id = it.id;
    el.innerHTML = `<div>
                      <div class="title" style="color:${it.color? (it.color==='gold'? 'var(--accent)': it.color): '#fff'}">${it.title}</div>
                      <div class="caption">${it.caption}</div>
                    </div>
                    <div style="opacity:0.9">‚Ä∫</div>`;
    el.addEventListener('click', ()=>onMenuClick(it.id));
    menuListEl.appendChild(el);
  });
}

/* ----- Event mapping ----- */
document.getElementById('servicesBtn').addEventListener('click', ()=>{
  document.getElementById('servicesBtn').classList.add('active');
  document.getElementById('workBtn').classList.remove('active');
  renderMenuItems();
});
document.getElementById('workBtn').addEventListener('click', ()=>{
  document.getElementById('workBtn').classList.add('active');
  document.getElementById('servicesBtn').classList.remove('active');
  renderMenuItems();
});
document.getElementById('calendarBtn').addEventListener('click', openCalendarModal);
document.getElementById('settingsBtn').addEventListener('click', ()=>openSettingsModal(false));
document.getElementById('openNotifs').addEventListener('click', openNotifications);
document.getElementById('authSubmit').addEventListener('click', doAuth);
document.getElementById('authSkip').addEventListener('click', ()=>{ authBackdrop.style.display='none'; renderAll(); if(!state.user || !state.user.surname) setTimeout(()=>openSettingsModal(true),400); });

/* ----- Menu actions ----- */
function onMenuClick(id){
  if(id==='order') openOrderModal();
  else if(id==='reserve') openReserveModal();
  else if(id==='ads' || id==='ads2') openAdsModal();
  else if(id==='citychat' || id==='citychat2') openCityChatModal();
  else if(id==='messenger' || id==='messenger2') openMessengerModal();
  else if(id==='wallet' || id==='wallet2') openWalletModal();
  else if(id==='findJobs') openFindJobsModal();
}

/* ----- Modal open/close helpers ----- */
function showModal(html){
  modalWindow.innerHTML = html;
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  // attach data-close listeners if exist
  modalWindow.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', hideModal));
}
function hideModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); modalWindow.innerHTML=''; }

/* ----- Calendar & reminders ----- */
function openCalendarModal(){
  const modal = `
    <div class="h">–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî ${new Date().toLocaleString('ru',{month:'long', year:'numeric'})}</div>
    <label>–î–∞—Ç–∞</label><input type="date" id="remDate" value="${new Date().toISOString().slice(0,10)}">
    <label>–í—Ä–µ–º—è</label><input type="time" id="remTime" value="12:00">
    <label>–ó–∞–º–µ—Ç–∫–∞</label><input type="text" id="remNote" placeholder="–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ">
    <div class="modal-actions">
      <button class="btn primary" id="saveReminder">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>`;
  showModal(modal);
  document.getElementById('saveReminder').addEventListener('click', ()=>{
    const d = document.getElementById('remDate').value;
    const t = document.getElementById('remTime').value;
    const note = document.getElementById('remNote').value || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ';
    if(!d || !t) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
    const dt = new Date(d+'T'+t+':00').toISOString();
    state.reminders.unshift({id:Date.now(), datetime: dt, note, read:false});
    addNotification('–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '+note);
    requestSave();
    hideModal();
  });
}

/* ----- Settings modal (avatar via mediapicker) ----- */
function openSettingsModal(forceOpen){
  const cities = Object.keys(CITY_COORDS);
  const themeNames = Object.keys(THEMES);
  const modal = `
    <div class="h">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <label>–ê–≤–∞—Ç–∞—Ä</label>
    <div style="display:flex;gap:8px;align-items:center"><button class="btn" id="uploadAvatarBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button><img id="avatarPreviewSmall" src="${state.user && state.user.avatar ? state.user.avatar : 'https://via.placeholder.com/48/333/fff?text=U'}" style="width:48px;height:48px;border-radius:8px;object-fit:cover"></div>
    <label>–ò–º—è</label><input type="text" id="profileName" value="${escapeHtml(state.user && state.user.name || '')}">
    <label>–§–∞–º–∏–ª–∏—è</label><input type="text" id="profileSurname" value="${escapeHtml(state.user && state.user.surname || '')}">
    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="profilePhone" value="${escapeHtml(state.user && state.user.phone || '')}">
    <label>–ì–æ—Ä–æ–¥</label><select id="citySelect">${cities.map(c=>`<option ${c===state.city? 'selected':''}>${c}</option>`).join('')}</select>
    <label>–¢–µ–º–∞</label><select id="themeSelect">${themeNames.map(t=>`<option ${t===state.theme? 'selected':''} value="${t}">${t}</option>`).join('')}</select>
    <div class="modal-actions">
      <button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="small" id="requiredNote" style="display:none;color:var(--accent)">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.</div>
  `;
  showModal(modal);

  document.getElementById('uploadAvatarBtn').addEventListener('click', ()=> fileProfileAvatar.click());
  fileProfileAvatar.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const b64 = await fileToBase64(f);
    document.getElementById('avatarPreviewSmall').src = b64;
    document.getElementById('avatarPreviewSmall').dataset.b64 = b64;
  };

  document.getElementById('saveSettings').addEventListener('click', ()=>{
    const name = document.getElementById('profileName').value.trim();
    const sur = document.getElementById('profileSurname').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const city = document.getElementById('citySelect').value;
    const theme = document.getElementById('themeSelect').value;
    const avatarB64 = document.getElementById('avatarPreviewSmall').dataset ? document.getElementById('avatarPreviewSmall').dataset.b64 : null;
    if(!name || !sur){ document.getElementById('requiredNote').style.display='block'; return; }
    state.user = state.user || {};
    if(avatarB64) state.user.avatar = avatarB64;
    state.user.name = name;
    state.user.surname = sur;
    state.user.phone = phone;
    state.city = city;
    state.theme = theme;
    if(state.user.avatar) document.getElementById('avatarImg').src = state.user.avatar;
    applyTheme(theme);
    requestSave();
    hideModal();
    renderAll();
  });
}

/* ----- Notifications modal ----- */
function openNotifications(){
  const list = state.notifications.map(n=>`<div class="post"><div class="meta">${new Date(n.ts).toLocaleString()}</div><div>${escapeHtml(n.text)}</div></div>`).join('') || '<div class="small">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  const modal = `<div class="h">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div class="list">${list}</div><div class="modal-actions"><button class="btn" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('clearNotifs').addEventListener('click', ()=>{ state.notifications = []; requestSave(); hideModal(); renderAll(); });
}

/* ----- Order modal with attach ----- */
function openOrderModal(){
  const modal = `
    <div class="h">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</div>
    <label>–£—Å–ª—É–≥–∞</label>
    <select id="orderService"><option>GiD –ó–∞–∫–∞–∑</option><option>–ö–≤–∞—Ä—Ç–∏—Ä–∞/–¥–æ–º</option><option>–¢–∞–∫—Å–∏</option><option>–ö—É—Ä—å–µ—Ä</option><option>–ú–∞—Å—Ç–µ—Ä/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</option></select>
    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="orderDesc"></textarea>
    <div style="display:flex;gap:8px">
      <div style="flex:1"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="orderDeadline"></div>
      <div style="width:120px"><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input type="number" id="orderBudget" min="0" value="0"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button class="btn" id="attachOrderBtn">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <div id="orderAttachPreview"></div>
    </div>
    <div class="modal-actions">
      <button class="btn primary" id="createOrder">–ó–∞–∫–∞–∑–∞—Ç—å</button>
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>`;
  showModal(modal);
  document.getElementById('attachOrderBtn').addEventListener('click', ()=> fileOrderAttach.click());
  fileOrderAttach.onchange = async (e)=>{ const f = e.target.files[0]; if(!f) return; const b = await fileToBase64(f); document.getElementById('orderAttachPreview').innerHTML = `<img src="${b}" style="width:72px;height:72px;border-radius:8px;object-fit:cover">`; document.getElementById('orderAttachPreview').dataset.b64 = b; };

  document.getElementById('createOrder').addEventListener('click', ()=>{
    const svc = document.getElementById('orderService').value;
    const desc = document.getElementById('orderDesc').value.trim();
    const dl = document.getElementById('orderDeadline').value;
    const budget = document.getElementById('orderBudget').value;
    const img = document.getElementById('orderAttachPreview').dataset ? document.getElementById('orderAttachPreview').dataset.b64 : null;
    if(!desc) return alert('–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É');
    const order = { id: Date.now(), svc, desc, deadline:dl, budget, created: new Date().toISOString(), city: state.city, image: img };
    state.servicesPosts.unshift(order);
    addNotification('–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + svc);
    requestSave();
    hideModal();
    alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø).');
  });
}

/* ----- Reserve modal ----- */
function openReserveModal(){ showModal(`<div class="h">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</div><div class="small">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∫ GiDCity</div><div class="modal-actions"><button class="btn primary" data-close>OK</button></div>`); }

/* ----- Ads modal ----- */
function openAdsModal(){
  const modal = `<div class="h">–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥</div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="adsCat"><option>–í–∞–∫–∞–Ω—Å–∏–∏</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ê–∫—Ü–∏–∏</option></select><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="adsTitle"><label>–¢–µ–∫—Å—Ç</label><textarea id="adsText"></textarea><div class="modal-actions"><button class="btn primary" id="publishAds">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('publishAds').addEventListener('click', ()=>{
    const cat = document.getElementById('adsCat').value;
    const title = document.getElementById('adsTitle').value.trim();
    const text = document.getElementById('adsText').value.trim();
    if(!title || !text) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
    const post = { id:Date.now(), cat, title, text, created: new Date().toISOString(), authorName: state.user ? `${state.user.name} ${state.user.surname}` : '–ê–Ω–æ–Ω–∏–º', authorAvatar: state.user && state.user.avatar ? state.user.avatar : null, city: state.city, likes:0, comments:0, reposts:0 };
    state.cityPosts.unshift(post);
    addNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: '+title);
    requestSave();
    hideModal();
  });
}

/* ----- City chat (with likes/comments/reposts, attach) ----- */
function openCityChatModal(){
  function renderPostsHtml(){
    return state.cityPosts.map(p=>{
      const author = p.authorName || (state.user ? `${state.user.name} ${state.user.surname}` : '–ê–Ω–æ–Ω–∏–º');
      const avatar = p.authorAvatar || (state.user && state.user.avatar) || 'https://via.placeholder.com/36/333/fff?text=U';
      return `<div class="post" data-id="${p.id}">
          <div class="post-author"><img src="${avatar}"><div style="display:flex;flex-direction:column"><div style="font-weight:800">${escapeHtml(author)}</div><div class="small">${new Date(p.created).toLocaleString()}</div></div></div>
          <div>${escapeHtml(p.text || p.title || '')}</div>
          ${p.image? `<img src="${p.image}" style="max-width:100%;border-radius:8px">`:''}
          <div class="post-actions">
            <span data-action="like" data-id="${p.id}">‚ù§ ${p.likes||0}</span>
            <span data-action="comment" data-id="${p.id}">üí¨ ${p.comments||0}</span>
            <span data-action="repost" data-id="${p.id}">‚§¥ ${p.reposts||0}</span>
          </div>
        </div>`;
    }).join('') || '<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞—è</div>';
  }
  const modal = `<div class="h">City —á–∞—Ç ‚Äî ${state.city}</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <img src="${state.user && state.user.avatar ? state.user.avatar : 'https://via.placeholder.com/36/333/fff?text=U'}" style="width:44px;height:44px;border-radius:8px;object-fit:cover">
      <input id="cityPostText" type="text" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å...">
      <button class="btn" id="attachImg">üìé</button>
    </div>
    <div id="attachedPreview"></div>
    <div class="modal-actions">
      <button class="btn primary" id="publishCityPost">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="height:10px"></div>
    <div class="list" id="cityPostsList">${renderPostsHtml()}</div>`;
  showModal(modal);

  fileChatAttach.onchange = async (e)=>{ const f = e.target.files[0]; if(!f) return; const b = await fileToBase64(f); document.getElementById('attachedPreview').innerHTML = `<img src="${b}" style="max-width:120px;border-radius:8px">`; document.getElementById('attachedPreview').dataset.b64 = b; };
  document.getElementById('attachImg').addEventListener('click', ()=> fileChatAttach.click());
  document.getElementById('publishCityPost').addEventListener('click', ()=>{
    const text = document.getElementById('cityPostText').value.trim();
    const img = document.getElementById('attachedPreview').dataset ? document.getElementById('attachedPreview').dataset.b64 : null;
    if(!text && !img) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const post = { id:Date.now(), text, image: img, created: new Date().toISOString(), authorName: state.user ? `${state.user.name} ${state.user.surname}` : '–ê–Ω–æ–Ω–∏–º', authorAvatar: state.user && state.user.avatar ? state.user.avatar : null, likes:0, comments:0, reposts:0, city:state.city };
    state.cityPosts.unshift(post);
    requestSave();
    addNotification('–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ City —á–∞—Ç–µ');
    // refresh post list
    document.getElementById('cityPostsList').insertAdjacentHTML('afterbegin', `<div class="post" data-id="${post.id}"><div class="post-author"><img src="${post.authorAvatar||'https://via.placeholder.com/36/333/fff?text=U'}"><div style="display:flex;flex-direction:column"><div style="font-weight:800">${escapeHtml(post.authorName)}</div><div class="small">${new Date(post.created).toLocaleString()}</div></div></div><div>${escapeHtml(post.text)}</div>${post.image?`<img src="${post.image}" style="max-width:100%;border-radius:8px">`:''}<div class="post-actions"><span data-action="like" data-id="${post.id}">‚ù§ 0</span><span data-action="comment" data-id="${post.id}">üí¨ 0</span><span data-action="repost" data-id="${post.id}">‚§¥ 0</span></div></div>`);
    document.getElementById('cityPostText').value=''; document.getElementById('attachedPreview').innerHTML=''; delete document.getElementById('attachedPreview').dataset.b64;
  });

  // delegate actions (like/comment/repost)
  modalWindow.addEventListener('click', function onPostAction(e){
    const target = e.target.closest('[data-action]');
    if(!target) return;
    const action = target.dataset.action;
    const id = target.dataset.id;
    const post = state.cityPosts.find(p=>String(p.id)===String(id));
    if(!post) return;
    if(action==='like'){ post.likes = (post.likes||0)+1; }
    if(action==='comment'){ const c = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:'); if(c) post.comments = (post.comments||0)+1; }
    if(action==='repost'){ post.reposts = (post.reposts||0)+1; alert('–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¥–µ–º–æ)'); }
    requestSave();
    // update UI counters in modal
    const span = modalWindow.querySelector(`[data-action="${action}"][data-id="${id}"]`);
    if(span) span.textContent = (action==='like' ? '‚ù§ ' + post.likes : action==='comment' ? 'üí¨ ' + post.comments : '‚§¥ ' + post.reposts);
  }, {once:false});
}

/* ----- Messenger (simple) ----- */
function openMessengerModal(){
  const chatsHtml = state.chats.map(c=>`<div class="post" data-chat-id="${c.id}" style="display:flex;gap:8px;align-items:center"><img src="${c.avatar||'https://via.placeholder.com/36/333/fff?text=C'}" style="width:44px;height:44px;border-radius:8px"><div style="flex:1"><div style="font-weight:800">${escapeHtml(c.name||c.contact||'–ö–æ–Ω—Ç–∞–∫—Ç')}</div><div class="small">${escapeHtml(c.last||'')}</div></div></div>`).join('') || '<div class="small">–°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –ø—É—Å—Ç</div>';
  const modal = `<div class="h">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div><div style="display:flex;gap:8px;margin-bottom:10px"><button class="btn" id="openContacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button><button class="btn" id="createChat">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button></div><div class="list" id="chatsList">${chatsHtml}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('createChat').addEventListener('click', ()=>{
    const name = prompt('–ò–º—è / –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞:');
    if(!name) return;
    state.chats.unshift({id:Date.now(), name, last:'–ù–æ–≤—ã–π —á–∞—Ç', avatar: state.user && state.user.avatar || null, messages:[]});
    requestSave();
    hideModal(); openMessengerModal();
  });
  document.getElementById('openContacts').addEventListener('click', ()=>{
    const contacts = state.chats.map(c=>c.name||c.contact).filter(Boolean);
    showModal(`<div class="h">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="list">${contacts.map(c=>`<div class="post">${escapeHtml(c)}</div>`).join('')}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  });
}

/* ----- Wallet ----- */
function openWalletModal(){
  const modal = `<div class="h">–ö–æ—à–µ–ª—ë–∫</div><div style="font-size:26px;font-weight:900">${state.wallet.balance||0} ‚Ç∏</div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="walletTransfer">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button><button class="btn" id="walletTopup">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button><button class="btn" id="walletWithdraw">–°–Ω—è—Ç—å</button></div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('walletTopup').addEventListener('click', ()=>{ const s = parseInt(prompt('–°—É–º–º–∞ (‚Ç∏):')||'0',10); if(s>0){ state.wallet.balance = (state.wallet.balance||0) + s; requestSave(); hideModal(); openWalletModal(); }});
  document.getElementById('walletTransfer').addEventListener('click', ()=>{ const to=prompt('–ö–æ–º—É (–Ω–æ–º–µ—Ä):'); const s=parseInt(prompt('–°—É–º–º–∞:')||'0',10); if(to && s>0 && (state.wallet.balance||0)>=s){ state.wallet.balance -= s; addNotification(`–ü–µ—Ä–µ–≤–æ–¥ ${s}‚Ç∏ –Ω–∞ ${to}`); requestSave(); hideModal(); }});
  document.getElementById('walletWithdraw').addEventListener('click', ()=>{ const s=parseInt(prompt('–°—É–º–º–∞:')||'0',10); if(s>0 && (state.wallet.balance||0)>=s){ state.wallet.balance -= s; requestSave(); hideModal(); openWalletModal(); }});
}

/* ----- Find jobs modal ----- */
function openFindJobsModal(){
  const jobs = state.servicesPosts.map(o=>`<div class="post"><div class="meta">${escapeHtml(o.svc)} ¬∑ ${escapeHtml(o.deadline||'')}</div><div style="font-weight:700">${escapeHtml(o.desc)}</div><div class="small">–ë—é–¥–∂–µ—Ç ${o.budget} ‚Ç∏</div><div style="margin-top:8px"><button class="btn" onclick="applyJob(${o.id})">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button></div>${o.image?`<img src="${o.image}" style="max-width:100%;border-radius:8px">`:''}</div>`).join('') || '<div class="small">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
  showModal(`<div class="h">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã</div><div class="list">${jobs}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
}
window.applyJob = function(orderId){
  const budget = prompt('–í–∞—à –±—é–¥–∂–µ—Ç (‚Ç∏):','0'); const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:','');
  const order = state.servicesPosts.find(o=>o.id==orderId); if(!order) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ');
  addNotification(`–û—Ç–∫–ª–∏–∫ –Ω–∞ ${order.svc}: ${budget}‚Ç∏ ‚Äî ${comment}`);
  requestSave();
  hideModal();
  alert('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¥–µ–º–æ).');
}

/* ----- Auth ----- */
function doAuth(){
  const name = document.getElementById('authName').value.trim();
  const phone = document.getElementById('authPhone').value.trim();
  const pin = document.getElementById('authPIN').value.trim();
  if(!name || !phone || !/^\d{4}$/.test(pin)) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ 4-–∑–Ω–∞—á–Ω—ã–π PIN');
  state.user = state.user || {};
  state.user.name = name; state.user.phone = phone; state.user.pin = pin;
  requestSave();
  addNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª: ' + name);
  authBackdrop.style.display = 'none';
  renderAll();
  if(!state.user.surname) setTimeout(()=>openSettingsModal(true),300);
}

/* ----- Utilities ----- */
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function addNotification(text, meta={}){ state.notifications.unshift({id:Date.now(), text, meta, ts:new Date().toISOString()}); updateNotifCount(); requestSave(); }

/* ----- Render All UI ----- */
function renderAll(){
  document.getElementById('cityName').textContent = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞';
  document.getElementById('avatarImg').src = (state.user && state.user.avatar) ? state.user.avatar : 'https://via.placeholder.com/48/333/fff?text=U';
  applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π');
  updateNotifCount();
  renderMenuItems();
  fetchWeatherForCity(state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞');
  if(!map) initMap();
}

/* ----- Initial load & periodic pull ----- */
(async function init(){
  loadLocal();
  renderAll();
  try{ await loadFromJSONBin(); }catch(e){ /* fallback to local */ }
  renderAll();
  // start periodic pull
  startPeriodicPull(PULL_INTERVAL_MS);
  // init map
  initMap();
  // set header date button
  document.getElementById('dateButton').textContent = new Date().toLocaleString('ru',{day:'2-digit',month:'short',year:'numeric'});
})();

/* ----- Modal backdrop close on click outside ----- */
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) hideModal(); });

</script>
</body>
</html>