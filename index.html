<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiD City ‚Äî –°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥ & –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22;
  --surface:rgba(20,24,40,.88); --glass:rgba(255,255,255,.06);
  --line:rgba(160,170,230,.18);
  --accent-a:#a970ff; --accent-b:#32ffd2;
  --gold:#ffd84d; --danger:#ff6b70;
  --text:#fff; --muted:#9aa6d9;
  --radius:14px; --shadow:0 16px 46px rgba(0,0,0,.45);
  --ui-font:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --ui-font-size:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:var(--ui-font-size) var(--ui-font); color:var(--text);
  background:linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.wrapper{ max-width:980px; margin:16px auto; display:flex; flex-direction:column; gap:12px; padding:0 12px; }

/* Header */
.header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.brand{ display:flex; gap:8px; align-items:center; }
.brand h1{ margin:0; font-size:20px; font-weight:800; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); -webkit-background-clip:text; color:transparent; }
.buildInfo{ font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; margin-left:8px; }
.buildInfo .weather{ font-size:14px; }
.header-right{ display:flex; gap:8px; align-items:center; }

/* Top controls (roles) */
.topbar{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
.role-tabs{ display:flex; gap:8px; width:100%; }
.role-tab{ flex:1; padding:12px 14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); font-weight:900; text-align:center; cursor:pointer; user-select:none; }
.role-tab.active{ background:var(--gold); color:#0b0f18; border-color:rgba(0,0,0,.08); box-shadow:0 6px 20px rgba(255,216,77,.10) }

/* Container + menu */
.container{ border-radius:16px; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden }
.panel-top{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.02) }
.panel-top h2{ margin:0; font-size:16px; font-weight:900; display:flex; gap:8px; align-items:center; }
#notifBtn{ margin-left:8px; position:relative; }
#notifBadge{ position:absolute; top:-8px; right:-8px; background:var(--danger); color:#fff; padding:2px 6px; border-radius:999px; font-size:11px; font-weight:900; display:none; }

.menu-grid{ padding:14px; display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); align-items:stretch; }
.menu-btn{ display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.12)); cursor:pointer; }
.menu-btn .title{ font-weight:900 }
.menu-btn.dark{ background:linear-gradient(180deg, rgba(0,0,0,.4), rgba(0,0,0,.6)); color:var(--muted); border-color:rgba(255,255,255,.02); }

/* Modal / screen */
.screen{ position:fixed; inset:0; display:none; z-index:60; align-items:flex-start; justify-content:center; padding:12px; background:rgba(0,0,0,.45); backdrop-filter:blur(6px); }
.screen.active{ display:flex; }
.modal{ width:100%; max-width:980px; max-height:88vh; overflow:auto; background:var(--surface); border-radius:12px; border:1px solid var(--line); padding:14px }

/* Inputs */
.input, textarea, select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(12,16,36,.7); color:var(--text); outline:none; font-size:14px; }
textarea{ min-height:120px; resize:vertical }

/* City thread */
.city-composer{ position:sticky; top:12px; z-index:10; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.03); display:flex; gap:8px; flex-direction:column; transition:all .18s ease; }
.city-composer.compact{ padding:6px; transform:scale(.99); opacity:.95 }
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.04); border-radius:12px; padding:10px; margin-bottom:10px; }
.post-img{ width:100%; border-radius:8px; margin-top:8px; max-height:360px; object-fit:cover; }

/* Messenger top fixed row */
.chat-top-row{ display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); width:100%; box-sizing:border-box; position:sticky; top:14px; z-index:20; }
.chat-top-row .avatar{ width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent-a),var(--accent-b)); color:#fff; font-weight:900; }
.chat-top-row .share{ flex:1; text-align:left; padding-left:8px; color:var(--muted); cursor:text; }

/* Messages: left/right */
.msgs{ margin-top:12px; max-height:56vh; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:8px; }
.msg{ padding:10px 14px; border-radius:14px; max-width:78%; word-break:break-word; box-shadow:0 8px 18px rgba(0,0,0,.35); }
.msg.other{ align-self:flex-start; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.06)); border:1px solid var(--line); color:var(--text); }
.msg.me{ align-self:flex-end; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#071020; font-weight:900; }

/* Buttons */
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; padding:8px 12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08)); border:1px solid var(--line); color:var(--text); }
.btn.primary{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#081018; }
.btn.ghost{ background:transparent; border:1px dashed var(--line); }

/* Welcome overlay tweaks */
#welcomeOverlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:80; background:rgba(0,0,0,.6); backdrop-filter:blur(6px); }
#welcomeCard{ width:92%; max-width:540px; padding:18px; border-radius:18px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); box-shadow:var(--shadow); text-align:center; }
#welcomeOk{ min-width:220px; padding:12px 18px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); font-weight:900; }

/* small footer */
.footer-note{ font-size:11px; color:var(--muted); text-align:center; margin-top:10px; opacity:0.85; }
@media (max-width:720px){
  .role-tab{ font-size:13px; padding:10px; }
  #welcomeOk{ width:100%; }
}
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiDCity</h1>
      <div class="buildInfo" id="buildInfo">
        <div id="dateTime">--.--.-- --:--</div>
        <div class="weather" id="weather">‚òÄÔ∏è 18¬∞C</div>
      </div>
    </div>

    <div class="header-right">
      <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </header>

  <div class="topbar">
    <div id="roleTabs" class="role-tabs"></div>
  </div>

  <main class="container" role="main" aria-live="polite">
    <div class="panel-top">
      <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
      <div>
        <button id="notifBtn" class="btn">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifBadge">0</span></button>
      </div>
    </div>

    <div id="menuGrid" class="menu-grid"></div>
  </main>

  <div class="footer-note" id="footerNote">KASSEN Technology Inc</div>
</div>

<!-- WELCOME -->
<div id="welcomeOverlay" style="display:none">
  <div id="welcomeCard">
    <h2 style="margin:0 0 8px 0; font-weight:900; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); -webkit-background-clip:text; color:transparent">GiDCity-“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!</h2>
    <div style="color:var(--muted); margin-bottom:14px">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GiDCity!</div>
    <button id="welcomeOk" class="btn primary">–ù–∞—á–∞—Ç—å</button>
  </div>
</div>

<!-- NOTIFICATIONS -->
<section id="notificationsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('notificationsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="notificationsList" style="margin-top:12px"></div>
</div></section>

<!-- CITY THREAD -->
<section id="cityThreadScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3><button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="cityScroll" style="margin-top:10px; max-height:74vh; overflow:auto; padding-right:8px;">
    <div id="cityComposer" class="city-composer">
      <textarea id="cityPostText" class="input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—å—é..." style="min-height:140px"></textarea>
      <div style="display:flex; gap:8px; justify-content:flex-end; align-items:center">
        <label class="btn">üì∑<input type="file" id="cityPostImage" accept="image/*" style="display:none"></label>
        <button id="cityPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      </div>
    </div>
    <div id="cityPosts" style="margin-top:12px"></div>
  </div>
</div></section>

<!-- CREATE ORDER -->
<section id="createScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ó–ê–ö–ê–ó–ê–¢–¨</h3><button onclick="closeScreen('createScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button>
  </div>
  <div style="margin-top:10px;">
    <div id="createTabs" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px"></div>
    <form id="createForm">
      <textarea id="c-desc" class="input" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É: —á—Ç–æ, –≥–¥–µ, —Å—Ä–æ–∫–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
      <div style="margin-top:8px;" id="criteriaWrap"></div>
      <div id="createExtraFields" style="margin-top:8px"></div>
      <div style="display:flex; gap:8px; align-items:flex-end; margin-top:8px; flex-wrap:wrap">
        <div style="flex:1; min-width:220px">
          <label style="font-size:12px; color:var(--muted)">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
          <input id="c-datetime" class="input" type="datetime-local">
        </div>
        <div style="width:160px">
          <label style="font-size:12px; color:var(--muted)">–ë—é–¥–∂–µ—Ç (‚Ç∏)</label>
          <input id="c-budget" class="input" type="number" required>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn primary" type="submit">–ó–ê–ö–ê–ó–ê–¢–¨</button>
        <button class="btn ghost" type="button" onclick="closeScreen('createScreen')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div></section>

<!-- FIND ORDERS -->
<section id="findScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´</h3><button onclick="closeScreen('findScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div style="margin-top:10px;">
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫...">
      <select id="filterCat" class="input" style="max-width:240px">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
      <button id="applySearch" class="btn">–§–∏–ª—å—Ç—Ä</button>
    </div>
    <div id="findList" style="margin-top:12px"></div>
  </div>
</div></section>

<!-- OFFER modal (–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É) -->
<section id="offerModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É</h3><button onclick="closeScreen('offerModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <form id="offerForm" style="margin-top:12px; display:grid; gap:8px;">
    <div><label style="font-size:12px; color:var(--muted)">–¶–µ–Ω–∞ (‚Ç∏)</label><input id="offerPrice" class="input" type="number" required></div>
    <div><label style="font-size:12px; color:var(--muted)">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><textarea id="offerComment" class="input"></textarea></div>
    <div style="display:flex; gap:8px">
      <button class="btn primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
      <button class="btn ghost" type="button" onclick="closeScreen('offerModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </form>
</div></section>

<!-- BIDS modal -->
<section id="bidsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 id="bidsTitle" style="margin:0">–ó–∞—è–≤–∫–∏</h3><button onclick="closeScreen('bidsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="bidsList" style="margin-top:12px"></div>
</div></section>

<!-- MESSENGER -->
<section id="messengerScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center; flex-direction:column; gap:8px;">
    <div style="width:100%;" class="chat-top-row">
      <div style="display:flex; gap:10px; align-items:center;">
        <div id="myChatAvatar" class="avatar">–Ø</div>
        <div style="display:flex; flex-direction:column">
          <div id="myChatName" style="font-weight:900">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
          <div style="font-size:12px; color:var(--muted)">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
        </div>
      </div>
      <div class="share" id="chatSharePlaceholder">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å...</div>
    </div>

    <div style="width:100%; display:flex; gap:12px;">
      <div style="flex:1;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3>
          <div>
            <button id="createChatBtn" class="btn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
          </div>
        </div>
        <div id="chatsList" style="margin-top:12px"></div>
      </div>
      <div style="width:340px;">
        <h4 style="margin:0 0 8px 0">–¢–µ–∫—É—â–∏–π —á–∞—Ç</h4>
        <div id="chatWindowArea" style="border:1px solid var(--line); border-radius:10px; padding:10px; min-height:220px; display:flex; flex-direction:column;">
          <div id="chatWinMsgs" class="msgs"></div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <input id="chatWinInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="chatWinSend" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div style="width:100%; display:flex; justify-content:flex-end;"><button onclick="closeScreen('messengerScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div></section>

<!-- Quick post modal -->
<section id="quickPostModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center"><h3 style="margin:0">–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3><button onclick="closeScreen('quickPostModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div style="margin-top:10px;">
    <textarea id="quickPostText" class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button id="quickPostSend" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div></section>

<!-- Chat create picker -->
<section id="createChatScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h3><button onclick="closeScreen('createChatScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="chatPicker" style="margin-top:12px"></div>
</div></section>

<div style="height:20px"></div>

<script>
/* ====== Simple state and helpers ====== */
const LS='gid_state_v4';
const JSONBIN = { ENABLED:true, BIN_ID:'6911fbe843b1c97be9a4dc97', KEY:'$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG' };
const $ = id => document.getElementById(id);
const uid = () => Math.random().toString(36).slice(2,9);
const nowISO = () => new Date().toISOString();

let STATE = {
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  role: 'user', // user | worker
  theme: 'violet',
  profile: { id: 'u_me', name: '–í—ã', avatarType:'emoji', avatarData:'ü§ñ' },
  orders: [],
  feed: {},
  notifs: [],
  chats: []
};

/* ====== date/time + simple weather emoji (local) ====== */
function updateDateTimeWeather(){
  const dt = new Date();
  const hh = dt.getHours();
  const mins = String(dt.getMinutes()).padStart(2,'0');
  $('dateTime').textContent = dt.toLocaleDateString('ru-RU') + ' ' + hh + ':' + mins;
  const icon = hh>=6 && hh<18 ? '‚òÄÔ∏è' : 'üåô';
  $('weather').textContent = icon + ' ' + (18 + (hh%6)) + '¬∞C';
}
setInterval(updateDateTimeWeather, 30*1000);
updateDateTimeWeather();

/* ====== storage ====== */
function saveLocal(){ try{ localStorage.setItem(LS, JSON.stringify(STATE)); }catch(e){console.warn(e);} }
function loadLocal(){ try{ const v=localStorage.getItem(LS); if(v) STATE=Object.assign(STATE, JSON.parse(v)); }catch(e){console.warn(e);} }
loadLocal();

/* ====== theme / roles UI ====== */
function setRoleTabs(){
  const wrap = $('roleTabs'); wrap.innerHTML='';
  const roles = [{k:'user', t:'–°–§–ï–†–ê –£–°–õ–£–ì'}, {k:'worker', t:'–ü–û–î–†–ê–ë–û–¢–ö–ê'}];
  roles.forEach(r=>{
    const el = document.createElement('div'); el.className='role-tab'; el.textContent=r.t; el.dataset.role=r.k;
    if(STATE.role===r.k) el.classList.add('active');
    el.onclick = ()=>{ STATE.role = r.k; saveLocal(); setRoleTabs(); renderMenu(); };
    wrap.appendChild(el);
  });
}
setRoleTabs();

/* ====== menu rendering ====== */
function menuBtn(id, title, note, extraClass=''){
  const d=document.createElement('div'); d.className='menu-btn '+extraClass; d.id=id;
  d.innerHTML = `<div style="flex:1"><div class="title">${title}</div><div class="note">${note||''}</div></div>`;
  return d;
}
function renderMenu(){
  const grid=$('menuGrid'); grid.innerHTML='';
  if(STATE.role==='user'){
    grid.appendChild(menuBtn('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'));
    const btnBook = menuBtn('btnBook','–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å (—Å–∫–æ—Ä–æ)','–°–∫–æ—Ä–æ','dark');
    grid.appendChild(btnBook);
    grid.appendChild(menuBtn('btnCity','–ß–ê–¢ –¢–í–û–ï–ì–û –ì–û–†–û–î–ê','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtn('btnMine','–ú–û–ò –ó–ê–ö–ê–ó–´','–í–∞—à–∏ –∑–∞—è–≤–∫–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–ï–°–°–ï–ù–î–ñ–ï–†','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtn('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–Ø –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'));
    grid.appendChild(menuBtn('btnWallet','–ö–û–®–ï–õ–Å–ö','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  } else {
    grid.appendChild(menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π'));
    grid.appendChild(menuBtn('btnCity','–ß–ê–¢ –¢–í–û–ï–ì–û –ì–û–†–û–î–ê','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtn('btnMine','–ú–û–ò –ó–ê–ö–ê–ó–´','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–ï–°–°–ï–ù–î–ñ–ï–†','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtn('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–Ø –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'));
    grid.appendChild(menuBtn('btnWallet','–ö–û–®–ï–õ–Å–ö','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  }

  grid.querySelectorAll('.menu-btn').forEach(el=>{
    el.onclick = ()=>{
      const id = el.id;
      if(id==='btnOrder') openScreen('createScreen');
      if(id==='btnBook') alert('–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (—Å–∫–æ—Ä–æ)');
      if(id==='btnCity') { renderCityPosts(); openScreen('cityThreadScreen'); }
      if(id==='btnFind') { renderFindList(); openScreen('findScreen'); }
      if(id==='btnMine') { renderMineList(); openScreen('mineScreen'); }
      if(id==='btnMessenger') { renderChats(); openScreen('messengerScreen'); }
      if(id==='btnAds') alert('–û–±—ä—è–≤–ª–µ–Ω–∏—è - –¥–µ–º–æ');
      if(id==='btnWallet') alert('–ö–æ—à–µ–ª—ë–∫ - –¥–µ–º–æ');
    };
  });
}
renderMenu();

/* ====== notifications center ====== */
function refreshNotifs(){
  const b = $('notifBadge'); const n = STATE.notifs.length;
  if(n>0){ b.style.display='inline-block'; b.textContent = n>99 ? '99+' : String(n); } else b.style.display='none';
}
function renderNotifsList(){
  const wrap = $('notificationsList'); wrap.innerHTML='';
  if(!STATE.notifs.length) { wrap.innerHTML='<div style="padding:8px;color:var(--muted)">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div>'; return; }
  STATE.notifs.forEach((n, idx)=>{
    const c = document.createElement('div'); c.className='post-card'; c.style.cursor='pointer';
    c.innerHTML = `<div style="font-weight:900">${n.title}</div><div style="margin-top:6px;color:var(--muted)">${new Date(n.ts).toLocaleString()}</div><div style="margin-top:8px">${n.body||''}</div>`;
    c.onclick = ()=>{ alert(n.title + "\n\n" + (n.body||'')); closeScreen('notificationsModal'); };
    wrap.appendChild(c);
  });
}
$('notifBtn').addEventListener('click', ()=>{ renderNotifsList(); openScreen('notificationsModal'); });

/* ====== create order UI ====== */
const CATS = ['–°–ü–ï–¶. –ó–ê–ö–ê–ó','–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–î–æ—Å—Ç–∞–≤–∫–∞','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)','–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç','–ü—Ä–æ—á–∏–µ'];
function initCreateTabs(){
  const wrap = $('createTabs'); wrap.innerHTML='';
  CATS.forEach(c=>{
    const el = document.createElement('div'); el.className='role-tab'; el.textContent=c; el.dataset.cat=c;
    el.onclick = ()=>{
      wrap.querySelectorAll('.role-tab').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      renderCriteria(c);
    };
    wrap.appendChild(el);
  });
  wrap.firstChild.classList.add('active');
  renderCriteria(CATS[0]);
}
initCreateTabs();

const CRITERIA = {
  '–°–ü–ï–¶. –ó–ê–ö–ê–ó':['–°—Ä–æ—á–Ω–æ','–°–µ–≥–æ–¥–Ω—è','–û–ø—ã—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'],
  '–¢–∞–∫—Å–∏':['–ì–æ—Ä–æ–¥','–ú–µ–∂–≥–æ—Ä–æ–¥','–ë–∞–≥–∞–∂'],
  '–ö—É—Ä—å–µ—Ä':['–î–æ 5 –∫–≥','–î–æ–∫—É–º–µ–Ω—Ç—ã','–°–µ–≥–æ–¥–Ω—è'],
  '–î–æ—Å—Ç–∞–≤–∫–∞':['–ö—É–ø–∏—Ç—å','–ó–∞–±—Ä–∞—Ç—å','–•—Ä—É–ø–∫–æ–µ'],
  '–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)':['–ê—Ä–µ–Ω–¥–∞','–ü—Ä–æ–¥–∞–∂–∞','1–∫','2–∫','3–∫'],
  '–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç':['–ù—è–Ω—è','–ü—Å–∏—Ö–æ–ª–æ–≥','–≠–ª–µ–∫—Ç—Ä–∏–∫','–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫'],
  '–ü—Ä–æ—á–∏–µ':['–†–∞–∑–æ–≤–æ–µ','–ü–æ—Å—Ç–æ—è–Ω–Ω–æ']
};
function renderCriteria(cat){
  const wrap = $('criteriaWrap'); wrap.innerHTML='';
  (CRITERIA[cat]||[]).forEach(x=>{
    const ch = document.createElement('div'); ch.className='chip'; ch.style.display='inline-block'; ch.style.margin='4px'; ch.style.padding='6px 10px'; ch.style.borderRadius='999px'; ch.style.border='1px solid var(--line)'; ch.style.cursor='pointer'; ch.textContent=x;
    ch.onclick = ()=> ch.classList.toggle('active');
    wrap.appendChild(ch);
  });
  const extra = $('createExtraFields'); extra.innerHTML='';
  if(cat==='–¢–∞–∫—Å–∏') extra.innerHTML = '<div style="display:flex;gap:8px;margin-top:8px"><input class="input" id="f-from" placeholder="–û—Ç–∫—É–¥–∞"><input class="input" id="f-to" placeholder="–ö—É–¥–∞"></div>';
  if(cat==='–ö—É—Ä—å–µ—Ä') extra.innerHTML = '<div style="display:flex;gap:8px;margin-top:8px"><input class="input" id="f-pick" placeholder="–ó–∞–±—Ä–∞—Ç—å (–∞–¥—Ä–µ—Å)"><input class="input" id="f-drop" placeholder="–î–æ—Å—Ç–∞–≤–∏—Ç—å (–∞–¥—Ä–µ—Å)"></div>';
  if(cat==='–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç') extra.innerHTML = '<div style="display:flex;gap:8px;margin-top:8px"><input class="input" id="f-person" placeholder="–ö–æ–≥–æ –∏—â–µ–º (–Ω—è–Ω—è/–ø—Å–∏—Ö–æ–ª–æ–≥...)"><input class="input" id="f-details" placeholder="–î–µ—Ç–∞–ª–∏"></div>';
}

/* submit order */
$('createForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const cat = document.querySelector('#createTabs .role-tab.active')?.dataset.cat || '–°–ü–ï–¶. –ó–ê–ö–ê–ó';
  const desc = $('c-desc').value.trim();
  const dt = $('c-datetime').value;
  const budget = Number($('c-budget').value||0);
  if(!desc || !dt) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è');
  const order = { id:'o_'+uid(), category:cat, desc, datetime:dt, budget, city: STATE.city, ownerId: STATE.profile.id, ownerName: STATE.profile.name, bids:[], status:'open', createdAt:nowISO() };
  STATE.orders.unshift(order); saveLocal();
  alert('–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'); closeScreen('createScreen'); renderMineList(); renderFindList();
});

/* ====== find orders (with "–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É") ====== */
function renderFindList(){
  const wrap = $('findList'); wrap.innerHTML='';
  const q = ($('searchInput')?.value||'').toLowerCase();
  const cat = ($('filterCat')?.value||'');
  if($('filterCat').children.length<=1){
    CATS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; $('filterCat').appendChild(o); });
  }
  let items = STATE.orders.filter(o=>o.status==='open' && o.city===STATE.city);
  if(cat) items = items.filter(x=>x.category===cat);
  if(q) items = items.filter(o=> (o.category+' '+o.desc+' '+o.ownerName).toLowerCase().includes(q));
  if(!items.length) { wrap.innerHTML='<div style="color:var(--muted)">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const card = document.createElement('div'); card.className='post-card';
    card.innerHTML = `<div style="font-weight:900">${o.category} ‚Ä¢ <span style="font-weight:600">${o.city}</span> ‚Ä¢ ‚Ç∏ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>
      <div style="margin-top:6px;color:var(--muted)">–î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div>
      <div style="margin-top:8px; white-space:pre-wrap">${o.desc}</div>
      <div style="display:flex; gap:8px; margin-top:8px"><button class="btn" data-act="offer">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É</button></div>`;
    card.querySelector('[data-act="offer"]').addEventListener('click', ()=>{
      $('offerModal').dataset.orderId = o.id;
      $('offerPrice').value=''; $('offerComment').value='';
      openScreen('offerModal');
    });
    wrap.appendChild(card);
  });
}
$('applySearch').addEventListener('click', renderFindList);

/* offer form submit */
$('offerForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const price = Number($('offerPrice').value||0);
  const comment = $('offerComment').value.trim();
  if(!price) return alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É');
  const orderId = $('offerModal').dataset.orderId;
  const order = STATE.orders.find(x=>x.id===orderId);
  if(!order) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const bid = { performerId: STATE.profile.id, name: STATE.profile.name, price, comment, createdAt: nowISO() };
  order.bids = order.bids||[]; order.bids.push(bid);
  saveLocal(); closeScreen('offerModal'); alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); renderFindList();
  STATE.notifs.unshift({ id:'n_'+uid(), type:'bid', title:'–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', body:`–ù–∞ –≤–∞—à –∑–∞–∫–∞–∑ "${order.category}" –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ ‚Ç∏ ${price}`, ts: nowISO(), payload:{orderId} });
  refreshNotifs();
});

/* ====== mine orders + bids modal (owner) ====== */
function renderMineList(){
  const holder = $('mineList'); if(!holder) {
    // create container on the fly if missing (some flows open mineScreen via modal)
    return;
  }
  holder.innerHTML='';
  const me = STATE.profile.id;
  const mine = STATE.orders.filter(o=>o.ownerId===me);
  if(!mine.length){ holder.innerHTML = '<div style="color:var(--muted)">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  mine.forEach(o=>{
    const card = document.createElement('div'); card.className='post-card';
    const bidsCount = (o.bids||[]).length;
    card.innerHTML = `<div style="font-weight:900">${o.category} ‚Ä¢ ${o.city} ${bidsCount?(' ‚Ä¢ <span style="color:#ff9bb0">'+bidsCount+' –∑–∞—è–≤–æ–∫</span>'):''}</div>
      <div style="margin-top:6px;color:var(--muted)">–°—Ç–∞—Ç—É—Å: ${o.status} ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div>
      <div style="margin-top:8px; white-space:pre-wrap">${o.desc}</div>
      <div style="display:flex; gap:8px; margin-top:8px"></div>`;
    const actions = card.querySelector('div:last-child');
    if(o.status==='open' && bidsCount){
      const view = document.createElement('button'); view.className='btn'; view.textContent='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏';
      view.addEventListener('click', ()=> openBidsModal(o.id) );
      actions.appendChild(view);
    }
    holder.appendChild(card);
  });
}
function openBidsModal(orderId){
  const order = STATE.orders.find(x=>x.id===orderId); if(!order) return;
  const list = $('bidsList'); list.innerHTML='';
  if(!(order.bids && order.bids.length)) { list.innerHTML = '<div style="color:var(--muted)">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>'; openScreen('bidsModal'); return; }
  order.bids.forEach((b, idx)=>{
    const row = document.createElement('div'); row.className='post-card';
    row.innerHTML = `<div style="font-weight:900">${b.name} ‚Äî ‚Ç∏ ${Number(b.price).toLocaleString('ru-RU')}</div>
      <div style="margin-top:6px;color:var(--muted)">${new Date(b.createdAt).toLocaleString()}</div>
      <div style="margin-top:8px">${b.comment||''}</div>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="btn primary" data-act="accept">–ü—Ä–∏–Ω—è—Ç—å</button>
        <button class="btn" data-act="decline">–û—Ç–∫–∞–∑–∞—Ç—å</button>
      </div>`;
    row.addEventListener('click', (e)=>{
      const a = e.target.closest('[data-act]'); if(!a) return;
      const act = a.dataset.act;
      if(act==='accept'){
        const chat = { id:'chat_'+uid(), orderId: order.id, title: order.category + ' ‚Äî —á–∞—Ç', participants:[order.ownerId, b.performerId], messages:[{ from:'system', text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω –ø–æ –∑–∞–∫–∞–∑—É', ts: nowISO() }] };
        STATE.chats.unshift(chat);
        order.status='in_progress';
        STATE.notifs.unshift({ id:'n_'+uid(), type:'accepted_owner', title:'–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É', body:`–û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å ${b.name}`, ts:nowISO(), payload:{chatId:chat.id, orderId:order.id} });
        saveLocal();
        closeScreen('bidsModal');
        renderMineList(); renderChats();
        openChatInPanel(chat.id);
      } else if(act==='decline'){
        order.bids.splice(idx,1); saveLocal(); openBidsModal(orderId);
      }
    });
    list.appendChild(row);
  });
  $('bidsTitle').textContent = `–ó–∞—è–≤–∫–∏ ‚Äî ${order.category}`;
  openScreen('bidsModal');
}

/* ====== messenger / chats ====== */
function renderChats(){
  const wrap = $('chatsList'); wrap.innerHTML='';
  if(!STATE.chats.length) { wrap.innerHTML = '<div style="padding:8px;color:var(--muted)">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
  STATE.chats.forEach(c=>{
    const row = document.createElement('div'); row.className='post-card'; row.style.cursor='pointer';
    row.innerHTML = `<div style="font-weight:900">${c.title||'–ß–∞—Ç'}</div><div style="margin-top:6px;color:var(--muted)">${c.orderId?('–ü–æ –∑–∞–∫–∞–∑—É: '+c.orderId):'–î–∏–∞–ª–æ–≥'}</div>`;
    row.onclick = ()=> openChatInPanel(c.id);
    wrap.appendChild(row);
  });
}

/* ====== Core change: render chat messages with left/right alignment ====== */
function openChatInPanel(id){
  const chat = STATE.chats.find(x=>x.id===id); if(!chat) return alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const msgs = $('chatWinMsgs'); msgs.innerHTML='';
  (chat.messages||[]).forEach(m=>{
    const isSystem = (m.from === 'system' || m.from === 'system');
    const isMe = (!isSystem) && (m.from === STATE.profile.id);
    const d = document.createElement('div');
    d.className = 'msg ' + (isSystem ? '' : (isMe ? 'me' : 'other'));
    if(isSystem){
      d.style.fontStyle='italic'; d.style.color='var(--muted)'; d.textContent = m.text;
    } else {
      // show name for others, for me optionally hide name (we keep name for clarity)
      if(isMe){
        d.innerHTML = `<div style="white-space:pre-wrap">${escapeHtml(m.text||'')}</div>`;
      } else {
        d.innerHTML = `<div style="font-weight:800; margin-bottom:6px">${escapeHtml(m.fromName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div><div style="white-space:pre-wrap">${escapeHtml(m.text||'')}</div>`;
      }
    }
    msgs.appendChild(d);
  });
  msgs.scrollTop = msgs.scrollHeight;

  // set send handler for this chat
  $('chatWinSend').onclick = ()=>{
    const v = $('chatWinInput').value.trim(); if(!v) return;
    const message = { from: STATE.profile.id, fromName: STATE.profile.name, text: v, ts: nowISO() };
    chat.messages.push(message);
    saveLocal();
    $('chatWinInput').value='';
    openChatInPanel(id); // re-render
  };
}

/* Quick post and messenger top */
function setupMessengerTop(){
  const avatar = $('myChatAvatar'); avatar.textContent = STATE.profile.avatarData || STATE.profile.name[0];
  $('myChatName').textContent = STATE.profile.name;
  document.querySelector('.chat-top-row').addEventListener('click', ()=>{
    openScreen('quickPostModal');
    $('quickPostText').value='';
  });
  $('quickPostSend').addEventListener('click', ()=>{
    const txt = $('quickPostText').value.trim(); if(!txt) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
    const post = { id:'post_'+uid(), authorName: STATE.profile.name, text: txt, ts: nowISO(), likes:{byUser:{}}, comments:[] };
    (STATE.feed[STATE.city] = STATE.feed[STATE.city]||[]).unshift(post);
    saveLocal(); closeScreen('quickPostModal');
    alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ª–µ–Ω—Ç—É –≥–æ—Ä–æ–¥–∞');
  });
}
setupMessengerTop();

/* ====== city feed rendering ====== */
function renderCityPosts(){
  const cont = $('cityPosts'); if(!cont) return;
  cont.innerHTML = '';
  const posts = STATE.feed[STATE.city] || [];
  if(!posts.length) { cont.innerHTML = '<div style="color:var(--muted)">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
  posts.forEach(p=>{
    const card = document.createElement('div'); card.className='post-card';
    const likesCount = Object.keys(p.likes?.byUser||{}).length;
    card.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
        <div class="avatar">${(p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')[0] || '–ü'}</div>
        <div style="font-weight:900">${escapeHtml(p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div>
        <div style="margin-left:auto;color:var(--muted)">${new Date(p.ts).toLocaleString()}</div>
      </div>
      <div style="margin-top:8px; white-space:pre-wrap">${escapeHtml(p.text||'')}</div>
      ${p.image?('<img class="post-img" src="'+p.image+'" alt="">'):''}
      <div class="post-actions" style="margin-top:8px">
        <button class="btn" data-act="like">‚ù§Ô∏è (<span data-likecount>${likesCount}</span>)</button>
        <button class="btn" data-act="comment">üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="comments" style="margin-top:8px; display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px;"><input class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."><button class="btn primary" data-act="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
        <div class="comments-list"></div>
      </div>`;
    cont.appendChild(card);
    card.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-act]'); if(!btn) return;
      const act = btn.dataset.act;
      if(act==='like'){ toggleLike(p.id, card); }
      else if(act==='comment'){ const box = card.querySelector('.comments'); box.style.display = box.style.display==='none' ? 'block' : 'none'; }
      else if(act==='sendComment'){ const input = card.querySelector('.comments input'); const txt = input.value.trim(); if(!txt) return; p.comments = p.comments||[]; p.comments.push({ id:'c_'+uid(), authorName: STATE.profile.name, text: txt, ts: nowISO() }); saveLocal(); renderCityPosts(); }
    });
  });
}
function toggleLike(postId, cardEl){
  const posts = STATE.feed[STATE.city] || []; const p = posts.find(x=>x.id===postId); if(!p) return;
  p.likes = p.likes || { byUser:{} }; const me = STATE.profile.id;
  if(p.likes.byUser[me]) delete p.likes.byUser[me]; else p.likes.byUser[me]=true;
  saveLocal(); renderCityPosts();
}

/* add city post (from city composer) */
document.getElementById('cityPostSend').addEventListener('click', ()=>{
  const text = $('cityPostText').value.trim();
  if(!text && !document.getElementById('cityPostImage').files.length) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
  const imgFile = document.getElementById('cityPostImage').files[0];
  if(imgFile){
    const fr = new FileReader();
    fr.onload = ()=> {
      const post = { id:'post_'+uid(), authorName: STATE.profile.name, text, image: fr.result, ts: nowISO(), likes:{byUser:{}}, comments:[] };
      (STATE.feed[STATE.city]=STATE.feed[STATE.city]||[]).unshift(post);
      saveLocal(); $('cityPostText').value=''; document.getElementById('cityPostImage').value=''; renderCityPosts();
    };
    fr.readAsDataURL(imgFile);
  } else {
    const post = { id:'post_'+uid(), authorName: STATE.profile.name, text, ts: nowISO(), likes:{byUser:{}}, comments:[] };
    (STATE.feed[STATE.city]=STATE.feed[STATE.city]||[]).unshift(post);
    saveLocal(); $('cityPostText').value=''; renderCityPosts();
  }
});

/* composer shrink on scroll + prevent composer from blocking scroll */
(function composerScrollBehavior(){
  const scroll = $('cityScroll'); const comp = $('cityComposer');
  if(!scroll || !comp) return;
  scroll.addEventListener('scroll', ()=> {
    if(scroll.scrollTop > 60) comp.classList.add('compact'); else comp.classList.remove('compact');
  }, { passive:true });
  comp.addEventListener('wheel', (e)=>{ if(e.target.tagName.toLowerCase()!=='textarea') e.stopPropagation(); }, { passive:false });
})();

/* ====== chats create picker ====== */
$('createChatBtn').addEventListener('click', ()=>{
  const wrap = $('chatPicker'); wrap.innerHTML='';
  const map = new Map();
  STATE.orders.forEach(o=>{ map.set(o.ownerId, o.ownerName||'–ó–∞–∫–∞–∑—á–∏–∫'); (o.bids||[]).forEach(b=>map.set(b.performerId, b.name||'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å')); });
  if(!map.size) { wrap.innerHTML = '<div style="color:var(--muted)">–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>'; openScreen('createChatScreen'); return; }
  map.forEach((name,id)=>{
    const r = document.createElement('div'); r.className='post-card'; r.style.cursor='pointer';
    r.innerHTML = `<div style="font-weight:900">${name}</div><div style="margin-top:6px;color:var(--muted)">${id}</div>`;
    r.onclick = ()=> {
      const chat = { id:'chat_'+uid(), orderId:null, title:'–î–∏–∞–ª–æ–≥ —Å '+name, participants:[STATE.profile.id, id], messages:[{from:'system', text:'–ß–∞—Ç —Å–æ–∑–¥–∞–Ω', ts: nowISO()}] };
      STATE.chats.unshift(chat); saveLocal(); closeScreen('createChatScreen'); renderChats(); openChatInPanel(chat.id);
    };
    wrap.appendChild(r);
  });
  openScreen('createChatScreen');
});

/* ====== simple helpers ====== */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const el = $(id); if(el) el.classList.add('active'); }
function closeScreen(id){ const el = $(id); if(el) el.classList.remove('active'); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* ====== init small ====== */
function init(){
  const greeted = localStorage.getItem('gid_greeted_v1');
  if(!greeted){
    $('welcomeOverlay').style.display='flex';
    $('welcomeOk').onclick = ()=>{ $('welcomeOverlay').style.display='none'; localStorage.setItem('gid_greeted_v1','1'); };
  }

  renderMenu(); setRoleTabs(); renderCityPosts(); renderFindList(); renderMineList(); renderChats(); refreshNotifs();
  $('openSettings').addEventListener('click', ()=>{ alert('–û—Ç–∫—Ä–æ—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–µ–º–æ)'); });
  // sync button stub (if you have sync modal, wire here)
}
init();

/* expose for debug */
window.GIDCITY = { STATE, saveLocal };
</script>
</body>
</html>
