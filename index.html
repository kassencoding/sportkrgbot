<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GiD City ‚Äî –°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥ & –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* =================== –¢–ï–ú–´ =================== */
:root{
  --bg-1:#0a0f1a; --bg-2:#0b0e1c; --bg-3:#0b0e1e;
  --radial-a:#1e1b3a; --radial-b:#08152a;

  --surface:rgba(20,24,40,.72); /* —Å—Ç–µ–∫–ª—è–Ω–Ω–æ—Å—Ç—å */
  --line:rgba(160,170,230,.28);

  --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff;
  --danger:#ff4f6a; --gold:#ffd84d;

  --text:#ffffff; --text-dim:#d8dcff; --text-muted:#9aa6d9; --text-invert:#0b0f18;

  --radius:16px; --ui-font:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --ui-font-size:14px;
  --shadow:0 16px 46px rgba(0,0,0,.45);
}
/* –±–∞–∑–æ–≤—ã–µ */
html[data-theme="violet"]{ --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff; --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22; }
html[data-theme="navy"]  { --accent-a:#6aa7ff; --accent-b:#7ef3ff; --accent-c:#65d0ff; --bg-1:#04101c; --bg-2:#041426; --bg-3:#061a32; }
html[data-theme="emerald"]{ --accent-a:#33e09d; --accent-b:#b7ff78; --accent-c:#75ffd9; --bg-1:#081710; --bg-2:#082019; --bg-3:#071a12; }
html[data-theme="sunset"]{ --accent-a:#ff6dab; --accent-b:#ffcc6d; --accent-c:#ff9b6d; --bg-1:#1a080a; --bg-2:#22090b; --bg-3:#2c0b10; }
/* —Ç—ë–ø–ª—ã–µ/—è—Ä–∫–∏–µ */
html[data-theme="peach"]{ --accent-a:#ff9e7a; --accent-b:#ffd36d; --accent-c:#ffa07a; --bg-1:#1c0f0a; --bg-2:#24130d; --bg-3:#2a170f; }
html[data-theme="sunrise"]{ --accent-a:#ff8a5c; --accent-b:#ffd56b; --accent-c:#ffb86b; --bg-1:#140c08; --bg-2:#1b110b; --bg-3:#22150d; }
html[data-theme="amber"]{ --accent-a:#ffb300; --accent-b:#ffd54f; --accent-c:#ffc107; --bg-1:#100a02; --bg-2:#160d03; --bg-3:#1b1004; }
html[data-theme="rose"]{ --accent-a:#ff6fa3; --accent-b:#ffc6e0; --accent-c:#ff99c2; --bg-1:#160711; --bg-2:#1e0a16; --bg-3:#250c1a; }
html[data-theme="mint"]{ --accent-a:#35e0c1; --accent-b:#a7ff83; --accent-c:#6cffdf; --bg-1:#051612; --bg-2:#071d18; --bg-3:#09231d; }
/* —Å–≤–µ—Ç–ª—ã–µ */
html[data-theme="light1"]{
  --bg-1:#ffffff; --bg-2:#f6f7fb; --bg-3:#eef1f7;
  --text:#1a1a1a; --text-dim:#2c2c2c; --text-muted:#555; --text-invert:#ffffff;
  --surface:rgba(255,255,255,.78); --line:#e5e8f0;
  --accent-a:#6a5cff; --accent-b:#22c1c3; --accent-c:#6a8cff;
}
html[data-theme="light2"]{
  --bg-1:#fefefe; --bg-2:#edf6ff; --bg-3:#e6f0ff;
  --text:#191c22; --text-dim:#2a2f36; --text-muted:#4b5563; --text-invert:#ffffff;
  --surface:rgba(255,255,255,.78); --line:#e1e7f0;
  --accent-a:#8a65ff; --accent-b:#4de0c2; --accent-c:#74a6ff;
}

/* =================== –§–û–ù =================== */
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; padding:18px; color:var(--text);
  font: var(--ui-font-size) var(--ui-font);
  background:
    radial-gradient(900px at 20% -10%, var(--radial-a) 0%, transparent 70%),
    radial-gradient(700px at 120% 20%, var(--radial-b) 0%, transparent 70%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
  display:flex; justify-content:center;
}
html[data-theme="light1"] body{ background:linear-gradient(120deg,#f2f5ff,#ffffff); }
html[data-theme="light2"] body{ background:linear-gradient(120deg,#e8f3ff,#ffffff); }

.wrapper{ width:100%; max-width:1100px; display:flex; flex-direction:column; gap:16px; animation:intro .55s ease-out; }
@keyframes intro{ from{ opacity:0; transform:translateY(10px)} to{ opacity:1; transform:translateY(0)} }

/* =================== –•–ï–î–ï–† =================== */
.header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:6px 2px; }
.brand{ display:flex; flex-direction:column; gap:6px; }
.brand h1{
  margin:0; font-weight:800; font-size:22px;
  background:linear-gradient(90deg,var(--accent-a),var(--accent-b));
  -webkit-background-clip:text; color:transparent;
  text-shadow:0 0 18px rgba(169,112,255,.28);
}
.header-sub{ font-size:13px; color:var(--text-muted) }
.header-right{ display:flex; flex-direction:column; gap:10px; align-items:flex-end }

/* =================== –ö–ù–û–ü–ö–ò =================== */
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; color:var(--text);
  padding:10px 14px; border-radius:12px; line-height:1;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  border:1px solid var(--line); box-shadow:var(--shadow); transition:transform .12s, box-shadow .25s, background .12s;
}
.btn:hover{ transform:translateY(-1px) }
.btn:active{ transform:translateY(0) }
.btn.primary{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:var(--text-invert); }
.btn.ghost{ background:transparent; }
.controls-row{ display:flex; gap:8px }
.btn-with-badge{ position:relative }
.badge-dot{ position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px;
  display:flex; align-items:center; justify-content:center; background:var(--danger); color:#fff; border-radius:999px; font-size:12px; font-weight:900; box-shadow:0 0 0 2px rgba(0,0,0,.7);
}

/* =================== ROLE TABS (–≤–Ω–∏–∑—É –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞) =================== */
.role-tabs{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center; }
.role-tab{
  padding:16px 18px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.16));
  border:1px solid var(--line); cursor:pointer; font-weight:900; color:var(--text);
  transition:transform .12s, color .12s, background .12s; text-align:center; min-height:64px; box-shadow:var(--shadow);
}
.role-tab.active{ color:var(--text-invert); background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); transform:translateY(-1px); box-shadow:0 10px 30px rgba(50,255,210,.16); }

/* =================== CITY LABEL =================== */
.city-top-label{ text-align:left; font-weight:900; color:var(--text-muted); margin-bottom:6px }

/* =================== –ö–û–ù–¢–ï–ô–ù–ï–† / –ú–ï–ù–Æ =================== */
.container{ width:100%; border-radius:20px; padding:0; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden; backdrop-filter: blur(14px) saturate(120%); }
.panel-top{ display:flex; justify-content:space-between; align-items:center; margin:0; padding:16px }
.panel-top h2{ margin:0; font-size:18px; font-weight:900 }

/* menu grid */
.menu-grid{ display:flex; gap:12px; width:100%; justify-content:center; flex-wrap:wrap; align-items:flex-start; padding:18px; }
.menu-btn{
  display:flex; align-items:center; gap:12px; cursor:pointer;
  min-height:64px; padding:12px 16px; border-radius:14px; border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12)); box-shadow:0 8px 26px rgba(0,0,0,.35);
  color:var(--text); transition:transform .18s, box-shadow .2s, background .16s;
  flex: 1 1 330px; max-width:520px;
  justify-content:flex-start;
}
.menu-btn .title{ font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.menu-btn .note{ font-size:12px; color:var(--text-muted) }
.menu-btn.primary{ background:linear-gradient(135deg, rgba(169,112,255,.18), rgba(50,255,210,.10)); border-color: rgba(169,112,255,.26); }
.menu-btn.disabled{ opacity:.6; pointer-events:none }

/* reveal animation for menu items */
.menu-grid.revealing .menu-btn{ opacity:0; transform:translateY(18px) scale(.98); animation:revealUp .42s forwards; }
@keyframes revealUp{ to{ opacity:1; transform:translateY(0) scale(1); } }

/* footer with big role buttons INSIDE main container */
.role-footer{ padding:12px 18px 18px; border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08)); }

/* =================== CARDS / AVATARS =================== */
.card{ background:linear-gradient(180deg, rgba(12,16,30,.9), rgba(8,12,26,.9)); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:var(--shadow); display:flex; gap:12px; align-items:flex-start }
.avatar{ width:32px; height:32px; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; color:#fff }
.avatar img{ width:100%; height:100%; object-fit:cover }

/* =================== INPUTS =================== */
.field-label{ font-size:12px; color:var(--text-muted); font-weight:800; margin:0 0 4px 2px; }
.input, textarea, select{
  width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
  background:rgba(12,16,36,.75); color:var(--text); font-size:14px; outline:none; box-sizing:border-box;
}
.input:focus, textarea:focus, select:focus{ border-color:var(--accent-a); box-shadow:0 0 0 3px rgba(169,112,255,.12) }
textarea{ min-height:110px; resize:vertical }
.row{ display:flex; gap:8px; flex-wrap:wrap } .col{ flex:1 1 260px }
.small{ font-size:12px; color:var(--text-muted) }
.form-stack .input{ height:48px; min-height:48px; display:flex; align-items:center }

/* –ö—Ä–∏—Ç–µ—Ä–∏–∏ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ç–µ–≥–∏ */
.criteria{ display:flex; gap:6px; flex-wrap:wrap }
.crit{ padding:6px 10px; border-radius:10px; border:1px solid var(--line); cursor:pointer; font-weight:800; font-size:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.12)); }
.crit.active{ background:linear-gradient(90deg, rgba(169,112,255,.32), rgba(50,255,210,.24)); border-color:rgba(169,112,255,.6) }

/* Tabs for create form */
.create-tabs{ display:flex; gap:8px; overflow:auto; padding:12px 0; border-bottom:1px solid rgba(255,255,255,.06); }
.create-tab{ padding:8px 14px; border-radius:8px 8px 0 0; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10)); border:1px solid var(--line); border-bottom:0; cursor:pointer; font-weight:900; color:var(--text-dim); white-space:nowrap; }
.create-tab.active{ color:var(--gold); background:linear-gradient(180deg, rgba(255,216,77,.10), rgba(169,112,255,.06)); transform:translateY(-2px); box-shadow:0 10px 30px rgba(255,200,80,.06); }

/* =================== SCREENS =================== */
.screen{ position:fixed; inset:0; display:none; z-index:120; padding:12px; background:rgba(0,0,0,.55); backdrop-filter:blur(8px); align-items:flex-start; justify-content:center }
.screen.active{ display:flex }
.modal{ width:100%; max-width:1100px; max-height:88vh; overflow:auto; background:var(--surface); color:var(--text); box-shadow:var(--shadow); border:1px solid var(--line); border-radius:18px; padding:16px }

/* =================== MESSENGER =================== */
.msgs{ margin-top:8px; max-height:58vh; overflow:auto; padding-right:6px }
.msg-row{ margin:8px 0 } .msg-me{ text-align:right }
.msg-me .b{ display:inline-block; background:linear-gradient(90deg, rgba(169,112,255,.9), rgba(50,255,210,.9)); padding:8px 12px; border-radius:12px; color:#0a0f1e; font-weight:800; box-shadow:0 8px 26px rgba(50,200,200,.06); max-width:78%; word-break:break-word; }
.msg-other .b{ display:inline-block; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); padding:8px 12px; border-radius:12px; color:var(--text); max-width:78%; word-break:break-word; }
.msg-system{ text-align:center; margin:10px 0 14px 0; color:var(--text-muted); font-size:12px }
.msg-img{ display:block; max-width:60%; border-radius:12px; margin-top:6px; border:1px solid var(--line) }

/* =================== –ì–û–†–û–î/–õ–ï–ù–¢–ê =================== */
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); backdrop-filter:blur(6px); border-radius:14px; padding:12px; box-shadow:var(--shadow); margin-bottom:10px }
.post-img{ width:100%; border-radius:12px; margin-top:8px; max-height:360px; object-fit:cover }
.post-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
.comment{ background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:10px; padding:8px; margin-top:6px }

/* composer floating */
.city-composer{ position:sticky; top:12px; z-index:10; display:flex; gap:8px; align-items:center; padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.08); margin-bottom:12px; }

/* Responsive */
@media (max-width:900px){
  .menu-btn{ width:100%; flex-basis:100%; }
  .create-tab{ min-width:30%; }
}
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiD City</h1>
      <div id="topCity" class="header-sub">–ì–æ—Ä–æ–¥: ‚Äî</div>
    </div>
    <div class="header-right">
      <div class="controls-row">
        <button id="openNotifications" class="btn btn-with-badge">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifBadge" class="badge-dot" style="display:none">0</span></button>
        <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
  </header>

  <main class="container" role="main" aria-live="polite">
    <div class="panel-top"><h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2><div style="width:140px"></div></div>
    <div class="menu-grid" id="menuGrid"></div>

    <!-- –ù–∏–∂–Ω–∏–π –±–ª–æ–∫ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ —Ä–æ–ª–µ–π –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞ –º–µ–Ω—é -->
    <div class="role-footer">
      <div class="city-top-label">–ì–æ—Ä–æ–¥: <span id="cityTopLabel">‚Äî</span></div>
      <div id="roleTabs" class="role-tabs"></div>
    </div>
  </main>
</div>

<!-- ===== AUTH ===== -->
<section id="authScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–í—Ö–æ–¥</h3><button onclick="closeScreen('authScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <form id="authForm" style="margin-top:12px">
      <input id="authLogin" class="input" placeholder="Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" required>
      <input id="authPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="margin-top:8px" required>
      <div style="display:flex; gap:8px; margin-top:12px"><button type="submit" class="btn primary">–í–æ–π—Ç–∏</button><button type="button" id="registerBtn" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
      <div class="small" style="margin-top:10px">–î–µ–º–æ: –ª–æ–∫–∞–ª—å–Ω–æ + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è JSONBin</div>
    </form>
  </div>
</div></section>

<!-- ===== CREATE ORDER ===== -->
<section id="createScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ó–ê–ö–ê–ó–ê–¢–¨</h3><button onclick="closeScreen('createScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
    <div style="margin-top:10px;">

      <div id="createTabs" class="create-tabs" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–∞">
        <div class="create-tab active" data-val="–°–ü–ï–¶. –ó–ê–ö–ê–ó" role="tab">–°–ü–ï–¶. –ó–ê–ö–ê–ó</div>
        <div class="create-tab" data-val="–¢–∞–∫—Å–∏" role="tab">–¢–∞–∫—Å–∏</div>
        <div class="create-tab" data-val="–ö—É—Ä—å–µ—Ä" role="tab">–ö—É—Ä—å–µ—Ä</div>
        <div class="create-tab" data-val="–î–æ—Å—Ç–∞–≤–∫–∞" role="tab">–î–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="create-tab" data-val="–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)" role="tab">–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º</div>
        <div class="create-tab" data-val="–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç" role="tab">–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</div>
        <div class="create-tab" data-val="–ü—Ä–æ—á–∏–µ" role="tab">–ü—Ä–æ—á–∏–µ</div>
      </div>

      <form id="createForm" style="margin-top:12px; display:grid; gap:10px;">
        <textarea id="c-desc" class="input" placeholder="–ó–∞–∫–∞–∂–∏ –ª—é–±—É—é —É—Å–ª—É–≥—É ‚Äî –º—ã –Ω–∞–π–¥—ë–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"></textarea>

        <!-- –ö—Ä–∏—Ç–µ—Ä–∏–∏: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ç–µ–≥–∏, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∏ –º–µ—Å—Ç–æ -->
        <div id="criteriaWrap" class="criteria" aria-label="–ö—Ä–∏—Ç–µ—Ä–∏–∏"></div>

        <div id="createExtraFields"></div>

        <!-- –î–µ–¥–ª–∞–π–Ω: –¥–æ–±–∞–≤–∏–ª–∏ —è–≤–Ω—É—é –ø–æ–¥–ø–∏—Å—å -->
        <div class="form-stack" style="display:flex; flex-direction:row; gap:8px; align-items:flex-start; flex-wrap:wrap">
          <div class="col" style="min-width:220px;">
            <label class="field-label" for="c-datetime">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
            <input id="c-datetime" class="input" type="datetime-local">
          </div>
          <div style="width:160px">
            <label class="field-label" for="c-budget">–ë—é–¥–∂–µ—Ç (‚Ç∏)</label>
            <input id="c-budget" class="input" type="number" placeholder="–ù–∞–ø—Ä. 10000">
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:6px; align-items:center">
          <button class="btn primary" id="orderNowBtn" type="submit" style="min-width:220px; padding:14px 18px; font-size:15px">–ó–ê–ö–ê–ó–ê–¢–¨</button>
          <button class="btn ghost" type="button" onclick="closeScreen('createScreen')">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</div></section>

<!-- ===== FIND, MINE, BIDS, MESSENGER, CHAT, ADS, MYADS, AD CREATE, NOTIFICATIONS, SETTINGS, PROFILE, WALLET, CITY THREAD, REPOST ===== -->
<section id="findScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0; font-size:22px; letter-spacing:.5px">–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´</h3><button onclick="closeScreen('findScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div><div style="margin-top:8px"><div style="display:flex; gap:8px;"><input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫..."><button id="applySearch" class="btn">–ü–æ–∏—Å–∫</button></div><div id="findList" class="list" style="margin-top:12px"></div></div></div></div></section>
<section id="mineScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3><button onclick="closeScreen('mineScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div><div id="mineList" class="list" style="margin-top:12px"></div></div></div></section>
<section id="bidsModal" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 id="bidsModalTitle" style="margin:0">–ó–∞—è–≤–∫–∏</h3><button onclick="closeScreen('bidsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="bidsList" style="margin-top:12px"></div></div></div></section>
<section id="messengerScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3><button onclick="closeScreen('messengerScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="chatsList" style="margin-top:12px"></div></div></div></section>
<section id="chatWindow" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; align-items:center; gap:10px;"><div id="chatWinAvatar" class="avatar" style="width:32px; height:32px"></div><div id="chatWinTitle" style="font-weight:900">–ß–∞—Ç</div><div class="small" id="chatWinSub" style="margin-left:auto"></div><button onclick="closeScreen('chatWindow')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="chatWinMsgs" class="msgs"></div><div style="display:flex; gap:8px; margin-top:8px; align-items:center;"><label class="btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å" style="padding:10px 12px;">üìé<input type="file" id="chatAttach" accept="image/*" style="display:none"></label><input id="chatWinInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."><button id="chatWinSend" class="btn primary" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div></div></div></section>
<section id="adsScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥</h3><button onclick="closeScreen('adsScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div style="margin-top:10px;"><button id="myAdsOpenBtn" class="btn">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button></div><div style="margin-top:12px; display:flex; gap:12px; align-items:center; justify-content:space-between;"><div style="font-weight:900">–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div><div><button id="createAdBtn" class="btn">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button></div></div><div id="adsList" class="list" style="margin-top:12px; max-height:60vh; overflow:auto"></div></div></div></section>
<section id="myAdsScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('myAdsScreen'); openScreen('adsScreen');" class="btn ghost">–ù–∞–∑–∞–¥</button></div><div id="myAdsList" class="list" style="margin-top:12px; max-height:66vh; overflow:auto"></div></div></div></section>
<section id="adCreateModal" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3><button onclick="closeScreen('adCreateModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><form id="adForm" style="margin-top:12px"><input id="adTitle" class="input" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" required><textarea id="adDesc" class="input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" style="margin-top:8px"></textarea><div style="display:flex; gap:8px; margin-top:8px;"><input id="adPhone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"><input id="adPrice" class="input" placeholder="–¶–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></div><div style="display:flex; gap:8px; margin-top:10px;"><button class="btn primary" type="submit">–°–æ–∑–¥–∞—Ç—å</button><button class="btn ghost" type="button" onclick="closeScreen('adCreateModal')">–û—Ç–º–µ–Ω–∞</button></div></form></div></div></section>
<section id="notificationsModal" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('notificationsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="notificationsList" style="margin-top:12px; max-height:58vh; overflow:auto"></div><div style="display:flex; gap:8px; margin-top:12px"><button id="clearNotifications" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button></div></div></div></section>
<section id="settingsModal" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="closeScreen('settingsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div style="margin-top:10px">
  <div style="font-weight:900; margin-bottom:6px">–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
  <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –∫–∞–∫ –¥–ª—è –≥–æ—Ä–æ–¥–∞ -->
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <select id="themeSelect" class="input" style="max-width:260px">
      <option value="violet">Violet</option>
      <option value="navy">Navy</option>
      <option value="emerald">Emerald</option>
      <option value="sunset">Sunset</option>
      <option value="peach">Peach</option>
      <option value="sunrise">Sunrise</option>
      <option value="amber">Amber</option>
      <option value="rose">Rose</option>
      <option value="mint">Mint</option>
      <option value="light1">Light 1</option>
      <option value="light2">Light 2</option>
    </select>
    <button id="applyThemeBtn" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>

  <div style="margin-top:16px; font-weight:900">–ì–æ—Ä–æ–¥</div>
  <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
    <select id="citySelect" class="input" style="max-width:260px">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî</option>
      <option>–ê–ª–º–∞—Ç—ã</option><option>–ê—Å—Ç–∞–Ω–∞</option><option>–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</option><option>–®—ã–º–∫–µ–Ω—Ç</option><option>–ê–∫—Ç–æ–±–µ</option>
    </select>
    <button id="saveCityBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
    <button id="syncNowBtn" class="btn">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
    <button id="openProfile" class="btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
  </div>
</div></div></div></section>
<section id="profileScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ü—Ä–æ—Ñ–∏–ª—å</h3><button onclick="closeScreen('profileScreen'); openScreen('settingsModal');" class="btn ghost">–ù–∞–∑–∞–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button></div><div id="profileWrap" style="margin-top:12px"></div></div></div></section>
<section id="walletScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ö–æ—à–µ–ª—ë–∫</h3><button onclick="closeScreen('walletScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="walletWrap" style="margin-top:12px"></div></div></div></section>
<section id="cityThreadScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3><button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div style="margin-top:12px;"><div class="city-composer"><input id="cityPostText" class="input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—å—é..."><label class="btn"><input type="file" id="cityPostImage" accept="image/*" style="display:none">–§–æ—Ç–æ</label><button id="cityPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div><div id="cityPosts" style="margin-top:12px;"></div></div></div></div></section>
<section id="repostScreen" class="screen"><div class="modal"><div class="content-inner"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–†–µ–ø–æ—Å—Ç –≤ —á–∞—Ç</h3><button onclick="closeScreen('repostScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="repostList" style="margin-top:12px"></div></div></div></section>

<script>
/* =================== CONSTANTS / STORE =================== */
const LS_ORD='gid_orders_v13', LS_CHAT='gid_chats_v13', LS_ADS='gid_ads_v2', LS_PROFILE='gid_profile_v1', LS_ROLE='gid_role_v1', LS_CITY='gid_city_v1', LS_NOTIF='gid_notif_v1', LS_WALLET='gid_wallet_v1', LS_THEME='gid_theme_v1', LS_CITY_FEED='gid_city_feed_v3';

const $=id=>document.getElementById(id);
const uid=()=>Math.random().toString(36).slice(2,9);
const nowISO=()=>new Date().toISOString();

function displayName(p){
  if(!p) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  const nm=[p.firstName||'', p.lastName||''].join(' ').trim() || p.name || '';
  if(nm) return nm;
  const l=p.login||'';
  if(/^\+?\d[\d\s\-()]{6,}$/.test(l)) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  return l || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
}
function esc(s){
  return String(s||'').replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]);
  });
}

const Store={
  getOrders(){try{return JSON.parse(localStorage.getItem(LS_ORD))||[]}catch(e){return[]}}, setOrders(v){localStorage.setItem(LS_ORD,JSON.stringify(v))},
  addOrder(o){const a=this.getOrders();a.unshift(o);this.setOrders(a);return a},
  updateOrder(id,fn){const a=this.getOrders();const i=a.findIndex(x=>x.id===id);if(i>-1){fn(a[i]);this.setOrders(a);}return a},

  getChats(){try{return JSON.parse(localStorage.getItem(LS_CHAT))||[]}catch(e){return[]}}, setChats(v){localStorage.setItem(LS_CHAT,JSON.stringify(v))},
  addChat(c){const a=this.getChats();a.unshift(c);this.setChats(a);return a},
  updateChat(id,fn){const a=this.getChats();const i=a.findIndex(x=>x.id===id);if(i>-1){fn(a[i]);this.setChats(a);}return a},

  getAds(){try{return JSON.parse(localStorage.getItem(LS_ADS))||[]}catch(e){return[]}}, setAds(v){localStorage.setItem(LS_ADS,JSON.stringify(v))},

  getProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE))||null}catch(e){return null}}, setProfile(p){localStorage.setItem(LS_PROFILE,JSON.stringify(p))},

  getRole(){return localStorage.getItem(LS_ROLE)||'user'}, setRole(r){localStorage.setItem(LS_ROLE,r)},

  getCity(){return localStorage.getItem(LS_CITY)||'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'}, setCity(c){localStorage.setItem(LS_CITY,c)},

  getNotifs(){try{return JSON.parse(localStorage.getItem(LS_NOTIF))||[]}catch(e){return[]}}, setNotifs(a){localStorage.setItem(LS_NOTIF,JSON.stringify(a))},

  getWallet(){try{return JSON.parse(localStorage.getItem(LS_WALLET))||{balance:0,ops:[]}}catch(e){return{balance:0,ops:[]}}}, setWallet(w){localStorage.setItem(LS_WALLET,JSON.stringify(w))},

  getTheme(){return localStorage.getItem(LS_THEME)||'violet'}, setTheme(t){localStorage.setItem(LS_THEME,t); applyTheme(); },

  getCityFeed(){ try{return JSON.parse(localStorage.getItem(LS_CITY_FEED))||{} }catch(_){ return {} } },
  setCityFeed(obj){ localStorage.setItem(LS_CITY_FEED, JSON.stringify(obj)); saveCloudDebounced(); }
};

/* =================== THEME / CITY / BADGE =================== */
function applyTheme(){ document.documentElement.setAttribute('data-theme', Store.getTheme()); }
function updateCityLabel(){ const c=Store.getCity()||'‚Äî'; $('topCity').textContent='–ì–æ—Ä–æ–¥: '+c; $('cityTopLabel').textContent=c; const sel=$('citySelect'); if(sel) sel.value=c||''; }
function refreshNotifBadge(){ const n=Store.getNotifs().length; const b=$('notifBadge'); if(n>0){b.style.display='flex';b.textContent=n>99?'99+':String(n);}else b.style.display='none'; }

/* =================== SCREENS =================== */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const el=$(id); if(el) el.classList.add('active'); window.scrollTo(0,0); }
function closeScreen(id){ const el=$(id); if(el) el.classList.remove('active'); }

/* =================== ICONS =================== */
function iconFor(key){
  const icons={
    order:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18"/><path d="M7 3v4"/><path d="M17 3v4"/><rect x="3" y="7" width="18" height="14" rx="2"/></svg>`,
    ads:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11h18"/><path d="M7 6v6"/><path d="M17 6v6"/></svg>`,
    find:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="6"/><path d="M21 21l-4.35-4.35"/></svg>`,
    city:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21v-8a2 2 0 0 1 2-2h3v10"/><path d="M14 21V10h4v11"/><path d="M7 10V3h7v7"/></svg>`,
    mine:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/><path d="M21 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/></svg>`,
    chat:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
    wallet:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3v4"/><circle cx="18" cy="13" r="1"/></svg>`
  };
  key = (key||'').toLowerCase();
  if(/—Ç–∞–∫—Å–∏|–∑–∞–∫–∞–∑/.test(key)) return icons.order;
  if(/–æ–±—ä—è–≤–ª–µ–Ω/.test(key)) return icons.ads;
  if(/–Ω–∞–π—Ç–∏|–ø–æ–∏—Å–∫/.test(key)) return icons.find;
  if(/–≥–æ—Ä–æ–¥|—á–∞—Ç/.test(key)) return icons.city;
  if(/–º–æ–∏|–∑–∞–∫–∞–∑—ã|mine|–Ω–∞–∑–Ω–∞—á/.test(key)) return icons.mine;
  if(/–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä|—á–∞—Ç|message/.test(key)) return icons.chat;
  if(/–∫–æ—à–µ–ª|–±–∞–ª–∞–Ω—Å|wallet/.test(key)) return icons.wallet;
  return icons.order;
}

/* =================== ROLE & MENU =================== */
function setRoleTabs(){
  const wrap=$('roleTabs'); wrap.innerHTML='';
  const roles=['user','worker'];
  const labels={'user':'–°–§–ï–†–ê –£–°–õ–£–ì','worker':'–ü–û–î–†–ê–ë–û–¢–ö–ê'};
  roles.forEach(r=>{
    const d=document.createElement('div'); d.className='role-tab'; d.dataset.role=r; d.textContent=labels[r]; if(Store.getRole()===r) d.classList.add('active');
    wrap.appendChild(d);
  });
  wrap.onclick=(e)=>{
    const t=e.target.closest('.role-tab'); if(!t) return; Store.setRole(t.dataset.role); applyRoleUI();
  };
}
function menuBtn(id,title,note,extraClass){ const d=document.createElement('div'); d.id=id; d.className='menu-btn'+(extraClass?(' '+extraClass):''); d.innerHTML=`<div class="left">${iconFor(title)}</div><div style="flex:1"><div class="title">${title}</div><div class="note">${note}</div></div>`; return d; }
function applyRoleUI(){
  document.querySelectorAll('.role-tab').forEach(x=>x.classList.toggle('active', x.dataset.role===Store.getRole()));
  const role=Store.getRole(), grid=$('menuGrid'); grid.innerHTML='';
  if(role==='user'){
    grid.appendChild(menuBtn('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞','primary'));
    grid.appendChild(menuBtn('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'));
    grid.appendChild(menuBtn('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  }else{
    grid.appendChild(menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π','primary'));
    grid.appendChild(menuBtn('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'));
    grid.appendChild(menuBtn('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  }
  const items = Array.from(grid.children);
  grid.classList.add('revealing');
  items.forEach((it,idx)=>{ it.style.animationDelay = (idx*80)+'ms'; });
  setTimeout(()=>{ grid.classList.remove('revealing'); items.forEach(it=>it.style.animationDelay=''); }, 1200);
  wireMainButtons();
}

/* =================== NOTIFICATIONS =================== */
function pushNotif(n){ const arr=Store.getNotifs(); arr.unshift(n); Store.setNotifs(arr); refreshNotifBadge(); }

/* =================== FIND (demo minimal) =================== */
function renderFindList(){
  const wrap=$('findList'); if(!wrap) return; wrap.innerHTML='';
  const city=Store.getCity(); let items=Store.getOrders().filter(o=>o.status==='open');
  const q=(document.getElementById('searchInput')?.value||'').toLowerCase().trim();
  if(q) items=items.filter(o=>[o.category,o.desc,o.city].join(' ').toLowerCase().includes(q));
  if(city) items=items.filter(o=>!o.city || o.city===city);
  if(!items.length){ wrap.innerHTML='<div class="small" style="padding:12px">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div style="flex:0 0 36px" class="avatar">${(o.ownerName||'–ü')[0]||'–ü'}</div>
      <div style="flex:1">
        <div style="font-weight:900">${esc(o.category)} ‚Ä¢ ${esc(o.city)} ‚Ä¢ ‚Ç∏ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>
        <div class="small" style="margin-top:6px">–î–µ–¥–ª–∞–π–Ω: ${(o.datetime||'').replace('T',' ')}</div>
        <div style="margin-top:8px; white-space:pre-wrap">${esc(o.desc)}</div>
      </div>`;
    wrap.appendChild(card);
  });
}

document.getElementById('applySearch')?.addEventListener('click',renderFindList);

/* =================== CREATE ORDER =================== */
const CATEGORY_HINTS={
  '–°–ü–ï–¶. –ó–ê–ö–ê–ó':'–û–ø–∏—à–∏—Ç–µ –ª—é–±—É—é –∑–∞–¥–∞—á—É: —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –≥–¥–µ, —Å—Ä–æ–∫–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è.',
  '–¢–∞–∫—Å–∏':'–ú–∞—Ä—à—Ä—É—Ç: –û—Ç–∫—É–¥–∞ ‚Üí –ö—É–¥–∞, –≤—Ä–µ–º—è –ø–æ–¥–∞—á–∏, –ø–∞—Å—Å–∞–∂–∏—Ä—ã/–±–∞–≥–∞–∂.',
  '–ö—É—Ä—å–µ—Ä':'–ß—Ç–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å, –∞–¥—Ä–µ—Å–∞, –≤–µ—Å/–≥–∞–±–∞—Ä–∏—Ç—ã, –∫–æ–≥–¥–∞.',
  '–î–æ—Å—Ç–∞–≤–∫–∞':'–ß—Ç–æ –∫—É–ø–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å, –∞–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞, –¥–æ—Å—Ç–∞–≤–∫–∞.',
  '–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)':'–¢–∏–ø —Å–¥–µ–ª–∫–∏, —Ä–∞–π–æ–Ω, –∫–æ–º–Ω–∞—Ç—ã, –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã/–±—é–¥–∂–µ—Ç, —É—Å–ª–æ–≤–∏—è.',
  '–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç':'–ö–æ–≥–æ –∏—â–µ—Ç–µ (–Ω—è–Ω—è/–ø—Å–∏—Ö–æ–ª–æ–≥/–º–∞—Å—Ç–µ—Ä), —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å, –∞–¥—Ä–µ—Å.',
  '–ü—Ä–æ—á–∏–µ':'–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–æ–¥—Ä–æ–±–Ω–æ, –≥–¥–µ –∏ –∫–æ–≥–¥–∞.'
};
const CATEGORY_FIELDS={
  '–¢–∞–∫—Å–∏':()=>`<div class="row"><input class="input" id="f-from" placeholder="–û—Ç–∫—É–¥–∞"><input class="input" id="f-to" placeholder="–ö—É–¥–∞"></div>`,
  '–ö—É—Ä—å–µ—Ä':()=>`<div class="row"><input class="input" id="f-pick" placeholder="–ó–∞–±—Ä–∞—Ç—å (–∞–¥—Ä–µ—Å)"><input class="input" id="f-drop" placeholder="–î–æ—Å—Ç–∞–≤–∏—Ç—å (–∞–¥—Ä–µ—Å)"></div>`,
  '–î–æ—Å—Ç–∞–≤–∫–∞':()=>`<div class="row"><input class="input" id="f-what" placeholder="–ß—Ç–æ –∫—É–ø–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å"><input class="input" id="f-daddr" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"></div>`,
  '–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)':()=>`
    <div class="row">
      <select class="input" id="f-deal"><option>–ê—Ä–µ–Ω–¥–∞</option><option>–ü—Ä–æ–¥–∞–∂–∞</option></select>
      <input class="input" id="f-area" placeholder="–†–∞–π–æ–Ω">
      <input class="input" id="f-rooms" placeholder="–ö–æ–º–Ω–∞—Ç (1,2,3...)">
    </div>
    <div class="row">
      <input class="input" id="f-period" placeholder="–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã (–µ—Å–ª–∏ –∞—Ä–µ–Ω–¥–∞)">
      <input class="input" id="f-square" placeholder="–ü–ª–æ—â–∞–¥—å (–º¬≤)">
    </div>`,
  '–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç':()=>`<div class="row"><input class="input" id="f-role" placeholder="–ö–æ–≥–æ –∏—â–µ—Ç–µ (–Ω—è–Ω—è/–ø—Å–∏—Ö–æ–ª–æ–≥/–º–∞—Å—Ç–µ—Ä)"><input class="input" id="f-model" placeholder="–î–µ—Ç–∞–ª–∏"></div>`
};
const CATEGORY_CRITERIA={
  '–°–ü–ï–¶. –ó–ê–ö–ê–ó':['–°—Ä–æ—á–Ω–æ','–°–µ–≥–æ–¥–Ω—è','–í—ã–µ–∑–¥','–û–Ω–ª–∞–π–Ω','–ì–∞—Ä–∞–Ω—Ç–∏—è'],
  '–¢–∞–∫—Å–∏':['–î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ','–î–æ 4 –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤','–ë–∞–≥–∞–∂','–ù–∞–ª–∏—á–Ω—ã–µ','–ë–µ–∑–Ω–∞–ª'],
  '–ö—É—Ä—å–µ—Ä':['–°—Ä–æ—á–Ω–æ','–î–æ 5 –∫–≥','–•—Ä—É–ø–∫–æ–µ','–§–æ—Ç–æ-–æ—Ç—á—ë—Ç'],
  '–î–æ—Å—Ç–∞–≤–∫–∞':['–ö—É–ø–∏—Ç—å –∏ –ø—Ä–∏–≤–µ–∑—Ç–∏','–û–ø–ª–∞—Ç–∞ –Ω–∞ –º–µ—Å—Ç–µ','–ë–µ–∑–Ω–∞–ª'],
  '–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)':['–ú–µ–±–ª–∏—Ä–æ–≤–∞–Ω–∞','–ë–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–≤','–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ'],
  '–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç':['–ù–∞ –¥–æ–º—É','–° –æ–ø—ã—Ç–æ–º','–ü–æ—á–∞—Å–æ–≤–∞—è'],
  '–ü—Ä–æ—á–∏–µ':['–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è —Ü–µ–Ω–∞','–ù–∞–ª–∏—á–Ω—ã–µ','–ë–µ–∑–Ω–∞–ª']
};
function renderCriteria(cat){
  const wrap=$('criteriaWrap'); wrap.innerHTML='';
  (CATEGORY_CRITERIA[cat]||[]).forEach(name=>{
    const b=document.createElement('button'); b.type='button'; b.className='crit'; b.textContent=name;
    b.onclick=()=>b.classList.toggle('active'); wrap.appendChild(b);
  });
}

document.getElementById('createTabs').addEventListener('click', e=>{
  const t=e.target.closest('.create-tab'); if(!t) return;
  document.querySelectorAll('#createTabs .create-tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); const cat=t.dataset.val||t.textContent;
  $('c-desc').placeholder=CATEGORY_HINTS[cat] || CATEGORY_HINTS['–°–ü–ï–¶. –ó–ê–ö–ê–ó'];
  $('createExtraFields').innerHTML=(CATEGORY_FIELDS[cat]?.()||'');
  renderCriteria(cat);
});

$('createForm').addEventListener('submit',e=>{
  e.preventDefault();
  const profile=Store.getProfile(); if(!profile){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); openScreen('authScreen'); return; }
  const cat=document.querySelector('#createTabs .create-tab.active')?.dataset.val||'–î—Ä—É–≥–æ–µ';
  const desc=$('c-desc').value.trim(); const budget=Number($('c-budget').value||0); const datetime=$('c-datetime').value||'';
  if(!desc||!datetime){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É'); return; }
  let extra='';
  if(cat==='–¢–∞–∫—Å–∏'){ extra=`
–ú–∞—Ä—à—Ä—É—Ç: ${($('f-from')?.value||'')} ‚Üí ${($('f-to')?.value||'')}`.trim(); }
  if(cat==='–ö—É—Ä—å–µ—Ä'){ extra=`
–û—Ç–∫—É–¥–∞: ${($('f-pick')?.value||'')} ‚Üí –ö—É–¥–∞: ${($('f-drop')?.value||'')}`.trim(); }
  if(cat==='–î–æ—Å—Ç–∞–≤–∫–∞'){ extra=`
–ß—Ç–æ: ${($('f-what')?.value||'')} ‚Ä¢ –ê–¥—Ä–µ—Å: ${($('f-daddr')?.value||'')}`.trim(); }
  if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)'){
    const deal=$('f-deal')?.value||'', area=$('f-area')?.value||'', rooms=$('f-rooms')?.value||'', period=$('f-period')?.value||'', sq=$('f-square')?.value||'';
    extra=`
–°–¥–µ–ª–∫–∞: ${deal} ‚Ä¢ –†–∞–π–æ–Ω: ${area} ‚Ä¢ –ö–æ–º–Ω–∞—Ç: ${rooms} ‚Ä¢ –ü–µ—Ä–∏–æ–¥: ${period} ‚Ä¢ –ü–ª–æ—â–∞–¥—å: ${sq}`.trim();
  }
  if(cat==='–ú–∞—Å—Ç–µ—Ä/–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'){ extra=`
–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: ${($('f-role')?.value||'')} ‚Ä¢ –î–µ—Ç–∞–ª–∏: ${($('f-model')?.value||'')}`.trim(); }

  const crit=Array.from(document.querySelectorAll('#criteriaWrap .crit.active')).map(x=>x.textContent).join(', ');
  const critLine = crit?`
–ö—Ä–∏—Ç–µ—Ä–∏–∏: ${crit}`:'';

  const fullDesc=desc+(extra?('
'+extra):'')+critLine;
  const order={id:'o_'+uid(), category:cat, desc:fullDesc, budget, datetime, city:Store.getCity()||'‚Äî', ownerId:profile.id, ownerName:displayName(profile), bids:[], status:'open', createdAt:nowISO()};
  Store.addOrder(order);
  pushNotif({ id:'n_'+uid(), type:'created', title:'–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω', body:`–í–∞—à –∑–∞–∫–∞–∑ "${cat}" –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω`, payload:{orderId:order.id}, ts:nowISO() });
  closeScreen('createScreen'); renderFindList(); alert('–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'); saveCloudDebounced?.();
});

// –î–µ–¥–ª–∞–π–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –±–ª–∏–∂–∞–π—à–∏–µ 30 –º–∏–Ω—É—Ç + min
(function initDeadline(){
  const in30=new Date(Date.now()+30*60*1000); const pad=n=>String(n).padStart(2,'0');
  const v=in30.getFullYear()+"-"+pad(in30.getMonth()+1)+"-"+pad(in30.getDate())+"T"+pad(in30.getHours())+":"+pad(in30.getMinutes());
  const el=$('c-datetime'); if(el){ el.value=v; el.min=v; }
})();

/* =================== CITY THREAD: —Ä–∞–±–æ—á–∞—è –ª–µ–Ω—Ç–∞ —Å –ª–∞–π–∫–∞–º–∏/–∫–æ–º–º–µ–Ω—Ç–∞–º–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ =================== */
let __cityImg=null, __repostPost=null;
function initials(name){if(!name)return'?';const p=(name||'').split(/\s+/);return(p[0]||'').slice(0,2).toUpperCase()}
function renderAvatar(el, name, type, data){
  el.innerHTML=''; el.style.background='';
  if(type==='image' && data){ const img=document.createElement('img'); img.src=data; img.alt='avatar'; el.appendChild(img); return; }
  if(type==='emoji' && data){ el.textContent=data; el.style.fontSize='14px'; el.style.lineHeight='24px'; el.style.background='linear-gradient(135deg,#a970ff,#32ffd2)'; return; }
  const pal=['#a970ff','#6a8cff','#32ffd2','#61e6ff','#ffaa6b']; let h=0; for(let i=0;i<(name||'').length;i++)h+=name.charCodeAt(i);
  const a=pal[h%pal.length], b=pal[(h+1)%pal.length]; el.style.background=`linear-gradient(135deg, ${a}, ${b})`; el.textContent=initials(name||'');
}

function postById(city, id){ const feed=Store.getCityFeed(); return (feed[city]||[]).find(p=>p.id===id); }
function updateFeedCity(city, modify){ const feed=Store.getCityFeed(); const list=(feed[city]||[]); modify(list); feed[city]=list; Store.setCityFeed(feed); }

function renderCityPosts(){
  const container=$('cityPosts'); if(!container) return; container.innerHTML='';
  const city=Store.getCity()||'‚Äî';
  const feed=Store.getCityFeed(); const posts=(feed[city]||[]);
  if(!posts.length){ container.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
  posts.forEach(p=> container.appendChild(renderPostCard(p, city)) );
}

function renderPostCard(p, city){
  const card=document.createElement('div'); card.className='post-card'; card.dataset.postId=p.id;
  const likesCount=Object.keys(p.likes?.byUser||{}).length;
  const name=p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  card.innerHTML=
    `<div style="display:flex; gap:8px; align-items:center;">
      <div class="avatar" style="width:32px;height:32px" id="postAv_${p.id}"></div>
      <div style="font-weight:900">${esc(name)}</div>
      <div class="small" style="margin-left:auto">${new Date(p.ts).toLocaleString()}</div>
    </div>
    <div class="post-text" style="margin-top:8px; white-space:pre-wrap">${esc(p.text||'')}</div>`+
    (p.image?`<img class="post-img" src="${p.image}" alt="">`:'')+
    `<div class="post-actions">
      <button class="btn" data-act="like">‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è (<span data-likecount>${likesCount}</span>)</button>
      <button class="btn" data-act="comment">üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn" data-act="repost">üîÅ –†–µ–ø–æ—Å—Ç</button>
    </div>
    <div class="comments" style="margin-top:8px; display:none">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
        <button class="btn primary" data-act="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="comments-list"></div>
    </div>`;
  renderAvatar(document.getElementById('postAv_'+p.id), p.authorName, p.authorAvatarType, p.authorAvatarData);
  const list=card.querySelector('.comments-list');
  (p.comments||[]).forEach(c=>{
    const cEl=document.createElement('div'); cEl.className='comment';
    cEl.innerHTML=`<div style="display:flex; gap:6px; align-items:center;">
      <div class="avatar" style="width:20px;height:20px" id="cav_${c.id}"></div>
      <div style="font-weight:800">${esc(c.authorName||'')}</div>
      <div class="small" style="margin-left:auto">${new Date(c.ts).toLocaleString()}</div>
    </div>
    <div style="margin-top:6px; white-space:pre-wrap">${esc(c.text||'')}</div>`;
    list.appendChild(cEl);
    renderAvatar(document.getElementById('cav_'+c.id), c.authorName, c.authorAvatarType, c.authorAvatarData);
  });

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ª–∞–π–∫–∞/–∫–æ–º–º–µ–Ω—Ç–æ–≤ (–∂–∏–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞)
  card.addEventListener('click', (e)=>{
    const btn=e.target.closest('[data-act]'); if(!btn) return;
    const act=btn.dataset.act;
    if(act==='like'){
      const meId=(Store.getProfile()?.id)||'u_demo_user';
      updateFeedCity(city, list=>{
        const post=list.find(x=>x.id===p.id); post.likes||(post.likes={byUser:{}});
        if(post.likes.byUser[meId]) delete post.likes.byUser[meId]; else post.likes.byUser[meId]=true;
        const count=Object.keys(post.likes.byUser).length;
        card.querySelector('[data-likecount]').textContent=String(count);
      });
    }else if(act==='comment'){
      const box=card.querySelector('.comments'); box.style.display=box.style.display==='none'?'block':'none';
    }else if(act==='sendComment'){
      const input=card.querySelector('.comments input'); const text=input.value.trim(); if(!text) return;
      const me=Store.getProfile();
      const newC={ id:'c_'+uid(), authorName:displayName(me), authorAvatarType:me?.avatarType, authorAvatarData:me?.avatarData, text, ts: nowISO() };
      updateFeedCity(city, list=>{ const post=list.find(x=>x.id===p.id); (post.comments||(post.comments=[])).push(newC); });
      // append –±–µ–∑ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞
      const cEl=document.createElement('div'); cEl.className='comment';
      cEl.innerHTML=`<div style="display:flex; gap:6px; align-items:center;">
        <div class="avatar" style="width:20px;height:20px" id="cav_${newC.id}"></div>
        <div style="font-weight:800">${esc(newC.authorName||'')}</div>
        <div class="small" style="margin-left:auto">${new Date(newC.ts).toLocaleString()}</div>
      </div>
      <div style="margin-top:6px; white-space:pre-wrap">${esc(newC.text||'')}</div>`;
      list.appendChild(cEl); renderAvatar(document.getElementById('cav_'+newC.id), newC.authorName, newC.authorAvatarType, newC.authorAvatarData);
      input.value='';
    }else if(act==='repost'){
      __repostPost=p; openRepostPicker();
    }
  });

  return card;
}

function openRepostPicker(){
  openScreen('repostScreen');
  const list=$('repostList'); list.innerHTML='';
  const chats=Store.getChats?.()||[];
  if(!chats.length){ list.innerHTML='<div class="small" style="padding:12px">–ù–µ—Ç —á–∞—Ç–æ–≤ –¥–ª—è —Ä–µ–ø–æ—Å—Ç–∞</div>'; return; }
  chats.forEach(c=>{
    const item=document.createElement('div'); item.className='card'; item.style.cursor='pointer';
    const other=(c.participantsMeta&&Object.values(c.participantsMeta)[0])||{name:'–ß–∞—Ç'};
    item.innerHTML=`<div style="font-weight:900">${esc(other.name||'–ß–∞—Ç')}</div><div class="small" style="margin-top:6px">${esc(c.title||'')}</div>`;
    item.addEventListener('click',()=>{ if(!__repostPost) return; repostToChat(c.id, __repostPost); closeScreen('repostScreen'); });
    list.appendChild(item);
  });
}
function repostToChat(chatId, post){
  Store.updateChat?.(chatId, c=>{
    const me=Store.getProfile()?.id||'u_demo_user';
    const snippet = `üîÅ –†–µ–ø–æ—Å—Ç –∏–∑ "–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞" ‚Äî ${Store.getCity()||'‚Äî'}:
${post.text||''}`;
    (c.messages||(c.messages=[])).push({ fromId:me, text: snippet, ts: nowISO() });
    if(post.image){ c.messages.push({ fromId:me, text:'[—Ñ–æ—Ç–æ]', image: post.image, ts: nowISO() }); }
    const other=(c.participants||[]).find(p=>p!==me); if(other){ c.unread||(c.unread={}); c.unread[other]=(c.unread[other]||0)+1; }
  });
  pushNotif({ id:'n_'+uid(), type:'message', title:'–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', body:`–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç`, payload:{chatId}, ts:nowISO() });
}

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–∞ (—Ñ–∏–∫—Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π) + –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π prepend
$('cityPostImage').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ __cityImg=r.result; alert('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); }; r.readAsDataURL(f); });
$('cityPostSend').addEventListener('click',()=>{
  const text=$('cityPostText').value.trim(); if(!text && !__cityImg){ alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ'); return; }
  const city=Store.getCity()||'‚Äî'; const me=Store.getProfile();
  const post={ id:'post_'+uid(), authorName: displayName(me), authorAvatarType:me?.avatarType, authorAvatarData:me?.avatarData, text, image: __cityImg||null, ts: nowISO(), likes:{byUser:{}}, comments:[] };
  updateFeedCity(city, list=>{ list.unshift(post); });
  const container=$('cityPosts');
  if(container){
    if(container.firstChild && container.firstChild.classList?.contains('small')) container.innerHTML='';
    container.prepend(renderPostCard(post, city));
  }
  $('cityPostText').value=''; __cityImg=null;
});

/* =================== SETTINGS =================== */
$('openNotifications').addEventListener('click',()=>{ openScreen('notificationsModal'); });
$('clearNotifications').addEventListener('click',()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')){ Store.setNotifs([]); refreshNotifBadge(); } });
$('openSettings').addEventListener('click',()=>{ openScreen('settingsModal'); $('citySelect').value=Store.getCity()||''; $('themeSelect').value=Store.getTheme(); });
$('applyThemeBtn').addEventListener('click',()=>{ const v=$('themeSelect').value; if(!v) return; Store.setTheme(v); applyTheme(); alert('–¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞'); });
$('saveCityBtn').addEventListener('click',()=>{ const v=$('citySelect').value.trim(); if(!v) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); Store.setCity(v); updateCityLabel(); alert('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });

/* =================== MAIN BUTTONS =================== */
function wireMainButtons(){
  const on=(id,fn)=>{ const el=$(id); if(el){ const clone=el.cloneNode(true); el.parentNode.replaceChild(clone,el); clone.addEventListener('click',fn); } };
  on('btnOrder',()=>{ openScreen('createScreen'); });
  on('btnFind',()=>{ openScreen('findScreen'); renderFindList(); });
  on('btnMessenger',()=>{ openScreen('messengerScreen'); });
  on('btnWallet',()=>{ openScreen('walletScreen'); });
  on('btnMine',()=>{ openScreen('mineScreen'); });
  on('btnAds',()=>{ openScreen('adsScreen'); });
  on('btnCityThread',()=>{ openScreen('cityThreadScreen'); renderCityPosts(); });
}

/* =================== CLOUD SYNC (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ) =================== */
const CLOUD = { ENABLED: true, BIN_ID: '6911fbe843b1c97be9a4dc97', KEY:  '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG', POLL_MS: 8000 };
const CloudAPI = { url: id => `https://api.jsonbin.io/v3/b/${id}`, headers: key => ({ 'Content-Type':'application/json','X-Master-Key': key,'X-Bin-Versioning':'false' }) };
let __cloudLoading=false, __cloudSaving=false, __saveTimer=null, cloudCache={orders:[],ads:[],cityFeed:{}};
async function loadCloud(){
  if(!CLOUD.ENABLED||__cloudLoading) return; __cloudLoading=true;
  try{
    const res=await fetch(CloudAPI.url(CLOUD.BIN_ID),{headers:{'X-Master-Key':CLOUD.KEY}});
    if(!res.ok) throw new Error('GET '+res.status);
    const data=await res.json();
    const remote=data.record||{};
    cloudCache.orders=Array.isArray(remote.orders)?remote.orders:[];
    cloudCache.ads=Array.isArray(remote.ads)?remote.ads:[];
    cloudCache.cityFeed=remote.cityFeed||{};
    localStorage.setItem(LS_CITY_FEED, JSON.stringify(cloudCache.cityFeed));
    renderCityPosts();
  }catch(e){ console.warn('Cloud load error:', e); }
  finally{ __cloudLoading=false; }
}
async function saveCloud(){
  if(!CLOUD.ENABLED||__cloudSaving) return; __cloudSaving=true;
  try{
    const payload={ orders: Store.getOrders?.()||[], ads: Store.getAds?.()||[], cityFeed: Store.getCityFeed() };
    cloudCache=payload;
    const res=await fetch(CloudAPI.url(CLOUD.BIN_ID),{ method:'PUT', headers: CloudAPI.headers(CLOUD.KEY), body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('PUT '+res.status);
  }catch(e){ console.warn('Cloud save error:', e); }
  finally{ __cloudSaving=false; }
}
function saveCloudDebounced(){ clearTimeout(__saveTimer); __saveTimer=setTimeout(saveCloud, 700); }
$('syncNowBtn')?.addEventListener('click', async ()=>{ await loadCloud(); alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); });

/* =================== INITIAL =================== */
function setRoleTabsAndUI(){ setRoleTabs(); applyRoleUI(); }
function initial(){
  applyTheme();
  updateCityLabel(); refreshNotifBadge();
  if(!Store.getRole()) Store.setRole('user');
  setRoleTabsAndUI(); wireMainButtons();
}
initial();

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–µ–º–æ
$('authForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const login=$('authLogin').value.trim(), pass=$('authPass').value.trim(); if(!login||!pass) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
  const prof={id:'u_'+uid(), login, name:login.split('@')[0]||login, createdAt:nowISO()}; Store.setProfile(prof);
  alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); closeScreen('authScreen'); initial(); await loadCloud();
});
$('registerBtn').addEventListener('click',async ()=>{ const email=prompt('Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω:','user@example.com'); if(!email) return; const prof={id:'u_'+uid(), login:email, name:email.split('@')[0]||email, createdAt:nowISO()}; Store.setProfile(prof); alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ'); closeScreen('authScreen'); initial(); await loadCloud(); });
setInterval(()=>{ loadCloud(); }, CLOUD.POLL_MS);

/* =================== INLINE TESTS =================== */
(function runTests(){
  try{
    console.assert(esc("<b>&'"") === "&lt;b&gt;&amp;&#039;&quot;", 'esc() should escape HTML special chars');
    console.assert(document.querySelector('#createTabs .create-tab') !== null, 'createTabs exists');
    // –ì–æ—Ä–æ–¥—Å–∫–æ–π —á–∞—Ç: –ø—É–±–ª–∏–∫–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const beforeCount = document.querySelectorAll('#cityPosts .post-card').length;
    const city=Store.getCity()||'‚Äî';
    const testPost={ id:'post_TEST', authorName:'–¢–µ—Å—Ç', text:'–¢–µ—Å—Ç –ø–æ—Å—Ç', ts: nowISO(), likes:{byUser:{}}, comments:[] };
    (function(){ const feed=Store.getCityFeed(); (feed[city]||(feed[city]=[])).unshift(testPost); Store.setCityFeed(feed); })();
    renderCityPosts();
    const afterCount = document.querySelectorAll('#cityPosts .post-card').length;
    console.assert(afterCount >= beforeCount+1, 'city feed should render new post');
    // –£–¥–∞–ª–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç
    (function(){ const feed=Store.getCityFeed(); feed[city]=feed[city].filter(p=>p.id!=='post_TEST'); Store.setCityFeed(feed); renderCityPosts(); })();
    console.log('%cInline tests passed','color:lime');
  }catch(err){ console.error('Tests failed:', err); }
})();

console.log('GiD City initialized (full v3 with fixes)');
</script>
</body>
</html>
