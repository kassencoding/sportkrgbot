<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiDCity — Local Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ===========================
   GiDCity — single-file UI CSS
   =========================== */
:root{
  --bg1: #6f5bff; --bg2:#000; --bg3:#06122a;
  --accent1:#b37aff; --accent2:#7BFF5A; --gold:#f5c24a;
  --glass: rgba(255,255,255,0.03); --muted: rgba(255,255,255,0.64); --text:#fff;
  --radius:12px; --ui-font-size:14px; --primary-cta: linear-gradient(90deg,#ffd84d,#ffcf3b);
  --secondary-cta: linear-gradient(90deg,var(--accent1),var(--accent2));
  --panel-opaque: rgba(8,8,12,0.98);
}

/* base reset */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:14px; font-family:-apple-system,BlinkMacSystemFont,"Inter","SF Pro Text","Helvetica Neue",Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  background:
    radial-gradient(700px 360px at 8% 8%, rgba(179,122,255,0.06), transparent 8%),
    linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 36%, var(--bg3) 100%);
  color:var(--text); display:flex; justify-content:center; font-size:var(--ui-font-size);
}

/* wrapper */
.wrapper{ width:100%; max-width:1000px; display:flex; flex-direction:column; gap:12px; }

/* header */
.header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
.brand{ display:flex; align-items:center; gap:10px; }
.brand h1{ margin:0; font-size:20px; font-weight:800 }
.brand .gid{ color:#fff } .brand .city{ color:var(--accent1) }
.header-right{ display:flex; align-items:center; gap:10px; }

/* weather */
.weather{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px }
.weather .icon{ width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center }

/* settings button (raised a bit to avoid overlap) */
.settings-btn{
  width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); cursor:pointer; transition:transform .12s ease; margin-top:-6px; z-index:40;
}
.settings-btn:hover{ transform:translateY(-3px) }

/* main container */
.container{
  width:100%; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
  border-radius:14px; border:1px solid rgba(255,255,255,0.04); padding:14px; box-shadow:0 28px 60px rgba(0,0,0,0.55); position:relative;
}

/* menu layout (primary CTA lower) */
.menu-grid{ display:flex; flex-direction:column; gap:10px; min-height:240px }
.menu-top{ display:flex; flex-direction:column; gap:10px }
.menu-bottom{ margin-top:8px; display:flex; flex-direction:column; gap:8px }

/* menu item */
.menu-item{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-radius:10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03); cursor:pointer }
.menu-item .title{ font-weight:800; font-size:15px } .menu-item .sub{ color:var(--muted); font-weight:700; font-size:13px }

/* primary CTA */
.menu-item.primary{ border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); box-shadow: 0 8px 28px rgba(0,0,0,0.45); }

/* list/cards */
.list{ display:flex; flex-direction:column; gap:10px; margin-top:10px }
.card{ display:flex; gap:10px; padding:10px; border-radius:10px; align-items:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03) }
.card-left{ flex:0 0 44px } .avatar{ width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; box-shadow:0 8px 18px rgba(0,0,0,0.45); font-size:14px }
.card-body{ flex:1 } .card-title{ font-weight:800; font-size:14px } .card-meta{ color:var(--muted); font-size:12px; margin-top:6px } .card-desc{ margin-top:8px; color:rgba(255,255,255,0.95); font-size:13px }

/* buttons */
.btn{ padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer; border:none; display:inline-flex; align-items:center; justify-content:center; font-size:13px }
.btn.primary{ background:var(--primary-cta); color:#111; box-shadow:0 8px 22px rgba(245,194,74,0.10); min-width:160px }
.btn.secondary{ background:var(--secondary-cta); color:#041; min-width:120px }
.btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); min-width:100px }

/* forms */
.form-field{ margin-top:10px } .input, textarea, select{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text); font-size:13px }
textarea{ min-height:120px; resize:vertical }

/* tabs */
.tabs{ display:flex; gap:8px; align-items:center; overflow:auto; padding-bottom:6px; margin-top:10px }
.tab{ padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); color:var(--muted); font-weight:700; cursor:pointer; font-size:13px; white-space:nowrap; background:transparent }
.tab.active{ color:#071; border-color: rgba(123,255,90,0.14); background: linear-gradient(90deg, rgba(123,255,90,0.05), rgba(179,122,255,0.03)) }
.tab.gold{ color:var(--gold); border-color: rgba(245,194,74,0.18); background: linear-gradient(90deg, rgba(245,194,74,0.06), rgba(255,255,255,0.01)) }

/* screens & panels */
.screen{ position:fixed; inset:0; display:none; z-index:60; padding:18px; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px) }
.screen.active{ display:block }
.panel{ max-width:840px; margin:28px auto; border-radius:14px; padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(0,0,0,0.14)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 20px 48px rgba(0,0,0,0.6); transform-origin:center bottom; transition: transform .28s cubic-bezier(.2,.9,.22,1), opacity .22s ease }

/* settings panel (matte) */
.settings-panel{ position:fixed; top:0; right:-420px; width:380px; height:100%; background: linear-gradient(180deg, var(--panel-opaque), rgba(6,6,8,0.98)); color:var(--text); border-left:1px solid rgba(255,255,255,0.04); box-shadow:-20px 0 60px rgba(0,0,0,0.6); transition:right .32s cubic-bezier(.2,.9,.22,1); z-index:130; padding:16px }
.settings-panel.open{ right:0 } .setting-row{ margin-top:12px; display:flex; gap:8px; align-items:center }

/* modal (bid) */
.modal-back{ position:fixed; inset:0; display:none; background: rgba(0,0,0,0.55); z-index:120; align-items:center; justify-content:center }
.modal{ background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.16)); border:1px solid rgba(255,255,255,0.06); padding:12px; border-radius:10px; width:92%; max-width:420px }
.modal-back.active{ display:flex }

/* small */
.small{ font-size:13px; color:var(--muted) }

/* responsive */
@media(max-width:820px){
  .wrapper{ padding:8px }
  .settings-panel{ width:100%; right:-100% } .settings-panel.open{ right:0 }
  .header{ flex-direction:column; align-items:flex-start; gap:6px }
}
</style>
</head>
<body>
<div class="wrapper">

  <!-- Header -->
  <header class="header" role="banner">
    <div class="brand"><h1><span class="gid">GiD</span><span class="city">City</span></h1></div>
    <div class="header-right">
      <div id="topCity" class="small">—</div>
      <div id="weather" class="weather" aria-hidden="true"></div>
      <button id="openSettings" class="settings-btn" title="Настройки" aria-label="Настройки">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.7 1.7 0 0 0 .33 1.88l.02.02a2 2 0 0 1-2.82 2.82l-.02-.02A1.7 1.7 0 0 0 15 19.4a1.7 1.7 0 0 0-1.88.33l-.02.02a2 2 0 0 1-2.82-2.82l.02-.02A1.7 1.7 0 0 0 8.6 15 1.7 1.7 0 0 0 7.72 13.12l-.02-.02a2 2 0 0 1 2.82-2.82l.02.02A1.7 1.7 0 0 0 9 8.6 1.7 1.7 0 0 0 10.12 6.72l.02-.02a2 2 0 0 1 2.82 2.82l-.02.02A1.7 1.7 0 0 0 15 8.6a1.7 1.7 0 0 0 1.88-.33l.02-.02a2 2 0 0 1 2.82 2.82l-.02.02A1.7 1.7 0 0 0 19.4 11z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </header>

  <!-- Main container -->
  <main class="container" role="main" aria-live="polite">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="font-weight:800; font-size:16px">Главное меню</div>
      <div class="small" id="roleLabel">—</div>
    </div>

    <div class="menu-grid">
      <div class="menu-top" id="menuTop"></div>
      <div class="menu-bottom" id="menuBottom"></div>
    </div>

  </main>
</div>

<!-- screens (auth, city, role, find, create, mine, messenger, wallet, profile, import/export) -->
<section id="authScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <h2>Вход</h2>
    <form id="authForm" style="margin-top:10px;">
      <div class="form-field"><input id="authLogin" class="input" placeholder="Email или телефон" required /></div>
      <div class="form-field"><input id="authPass" class="input" placeholder="Пароль" type="password" required /></div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button type="submit" class="btn primary">Войти</button>
        <button type="button" id="registerBtn" class="btn ghost">Регистрация</button>
      </div>
      <div class="small" style="margin-top:8px">Данные сохраняются локально (демо)</div>
    </form>
  </div>
</section>

<section id="cityScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <h2>Выберите город</h2>
    <div class="form-field"><input id="citySearch" class="input" placeholder="Поиск города" /></div>
    <div id="cityList" class="city-list" style="max-height:48vh; overflow:auto; margin-top:8px;"></div>
    <div style="display:flex; gap:8px; margin-top:12px;"><button id="cityConfirm" class="btn primary">Подтвердить</button><button id="cityBack" class="btn ghost">Назад</button></div>
  </div>
</section>

<section id="roleScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <h2>Кем вы будете?</h2>
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
      <button id="roleUser" class="btn primary" style="background:linear-gradient(90deg,#7be495,#52c12d);">Пользователь</button>
      <button id="roleWorker" class="btn ghost">Исполнитель</button>
    </div>
  </div>
</section>

<section id="findScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Найти заказы</h2>
      <button class="btn ghost" onclick="closeScreen('findScreen')">← Назад</button>
    </div>

    <div class="tabs" id="findTabs">
      <div class="tab active" data-tab="all">Все заказы</div>
      <div class="tab gold" data-tab="spec">СПЕЦ. ЗАКАЗ</div>
      <div class="tab" data-tab="taxi">Такси</div>
      <div class="tab" data-tab="food">Доставка еды</div>
      <div class="tab" data-tab="more">Ещё</div>
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <input id="searchInput" class="input" placeholder="Поиск..." />
      <button id="applySearch" class="btn primary">Поиск</button>
    </div>

    <div id="findList" class="list"></div>
  </div>
</section>

<section id="createScreen" class="screen" aria-hidden="true">
  <div class="panel" id="createPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Новый заказ</h2>
      <button class="btn ghost" onclick="closeScreen('createScreen')">← Назад</button>
    </div>

    <div class="tabs" id="createTabs" style="margin-top:8px;">
      <div class="tab gold active" data-val="СПЕЦ. ЗАКАЗ">СПЕЦ. ЗАКАЗ</div>
      <div class="tab" data-val="Такси">Такси</div>
      <div class="tab" data-val="Доставка еды">Доставка еды</div>
      <div class="tab" data-val="Курьер">Курьер</div>
      <div class="tab" data-val="Ремонт / Квартира">Ремонт / Квартира</div>
    </div>

    <form id="createForm" style="margin-top:10px;">
      <div class="form-field"><textarea id="c-desc" class="input" placeholder="закажи любую услугу и мы найдем исполнителя"></textarea></div>
      <div style="display:flex; gap:8px;" class="form-field">
        <input id="c-budget" class="input" type="number" placeholder="Бюджет (₸)" />
        <input id="c-datetime" class="input" type="datetime-local" />
      </div>

      <div id="createExtraFields" class="form-field"></div>

      <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
        <button class="btn primary" type="submit" id="orderNowBtn" style="min-width:220px;">ЗАКАЗАТЬ СЕЙЧАС</button>
        <button type="button" class="btn ghost" id="orderCancelBtn">Отмена</button>
        <div style="margin-left:auto; color:var(--muted); font-weight:800;" id="selectedCategory">СПЕЦ. ЗАКАЗ</div>
      </div>
      <div style="margin-top:8px;"><label class="small">Прикрепить фото/файл (опционально)</label><input id="orderAttachment" type="file" accept="image/*,.pdf" /></div>
    </form>
  </div>
</section>

<section id="mineScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Мои заказы</h2>
      <button class="btn ghost" onclick="closeScreen('mineScreen')">← Назад</button>
    </div>
    <div id="mineList" class="list" style="margin-top:10px;"></div>
  </div>
</section>

<section id="messengerScreen" class="screen" aria-hidden="true">
  <div class="panel" style="display:flex; gap:12px;">
    <div style="width:260px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;font-size:16px">Мессенджер</h2>
        <button class="btn ghost" onclick="closeScreen('messengerScreen')">← Назад</button>
      </div>
      <div id="chatsList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
    </div>

    <div style="flex:1;">
      <div id="chatView" style="display:none; flex-direction:column;">
        <div style="display:flex; gap:8px; align-items:center;">
          <div id="chatAvatar" class="avatar" style="width:40px;height:40px;"></div>
          <div>
            <div id="chatTitle" style="font-weight:800"></div>
            <div id="chatSub" class="small">Чат</div>
          </div>
        </div>

        <div id="messages" style="margin-top:10px; max-height:60vh; overflow:auto; padding-right:6px;"></div>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <input id="messageInput" class="input" placeholder="Сообщение..." />
          <input id="messageAttach" type="file" accept="image/*,.pdf" />
          <button id="sendMsgBtn" class="btn primary">Отправить</button>
        </div>
      </div>

      <div id="noChat" class="small" style="padding:24px;">Выберите чат слева</div>
    </div>
  </div>
</section>

<section id="walletScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Кошелёк</h2>
      <button class="btn ghost" onclick="closeScreen('walletScreen')">← Назад</button>
    </div>
    <div style="display:flex; gap:12px; margin-top:10px; align-items:center;">
      <div style="flex:1"><div class="small">Баланс</div><div style="font-weight:800; font-size:22px">₸ <span id="balance">0</span></div></div>
      <div style="display:flex; flex-direction:column; gap:8px;"><button id="topupBtn" class="btn primary">Пополнить</button><button id="withdrawBtn" class="btn ghost">Вывести</button></div>
    </div>
  </div>
</section>

<section id="profileScreen" class="screen" aria-hidden="true">
  <div class="panel">
    <h2>Профиль</h2>
    <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
      <div id="profileAvatar" class="avatar" style="width:72px;height:72px;"></div>
      <div style="flex:1;">
        <div id="profileName" style="font-weight:800"></div>
        <div id="profileLogin" class="small" style="color:var(--muted)"></div>
      </div>
      <div><button id="editProfileBtn" class="btn ghost">Редактировать</button></div>
    </div>

    <div id="profileFormWrap" style="margin-top:12px;"></div>
    <div style="display:flex; gap:8px; margin-top:12px;"><button id="exportData" class="btn ghost">Экспорт JSON</button><button id="importDataBtn" class="btn ghost">Импорт JSON</button></div>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>
</section>

<!-- bid modal -->
<div id="bidModalWrap" class="modal-back" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="bidTitle"><div style="font-weight:800; font-size:16px" id="bidTitle">Предложить цену</div><div style="margin-top:8px;"><input id="bidPrice" class="input" placeholder="Ваша цена (₸)" type="number" /><input id="bidComment" class="input" placeholder="Комментарий (сроки, детали)" style="margin-top:8px" /><div style="display:flex; gap:8px; margin-top:10px;"><button id="sendBidBtn" class="btn primary">Отправить</button><button id="closeBidBtn" class="btn ghost">Отмена</button></div></div></div></div>

<!-- settings panel -->
<aside id="settingsPanel" class="settings-panel" aria-hidden="true">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div style="font-weight:800">Настройки</div>
    <button id="closeSettings" class="btn ghost">✕</button>
  </div>

  <div class="setting-row" style="margin-top:12px;"><div style="font-weight:700">Роль</div></div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button id="setRoleUser" class="btn primary" style="flex:1; background:linear-gradient(90deg,#7be495,#52c12d)">Пользователь</button>
    <button id="setRoleWorker" class="btn ghost" style="flex:1">Исполнитель</button>
  </div>

  <div class="setting-row"><div style="font-weight:700; margin-top:12px">Тема</div></div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button class="btn theme-btn" data-theme="violet" style="flex:1;"><div style="display:flex; gap:6px; align-items:center;"><span style="width:18px;height:12px;background:linear-gradient(90deg,#b37aff,#8f7bff);border-radius:3px"></span>Фиолет</div></button>
    <button class="btn theme-btn" data-theme="navy" style="flex:1;"><div style="display:flex; gap:6px; align-items:center;"><span style="width:18px;height:12px;background:linear-gradient(90deg,#4fa3ff,#7be4ff);border-radius:3px"></span>Тёмно-синяя</div></button>
  </div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button class="btn theme-btn" data-theme="warm" style="flex:1;"><div style="display:flex; gap:6px; align-items:center;"><span style="width:18px;height:12px;background:linear-gradient(90deg,#ffb86b,#ff7b6b);border-radius:3px"></span>Тёплая</div></button>
    <button class="btn theme-btn" data-theme="mint" style="flex:1;"><div style="display:flex; gap:6px; align-items:center;"><span style="width:18px;height:12px;background:linear-gradient(90deg,#0fe3a1,#4fbf91);border-radius:3px"></span>Мятная</div></button>
  </div>
  <div style="display:flex; gap:8px; margin-top:8px;"><button id="resetTheme" class="btn ghost" style="flex:1">Сбросить</button></div>

  <div class="setting-row"><div style="font-weight:700; margin-top:12px">Размер шрифта</div></div>
  <div style="display:flex; gap:8px; margin-top:8px;">
    <button class="btn font-btn" data-font="small" style="flex:1">Мелкий</button>
    <button class="btn font-btn" data-font="normal" style="flex:1">Обычный</button>
    <button class="btn font-btn" data-font="large" data-font-val="large" style="flex:1">Крупный</button>
  </div>

  <div class="setting-row"><div style="font-weight:700; margin-top:12px">Аккаунт</div></div>
  <div style="margin-top:8px"><button id="openProfile" class="btn ghost" style="width:100%">Профиль</button></div>

  <div style="margin-top:12px;"><button id="exportAll" class="btn ghost" style="width:100%">Экспорт данных</button></div>
  <div style="margin-top:8px;"><button id="clearLocal" class="btn ghost" style="width:100%">Очистить всё (localStorage)</button></div>
</aside>

<script>
/* =========================
   GiDCity — single-file JS
   ========================= */

/* ===== Storage keys ===== */
const LS_ORD='gid_orders_v8', LS_CHAT='gid_chats_v8', LS_WAL='gid_wallet_v8', LS_PROFILE='gid_profile_v1', LS_CITY='gid_city_v1', LS_ROLE='gid_role_v1', LS_THEME='gid_theme_v1', LS_FONT='gid_font_v1', LS_SAVED_SEARCHES='gid_searches_v1';

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
function uid(){ return Math.random().toString(36).slice(2,9); }
function nowISO(){ return new Date().toISOString(); }
function initials(name){ if(!name) return '?'; const p=name.trim().split(/\s+/); return (p[0].slice(0,2)).toUpperCase(); }
function avatarStyle(name, el){ const pal=['#b37aff','#8f7bff','#7BFF5A','#61e6ff','#ffaa6b']; const h=Array.from(name||'').reduce((s,c)=>s+c.charCodeAt(0),0); const a=pal[h%pal.length], b=pal[(h+2)%pal.length]; el.style.background=`linear-gradient(135deg, ${a}, ${b})`; el.textContent=initials(name); }

/* ===== Simple Store wrapper ===== */
const Store = {
  getOrders(){ try{ return JSON.parse(localStorage.getItem(LS_ORD))||[]; }catch(e){return[]} },
  setOrders(v){ localStorage.setItem(LS_ORD, JSON.stringify(v)); },
  addOrder(o){ const a=this.getOrders(); a.unshift(o); this.setOrders(a); return a; },
  updateOrder(id,fn){ const a=this.getOrders(); const i=a.findIndex(x=>x.id===id); if(i>-1){ fn(a[i]); this.setOrders(a);} return a; },
  deleteOrder(id){ const a=this.getOrders().filter(x=>x.id!==id); this.setOrders(a); return a; },

  getChats(){ try{ return JSON.parse(localStorage.getItem(LS_CHAT))||[] }catch(e){return[]} },
  setChats(v){ localStorage.setItem(LS_CHAT, JSON.stringify(v)) },
  addChat(c){ const a=this.getChats(); a.unshift(c); this.setChats(a); return a; },
  updateChat(id,fn){ const a=this.getChats(); const i=a.findIndex(x=>x.id===id); if(i>-1){ fn(a[i]); this.setChats(a); } return a; },

  getWallet(){ try{ return JSON.parse(localStorage.getItem(LS_WAL)) || {balance:0,history:[]} }catch(e){return {balance:0,history:[]}} },
  setWallet(w){ localStorage.setItem(LS_WAL, JSON.stringify(w)) },

  getProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE))||null }catch(e){return null} },
  setProfile(p){ localStorage.setItem(LS_PROFILE, JSON.stringify(p)) },

  getCity(){ return localStorage.getItem(LS_CITY) || null },
  setCity(c){ localStorage.setItem(LS_CITY, c) },

  getRole(){ return localStorage.getItem(LS_ROLE) || null },
  setRole(r){ localStorage.setItem(LS_ROLE, r) },

  getTheme(){ return localStorage.getItem(LS_THEME) || 'violet' },
  setTheme(t){ localStorage.setItem(LS_THEME, t) },

  getFont(){ return localStorage.getItem(LS_FONT) || 'normal' },
  setFont(f){ localStorage.setItem(LS_FONT, f) },

  getSavedSearches(){ try{ return JSON.parse(localStorage.getItem(LS_SAVED_SEARCHES))||[] }catch(e){return []} },
  setSavedSearches(v){ localStorage.setItem(LS_SAVED_SEARCHES, JSON.stringify(v)) }
};

/* ===== Seed data if empty ===== */
if(!localStorage.getItem(LS_ORD)){
  Store.setOrders([
    { id:'o1', category:'Такси', city:'Алматы', budget:800, datetime:new Date().toISOString().slice(0,16), desc:'Поездка до аэропорта', ownerId:'owner_1', ownerName:'Айдар', bids:[], status:'open', extra:{} },
    { id:'o2', category:'Доставка еды', city:'Астана', budget:1200, datetime:new Date().toISOString().slice(0,16), desc:'Доставка обеда', ownerId:'owner_2', ownerName:'Салтанат', bids:[], status:'open', extra:{} }
  ]);
}

/* ===== DOM refs ===== */
const menuTop = $('menuTop'), menuBottom = $('menuBottom'), roleLabel = $('roleLabel');
const openSettingsBtn = $('openSettings'), settingsPanel = $('settingsPanel'), closeSettingsBtn = $('closeSettings');
const authScreen = $('authScreen'), cityScreen = $('cityScreen'), roleScreen = $('roleScreen'), createScreen = $('createScreen'), findScreen = $('findScreen'), mineScreen = $('mineScreen'), messengerScreen = $('messengerScreen'), walletScreen = $('walletScreen'), profileScreen = $('profileScreen');
const cityList = $('cityList'), citySearch = $('citySearch'), topCity = $('topCity'), weatherEl = $('weather');
const bidModalWrap = $('bidModalWrap'), bidPrice = $('bidPrice'), bidComment = $('bidComment');
const chatsList = $('chatsList'), messagesEl = $('messages'), chatView = $('chatView'), noChat = $('noChat');

/* ===== Cities + coords (Open-Meteo) ===== */
const CITIES = ["Алматы","Астана","Шымкент","Караганда","Актобе","Костанай","Павлодар","Усть-Каменогорск","Тараз","Кызылорда","Петропавловск","Семей","Атырау","Актау","Уральск"];
const CITY_COORDS = { "Алматы":[43.238949,76.889709], "Астана":[51.160523,71.470355], "Шымкент":[42.3417,69.5901], "Караганда":[49.8063,73.0851], "Актобе":[50.2839,57.1669], "Костанай":[53.2194,63.6320], "Павлодар":[52.3150,76.9456], "Усть-Каменогорск":[49.95,82.6], "Тараз":[42.8979,71.3942], "Кызылорда":[44.85,65.5], "Петропавловск":[54.88,69.16], "Семей":[50.4153,80.2530], "Атырау":[47.1064,51.8828], "Актау":[43.65,51.2], "Уральск":[51.23,51.37] };

/* ===== Themes & fonts definitions ===== */
const THEMES = {
  violet:{bg1:'#6f5bff',bg2:'#000',bg3:'#06122a',accent1:'#b37aff',accent2:'#7BFF5A'},
  navy:{bg1:'#0b2540',bg2:'#020815',bg3:'#001029',accent1:'#4fa3ff',accent2:'#7be4ff'},
  warm:{bg1:'#ff9f6b',bg2:'#3b1a00',bg3:'#20110a',accent1:'#ffb86b',accent2:'#ff7b6b'},
  mint:{bg1:'#0fe3a1',bg2:'#02251a',bg3:'#021814',accent1:'#7efcc6',accent2:'#4fbf91'}
};
function applyTheme(name){
  const t = THEMES[name]||THEMES.violet;
  document.documentElement.style.setProperty('--bg1', t.bg1);
  document.documentElement.style.setProperty('--bg2', t.bg2);
  document.documentElement.style.setProperty('--bg3', t.bg3);
  document.documentElement.style.setProperty('--accent1', t.accent1);
  document.documentElement.style.setProperty('--accent2', t.accent2);
  Store.setTheme(name);
}
function applyFont(sizeKey){
  const map = { small:13, normal:14, large:16 };
  document.documentElement.style.setProperty('--ui-font-size', (map[sizeKey]||14) + 'px');
  Store.setFont(sizeKey);
}

/* ===== UI helpers: screens ===== */
function openScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
  const s = document.getElementById(id);
  if(s) s.style.display='block';
}
function closeScreen(id){ const s=document.getElementById(id); if(s) s.style.display='none'; }

/* ===== Initial flow: auth -> city -> role -> main ===== */
function initialFlow(){
  const profile = Store.getProfile();
  if(!profile){ openScreen('authScreen'); return; }
  if(!Store.getCity()){ openScreen('cityScreen'); renderCityList(); return; }
  if(!Store.getRole()){ openScreen('roleScreen'); return; }
  buildMenu(); updateCityAndWeather(); refreshAll();
}

/* ===== City list render (vertical scroller) ===== */
function renderCityList(filter=''){
  cityList.innerHTML='';
  const q=(filter||'').toLowerCase();
  CITIES.filter(c=>c.toLowerCase().includes(q)).forEach(c=>{
    const el=document.createElement('div'); el.className='city-item'; el.style.padding='8px'; el.style.borderRadius='8px'; el.style.cursor='pointer'; el.style.border='1px solid rgba(255,255,255,0.03)'; el.style.background='rgba(255,255,255,0.01)';
    el.textContent=c; if(Store.getCity()===c) el.style.outline='2px solid rgba(123,255,90,0.08)';
    el.onclick=()=>{ document.querySelectorAll('.city-item').forEach(x=>x.style.outline=''); el.style.outline='2px solid rgba(123,255,90,0.08)'; Store.setCity(c); };
    cityList.appendChild(el);
  });
}
if(citySearch) citySearch.addEventListener('input', (e)=> renderCityList(e.target.value));

$('cityConfirm').addEventListener('click', ()=>{
  if(!Store.getCity()){ alert('Выберите город'); return; }
  topCity.textContent = Store.getCity();
  openScreen('roleScreen');
});
$('cityBack').addEventListener('click', ()=> openScreen('authScreen'));

/* ===== Auth handlers ===== */
$('authForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const login = $('authLogin').value.trim(), pass = $('authPass').value.trim();
  if(!login||!pass){ alert('Введите логин и пароль'); return; }
  const profile = { id:'u_'+uid(), login, name: login.split('@')[0] || login, createdAt:nowISO(), rating:0, reviews:[], portfolio:[] };
  Store.setProfile(profile);
  openScreen('cityScreen'); renderCityList();
});
$('registerBtn').addEventListener('click', ()=> {
  const login = prompt('Email или телефон для регистрации:','user@example.com'); if(!login) return;
  const profile = { id:'u_'+uid(), login, name: login.split('@')[0]||login, createdAt:nowISO(), rating:0, reviews:[], portfolio:[] };
  Store.setProfile(profile); openScreen('cityScreen'); renderCityList();
});

/* ===== Build menu according to role ===== */
function buildMenu(){
  menuTop.innerHTML=''; menuBottom.innerHTML='';
  const role = Store.getRole() || 'user';
  roleLabel.textContent = role==='user' ? 'Вы — Пользователь' : 'Вы — Исполнитель';

  // common items
  const common = [
    {id:'wallet', title:'Кошелёк', sub:`₸ ${Store.getWallet().balance||0}`},
    {id:'messenger', title:'Мессенджер', sub:'Чаты'},
    {id:'mine', title:'Мои заказы', sub:'Ваши заявки'}
  ];
  // role-specific
  if(role==='worker'){
    const el = mkMenuItem('find','Найти заказы', `${Store.getOrders().filter(o=>o.status==='open').length}`); menuTop.appendChild(el);
  }
  common.forEach(it=> menuTop.appendChild(mkMenuItem(it.id, it.title, it.sub)));

  // primary CTA in bottom
  const primary = mkMenuItem('create','ЗАКАЗАТЬ','Новая заявка'); primary.classList.add('primary'); menuBottom.appendChild(primary);

  // small saved searches quick access
  const searches = Store.getSavedSearches() || [];
  if(searches.length){
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='8px';
    searches.slice(0,3).forEach(s=>{
      const b = document.createElement('button'); b.className='btn ghost'; b.textContent = s.name; b.onclick = ()=> { openScreen('findScreen'); document.getElementById('searchInput').value = s.query; renderFindList(); };
      wrap.appendChild(b);
    });
    menuBottom.appendChild(wrap);
  }
}

function mkMenuItem(id,title,sub){
  const el=document.createElement('div'); el.className='menu-item'; el.dataset.action=id; el.innerHTML = `<div class="title">${title}</div><div class="sub">${sub||''}</div>`;
  el.addEventListener('click', ()=> safeMenuAction(id));
  return el;
}

/* safe menu open */
function safeMenuAction(action){
  const role = Store.getRole();
  if(action==='find' && role!=='worker'){ alert('Функция "Найти заказы" доступна только исполнителям. Смените роль в настройках.'); return; }
  if(action==='create' && role!=='user'){ alert('Функция "ЗАКАЗАТЬ" доступна только пользователям. Смените роль в настройках.'); return; }
  if(action==='create'){ openCreateAnimated(); }
  else if(action==='find'){ openScreen('findScreen'); renderFindList(); }
  else if(action==='wallet'){ openScreen('walletScreen'); }
  else if(action==='messenger'){ openScreen('messengerScreen'); refreshChats(); }
  else if(action==='mine'){ openScreen('mineScreen'); renderMineList(); }
}

/* create screen open animation (from bottom) */
function openCreateAnimated(){
  openScreen('createScreen');
  const panel = $('createPanel');
  panel.style.transform = 'translateY(28px) scale(.98)';
  panel.style.opacity = '0';
  requestAnimationFrame(()=> { panel.style.transition='transform .28s cubic-bezier(.2,.9,.22,1), opacity .22s ease'; panel.style.transform='translateY(0) scale(1)'; panel.style.opacity='1'; });
}

/* ===== Render find list (workers) ===== */
function renderFindList(){
  const list = $('findList'); list.innerHTML='';
  const q = (($('searchInput') && $('searchInput').value) || '').toLowerCase().trim();
  const tab = document.querySelector('#findTabs .tab.active')?.dataset.tab || 'all';
  let items = Store.getOrders().filter(o=>o.status==='open');
  if(tab==='spec') items = items.filter(o=>/спец|ремонт|квартира/i.test(o.category));
  if(tab==='taxi') items = items.filter(o=>/такси/i.test(o.category));
  if(tab==='food') items = items.filter(o=>/доставка|еда|food/i.test(o.category));
  if(q) items = items.filter(o=> (o.city||'').toLowerCase().includes(q) || (o.category||'').toLowerCase().includes(q) || (o.desc||'').toLowerCase().includes(q));
  if(items.length===0){ list.innerHTML='<div class="small" style="color:var(--muted)">Ничего не найдено</div>'; return; }
  items.forEach(o=>{
    const card=document.createElement('div'); card.className='card';
    const left=document.createElement('div'); left.className='card-left'; const av=document.createElement('div'); av.className='avatar'; avatarStyle(o.ownerName||o.ownerId||'Z', av); left.appendChild(av);
    const body=document.createElement('div'); body.className='card-body';
    const top=document.createElement('div'); top.className='card-top'; const wrap=document.createElement('div'); const title=document.createElement('div'); title.className='card-title'; title.textContent=`${o.category} • ${o.city}`; const meta=document.createElement('div'); meta.className='card-meta'; meta.textContent=`Дедлайн: ${o.datetime?o.datetime.replace('T',' '):''} • Заказчик: ${o.ownerName||'-'}`; wrap.appendChild(title); wrap.appendChild(meta);
    const price=document.createElement('div'); price.innerHTML=`<div style="font-weight:800; font-size:15px">₸ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>`; top.appendChild(wrap); top.appendChild(price);
    const desc=document.createElement('div'); desc.className='card-desc'; desc.textContent=o.desc||'';
    const cta=document.createElement('div'); cta.style.marginTop='8px';
    const bidBtn=document.createElement('button'); bidBtn.className='btn secondary'; bidBtn.textContent='Предложить цену';
    bidBtn.addEventListener('click', ()=> openBidModalForOrder(o.id));
    cta.appendChild(bidBtn);
    // show attachment preview if exists
    if(o.attachment){ const att=document.createElement('div'); att.style.marginTop='8px'; att.innerHTML = `<div class="small">Вложение: ${o.attachment.name}</div>`; cta.appendChild(att); }
    body.appendChild(top); body.appendChild(desc); body.appendChild(cta);
    card.appendChild(left); card.appendChild(body); list.appendChild(card);
  });
}

/* ===== Bid modal logic ===== */
let currentBidOrderId = null;
function openBidModalForOrder(orderId){
  currentBidOrderId = orderId; bidPrice.value=''; bidComment.value=''; bidModalWrap.classList.add('active'); bidModalWrap.setAttribute('aria-hidden','false');
}
$('closeBidBtn').addEventListener('click', ()=> { bidModalWrap.classList.remove('active'); bidModalWrap.setAttribute('aria-hidden','true'); currentBidOrderId=null; });
bidModalWrap.addEventListener('click', (e)=> { if(e.target===bidModalWrap){ bidModalWrap.classList.remove('active'); bidModalWrap.setAttribute('aria-hidden','true'); currentBidOrderId=null; }});
$('sendBidBtn').addEventListener('click', ()=> {
  const price = Number(bidPrice.value||0), comment = (bidComment.value||'').trim(); if(!(price>0)){ alert('Укажите корректную цену'); return; }
  if(!currentBidOrderId){ alert('Нет заказа'); return; }
  const profile = Store.getProfile() || { id:'p_'+uid(), name:'Исполнитель' };
  Store.updateOrder(currentBidOrderId, (o)=>{ if(!Array.isArray(o.bids)) o.bids=[]; o.bids.push({ price, name:profile.name||profile.login||'Исполнитель', performerId:profile.id||('p_'+uid()), comment, createdAt:nowISO() }); });
  bidModalWrap.classList.remove('active'); bidModalWrap.setAttribute('aria-hidden','true'); currentBidOrderId=null;
  notifyLocal('Предложение отправлено', 'Ваша заявка отправлена заказчику'); renderFindList();
});

/* ===== Owner: view bids, accept -> create chat, mark in_progress ===== */
function showBidsForOrder(orderId){
  const order = Store.getOrders().find(o=>o.id===orderId); if(!order) return alert('Заказ не найден');
  openScreen('mineScreen');
  setTimeout(()=> {
    const panel = document.querySelector('#mineScreen .panel');
    const prev = panel.querySelector('.bids-block'); if(prev) prev.remove();
    const block = document.createElement('div'); block.className='bids-block'; block.style.marginTop='12px'; block.innerHTML = `<div style="font-weight:800;margin-bottom:8px">Заявки</div>`;
    const bids = order.bids || [];
    if(!bids.length){ block.innerHTML += `<div class="small" style="color:var(--muted)">Пока нет заявок</div>`; panel.appendChild(block); return; }
    bids.forEach((b, idx)=>{
      const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='8px 0';
      const av=document.createElement('div'); av.className='avatar'; av.style.width='40px'; av.style.height='40px'; avatarStyle(b.name||'И', av);
      const body=document.createElement('div'); body.style.flex='1'; body.innerHTML=`<div style="font-weight:800">${b.name} — ₸ ${b.price}</div><div style="color:var(--muted);font-size:13px">${b.comment||''}</div>`;
      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
      const accept=document.createElement('button'); accept.className='btn primary'; accept.textContent='Принять'; accept.addEventListener('click', ()=> acceptBid(orderId, idx));
      const reject=document.createElement('button'); reject.className='btn ghost'; reject.textContent='Отклонить'; reject.addEventListener('click', ()=> { Store.updateOrder(orderId, (oo)=>{ oo.bids=(oo.bids||[]).filter((_,i)=>i!==idx); }); showBidsForOrder(orderId); });
      actions.appendChild(accept); actions.appendChild(reject);
      row.appendChild(av); row.appendChild(body); row.appendChild(actions);
      block.appendChild(row);
    });
    panel.appendChild(block);
  }, 160);
}

function acceptBid(orderId,bidIndex){
  const order = Store.getOrders().find(o=>o.id===orderId); if(!order) return;
  const bid = (order.bids||[])[bidIndex]; if(!bid) return;
  Store.updateOrder(orderId, (o)=>{ o.status='in_progress'; o.assigned={ performerId:bid.performerId, performerName:bid.name, price:bid.price }; });
  const chat = { id:'chat_'+uid(), orderId, title:`${order.category} • ${order.city}`, participants:[order.ownerId, bid.performerId], meta:{ownerName:order.ownerName, performerName:bid.name}, messages:[{from:'system', text:`Чат создан между ${order.ownerName||'Заказчик'} и ${bid.name}`, ts:nowISO()}] };
  Store.addChat(chat); renderFindList(); renderMineList(); refreshChats();
  openScreen('messengerScreen'); setTimeout(()=> openChat(chat.id), 200);
  notifyLocal('Заявка принята', 'Чат создан и заказ закреплён за исполнителем');
}

/* ===== Chats ===== */
function refreshChats(){
  const list = $('chatsList'); list.innerHTML=''; const chats = Store.getChats();
  if(!chats.length){ list.innerHTML = '<div class="small" style="color:var(--muted)">Пока нет чатов</div>'; return; }
  chats.forEach(c=>{ const el=document.createElement('div'); el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.style.padding='8px'; el.style.cursor='pointer'; const av=document.createElement('div'); av.className='avatar'; av.style.width='40px'; av.style.height='40px'; avatarStyle(c.meta?.performerName||c.meta?.ownerName||'Ч', av); const t=document.createElement('div'); t.innerHTML=`<div style="font-weight:800">${c.title}</div><div class="small" style="color:var(--muted)">${c.meta?.performerName||''}</div>`; el.appendChild(av); el.appendChild(t); el.addEventListener('click', ()=> openChat(c.id)); list.appendChild(el); });
}

function openChat(chatId){
  const chat = Store.getChats().find(c=>c.id===chatId); if(!chat) return;
  $('chatView').style.display='flex'; noChat.style.display='none'; $('chatTitle').textContent = chat.title; avatarStyle(chat.meta?.performerName||chat.meta?.ownerName||'Ч', $('chatAvatar'));
  const msgs = $('messages'); msgs.innerHTML=''; (chat.messages||[]).forEach(m=>{ const d=document.createElement('div'); d.style.marginBottom='8px'; if(m.from==='system'){ d.style.color='var(--muted)'; d.style.textAlign='center'; d.textContent=m.text; } else if(m.from==='me'){ d.style.alignSelf='flex-end'; d.style.background='linear-gradient(180deg, rgba(123,255,90,0.06), rgba(123,255,90,0.03))'; d.style.padding='8px 12px'; d.style.borderRadius='10px'; d.textContent=m.text; } else { d.style.alignSelf='flex-start'; d.style.background='rgba(255,255,255,0.02)'; d.style.padding='8px 12px'; d.style.borderRadius='10px'; d.textContent=(m.fromName? m.fromName+': ':'') + m.text; } msgs.appendChild(d); });
  msgs.scrollTop = msgs.scrollHeight;
  $('sendMsgBtn').onclick = ()=> {
    const v=$('messageInput').value.trim(); if(!v) return;
    const file = $('messageAttach').files[0];
    if(file){ fileToBase64(file).then(dataUrl=>{ Store.updateChat(chatId, (c)=>{ c.messages.push({ from:'me', text:v, file:{ name:file.name, data:dataUrl }, ts:nowISO() }); }); openChat(chatId); $('messageInput').value=''; $('messageAttach').value=''; }); }
    else { Store.updateChat(chatId, (c)=>{ c.messages.push({ from:'me', text:v, ts:nowISO() }); }); openChat(chatId); $('messageInput').value=''; }
  };
}

/* helper: file -> base64 */
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ===== Create order form (extra fields per category + attachment) ===== */
function showExtraFieldsForCategory(cat){
  const container = $('createExtraFields'); container.innerHTML='';
  if(/квартира|ремонт/i.test(cat)){
    container.innerHTML = `<label class="small">Тип помещения</label><select id="c-apartment-type" class="input"><option value="flat">Квартира</option><option value="house">Дом</option></select><div style="display:flex; gap:8px; margin-top:8px;"><input id="c-rooms" class="input" placeholder="Кол-во комнат" type="number" /><input id="c-floor" class="input" placeholder="Этаж" type="number" /></div>`;
  } else if(/такси/i.test(cat)){
    container.innerHTML = `<label class="small">Тип авто</label><select id="c-vehicle" class="input"><option value="">Любой</option><option value="sedan">Седан</option><option value="suv">SUV</option></select>`;
  } else if(/доставка|еда/i.test(cat)){
    container.innerHTML = `<label class="small">Опции доставки</label><select id="c-delivery" class="input"><option value="">Стандарт</option><option value="fast">Срочно</option></select>`;
  } else container.innerHTML='';
}
$('createTabs').addEventListener('click', (e)=>{ const t=e.target.closest('.tab'); if(!t) return; document.querySelectorAll('#createTabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); $('selectedCategory').textContent = t.dataset.val || t.textContent; showExtraFieldsForCategory($('selectedCategory').textContent); });

function readExtraFields(){ const extra={}; const rooms=$('c-rooms'); if(rooms) extra.rooms = Number(rooms.value||0); const floor=$('c-floor'); if(floor) extra.floor=Number(floor.value||0); const vehicle=$('c-vehicle'); if(vehicle) extra.vehicle=vehicle.value||''; const apt=$('c-apartment-type'); if(apt) extra.apartmentType=apt.value||''; const delivery=$('c-delivery'); if(delivery) extra.delivery=delivery.value||''; return extra; }

$('createForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const profile=Store.getProfile(); if(!profile){ alert('Сначала войдите'); openScreen('authScreen'); return; } const category = document.querySelector('#createTabs .tab.active')?.dataset.val || 'Другое'; const city = Store.getCity() || '—'; const budget = Number($('c-budget').value || 0); const datetime = $('c-datetime').value || ''; const desc = $('c-desc').value.trim(); if(!desc || !datetime){ alert('Заполните описание и дату'); return; } const extra = readExtraFields(); let attachment=null; const f=$('orderAttachment').files[0]; if(f){ const data = await fileToBase64(f); attachment = { name:f.name, data, size:f.size }; } const order = { id:'o_'+uid(), category, city, budget, datetime, desc, ownerId:profile.id, ownerName:profile.name, bids:[], status:'open', createdAt:nowISO(), extra, attachment }; Store.addOrder(order); alert('Заказ создан'); closeScreen('createScreen'); renderFindList(); renderMineList(); refreshAll(); notifyLocal('Новый заказ создан', `Ваш заказ "${category}" размещён`); });

/* ===== Render mine list (with view bids) ===== */
function renderMineList(){
  const list = $('mineList'); list.innerHTML=''; const profile = Store.getProfile(); if(!profile){ list.innerHTML='<div class="small" style="color:var(--muted)">Войдите в профиль</div>'; return; } const orders = Store.getOrders().filter(o=>o.ownerId===profile.id); if(!orders.length){ list.innerHTML='<div class="small" style="color:var(--muted)">Пока нет заказов</div>'; return; } orders.forEach(o=>{ const card=document.createElement('div'); card.className='card'; const left=document.createElement('div'); left.className='card-left'; const av=document.createElement('div'); av.className='avatar'; avatarStyle(o.ownerName||'Вы', av); left.appendChild(av); const body=document.createElement('div'); body.className='card-body'; const top=document.createElement('div'); top.className='card-top'; const title=document.createElement('div'); title.className='card-title'; title.textContent=`${o.category} • ${o.city}`; const price=document.createElement('div'); price.innerHTML=`<div style="font-weight:800; font-size:15px">₸ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>`; top.appendChild(title); top.appendChild(price); const meta=document.createElement('div'); meta.className='card-meta'; meta.textContent=`Дедлайн: ${o.datetime||''} • Статус: ${o.status||'open'}`; const desc=document.createElement('div'); desc.className='card-desc'; desc.textContent=o.desc||''; const actions=document.createElement('div'); actions.style.marginTop='8px'; const viewBids=document.createElement('button'); viewBids.className='btn secondary'; viewBids.textContent='Просмотр заявок'; viewBids.addEventListener('click', ()=> showBidsForOrder(o.id)); actions.appendChild(viewBids); if(o.attachment){ const att=document.createElement('div'); att.style.marginTop='8px'; att.innerHTML=`<div class="small">Вложение: ${o.attachment.name}</div>`; actions.appendChild(att);} body.appendChild(top); body.appendChild(meta); body.appendChild(desc); body.appendChild(actions); card.appendChild(left); card.appendChild(body); list.appendChild(card); });
}

/* ===== Settings open/close, role change, theme/font handlers ===== */
openSettingsBtn.addEventListener('click', ()=> { settingsPanel.classList.add('open'); settingsPanel.setAttribute('aria-hidden','false'); });
$('closeSettings').addEventListener('click', ()=> { settingsPanel.classList.remove('open'); settingsPanel.setAttribute('aria-hidden','true'); });

$('setRoleUser').addEventListener('click', ()=> { Store.setRole('user'); buildMenu(); settingsPanel.classList.remove('open'); refreshAll(); });
$('setRoleWorker').addEventListener('click', ()=> { Store.setRole('worker'); buildMenu(); settingsPanel.classList.remove('open'); refreshAll(); });

document.querySelectorAll('.theme-btn').forEach(b=> b.addEventListener('click', (e)=>{ applyTheme(e.currentTarget.dataset.theme); settingsPanel.classList.remove('open'); }));
$('resetTheme').addEventListener('click', ()=>{ applyTheme('violet'); settingsPanel.classList.remove('open'); });

document.querySelectorAll('.font-btn').forEach(b=> b.addEventListener('click', (e)=>{ applyFont(e.currentTarget.dataset.font); settingsPanel.classList.remove('open'); }));

/* export/import & clear */
$('exportAll').addEventListener('click', ()=> {
  const data = { orders: Store.getOrders(), chats: Store.getChats(), wallet: Store.getWallet(), profile: Store.getProfile(), city: Store.getCity(), role: Store.getRole(), settings:{ theme: Store.getTheme(), font: Store.getFont() } };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gidcity-data.json'; a.click(); URL.revokeObjectURL(url);
});
$('clearLocal').addEventListener('click', ()=> { if(confirm('Удалить все локальные данные?')){ localStorage.clear(); location.reload(); }});

/* profile open/edit/export/import */
$('openProfile').addEventListener('click', ()=> { openScreen('profileScreen'); renderProfile(); });
$('exportData').addEventListener('click', ()=> { $('exportAll').click(); });
$('importDataBtn').addEventListener('click', ()=> $('importFile').click());
$('importFile').addEventListener('change', (e)=> { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> { try{ const json=JSON.parse(r.result); if(json.orders) Store.setOrders(json.orders); if(json.chats) Store.setChats(json.chats); if(json.wallet) Store.setWallet(json.wallet); if(json.profile) Store.setProfile(json.profile); if(json.city) Store.setCity(json.city); if(json.role) Store.setRole(json.role); alert('Импорт выполнен, перезагружаю UI'); refreshAll(); }catch(err){ alert('Неверный файл'); } }; r.readAsText(f); });

function renderProfile(){
  const wrap = $('profileFormWrap'); wrap.innerHTML='';
  const profile = Store.getProfile(); if(!profile){ wrap.innerHTML = '<div class="small" style="color:var(--muted)">Сначала войдите</div>'; return; }
  $('profileName').textContent = profile.name || profile.login; $('profileLogin').textContent = profile.login || '';
  avatarStyle(profile.name||profile.login||'Я', $('profileAvatar'));
  // edit form
  const form = document.createElement('div'); form.innerHTML = `<div class="form-field"><label class="small">Имя</label><input id="p-name" class="input" value="${escapeHtml(profile.name||'')}" /></div><div class="form-field"><label class="small">Коротко о себе</label><textarea id="p-about" class="input">${escapeHtml(profile.about||'')}</textarea></div><div style="display:flex; gap:8px; margin-top:8px;"><button id="saveProfile" class="btn primary">Сохранить</button><button id="uploadPortfolio" class="btn ghost">Добавить фото в портфолио</button></div><div style="margin-top:8px;"><div class="small">Рейтинг: <strong id="profileRating">${profile.rating||0}</strong></div><div id="profileReviews" style="margin-top:8px"></div></div>`; wrap.appendChild(form);
  $('saveProfile').addEventListener('click', ()=> {
    const name = $('p-name').value.trim(), about = $('p-about').value.trim();
    const p = Store.getProfile() || {}; p.name = name || p.name; p.about = about || ''; Store.setProfile(p); alert('Профиль обновлён'); renderProfile(); refreshAll();
  });
  $('uploadPortfolio').addEventListener('click', ()=> { const f = document.createElement('input'); f.type='file'; f.accept='image/*'; f.onchange = async (ev)=>{ const file = ev.target.files[0]; if(!file) return; const data = await fileToBase64(file); const p = Store.getProfile() || {}; p.portfolio = p.portfolio || []; p.portfolio.unshift({ name:file.name, data, ts:nowISO() }); Store.setProfile(p); alert('Файл добавлен в портфолио'); renderProfile(); }; f.click(); });
  // reviews
  const reviewsWrap = $('profileReviews'); reviewsWrap.innerHTML = '<div style="font-weight:700;margin-bottom:6px">Отзывы</div>';
  (profile.reviews||[]).forEach(r=>{ const row=document.createElement('div'); row.style.borderTop='1px solid rgba(255,255,255,0.03)'; row.style.padding='6px 0'; row.innerHTML = `<div style="font-weight:700">${escapeHtml(r.fromName||'—')}</div><div class="small" style="color:var(--muted)">${escapeHtml(r.text)}</div><div class="small" style="color:var(--muted)">${r.rating||0} ★ • ${new Date(r.ts).toLocaleString()}</div>`; reviewsWrap.appendChild(row);});
}

/* escape helper */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])); }

/* ===== Weather fetch via Open-Meteo ===== */
async function fetchWeatherForCity(city){
  try{
    if(!city || !CITY_COORDS[city]) { updateWeatherUI(null); return; }
    const [lat,lon] = CITY_COORDS[city];
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
    const r = await fetch(url); if(!r.ok){ updateWeatherUI(null); return; } const j = await r.json(); const cw = j.current_weather; if(!cw){ updateWeatherUI(null); return; }
    updateWeatherUI({ temp: Math.round(cw.temperature), code: cw.weathercode });
  }catch(err){ console.warn(err); updateWeatherUI(null); }
}
function updateWeatherUI(data){ if(!weatherEl) return; if(!data){ weatherEl.innerHTML = `<span class="small">—</span>`; return; } const mapIcon = (code)=> { if(code===0) return '☀️'; if(code<=3) return '⛅'; if(code<=48) return '🌫️'; if(code<=67) return '🌧️'; if(code<=77) return '❄️'; return '🌩️'; }; weatherEl.innerHTML = `<span class="icon">${mapIcon(data.code)}</span><span class="small">${data.temp}°C</span>`; }

/* call weather when city changes */
function updateCityAndWeather(){ const c = Store.getCity(); topCity.textContent = c || '—'; if(c) fetchWeatherForCity(c); }

/* ===== Local notifications (Notification API) ===== */
function notifyLocal(title, body){
  if(!('Notification' in window)){ console.log('Notifications unsupported'); return; }
  if(Notification.permission === 'granted'){ new Notification(title, { body }); }
  else if(Notification.permission !== 'denied'){ Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title,{body}); }); }
}

/* ===== Saved searches: quick UI (small) ===== */
function saveSearch(name, query){
  const arr = Store.getSavedSearches() || []; arr.unshift({ id:'s_'+uid(), name, query, ts:nowISO() }); Store.setSavedSearches(arr);
}

/* ===== Small wallet actions ===== */
$('topupBtn').addEventListener('click', ()=> { const v=prompt('Сумма для пополнения (₸):','1000'); if(!v) return; const w=Store.getWallet(); w.balance=(w.balance||0)+Number(v); Store.setWallet(w); refreshAll(); alert('Пополнено'); });
$('withdrawBtn').addEventListener('click', ()=> { const v=prompt('Сумма вывода (₸):','500'); if(!v) return; const w=Store.getWallet(); if(w.balance<Number(v)){ alert('Недостаточно средств'); return;} w.balance-=Number(v); Store.setWallet(w); refreshAll(); alert('Выведено'); });

/* ===== Tabs handlers for find/create ===== */
document.querySelectorAll('.tabs').forEach(tabWrap=>{ tabWrap.addEventListener('click',(e)=>{ const t=e.target.closest('.tab'); if(!t) return; tabWrap.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); if(tabWrap.id==='findTabs') renderFindList(); if(tabWrap.id==='createTabs'){ $('selectedCategory').textContent = t.dataset.val || t.textContent; showExtraFieldsForCategory($('selectedCategory').textContent); } }); });
$('applySearch').addEventListener('click', ()=> renderFindList());

/* ===== Export / import done earlier; clear local done earlier ===== */

/* ===== Helpers: refreshAll & initial ===== */
function refreshAll(){ buildMenu(); renderFindList(); renderMineList(); refreshChats(); updateCityAndWeather(); const wItem = Array.from(document.querySelectorAll('.menu-item')).find(x=>x.dataset.action==='wallet'); if(wItem) wItem.querySelector('.sub').textContent = `₸ ${Store.getWallet().balance||0}`; }
function refreshChats(){ try{ const chats=Store.getChats(); chatsList.innerHTML=''; if(!chats.length){ chatsList.innerHTML='<div class="small" style="color:var(--muted)">Пока нет чатов</div>'; return; } chats.forEach(c=>{ const el=document.createElement('div'); el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.style.padding='8px'; el.style.cursor='pointer'; const av=document.createElement('div'); av.className='avatar'; av.style.width='40px'; av.style.height='40px'; avatarStyle(c.meta?.performerName||c.meta?.ownerName||'Ч', av); const t=document.createElement('div'); t.innerHTML = `<div style="font-weight:800">${c.title}</div><div class="small" style="color:var(--muted)">${c.meta?.performerName||''}</div>`; el.appendChild(av); el.appendChild(t); el.addEventListener('click', ()=> openChat(c.id)); chatsList.appendChild(el); }); }catch(e){ console.warn(e); }}

/* ===== Add ability to save search from find screen (small UI) ===== */
(function addSaveSearchUI(){
  const btn = document.createElement('button'); btn.className='btn ghost'; btn.textContent='Сохранить поиск'; btn.style.marginLeft='8px'; btn.onclick = ()=> { const q = (document.getElementById('searchInput')||{value:''}).value.trim(); if(!q) return alert('Введите запрос для сохранения'); const name = prompt('Имя для сохранённого поиска:', q.slice(0,24)); if(!name) return; saveSearch(name,q); buildMenu(); alert('Поиск сохранён'); }; const parent = document.querySelector('#findScreen .panel > .tabs'); if(parent) parent.appendChild(btn);
})();

/* ===== Persistence and storage cross-tab sync ===== */
window.addEventListener('storage', (e)=> { if([LS_ORD,LS_CHAT,LS_WAL,LS_PROFILE,LS_CITY,LS_ROLE].includes(e.key)) refreshAll(); });

/* ===== Init: apply theme & font & initialFlow ===== */
document.addEventListener('DOMContentLoaded', ()=> { applyTheme(Store.getTheme()||'violet'); applyFont(Store.getFont()||'normal'); renderCityList(); if(Store.getCity()) { topCity.textContent = Store.getCity(); fetchWeatherForCity(Store.getCity()); } initialFlow(); });

/* Expose initialFlow to console for testing */
window.gid_refresh = refreshAll;

/* End of script */
</script>
</body>
</html>
