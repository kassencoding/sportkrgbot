<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiD City ‚Äî –°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥ & –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* =================== –¢–ï–ú–´ =================== */
:root{
  --bg-1:#0a0f1a; --bg-2:#0b0e1c; --bg-3:#0b0e1e;
  --radial-a:#1e1b3a; --radial-b:#08152a;

  --surface:rgba(20,24,40,.92);
  --line:rgba(160,170,230,.28);

  --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff;
  --danger:#ff4f6a; --gold:#ffd84d;

  --text:#ffffff; --text-dim:#d8dcff; --text-muted:#9aa6d9; --text-invert:#0b0f18;

  --radius:16px; --ui-font:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --ui-font-size:14px;
  --shadow:0 16px 46px rgba(0,0,0,.45);
}
/* themes omitted for brevity (keep same as before) */
html[data-theme="violet"]{ --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff; --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22; }
html[data-theme="light1"]{
  --bg-1:#ffffff; --bg-2:#f6f7fb; --bg-3:#eef1f7;
  --text:#1a1a1a; --text-dim:#2c2c2c; --text-muted:#555; --text-invert:#ffffff;
  --surface:#ffffff; --line:#e5e8f0;
  --accent-a:#6a5cff; --accent-b:#22c1c3; --accent-c:#6a8cff;
}

/* =================== BASE =================== */
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; padding:18px; color:var(--text);
  font: var(--ui-font-size) var(--ui-font);
  background:
    radial-gradient(900px at 20% -10%, var(--radial-a) 0%, transparent 70%),
    radial-gradient(700px at 120% 20%, var(--radial-b) 0%, transparent 70%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
  display:flex; justify-content:center;
}
html[data-theme="light1"] body{ background:linear-gradient(120deg,#f2f5ff,#ffffff); }

.wrapper{ width:100%; max-width:1100px; display:flex; flex-direction:column; gap:16px; }

/* header */
.header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:6px 2px; }
.brand{ display:flex; flex-direction:column; gap:6px; }
.brand h1{ margin:0; font-weight:800; font-size:22px;
  background:linear-gradient(90deg,var(--accent-a),var(--accent-b));
  -webkit-background-clip:text; color:transparent; text-shadow:0 0 18px rgba(169,112,255,.28);
}
.header-right{ display:flex; gap:8px; align-items:center; }

/* buttons */
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; color:var(--text);
  padding:10px 14px; border-radius:12px; line-height:1;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  border:1px solid var(--line); box-shadow:var(--shadow); transition:transform .12s, box-shadow .25s, background .12s;
}
.btn:hover{ transform:translateY(-1px) }
.btn.primary{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:var(--text-invert); }
.btn.ghost{ background:transparent; }
.controls-row{ display:flex; gap:8px }

/* role tabs (browser-style) */
.role-tabs-row{ display:flex; flex-direction:column; align-items:center; gap:6px; }
.role-tabs{ display:flex; gap:6px; align-items:center; justify-content:center; }
.role-tab{
  padding:10px 18px; border-radius:8px 8px 0 0; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06));
  border:1px solid var(--line); border-bottom:0; cursor:pointer; font-weight:800; color:var(--text-dim);
  transition:transform .12s, color .12s, background .12s;
  min-width:160px; text-align:center;
}
.role-tab.active{ color:var(--gold); background:linear-gradient(180deg, rgba(255,216,77,.06), rgba(169,112,255,.02)); transform:translateY(-2px); box-shadow:0 10px 30px rgba(255,200,80,.06); }

/* center city below tabs */
.center-city{ text-align:center; font-weight:700; color:var(--text-muted); }

/* main container */
.container{ width:100%; border-radius:14px; padding:0; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden }
.panel-top{ display:flex; justify-content:space-between; align-items:center; margin:0; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.02) }
.panel-top h2{ margin:0; font-size:18px; font-weight:900 }

/* menu grid: centered with equal margins */
.menu-grid{ display:flex; gap:12px; width:100%; justify-content:center; flex-wrap:wrap; align-items:flex-start; padding:18px; }
.menu-btn{
  display:flex; align-items:center; gap:12px; cursor:pointer;
  min-height:64px; padding:12px 16px; border-radius:12px; border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.16)); box-shadow:0 8px 26px rgba(0,0,0,.35);
  color:var(--text); transition:transform .18s, box-shadow .2s, background .16s;
  flex: 0 1 320px; max-width:360px; width:calc(33% - 24px); min-width:230px;
  justify-content:flex-start;
}
.menu-btn .title{ font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.menu-btn .note{ font-size:12px; color:var(--text-muted) }
.menu-btn.primary{ background:linear-gradient(135deg, rgba(169,112,255,.12), rgba(50,255,210,.06)); border-color: rgba(169,112,255,.16); }

/* reveal animation for menu items */
.menu-grid.revealing .menu-btn{ opacity:0; transform:translateY(18px) scale(.98); animation:revealUp .42s forwards; }
@keyframes revealUp{ to{ opacity:1; transform:translateY(0) scale(1); } }

/* modal, screens etc */
.screen{ position:fixed; inset:0; display:none; z-index:120; padding:12px; background:rgba(0,0,0,.55); backdrop-filter:blur(8px); align-items:flex-start; justify-content:center }
.screen.active{ display:flex }
.modal{ width:100%; max-width:1100px; max-height:88vh; overflow:auto; background:var(--surface); color:var(--text); box-shadow:var(--shadow); border:1px solid var(--line); border-radius:12px; padding:16px }

/* input styles */
.input, textarea, select{
  width:100%; padding:12px; border-radius:10px; border:1px solid var(--line);
  background:rgba(12,16,36,.75); color:var(--text); font-size:14px; outline:none; box-sizing:border-box;
}
.input:focus, textarea:focus, select:focus{ border-color:var(--accent-a); box-shadow:0 0 0 3px rgba(169,112,255,.12) }
textarea{ min-height:110px; resize:vertical }

/* posts / cards (glass look) */
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.04); border-radius:12px; padding:12px; margin-bottom:10px; color:var(--text); }
.post-img{ width:100%; border-radius:10px; margin-top:8px; max-height:360px; object-fit:cover }

/* composer floating */
.city-composer{
  position:sticky; top:12px; z-index:6; margin-bottom:12px; display:flex; gap:8px; align-items:center;
  padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); backdrop-filter: blur(6px);
  border:1px solid rgba(255,255,255,.04);
}
.city-composer .input{ flex:1; margin:0; border-radius:8px; padding:10px; }
.city-composer .btn{ min-width:110px; }

/* chats: glass bubbles and different color for me/other */
.msgs{ margin-top:12px; max-height:58vh; overflow:auto; padding-right:6px }
.msg-row{ margin:8px 0; display:flex; flex-direction:column; }
.msg-me{ align-items:flex-end; }
.msg-me .b{ display:inline-block; background:linear-gradient(90deg, rgba(255,221,102,.95), rgba(255,200,80,.95)); padding:10px 14px; border-radius:12px; color:#071018; font-weight:800; box-shadow:0 8px 20px rgba(255,180,60,.08); max-width:78%; word-break:break-word; }
.msg-other{ align-items:flex-start; }
.msg-other .b{ display:inline-block; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); padding:10px 14px; border-radius:12px; color:var(--text); font-weight:700; border:1px solid rgba(255,255,255,.04); max-width:78%; word-break:break-word; }

/* small responsive adjustments */
@media (max-width:900px){
  .menu-btn{ width:100%; flex-basis:100%; }
  .role-tab{ min-width:140px; }
}
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiD City</h1>
    </div>
    <div class="header-right">
      <div class="controls-row">
        <button id="openNotifications" class="btn">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
  </header>

  <!-- ROLE TABS placed above main menu (browser-like) -->
  <div class="role-tabs-row" style="width:100%; max-width:1100px; margin:0 auto;">
    <div class="role-tabs" id="roleTabs">
      <div class="role-tab" data-role="user" id="roleUserBtn">–°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥</div>
      <div class="role-tab" data-role="worker" id="roleWorkerBtn">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</div>
    </div>
    <div class="center-city" id="centerCityLabel">–ì–æ—Ä–æ–¥: –ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
  </div>

  <main class="container" role="main" aria-live="polite">
    <div class="panel-top"><h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2><div style="width:140px"></div></div>
    <div class="menu-grid" id="menuGrid"></div>
  </main>
</div>

<!-- ===== CITY THREAD (screen) ===== -->
<section id="cityThreadScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
    <button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <!-- Floating composer (sticky at top of modal) -->
  <div style="margin-top:12px" id="cityThreadInner">
    <div class="city-composer">
      <input id="cityPostText" class="input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—å—é...">
      <label class="btn"><input type="file" id="cityPostImage" accept="image/*" style="display:none">–§–æ—Ç–æ</label>
      <button id="cityPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>

    <div id="cityPosts" style="margin-top:12px;"></div>
  </div>
</div></section>

<!-- other screens kept minimal (auth, create, find...) - reuse from previous code -->
<!-- AUTH -->
<section id="authScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–í—Ö–æ–¥</h3><button onclick="closeScreen('authScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <form id="authForm" style="margin-top:12px; display:grid; gap:8px;">
    <input id="authLogin" class="input" placeholder="Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" required>
    <input id="authPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password" required>
    <div style="display:flex; gap:8px"><button type="submit" class="btn primary">–í–æ–π—Ç–∏</button><button type="button" id="registerBtn" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
    <div class="small" style="margin-top:10px">–î–µ–º–æ: –ª–æ–∫–∞–ª—å–Ω–æ + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è JSONBin</div>
  </form>
</div></section>

<!-- CREATE ORDER -->
<section id="createScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ó–ê–ö–ê–ó–ê–¢–¨</h3><button onclick="closeScreen('createScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div style="margin-top:10px;">
    <div class="tabs" id="createTabs">
      <div class="tab active" data-val="–°–ü–ï–¶. –ó–ê–ö–ê–ó">–°–ü–ï–¶. –ó–ê–ö–ê–ó</div>
      <div class="tab" data-val="–¢–∞–∫—Å–∏">–¢–∞–∫—Å–∏</div>
      <div class="tab" data-val="–ö—É—Ä—å–µ—Ä">–ö—É—Ä—å–µ—Ä</div>
      <div class="tab" data-val="–î–æ—Å—Ç–∞–≤–∫–∞">–î–æ—Å—Ç–∞–≤–∫–∞</div>
      <div class="tab" data-val="–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞)">–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º</div>
      <div class="tab" data-val="–ú–∞—Å—Ç–µ—Ä">–ú–∞—Å—Ç–µ—Ä</div>
      <div class="tab" data-val="–ü—Ä–æ—á–∏–µ">–ü—Ä–æ—á–∏–µ</div>
    </div>

    <form id="createForm" style="margin-top:12px; display:grid; gap:8px;">
      <textarea id="c-desc" class="input" placeholder="–ó–∞–∫–∞–∂–∏ –ª—é–±—É—é —É—Å–ª—É–≥—É ‚Äî –º—ã –Ω–∞–π–¥—ë–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"></textarea>

      <div id="createExtraFields" class="form-field" style="margin-top:0"></div>

      <div class="form-stack" style="display:flex; gap:8px; margin-top:0; flex-wrap:wrap;">
        <input id="c-datetime" class="input" type="datetime-local" placeholder="–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è" style="flex:1; min-width:220px;">
        <input id="c-budget" class="input" type="number" placeholder="–ë—é–¥–∂–µ—Ç (‚Ç∏)" style="width:160px;">
      </div>

      <div style="display:flex; gap:12px; margin-top:6px">
        <button class="btn primary" id="orderNowBtn" type="submit" style="min-width:220px; padding:14px 18px; font-size:15px">–ó–ê–ö–ê–ó–ê–¢–¨</button>
        <button class="btn ghost" type="button" onclick="closeScreen('createScreen')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div></section>

<!-- FIND, MINE, ADS, MESSENGER, CHAT WINDOW, NOTIFICATIONS, SETTINGS, PROFILE, WALLET omitted for brevity -->
<!-- We'll include simplified versions of necessary screens to keep file runnable. Full functionality remains in script. -->

<section id="findScreen" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>–ù–∞–π—Ç–∏</h3><button onclick="closeScreen('findScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div style="margin-top:12px"><div style="display:flex;gap:8px"><input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫"><button id="applySearch" class="btn">–ü–æ–∏—Å–∫</button></div><div id="findList" style="margin-top:12px"></div></div></div></section>

<section id="mineScreen" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3><button onclick="closeScreen('mineScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="mineList" style="margin-top:12px"></div></div></section>

<section id="adsScreen" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>–û–±—ä—è–≤–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('adsScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="adsList" style="margin-top:12px"></div></div></section>

<section id="messengerScreen" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3><button onclick="closeScreen('messengerScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="chatsList" style="margin-top:12px"></div></div></section>

<section id="chatWindow" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 id="chatWinTitle">–ß–∞—Ç</h3><button onclick="closeScreen('chatWindow')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="chatWinMsgs" class="msgs"></div><div style="display:flex;gap:8px;margin-top:8px"><input id="chatWinInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."><button id="chatWinSend" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div></div></section>

<section id="notificationsModal" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('notificationsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div id="notificationsList" style="margin-top:12px"></div></div></section>

<section id="settingsModal" class="screen"><div class="modal"><div style="display:flex; justify-content:space-between;"><h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="closeScreen('settingsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div><div style="margin-top:12px"><div style="font-weight:900">–ì–æ—Ä–æ–¥</div><div style="display:flex;gap:8px;margin-top:8px"><select id="citySelect" class="input" style="max-width:200px"><option>‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option><option>–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</option><option>–ê–ª–º–∞—Ç—ã</option><option>–ê—Å—Ç–∞–Ω–∞</option></select><button id="saveCityBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div></div></section>

<script>
/* ========== Utilities & Store (kept similar, with getCurrentCityKey) ========== */
const LS_ORD='gid_orders_v13', LS_CHAT='gid_chats_v13', LS_ADS='gid_ads_v2', LS_PROFILE='gid_profile_v1', LS_ROLE='gid_role_v1', LS_CITY='gid_city_v1', LS_NOTIF='gid_notif_v1', LS_THEME='gid_theme_v1', LS_CITY_FEED='gid_city_feed_v3';
const $=id=>document.getElementById(id);
const uid=()=>Math.random().toString(36).slice(2,9);
const nowISO=()=>new Date().toISOString();

function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]) );}

const Store={
  getOrders(){try{return JSON.parse(localStorage.getItem(LS_ORD))||[]}catch(e){return[]}}, setOrders(v){localStorage.setItem(LS_ORD,JSON.stringify(v))},
  addOrder(o){const a=this.getOrders();a.unshift(o);this.setOrders(a);return a},
  updateOrder(id,fn){const a=this.getOrders();const i=a.findIndex(x=>x.id===id);if(i>-1){fn(a[i]);this.setOrders(a);}return a},

  getChats(){try{return JSON.parse(localStorage.getItem(LS_CHAT))||[]}catch(e){return[]}}, setChats(v){localStorage.setItem(LS_CHAT,JSON.stringify(v))},
  addChat(c){const a=this.getChats();a.unshift(c);this.setChats(a);return a},
  updateChat(id,fn){const a=this.getChats();const i=a.findIndex(x=>x.id===id);if(i>-1){fn(a[i]);this.setChats(a);}return a},

  getAds(){try{return JSON.parse(localStorage.getItem(LS_ADS))||[]}catch(e){return[]}}, setAds(v){localStorage.setItem(LS_ADS,JSON.stringify(v))},

  getProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE))||null}catch(e){return null}}, setProfile(p){localStorage.setItem(LS_PROFILE,JSON.stringify(p))},

  getRole(){return localStorage.getItem(LS_ROLE)||'user'}, setRole(r){localStorage.setItem(LS_ROLE,r)},

  getCity(){ return localStorage.getItem(LS_CITY) || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞' }, setCity(c){ localStorage.setItem(LS_CITY,c); },

  getNotifs(){try{return JSON.parse(localStorage.getItem(LS_NOTIF))||[]}catch(e){return[]}}, setNotifs(a){localStorage.setItem(LS_NOTIF,JSON.stringify(a))},

  getTheme(){return localStorage.getItem(LS_THEME)||'violet'}, setTheme(t){localStorage.setItem(LS_THEME,t); applyTheme(); },

  getCityFeed(){ try{return JSON.parse(localStorage.getItem(LS_CITY_FEED))||{} }catch(_){ return {} } },
  setCityFeed(obj){ localStorage.setItem(LS_CITY_FEED, JSON.stringify(obj)); }
};

function getCurrentCityKey(){ // consistent key for feed
  const c = Store.getCity();
  return (c && String(c).trim()) ? String(c).trim() : '‚Äî';
}

/* ========== Theme / UI helpers ========== */
function applyTheme(){ document.documentElement.setAttribute('data-theme', Store.getTheme()); }
function updateCityLabel(){ const c=getCurrentCityKey(); $('centerCityLabel').textContent='–ì–æ—Ä–æ–¥: '+c; if($('citySelect')) $('citySelect').value=c; }
function refreshNotifBadge(){ const n=Store.getNotifs().length; /* minimal */ }

/* ========== Menu building (no icons) ========== */
function menuBtnObj(id,title,note,extraClass){
  const el = document.createElement('div');
  el.id=id; el.className='menu-btn'+(extraClass?(' '+extraClass):'');
  const textWrap=document.createElement('div'); textWrap.style.flex='1';
  const t=document.createElement('div'); t.className='title'; t.textContent=title;
  const ndiv=document.createElement('div'); ndiv.className='note'; ndiv.textContent=note||'';
  textWrap.appendChild(t); textWrap.appendChild(ndiv);
  el.appendChild(textWrap);
  return el;
}

function setRoleTabsUI(){
  const role = Store.getRole();
  document.querySelectorAll('.role-tab').forEach(tab=>tab.classList.toggle('active', tab.dataset.role===role));
}
function applyRoleUI(){
  setRoleTabsUI();
  const role=Store.getRole(), grid=$('menuGrid'); grid.innerHTML='';
  if(role==='user'){
    grid.appendChild(menuBtnObj('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞','primary'));
    grid.appendChild(menuBtnObj('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'));
    grid.appendChild(menuBtnObj('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtnObj('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏'));
    grid.appendChild(menuBtnObj('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtnObj('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  } else {
    grid.appendChild(menuBtnObj('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π','primary'));
    grid.appendChild(menuBtnObj('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'));
    grid.appendChild(menuBtnObj('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtnObj('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏'));
    grid.appendChild(menuBtnObj('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtnObj('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  }
  // reveal
  const items = Array.from(grid.children);
  grid.classList.add('revealing');
  items.forEach((it,idx)=>it.style.animationDelay=(idx*70)+'ms');
  setTimeout(()=>{ grid.classList.remove('revealing'); items.forEach(it=>it.style.animationDelay=''); }, 1000);
  wireMainButtons();
}

/* ========== Wire main buttons ========== */
function wireMainButtons(){
  const on=(id,fn)=>{ document.querySelectorAll('#'+id).forEach(el=>el.addEventListener('click',fn)); };
  on('btnOrder',()=>{ if(Store.getRole()!=='user'){ alert('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥'); return; } openScreen('createScreen'); });
  on('btnFind',()=>{ if(Store.getRole()!=='worker'){ alert('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞'); return; } openScreen('findScreen'); renderFindList(); });
  on('btnMessenger',()=>{ openScreen('messengerScreen'); renderChats(); });
  on('btnWallet',()=>{ openScreen('settingsModal'); }); // small shortcut
  on('btnMine',()=>{ openScreen('mineScreen'); renderMineList(); });
  on('btnAds',()=>{ openScreen('adsScreen'); renderAds(); });
  on('btnCityThread',()=>{ openScreen('cityThreadScreen'); renderCityPosts(); });
}

/* ========== City posts (fixed: consistent keys + immediate render) ========== */
function renderCityPosts(){
  const container=$('cityPosts'); if(!container) return; container.innerHTML='';
  const city = getCurrentCityKey();
  const feed=Store.getCityFeed(); const posts=Array.isArray(feed[city])?feed[city]:[];
  if(!posts.length){ container.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
  posts.forEach(p=>{
    const card=document.createElement('div'); card.className='post-card'; card.dataset.postId=p.id;
    const top=`<div style="display:flex;gap:8px;align-items:center"><div style="font-weight:900">${esc(p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div><div class="small" style="margin-left:auto">${new Date(p.ts).toLocaleString()}</div></div>`;
    card.innerHTML = top + `<div style="margin-top:8px; white-space:pre-wrap">${esc(p.text||'')}</div>` + (p.image?`<img class="post-img" src="${p.image}" alt="">`:'') +
      `<div style="display:flex;gap:8px;margin-top:8px"><button class="btn" data-act="like">‚ù§Ô∏è (<span data-likecount>${Object.keys(p.likes?.byUser||{}).length}</span>)</button><button class="btn" data-act="comment">üí¨</button><button class="btn" data-act="repost">üîÅ</button></div>
       <div class="comments" style="margin-top:8px; display:none"><div style="display:flex;gap:8px;margin-bottom:8px"><input class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."><button class="btn primary" data-act="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div><div class="comments-list"></div></div>`;
    container.appendChild(card);

    // render comments
    const commentsList = card.querySelector('.comments-list');
    (p.comments||[]).forEach(c=>{
      const cEl=document.createElement('div'); cEl.className='comment';
      cEl.innerHTML = `<div style="display:flex;gap:6px;align-items:center"><div style="font-weight:800">${esc(c.authorName||'')}</div><div class="small" style="margin-left:auto">${new Date(c.ts).toLocaleString()}</div></div><div style="margin-top:6px">${esc(c.text)}</div>`;
      commentsList.appendChild(cEl);
    });

    card.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-act]'); if(!btn) return;
      const act = btn.dataset.act;
      if(act==='like'){ toggleLike(p.id); }
      else if(act==='comment'){ const box=card.querySelector('.comments'); box.style.display = (box.style.display==='none' || !box.style.display)?'block':'none'; }
      else if(act==='sendComment'){ const input=card.querySelector('.comments input'); sendComment(p.id, input.value.trim()); input.value=''; }
      else if(act==='repost'){ openRepostPicker(p); }
    });
  });
}
function saveCityFeed(feed){ Store.setCityFeed(feed); localStorage.setItem(LS_CITY_FEED, JSON.stringify(feed)); }
function toggleLike(postId){
  const me = currentUserId();
  const city = getCurrentCityKey();
  const feed = Store.getCityFeed();
  const posts = feed[city] || [];
  const post = posts.find(p=>p.id===postId); if(!post) return;
  post.likes = post.likes || {byUser:{}};
  if(post.likes.byUser[me]) delete post.likes.byUser[me]; else post.likes.byUser[me]=true;
  feed[city]=posts; Store.setCityFeed(feed); renderCityPosts();
}
function sendComment(postId, text){
  if(!text) return;
  const me = Store.getProfile() || {name:'–ì–æ—Å—Ç—å', id:currentUserId()};
  const city = getCurrentCityKey();
  const feed = Store.getCityFeed();
  const posts = feed[city] || [];
  const post = posts.find(p=>p.id===postId); if(!post) return;
  post.comments = post.comments || [];
  post.comments.push({ id:'c_'+uid(), authorName: displayName(me), text, ts: nowISO() });
  feed[city]=posts; Store.setCityFeed(feed); renderCityPosts();
}
function openRepostPicker(post){ // simple: open messenger and put snippet
  alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ ‚Äî —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–µ–ø–æ—Å—Ç–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏.');
}

/* publisher handler - uses consistent city key and renders immediately */
let __cityImage=null;
$('cityPostImage')?.addEventListener('change', e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{ __cityImage = r.result; alert('–§–æ—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ'); }; r.readAsDataURL(f);
});
$('cityPostSend')?.addEventListener('click', ()=>{
  const text = $('cityPostText')?.value.trim();
  const img = __cityImage;
  if(!text && !img) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
  const city = getCurrentCityKey();
  const feed = Store.getCityFeed();
  const post = { id:'post_'+uid(), authorName: displayName(Store.getProfile()) || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', text: text||'', image: img||null, ts: nowISO(), likes:{byUser:{}}, comments:[] };
  (feed[city] = feed[city]||[]).unshift(post);
  Store.setCityFeed(feed); // persist
  $('cityPostText').value=''; __cityImage=null;
  renderCityPosts();
});

/* ========== Chats bubbles: changed style (render simple demoÔºâ ========== */
function renderChats(){ const wrap=$('chatsList'); if(!wrap) return; wrap.innerHTML=''; const chats = Store.getChats(); if(!chats.length){ wrap.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>'; return; }
  chats.forEach(c=>{
    const card = document.createElement('div'); card.className='post-card';
    card.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div style="font-weight:900">${esc(c.title||'–ß–∞—Ç')}</div><div class="small" style="margin-left:auto">${new Date(c.messages?.[0]?.ts||'').toLocaleString()}</div></div>`;
    card.addEventListener('click', ()=> openChatWindow(c.id));
    wrap.appendChild(card);
  });
}
let __currentChatId=null;
function openChatWindow(chatId){
  const chat = Store.getChats().find(c=>c.id===chatId); if(!chat) return alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
  __currentChatId = chatId;
  openScreen('chatWindow');
  const msgsEl = $('chatWinMsgs'); msgsEl.innerHTML='';
  const me = currentUserId();
  (chat.messages||[]).forEach(m=>{
    const row = document.createElement('div'); row.className = (m.fromId===me ? 'msg-row msg-me' : 'msg-row msg-other');
    const bubble = document.createElement('div'); bubble.className='b'; bubble.textContent = m.text || '';
    row.appendChild(bubble);
    msgsEl.appendChild(row);
  });
}
$('chatWinSend').addEventListener('click', ()=>{
  const v = $('chatWinInput').value.trim(); if(!v || !__currentChatId) return;
  const me = Store.getProfile()||{id:'u_demo_user', name:'–í—ã'};
  Store.updateChat(__currentChatId, c=>{
    c.messages = c.messages || [];
    c.messages.push({ fromId: me.id, text: v, ts: nowISO() });
  });
  $('chatWinInput').value=''; openChatWindow(__currentChatId);
});

/* ========== Small UI & init ========== */
function displayName(p){ if(!p) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; const nm=[p.firstName||'', p.lastName||''].join(' ').trim() || p.name || ''; if(nm) return nm; return p.login||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; }
function currentUserId(){ return Store.getProfile()?.id || 'u_demo_user'; }

/* quick default data if empty */
function initial(){
  applyTheme();
  if(!Store.getRole()) Store.setRole('user');
  if(!Store.getCity()) Store.setCity('–ö–∞—Ä–∞–≥–∞–Ω–¥–∞');
  updateCityLabel();
  applyRoleUI();
  renderCityPosts();
  renderChats();
  renderFindList();
  renderMineList();
  renderAds();
}
initial();

/* role tab click */
document.getElementById('roleTabs').addEventListener('click', (e)=>{
  const tab = e.target.closest('.role-tab'); if(!tab) return;
  const r = tab.dataset.role; if(!r) return;
  Store.setRole(r); setRoleTabsUI(); applyRoleUI();
});

/* wire header buttons */
$('openNotifications').addEventListener('click', ()=>openScreen('notificationsModal'));
$('openSettings').addEventListener('click', ()=>openScreen('settingsModal'));

/* simple render functions used above (stubs / adapted from original) */
function renderFindList(){ const wrap=$('findList'); if(!wrap) return; wrap.innerHTML='<div class="small" style="padding:12px">–§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞</div>'; }
function renderMineList(){ const wrap=$('mineList'); if(!wrap) return; wrap.innerHTML='<div class="small" style="padding:12px">–í–∞—à–∏ –∑–∞–∫–∞–∑—ã</div>'; }
function renderAds(){ const wrap=$('adsList'); if(!wrap) return; wrap.innerHTML='<div class="small" style="padding:12px">–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>'; }

/* basic auth handling for demo */
$('authForm').addEventListener('submit', e=>{ e.preventDefault(); const login=$('authLogin').value.trim(); if(!login) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω'); const prof={id:'u_'+uid(), login, name: login.split('@')[0]||login}; Store.setProfile(prof); alert('–í–æ—à–ª–∏'); closeScreen('authScreen'); });

/* settings: save city */
$('saveCityBtn')?.addEventListener('click', ()=>{ const v=$('citySelect').value; if(!v) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); Store.setCity(v); updateCityLabel(); alert('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });

/* helper screens control */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const el=$(id); if(el) el.classList.add('active'); }
function closeScreen(id){ const el=$(id); if(el) el.classList.remove('active'); }
</script>
</body>
</html>
