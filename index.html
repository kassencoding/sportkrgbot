<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GiDCity ‚Äî Telegram Mini App</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22;
  --surface:rgba(20,24,40,.78);
  --glass:rgba(255,255,255,.08);
  --line:rgba(160,170,230,.28);
  --accent-a:#a970ff; --accent-b:#32ffd2;
  --accent-green:#7ef3c0; --gold:#ffd84d; --danger:#ff4f6a;
  --text:#ffffff; --text-muted:#9aa6d9; --text-invert:#0b0f18;
  --radius:16px; --shadow:0 16px 46px rgba(0,0,0,.45);
  --ui-font:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --ui-font-size:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; min-height:100vh; padding:12px; color:var(--text);
  font: var(--ui-font-size) var(--ui-font);
  background: linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
}
.wrapper{ max-width:860px; margin:0 auto; display:flex; flex-direction:column; gap:12px }
/* Header */
.header{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px }
.brand h1{ margin:0; font-weight:800; font-size:22px; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); -webkit-background-clip:text; color:transparent }
.header-sub{ font-size:13px; color:var(--text-muted) }
/* Top bar */
.topbar{ display:flex; flex-direction:column; gap:8px }
.city-top{ display:flex; align-items:center; gap:8px; font-weight:900; color:var(--text-muted) }
.role-tabs{ display:flex; gap:8px; flex-wrap:wrap }
.role-tab{ padding:10px 14px; border-radius:12px; background:rgba(0,0,0,.15); border:1px solid var(--line); cursor:pointer; font-weight:900; }
.role-tab.active{ background:linear-gradient(180deg,#ffd84d,#ffcc33); color:#1a1a1a; border-color:#e6b800; box-shadow:0 6px 18px rgba(255,216,77,.25) }
/* Container */
.container{ border-radius:16px; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden }
.panel-top{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--glass) }
.panel-top h2{ margin:0; font-size:16px; font-weight:900 }
/* Menu */
.menu-grid{ padding:12px; display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:10px }
.menu-btn{ display:flex; align-items:center; gap:10px; padding:12px; min-height:64px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12)); cursor:pointer }
.menu-btn .title{ font-weight:900 } .menu-btn .note{ font-size:12px; color:var(--text-muted) }
/* Inputs */
.input, textarea, select{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:rgba(12,16,36,.75); color:var(--text); font-size:14px; outline:none }
textarea{ min-height:120px; resize:vertical }
.field-label{ font-size:12px; color:var(--text-muted); font-weight:800; margin:0 0 4px 2px }
/* Buttons */
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; color:var(--text); padding:10px 14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18)); border:1px solid var(--line) }
.btn.primary{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:var(--text-invert) }
.btn.ghost{ background:transparent; border:1px dashed var(--line) }
/* Screens (modal) */
.screen{ position:fixed; inset:0; display:none; z-index:10; padding:10px; background:rgba(0,0,0,.45); backdrop-filter:blur(8px); align-items:flex-start; justify-content:center }
.screen.active{ display:flex }
.modal{ width:100%; max-width:860px; max-height:88vh; overflow:auto; background:var(--surface); border:1px solid var(--line); border-radius:14px; padding:14px }
/* Chat */
.city-composer{ position:sticky; top:10px; z-index:1; padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); display:flex; flex-direction:column; gap:8px }
.post-card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; margin-bottom:10px }
.post-img{ width:100%; border-radius:10px; margin-top:6px; max-height:320px; object-fit:cover }
.post-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
.comment{ background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:10px; padding:8px; margin-top:6px }
.avatar{ width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; background:linear-gradient(135deg,#a970ff,#32ffd2); color:#fff }
.avatar img{ width:100%; height:100%; object-fit:cover; border-radius:50% }
/* Emoji */
.emoji-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(44px,1fr)); gap:8px; }
.emoji-item{ font-size:26px; line-height:44px; height:44px; text-align:center; border-radius:12px; cursor:pointer; background:rgba(255,255,255,.06); border:1px solid var(--line) }
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiDCity</h1>
      <div id="topCity" class="header-sub">–ì–æ—Ä–æ–¥: ‚Äî</div>
    </div>
    <div class="header-right">
      <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </header>

  <section class="topbar">
    <div class="city-top">–ì–æ—Ä–æ–¥:
      <select id="cityQuickSelect" class="input" style="max-width:260px"></select>
      <button id="saveQuickCity" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="roleTabs" class="role-tabs"></div>
  </section>

  <main class="container">
    <div class="panel-top"><h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2></div>
    <div id="menuGrid" class="menu-grid"></div>
  </main>
</div>

<!-- CITY CHAT -->
<section id="cityThreadScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
      <button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="margin-top:10px;">
      <div class="city-composer">
        <textarea id="cityPostText" class="input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—å—é..."></textarea>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <label class="btn">üì∑ –§–æ—Ç–æ<input type="file" id="cityPostImage" accept="image/*" style="display:none"></label>
          <button id="cityPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </div>
      <div id="cityPosts" style="margin-top:10px;"></div>
    </div>
  </div></div></section>

<!-- SETTINGS + ONBOARDING -->
<section id="settingsModal" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="closeScreen('settingsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <div style="margin-top:10px; display:grid; gap:10px">
      <div>
        <div class="field-label">–ì–æ—Ä–æ–¥</div>
        <select id="citySelect" class="input"></select>
        <div style="margin-top:6px"><button id="saveCityBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </div>
      <div>
        <div class="field-label">–ò–º—è</div>
        <input id="profileName" class="input" placeholder="–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?">
      </div>
      <div>
        <div class="field-label">–ê–≤–∞—Ç–∞—Ä</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" id="profilePhoto" accept="image/*" style="display:none"></label>
          <button id="pickEmojiBtn" class="btn">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
          <div id="avatarPreview" class="avatar" title="–ü—Ä–µ–≤—å—é"></div>
        </div>
        <div id="emojiPicker" style="display:none; margin-top:8px">
          <div class="emoji-grid" id="emojiGrid"></div>
        </div>
      </div>
      <div style="display:flex; gap:8px">
        <button id="saveProfileBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
    </div>
  </div>
</div></section>

<script>
// Telegram WebApp API
const tg = window.Telegram?.WebApp;
if(tg){ tg.ready(); tg.expand(); }

/* ===== Storage helpers: Telegram CloudStorage (if available) + localStorage fallback ===== */
const AppStorage = {
  async set(key, value){
    if(tg && tg.CloudStorage){
      return new Promise(res=> tg.CloudStorage.setItem(key, JSON.stringify(value), ()=>res(true)));
    }
    localStorage.setItem(key, JSON.stringify(value)); return true;
  },
  async get(key, def=null){
    if(tg && tg.CloudStorage){
      return new Promise(res=> tg.CloudStorage.getItem(key, v=>{
        if(!v) return res(def); try{ res(JSON.parse(v)); }catch(_){ res(def); }
      }));
    }
    try{ const v=localStorage.getItem(key); return v?JSON.parse(v):def; }catch(_){ return def; }
  }
};

/* ===== Constants ===== */
const KEYS = {
  CITY:'gid_city', ROLE:'gid_role', FEED:'gid_feed', PROFILE:'gid_profile'
};
const DEFAULT_CITIES=['–ê–ª–º–∞—Ç—ã','–ê—Å—Ç–∞–Ω–∞','–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','–®—ã–º–∫–µ–Ω—Ç','–ê–∫—Ç–æ–±–µ','–¢–∞—Ä–∞–∑','–ü–∞–≤–ª–æ–¥–∞—Ä','–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫','–°–µ–º–µ–π','–ö—ã–∑—ã–ª–æ—Ä–¥–∞','–£—Ä–∞–ª—å—Å–∫','–ê—Ç—ã—Ä–∞—É','–ö–æ—Å—Ç–∞–Ω–∞–π','–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫','–≠–∫–∏–±–∞—Å—Ç—É–∑'];

/* ===== Minimal state ===== */
const $=id=>document.getElementById(id);
const uid=()=>Math.random().toString(36).slice(2,9);
const nowISO=()=>new Date().toISOString();

let STATE = {
  city:'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  role:'user',
  profile:null, // {id, name, avatarType:'image'|'emoji', avatarData}
  feed:{} // by city
};

/* ===== UI helpers ===== */
function displayName(){ return (STATE.profile?.name) || tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; }
function renderAvatar(el, prof){
  el.innerHTML=''; el.style.background='linear-gradient(135deg,#a970ff,#32ffd2)';
  if(prof?.avatarType==='image' && prof?.avatarData){ const img=document.createElement('img'); img.src=prof.avatarData; el.appendChild(img); return; }
  if(prof?.avatarType==='emoji' && prof?.avatarData){ el.textContent=prof.avatarData; el.style.fontSize='22px'; return; }
  el.textContent=(displayName()[0]||'?').toUpperCase();
}
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }
function closeScreen(id){ $(id).classList.remove('active'); }

/* ===== Role tabs + City ===== */
function setRoleTabs(){
  const wrap=$('roleTabs'); wrap.innerHTML='';
  [['user','–°–§–ï–†–ê –£–°–õ–£–ì'],['worker','–ü–û–î–†–ê–ë–û–¢–ö–ê']].forEach(([val,label])=>{
    const d=document.createElement('div'); d.className='role-tab'; d.dataset.role=val; d.textContent=label; if(STATE.role===val) d.classList.add('active'); wrap.appendChild(d);
  });
  wrap.onclick=(e)=>{ const t=e.target.closest('.role-tab'); if(!t) return; STATE.role=t.dataset.role; persistState(); setRoleTabs(); applyMenu(); };
}
function fillCities(){
  const selQuick=$('cityQuickSelect'); selQuick.innerHTML=''; DEFAULT_CITIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; if(c===STATE.city) o.selected=true; selQuick.appendChild(o); });
  const sel=$('citySelect'); sel.innerHTML=''; DEFAULT_CITIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; if(c===STATE.city) o.selected=true; sel.appendChild(o); });
  $('topCity').textContent='–ì–æ—Ä–æ–¥: '+STATE.city;
}
$('saveQuickCity').onclick=()=>{ STATE.city=$('cityQuickSelect').value; persistState(); fillCities(); renderCityPosts(); };

/* ===== Menu ===== */
function iconOrder(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18"/><path d="M7 3v4"/><path d="M17 3v4"/><rect x="3" y="7" width="18" height="14" rx="2"/></svg>'}
function iconCity(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21v-8a2 2 0 0 1 2-2h3v10"/><path d="M14 21V10h4v11"/><path d="M7 10V3h7v7"/></svg>'}
function iconFind(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="6"/><path d="M21 21l-4.35-4.35"/></svg>'}
function iconMsg(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'}
function iconWallet(){return '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3v4"/><circle cx="18" cy="13" r="1"/></svg>'}
function menuBtn(id,title,note,icon){ const d=document.createElement('div'); d.id=id; d.className='menu-btn'; d.innerHTML=`<div class="left">${icon||iconOrder()}</div><div style="flex:1"><div class="title">${title}</div><div class="note">${note}</div></div>`; return d; }
function applyMenu(){
  const grid=$('menuGrid'); grid.innerHTML='';
  if(STATE.role==='user'){
    grid.appendChild(menuBtn('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É',iconOrder()));
    grid.appendChild(menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π',iconFind()));
    grid.appendChild(menuBtn('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å',iconCity()));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏', iconMsg()));
    grid.appendChild(menuBtn('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–ü—É–±–ª–∏–∫—É–π—Ç–µ –∏ –∏—â–∏—Ç–µ'));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏', iconWallet()));
    grid.appendChild(menuBtn('btnSettings','–ù–∞—Å—Ç—Ä–æ–π–∫–∏','–¢–µ–º—ã, –≥–æ—Ä–æ–¥'));
  }else{
    grid.appendChild(menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π',iconFind()));
    grid.appendChild(menuBtn('btnCity','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å',iconCity()));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏', iconMsg()));
    grid.appendChild(menuBtn('btnAds','–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥','–ü—É–±–ª–∏–∫—É–π—Ç–µ –∏ –∏—â–∏—Ç–µ'));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏', iconWallet()));
    grid.appendChild(menuBtn('btnSettings','–ù–∞—Å—Ç—Ä–æ–π–∫–∏','–¢–µ–º—ã, –≥–æ—Ä–æ–¥'));
  }
  const on=(id,fn)=>{ const el=$(id); if(el){ el.onclick=fn; } };
  on('btnCity',()=>{ openScreen('cityThreadScreen'); renderCityPosts(); });
  on('btnSettings',()=> openScreen('settingsModal'));
  on('btnOrder',()=> tg?.showAlert?.('–≠–∫—Ä–∞–Ω ¬´–ó–∞–∫–∞–∑–∞—Ç—å¬ª –¥–æ–±–∞–≤–ª—é –ø–æ—Å–ª–µ —á–∞—Ç–∞ –≤ —ç—Ç–æ–π –º–∏–Ω–∏-–≤–µ—Ä—Å–∏–∏.'));
  on('btnFind',()=> tg?.showAlert?.('–≠–∫—Ä–∞–Ω ¬´–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã¬ª –≤ —Å–ª–µ–¥—É—é—â–µ–º –∞–ø–¥–µ–π—Ç–µ –º–∏–Ω–∏-–∞–ø–ø–∞.'));
}

/* ===== City feed ===== */
function ensureFeed(){ if(!STATE.feed[STATE.city]) STATE.feed[STATE.city]=[]; return STATE.feed[STATE.city]; }
function renderCityPosts(){
  const wrap=$('cityPosts'); wrap.innerHTML='';
  const list=ensureFeed();
  if(!list.length){ wrap.innerHTML='<div class="field-label" style="padding:10px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
  list.forEach(p=>{
    const card=document.createElement('div'); card.className='post-card';
    const head=document.createElement('div'); head.style.display='flex'; head.style.gap='8px'; head.style.alignItems='center';
    const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, {avatarType:p.authorAvatarType, avatarData:p.authorAvatarData, name:p.authorName}); head.appendChild(av);
    const nm=document.createElement('div'); nm.style.fontWeight='900'; nm.textContent=p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; head.appendChild(nm);
    const tm=document.createElement('div'); tm.className='field-label'; tm.style.marginLeft='auto'; tm.textContent=new Date(p.ts).toLocaleString('ru-RU'); head.appendChild(tm);
    card.appendChild(head);
    const text=document.createElement('div'); text.style.marginTop='8px'; text.style.whiteSpace='pre-wrap'; text.textContent=p.text||''; card.appendChild(text);
    if(p.image){ const img=document.createElement('img'); img.src=p.image; img.className='post-img'; card.appendChild(img); }
    const actions=document.createElement('div'); actions.className='post-actions';
    const likeBtn=document.createElement('button'); likeBtn.className='btn'; likeBtn.innerHTML=`‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è (<span>${Object.keys(p.likes?.byUser||{}).length}</span>)`;
    likeBtn.onclick=()=>{
      const me=STATE.profile?.id || 'u_demo';
      p.likes||(p.likes={byUser:{}});
      if(p.likes.byUser[me]) delete p.likes.byUser[me]; else p.likes.byUser[me]=true;
      likeBtn.querySelector('span').textContent=String(Object.keys(p.likes.byUser).length);
      persistState();
    };
    const cmtBtn=document.createElement('button'); cmtBtn.className='btn'; cmtBtn.textContent='üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å';
    actions.appendChild(likeBtn); actions.appendChild(cmtBtn);
    card.appendChild(actions);
    const cWrap=document.createElement('div'); cWrap.style.marginTop='8px'; cWrap.style.display='none';
    const cRow=document.createElement('div'); cRow.style.display='flex'; cRow.style.gap='8px'; cRow.style.alignItems='center';
    const cInput=document.createElement('input'); cInput.className='input'; cInput.placeholder='–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...';
    const cSend=document.createElement('button'); cSend.className='btn primary'; cSend.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    cRow.appendChild(cInput); cRow.appendChild(cSend); cWrap.appendChild(cRow);
    const cList=document.createElement('div'); cWrap.appendChild(cList);
    card.appendChild(cWrap);
    cmtBtn.onclick=()=>{ cWrap.style.display=cWrap.style.display==='none'?'block':'none'; };
    cSend.onclick=()=>{
      const txt=cInput.value.trim(); if(!txt) return;
      const me=STATE.profile||{name:displayName(), avatarType:'emoji', avatarData:'ü§ñ'};
      const c={ id:'c_'+uid(), authorName: me.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', authorAvatarType:me.avatarType, authorAvatarData:me.avatarData, text:txt, ts: nowISO() };
      (p.comments||(p.comments=[])).push(c);
      const row=document.createElement('div'); row.className='comment';
      row.innerHTML=`<div style="display:flex; gap:6px; align-items:center;"><div class="avatar" id="cav_${c.id}" style="width:20px;height:20px"></div><div style="font-weight:800">${c.authorName}</div><div class="field-label" style="margin-left:auto">${new Date(c.ts).toLocaleString('ru-RU')}</div></div><div style="margin-top:6px; white-space:pre-wrap">${c.text}</div>`;
      cList.appendChild(row); setTimeout(()=>{ const el=document.getElementById('cav_'+c.id); if(el) renderAvatar(el, {avatarType:c.authorAvatarType, avatarData:c.authorAvatarData, name:c.authorName}); },0);
      cInput.value=''; persistState();
    };
    (p.comments||[]).forEach(c=>{
      const row=document.createElement('div'); row.className='comment';
      row.innerHTML=`<div style="display:flex; gap:6px; align-items:center;"><div class="avatar" id="cav_${c.id}" style="width:20px;height:20px"></div><div style="font-weight:800">${c.authorName||''}</div><div class="field-label" style="margin-left:auto">${new Date(c.ts).toLocaleString('ru-RU')}</div></div><div style="margin-top:6px; white-space:pre-wrap">${c.text||''}</div>`;
      cList.appendChild(row); setTimeout(()=>{ const el=document.getElementById('cav_'+c.id); if(el) renderAvatar(el, {avatarType:c.authorAvatarType, avatarData:c.authorAvatarData, name:c.authorName}); },0);
    });
    wrap.appendChild(card);
  });
}

/* ===== Composer ===== */
let __cityImg=null;
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id==='cityPostImage'){
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ __cityImg=r.result; tg?.showPopup?.({title:'–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ', message:'–ö –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', buttons:[{type:'ok'}]}); }; r.readAsDataURL(f);
  }
});
document.getElementById('cityPostSend').addEventListener('click',()=>{
  const text=$('cityPostText').value.trim(); if(!text && !__cityImg){ tg?.showAlert?.('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ'); return; }
  const me=STATE.profile || { id:'u_demo', name: displayName(), avatarType:'emoji', avatarData:'ü§ñ' };
  const post={ id:'post_'+uid(), authorName: me.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', authorAvatarType:me.avatarType, authorAvatarData:me.avatarData, text, image: __cityImg||null, ts: nowISO(), likes:{byUser:{}}, comments:[] };
  const list=ensureFeed(); list.unshift(post);
  $('cityPostText').value=''; __cityImg=null; persistState(); renderCityPosts();
});

/* ===== Settings/Profile (with emoji) ===== */
const APPLE_EMOJI=['ü•π','ü§©','üòè','ü§ñ','üòé','üòä','üòá','üòç','üß†','ü¶æ','üêº','ü¶Ñ','üéØ','üî•','üíô','üíú'];
function setupProfileUI(){
  const sel=$('citySelect'); sel.innerHTML=''; DEFAULT_CITIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; if(c===STATE.city) o.selected=true; sel.appendChild(o); });
  $('profileName').value=STATE.profile?.name||tg?.initDataUnsafe?.user?.first_name||'';
  renderAvatar($('avatarPreview'), STATE.profile);
  $('pickEmojiBtn').onclick=()=>{
    const box=$('emojiPicker'); if(box.style.display==='none'){ $('emojiGrid').innerHTML=''; APPLE_EMOJI.forEach(e=>{ const it=document.createElement('div'); it.className='emoji-item'; it.textContent=e; it.onclick=()=>{ STATE.profile=STATE.profile||{id: tg?.initDataUnsafe?.user?.id ? 'tg_'+tg.initDataUnsafe.user.id : 'u_'+uid()}; STATE.profile.avatarType='emoji'; STATE.profile.avatarData=e; renderAvatar($('avatarPreview'), STATE.profile); }; $('emojiGrid').appendChild(it); }); box.style.display='block'; } else box.style.display='none';
  };
  $('profilePhoto').onchange=(ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ STATE.profile=STATE.profile||{id: tg?.initDataUnsafe?.user?.id ? 'tg_'+tg.initDataUnsafe.user.id : 'u_'+uid()}; STATE.profile.avatarType='image'; STATE.profile.avatarData=r.result; renderAvatar($('avatarPreview'), STATE.profile); }; r.readAsDataURL(f); };
  $('saveProfileBtn').onclick=async ()=>{
    STATE.city=$('citySelect').value;
    STATE.profile=STATE.profile||{id: tg?.initDataUnsafe?.user?.id ? 'tg_'+tg.initDataUnsafe.user.id : 'u_'+uid()};
    const nm=$('profileName').value.trim(); if(nm) STATE.profile.name=nm; else if(!STATE.profile.name) STATE.profile.name=displayName();
    if(!STATE.profile.avatarType){ STATE.profile.avatarType='emoji'; STATE.profile.avatarData='ü§ñ'; }
    await persistState();
    fillCities();
    closeScreen('settingsModal');
    tg?.showPopup?.({title:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', message:'–ü—Ä–æ—Ñ–∏–ª—å –∏ –≥–æ—Ä–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', buttons:[{type:'ok'}]});
  };
}

$('openSettings').onclick=()=>{ setupProfileUI(); openScreen('settingsModal'); };

/* ===== Persistence (Telegram CloudStorage) ===== */
async function persistState(){
  await AppStorage.set(KEYS.CITY, STATE.city);
  await AppStorage.set(KEYS.ROLE, STATE.role);
  await AppStorage.set(KEYS.PROFILE, STATE.profile);
  await AppStorage.set(KEYS.FEED, STATE.feed);
}
async function loadState(){
  STATE.city = await AppStorage.get(KEYS.CITY, STATE.city);
  STATE.role = await AppStorage.get(KEYS.ROLE, STATE.role);
  STATE.profile = await AppStorage.get(KEYS.PROFILE, STATE.profile);
  STATE.feed = await AppStorage.get(KEYS.FEED, STATE.feed);
}

/* ===== Init ===== */
async function init(){
  await loadState();
  // Prefill from Telegram user if empty
  if(!STATE.profile){
    const tgUser = tg?.initDataUnsafe?.user;
    STATE.profile = { id: tgUser?.id ? 'tg_'+tgUser.id : 'u_'+uid(), name: tgUser?.first_name || '', avatarType:'', avatarData:'' };
    await persistState();
  }
  $('topCity').textContent='–ì–æ—Ä–æ–¥: '+STATE.city;
  fillCities();
  setRoleTabs();
  applyMenu();
}
init();
</script>
</body>
</html>
