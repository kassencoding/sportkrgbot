<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GiD City ‚Äî –°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥ & –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* =================== –¢–ï–ú–´ =================== */
:root{
  --bg-1:#0a0f1a; --bg-2:#0b0e1c; --bg-3:#0b0e1e;
  --radial-a:#1e1b3a; --radial-b:#08152a;

  --surface:rgba(20,24,40,.92);
  --line:rgba(160,170,230,.28);

  --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff;
  --danger:#ff4f6a; --gold:#ffd84d;

  --text:#ffffff; --text-dim:#d8dcff; --text-muted:#9aa6d9; --text-invert:#0b0f18;

  --radius:16px; --ui-font:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --ui-font-size:14px;
  --shadow:0 16px 46px rgba(0,0,0,.45);
}
/* –±–∞–∑–æ–≤—ã–µ */
html[data-theme="violet"]{ --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff; --bg-1:#060614; --bg-2:#07081a; --bg-3:#090b22; --line:rgba(160,170,230,.28);} 
html[data-theme="navy"]  { --accent-a:#6aa7ff; --accent-b:#7ef3ff; --accent-c:#65d0ff; --bg-1:#04101c; --bg-2:#041426; --bg-3:#061a32; --line:rgba(110,150,240,.18);} 
html[data-theme="emerald"]{ --accent-a:#33e09d; --accent-b:#b7ff78; --accent-c:#75ffd9; --bg-1:#081710; --bg-2:#082019; --bg-3:#071a12; --line:rgba(60,200,150,.12);} 
html[data-theme="sunset"]{ --accent-a:#ff6dab; --accent-b:#ffcc6d; --accent-c:#ff9b6d; --bg-1:#1a080a; --bg-2:#22090b; --bg-3:#2c0b10; --line:rgba(255,140,100,.12);} 
html[data-theme="light1"]{ --bg-1:#ffffff; --bg-2:#f6f7fb; --bg-3:#eef1f7; --text:#1a1a1a; --text-dim:#2c2c2c; --text-muted:#555; --text-invert:#ffffff; --surface:#ffffff; --line:#e5e8f0; --accent-a:#6a5cff; --accent-b:#22c1c3; --accent-c:#6a8cff; }
html[data-theme="light2"]{ --bg-1:#fefefe; --bg-2:#edf6ff; --bg-3:#e6f0ff; --text:#191c22; --text-dim:#2a2f36; --text-muted:#4b5563; --text-invert:#ffffff; --surface:#ffffff; --line:#e1e7f0; --accent-a:#8a65ff; --accent-b:#4de0c2; --accent-c:#74a6ff; }

/* =================== –§–û–ù =================== */
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; padding:18px; color:var(--text);
  font: var(--ui-font-size) var(--ui-font);
  background:
    radial-gradient(900px at 20% -10%, var(--radial-a) 0%, transparent 70%),
    radial-gradient(700px at 120% 20%, var(--radial-b) 0%, transparent 70%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2),var(--bg-3));
  display:flex; justify-content:center;
}

.wrapper{ width:100%; max-width:1100px; display:flex; flex-direction:column; gap:16px; }

/* =================== –•–ï–î–ï–† =================== */
.header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:6px 2px; }
.brand{ display:flex; flex-direction:column; gap:6px; }
.brand h1{
  margin:0; font-weight:800; font-size:22px;
  background:linear-gradient(90deg,var(--accent-a),var(--accent-b));
  -webkit-background-clip:text; color:transparent;
  text-shadow:0 0 18px rgba(169,112,255,.28);
}
.header-sub{ font-size:13px; color:var(--text-muted) }
.header-right{ display:flex; flex-direction:column; gap:10px; align-items:flex-end }

/* =================== –ö–ù–û–ü–ö–ò =================== */
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; color:var(--text);
  padding:10px 14px; border-radius:12px; line-height:1;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  border:1px solid var(--line); box-shadow:var(--shadow); transition:transform .12s, box-shadow .25s, background .18s;
}
.btn:hover{ transform:translateY(-1px) }
.btn:active{ transform:translateY(0) }
.btn.primary{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:var(--text-invert); }
.btn.ghost{ background:transparent; }
.controls-row{ display:flex; gap:8px }
.btn-with-badge{ position:relative }
.badge-dot{ position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px;
  display:flex; align-items:center; justify-content:center; background:var(--danger); color:#fff; border-radius:999px; font-size:12px; font-weight:900; box-shadow:0 0 0 2px rgba(0,0,0,.7);
}

/* =================== ROLE TABS (moved above panel-top) =================== */
.role-tabs{ display:flex; gap:12px; align-items:center; justify-content:flex-start; margin-bottom:12px }
.role-tab{
  width:160px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; gap:8px;
  font-weight:900; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.12));
  border:1px solid var(--line); cursor:pointer; transition:transform .18s, box-shadow .18s, color .12s, border-color .12s, background .12s;
  color:var(--text-dim); position:relative; overflow:hidden;
}
.role-tab .label{ font-weight:900; font-size:13px; }
.role-tab.active{ transform:scale(1.06); color:var(--gold); border-color:rgba(255,216,77,.9); box-shadow:0 10px 30px rgba(255,200,80,.06); background:linear-gradient(90deg, rgba(255,216,77,.06), rgba(169,112,255,.02)); }

/* =================== CONTAINER / MENU =================== */
.container{ width:100%; border-radius:20px; padding:18px; background:var(--surface); border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden }
.panel-top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid var(--line) }
.panel-top h2{ margin:0; font-size:18px; font-weight:900 }

/* add notif button area at panel-top right */
.panel-controls{ display:flex; gap:8px; align-items:center }

/* menu grid: centered with equal margins */
.menu-grid{ display:flex; gap:12px; width:100%; justify-content:center; flex-wrap:wrap; align-items:flex-start; padding:12px 6px; }
.menu-btn{
  display:flex; align-items:center; gap:12px; cursor:pointer;
  min-height:64px; padding:12px 16px; border-radius:14px; border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.16)); box-shadow:0 8px 26px rgba(0,0,0,.35);
  color:var(--text); transition:transform .18s, box-shadow .2s, background .16s;
  flex: 0 1 320px; max-width:360px; width:calc(33% - 24px); min-width:230px;
  justify-content:flex-start;
}
.menu-btn .left{ width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg, rgba(255,255,255,.03), rgba(0,0,0,.06)); flex-shrink:0; }
.menu-btn .title{ font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.menu-btn .note{ font-size:12px; color:var(--text-muted) }
.menu-btn.primary{ background:linear-gradient(135deg, rgba(169,112,255,.12), rgba(50,255,210,.06)); border-color: rgba(169,112,255,.16); }
.menu-btn.disabled{ opacity:.6; pointer-events:none }

/* reveal animation for menu items */
.menu-grid.revealing .menu-btn{ opacity:0; transform:translateY(18px) scale(.98); animation:revealUp .42s forwards; }
@keyframes revealUp{ to{ opacity:1; transform:translateY(0) scale(1); } }

/* =================== CARDS / AVATARS =================== */
.card{ background:linear-gradient(180deg, rgba(12,16,30,.9), rgba(8,12,26,.9)); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:var(--shadow); display:flex; gap:12px; align-items:flex-start }
.avatar{ width:32px; height:32px; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; color:#fff }
.avatar img{ width:100%; height:100%; object-fit:cover }

/* =================== INPUTS / MODAL SYMMETRY =================== */
.input, textarea, select{
  width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
  background:rgba(12,16,36,.75); color:var(--text); font-size:14px; outline:none; box-sizing:border-box;
}
.input:focus, textarea:focus, select:focus{ border-color:var(--accent-a); box-shadow:0 0 0 3px rgba(169,112,255,.12) }
textarea{ min-height:110px; resize:vertical }
.row{ display:flex; gap:8px; flex-wrap:wrap } .col{ flex:1 1 260px }
.small{ font-size:12px; color:var(--text-muted) }
.form-stack .input{ height:48px; min-height:48px; display:flex; align-items:center }

/* modal content */
.screen{ position:fixed; inset:0; display:none; z-index:120; padding:12px; background:rgba(0,0,0,.55); backdrop-filter:blur(8px); align-items:flex-start; justify-content:center }
.screen.active{ display:flex }
.modal{ width:100%; max-width:1100px; max-height:88vh; overflow:auto; background:var(--surface); color:var(--text); box-shadow:var(--shadow); border:1px solid var(--line); border-radius:18px; padding:16px }
.modal .content-inner{ padding:6px; display:block }

/* posts/chat */
.msgs{ margin-top:8px; max-height:58vh; overflow:auto; padding-right:6px }
.msg-row{ margin:8px 0 } .msg-me{ text-align:right }
.msg-me .b{ display:inline-block; background:linear-gradient(90deg, rgba(169,112,255,.9), rgba(50,255,210,.9)); padding:8px 12px; border-radius:10px; color:#0a0f1e; font-weight:800 }
.msg-other .b{ display:inline-block; background:rgba(255,255,255,.06); border:1px solid var(--line); padding:8px 12px; border-radius:10px }
.msg-system{ text-align:center; margin:10px 0 14px 0; color:var(--text-muted); font-size:12px }
.msg-img{ display:block; max-width:60%; border-radius:12px; margin-top:6px; border:1px solid var(--line) }

.post-card{ background:linear-gradient(180deg, rgba(12,16,30,.92), rgba(8,12,26,.9)); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:var(--shadow); margin-bottom:10px }
.post-img{ width:100%; border-radius:12px; margin-top:8px; max-height:360px; object-fit:cover }
.post-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
.comment{ background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:10px; padding:8px; margin-top:6px }

/* theme list scrollbar like city select */
.theme-list{ max-height:200px; overflow:auto; padding-right:6px; display:flex; gap:8px; flex-direction:column }
/* scrollbars ‚Äî neon minimal (vertical) */
::-webkit-scrollbar{ width:10px; height:10px; }
::-webkit-scrollbar-track{ background:transparent; }
::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, rgba(169,112,255,.22), rgba(50,255,210,.12)); border-radius:999px; border:2px solid rgba(0,0,0,.12); }

/* city composer fixed tiny panel */
.city-composer-fixed{ position:sticky; bottom:12px; left:0; right:0; display:flex; gap:8px; align-items:center; padding:8px 12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06)); border:1px solid var(--line); box-shadow:var(--shadow); cursor:pointer; max-width:720px; margin:12px auto 0 auto }
.city-composer-fixed .avatar{ width:28px; height:28px; border-radius:8px }
.city-composer-fixed .share{ margin-left:auto; color:var(--text-muted) }
.city-composer-fixed.hidden{ transform:translateY(110%); opacity:0; transition:transform .28s, opacity .28s; }
.city-composer-fixed.visible{ transform:translateY(0); opacity:1; transition:transform .28s, opacity .28s; }

/* responsive */
@media (max-width:900px){ .menu-btn{ width:100%; flex-basis:100%; } .role-tab{ width:48%; } }
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiD City</h1>
      <div id="topCity" class="header-sub">–ì–æ—Ä–æ–¥: ‚Äî</div>
    </div>
    <div class="header-right">
      <div class="controls-row">
        <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
      <!-- role tabs moved visually above panel-top (kept here for initial placement) -->
    </div>
  </header>

  <main class="container" role="main" aria-live="polite">
    <!-- ROLE TABS: —Ç–µ–ø–µ—Ä—å —Å–≤–µ—Ä—Ö—É –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
    <div class="role-tabs" id="roleTabs">
      <div class="role-tab" data-role="user" id="roleUserBtn"><span class="label">–°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥</span></div>
      <div class="role-tab" data-role="worker" id="roleWorkerBtn"><span class="label">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</span></div>
    </div>

    <div class="panel-top"><h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
      <div class="panel-controls">
        <!-- –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ —Å—é–¥–∞, –Ω–∞–ø—Ä–æ—Ç–∏–≤ –Ω–∞–¥–ø–∏—Å–∏ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" -->
        <button id="openNotifications" class="btn btn-with-badge">üîî <span id="notifBadge" class="badge-dot" style="display:none">0</span></button>
      </div>
    </div>

    <div class="menu-grid" id="menuGrid"></div>

    <!-- footer small minimal text under the panel -->
    <div style="margin-top:12px; text-align:center; font-size:11px; color:var(--text-muted);">kassen technology inc</div>
  </main>
</div>

<!-- WELCOME OVERLAY -->
<section id="welcomeOverlay" class="screen active" style="background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.6)); align-items:center; justify-content:center;">
  <div class="modal" style="max-width:720px; text-align:center;">
    <div style="font-weight:900; font-size:26px; margin:18px 0;" id="welcomeText">Welcome to GiDCity</div>
    <div style="color:var(--text-muted)">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...</div>
  </div>
</section>

<!-- CITY THREAD (updated composer small fixed panel + image icon input) -->
<section id="cityThreadScreen" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
      <button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="margin-top:12px; position:relative;">
      <!-- posts list -->
      <div id="cityPosts" style="margin-top:6px; max-height:60vh; overflow:auto; padding-right:6px"></div>

      <!-- fixed tiny composer panel (appears at bottom of modal content) -->
      <div id="cityComposerFixed" class="city-composer-fixed visible" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
        <div class="avatar" id="composerAvatar">–Ø</div>
        <div style="margin-left:8px; font-weight:700" id="composerName">–í—ã</div>
        <div class="share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è...</div>
      </div>
    </div>
  </div>
</div></section>

<!-- quick post modal (appears when composer clicked) -->
<section id="quickPostModal" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ª–µ–Ω—Ç–µ</h3><button onclick="closeScreen('quickPostModal')" class="btn ghost">–û—Ç–º–µ–Ω–∞</button></div>
    <div style="margin-top:12px;">
      <textarea id="quickPostText" class="input" placeholder="–û —á—ë–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å?"></textarea>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <!-- image icon button -->
        <label class="btn" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ" style="padding:8px 10px; font-weight:900;">
          üì∑ <input id="quickPostImage" type="file" accept="image/*" style="display:none">
        </label>
        <div id="quickPostPreview" style="margin-top:8px; flex:1"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="quickPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>
</div></section>

<!-- notifications modal -->
<section id="notificationsModal" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('notificationsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <div id="notificationsList" style="margin-top:12px; max-height:66vh; overflow:auto"></div>
  </div>
</div></section>

<!-- settings (theme list turned into scrollable list like city) -->
<section id="settingsModal" class="screen"><div class="modal">
  <div class="content-inner">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="closeScreen('settingsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <div style="margin-top:10px">
      <div style="font-weight:900">–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
      <div id="themeList" class="theme-list" style="margin-top:8px;"> <!-- themes will be rendered here with vertical scrollbar -->
      </div>

      <div style="margin-top:16px; font-weight:900">–ì–æ—Ä–æ–¥</div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; align-items:center;">
        <select id="citySelect" class="input" style="max-width:260px">
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî</option>
          <option>–ê–ª–º–∞—Ç—ã</option><option>–ê—Å—Ç–∞–Ω–∞</option><option>–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</option><option>–®—ã–º–∫–µ–Ω—Ç</option><option>–ê–∫—Ç–æ–±–µ</option>
        </select>
        <button id="saveCityBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <label style="display:flex;align-items:center;gap:8px"><input id="autoSyncToggle" type="checkbox" style="transform:scale(1.1)"> <span class="small">–ê–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span></label>
        <button id="syncNowBtn" class="btn">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
        <button id="openProfile" class="btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
      </div>
    </div>
  </div>
</div></section>

<script>
/* =================== CONSTANTS / STORE (unchanged) =================== */
const LS_ORD='gid_orders_v13', LS_CHAT='gid_chats_v13', LS_ADS='gid_ads_v2', LS_PROFILE='gid_profile_v1', LS_ROLE='gid_role_v1', LS_CITY='gid_city_v1', LS_NOTIF='gid_notif_v1', LS_WALLET='gid_wallet_v1', LS_THEME='gid_theme_v1', LS_CITY_FEED='gid_city_feed_v3';
const $=id=>document.getElementById(id);
const uid=()=>Math.random().toString(36).slice(2,9);
const nowISO=()=>new Date().toISOString();

/* simplified store (same as before) */
const Store={
  getOrders(){try{return JSON.parse(localStorage.getItem(LS_ORD))||[]}catch(e){return[]}}, setOrders(v){localStorage.setItem(LS_ORD,JSON.stringify(v))},
  addOrder(o){const a=this.getOrders();a.unshift(o);this.setOrders(a);return a}, updateOrder(id,fn){const a=this.getOrders();const i=a.findIndex(x=>x.id===id);if(i>-1){fn(a[i]);this.setOrders(a);}return a},
  getChats(){try{return JSON.parse(localStorage.getItem(LS_CHAT))||[]}catch(e){return[]}}, setChats(v){localStorage.setItem(LS_CHAT,JSON.stringify(v))}, addChat(c){const a=this.getChats();a.unshift(c);this.setChats(a);return a}, updateChat(id,fn){const a=this.getChats();const i=a.findIndex(x=>x.id===id);if(i>-1){fn(a[i]);this.setChats(a);}return a},
  getAds(){try{return JSON.parse(localStorage.getItem(LS_ADS))||[]}catch(e){return[]}}, setAds(v){localStorage.setItem(LS_ADS,JSON.stringify(v))},
  getProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE))||null}catch(e){return null}}, setProfile(p){localStorage.setItem(LS_PROFILE,JSON.stringify(p))},
  getRole(){return localStorage.getItem(LS_ROLE)||'user'}, setRole(r){localStorage.setItem(LS_ROLE,r)},
  getCity(){return localStorage.getItem(LS_CITY)||''}, setCity(c){localStorage.setItem(LS_CITY,c)},
  getNotifs(){try{return JSON.parse(localStorage.getItem(LS_NOTIF))||[]}catch(e){return[]}}, setNotifs(a){localStorage.setItem(LS_NOTIF,JSON.stringify(a))},
  getWallet(){try{return JSON.parse(localStorage.getItem(LS_WALLET))||{balance:0,ops:[]}}catch(e){return{balance:0,ops:[]}}}, setWallet(w){localStorage.setItem(LS_WALLET,JSON.stringify(w))},
  getTheme(){return localStorage.getItem(LS_THEME)||'violet'}, setTheme(t){localStorage.setItem(LS_THEME,t); applyTheme(); },
  getCityFeed(){ try{return JSON.parse(localStorage.getItem(LS_CITY_FEED))||{} }catch(_){ return {} } }, setCityFeed(obj){ localStorage.setItem(LS_CITY_FEED, JSON.stringify(obj)); saveCloudDebounced(); }
};

/* THEME apply: also update --line so modals/panels lines change with theme */
const THEME_LINES = { violet:'rgba(160,170,230,.28)', navy:'rgba(110,150,240,.18)', emerald:'rgba(60,200,150,.12)', sunset:'rgba(255,140,100,.12)', light1:'#e5e8f0', light2:'#e1e7f0' };
function applyTheme(){ const t=Store.getTheme(); document.documentElement.setAttribute('data-theme', t); const line=THEME_LINES[t]||'rgba(160,170,230,.28)'; document.documentElement.style.setProperty('--line', line); renderThemeButtons(); }

/* small helpers */
function esc(s){return String(s||'').replace(/[&<>"]/,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]) )}
function currentUser(){return Store.getProfile();}
function currentUserId(){return currentUser()?.id || 'u_demo_user';}

/* RENDER THEME BUTTONS into scrollable area */
const AVAILABLE_THEMES = ['violet','navy','emerald','sunset','peach','sunrise','amber','rose','mint','light1','light2'];
function renderThemeButtons(){ const wrap=$('themeList'); if(!wrap) return; wrap.innerHTML=''; AVAILABLE_THEMES.forEach(t=>{ const b=document.createElement('button'); b.className='btn'; b.style.justifyContent='space-between'; b.dataset.theme=t; b.textContent=t; const p=document.createElement('div'); p.style.opacity=.7; p.style.fontSize='12px'; p.textContent='‚Ä∫'; b.appendChild(p); b.addEventListener('click', ()=>{ Store.setTheme(t); applyTheme(); }); wrap.appendChild(b); }); }

/* ROLE & MENU wiring (moved role-tabs into container) */
function setRoleLabelsUI(){ const role=Store.getRole(); document.querySelectorAll('.role-tab').forEach(tab=>tab.classList.toggle('active', tab.dataset.role===role)); }
function menuBtnObj(id,title,note,extraClass){ const el=document.createElement('div'); el.id=id; el.className='menu-btn'+(extraClass?(' '+extraClass):''); const left=document.createElement('div'); left.className='left'; left.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"></circle></svg>'; const textWrap=document.createElement('div'); textWrap.style.flex='1'; const t=document.createElement('div'); t.className='title'; t.innerHTML=title; const n=document.createElement('div'); n.className='note'; n.innerHTML=note||''; textWrap.appendChild(t); textWrap.appendChild(n); el.appendChild(left); el.appendChild(textWrap); return el; }
function applyRoleUI(){ setRoleLabelsUI(); const role=Store.getRole(), grid=$('menuGrid'); grid.innerHTML=''; if(role==='user'){ grid.appendChild(menuBtnObj('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞','primary')); grid.appendChild(menuBtnObj('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π')); grid.appendChild(menuBtnObj('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å')); grid.appendChild(menuBtnObj('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏')); grid.appendChild(menuBtnObj('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏')); grid.appendChild(menuBtnObj('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏')); } else { grid.appendChild(menuBtnObj('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π','primary')); grid.appendChild(menuBtnObj('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π')); grid.appendChild(menuBtnObj('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å')); grid.appendChild(menuBtnObj('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏')); grid.appendChild(menuBtnObj('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏')); grid.appendChild(menuBtnObj('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏')); }
  const items=Array.from(grid.children); grid.classList.add('revealing'); items.forEach((it,idx)=>it.style.animationDelay=(idx*80)+'ms'); setTimeout(()=>{ grid.classList.remove('revealing'); items.forEach(it=>it.style.animationDelay=''); },1200); wireMainButtons(); }

/* NOTIFS */
function refreshNotifBadge(){ const n=(Store.getNotifs()||[]).length; const b=$('notifBadge'); if(!b) return; if(n>0){ b.style.display='flex'; b.textContent=n>99?'99+':String(n); } else b.style.display='none'; }
function renderNotifs(){ const list=$('notificationsList'); list.innerHTML=''; const arr=Store.getNotifs(); if(!arr.length){ list.innerHTML='<div class="small" style="padding:12px">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div>'; return; } arr.forEach(n=>{ const node=document.createElement('div'); node.className='card'; node.innerHTML=`<div style="font-weight:900">${esc(n.title)}</div><div class="small" style="margin-top:6px">${esc(n.body)}</div><div class="small" style="margin-top:8px">${new Date(n.ts).toLocaleString()}</div>`; list.appendChild(node); }); }

/* RENDER MENU initially */
applyTheme(); applyRoleUI(); renderThemeButtons(); refreshNotifBadge();

/* wire buttons */
function wireMainButtons(){ const on=(id,fn)=>{ const el=$(id); if(el){ el.addEventListener('click',fn); } };
 on('btnOrder', ()=>{ if(Store.getRole()!=='user'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è ¬´–°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥¬ª.'); return } openScreen('createScreen'); });
 on('btnFind', ()=>{ if(Store.getRole()!=='worker'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è ¬´–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞¬ª.'); return } openScreen('findScreen'); });
 on('btnMessenger', ()=>{ openScreen('messengerScreen'); renderChats(); });
 on('btnWallet', ()=>{ openScreen('walletScreen'); renderWallet(); });
 on('btnMine', ()=>{ openScreen('mineScreen'); renderMineList(); });
 on('btnAds', ()=>{ openScreen('adsScreen'); renderAds(); });
 on('btnCityThread', ()=>{ openScreen('cityThreadScreen'); renderCityPosts(); });
}

/* role tab clicks */
document.getElementById('roleTabs').addEventListener('click', (e)=>{ const tab=e.target.closest('.role-tab'); if(!tab) return; const next=tab.dataset.role; if(!next) return; Store.setRole(next); setRoleLabelsUI(); applyRoleUI(); });

/* settings buttons */
$('openSettings').addEventListener('click', ()=>{ openScreen('settingsModal'); $('citySelect').value=Store.getCity()||''; });
$('openNotifications').addEventListener('click', ()=>{ openScreen('notificationsModal'); renderNotifs(); });
$('saveCityBtn').addEventListener('click', ()=>{ const v=$('citySelect').value.trim(); if(!v) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); Store.setCity(v); updateCityLabel(); alert('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });
$('syncNowBtn').addEventListener('click', async ()=>{ await loadCloud(); alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); });

/* CITY THREAD: composer behaviour (fixed small panel that opens quickPostModal) */
function updateComposerIdentity(){ const p=Store.getProfile()||{name:'–í—ã', avatarType:'emoji', avatarData:'üôÇ'}; $('composerAvatar').textContent = p.avatarData || (p.name[0]||'–Ø'); $('composerName').textContent = p.name || '–í—ã'; }
updateComposerIdentity();
const composer = $('cityComposerFixed');
if(composer){ composer.addEventListener('click', ()=>{ $('quickPostText').value=''; $('quickPostPreview').innerHTML=''; $('quickPostImage').value=''; openScreen('quickPostModal'); }); }

// image picker in quick post modal
$('quickPostImage')?.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ $('quickPostPreview').innerHTML = `<img src="${r.result}" style="max-width:100%;border-radius:8px">`; $('quickPostPreview').dataset.img = r.result; }; r.readAsDataURL(f); });

// publish quick post -> push to city feed and render; scroll behavior: when publishing, scroll feed to top so post visible
$('quickPostSend')?.addEventListener('click', ()=>{
  const text = $('quickPostText').value.trim(); const img = $('quickPostPreview').dataset.img || null; if(!text && !img) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
  const city = Store.getCity() || ($('citySelect')?.value || '‚Äî'); if(!Store.getCity() && $('citySelect') && $('citySelect').value){ Store.setCity($('citySelect').value); updateCityLabel(); }
  const feed = Store.getCityFeed(); const me = Store.getProfile() || {id:'u_demo_user', name:'–í—ã', avatarType:'emoji', avatarData:'üôÇ'};
  const post = { id:'post_'+uid(), authorName: me.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', authorAvatarType: me.avatarType, authorAvatarData: me.avatarData, text, image: img, ts: nowISO(), likes:{byUser:{}}, comments:[] };
  (feed[city]||(feed[city]=[])).unshift(post);
  Store.setCityFeed(feed);
  $('quickPostText').value=''; $('quickPostPreview').innerHTML=''; delete $('quickPostPreview').dataset.img; closeScreen('quickPostModal'); renderCityPosts(); alert('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ');
  // after render, ensure posts container scrolls to top so new post visible
  setTimeout(()=>{ const cp = $('cityPosts'); if(cp) cp.scrollTop = 0; }, 50);
});

/* render city posts function (reused) */
function renderCityPosts(){ const container=$('cityPosts'); if(!container) return; container.innerHTML=''; const city=Store.getCity()||'‚Äî'; const feed=Store.getCityFeed(); const posts=(Array.isArray(feed[city])?feed[city]:[]); if(!posts.length){ container.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>'; return; }
 posts.forEach(p=>{
   const card=document.createElement('div'); card.className='post-card'; card.dataset.postId=p.id; const likesCount=Object.keys(p.likes?.byUser||{}).length; const name=p.authorName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; const top=`<div style="display:flex; gap:8px; align-items:center;"><div class=\"avatar\" style=\"width:32px;height:32px\" id=\"postAv_${p.id}\"></div><div style=\"font-weight:900\">${esc(name)}</div><div class=\"small\" style=\"margin-left:auto\">${new Date(p.ts).toLocaleString()}</div></div>`;
   card.innerHTML = top + `<div style="margin-top:8px; white-space:pre-wrap">${esc(p.text||'')}</div>` + (p.image?`<img class="post-img" src="${p.image}" alt="">`:'') + `<div class="post-actions"><button class="btn" data-act="like">‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è (<span data-likecount>${likesCount}</span>)</button><button class="btn" data-act="comment">üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" data-act="repost">üîÅ –†–µ–ø–æ—Å—Ç</button></div><div class="comments" style="margin-top:8px; display:none"><div style="display:flex; gap:8px; margin-bottom:8px;"><input class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."><button class="btn primary" data-act="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div><div class="comments-list"></div></div>`;
   container.appendChild(card); renderAvatar($('postAv_'+p.id), p.authorName, p.authorAvatarType, p.authorAvatarData);
   // comments
   const list=card.querySelector('.comments-list'); (p.comments||[]).forEach(c=>{ const cEl=document.createElement('div'); cEl.className='comment'; cEl.innerHTML=`<div style="display:flex; gap:6px; align-items:center;"><div class=\"avatar\" style=\"width:20px;height:20px\" id=\"cav_${c.id}\"></div><div style=\"font-weight:800\">${esc(c.authorName||'')}</div><div class=\"small\" style=\"margin-left:auto\">${new Date(c.ts).toLocaleString()}</div></div><div style=\"margin-top:6px; white-space:pre-wrap\">${esc(c.text||'')}</div>`; list.appendChild(cEl); renderAvatar($('cav_'+c.id), c.authorName, c.authorAvatarType, c.authorAvatarData); });
   // actions
   card.addEventListener('click', (e)=>{ const btn=e.target.closest('[data-act]'); if(!btn) return; const act=btn.dataset.act; if(act==='like'){ toggleLike(p.id, card); } else if(act==='comment'){ const box=card.querySelector('.comments'); box.style.display = box.style.display==='none'?'block':'none'; } else if(act==='sendComment'){ const input=card.querySelector('.comments input'); sendComment(p.id, input.value.trim(), card); input.value=''; } else if(act==='repost'){ openRepostPicker(p); } });
 }); }

function sendComment(postId, text, cardEl){ if(!text) return; const me=Store.getProfile()||{name:'–í—ã'}; const city=Store.getCity()||'‚Äî'; const feed=Store.getCityFeed(); const posts=feed[city]||[]; const post=posts.find(p=>p.id===postId); if(!post) return; const c={id:'c_'+uid(), authorName:me.name, authorAvatarType:me.avatarType, authorAvatarData:me.avatarData, text, ts: nowISO()}; (post.comments||(post.comments=[])).push(c); feed[city]=posts; Store.setCityFeed(feed); renderCityPosts(); }
function toggleLike(postId, cardEl){ const meId=currentUserId(); const city=Store.getCity()||'‚Äî'; const feed=Store.getCityFeed(); const posts=feed[city]||[]; const post=posts.find(p=>p.id===postId); if(!post) return; if(!post.likes) post.likes={byUser:{}}; if(post.likes.byUser[meId]) delete post.likes.byUser[meId]; else post.likes.byUser[meId]=true; feed[city]=posts; Store.setCityFeed(feed); renderCityPosts(); }
function openRepostPicker(post){ // open repost modal and let user pick chat
  window.__repostPost = post; openScreen('repostScreen'); const list=$('repostList'); list.innerHTML=''; const chats=Store.getChats(); if(!chats.length){ list.innerHTML='<div class="small" style="padding:12px">–ù–µ—Ç —á–∞—Ç–æ–≤ –¥–ª—è —Ä–µ–ø–æ—Å—Ç–∞</div>'; return; } chats.forEach(c=>{ const item=document.createElement('div'); item.className='card'; item.style.cursor='pointer'; item.innerHTML=`<div style="font-weight:900">${esc(c.title||'–ß–∞—Ç')}</div><div class="small" style="margin-top:6px">${esc(c.meta?.context||'–î–∏–∞–ª–æ–≥')}</div>`; item.addEventListener('click', ()=>{ repostToChat(c.id, post); closeScreen('repostScreen'); openChatWindow(c.id); }); list.appendChild(item); }); }
function repostToChat(chatId, post){ Store.updateChat(chatId, c=>{ const snippet = `üîÅ –†–µ–ø–æ—Å—Ç –∏–∑ "–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞" ‚Äî ${Store.getCity()||'‚Äî'}:\n${post.text||''}`; const me=currentUserId(); c.messages.push({ fromId:me, text: snippet, ts: nowISO() }); if(post.image) c.messages.push({ fromId:me, text:'[—Ñ–æ—Ç–æ]', image: post.image, ts: nowISO() }); const other=(c.participants||[]).find(p=>p!==me); if(other){ c.unread||(c.unread={}); c.unread[other]=(c.unread[other]||0)+1; } }); pushNotif({ id:'n_'+uid(), type:'message', title:'–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', body:`–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç`, payload:{chatId}, ts:nowISO() }); }

/* simple pushNotif */
function pushNotif(n){ const arr=Store.getNotifs(); arr.unshift(n); Store.setNotifs(arr); refreshNotifBadge(); }

/* basic avatar rendering (kept) */
function initials(name){ if(!name) return '?'; const p=(name||'').split(/\s+/); return (p[0]||'').slice(0,2).toUpperCase(); }
function renderAvatar(el, name, type, data){ if(!el) return; el.innerHTML=''; el.style.background=''; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center'; if(type==='image' && data){ const img=document.createElement('img'); img.src=data; img.alt='avatar'; el.appendChild(img); return; } if(type==='emoji' && data){ el.textContent=data; el.style.fontSize='14px'; el.style.lineHeight='24px'; el.style.background='linear-gradient(135deg,#a970ff,#32ffd2)'; return; } const pal=['#a970ff','#6a8cff','#32ffd2','#61e6ff','#ffaa6b']; let h=0; for(let i=0;i<(name||'').length;i++)h+=name.charCodeAt(i); const a=pal[h%pal.length], b=pal[(h+1)%pal.length]; el.style.background=`linear-gradient(135deg, ${a}, ${b})`; el.textContent=initials(name||''); }

/* cloud sync: auto sync enabled via checkbox; periodic auto-save added */
const CLOUD = { ENABLED: true, BIN_ID: '6911fbe843b1c97be9a4dc97', KEY:  '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG', POLL_MS: 8000 };
const CloudAPI = { url: id => `https://api.jsonbin.io/v3/b/${id}`, headers: key => ({ 'Content-Type':'application/json','X-Master-Key': key,'X-Bin-Versioning':'false' }) };
let __cloudLoading=false, __cloudSaving=false, __saveTimer=null, cloudCache={orders:[],ads:[],cityFeed:{}};
async function loadCloud(){ if(!CLOUD.ENABLED||__cloudLoading) return; __cloudLoading=true; try{ const res=await fetch(CloudAPI.url(CLOUD.BIN_ID),{headers:{'X-Master-Key':CLOUD.KEY}}); if(!res.ok) throw new Error('GET '+res.status); const data=await res.json(); const remote=data.record||{}; cloudCache.orders=Array.isArray(remote.orders)?remote.orders:[]; cloudCache.ads=Array.isArray(remote.ads)?remote.ads:[]; cloudCache.cityFeed=remote.cityFeed||{}; Store.setOrders(cloudCache.orders); Store.setAds(cloudCache.ads); localStorage.setItem(LS_CITY_FEED, JSON.stringify(cloudCache.cityFeed)); renderFindList(); renderMineList(); renderAds(); renderCityPosts(); renderChats(); renderNotifs(); }catch(e){ console.warn('Cloud load error:', e); } finally{ __cloudLoading=false; } }
async function saveCloud(){ if(!CLOUD.ENABLED||__cloudSaving) return; __cloudSaving=true; try{ const payload={ orders: Store.getOrders(), ads: Store.getAds(), cityFeed: Store.getCityFeed() }; cloudCache=payload; const res=await fetch(CloudAPI.url(CLOUD.BIN_ID),{ method:'PUT', headers: CloudAPI.headers(CLOUD.KEY), body: JSON.stringify(payload) }); if(!res.ok) throw new Error('PUT '+res.status); }catch(e){ console.warn('Cloud save error:', e); } finally{ __cloudSaving=false; } }
function saveCloudDebounced(){ clearTimeout(__saveTimer); __saveTimer=setTimeout(saveCloud, 700); }
// patch store methods to auto save to cloud
(function patchStoresForCloud(){ const a1=Store.addOrder; Store.addOrder=function(o){ const r=a1.call(Store,o); saveCloudDebounced(); return r; }; const u1=Store.updateOrder; Store.updateOrder=function(id,fn){ const r=u1.call(Store,id,fn); saveCloudDebounced(); return r; }; const sAds=Store.setAds; Store.setAds=function(arr){ sAds.call(Store,arr); saveCloudDebounced(); }; Store.setCityFeed = function(obj){ localStorage.setItem(LS_CITY_FEED, JSON.stringify(obj)); saveCloudDebounced(); }; })();

// Auto sync: periodic load from cloud + periodic save (if auto enabled)
let autoSyncInterval = null;
function setAutoSync(enabled){ if(autoSyncInterval) clearInterval(autoSyncInterval); if(enabled){ autoSyncInterval = setInterval(()=>{ if(CLOUD.ENABLED){ saveCloudDebounced(); loadCloud(); } }, 10000); } }
// hook checkbox
$('autoSyncToggle')?.addEventListener('change', (e)=>{ setAutoSync(!!e.target.checked); if(e.target.checked) alert('–ê–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞'); else alert('–ê–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞'); });
// default enable
setAutoSync(true); if($('autoSyncToggle')) $('autoSyncToggle').checked = true;

// also poll cloud for updates
setInterval(()=>{ if(CLOUD.ENABLED) loadCloud(); }, CLOUD.POLL_MS);

/* small UI helpers */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const el=$(id); if(el) el.classList.add('active'); window.scrollTo(0,0); }
function closeScreen(id){ const el=$(id); if(el) el.classList.remove('active'); }

/* initial state and rendering for city posts, chats etc (some functions referenced above) */
function renderFindList(){ /* minimal placeholder to avoid errors (can reuse previous logic if needed) */ }
function renderMineList(){}
function renderAds(){}
function renderChats(){}
function renderWallet(){}

/* page init */
function updateCityLabel(){ const c=Store.getCity()||'‚Äî'; $('topCity').textContent='–ì–æ—Ä–æ–¥: '+c; const sel=$('citySelect'); if(sel) sel.value=c||''; }
updateCityLabel();
if(!Store.getProfile()){
  // create demo profile for composer
  Store.setProfile({ id:'u_demo_user', name:'–í—ã', avatarType:'emoji', avatarData:'üôÇ' });
}
applyTheme(); applyRoleUI(); renderThemeButtons(); updateComposerIdentity(); renderCityPosts();

/* composer show/hide on scroll: hide when user scrolls down, show when scroll up */
(function composerScrollBehavior(){ const postsEl = $('cityPosts'); if(!postsEl) return; let last=postsEl.scrollTop; postsEl.addEventListener('scroll', ()=>{ const cur=postsEl.scrollTop; const c = $('cityComposerFixed'); if(!c) return; if(cur>last+8){ // scrolling down
    c.classList.remove('visible'); c.classList.add('hidden');
  } else if(cur<last-8){ // scrolling up
    c.classList.remove('hidden'); c.classList.add('visible');
  }
  last=cur;
}, {passive:true}); })();

/* welcome animation (unchanged) */
function runWelcomeSequence(){ const overlay = $('welcomeOverlay'), text = $('welcomeText'); if(!overlay || !text) return; text.style.opacity=1; text.style.transition='opacity .6s'; setTimeout(()=>{ text.style.opacity=0; }, 1200); setTimeout(()=>{ text.textContent='–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GiDCity'; text.style.opacity=1; }, 1900); setTimeout(()=>{ overlay.classList.remove('active'); overlay.style.display='none'; }, 3600); }
setTimeout(runWelcomeSequence, 400);
</script>
</body>
</html>
