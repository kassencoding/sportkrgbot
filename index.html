<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (—Å –∫–∞—Ä—Ç–æ–π)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg1:#5b2cff; --bg2:#0a0a0a; --panel:#0a0a0a; --accent:#ffd54a; --glass-bg:rgba(255,255,255,0.02); --glass-border:rgba(255,255,255,0.06);
    --text:#f2f2f2; --muted:rgba(242,242,242,0.62); --radius:12px; --gap:12px;
  }

  /* base layout */
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:linear-gradient(160deg,var(--bg1) 0%, #2b0b3a 40%, var(--bg2) 100%);color:var(--text);display:flex;align-items:center;justify-content:center;padding:12px;}
  .phone{width:380px;max-width:calc(100% - 24px);height:812px;border-radius:30px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.6);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));position:relative}
  /* header */
  .header{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;backdrop-filter: blur(6px);background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid var(--glass-border);position:relative;z-index:40}
  .title{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:50%;background:var(--glass-bg);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(91,44,255,0.12);border:1px solid var(--glass-border);overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .app-name{font-weight:900;font-size:18px;display:flex;gap:8px;align-items:center}
  .app-name small{font-weight:700;font-size:11px;color:var(--muted)}
  .header-center{display:flex;align-items:center;gap:8px}
  .calendar-btn{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);font-weight:700;cursor:pointer}
  .header-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--glass-bg);border:1px solid var(--glass-border);cursor:pointer;position:relative}
  .notif-badge{position:absolute;top:-6px;right:-6px;background:var(--accent);color:#081018;padding:4px 6px;border-radius:12px;font-weight:800;font-size:11px}

  /* content */
  .content{padding:12px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .city-block{display:flex;flex-direction:column}
  .city-name{font-weight:800;font-size:18px;margin:0}
  .city-sub{font-size:12px;color:var(--muted)}
  .center-area{display:flex;align-items:center;gap:12px}
  .weather{padding:6px 12px;border-radius:12px;background:var(--panel);border:1px solid var(--glass-border);font-weight:700}
  .status-badge{font-size:12px;color:var(--muted);padding:4px 6px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid var(--glass-border)}

  /* tabs */
  .tabs{display:flex;gap:8px;margin-top:6px}
  .tab{flex:1;padding:8px;border-radius:12px;text-align:center;background:transparent;border:1px solid var(--glass-border);cursor:pointer;color:var(--muted);font-weight:800;transition:all 180ms}
  .tab.service-active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#081018;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25);background-color:var(--accent);font-weight:900}
  .tab.work-active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#081018;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25);background-color:#4cd964; font-weight:900}

  /* main card */
  .main-card{background:var(--panel);border-radius:14px;padding:12px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:10px;flex:1;min-height:240px;overflow:hidden}
  .menu-list{flex:1;display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px}
  .menu-item{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center;min-height:62px;cursor:pointer}
  .menu-item.gidchat{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,215,74,0.16)}
  .menu-item .left{display:flex;flex-direction:column}
  .menu-item .title{font-weight:900;font-size:16px}
  .menu-item .title.gidchat{font-size:18px;letter-spacing:0.6px}
  .menu-item .caption{font-size:12px;color:var(--muted)}
  footer{padding:8px 12px;border-top:1px solid rgba(255,255,255,0.02);font-size:12px;color:var(--muted);text-align:center}

  /* map collapse */
  .map-panel{border-radius:10px;border:1px solid var(--glass-border);overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));transition:all 280ms ease;position:relative}
  .map-header{display:flex;align-items:center;gap:8px;padding:8px}
  .map-toggle{flex:1;display:flex;align-items:center;gap:8px;cursor:pointer}
  .map-actions{display:flex;gap:6px}
  .map-body{height:260px}
  #map{height:100%}
  .map-expanded{height:340px}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal{width:100%;max-width:640px;background:linear-gradient(180deg,var(--panel),#070707);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:0 30px 80px rgba(0,0,0,0.7);max-height:90vh;overflow:auto}
  .modal.fullscreen{max-width:100%;width:100%;height:100%;max-height:100%;border-radius:0;padding:18px;display:flex;flex-direction:column}
  .modal .modal-body{flex:1;overflow:auto}
  label{font-size:13px;color:var(--muted);display:block;margin:6px 0 4px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  textarea{min-height:90px}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);font-weight:800}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#ffb347);color:#081018}
  .gidchat-holo{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg, rgba(255,215,74,0.08), rgba(255,255,255,0.02));border:1px solid rgba(255,215,74,0.22);box-shadow:0 10px 40px rgba(255,215,74,0.06);font-weight:900}

  /* theme previews in settings */
  .theme-swatch{width:36px;height:24px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);display:inline-block;margin-right:8px;vertical-align:middle}

  /* responsive */
  @media(max-width:420px){.phone{width:100%;height:100vh;border-radius:0}}
</style>
</head>
<body>
<div class="phone" role="application" aria-label="GiDCity prototype">
  <!-- HEADER -->
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview">G</div>
      <div>
        <div class="app-name"><span>GiDCity</span> <small>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small></div>
      </div>
    </div>

    <!-- calendar stays in header as requested -->
    <div class="header-center">
      <button class="calendar-btn" id="calendarBtn">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    </div>

    <div class="header-actions">
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
      <div class="icon-btn" id="notifBtn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">üîî<div class="notif-badge" id="notifCount">0</div></div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="top-row">
      <div class="city-block">
        <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
        <div class="city-sub" id="citySub">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
      </div>

      <!-- center area: only weather moved here (calendar left in header) -->
      <div class="center-area">
        <div class="weather" id="weatherBlock">‚Äî ¬∞C</div>
      </div>

      <!-- right status -->
      <div class="status-badge" id="syncText">–û–Ω–ª–∞–π–Ω</div>
    </div>

    <div class="tabs">
      <div class="tab" id="tabServices">–£–°–õ–£–ì–ò</div>
      <div class="tab" id="tabWork">–†–ê–ë–û–¢–ê</div>
    </div>

    <div class="main-card" id="mainCard">
      <!-- –∫–∞—Ä—Ç–∞: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞ –∏ –≤–∏–¥–Ω–∞, –Ω–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É -->
      <div class="map-panel map-expanded" id="mapPanel" style="height:340px">
        <div class="map-header">
          <div class="map-toggle" id="mapToggle">
            <div style="font-weight:800">–ö–∞—Ä—Ç–∞ –≥–æ—Ä–æ–¥–∞</div>
            <div style="color:var(--muted);font-size:12px">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å / –∑–∞–∫—Ä—ã—Ç—å</div>
          </div>
          <div class="map-actions">
            <button class="btn" id="mapCenterBtn">–¶–µ–Ω—Ç—Ä</button>
            <button class="btn" id="mapClearBtn">–°–±—Ä–æ—Å</button>
          </div>
        </div>
        <div class="map-body" id="mapBody" style="height:260px;display:block">
          <div style="padding:8px;display:flex;gap:8px;align-items:center">
            <input id="mapSearch" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass-bg);color:var(--text)">
            <button class="btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
            <button class="btn" id="setFromBtn">A</button>
            <button class="btn" id="setToBtn">B</button>
            <button class="btn primary" id="routeBtn">–ú–∞—Ä—à—Ä—É—Ç</button>
          </div>
          <div id="map" style="height:200px;border-radius:8px;margin:8px"></div>
        </div>
      </div>

      <!-- –º–µ–Ω—é (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ) -->
      <div>
        <div class="menu-list" id="menuList"></div>
      </div>
    </div>
  </div>

  <footer id="appFooter">GiDCity ‚Ä¢ –º–∞–∫–µ—Ç ‚Äî –∫–∞—Ä—Ç–∞: OpenRouteService</footer>
</div>

<!-- –º–æ–¥–∞–ª–∫–∏ -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalWindow" role="dialog" aria-modal="true">
    <div class="modal-body" id="modalContent"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<!-- –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===========================
   GiDCity Unified Prototype ‚Äî full integrated update
   - All previous features preserved.
   - New: themes (gold/holo/neon), GIDChat fullscreen, GiD order integrated into "–ó–∞–∫–∞–∑–∞—Ç—å",
     weather moved, calendar kept, map expanded by default and fixed controls, tabs colored.
   =========================== */

/* -------------------
   Configuration
   ------------------- */
const OPENROUTESERVICE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjcyZWNiZDAxMGJlNTRjY2E4NDQwYTVlYmM2N2U1NzdkIiwiaCI6Im11cm11cjY0In0=';
const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG';
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const USE_JSONBIN = true;
const PULL_INTERVAL_MS = 15000;

/* -------------------
   State
   ------------------- */
const appStateKey = 'gidcity_state_live_v3';
let state = {
  __updatedAt: new Date(0).toISOString(),
  user: null,
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance:0},
  reminders: []
};
function loadState(){ try{ const raw=localStorage.getItem(appStateKey); if(raw) Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); } }
function localSave(){ localStorage.setItem(appStateKey, JSON.stringify(state)); }

/* JSONBin sync helpers (unchanged) */
async function syncToJSONBin(){ if(!USE_JSONBIN) return; try{
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  state.__updatedAt = new Date().toISOString();
  const payload = {state, updatedAt: state.__updatedAt};
  const resp = await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY},body:JSON.stringify(payload)});
  if(!resp.ok) throw new Error('JSONBin save failed');
  return resp.json();
}catch(e){ console.warn('sync error', e); throw e; } }
async function loadFromJSONBin(){ if(!USE_JSONBIN) return null; try{
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const resp = await fetch(url,{headers:{'X-Master-Key':JSONBIN_KEY}});
  if(!resp.ok) throw new Error('JSONBin load failed');
  const data = await resp.json(); return data;
}catch(e){ console.warn(e); return null; } }

let pullTimer = null;
async function pullAndMerge(){ if(!USE_JSONBIN) return;
  try{
    const data = await loadFromJSONBin();
    if(data && data.record && data.record.state){
      const remoteUpdated = data.updatedAt || data.record.state.__updatedAt;
      if(remoteUpdated && new Date(remoteUpdated) > new Date(state.__updatedAt || 0)){
        state = data.record.state || state; if(data.updatedAt) state.__updatedAt = data.updatedAt; localSave(); renderAll(); setSyncStatus('—Å–∏–Ω—Ö—Ä. JSONBin');
      }
    }
  }catch(e){ console.warn('pull err', e); setSyncStatus('–æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä.'); }
}
function startPeriodicPull(){ if(pullTimer) clearInterval(pullTimer); if(USE_JSONBIN) pullTimer = setInterval(pullAndMerge, PULL_INTERVAL_MS); }

/* -------------------
   UI Refs & helpers
   ------------------- */
function el(id){ return document.getElementById(id); }
function setSyncStatus(txt){ const s = el('syncText'); if(s) s.textContent = txt; }

/* -------------------
   Themes
   ------------------- */
const THEMES = {
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π':{top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a', border:'rgba(255,255,255,0.06)', glass:'rgba(255,255,255,0.02)'},
  'gold':{top:'#3b2b14', bottom:'#0b0703', accent:'#ffd54a', border:'rgba(255,215,74,0.12)', glass:'rgba(255,215,74,0.03)'},
  'holo':{top:'#06103a', bottom:'#0b0033', accent:'#7bf0ff', border:'rgba(123,240,255,0.08)', glass:'rgba(123,240,255,0.03)'},
  'neon':{top:'#001219', bottom:'#060014', accent:'#ff3bff', border:'rgba(255,59,255,0.12)', glass:'rgba(255,59,255,0.03)'}
};
function applyTheme(name){
  const t = THEMES[name] || THEMES['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  document.documentElement.style.setProperty('--bg1', t.top);
  document.documentElement.style.setProperty('--bg2', t.bottom);
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--glass-border', t.border);
  document.documentElement.style.setProperty('--glass-bg', t.glass);
  state.theme = name; localSave();
  // visual tweak: change tab accents if service/work active
  updateTabsVisual();
}

/* -------------------
   Map (expanded by default)
   ------------------- */
let map=null, fromMarker=null, toMarker=null, routeLayer=null, searchMarkers=[];
const DEFAULT_CENTER = {lat:49.8062, lon:73.0851, zoom:13};
function initMapIfNeeded(){
  if(map) return;
  try{
    map = L.map('map').setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lon], DEFAULT_CENTER.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(map);
    map.on('click', e=>{
      if(map._setMode==='from'){ setFromPoint(e.latlng); map._setMode=null; }
      else if(map._setMode==='to'){ setToPoint(e.latlng); map._setMode=null; }
    });
  }catch(e){ console.warn('map init err', e); alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ).'); }
}
function setFromPoint(latlng){ if(fromMarker) map.removeLayer(fromMarker); fromMarker = L.marker(latlng,{title:'A',draggable:true}).addTo(map).bindPopup('A ‚Äì –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ').openPopup(); fromMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); }); }
function setToPoint(latlng){ if(toMarker) map.removeLayer(toMarker); toMarker = L.marker(latlng,{title:'B',draggable:true}).addTo(map).bindPopup('B ‚Äì –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ').openPopup(); toMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); }); }
function clearRoute(){ if(fromMarker){ map.removeLayer(fromMarker); fromMarker=null; } if(toMarker){ map.removeLayer(toMarker); toMarker=null; } if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } searchMarkers.forEach(m=>map.removeLayer(m)); searchMarkers=[]; }

async function geocode(query){
  try{
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${OPENROUTESERVICE_API_KEY}&text=${encodeURIComponent(query)}&size=5`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('geocode fail '+r.status);
    const data = await r.json();
    return (data.features||[]).map(f=>({label:f.properties.label, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0], props:f.properties}));
  }catch(e){ console.warn(e); return []; }
}

async function buildRoute(fromLatLng, toLatLng){
  try{
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?start=${fromLatLng.lng},${fromLatLng.lat}&end=${toLatLng.lng},${toLatLng.lat}&api_key=${OPENROUTESERVICE_API_KEY}`;
    let resp = await fetch(url);
    if(!resp.ok){
      resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{method:'POST',headers:{'Content-Type':'application/json','Authorization':OPENROUTESERVICE_API_KEY},body:JSON.stringify({coordinates:[[fromLatLng.lng,fromLatLng.lat],[toLatLng.lng,toLatLng.lat]]})});
      if(!resp.ok) throw new Error('routing fail ' + resp.status);
      const g = await resp.json(); renderRouteGeoJSON(g); return g;
    }
    const g = await resp.json(); renderRouteGeoJSON(g); return g;
  }catch(e){ console.warn(e); alert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + (e.message||e)); }
}
function renderRouteGeoJSON(g){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.geoJSON(g,{style:{color:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ffd54a',weight:5,opacity:0.9}}).addTo(map);
  if(routeLayer && routeLayer.getBounds) map.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
}

async function doMapSearch(q){
  if(!q) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å');
  if(!map) initMapIfNeeded();
  const res = await geocode(q);
  searchMarkers.forEach(m=>map.removeLayer(m)); searchMarkers=[];
  if(!res.length){ alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  res.forEach(r=>{
    const mk = L.marker([r.lat,r.lon]).addTo(map).bindPopup(`<strong>${r.label}</strong><div style="margin-top:6px"><button onclick="window.__setFrom(${r.lat},${r.lon})">A</button> <button onclick="window.__setTo(${r.lat},${r.lon})">B</button></div>`);
    searchMarkers.push(mk);
  });
  map.fitBounds(L.featureGroup(searchMarkers).getBounds(),{padding:[20,20]});
  return res;
}
window.__setFrom = (lat,lon)=>{ setFromPoint(L.latLng(lat,lon)); };
window.__setTo = (lat,lon)=>{ setToPoint(L.latLng(lat,lon)); };

/* -------------------
   Menu & Rendering
   ------------------- */
function renderMenu(){
  const menuList = el('menuList'); menuList.innerHTML='';
  const active = el('tabServices').classList.contains('service-active') ? 'services' : 'work';
  const items = active==='services' ? [
    {id:'gid_order', title:'GiD –ó–∞–∫–∞–∑', caption:'–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ (–≤—Å—ë —á—Ç–æ —É–≥–æ–¥–Ω–æ)'},
    {id:'order', title:'–ó–∞–∫–∞–∑–∞—Ç—å', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
    {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å / –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å'},
    {id:'citychat', title:'GIDChat', caption:'–õ–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ] : [
    {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫'},
    {id:'myOffers', title:'–ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏', caption:'–û—Ç–∫–ª–∏–∫–∏'},
    {id:'reports', title:'–û—Ç—á—ë—Ç—ã', caption:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'},
    {id:'settings', title:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', caption:'–ü—Ä–æ—Ñ–∏–ª—å –∏ —Ç–µ–º—ã'}
  ];
  items.forEach(it=>{
    const elDiv = document.createElement('div'); elDiv.className='menu-item'; elDiv.dataset.id=it.id;
    // special styling for GIDChat
    if(it.id==='citychat'){ elDiv.classList.add('gidchat'); elDiv.innerHTML = `<div class="left"><div class="title gidchat">GIDChat</div><div class="caption">–ë–æ–ª—å—à–∞—è –ª–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞</div></div><div class="gidchat-holo">OPEN</div>`; }
    else elDiv.innerHTML = `<div class="left"><div class="title">${it.title}</div><div class="caption">${it.caption}</div></div><div style="opacity:0.9">‚Ä∫</div>`;
    elDiv.addEventListener('click', ()=>onMenuClick(it.id));
    menuList.appendChild(elDiv);
  });
}

/* -------------------
   Modals & Special UI
   ------------------- */
function openModal(html, actionsHtml, opts={}){
  // opts.fullscreen = true -> use fullscreen modal
  const mb = el('modalBackdrop'), mw = el('modalWindow');
  el('modalContent').innerHTML = html;
  el('modalActions').innerHTML = actionsHtml || '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>';
  if(opts.fullscreen){
    mw.classList.add('fullscreen');
  } else {
    mw.classList.remove('fullscreen');
  }
  mb.style.display='flex'; mb.setAttribute('aria-hidden','false');
  mb.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));
  mb.addEventListener('click', (e)=>{ if(e.target===mb) closeModal(); });
}
function closeModal(){ const mb = el('modalBackdrop'), mw = el('modalWindow'); mb.style.display='none'; mb.setAttribute('aria-hidden','true'); el('modalContent').innerHTML=''; el('modalActions').innerHTML=''; mw.classList.remove('fullscreen'); }

/* GiD –ó–∞–∫–∞–∑ integrated into Order modal */
function openOrderModal(preselectCategory){
  const categories = ['–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º','–ú–∞—Å—Ç–µ—Ä','GiD –ó–∞–∫–∞–∑'];
  let html = `<div class="h"><strong>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</strong></div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="ordCat">${categories.map(c=>`<option>${c}</option>`).join('')}</select><div id="ordDynamic"></div><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input id="ordBudget" type="number" value="0">`;
  const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="ordCreate">–°–æ–∑–¥–∞—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{ 
    if(preselectCategory){
      const sel = document.getElementById('ordCat');
      sel.value = preselectCategory;
    }
    populateDynamicFields(); 
    document.getElementById('ordCat').addEventListener('change', populateDynamicFields);
    document.getElementById('ordCreate').addEventListener('click', ()=>{
      const cat=document.getElementById('ordCat').value; const budget=document.getElementById('ordBudget').value; const dyn=captureDynamicFields();
      if(!dyn) return; state.servicesPosts.unshift({id:Date.now(),cat,budget,dyn,created:new Date().toISOString()}); localSave(); addNotification('–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞: '+cat); closeModal();
    });
  },50);
}
function populateDynamicFields(){
  const cat=document.getElementById('ordCat').value; const cont=el('ordDynamic'); cont.innerHTML='';
  if(cat==='–¢–∞–∫—Å–∏'){ cont.innerHTML=`<label>–û—Ç–∫—É–¥–∞</label><input id="taxFrom"><label>–ö—É–¥–∞</label><input id="taxTo"><label>–ü–∞—Å—Å–∞–∂–∏—Ä—ã</label><input id="taxPax" type="number" value="1">`; }
  else if(cat==='–ö—É—Ä—å–µ—Ä'){ cont.innerHTML=`<label>–û—Ç–∫—É–¥–∞</label><input id="curFrom"><label>–ö—É–¥–∞</label><input id="curTo"><label>–í–µ—Å/–≥–∞–±–∞—Ä–∏—Ç—ã</label><input id="curSize">`; }
  else if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º'){ cont.innerHTML=`<label>–ê–¥—Ä–µ—Å</label><input id="homeAddr"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="homeDesc"></textarea><label>–§–æ—Ç–æ</label><input id="homeFile" type="file" accept="image/*">`; document.getElementById('homeFile')?.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; cont.dataset.file=await fileToBase64(f); }); }
  else if(cat==='–ú–∞—Å—Ç–µ—Ä'){ cont.innerHTML=`<label>–ê–¥—Ä–µ—Å</label><input id="mAddr"><label>–í–∏–¥ —Ä–∞–±–æ—Ç</label><input id="mType"><label>–í—Ä–µ–º—è</label><input id="mTime" type="time">`; }
  else { /* GiD –ó–∞–∫–∞–∑ - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ —É—Å–ª—É–≥ */ cont.innerHTML=`<label>–¢–∏–ø —É—Å–ª—É–≥–∏</label><select id="gidType"><option>–õ—é–±–∞—è</option><option>–ü–æ–∫—É–ø–∫–∞</option><option>–î–æ—Å—Ç–∞–≤–∫–∞</option><option>–ü–æ–º–æ—â—å</option><option>–ú–∞—Å—Ç–µ—Ä</option></select><label>–ö—Ä–∏—Ç–µ—Ä–∏–∏ / –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</label><input id="gidCriteria" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ä–æ—á–Ω–æ, –±—é–¥–∂–µ—Ç –¥–æ 5000..."><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="gDesc"></textarea><label>–ê–¥—Ä–µ—Å</label><input id="gAddr">`; }
}
function captureDynamicFields(){
  const cat=document.getElementById('ordCat').value;
  if(cat==='–¢–∞–∫—Å–∏'){ const f=document.getElementById('taxFrom').value.trim(), t=document.getElementById('taxTo').value.trim(); if(!f||!t){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å–∞');return null;} return {from:f,to:t,pax:document.getElementById('taxPax').value}; }
  if(cat==='–ö—É—Ä—å–µ—Ä'){ const f=document.getElementById('curFrom').value.trim(), t=document.getElementById('curTo').value.trim(); if(!f||!t){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å–∞');return null;} return {from:f,to:t,size:document.getElementById('curSize').value}; }
  if(cat==='–ö–≤–∞—Ä—Ç–∏—Ä–∞/–î–æ–º'){ const a=document.getElementById('homeAddr').value.trim(), d=document.getElementById('homeDesc').value.trim(); if(!a||!d){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –æ–ø–∏—Å–∞–Ω–∏–µ');return null;} return {addr:a,desc:d,file:el('ordDynamic').dataset.file||null}; }
  if(cat==='–ú–∞—Å—Ç–µ—Ä'){ const a=document.getElementById('mAddr').value.trim(), ty=document.getElementById('mType').value.trim(); if(!a||!ty){alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –≤–∏–¥ —Ä–∞–±–æ—Ç');return null;} return {addr:a,type:ty,time:document.getElementById('mTime').value}; }
  const d=document.getElementById('gDesc') ? document.getElementById('gDesc').value.trim() : ''; const a=document.getElementById('gAddr') ? document.getElementById('gAddr').value.trim() : '';
  if(cat==='GiD –ó–∞–∫–∞–∑'){ const type=document.getElementById('gidType').value, crit=document.getElementById('gidCriteria').value.trim(); if(!d||!a){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');return null;} return {type,criteria:crit,desc:d,addr:a}; }
  if(!d||!a){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');return null;} return {desc:d,addr:a};
}

/* Ads */
function openAdsModal(){ const html=`<div class="h"><strong>–û–±—ä—è–≤–ª–µ–Ω–∏–µ</strong></div><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="adTitle"><label>–¢–µ–∫—Å—Ç</label><textarea id="adText"></textarea>`; const actions = '<button class="btn" data-close>–û—Ç–º–µ–Ω–∞</button><button class="btn primary" id="publishAd">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>'; openModal(html, actions); setTimeout(()=>{ document.getElementById('publishAd').addEventListener('click', ()=>{ const t=el('adTitle').value.trim(), txt=el('adText').value.trim(); if(!t||!txt) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ'); state.cityPosts.unshift({id:Date.now(),title:t,text:txt,created:new Date().toISOString()}); localSave(); addNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'); closeModal(); }); },50); }

/* City chat / GIDChat fullscreen */
function openGIDChatFull(){
  // fullscreen modal with big feed
  const postsHtml = (state.cityPosts||[]).map(p=>`<div style="padding:12px;border-bottom:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);margin-bottom:8px;border-radius:8px"><div style="font-weight:900">${p.title||'–ü–æ—Å—Ç'}</div><div class="small" style="color:var(--muted)">${new Date(p.created).toLocaleString()}</div><div style="margin-top:8px">${p.text||''}</div></div>`).join('')||'<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
  const html = `<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px"><div style="font-weight:900;font-size:20px">GIDChat ‚Äî ${state.city}</div><div style="display:flex;gap:8px"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="newPostBtn">+ –ü–æ—Å—Ç</button></div></div><div style="flex:1;overflow:auto">${postsHtml}</div>`;
  openModal(html, '', {fullscreen:true});
  setTimeout(()=>{ el('newPostBtn')?.addEventListener('click', ()=>{ openAdsModal(); }); },50);
}

/* Messenger & Wallet (preserved) */
function openMessenger(){ openModal('<div class="h"><strong>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</strong></div><div class="small">–°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ (–¥–µ–º–æ)</div>','<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>'); }
function openWallet(){ const html=`<div class="h"><strong>–ö–æ—à–µ–ª—ë–∫</strong></div><div style="font-size:24px;font-weight:900">${state.wallet.balance||0} ‚Ç∏</div>`; openModal(html,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>'); }

/* Settings with theme selection (added futures) */
function openSettingsModal(forceOpen){
  const cities = ['–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','–ù—É—Ä-–°—É–ª—Ç–∞–Ω','–ê–ª–º–∞—Ç—ã'];
  const themes = Object.keys(THEMES);
  const html = `<div class="h" style="display:flex;justify-content:space-between;align-items:center"><strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong><div style="font-size:12px;color:var(--muted)">–¢–µ–º–∞: <strong>${state.theme}</strong></div></div>
    <label>–ê–≤–∞—Ç–∞—Ä</label><button class="btn" id="uploadAvatar">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button><img id="avatarPreviewSmall" src="" style="width:44px;height:44px;border-radius:8px;margin-left:8px;vertical-align:middle">
    <label>–ò–º—è</label><input id="profileName"><label>–§–∞–º–∏–ª–∏—è</label><input id="profileSurname"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="profilePhone"><label>–ì–æ—Ä–æ–¥</label><select id="citySelect">${cities.map(c=>`<option>${c}</option>`).join('')}</select>
    <label>–¢–µ–º–∞</label><select id="themeSelect">${themes.map(t=>`<option>${t}</option>`).join('')}</select>
    <div style="margin-top:8px"><span class="theme-swatch" id="sw1" style="background:linear-gradient(90deg,#5b2cff,#2b0b3a)"></span><span class="theme-swatch" id="sw2" style="background:linear-gradient(90deg,#3b2b14,#0b0703)"></span><span class="theme-swatch" id="sw3" style="background:linear-gradient(90deg,#06103a,#0b0033)"></span><span class="theme-swatch" id="sw4" style="background:linear-gradient(90deg,#001219,#060014)"></span> ‚Äî –ø—Ä–∏–º–µ—Ä—ã —Ç–µ–º</div>
  `;
  const actions = '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
  openModal(html, actions);
  setTimeout(()=>{
    document.getElementById('profileName').value = state.user ? (state.user.name||'') : '';
    document.getElementById('profileSurname').value = state.user ? (state.user.surname||'') : '';
    document.getElementById('profilePhone').value = state.user ? (state.user.phone||'') : '';
    document.getElementById('avatarPreviewSmall').src = state.user && state.user.avatar ? state.user.avatar : 'https://via.placeholder.com/44/333333/fff?text=U';
    document.getElementById('uploadAvatar').addEventListener('click', ()=>{ const f=document.createElement('input'); f.type='file'; f.accept='image/*'; f.onchange=async e=>{ const file=e.target.files[0]; if(!file) return; const b=await fileToBase64(file); document.getElementById('avatarPreviewSmall').src=b; document.getElementById('avatarPreviewSmall').dataset.b64=b; }; f.click(); });
    document.getElementById('saveSettings').addEventListener('click', ()=>{
      const name=el('profileName').value.trim(), surname=el('profileSurname').value.trim();
      if(!name||!surname){ alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'); return; }
      state.user = state.user||{};
      state.user.name = name; state.user.surname = surname; state.user.phone = el('profilePhone').value.trim();
      const b64 = document.getElementById('avatarPreviewSmall').dataset ? document.getElementById('avatarPreviewSmall').dataset.b64 : null;
      if(b64) state.user.avatar = b64;
      state.city = el('citySelect').value;
      const chosenTheme = el('themeSelect').value || state.theme;
      applyTheme(chosenTheme); localSave(); closeModal(); renderAll();
    });
  },50);
}

/* Auth */
function openAuthModal(){
  const html=`<div class="h"><strong>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</strong></div><label>–ò–º—è</label><input id="authName"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="authPhone"><label>PIN (4 —Ü–∏—Ñ—Ä—ã)</label><input id="authPIN" maxlength="4">`;
  const actions = '<button class="btn" data-close>–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button><button class="btn primary" id="authSubmit">–í–æ–π—Ç–∏</button>';
  openModal(html, actions);
  setTimeout(()=>{ document.getElementById('authSubmit').addEventListener('click', ()=>{ const name=el('authName').value.trim(); const phone=el('authPhone').value.trim(); const pin=el('authPIN').value.trim(); if(!name||!phone||!/^\d{4}$/.test(pin)){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'); return; } state.user = state.user||{}; state.user.name=name; state.user.phone=phone; state.user.pin=pin; localSave(); addNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª: '+name); closeModal(); renderAll(); }); },50);
}

/* Notifications & helper */
function addNotification(text, meta={}){
  state.notifications.unshift({id:Date.now(), text, meta, ts:new Date().toISOString()}); localSave(); updateNotifCount();
}
function updateNotifCount(){ el('notifCount').textContent = state.notifications.length || 0; }

/* City posts feed modal (smaller) */
function openCityChatModal(){
  const postsHtml = (state.cityPosts||[]).map(p=>`<div style="padding:8px;border-bottom:1px solid var(--glass-border)"><div style="font-weight:800">${p.title||'–ü–æ—Å—Ç'}</div><div class="small">${new Date(p.created).toLocaleString()}</div><div style="margin-top:6px">${p.text||''}</div></div>`).join('')||'<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
  openModal(`<div class="h"><strong>City —á–∞—Ç ‚Äî ${state.city}</strong></div><div style="max-height:320px;overflow:auto">${postsHtml}</div>`,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>');
}

/* helpers */
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* -------------------
   Menu click router
   ------------------- */
function onMenuClick(id){
  if(id==='gid_order'){ openOrderModal('GiD –ó–∞–∫–∞–∑'); } // integrated: preselect GiD
  else if(id==='order') openOrderModal();
  else if(id==='ads') openAdsModal();
  else if(id==='citychat') openGIDChatFull();
  else if(id==='messenger') openMessenger();
  else if(id==='wallet') openWallet();
  else if(id==='findJobs') alert('–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ ‚Äî –¥–µ–º–æ');
  else if(id==='settings') openSettingsModal();
  else alert('–ù–∞–∂–∞—Ç–∞: '+id);
}

/* -------------------
   Render & misc
   ------------------- */
function renderAll(){
  el('cityName').textContent = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞';
  updateNotifCount();
  renderMenu();
  applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π');
  fetchWeather();
  // avatar preview
  if(state.user && state.user.avatar) el('avatarPreview').innerHTML = `<img src="${state.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
  setSyncStatus('–û–Ω–ª–∞–π–Ω');
  // ensure map visible
  setTimeout(()=>{ initMapIfNeeded(); if(map) map.invalidateSize(); },300);
}

/* -------------------
   Weather
   ------------------- */
async function fetchWeather(){
  try{
    const coords = {lat:49.8062,lon:73.0851};
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fail');
    const d = await r.json();
    if(d && d.current_weather) el('weatherBlock').textContent = `${Math.round(d.current_weather.temperature)} ¬∞C`;
  }catch(e){ el('weatherBlock').textContent='‚Äî ¬∞C'; }
}

/* -------------------
   Tabs visual update + events
   ------------------- */
function updateTabsVisual(){
  const s = el('tabServices'), w = el('tabWork');
  // remove all classes
  s.className = 'tab'; w.className = 'tab';
  // determine which is active by dataset (we use class on click handlers)
  if(s.dataset.active === '1') { s.classList.add('service-active'); }
  if(w.dataset.active === '1') { w.classList.add('work-active'); }
}
document.addEventListener('DOMContentLoaded', async ()=>{
  loadState();
  // default: services active
  el('tabServices').dataset.active = '1';
  renderAll();

  // JSONBin load
  if(USE_JSONBIN){
    try{
      const data = await loadFromJSONBin();
      if(data && data.record && data.record.state){ state = data.record.state; if(data.updatedAt) state.__updatedAt = data.updatedAt; localSave(); }
    }catch(e){ console.warn(e); }
  }
  startPeriodicPull();

  // UI bindings
  el('tabServices').addEventListener('click', ()=>{ el('tabServices').dataset.active='1'; el('tabWork').dataset.active='0'; updateTabsVisual(); renderMenu(); });
  el('tabWork').addEventListener('click', ()=>{ el('tabWork').dataset.active='1'; el('tabServices').dataset.active='0'; updateTabsVisual(); renderMenu(); });
  el('settingsBtn').addEventListener('click', ()=>openSettingsModal());
  el('calendarBtn').addEventListener('click', ()=>openCalendar());
  el('notifBtn').addEventListener('click', ()=>{ openNotifications(); });

  // map toggle
  const mapToggle = el('mapToggle');
  mapToggle.addEventListener('click', ()=>{
    const body = el('mapBody'), panel = el('mapPanel');
    if(body.style.display==='none' || body.style.display==='') {
      body.style.display='block'; panel.classList.add('map-expanded'); panel.style.height='340px';
      setTimeout(()=>{ initMapIfNeeded(); if(map) map.invalidateSize(); },200);
    } else {
      body.style.display='none'; panel.classList.remove('map-expanded'); panel.style.height='56px';
    }
  });

  // map controls
  el('searchBtn').addEventListener('click', ()=>{ const q=el('mapSearch').value.trim(); if(!q) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å'); initMapIfNeeded(); doMapSearch(q); });
  el('setFromBtn').addEventListener('click', ()=>{ initMapIfNeeded(); map._setMode='from'; alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (A)'); });
  el('setToBtn').addEventListener('click', ()=>{ initMapIfNeeded(); map._setMode='to'; alert('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (B)'); });
  el('routeBtn').addEventListener('click', ()=>{ if(!fromMarker||!toMarker) return alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫–∏ A –∏ B'); buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); });
  el('mapClearBtn').addEventListener('click', ()=>{ clearRoute(); });
  el('mapCenterBtn').addEventListener('click', ()=>{ if(!map) initMapIfNeeded(); map.setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lon], DEFAULT_CENTER.zoom); });

  // initial menu
  renderMenu();

  // auth if no user
  if(!state.user) setTimeout(()=>openAuthModal(), 600);
});

/* Calendar modal */
function openCalendar(){
  const html = `<div class="h"><strong>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</strong></div><label>–î–∞—Ç–∞</label><input type="date" id="calDate" value="${new Date().toISOString().slice(0,10)}"><label>–í—Ä–µ–º—è</label><input type="time" id="calTime" value="12:00"><label>–ó–∞–º–µ—Ç–∫–∞</label><input id="calNote"><div class="small">–î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ—è–≤–∏—Ç—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö.</div>`;
  openModal(html,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="addRem">–î–æ–±–∞–≤–∏—Ç—å</button>');
  setTimeout(()=>{ el('addRem').addEventListener('click', ()=>{ const d=el('calDate').value, t=el('calTime').value, n=el('calNote').value; if(!d||!t) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'); state.notifications.unshift({id:Date.now(),text:`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${n||'–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}`,ts:new Date(d+'T'+t+':00').toISOString()}); localSave(); updateNotifCount(); closeModal(); }); },50);
}

/* Notifications list */
function openNotifications(){
  const listHtml = (state.notifications||[]).map(n=>`<div style="padding:8px;border-bottom:1px solid var(--glass-border)"><div class="small">${new Date(n.ts).toLocaleString()}</div><div style="margin-top:6px">${n.text}</div></div>`).join('')||'<div class="small">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  openModal(`<div class="h"><strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong></div><div style="max-height:360px;overflow:auto">${listHtml}</div>`,'<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button>');
  setTimeout(()=>{ el('clearNotifs').addEventListener('click', ()=>{ state.notifications=[]; localSave(); updateNotifCount(); closeModal(); }); },50);
}

/* helpers */
function updateNotifCount(){ el('notifCount').textContent = state.notifications.length || 0; }

</script>
</body>
</html>