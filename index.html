<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (—Å –∫–∞—Ä—Ç–æ–π)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg1:#5b2cff; --bg2:#0a0a0a; --panel:#0a0a0a; --accent:#ffd54a; --glass-bg:rgba(255,255,255,0.02); --glass-border:rgba(255,255,255,0.06);
    --text:#f2f2f2; --muted:rgba(242,242,242,0.62); --radius:12px; --gap:12px;
  }

  /* base layout */
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:linear-gradient(160deg,var(--bg1) 0%, #2b0b3a 40%, var(--bg2) 100%);color:var(--text);display:flex;align-items:center;justify-content:center;padding:12px;}
  /* –£–í–ï–õ–ò–ß–ò–õ –®–ò–†–ò–ù–£ "—Ç–µ–ª–µ—Ñ–æ–Ω–∞" —á—Ç–æ–±—ã –ø–∞–Ω–µ–ª—å –±—ã–ª–∞ —à–∏—Ä–µ */
  .phone{width:400px;max-width:calc(100% - 24px);height:812px;border-radius:30px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.6);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));position:relative}
  /* header */
  .header{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;backdrop-filter: blur(6px);background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid var(--glass-border);position:relative;z-index:40}
  .title{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:50%;background:var(--glass-bg);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(91,44,255,0.12);border:1px solid var(--glass-border);overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .app-name{font-weight:900;font-size:18px;display:flex;gap:8px;align-items:center}
  .app-name small{font-weight:700;font-size:11px;color:var(--muted);display:none} /* —Å–ª–æ–≤–æ "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" —Å–∫—Ä—ã—Ç–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é */
  .header-center{display:flex;align-items:center;gap:8px}
  .calendar-btn{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);font-weight:700;cursor:pointer}
  .header-actions{display:flex;gap:8px;align-items:center; margin-right:6px;} /* —á—É—Ç—å –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É (—É–º–µ–Ω—å—à–∏–ª –ø—Ä–∞–≤—ã–π –æ—Ç—Å—Ç—É–ø) */
  .icon-btn{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--glass-bg);border:1px solid var(--glass-border);cursor:pointer;position:relative}
  .notif-badge{position:absolute;top:-6px;right:-6px;background:var(--accent);color:#081018;padding:4px 6px;border-radius:12px;font-weight:800;font-size:11px}

  /* content */
  .content{padding:12px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}
  /* –¥–µ–ª–∞–µ–º .top-row –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≥–æ–¥—É –∞–±—Å–æ–ª—é—Ç–æ–º */
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:8px;position:relative}
  .city-block{display:flex;flex-direction:column}
  .city-name{font-weight:800;font-size:18px;margin:0;color:var(--text)}
  .city-sub{font-size:12px;color:var(--muted)}
  /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º center-area —á–µ—Ä–µ–∑ absolute -> —Ç–æ—á–Ω–æ –ø–æ —Å–µ—Ä–µ–¥–∏–Ω–µ */
  .center-area{display:flex;align-items:center;gap:8px;position:absolute;left:50%;transform:translateX(-50%);top:50%;transform-origin:center;translate: none;}
  /* –∏—Å–ø—Ä–∞–≤–ª—è–µ–º transform: –¥–≤–∞ —Å–≤–æ–π—Å—Ç–≤–∞ —Ä–∞–Ω–µ–µ ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ–º; —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º translateX only, —É–±–∏—Ä–∞–µ–º translateY */
  .center-area{position:absolute;left:50%;transform:translateX(-50%);top:50%;transform-origin:center; margin-top:-10px;}
  .weather{padding:6px 12px;border-radius:12px;background:var(--panel);border:1px solid var(--glass-border);font-weight:700;display:flex;align-items:center;gap:8px;color:var(--text)}
  .status-badge{font-size:12px;color:var(--muted);padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.01);border:1px solid var(--glass-border);cursor:pointer;min-width:70px;text-align:center} /* –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */

  /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û–Ω–ª–∞–π–Ω" –≤–∏–∑—É–∞–ª—å–Ω–æ (–Ω–µ —É–¥–∞–ª—è—è —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –∫–æ–¥–∞) */
  #onlineBtn{display:none !important;visibility:hidden;}

  /* tabs */
  .tabs{display:flex;gap:8px;margin-top:6px}
  .tab{flex:1;padding:8px;border-radius:12px;text-align:center;background:transparent;border:1px solid var(--glass-border);cursor:pointer;color:var(--muted);font-weight:800;transition:all 180ms}
  .tab.service-active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#081018;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25);background-color:var(--accent);font-weight:900}
  .tab.work-active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#081018;box-shadow:inset 0 -6px 0 rgba(0,0,0,0.25);background-color:#4cd964; font-weight:900}

  /* main card */
  .main-card{background:var(--panel);border-radius:14px;padding:12px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:10px;flex:1;min-height:240px;overflow:hidden}
  .menu-list{flex:1;display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px}
  .menu-item{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center;min-height:62px;cursor:pointer}
  .menu-item.gidchat{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,215,74,0.16)}
  .menu-item .left{display:flex;flex-direction:column}
  /* –°–¥–µ–ª–∞–ª —à—Ä–∏—Ñ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–∏ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é –º–µ–Ω—å—à–µ */
  .menu-item .title{font-weight:900;font-size:14px;color:var(--text)}
  .menu-item .title.gidchat{font-size:15px;letter-spacing:0.4px}
  .menu-item .caption{font-size:11px;color:var(--muted)}
  footer{padding:8px 12px;border-top:1px solid rgba(255,255,255,0.02);font-size:12px;color:var(--muted);text-align:center}

  /* map collapse */
  .map-panel{border-radius:10px;border:1px solid var(--glass-border);overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));transition:all 280ms ease;position:relative}
  .map-header{display:flex;align-items:center;gap:8px;padding:8px}
  .map-toggle{flex:1;display:flex;align-items:center;gap:8px;cursor:pointer}
  .map-actions{display:flex;gap:6px}
  .map-body{height:260px}
  #map{height:100%}
  .map-expanded{height:340px}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal{width:100%;max-width:640px;background:linear-gradient(180deg,var(--panel),#070707);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:0 30px 80px rgba(0,0,0,0.7);max-height:90vh;overflow:auto}
  .modal.fullscreen{max-width:100%;width:100%;height:100%;max-height:100%;border-radius:0;padding:18px;display:flex;flex-direction:column}
  .modal .modal-body{flex:1;overflow:auto}
  label{font-size:13px;color:var(--muted);display:block;margin:6px 0 4px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  textarea{min-height:90px}
  .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);font-weight:800;font-size:13px} /* —É–º–µ–Ω—å—à–∏–ª —à—Ä–∏—Ñ—Ç –∫–Ω–æ–ø–æ–∫ */
  .btn.primary{background:linear-gradient(90deg,var(--accent),#ffb347);color:#081018}
  .gidchat-holo{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg, rgba(255,215,74,0.08), rgba(255,255,255,0.02));border:1px solid rgba(255,215,74,0.22);box-shadow:0 10px 40px rgba(255,215,74,0.06);font-weight:900}

  /* theme previews in settings */
  .theme-swatch{width:36px;height:24px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);display:inline-block;margin-right:8px;vertical-align:middle}

  /* responsive */
  @media(max-width:420px){.phone{width:100%;height:100vh;border-radius:0}}
</style>
</head>
<body>
<div class="phone" role="application" aria-label="GiDCity prototype">
  <!-- HEADER -->
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview">G</div>
      <div>
        <div class="app-name"><span>GiDCity</span> <small>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small></div>
      </div>
    </div>

    <!-- calendar stays in header as requested -->
    <div class="header-center">
      <button class="calendar-btn" id="calendarBtn">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    </div>

    <div class="header-actions">
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="settings">‚öôÔ∏è</div>
      <!-- –í–µ—Ä—Ö–Ω—è—è –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É–±—Ä–∞–Ω–∞ (—Å–∫—Ä—ã—Ç–∞) —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É -->
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="top-row">
      <div class="city-block">
        <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
        <div class="city-sub" id="citySub">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
      </div>

      <!-- center area: –ø–æ–≥–æ–¥–∞ —Ä–æ–≤–Ω–æ –ø–æ —Å–µ—Ä–µ–¥–∏–Ω–µ -->
      <div class="center-area">
        <div class="weather" id="weatherBlock">‚Äî ¬∞C</div>

        <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä—è–¥–æ–º —Å –ø–æ–≥–æ–¥–æ–π (—Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–≥–æ–¥—ã) -->
        <div class="icon-btn" id="weatherNotifBtn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" aria-label="notifications">üîî<div class="notif-badge" id="weatherNotifCount">0</div></div>
      </div>

      <!-- right status as rectangular button (was "–û–Ω–ª–∞–π–Ω") -->
      <div class="status-badge" id="onlineBtn" role="button" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞">–û–Ω–ª–∞–π–Ω</div>
    </div>

    <div class="tabs">
      <div class="tab" id="tabServices">–£–°–õ–£–ì–ò</div>
      <div class="tab" id="tabWork">–†–ê–ë–û–¢–ê</div>
    </div>

    <div class="main-card" id="mainCard">
      <!-- –∫–∞—Ä—Ç–∞ —Ç–µ–ø–µ—Ä—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–æ–π.
           –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª: –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "—Ä–∞–±–æ—Ç–∞" –∫–∞—Ä—Ç–∞ ‚Äî –∫–Ω–æ–ø–∫–∞, –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è –º–æ–¥–∞–ª–∫—É —Å –∫–∞—Ä—Ç–æ–π.
           –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É" -->
      <div class="map-panel map-expanded" id="mapPanel" style="height:120px;overflow:hidden">
        <div class="map-header">
          <div class="map-toggle" id="mapToggle">
            <div style="font-weight:800">–ö–∞—Ä—Ç–∞ –≥–æ—Ä–æ–¥–∞</div>
            <div style="color:var(--muted);font-size:12px">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –≤ –º–æ–¥–∞–ª–∫–µ</div>
          </div>
          <div class="map-actions">
            <button class="btn" id="openMapModalBtn">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
          </div>
        </div>
        <div style="padding:8px;color:var(--muted);font-size:13px">–ö–ª–∏–∫–Ω–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É¬ª ‚Äî –º–∞—Ä—à—Ä—É—Ç –º–æ–∂–Ω–æ –ø—Ä–æ–ª–æ–∂–∏—Ç—å –≤ –º–æ–¥–∞–ª–∫–µ.</div>
      </div>

      <!-- –º–µ–Ω—é (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ) -->
      <div>
        <div class="menu-list" id="menuList"></div>
      </div>
    </div>
  </div>

  <footer id="appFooter">GiDCity ‚Ä¢ –º–∞–∫–µ—Ç ‚Äî –∫–∞—Ä—Ç–∞: OpenRouteService</footer>
</div>

<!-- –º–æ–¥–∞–ª–∫–∏ -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalWindow" role="dialog" aria-modal="true">
    <div class="modal-body" id="modalContent"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<!-- –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===========================
   GiDCity Unified Prototype ‚Äî updated per user's requests
   - –í–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è:
     * –®–∏—Ä–µ –ø–∞–Ω–µ–ª—å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
     * –ü–æ–≥–æ–¥–∞ —Ä–æ–≤–Ω–æ –ø–æ —Å–µ—Ä–µ–¥–∏–Ω–µ
     * –¢–µ–º—ã: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–º —Ç–µ–∫—Å—Ç–∞ –∏ muted –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
   =========================== */

/* -------------------
   Configuration (unchanged keys)
   ------------------- */
const OPENROUTESERVICE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjcyZWNiZDAxMGJlNTRjY2E4NDQwYTVlYmM2N2U1NzdkIiwiaCI6Im11cm11cjY0In0=';
const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG';
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const USE_JSONBIN = true;
const PULL_INTERVAL_MS = 15000;

/* -------------------
   State
   ------------------- */
const appStateKey = 'gidcity_state_live_v3';
let state = {
  __updatedAt: new Date(0).toISOString(),
  user: null,
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance:0},
  reminders: []
};
function loadState(){ try{ const raw=localStorage.getItem(appStateKey); if(raw) Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); } }
function localSave(){ localStorage.setItem(appStateKey, JSON.stringify(state)); }

/* JSONBin sync helpers (unchanged) */
async function syncToJSONBin(){ if(!USE_JSONBIN) return; try{
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  state.__updatedAt = new Date().toISOString();
  const payload = {state, updatedAt: state.__updatedAt};
  const resp = await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY},body:JSON.stringify(payload)});
  if(!resp.ok) throw new Error('JSONBin save failed');
  return resp.json();
}catch(e){ console.warn('sync error', e); throw e; } }
async function loadFromJSONBin(){ if(!USE_JSONBIN) return null; try{
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const resp = await fetch(url,{headers:{'X-Master-Key':JSONBIN_KEY}});
  if(!resp.ok) throw new Error('JSONBin load failed');
  const data = await resp.json(); return data;
}catch(e){ console.warn(e); return null; } }

let pullTimer = null;
async function pullAndMerge(){ if(!USE_JSONBIN) return;
  try{
    const data = await loadFromJSONBin();
    if(data && data.record && data.record.state){
      const remoteUpdated = data.updatedAt || data.record.state.__updatedAt;
      if(remoteUpdated && new Date(remoteUpdated) > new Date(state.__updatedAt || 0)){
        state = data.record.state || state; if(data.updatedAt) state.__updatedAt = data.updatedAt; localSave(); renderAll(); setSyncStatus('—Å–∏–Ω—Ö—Ä. JSONBin');
      }
    }
  }catch(e){ console.warn('pull err', e); setSyncStatus('–æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä.'); }
}
function startPeriodicPull(){ if(pullTimer) clearInterval(pullTimer); if(USE_JSONBIN) pullTimer = setInterval(pullAndMerge, PULL_INTERVAL_MS); }

/* -------------------
   UI Refs & helpers
   ------------------- */
function el(id){ return document.getElementById(id); }
function setSyncStatus(txt){ const s = el('onlineBtn'); if(s) s.textContent = txt; }

/* -------------------
   Themes ‚Äî —Ä–∞—Å—à–∏—Ä–∏–ª —Å–ø–∏—Å–æ–∫ (—Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–Ω—ã–µ, —Å–≤–µ—Ç–ª—ã–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã)
   –¢–µ–ø–µ—Ä—å applyTheme –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç --text –∏ --muted.
   ------------------- */
const THEMES = {
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π':{top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a', border:'rgba(255,255,255,0.06)', glass:'rgba(255,255,255,0.02)'},
  'gold':{top:'#3b2b14', bottom:'#0b0703', accent:'#ffd54a', border:'rgba(255,215,74,0.12)', glass:'rgba(255,215,74,0.03)'},
  'holo':{top:'#06103a', bottom:'#0b0033', accent:'#7bf0ff', border:'rgba(123,240,255,0.08)', glass:'rgba(123,240,255,0.03)'},
  'neon':{top:'#001219', bottom:'#060014', accent:'#ff3bff', border:'rgba(255,59,255,0.12)', glass:'rgba(255,59,255,0.03)'},
  'sunset':{top:'#ff7a59', bottom:'#2b0b3a', accent:'#ffd54a', border:'rgba(255,122,89,0.12)', glass:'rgba(255,122,89,0.03)'},
  'forest':{top:'#0b5d3a', bottom:'#02120a', accent:'#7fffd4', border:'rgba(127,255,212,0.08)', glass:'rgba(127,255,212,0.03)'},
  /* –ù–æ–≤—ã–µ —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Å–≤–µ—Ç–ª—ã–µ —Ç–µ–º—ã */
  'futuristic-neon':{top:'linear-gradient(90deg,#0f172a,#0b1020)', bottom:'#03030a', accent:'#00ffd5', border:'rgba(0,255,213,0.10)', glass:'rgba(0,255,213,0.03)'},
  'futuristic-light':{top:'linear-gradient(90deg,#f5f7ff,#e6f0ff)', bottom:'#ffffff', accent:'#6b8cff', border:'rgba(40,80,200,0.08)', glass:'rgba(40,80,200,0.04)', textDark:'#071133'},
  'cyber-sky':{top:'linear-gradient(90deg,#a1c4fd,#c2e9fb)', bottom:'#eaf6ff', accent:'#1a73e8', border:'rgba(26,115,232,0.08)', glass:'rgba(26,115,232,0.03)', textDark:'#05264b'},
  'sunrise-pastel':{top:'linear-gradient(90deg,#fff1e0,#ffeef8)', bottom:'#fff8f2', accent:'#ff8fa3', border:'rgba(255,143,163,0.08)', glass:'rgba(255,143,163,0.03)', textDark:'#2b1f2b'},
  'glass-light':{top:'linear-gradient(90deg,#ffffff,#f0f8ff)', bottom:'#ffffff', accent:'#7cc0ff', border:'rgba(124,192,255,0.08)', glass:'rgba(124,192,255,0.06)', textDark:'#042345'}
};
function applyTheme(name){
  const t = THEMES[name] || THEMES['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  // top/bottom –º–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞–º–∏-–≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ –∏–ª–∏ —Ü–≤–µ—Ç–∞–º–∏
  if(t.top) document.documentElement.style.setProperty('--bg1', t.top);
  if(t.bottom) document.documentElement.style.setProperty('--bg2', t.bottom);
  if(t.accent) document.documentElement.style.setProperty('--accent', t.accent);
  if(t.border) document.documentElement.style.setProperty('--glass-border', t.border);
  if(t.glass) document.documentElement.style.setProperty('--glass-bg', t.glass);
  // –£–ø—Ä–∞–≤–ª—è–µ–º —á–∏—Ç–∞–µ–º–æ—Å—Ç—å—é: –µ—Å–ª–∏ —Ç–µ–º–∞ –∑–∞–¥–∞—ë—Ç textDark (—Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ,
  // –∏–Ω–∞—á–µ —Å—Ç–∞–≤–∏–º –±–µ–ª—ã–π (#f2f2f2) –¥–ª—è —Ç—ë–º–Ω—ã—Ö —Ç–µ–º.
  if(t.textDark){
    document.documentElement.style.setProperty('--text', t.textDark);
    // muted ‚Äî —Ç–æ—Ç –∂–µ —Ü–≤–µ—Ç —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
    document.documentElement.style.setProperty('--muted', hexToRgba(t.textDark, 0.62));
  } else {
    document.documentElement.style.setProperty('--text', '#f2f2f2');
    document.documentElement.style.setProperty('--muted', 'rgba(242,242,242,0.62)');
  }
  state.theme = name; localSave();
  updateTabsVisual();
}
/* helper: –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç hex (#rrggbb) –≤ rgba(r,g,b,a) ‚Äî –µ—Å–ª–∏ –≤—Ö–æ–¥ –Ω–µ hex, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª —Å alpha –ø–æ–ø—ã—Ç–∫–æ–π */
function hexToRgba(hex, alpha){
  if(!hex) return `rgba(0,0,0,${alpha})`;
  // –µ—Å–ª–∏ —É–∂–µ rgba/hsla ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
  if(hex.startsWith('rgba') || hex.startsWith('rgb') || hex.startsWith('linear-gradient')) return hex;
  let c = hex.replace('#','');
  if(c.length===3) c = c.split('').map(ch=>ch+ch).join('');
  if(c.length!==6) return hex;
  const r = parseInt(c.slice(0,2),16), g = parseInt(c.slice(2,4),16), b = parseInt(c.slice(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* -------------------
   Map (modal version; –æ—Å–Ω–æ–≤–Ω–æ–π map –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–∞–Ω–µ–ª–∏)
   ------------------- */
let map=null, fromMarker=null, toMarker=null, routeLayer=null, searchMarkers=[];
let modalMap = null, modalFrom=null, modalTo=null, modalRouteLayer=null;
const DEFAULT_CENTER = {lat:49.8062, lon:73.0851, zoom:13};

function initMapIfNeeded(){
  if(map) return;
  try{
    map = L.map('map').setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lon], DEFAULT_CENTER.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(map);
    map.on('click', e=>{
      if(map._setMode==='from'){ setFromPoint(e.latlng); map._setMode=null; }
      else if(map._setMode==='to'){ setToPoint(e.latlng); map._setMode=null; }
    });
  }catch(e){ console.warn('map init err', e); /* –∫–∞—Ä—Ç–∞ –ø–∞–Ω–µ–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ */ }
}
function initModalMapIfNeeded(){
  if(modalMap) return;
  try{
    // —Å–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä #modalMap –≤ –º–æ–¥–∞–ª–∫–µ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    modalMap = L.map('modalMap').setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lon], DEFAULT_CENTER.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(modalMap);
    modalMap.on('click', e=>{
      if(modalMap._setMode==='from'){ setModalFrom(e.latlng); modalMap._setMode=null; }
      else if(modalMap._setMode==='to'){ setModalTo(e.latlng); modalMap._setMode=null; }
    });
  }catch(e){ console.warn('modal map err', e); alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –≤ –º–æ–¥–∞–ª–∫–µ.'); }
}
function setFromPoint(latlng){ if(fromMarker) map.removeLayer(fromMarker); fromMarker = L.marker(latlng,{title:'A',draggable:true}).addTo(map).bindPopup('A ‚Äì –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ').openPopup(); fromMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); }); }
function setToPoint(latlng){ if(toMarker) map.removeLayer(toMarker); toMarker = L.marker(latlng,{title:'B',draggable:true}).addTo(map).bindPopup('B ‚Äì –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ').openPopup(); toMarker.on('dragend', ()=>{ if(fromMarker && toMarker) buildRoute(fromMarker.getLatLng(), toMarker.getLatLng()); }); }
function setModalFrom(latlng){ if(modalFrom) modalMap.removeLayer(modalFrom); modalFrom = L.marker(latlng,{title:'A',draggable:true}).addTo(modalMap).bindPopup('A ‚Äì –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ').openPopup(); modalFrom.on('dragend', ()=>{ if(modalFrom && modalTo) buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng()); }); }
function setModalTo(latlng){ if(modalTo) modalMap.removeLayer(modalTo); modalTo = L.marker(latlng,{title:'B',draggable:true}).addTo(modalMap).bindPopup('B ‚Äì –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ').openPopup(); modalTo.on('dragend', ()=>{ if(modalFrom && modalTo) buildModalRoute(modalFrom.getLatLng(), modalTo.getLatLng()); }); }
function clearRoute(){ if(fromMarker){ map.removeLayer(fromMarker); fromMarker=null; } if(toMarker){ map.removeLayer(toMarker); toMarker=null; } if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } searchMarkers.forEach(m=>map.removeLayer(m)); searchMarkers=[]; }
function clearModalRoute(){ if(modalFrom){ modalMap.removeLayer(modalFrom); modalFrom=null; } if(modalTo){ modalMap.removeLayer(modalTo); modalTo=null; } if(modalRouteLayer){ modalMap.removeLayer(modalRouteLayer); modalRouteLayer=null; } }

async function geocode(query){
  try{
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${OPENROUTESERVICE_API_KEY}&text=${encodeURIComponent(query)}&size=5`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('geocode fail '+r.status);
    const data = await r.json();
    return (data.features||[]).map(f=>({label:f.properties.label, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0], props:f.properties}));
  }catch(e){ console.warn(e); return []; }
}

async function buildRoute(fromLatLng, toLatLng){
  try{
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?start=${fromLatLng.lng},${fromLatLng.lat}&end=${toLatLng.lng},${toLatLng.lat}&api_key=${OPENROUTESERVICE_API_KEY}`;
    let resp = await fetch(url);
    if(!resp.ok){
      resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{method:'POST',headers:{'Content-Type':'application/json','Authorization':OPENROUTESERVICE_API_KEY},body:JSON.stringify({coordinates:[[fromLatLng.lng,fromLatLng.lat],[toLatLng.lng,toLatLng.lat]]})});
      if(!resp.ok) throw new Error('routing fail ' + resp.status);
      const g = await resp.json(); renderRouteGeoJSON(g); return g;
    }
    const g = await resp.json(); renderRouteGeoJSON(g); return g;
  }catch(e){ console.warn(e); alert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + (e.message||e)); }
}
function renderRouteGeoJSON(g){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.geoJSON(g,{style:{color:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ffd54a',weight:5,opacity:0.9}}).addTo(map);
  if(routeLayer && routeLayer.getBounds) map.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
}
async function buildModalRoute(fromLatLng, toLatLng){
  try{
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?start=${fromLatLng.lng},${fromLatLng.lat}&end=${toLatLng.lng},${toLatLng.lat}&api_key=${OPENROUTESERVICE_API_KEY}`;
    let resp = await fetch(url);
    if(!resp.ok){
      resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{method:'POST',headers:{'Content-Type':'application/json','Authorization':OPENROUTESERVICE_API_KEY},body:JSON.stringify({coordinates:[[fromLatLng.lng,fromLatLng.lat],[toLatLng.lng,toLatLng.lat]]})});
      if(!resp.ok) throw new Error('routing fail ' + resp.status);
      const g = await resp.json(); renderModalRouteGeoJSON(g); return g;
    }
    const g = await resp.json(); renderModalRouteGeoJSON(g); return g;
  }catch(e){ console.warn(e); alert('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + (e.message||e)); }
}
function renderModalRouteGeoJSON(g){
  if(modalRouteLayer) modalMap.removeLayer(modalRouteLayer);
  modalRouteLayer = L.geoJSON(g,{style:{color:getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ffd54a',weight:5,opacity:0.9}}).addTo(modalMap);
  if(modalRouteLayer && modalRouteLayer.getBounds) modalMap.fitBounds(modalRouteLayer.getBounds(),{padding:[20,20]});
}

async function doMapSearch(q){
  if(!q) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å');
  const res = await geocode(q);
  if(!res.length){ alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
  // –µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –¥–ª—è –º–æ–¥–∞–ª–∫–∏, —Ä–∞–±–æ—Ç–∞–µ–º —Å modalMap
  if(modalMap){
    searchMarkers.forEach(m=>modalMap.removeLayer(m)); searchMarkers=[];
    res.forEach(r=>{
      const mk = L.marker([r.lat,r.lon]).addTo(modalMap).bindPopup(`<strong>${r.label}</strong><div style="margin-top:6px"><button onclick="window.__setModalFrom(${r.lat},${r.lon})">A</button> <button onclick="window.__setModalTo(${r.lat},${r.lon})">B</button></div>`);
      searchMarkers.push(mk);
    });
    modalMap.fitBounds(L.featureGroup(searchMarkers).getBounds(),{padding:[20,20]});
  } else {
    alert('–ü–æ–∏—Å–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ä—Ç–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —ç—Ç–æ–π —Å–±–æ—Ä–∫–µ.');
  }
  return res;
}
window.__setFrom = (lat,lon)=>{ setFromPoint(L.latLng(lat,lon)); };
window.__setTo = (lat,lon)=>{ setToPoint(L.latLng(lat,lon)); };
window.__setModalFrom = (lat,lon)=>{ setModalFrom(L.latLng(lat,lon)); };
window.__setModalTo = (lat,lon)=>{ setModalTo(L.latLng(lat,lon)); };

/* -------------------
   Menu & Rendering
   ------------------- */
function renderMenu(){
  const menuList = el('menuList'); menuList.innerHTML='';
  const active = el('tabServices').classList.contains('service-active') ? 'services' : 'work';
  const items = active==='services' ? [
    {id:'order', title:'–ó–∞–∫–∞–∑–∞—Ç—å', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
    {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å / –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å'},
    {id:'citychat', title:'GIDChat', caption:'–õ–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ] : [
    {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫'},
    {id:'myOffers', title:'–ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏', caption:'–û—Ç–∫–ª–∏–∫–∏'},
    {id:'reports', title:'–û—Ç—á—ë—Ç—ã', caption:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'},
    {id:'settings', title:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', caption:'–ü—Ä–æ—Ñ–∏–ª—å –∏ —Ç–µ–º—ã'}
  ];
  items.forEach(it=>{
    const elDiv = document.createElement('div'); elDiv.className='menu-item'; elDiv.dataset.id=it.id;
    // special styling for GIDChat
    if(it.id==='citychat'){ elDiv.classList.add('gidchat'); elDiv.innerHTML = `<div class="left"><div class="title gidchat">GIDChat</div><div class="caption">–ë–æ–ª—å—à–∞—è –ª–µ–Ω—Ç–∞ –≥–æ—Ä–æ–¥–∞</div></div><div class="gidchat-holo">OPEN</div>`; }
    else elDiv.innerHTML = `<div class="left"><div class="title">${it.title}</div><div class="caption">${it.caption}</div></div><div style="opacity:0.9">‚Ä∫</div>`;
    elDiv.addEventListener('click', ()=>onMenuClick(it.id));
    menuList.appendChild(elDiv);
  });
}

/* -------------------
   Modals & Special UI
   ------------------- */
function openModal(html, actionsHtml, opts={}){
  const mb = el('modalBackdrop'), mw = el('modalWindow');
  el('modalContent').innerHTML = html;
  el('modalActions').innerHTML = actionsHtml || '<button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>';
  if(opts.fullscreen){
    mw.classList.add('fullscreen');
  } else {
    mw.classList.remove('fullscreen');
  }
  if(opts.maxWidth) mw.style.maxWidth = opts.maxWidth;
  else mw.style.maxWidth = '';
  mb.style.display='flex'; mb.setAttribute('aria-hidden','false');
  mb.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));
  mb.addEventListener('click', (e)=>{ if(e.target===mb) closeModal(); });
}
function closeModal(){ const mb = el('modalBackdrop'), mw = el('modalWindow'); mb.style.display='none'; mb.setAttribute('aria-hidden','true'); el('modalContent').innerHTML=''; el('modalActions').innerHTML=''; mw.classList.remove('fullscreen'); mw.style.maxWidth=''; }

... (the rest of your original JavaScript remains unchanged) ...

/* Note: –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–º–æ–¥–∞–ª–∫–∏/—á–∞—Ç/–∫–∞–ª–µ–Ω–¥–∞—Ä—å/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Å—Ç–∞–ª–∏—Å—å –ë–ï–ó –£–î–ê–õ–ï–ù–ò–ô.
         –Ø –∏–∑–º–µ–Ω–∏–ª –ª–∏—à—å –ª–æ–≥–∏–∫—É applyTheme / CSS –∏ —Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–≥–æ–¥—ã –∏ —à–∏—Ä–∏–Ω—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
*/

</script>
</body>
</html>
