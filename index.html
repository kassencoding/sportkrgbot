<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</title>
<meta name="description" content="–ü—Ä–æ—Ç–æ—Ç–∏–ø –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è GiDCity ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–¥–∞–ª–∫–∏, –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ JSONBin (–¥–µ–º–æ).">

<style>
  /* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ / –º–æ–±–∏–ª—å–Ω—ã–π —Ñ—Ä–µ–π–º --- */
  :root{
    --bg1: #5b2cff; /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
    --bg2: #0a0a0a; /* —á–µ—Ä–Ω—ã–π */
    --accent: #ffd54a; /* –∂–µ–ª—Ç—ã–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
    --glass-bg: rgba(255,255,255,0.06);
    --glass-border: rgba(255,255,255,0.12);
    --neon: rgba(91,44,255,0.9);
    --text: #f2f2f2;
    --muted: rgba(242,242,242,0.6);
  }
  html,body{
    height:100%;
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(160deg, var(--bg1) 0%, #2b0b3a 40%, var(--bg2) 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:12px;
  }

  /* –í–Ω–µ—à–Ω–∏–π –º–æ–±–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  .phone {
    width:380px; /* –º–æ–±–∏–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –¥–µ–º–æ */
    max-width:calc(100% - 24px);
    height:812px;
    border-radius:30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.03);
    overflow:hidden;
    position:relative;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));
    border: 1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
  }

  /* Header */
  .header{
    padding:18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    backdrop-filter: blur(6px) saturate(120%);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-bottom:1px solid rgba(255,255,255,0.03);
  }
  .title {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo {
    width:48px;
    height:48px;
    border-radius:10px;
    background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 6px 18px rgba(91,44,255,0.15), 0 1px 0 rgba(255,255,255,0.02) inset;
    border:1px solid var(--glass-border);
    position:relative;
    overflow:hidden;
  }
  .logo svg{filter: drop-shadow(0 6px 16px rgba(91,44,255,0.18));}
  .app-name {
    font-weight:800;
    font-size:20px;
    letter-spacing:0.6px;
  }
  /* glow animation */
  @keyframes title-glow{
    0%{text-shadow:0 0 0 rgba(255,255,255,0)}
    50%{text-shadow:0 0 18px rgba(91,44,255,0.75)}
    100%{text-shadow:0 0 0 rgba(255,255,255,0)}
  }
  .glow {
    animation: title-glow 2s infinite;
  }

  .header-center{
    text-align:center;
    font-size:14px;
    color:var(--muted);
  }
  .header-actions{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .icon-btn{
    width:44px;height:44px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:var(--glass-bg);
    border:1px solid var(--glass-border);
    backdrop-filter: blur(6px);
    cursor:pointer;
  }

  /* Content area */
  .content{
    padding:14px;
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:auto;
  }

  /* City & weather */
  .city-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .city-block{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .city-name{
    font-weight:700;
    font-size:18px;
  }
  .weather{
    font-size:13px;
    color:var(--muted);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:8px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.03);
    backdrop-filter: blur(6px);
  }

  /* Toggle buttons SERVICES / WORK */
  .toggle {
    display:flex;
    gap:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.05));
    padding:8px;
    border-radius:14px;
    width:100%;
  }
  .toggle button{
    flex:1;
    padding:10px 6px;
    border-radius:10px;
    background:transparent;
    border:none;
    color:var(--muted);
    font-weight:700;
    cursor:pointer;
  }
  .toggle button.active{
    background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    color:var(--text);
    box-shadow: 0 6px 18px rgba(0,0,0,0.4), 0 0 12px rgba(255,205,95,0.06) inset;
    position:relative;
  }
  .toggle button.active::after{
    content:'';
    position:absolute;
    bottom:-6px;
    left:50%;
    transform:translateX(-50%);
    width:40%;
    height:4px;
    border-radius:4px;
    background:var(--accent);
    box-shadow:0 6px 18px rgba(255,213,100,0.12);
  }

  /* Main card (glass) */
  .main-card{
    margin-top:2px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    border-radius:18px;
    padding:12px;
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    min-height:240px;
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .menu-list{
    flex:1;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .menu-item{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:6px;
    min-height:78px;
    cursor:pointer;
  }
  .menu-item .caption{color:var(--muted); font-size:12px;}
  .menu-item .title{font-weight:800;}

  .notifications-btn{
    width:64px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
  }
  .notifications-btn .count{
    background:var(--accent);
    color:#111;
    font-weight:800;
    font-size:12px;
    padding:6px 8px;
    border-radius:12px;
    margin-top:4px;
  }

  /* Footer small */
  .footer{
    padding:10px 16px;
    text-align:center;
    font-size:11px;
    color:var(--muted);
    border-top:1px solid rgba(255,255,255,0.02);
  }

  /* Modals (simple) */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.5);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:20px;
  }
  .modal{
    width:100%;
    max-width:420px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    border:1px solid rgba(255,255,255,0.04);
    padding:14px;
    box-shadow:0 30px 80px rgba(0,0,0,0.7);
  }
  .modal .h{
    font-weight:800; margin-bottom:8px;
  }
  .row{display:flex;gap:8px;align-items:center;}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px;}
  input[type="text"], input[type="tel"], input[type="password"], textarea, select, input[type="number"], input[type="date"], input[type="time"]{
    width:100%;
    padding:10px;
    border-radius:10px;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.03);
    color:var(--text);
    outline:none;
  }
  textarea{min-height:80px; resize:vertical;}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;}
  .btn{
    padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800;
    background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color:var(--text);
  }
  .btn.primary{
    background: linear-gradient(90deg, #ffd54a, #ffb347);
    color:#111;
  }
  .small{font-size:13px;color:var(--muted);}

  /* lists for chat / posts */
  .list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto;padding-right:6px;}
  .post{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);}
  .post .meta{font-size:12px;color:var(--muted);margin-bottom:6px;}
  .flex-between{display:flex;justify-content:space-between;align-items:center;}

  /* small responsive for very narrow screens */
  @media (max-width:420px){
    .phone{width:100%}
  }


  /* tiny helper for hidden */
  .hidden{display:none !important;}
</style>
</head>
<body>

<div class="phone" role="application" aria-label="GiDCity prototype">
  <!-- Header -->
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview" title="–ê–≤–∞—Ç–∞—Ä">
        <!-- simple city logo -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="4" height="10" rx="1.2" fill="white" opacity="0.12"/>
          <rect x="9" y="4" width="4" height="13" rx="1.2" fill="white" opacity="0.12"/>
          <rect x="15" y="9" width="4" height="8" rx="1.2" fill="white" opacity="0.12"/>
          <circle cx="12" cy="3" r="3" fill="#ffd54a" opacity="0.9"/>
        </svg>
      </div>
      <div>
        <div class="app-name glow" id="appTitle">GiDCity</div>
        <div class="small" id="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</div>
      </div>
    </div>

    <div class="header-center" id="headerCenter">GiDCity-“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!</div>

    <div class="header-actions">
      <div class="icon-btn" id="calendarBtn" title="–ö–∞–ª–µ–Ω–¥–∞—Ä—å" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">
        <!-- calendar svg -->
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 11h10M7 16h10M3 7h18M8 3v4M16 3v4" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06A2 2 0 113.28 16.9l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82L4.21 3.28A2 2 0 116.9 3.28l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09c.05.68.43 1.25 1 1.51h.01a1.65 1.65 0 001.82-.33l.06-.06A2 2 0 1120.72 7.1l-.06.06a1.65 1.65 0 00-.33 1.82V10c.07.55.36 1.05.81 1.44z" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- City / weather row -->
    <div class="city-row">
      <div class="city-block">
        <div>
          <div class="city-name" id="cityName">–ù—É—Ä-–°—É–ª—Ç–∞–Ω</div>
          <div class="small" id="citySubtitle">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
        </div>
        <div class="weather" id="weatherBlock">‚Äî ¬∞C ¬∑ —è—Å–Ω–æ–µ –Ω–µ–±–æ</div>
      </div>
      <div class="small">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä.: <span id="syncStatus">–ª–æ–∫–∞–ª—å–Ω–æ</span></div>
    </div>

    <!-- Toggle -->
    <div class="toggle" role="tablist" aria-label="–í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞">
      <button id="servicesBtn" class="active" aria-pressed="true">–£–°–õ–£–ì–ò</button>
      <button id="workBtn" aria-pressed="false">–†–ê–ë–û–¢–ê</button>
    </div>

    <!-- Main card -->
    <div class="main-card" role="region" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
      <div class="menu-list" id="menuList">
        <!-- items populated by JS -->
      </div>

      <div class="notifications-btn">
        <div style="font-size:13px;color:var(--muted)">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="count" id="notifCount">0</div>
        <button class="btn" id="openNotifs">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- small help -->
    <div class="small">–®—Ä–∏—Ñ—Ç ‚Äî —Å—Ç–∏–ª—å iOS. –î–∏–∑–∞–π–Ω ‚Äî –º–∏–Ω–∏–º–∞–ª–∏–∑–º + —Ñ—É—Ç—É—Ä–∏–∑–º, –Ω–µ–æ–Ω –∏ —Å—Ç–µ–∫–ª–æ.</div>

  </div>

  <!-- Footer -->
  <div class="footer">KASSEN Technology Inc.</div>
</div>

<!-- ---------------- MODALS ---------------- -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-hidden="true">
  <div class="modal" id="modalWindow" role="document" aria-modal="true">
    <!-- dynamic content -->
  </div>
</div>

<!-- Auth modal (shown on first open) -->
<div class="modal-backdrop" id="authBackdrop" style="display:flex;">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="h">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
    <div class="small">–î–ª—è –≤—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —á–µ—Ç—ã—Ä—ë—Ö–∑–Ω–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å (PIN)</div>
    <div style="height:10px"></div>

    <label for="authName">–ò–º—è</label>
    <input id="authName" type="text" placeholder="–í–∞—à–µ –∏–º—è">

    <label for="authPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
    <input id="authPhone" type="tel" placeholder="+7xxxxxxxxxx">

    <label for="authPIN">–ü–∞—Ä–æ–ª—å (4 —Ü–∏—Ñ—Ä—ã)</label>
    <input id="authPIN" type="password" maxlength="4" pattern="\d*" inputmode="numeric" placeholder="1234">

    <div class="modal-actions">
      <button class="btn" id="authSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button class="btn primary" id="authSubmit">–í–æ–π—Ç–∏</button>
    </div>

    <div style="height:10px"></div>
    <div class="small" style="color:#ffd54a">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ PIN –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</div>
  </div>
</div>

<!-- Template modals (inserted dynamically into #modalWindow) -->

<script>
/*
  GiDCity ‚Äî Single-file prototype (HTML/CSS/JS).
  - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ: localStorage
  - JSONBin sync: —Ñ—É–Ω–∫—Ü–∏—è `syncToJSONBin()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π Bin ID –∏ X-Master-Key.
    –í–ê–ñ–ù–û: –¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ. –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –Ω—É–∂–Ω–æ –ø—Ä—è—Ç–∞—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
*/

const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG'; // –í–ê–ñ–ù–û: –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–ª–∏–µ–Ω—Ç–µ
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const USE_JSONBIN = true; // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å: –µ—Å–ª–∏ false ‚Äî –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è)

const modalBackdrop = document.getElementById('modalBackdrop');
const modalWindow = document.getElementById('modalWindow');
const authBackdrop = document.getElementById('authBackdrop');

const appStateKey = 'gidcity_state_v1';

let state = {
  user: null,
  city: '–ù—É—Ä-–°—É–ª—Ç–∞–Ω',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance: 0},
  reminders: []
};

// ---------- Utilities ----------
function saveState(localOnly=false){
  localStorage.setItem(appStateKey, JSON.stringify(state));
  document.getElementById('syncStatus').textContent = localOnly ? '–ª–æ–∫–∞–ª—å–Ω–æ' : '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
  if (!localOnly && USE_JSONBIN){
    syncToJSONBin().then(res=>{
      document.getElementById('syncStatus').textContent = '—Å–∏–Ω—Ö—Ä. JSONBin';
    }).catch(err=>{
      console.warn('JSONBin sync error', err);
      document.getElementById('syncStatus').textContent = '–æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä.';
    });
  }
}
function loadState(){
  const raw = localStorage.getItem(appStateKey);
  if(raw){
    try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn('parse state err', e); }
  }
}
function addNotification(text, meta={}){
  const n = {id:Date.now(), text, meta, ts:new Date().toISOString()};
  state.notifications.unshift(n);
  updateNotifCount();
  saveState();
}
function updateNotifCount(){
  document.getElementById('notifCount').textContent = state.notifications.length || 0;
}

// ---------- JSONBin sync (demo). ----------
async function syncToJSONBin(){
  // Note: this writes the whole state to the bin (PUT). In production ‚Äî use server-side secret handling.
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  const payload = {state, updatedAt: new Date().toISOString()};
  // Use fetch with X-Master-Key. This will fail if the bin is locked / permissions different.
  const resp = await fetch(url, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'X-Master-Key': JSONBIN_KEY
    },
    body: JSON.stringify(payload)
  });
  if(!resp.ok) throw new Error('JSONBin save failed: '+resp.status);
  return resp.json();
}
async function loadFromJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const resp = await fetch(url, {headers:{'X-Master-Key': JSONBIN_KEY}});
  if(!resp.ok) throw new Error('JSONBin load failed: '+resp.status);
  const data = await resp.json();
  if(data && data.record && data.record.state) {
    state = data.record.state;
    saveState(true);
    renderAll();
  }
  return data;
}

// ---------- UI rendering ----------
function renderMenuItems(){
  const menuList = document.getElementById('menuList');
  menuList.innerHTML = '';
  const activeSection = document.getElementById('servicesBtn').classList.contains('active') ? 'services' : 'work';

  const items = (activeSection === 'services') ? [
    {id:'order', title:'–ó–ê–ö–ê–ó–ê–¢–¨', caption:'–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
    {id:'reserve', title:'–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨', caption:'—Å–∫–æ—Ä–æ...'},
    {id:'ads', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'},
    {id:'citychat', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'}
  ] : [
    {id:'findJobs', title:'–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã', caption:'–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫'},
    {id:'ads2', title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥', caption:'–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π'},
    {id:'citychat2', title:'City —á–∞—Ç', caption:'–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞'},
    {id:'messenger2', title:'–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', caption:'–î–∏–∞–ª–æ–≥–∏'},
    {id:'wallet2', title:'–ö–æ—à–µ–ª—ë–∫', caption:'–ë–∞–ª–∞–Ω—Å'},
    {id:'spacer', title:'', caption:''}
  ];

  items.forEach(it=>{
    const el = document.createElement('div');
    el.className='menu-item';
    el.dataset.id = it.id;
    el.innerHTML = `<div class="title">${it.title}</div><div class="caption">${it.caption}</div>`;
    if(it.id === 'spacer') el.style.visibility='hidden';
    el.addEventListener('click', ()=>onMenuClick(it.id, activeSection));
    menuList.appendChild(el);
  });
}

function renderAll(){
  document.getElementById('cityName').textContent = state.city || '–ù—É—Ä-–°—É–ª—Ç–∞–Ω';
  // subtitle remains
  updateNotifCount();
  renderMenuItems();
}

// ---------- Events & handlers ----------
document.getElementById('servicesBtn').addEventListener('click', ()=>{
  document.getElementById('servicesBtn').classList.add('active');
  document.getElementById('servicesBtn').setAttribute('aria-pressed','true');
  document.getElementById('workBtn').classList.remove('active');
  document.getElementById('workBtn').setAttribute('aria-pressed','false');
  renderMenuItems();
});
document.getElementById('workBtn').addEventListener('click', ()=>{
  document.getElementById('workBtn').classList.add('active');
  document.getElementById('workBtn').setAttribute('aria-pressed','true');
  document.getElementById('servicesBtn').classList.remove('active');
  document.getElementById('servicesBtn').setAttribute('aria-pressed','false');
  renderMenuItems();
});

document.getElementById('calendarBtn').addEventListener('click', openCalendarModal);
document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
document.getElementById('openNotifs').addEventListener('click', openNotifications);
document.getElementById('authSubmit').addEventListener('click', doAuth);
document.getElementById('authSkip').addEventListener('click', ()=>{
  authBackdrop.style.display='none';
  loadState();
  renderAll();
});

function onMenuClick(id, section){
  // map to actions
  if(id === 'order'){ openOrderModal(); }
  else if(id === 'reserve'){ openReserveModal(); }
  else if(id === 'ads' || id === 'ads2'){ openAdsModal(); }
  else if(id === 'citychat' || id === 'citychat2'){ openCityChatModal(); }
  else if(id === 'messenger' || id === 'messenger2'){ openMessengerModal(); }
  else if(id === 'wallet' || id === 'wallet2'){ openWalletModal(); }
  else if(id === 'findJobs'){ openFindJobsModal(); }
}

// ---------- Modals implementation ----------
function showModal(html){
  modalWindow.innerHTML = html;
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');

  // attach close handlers for elements with data-close
  modalWindow.querySelectorAll('[data-close]').forEach(btn=>{
    btn.addEventListener('click', hideModal);
  });
}

function hideModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); modalWindow.innerHTML=''; }

function openCalendarModal(){
  const modal = `
    <div class="h">–ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî ${new Date().toLocaleString('ru',{month:'long', year:'numeric'})}</div>
    <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫—É ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</div>
    <div style="height:8px"></div>
    <label>–î–∞—Ç–∞</label>
    <input type="date" id="remDate" value="${new Date().toISOString().slice(0,10)}">
    <label>–í—Ä–µ–º—è</label>
    <input type="time" id="remTime" value="12:00">
    <label>–ó–∞–º–µ—Ç–∫–∞</label>
    <input type="text" id="remNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–±—Ä–∞—Ç—å –ø–æ—Å—ã–ª–∫—É">
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="saveReminder">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
    </div>
  `;
  showModal(modal);
  document.getElementById('saveReminder').addEventListener('click', ()=>{
    const d = document.getElementById('remDate').value;
    const t = document.getElementById('remTime').value;
    const note = document.getElementById('remNote').value || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ';
    if(!d || !t) return alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
    const dtISO = new Date(d + 'T' + t + ':00').toISOString();
    state.reminders.unshift({id:Date.now(), datetime:dtISO, note, read:false});
    addNotification('–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + note, {type:'reminder', when:dtISO});
    saveState();
    hideModal();
    tryScheduleNotification(dtISO, note);
  });
}

function tryScheduleNotification(dtISO, text){
  // In this client demo we can't reliably schedule while tab closed. We'll use Notification API to request permission and create a immediate notification if <=1 minute away.
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') Notification.requestPermission();
  // if time less than 60s -> show immediate
  const time = new Date(dtISO).getTime() - Date.now();
  if(time <= 60000 && time > -5000){
    if(Notification.permission === 'granted'){
      new Notification('GiDCity ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', {body:text});
    }
  } else {
    // fallback: set timeout if tab active
    if(time > 0 && time < 1000*60*60*24*7){ // schedule within 7 days only for demo
      setTimeout(()=>{ if(Notification.permission === 'granted'){ new Notification('GiDCity ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', {body:text}); addNotification('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '+text); } }, time);
    }
  }
}

function openSettingsModal(){
  const icons = ['–ù—É—Ä-–°—É–ª—Ç–∞–Ω','–ê–ª–º–∞—Ç—ã','–®—ã–º–∫–µ–Ω—Ç','–ö–∞—Ä–∞–≥–∞–Ω–¥–∞','–ê–∫—Ç–æ–±–µ','–ü–∞–≤–ª–æ–¥–∞—Ä','–ö–æ—Å—Ç–∞–Ω–∞–π'];
  const themeOptions = ['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π','—Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π','—Ç—ë–ø–ª—ã–π-–æ—Ä–∞–Ω–∂–µ–≤—ã–π'];
  const modal = `
    <div class="h">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="small">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <label>–ê–≤–∞—Ç–∞—Ä (URL)</label>
    <input type="text" id="profileAvatar" placeholder="https://..." value="">
    <label>–ò–º—è</label>
    <input type="text" id="profileName" placeholder="–ò–º—è">
    <label>–§–∞–º–∏–ª–∏—è</label>
    <input type="text" id="profileSurname" placeholder="–§–∞–º–∏–ª–∏—è">
    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
    <input type="tel" id="profilePhone" placeholder="+7...">
    <div style="height:8px"></div>
    <label>–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞</label>
    <select id="citySelect">${icons.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
    <div style="height:8px"></div>
    <label>–í—ã–±–æ—Ä —Ç–µ–º—ã</label>
    <select id="themeSelect">${themeOptions.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div style="height:8px"></div>
    <div class="small" style="color:#ffd54a">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: API-–∫–ª—é—á –¥–ª—è JSONBin –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ –≤ –ø—É–±–ª–∏—á–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö.</div>
  `;
  showModal(modal);
  // preload
  document.getElementById('profileAvatar').value = (state.user && state.user.avatar) ? state.user.avatar : '';
  document.getElementById('profileName').value = (state.user && state.user.name) ? state.user.name : '';
  document.getElementById('profileSurname').value = (state.user && state.user.surname) ? state.user.surname : '';
  document.getElementById('profilePhone').value = (state.user && state.user.phone) ? state.user.phone : '';
  document.getElementById('citySelect').value = state.city || '–ù—É—Ä-–°—É–ª—Ç–∞–Ω';
  document.getElementById('themeSelect').value = state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π';

  document.getElementById('saveSettings').addEventListener('click', ()=>{
    const avatar = document.getElementById('profileAvatar').value.trim();
    const name = document.getElementById('profileName').value.trim();
    const surname = document.getElementById('profileSurname').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const city = document.getElementById('citySelect').value;
    const theme = document.getElementById('themeSelect').value;
    state.user = state.user || {};
    state.user.avatar = avatar || state.user.avatar;
    state.user.name = name || state.user.name;
    state.user.surname = surname || state.user.surname;
    state.user.phone = phone || state.user.phone;
    state.city = city;
    state.theme = theme;
    if(avatar) document.getElementById('avatarPreview').innerHTML = `<img src="${avatar}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`;
    saveState();
    hideModal();
    renderAll();
  });
}

function openNotifications(){
  const list = state.notifications.map(n=>`<div class="post"><div class="meta">${new Date(n.ts).toLocaleString()}</div><div>${n.text}</div></div>`).join('') || '<div class="small">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  const modal = `
    <div class="h">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <div class="list">${list}</div>
    <div class="modal-actions">
      <button class="btn" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(modal);
  document.getElementById('clearNotifs').addEventListener('click', ()=>{
    state.notifications = [];
    saveState();
    hideModal();
    renderAll();
  });
}

function openOrderModal(){
  const services = ['GiD –ó–∞–∫–∞–∑','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–¥–æ–º','–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–ú–∞—Å—Ç–µ—Ä/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'];
  const modal = `
    <div class="h">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</div>
    <label>–£—Å–ª—É–≥–∞</label>
    <select id="orderService">${services.map(s=>`<option>${s}</option>`).join('')}</select>
    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
    <textarea id="orderDesc" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É"></textarea>
    <div style="display:flex;gap:8px">
      <div style="flex:1"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="orderDeadline"></div>
      <div style="width:120px"><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input type="number" id="orderBudget" min="0" value="0"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="createOrder">–ó–∞–∫–∞–∑–∞—Ç—å</button>
    </div>
  `;
  showModal(modal);
  document.getElementById('createOrder').addEventListener('click', ()=>{
    const svc = document.getElementById('orderService').value;
    const desc = document.getElementById('orderDesc').value;
    const deadline = document.getElementById('orderDeadline').value;
    const budget = document.getElementById('orderBudget').value;
    const order = {id:Date.now(), svc, desc, deadline, budget, city:state.city, created: new Date().toISOString()};
    // store as a generic post / service request
    state.servicesPosts.unshift(order);
    addNotification('–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + svc, {type:'order', orderId:order.id});
    saveState();
    hideModal();
    alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø).');
  });
}

function openReserveModal(){
  const modal = `
    <div class="h">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="small">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∫ GiDCity</div>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(modal);
}

function openAdsModal(){
  const cats = ['–í–∞–∫–∞–Ω—Å–∏–∏','–ë–∏–∑–Ω–µ—Å','–ê–∫—Ü–∏–∏','–ê—Ñ–∏—à–∞','–¢–æ–≤–∞—Ä—ã','–ü—Ä–æ–¥—É–∫—Ç—ã'];
  const modal = `
    <div class="h">–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥</div>
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
    <select id="adsCat">${cats.map(c=>`<option>${c}</option>`).join('')}</select>
    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    <input type="text" id="adsTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
    <label>–¢–µ–∫—Å—Ç</label>
    <textarea id="adsText" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"></textarea>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="publishAds">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
  `;
  showModal(modal);
  document.getElementById('publishAds').addEventListener('click', ()=>{
    const cat = document.getElementById('adsCat').value;
    const title = document.getElementById('adsTitle').value;
    const text = document.getElementById('adsText').value;
    state.cityPosts.unshift({id:Date.now(), cat, title, text, created: new Date().toISOString()});
    saveState();
    addNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ' + title);
    hideModal();
  });
}

function openCityChatModal(){
  const postsHtml = state.cityPosts.map(p=>`<div class="post"><div class="meta">${new Date(p.created).toLocaleString()} ¬∑ ${p.cat}</div><div style="font-weight:700">${p.title}</div><div class="small">${p.text}</div></div>`).join('') || '<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞—è</div>';
  const modal = `
    <div class="h">City —á–∞—Ç ‚Äî ${state.city}</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <div style="width:44px;height:44px;border-radius:10px;background:var(--glass-bg);display:flex;align-items:center;justify-content:center"><div style="font-weight:800;color:var(--muted)">U</div></div>
      <input id="cityPostText" type="text" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å..." style="flex:1">
      <button class="btn" id="attachImg">üìé</button>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="publishCityPost">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
    <div style="height:10px"></div>
    <div class="list">${postsHtml}</div>
  `;
  showModal(modal);
  document.getElementById('publishCityPost').addEventListener('click', ()=>{
    const text = document.getElementById('cityPostText').value.trim();
    if(!text) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞');
    state.cityPosts.unshift({id:Date.now(), title: '–ü–æ—Å—Ç', text, cat:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ', created: new Date().toISOString()});
    saveState();
    addNotification('–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ City —á–∞—Ç–µ');
    hideModal();
  });
}

function openMessengerModal(){
  const chatsHtml = state.chats.map(c=>`<div class="post"><div class="meta">${c.name || c.contact}</div><div class="small">${c.last || ''}</div></div>`).join('') || '<div class="small">–°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –ø—É—Å—Ç</div>';
  const modal = `
    <div class="h">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button class="btn" id="openContacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
      <button class="btn" id="createChat">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
    </div>
    <div class="list">${chatsHtml}</div>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(modal);
  document.getElementById('createChat').addEventListener('click', ()=>{
    const name = prompt('–ò–º—è / –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞:');
    if(!name) return;
    state.chats.unshift({id:Date.now(), name, last:'–ù–æ–≤—ã–π —á–∞—Ç'});
    saveState();
    hideModal();
    openMessengerModal();
  });
}

function openWalletModal(){
  const modal = `
    <div class="h">–ö–æ—à–µ–ª—ë–∫</div>
    <div style="font-size:26px;font-weight:900">${state.wallet.balance || 0} ‚Ç∏</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="walletTransfer">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      <button class="btn" id="walletTopup">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button class="btn" id="walletWithdraw">–°–Ω—è—Ç—å</button>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(modal);
  document.getElementById('walletTopup').addEventListener('click', ()=>{
    const sum = parseInt(prompt('–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚Ç∏):')||'0',10);
    if(sum>0){ state.wallet.balance = (state.wallet.balance||0) + sum; saveState(); alert('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'); hideModal(); openWalletModal(); }
  });
  document.getElementById('walletTransfer').addEventListener('click', ()=>{
    const to = prompt('–ö–æ–º—É (–Ω–æ–º–µ—Ä):');
    const sum = parseInt(prompt('–°—É–º–º–∞ (‚Ç∏):')||'0',10);
    if(!to || sum<=0) return;
    if((state.wallet.balance||0) < sum) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
    state.wallet.balance -= sum;
    saveState();
    addNotification(`–ü–µ—Ä–µ–≤–æ–¥ ${sum}‚Ç∏ –Ω–∞ ${to}`);
    hideModal();
  });
  document.getElementById('walletWithdraw').addEventListener('click', ()=>{
    const sum = parseInt(prompt('–°—É–º–º–∞ —Å–Ω—è—Ç–∏—è (‚Ç∏):')||'0',10);
    if(sum>0 && (state.wallet.balance||0) >= sum){ state.wallet.balance -= sum; saveState(); alert('–°–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ'); hideModal(); openWalletModal(); }
    else alert('–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è');
  });
}

function openFindJobsModal(){
  const jobs = state.servicesPosts.map(o=>`<div class="post"><div class="meta">${o.svc} ¬∑ ${o.deadline || ''}</div><div style="font-weight:700">${o.desc}</div><div class="small">–ë—é–¥–∂–µ—Ç ${o.budget} ‚Ç∏</div><div style="margin-top:8px"><button class="btn" onclick="applyJob(${o.id})">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button></div></div>`).join('') || '<div class="small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>';
  const modal = `
    <div class="h">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã</div>
    <div class="small">–õ–µ–Ω—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–¥–µ–º–æ)</div>
    <div style="height:8px"></div>
    <div class="list">${jobs}</div>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>
  `;
  showModal(modal);
}

window.applyJob = function(orderId){
  const budget = prompt('–í–∞—à –±—é–¥–∂–µ—Ç (‚Ç∏):','0');
  const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:','');
  // find order
  const order = state.servicesPosts.find(o=>o.id == orderId);
  if(!order) return alert('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  // send proposal as notification to owner (prototype)
  addNotification(`–û—Ç–∫–ª–∏–∫ –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É (${order.svc}): ${budget}‚Ç∏ ‚Äî ${comment}`, {type:'proposal', orderId});
  hideModal();
  alert('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¥–µ–º–æ).');
}

// ---------- Auth ----------
function doAuth(){
  const name = document.getElementById('authName').value.trim();
  const phone = document.getElementById('authPhone').value.trim();
  const pin = document.getElementById('authPIN').value.trim();
  if(!name || !phone || !/^\d{4}$/.test(pin)) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ 4-–∑–Ω–∞—á–Ω—ã–π PIN');
  state.user = {name, phone, pin};
  addNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª: ' + name);
  saveState();
  authBackdrop.style.display='none';
  renderAll();
}

// ---------- Init ----------
loadState();
renderAll();

// If user has reminders in past -> schedule short-notifications for near ones
state.reminders.forEach(r=>{
  tryScheduleNotification(r.datetime, r.note);
});

// If user explicitly wants to use JSONBin and key present, try load (non-blocking)
if(USE_JSONBIN){
  // Try to load remote state (silent)
  loadFromJSONBin().catch(err=>{
    console.info('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ JSONBin (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –¥–µ–º–æ).', err);
  });
}

/* Accessibility: close modal on backdrop click */
modalBackdrop.addEventListener('click', (e)=>{
  if(e.target === modalBackdrop) hideModal();
});

// small dynamic title swap: show first greeting then russian text
setTimeout(()=>{ document.getElementById('headerCenter').textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GiDCity!'; }, 2200);

// Avatar preview if user exists
if(state.user && state.user.avatar){
  document.getElementById('avatarPreview').innerHTML = `<img src="${state.user.avatar}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`;
}

// initial notification (demo)
if(!localStorage.getItem('gidcity_welcome_shown')){
  addNotification('–î–æ–±—Ä–æ! –ü—Ä–æ—Ç–æ—Ç–∏–ø GiDCity –∑–∞–≥—Ä—É–∂–µ–Ω');
  localStorage.setItem('gidcity_welcome_shown','1');
}
renderAll();

</script>

</body>
</html>
