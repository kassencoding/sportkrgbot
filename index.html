<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>GiDCity ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø (—Å–∏–º–º–µ—Ç—Ä–∏—è, —Ç–µ–º—ã, JSONBin, –º–µ–¥–∏–∞)</title>
<meta name="description" content="GiDCity prototype with JSONBin sync, themes, media uploads, chat actions">
<style>
  /* ---------- ROOT / THEME VARIABLES ---------- */
  :root{
    --top: #5b2cff;
    --bottom: #0a0a0a;
    --panel-bg: #0a0a0a;
    --accent: #ffd54a;
    --glass-bg: rgba(255,255,255,0.02);
    --glass-border: rgba(255,255,255,0.06);
    --muted: rgba(242,242,242,0.62);
    --text: #f2f2f2;
    --radius: 14px;
    --card-h: 120px; /* fixed card height for symmetry */
    --card-gap: 12px;
    --phone-w: 380px;
    --phone-h: 812px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--top) 0%, #2b0b3a 40%, var(--bottom) 100%);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--text);-webkit-font-smoothing:antialiased;display:flex;align-items:center;justify-content:center;padding:12px;}
  /* ---------- PHONE FRAME (fixed size like Telegram mini-app) ---------- */
  .phone{width:var(--phone-w);height:var(--phone-h);border-radius:30px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.16));}
  /* ---------- HEADER ---------- */
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px);}
  .title{display:flex;align-items:center;gap:12px;}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;border:1px solid var(--glass-border);overflow:hidden;}
  .app-name{font-weight:900;font-size:18px;margin:0}
  .header-center{display:flex;align-items:center;gap:10px}
  .date-btn{padding:8px 12px;border-radius:12px;background:var(--panel-bg);border:1px solid var(--glass-border);font-weight:700}
  .header-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--glass-bg);border:1px solid var(--glass-border);cursor:pointer}
  /* ---------- CONTENT ---------- */
  .content{padding:14px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .city-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .city-block{display:flex;gap:12px;align-items:center}
  .city-name{font-weight:800;font-size:20px;margin:0}
  .weather{font-size:13px;color:var(--muted);background:var(--panel-bg);padding:8px 14px;border-radius:999px;border:1px solid var(--glass-border);min-width:140px;text-align:center}
  /* ---------- TOGGLE (services/work) ---------- */
  .toggle{display:flex;gap:10px;background:var(--panel-bg);padding:8px;border-radius:18px;width:100%;border:1px solid var(--glass-border)}
  .toggle button{flex:1;padding:12px;border-radius:12px;background:transparent;border:none;color:var(--muted);font-weight:800;cursor:pointer}
  .toggle button.active{color:var(--text);box-shadow:inset 0 -4px 0 0 var(--accent);background:transparent}
  /* ---------- MAIN CARD (menu) ---------- */
  .main-card{background:var(--panel-bg);padding:16px;border-radius:18px;border:1px solid var(--glass-border);display:flex;gap:14px;align-items:flex-start;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
  .menu-list{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--card-gap);flex:1}
  .menu-item{height:var(--card-h);border-radius:12px;padding:16px;background:var(--panel-bg);border:1px solid var(--glass-border);display:flex;flex-direction:column;justify-content:center;align-items:flex-start;box-sizing:border-box}
  .menu-item .title{font-size:18px;font-weight:900}
  .menu-item .caption{font-size:13px;color:var(--muted);margin-top:6px}
  .menu-right{width:80px;display:flex;flex-direction:column;align-items:center;gap:10px}
  .notif-btn{background:var(--panel-bg);border:1px solid var(--glass-border);padding:8px;border-radius:10px}
  .notif-count{background:var(--accent);color:#111;padding:6px 8px;border-radius:999px;font-weight:900}
  /* ---------- footer ---------- */
  .footer{padding:10px 16px;text-align:center;font-size:11px;color:var(--muted);border-top:1px solid rgba(255,255,255,0.02)}
  /* ---------- MODAL ---------- */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
  .modal{width:100%;max-width:420px;border-radius:14px;background:linear-gradient(180deg,var(--panel-bg),#0b0b0b);border:1px solid var(--glass-border);padding:14px;box-shadow:0 30px 80px rgba(0,0,0,0.7)}
  .modal .h{font-weight:900;margin-bottom:8px;font-size:18px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="tel"],input[type="password"],textarea,select,input[type="number"],input[type="date"],input[type="time"]{width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text);outline:none}
  textarea{min-height:90px;resize:vertical}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));color:var(--text)}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#ffb347);color:#111}
  .small{font-size:13px;color:var(--muted)}
  /* ---------- Post styles (city chat) ---------- */
  .post{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px}
  .post .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
  .post-author{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .post-author img{width:36px;height:36px;border-radius:50%;object-fit:cover}
  .post-actions{display:flex;gap:10px;margin-top:10px;align-items:center}
  .act-btn{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:800}
  .like-on{background:rgba(255,0,100,0.12);border-color:rgba(255,0,100,0.2)}
  .comment-list{margin-top:8px;padding-left:10px;border-left:2px dashed rgba(255,255,255,0.03)}
  .comment{margin-bottom:8px;padding:6px;border-radius:8px;background:rgba(0,0,0,0.2)}
  /* ---------- fixed layout helpers ---------- */
  .centered{display:flex;align-items:center;justify-content:center}
  /* theme-specific overrides will be set dynamically via JS */
  @media (max-width:420px){ .phone{width:calc(100% - 24px)} }
</style>
</head>
<body>

<div class="phone" role="application" aria-label="GiDCity">
  <div class="header">
    <div class="title">
      <div class="logo" id="avatarPreview" title="–ê–≤–∞—Ç–∞—Ä">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="4" height="10" rx="1.2" fill="white" opacity="0.12"/><rect x="9" y="4" width="4" height="13" rx="1.2" fill="white" opacity="0.12"/><rect x="15" y="9" width="4" height="8" rx="1.2" fill="white" opacity="0.12"/><circle cx="12" cy="3" r="3" fill="#ffd54a" opacity="0.9"/></svg>
      </div>
      <div>
        <div class="app-name" id="appTitle">GiDCity</div>
        <div class="small" id="subtitle">–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
      </div>
    </div>

    <!-- CENTER: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ö–ù–û–ü–ö–£ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π (–≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ –≥–æ—Ä–æ–¥–∞ / –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è) -->
    <div class="header-center">
      <button class="date-btn" id="dateButton" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å"></button>
    </div>

    <div class="header-actions">
      <div class="icon-btn" id="calendarBtn">üìÜ</div>
      <div class="icon-btn" id="settingsBtn">‚öôÔ∏è</div>
    </div>
  </div>

  <div class="content">
    <div class="city-row">
      <div class="city-block" style="align-items:flex-start">
        <div>
          <div class="city-name" id="cityName">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</div>
          <div class="small" id="citySubtitle">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
        </div>
      </div>

      <!-- WEATHER: —Å–ø—Ä–∞–≤–∞ -->
      <div class="weather" id="weatherBlock">‚Äî ¬∞C ¬∑ ‚Äî</div>
    </div>

    <div class="toggle" role="tablist" aria-label="–í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞">
      <button id="servicesBtn" class="active" aria-pressed="true">–£–°–õ–£–ì–ò</button>
      <button id="workBtn" aria-pressed="false">–†–ê–ë–û–¢–ê</button>
    </div>

    <div class="main-card" role="region" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
      <div class="menu-list" id="menuList"></div>

      <div class="menu-right">
        <!-- —É–±—Ä–∞–ª–∏ –±–µ–π–¥–∂ —É –∫–∞—Ä—Ç–æ—á–∫–∏ reserve: –∑–¥–µ—Å—å —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="notif-btn centered">
          <div class="small">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
          <div class="notif-count" id="notifCount">0</div>
        </div>
        <button class="btn" id="openNotifs">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="small">–®—Ä–∏—Ñ—Ç ‚Äî —Å—Ç–∏–ª—å iOS. –î–∏–∑–∞–π–Ω ‚Äî –º–∏–Ω–∏–º–∞–ª–∏–∑–º + —Ñ—É—Ç—É—Ä–∏–∑–º, –Ω–µ–æ–Ω –∏ —Å—Ç–µ–∫–ª–æ.</div>
  </div>

  <div class="footer">KASSEN Technology Inc.</div>
</div>

<!-- MODALS -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalWindow" role="dialog" aria-modal="true"></div>
</div>

<!-- AUTH (unchanged logic, kept) -->
<div class="modal-backdrop" id="authBackdrop" style="display:flex;">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="h">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
    <div class="small">–í–≤–µ–¥–∏—Ç–µ –∏–º—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ PIN (4 —Ü–∏—Ñ—Ä—ã)</div>
    <div style="height:10px"></div>
    <label>–ò–º—è</label><input id="authName" type="text" placeholder="–í–∞—à–µ –∏–º—è">
    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label><input id="authPhone" type="tel" placeholder="+7...">
    <label>PIN (4 —Ü–∏—Ñ—Ä—ã)</label><input id="authPIN" type="password" maxlength="4" inputmode="numeric">
    <div class="modal-actions"><button class="btn" id="authSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button><button class="btn primary" id="authSubmit">–í–æ–π—Ç–∏</button></div>
    <div style="height:8px"></div>
    <div class="small" style="color:var(--accent)">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è –±–æ–µ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è PIN –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</div>
  </div>
</div>

<!-- file inputs for media -->
<input id="fileProfileAvatar" type="file" accept="image/*" class="hidden">
<input id="fileChatAttach" type="file" accept="image/*" class="hidden">
<input id="fileMessageAttach" type="file" accept="image/*" class="hidden">
<input id="fileOrderAttach" type="file" accept="image/*" class="hidden">

<script>
/* =========================
   GiDCity ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª
   - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è JSONBin (–∞–≤—Ç–æ)
   - —Ç–µ–º—ã (–º–µ–Ω—è—é—Ç —Ñ–æ–Ω, –ø–∞–Ω–µ–ª–∏, –∞–∫—Ü–µ–Ω—Ç)
   - –º–µ–¥–∏–∞–≤–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä —Ñ–∞–π–ª–æ–≤
   - —Å–∏–º–º–µ—Ç—Ä–∏—è: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–æ—á–µ–∫
   - –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤ —Ü–µ–Ω—Ç—Ä–µ header (—Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞)
   - City chat: like/comment/repost
   ========================= */

/* JSONBin –∫–æ–Ω—Ñ–∏–≥ (–∫–∞–∫ —É —Ç–µ–±—è) */
const JSONBIN_KEY = '$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG';
const JSONBIN_ID = '6911fbe843b1c97be9a4dc97';
const USE_JSONBIN = true;

/* state */
const appStateKey = 'gidcity_live_v2';
let state = {
  user: null,
  city: '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
  theme: '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π',
  notifications: [],
  servicesPosts: [],
  cityPosts: [],
  chats: [],
  wallet: {balance:0},
  reminders: []
};

/* city coords for weather */
const CITY_COORDS = {
  "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞": {lat:49.8062, lon:73.0851},
  "–ù—É—Ä-–°—É–ª—Ç–∞–Ω": {lat:51.1605, lon:71.4704},
  "–ê–ª–º–∞—Ç—ã": {lat:43.2383, lon:76.9458}
};

/* themes map (top + black bottom + accent) */
const THEMES = {
  '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π': {top:'#5b2cff', bottom:'#0a0a0a', accent:'#ffd54a'},
  '—Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π': {top:'#0b3d91', bottom:'#061428', accent:'#55d4ff'},
  '–∫—Ä–∞—Å–Ω—ã–π': {top:'#ff416c', bottom:'#0a0a0a', accent:'#ffb37a'},
  '–æ—Ä–∞–Ω–∂–µ–≤—ã–π': {top:'#ff7a18', bottom:'#0a0a0a', accent:'#ffd54a'},
  '—Å–µ—Ä—ã–π': {top:'#6b6b6b', bottom:'#0a0a0a', accent:'#d0d0d0'},
  '–∑–µ–ª—ë–Ω—ã–π': {top:'#00b09b', bottom:'#0a0a0a', accent:'#a8ffcf'},
  '–±–µ–ª—ã–π': {top:'#ffffff', bottom:'#0a0a0a', accent:'#333333'},
  '–∂—ë–ª—Ç—ã–π': {top:'#ffd54a', bottom:'#0a0a0a', accent:'#111111'},
  '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π': {top:'#8b5e3c', bottom:'#0a0a0a', accent:'#ffd9b3'}
};

/* DOM refs */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalWindow = document.getElementById('modalWindow');
const authBackdrop = document.getElementById('authBackdrop');
const fileProfileAvatar = document.getElementById('fileProfileAvatar');
const fileChatAttach = document.getElementById('fileChatAttach');
const fileMessageAttach = document.getElementById('fileMessageAttach');
const fileOrderAttach = document.getElementById('fileOrderAttach');

/* ---------- load local state ---------- */
function loadStateLocal(){
  const raw = localStorage.getItem(appStateKey);
  if(raw){
    try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn('parse error', e); }
  }
}

/* ---------- save with debounce and JSONBin sync ---------- */
let saveTimer = null;
function requestSave(){
  localStorage.setItem(appStateKey, JSON.stringify(state));
  document.getElementById('syncStatus')?.remove?.(); // not present always
  // debounce
  if(!USE_JSONBIN) return;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{ syncToJSONBin().then(()=>{ console.log('synced'); }).catch(e=>console.warn('sync err',e)); }, 1100);
}

/* ---------- JSONBin functions ---------- */
async function syncToJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  const payload = {state, updatedAt: new Date().toISOString()};
  const r = await fetch(url, {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_KEY}, body: JSON.stringify(payload)});
  if(!r.ok) throw new Error('JSONBin PUT failed');
  return r.json();
}
async function loadFromJSONBin(){
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const r = await fetch(url, {headers:{'X-Master-Key':JSONBIN_KEY}});
  if(!r.ok) throw new Error('JSONBin GET failed');
  const data = await r.json();
  if(data && data.record && data.record.state){
    state = data.record.state;
    localStorage.setItem(appStateKey, JSON.stringify(state));
  }
  return data;
}

/* ---------- theme application ---------- */
function applyTheme(name){
  const t = THEMES[name] || THEMES['—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'];
  document.documentElement.style.setProperty('--top', t.top);
  document.documentElement.style.setProperty('--bottom', t.bottom);
  document.documentElement.style.setProperty('--panel-bg', t.bottom);
  document.documentElement.style.setProperty('--accent', t.accent);
  document.querySelector('.phone').style.background = `linear-gradient(180deg, ${t.top} 0%, #2b0b3a 40%, ${t.bottom} 100%)`;
  // color accents for buttons that depend on theme: we'll also recolor modal borders & active underline via CSS variables
}

/* ---------- weather via open-meteo ---------- */
async function fetchWeather(city){
  const coords = CITY_COORDS[city] || CITY_COORDS['–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'];
  if(!coords) return;
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('weather fetch failed');
    const data = await res.json();
    if(data && data.current_weather){
      const temp = Math.round(data.current_weather.temperature);
      const code = data.current_weather.weathercode;
      const txt = weatherCodeToText(code);
      document.getElementById('weatherBlock').textContent = `${temp} ¬∞C ¬∑ ${txt}`;
    }
  }catch(e){
    console.warn(e);
    document.getElementById('weatherBlock').textContent = '‚Äî ¬∞C ¬∑ ‚Äî';
  }
}
function weatherCodeToText(code){
  const map = {0:'—è—Å–Ω–æ',1:'–º–∞–ª–æ–æ–±–ª–∞—á–Ω–æ',2:'–æ–±–ª–∞—á–Ω–æ',3:'–ø–∞—Å–º—É—Ä–Ω–æ',45:'—Ç—É–º–∞–Ω',48:'—Ç—É–º–∞–Ω',51:'–º–æ—Ä–æ—Å—å',61:'–¥–æ–∂–¥—å',63:'–¥–æ–∂–¥—å',80:'–ª–∏–≤–µ–Ω—å'};
  return map[code] || '–Ω–µ–∏–∑–≤.';
}

/* ---------- UI rendering: menu items with theme-specific colors ---------- */
function renderMenu(){
  const menuList = document.getElementById('menuList');
  menuList.innerHTML = '';

  // when services active
  const servicesActive = document.getElementById('servicesBtn').classList.contains('active');

  if(servicesActive){
    // –ó–ê–ö–ê–ó–ê–¢–¨ (gold)
    menuList.appendChild(makeMenuItem('–ó–ê–ö–ê–ó–ê–¢–¨','–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É','order','gold'));
    // –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨ (gold, wider visually if needed)
    menuList.appendChild(makeMenuItem('–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨','—Å–∫–æ—Ä–æ...','reserve','gold'));
    // –û–ë–™–Ø–í–õ–ï–ù–ò–ï —É—Å–ª—É–≥ (gold)
    menuList.appendChild(makeMenuItem('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π','ads','gold'));
    // City —á–∞—Ç (dark green)
    menuList.appendChild(makeMenuItem('City —á–∞—Ç','–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','citychat','darkgreen'));
    // –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä (default)
    menuList.appendChild(makeMenuItem('–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏','messenger'));
    // –ö–æ—à–µ–ª—ë–∫
    menuList.appendChild(makeMenuItem('–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å','wallet'));
  } else {
    // –†–∞–±–æ—Ç–∞ mode
    menuList.appendChild(makeMenuItem('–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã','–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫','findJobs','gold'));
    menuList.appendChild(makeMenuItem('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π','ads2','gold'));
    menuList.appendChild(makeMenuItem('City —á–∞—Ç','–ª–µ–Ω—Ç–∞ —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','citychat2','darkgreen'));
    menuList.appendChild(makeMenuItem('–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏','messenger2'));
    menuList.appendChild(makeMenuItem('–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å','wallet2'));
    // filler
    const spacer = document.createElement('div'); spacer.className='menu-item'; spacer.style.visibility='hidden'; menuList.appendChild(spacer);
  }
  // ensure reserve badge removed: not rendering any badge in reserve element
}

function makeMenuItem(title, caption, id, styleTag){
  const el = document.createElement('div');
  el.className = 'menu-item';
  el.dataset.id = id;

  // styleTag determines special colors for button background or text underline
  if(styleTag === 'gold'){
    // gold title color
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;width:100%"><div><div class="title" style="color:var(--accent)">${title}</div><div class="caption">${caption}</div></div><div style="opacity:0.9">‚Ä∫</div></div>`;
  } else if(styleTag === 'darkgreen'){
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;width:100%"><div><div class="title" style="color:#0b6b3a">${title}</div><div class="caption">${caption}</div></div><div style="opacity:0.9">‚Ä∫</div></div>`;
  } else {
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;width:100%"><div><div class="title">${title}</div><div class="caption">${caption}</div></div><div style="opacity:0.9">‚Ä∫</div></div>`;
  }
  el.addEventListener('click', ()=>onMenuClick(id));
  return el;
}

/* ---------- Menu click mapping ---------- */
function onMenuClick(id){
  if(id === 'order') openOrderModal();
  else if(id === 'reserve') openReserveModal();
  else if(id === 'ads' || id === 'ads2') openAdsModal();
  else if(id === 'citychat' || id === 'citychat2') openCityChatModal();
  else if(id === 'messenger' || id === 'messenger2') openMessengerModal();
  else if(id === 'wallet' || id === 'wallet2') openWalletModal();
  else if(id === 'findJobs') openFindJobsModal();
}

/* ---------- modal helpers ---------- */
function showModal(html){
  modalWindow.innerHTML = html;
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  modalWindow.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', hideModal));
}
function hideModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); modalWindow.innerHTML=''; }
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) hideModal(); });

/* ---------- Calendar button (header center) ---------- */
function updateDateButton(){
  const btn = document.getElementById('dateButton');
  const now = new Date();
  const opts = {weekday:'short', day:'numeric', month:'short'};
  btn.textContent = now.toLocaleDateString('ru-RU', opts);
  btn.title = now.toLocaleString();
}
document.getElementById('dateButton').addEventListener('click', openCalendarModal);
document.getElementById('calendarBtn').addEventListener('click', openCalendarModal);

/* ---------- Settings (profile) with media upload ---------- */
function openSettingsModal(forceOpen){
  const cities = Object.keys(CITY_COORDS);
  const themes = Object.keys(THEMES);
  const modal = `
    <div class="h">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <label>–ê–≤–∞—Ç–∞—Ä</label>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="uploadAvatarBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <img id="avatarPreviewSmall" src="${state.user && state.user.avatar ? state.user.avatar : 'https://via.placeholder.com/48/333/fff?text=U'}" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--glass-border)">
    </div>
    <label>–ò–º—è</label><input id="profileName" type="text" value="${state.user && state.user.name ? escapeHtml(state.user.name) : ''}">
    <label>–§–∞–º–∏–ª–∏—è</label><input id="profileSurname" type="text" value="${state.user && state.user.surname ? escapeHtml(state.user.surname) : ''}">
    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="profilePhone" type="tel" value="${state.user && state.user.phone ? escapeHtml(state.user.phone) : ''}">
    <label>–ì–æ—Ä–æ–¥</label><select id="citySelect">${cities.map(c=>`<option value="${c}" ${c===state.city?'selected':''}>${c}</option>`).join('')}</select>
    <label>–¢–µ–º–∞</label><select id="themeSelect">${themes.map(t=>`<option value="${t}" ${t===state.theme?'selected':''}>${t}</option>`).join('')}</select>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="small" id="requiredNote" style="display:none;color:var(--accent)">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.</div>
  `;
  showModal(modal);

  document.getElementById('uploadAvatarBtn').addEventListener('click', ()=> fileProfileAvatar.click());

  fileProfileAvatar.onchange = async function(e){
    const f = e.target.files[0]; if(!f) return;
    const b64 = await fileToBase64(f);
    document.getElementById('avatarPreviewSmall').src = b64;
    document.getElementById('avatarPreviewSmall').dataset.b64 = b64;
  };

  document.getElementById('saveSettings').addEventListener('click', ()=>{
    const name = document.getElementById('profileName').value.trim();
    const surname = document.getElementById('profileSurname').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const city = document.getElementById('citySelect').value;
    const theme = document.getElementById('themeSelect').value;
    const avatarB64 = document.getElementById('avatarPreviewSmall').dataset ? document.getElementById('avatarPreviewSmall').dataset.b64 : null;
    if(!name || !surname){
      document.getElementById('requiredNote').style.display='block';
      alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
      return;
    }
    state.user = state.user || {};
    state.user.name = name;
    state.user.surname = surname;
    state.user.phone = phone;
    if(avatarB64) state.user.avatar = avatarB64;
    state.city = city;
    state.theme = theme;
    applyTheme(theme);
    updateDateButton();
    requestSave();
    hideModal();
    renderAll();
  });
}

/* ---------- File to base64 ---------- */
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = ()=> res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

/* ---------- Order modal with attach via file input ---------- */
function openOrderModal(){
  const services = ['GiD –ó–∞–∫–∞–∑','–ö–≤–∞—Ä—Ç–∏—Ä–∞/–¥–æ–º','–¢–∞–∫—Å–∏','–ö—É—Ä—å–µ—Ä','–ú–∞—Å—Ç–µ—Ä/—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'];
  const modal = `
    <div class="h">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</div>
    <label>–£—Å–ª—É–≥–∞</label><select id="orderService">${services.map(s=>`<option>${s}</option>`).join('')}</select>
    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="orderDesc" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É"></textarea>
    <div style="display:flex;gap:8px">
      <div style="flex:1"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="orderDeadline"></div>
      <div style="width:120px"><label>–ë—é–¥–∂–µ—Ç (‚Ç∏)</label><input type="number" id="orderBudget" min="0" value="0"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button class="btn" id="attachOrderBtn">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <div id="orderAttachPreview"></div>
    </div>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="createOrder">–ó–∞–∫–∞–∑–∞—Ç—å</button></div>
  `;
  showModal(modal);
  document.getElementById('attachOrderBtn').addEventListener('click', ()=> fileOrderAttach.click());
  fileOrderAttach.onchange = async function(e){
    const f = e.target.files[0]; if(!f) return;
    const b64 = await fileToBase64(f);
    const p = document.getElementById('orderAttachPreview');
    p.innerHTML = `<img src="${b64}" style="width:72px;height:72px;border-radius:8px;object-fit:cover">`;
    p.dataset.b64 = b64;
  };
  document.getElementById('createOrder').addEventListener('click', ()=>{
    const svc = document.getElementById('orderService').value;
    const desc = document.getElementById('orderDesc').value.trim();
    const deadline = document.getElementById('orderDeadline').value;
    const budget = document.getElementById('orderBudget').value;
    const image = document.getElementById('orderAttachPreview').dataset ? document.getElementById('orderAttachPreview').dataset.b64 : null;
    if(!desc) return alert('–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É');
    const order = {id:Date.now(), svc, desc, deadline, budget, city: state.city, created: new Date().toISOString(), image};
    state.servicesPosts.unshift(order);
    addNotification('–°–æ–∑–¥–∞–Ω–∞ –∑–∞—è–≤–∫–∞: ' + svc);
    requestSave();
    hideModal();
    alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–æ—Ç–æ—Ç–∏–ø).');
  });
}

/* ---------- Reserve modal (make button visually wider: done via gold styling) ---------- */
function openReserveModal(){
  const modal = `<div class="h">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</div><div class="small">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∫ GiDCity</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
}

/* ---------- Ads modal ---------- */
function openAdsModal(){
  const cats = ['–í–∞–∫–∞–Ω—Å–∏–∏','–ë–∏–∑–Ω–µ—Å','–ê–∫—Ü–∏–∏','–ê—Ñ–∏—à–∞','–¢–æ–≤–∞—Ä—ã','–ü—Ä–æ–¥—É–∫—Ç—ã'];
  const modal = `<div class="h">–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥</div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="adsCat">${cats.map(c=>`<option>${c}</option>`).join('')}</select><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="adsTitle" type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"><label>–¢–µ–∫—Å—Ç</label><textarea id="adsText" placeholder="–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è"></textarea><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="publishAds">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('publishAds').addEventListener('click', ()=>{
    const cat = document.getElementById('adsCat').value;
    const title = document.getElementById('adsTitle').value.trim();
    const text = document.getElementById('adsText').value.trim();
    if(!title || !text) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
    const authorName = state.user ? `${state.user.name} ${state.user.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    const authorAvatar = state.user && state.user.avatar ? state.user.avatar : null;
    const post = {id:Date.now(), cat, title, text, created:new Date().toISOString(), authorName, authorAvatar, comments:[], likes:0};
    state.cityPosts.unshift(post);
    requestSave();
    addNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ' + title);
    hideModal();
  });
}

/* ---------- City chat modal with like/comment/repost and image attach ---------- */
function openCityChatModal(){
  const postsHtml = state.cityPosts.map(p=>{
    const author = p.authorName || (state.user ? `${state.user.name} ${state.user.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º');
    const avatar = p.authorAvatar || (state.user && state.user.avatar ? state.user.avatar : 'https://via.placeholder.com/36/333/fff?text=U');
    const imgHtml = p.image ? `<img src="${p.image}" class="post-image" style="max-width:100%;border-radius:8px;margin-top:8px">` : '';
    const likes = p.likes || 0;
    const commentsCount = (p.comments && p.comments.length) || 0;
    return `<div class="post" data-id="${p.id}">
      <div class="post-author"><img src="${avatar}" alt="avatar"><div><div style="font-weight:900">${escapeHtml(author)}</div><div class="meta">${new Date(p.created).toLocaleString()}</div></div></div>
      <div>${escapeHtml(p.text || (p.title||''))}</div>
      ${imgHtml}
      <div class="post-actions">
        <button class="act-btn like-btn" data-id="${p.id}">‚ù§ <span class="like-count">${likes}</span></button>
        <button class="act-btn comment-btn" data-id="${p.id}">üí¨ <span class="comment-count">${commentsCount}</span></button>
        <button class="act-btn repost-btn" data-id="${p.id}">‚§¥Ô∏é –†–µ–ø–æ—Å—Ç</button>
      </div>
      <div class="comment-list" id="comments-${p.id}" style="display:${commentsCount? 'block':'none'}">
        ${(p.comments||[]).map(c=>`<div class="comment"><div style="font-weight:800">${escapeHtml(c.author)}</div><div class="small">${escapeHtml(c.text)}</div></div>`).join('')}
      </div>
    </div>`;
  }).join('') || '<div class="small">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞—è</div>';

  const modal = `<div class="h">City —á–∞—Ç ‚Äî ${state.city}</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <div style="width:44px;height:44px;border-radius:10px;background:var(--glass-bg);display:flex;align-items:center;justify-content:center">
        <div style="font-weight:800;color:var(--muted)">${state.user && state.user.name ? state.user.name[0].toUpperCase() : 'U'}</div>
      </div>
      <input id="cityPostText" type="text" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å..." style="flex:1">
      <button class="btn" id="attachImgBtn">üìé</button>
    </div>
    <div id="attachedPreview" style="margin-bottom:8px"></div>
    <div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="publishCityPost">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
    <div style="height:10px"></div>
    <div class="list" id="cityPostsList">${postsHtml}</div>
  `;
  showModal(modal);

  // attach image
  document.getElementById('attachImgBtn').addEventListener('click', ()=> fileChatAttach.click());
  fileChatAttach.onchange = async function(e){
    const f = e.target.files[0]; if(!f) return;
    const b64 = await fileToBase64(f);
    const p = document.getElementById('attachedPreview');
    p.innerHTML = `<img src="${b64}" style="max-width:120px;border-radius:8px">`;
    p.dataset.b64 = b64;
  };

  // publish
  document.getElementById('publishCityPost').addEventListener('click', ()=>{
    const text = document.getElementById('cityPostText').value.trim();
    const image = document.getElementById('attachedPreview').dataset ? document.getElementById('attachedPreview').dataset.b64 : null;
    if(!text && !image) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const authorName = state.user ? `${state.user.name} ${state.user.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    const authorAvatar = state.user && state.user.avatar ? state.user.avatar : null;
    const post = {id:Date.now(), text, image, created:new Date().toISOString(), authorName, authorAvatar, likes:0, comments:[]};
    state.cityPosts.unshift(post);
    requestSave();
    addNotification('–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ City —á–∞—Ç–µ');
    // insert live at top
    const list = document.getElementById('cityPostsList');
    const newHtml = `<div class="post" data-id="${post.id}"><div class="post-author"><img src="${post.authorAvatar||'https://via.placeholder.com/36/333/fff?text=U'}"><div><div style="font-weight:900">${escapeHtml(post.authorName)}</div><div class="meta">${new Date(post.created).toLocaleString()}</div></div></div><div>${escapeHtml(post.text)}</div>${post.image?`<img src="${post.image}" class="post-image" style="max-width:100%;border-radius:8px;margin-top:8px">`:''}<div class="post-actions"><button class="act-btn like-btn" data-id="${post.id}">‚ù§ <span class="like-count">0</span></button><button class="act-btn comment-btn" data-id="${post.id}">üí¨ <span class="comment-count">0</span></button><button class="act-btn repost-btn" data-id="${post.id}">‚§¥Ô∏é –†–µ–ø–æ—Å—Ç</button></div><div class="comment-list" id="comments-${post.id}" style="display:none"></div></div>`;
    list.insertAdjacentHTML('afterbegin', newHtml);
    // bind actions for new post
    bindPostActions(post.id);
    // clear inputs
    document.getElementById('cityPostText').value='';
    const prev = document.getElementById('attachedPreview'); if(prev){ prev.innerHTML=''; delete prev.dataset.b64; }
  });

  // bind existing posts
  (state.cityPosts || []).forEach(p => bindPostActions(p.id));
}

/* bind like/comment/repost for given post id (works for both existing inserted posts and new) */
function bindPostActions(postId){
  const container = modalWindow.querySelector(`.post[data-id="${postId}"]`);
  if(!container) return;
  const likeBtn = container.querySelector('.like-btn');
  const commentBtn = container.querySelector('.comment-btn');
  const repostBtn = container.querySelector('.repost-btn');

  if(likeBtn) likeBtn.addEventListener('click', ()=>{
    const post = state.cityPosts.find(p=>String(p.id)===String(postId));
    if(!post) return;
    post.likes = (post.likes || 0) + 1;
    likeBtn.querySelector('.like-count').textContent = post.likes;
    requestSave();
  });

  if(commentBtn) commentBtn.addEventListener('click', ()=>{
    openCommentsModal(postId);
  });

  if(repostBtn) repostBtn.addEventListener('click', ()=>{
    // choose contact (simple prompt)
    const contacts = (state.chats || []).map(c=>c.name || c.contact).filter(Boolean);
    if(contacts.length === 0){ alert('–£ –≤–∞—Å –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è —Ä–µ–ø–æ—Å—Ç–∞'); return; }
    const chosen = prompt('–ö–æ–º—É —Ä–µ–ø–æ—Å—Ç–∏—Ç—å? –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–∑ –≤–∞—à–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:\n' + contacts.join('\n'));
    if(!chosen) return;
    // simulate repost by adding a message to that contact's chat (or create)
    let chat = state.chats.find(c=> (c.name === chosen || c.contact === chosen) );
    if(!chat){
      chat = {id:Date.now(), name:chosen, messages:[]};
      state.chats.unshift(chat);
    }
    const post = state.cityPosts.find(p=>String(p.id)===String(postId));
    const message = {name: state.user ? `${state.user.name} ${state.user.surname||''}`.trim() : '–í—ã', text: `–†–µ–ø–æ—Å—Ç: ${post.text}`, ts: new Date().toISOString(), image: post.image || null, avatar: state.user && state.user.avatar ? state.user.avatar : null};
    chat.messages = chat.messages || [];
    chat.messages.push(message);
    requestSave();
    alert('–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç: ' + chosen);
  });
}

/* comments modal: show list, allow reply (threaded flat) */
function openCommentsModal(postId){
  const post = state.cityPosts.find(p=>String(p.id)===String(postId));
  if(!post) return;
  const existing = (post.comments || []).map(c=>`<div class="comment"><div style="font-weight:800">${escapeHtml(c.author)}</div><div class="small">${escapeHtml(c.text)}</div></div>`).join('') || '<div class="small">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
  const modal = `<div class="h">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div><div style="max-height:320px;overflow:auto">${existing}</div><label>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="commentText" type="text"><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button><button class="btn primary" id="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('sendComment').addEventListener('click', ()=>{
    const txt = document.getElementById('commentText').value.trim();
    if(!txt) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
    const author = state.user ? `${state.user.name} ${state.user.surname||''}`.trim() : '–ê–Ω–æ–Ω–∏–º';
    post.comments = post.comments || [];
    post.comments.push({author, text: txt, ts: new Date().toISOString()});
    requestSave();
    hideModal();
    openCityChatModal(); // reopen chat modal to show updated comments
  });
}

/* ---------- Messenger modal + chat view (unchanged behavior, added file attach) ---------- */
function openMessengerModal(){
  const chatsHtml = (state.chats || []).map(c=>`<div class="post" data-chat-id="${c.id}" style="display:flex;gap:8px;align-items:center"><img src="${c.avatar||'https://via.placeholder.com/44/333/fff?text=C'}" style="width:44px;height:44px;border-radius:8px;object-fit:cover"><div style="flex:1"><div style="font-weight:900">${escapeHtml(c.name||c.contact||'–ö–æ–Ω—Ç–∞–∫—Ç')}</div><div class="small">${escapeHtml(c.last||'')}</div></div></div>`).join('') || '<div class="small">–°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –ø—É—Å—Ç</div>';
  const modal = `<div class="h">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div><div style="display:flex;gap:8px;margin-bottom:10px"><button class="btn" id="openContacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button><button class="btn" id="createChat">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button></div><div class="list" id="chatsList">${chatsHtml}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
  document.getElementById('openContacts').addEventListener('click', ()=> {
    const contacts = (state.chats||[]).map(c=>c.name || c.contact).filter(Boolean);
    const html = contacts.length ? contacts.map(c=>`<div class="post"><div class="meta">${escapeHtml(c)}</div></div>`).join('') : '<div class="small">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–µ—Ç</div>';
    showModal(`<div class="h">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="list">${html}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  });
  document.getElementById('createChat').addEventListener('click', ()=>{
    const name = prompt('–ò–º—è / –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞:');
    if(!name) return;
    state.chats.unshift({id:Date.now(), name, messages:[], avatar: null, last:''});
    requestSave();
    hideModal();
    openMessengerModal();
  });
  // click chat to open
  document.querySelectorAll('#chatsList [data-chat-id]').forEach(el=> el.addEventListener('click', ()=> {
    const id = el.dataset.chatId;
    openChatWindow(id);
  }));
}

function openChatWindow(chatId){
  const chat = state.chats.find(c=>String(c.id)===String(chatId));
  if(!chat) return alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const messagesHtml = (chat.messages || []).map(m=>`<div class="post"><div class="post-author"><img src="${m.avatar||'https://via.placeholder.com/36/333/fff?text=U'}"><div><div style="font-weight:800">${escapeHtml(m.name||'')}</div><div class="meta">${new Date(m.ts).toLocaleString()}</div></div></div><div>${escapeHtml(m.text||'')}</div>${m.image?`<img src="${m.image}" class="post-image" style="max-width:100%;border-radius:8px;margin-top:8px">`:''}</div>`).join('') || '<div class="small">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  const modal = `<div class="h">${escapeHtml(chat.name||chat.contact)}</div><div class="list" id="chatMessages">${messagesHtml}</div><div style="display:flex;gap:8px;align-items:center"><input id="chatMsgText" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1"><button class="btn" id="attachMsgBtn">üìé</button><button class="btn primary" id="sendMsgBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div><div id="msgAttachPreview" style="margin-top:8px"></div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);

  document.getElementById('attachMsgBtn').addEventListener('click', ()=> fileMessageAttach.click());
  fileMessageAttach.onchange = async e => {
    const f = e.target.files[0]; if(!f) return;
    const b64 = await fileToBase64(f);
    const p = document.getElementById('msgAttachPreview');
    p.innerHTML = `<img src="${b64}" style="max-width:120px;border-radius:8px">`;
    p.dataset.b64 = b64;
  };
  document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
    const text = document.getElementById('chatMsgText').value.trim();
    const image = document.getElementById('msgAttachPreview').dataset ? document.getElementById('msgAttachPreview').dataset.b64 : null;
    if(!text && !image) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const message = {name: state.user ? `${state.user.name} ${state.user.surname||''}`.trim() : '–í—ã', text, ts: new Date().toISOString(), avatar: state.user && state.user.avatar ? state.user.avatar : null, image};
    chat.messages = chat.messages || [];
    chat.messages.push(message);
    chat.last = text || (image ? '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '');
    requestSave();
    // append
    const list = document.getElementById('chatMessages');
    list.insertAdjacentHTML('beforeend', `<div class="post"><div class="post-author"><img src="${message.avatar||'https://via.placeholder.com/36/333/fff?text=U'}"><div><div style="font-weight:800">${escapeHtml(message.name)}</div><div class="meta">${new Date(message.ts).toLocaleString()}</div></div></div><div>${escapeHtml(message.text)}</div>${message.image?`<img src="${message.image}" class="post-image" style="max-width:100%;border-radius:8px;margin-top:8px">`:''}</div>`);
    document.getElementById('chatMsgText').value='';
    const p = document.getElementById('msgAttachPreview'); if(p){ p.innerHTML=''; delete p.dataset.b64; }
  });
}

/* ---------- Find jobs modal ---------- */
function openFindJobsModal(){
  const jobsHtml = (state.servicesPosts || []).map(o=>`<div class="post"><div class="meta">${escapeHtml(o.svc)} ¬∑ ${escapeHtml(o.deadline||'')}</div><div style="font-weight:900">${escapeHtml(o.desc||'')}</div><div class="small">–ë—é–¥–∂–µ—Ç ${escapeHtml(String(o.budget||0))} ‚Ç∏</div>${o.image?`<img src="${o.image}" style="max-width:100%;border-radius:8px;margin-top:8px">`:''}<div style="margin-top:8px"><button class="btn" onclick="applyJob(${o.id})">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button></div></div>`).join('') || '<div class="small">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
  const modal = `<div class="h">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã</div><div class="list">${jobsHtml}</div><div class="modal-actions"><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(modal);
}
window.applyJob = function(orderId){
  const budget = prompt('–í–∞—à –±—é–¥–∂–µ—Ç (‚Ç∏):','0');
  const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:','');
  const order = state.servicesPosts.find(o=>String(o.id)===String(orderId));
  if(!order) return alert('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  addNotification(`–û—Ç–∫–ª–∏–∫ –Ω–∞ –∑–∞—è–≤–∫—É ${order.svc}: ${budget}‚Ç∏ ‚Äî ${comment}`);
  requestSave();
  hideModal();
  alert('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¥–µ–º–æ).');
};

/* ---------- notifications ---------- */
function addNotification(text, meta={}){
  state.notifications.unshift({id:Date.now(), text, meta, ts:new Date().toISOString()});
  requestSave();
  renderNotifCount();
}
function renderNotifCount(){ document.getElementById('notifCount').textContent = state.notifications.length || 0; }
document.getElementById('openNotifs').addEventListener('click', ()=> {
  const list = (state.notifications||[]).map(n=>`<div class="post"><div class="meta">${new Date(n.ts).toLocaleString()}</div><div>${escapeHtml(n.text)}</div></div>`).join('') || '<div class="small">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
  showModal(`<div class="h">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div class="list">${list}</div><div class="modal-actions"><button class="btn" id="clearNotifs">–û—á–∏—Å—Ç–∏—Ç—å</button><button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  document.getElementById('clearNotifs').addEventListener('click', ()=>{ state.notifications=[]; requestSave(); hideModal(); renderNotifCount(); });
});

/* ---------- Auth ---------- */
document.getElementById('authSubmit').addEventListener('click', ()=>{
  const name = document.getElementById('authName').value.trim();
  const phone = document.getElementById('authPhone').value.trim();
  const pin = document.getElementById('authPIN').value.trim();
  if(!name || !phone || !/^\d{4}$/.test(pin)) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ 4-–∑–Ω–∞—á–Ω—ã–π PIN');
  state.user = state.user || {};
  state.user.name = name; state.user.phone = phone; state.user.pin = pin;
  requestSave();
  authBackdrop.style.display='none';
  // if surname missing -> open settings
  if(!state.user.surname) setTimeout(()=>openSettingsModal(true), 300);
  renderAll();
});
document.getElementById('authSkip').addEventListener('click', ()=> { authBackdrop.style.display='none'; renderAll(); });

/* ---------- helpers ---------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ---------- Bind file inputs for global usage (profile upload stored earlier in settings) ---------- */
fileProfileAvatar.onchange = async (e)=> {
  const f = e.target.files[0]; if(!f) return;
  const b64 = await fileToBase64(f);
  state.user = state.user || {};
  state.user.avatar = b64;
  requestSave();
  document.getElementById('avatarPreview').innerHTML = `<img src="${b64}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`;
};

/* Bind initial events for header buttons */
document.getElementById('settingsBtn').addEventListener('click', ()=> openSettingsModal(false));
document.getElementById('servicesBtn').addEventListener('click', ()=> { document.getElementById('servicesBtn').classList.add('active'); document.getElementById('workBtn').classList.remove('active'); renderMenu(); });
document.getElementById('workBtn').addEventListener('click', ()=> { document.getElementById('workBtn').classList.add('active'); document.getElementById('servicesBtn').classList.remove('active'); renderMenu(); });

/* ---------- init ---------- */
(async function init(){
  loadStateLocal();
  // try load remote state first to enable multi-users view
  if(USE_JSONBIN){
    try{ await loadFromJSONBin(); console.log('state loaded from JSONBin'); }catch(e){ console.info('no remote or error, using local'); }
  }
  // apply theme and render
  applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π');
  document.getElementById('cityName').textContent = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞';
  updateDateButton();
  renderNotifCount();
  renderMenu();
  // initial weather fetch
  fetchWeather(state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞');

  // greeting animation: show for 1.5s only at startup in header greeting (we replaced greeting with date; so show quickly on load as alert overlay)
  // Instead: briefly flash the subtitle
  const subtitle = document.getElementById('subtitle');
  const old = subtitle.textContent;
  subtitle.textContent = 'GiDCity-“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!';
  setTimeout(()=>{ subtitle.textContent = old; }, 1500);

  // bind existing posts actions if city chat modal opened later (will bind on modal open)
  // ensure avatar preview if exists
  if(state.user && state.user.avatar) document.getElementById('avatarPreview').innerHTML = `<img src="${state.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`;

  // apply card coloring rules per request: ensure some buttons are gold or green via renderMenu (done)
})();

/* ---------- small utility: bind post actions when modal exists (called inside openCityChatModal) ---------- */
/* already implemented in bindPostActions function */

/* ---------- Ensure themes dropdown changes in settings apply (handled in settings saving) ---------- */
function renderAll(){ renderMenu(); document.getElementById('cityName').textContent = state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'; applyTheme(state.theme || '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á–µ—Ä–Ω—ã–π'); fetchWeather(state.city || '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'); renderNotifCount(); }

/* ---------- Expose requestSave for console debugging ---------- */
window.requestSave = requestSave;

</script>
</body>
</html>