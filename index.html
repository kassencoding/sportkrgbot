<!doctype html>
<html lang="ru" data-theme="violet">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiDCity ‚Äî –æ–±–ª–∞–∫–æ, —Ä–æ–ª–∏, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ================= TOKENS / THEMES ================= */
:root{
  --bg-1:#060910; --bg-2:#050815; --bg-3:#030711;
  --radial-a:#121a3a; --radial-b:#09203a;
  --surface:#0b1020; --line:#1a2346;
  --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff;
  --danger:#ff4d6d; --gold:#ffd84d;
  --text:#e7ebff; --text-dim:#c7d3ff; --text-muted:#9fb0ff; --text-invert:#0a0f1e;
  --radius:16px; --ui-font-size:14px;
  --glow-1:0 0 14px rgba(169,112,255,.45); --glow-2:0 0 22px rgba(50,255,210,.35); --shadow:0 18px 50px rgba(0,0,0,.55);
  --btn-press: 0 0 0 6px rgba(169,112,255,.18);
}

html[data-theme="violet"]{
  --accent-a:#a970ff; --accent-b:#32ffd2; --accent-c:#6a8cff;
  --bg-1:#0a0f24; --bg-2:#090e22; --bg-3:#070c20;
  --radial-a:#201c52; --radial-b:#0f2446;
  --text:#e7ebff; --text-invert:#0a0f1e;
}

html[data-theme="navy"]{
  --accent-a:#6aa7ff; --accent-b:#7ef3ff; --accent-c:#65d0ff;
  --bg-1:#07101e; --bg-2:#071426; --bg-3:#07182e;
  --radial-a:#0e2a4c; --radial-b:#0a3152;
  --text:#e7f2ff; --text-invert:#06101d;
}

html[data-theme="emerald"]{
  --accent-a:#3fe0a8; --accent-b:#baff6a; --accent-c:#75ffd9;
  --bg-1:#071a14; --bg-2:#051f17; --bg-3:#04241a;
  --radial-a:#0d3c2d; --radial-b:#0a503a;
  --text:#eafff7; --text-invert:#05120e;
}

/* ‚Äî –Ω–æ–≤—ã–µ —Ç—ë–ø–ª—ã–µ/—è—Ä–∫–∏–µ ‚Äî */
html[data-theme="sunset"]{
  --accent-a:#ff7ab6; --accent-b:#ffd06a; --accent-c:#ff9f6a;
  --bg-1:#1b0a12; --bg-2:#200d16; --bg-3:#240f18;
  --radial-a:#551a2c; --radial-b:#66331e;
  --text:#ffeef6; --text-invert:#1a0a10;
}
html[data-theme="lava"]{
  --accent-a:#ff5a37; --accent-b:#ffc34d; --accent-c:#ff7a5c;
  --bg-1:#120707; --bg-2:#1a0a08; --bg-3:#210d0a;
  --radial-a:#4a1410; --radial-b:#5a1a12;
  --text:#fff2ec; --text-invert:#160806;
}
html[data-theme="ocean"]{
  --accent-a:#44e1ff; --accent-b:#68ffa9; --accent-c:#7bd7ff;
  --bg-1:#041319; --bg-2:#051720; --bg-3:#061c27;
  --radial-a:#093747; --radial-b:#0b4558;
  --text:#e9fbff; --text-invert:#031116;
}

/* ‚Äî —Å–≤–µ—Ç–ª—ã–µ —Ç–µ–º—ã: —Ç–µ–∫—Å—Ç —Ç—ë–º–Ω—ã–π ‚Äî */
html[data-theme="paper"]{
  --accent-a:#6b7cff; --accent-b:#51d6a6; --accent-c:#8aa8ff;
  --bg-1:#f6f7fb; --bg-2:#f4f6fb; --bg-3:#f1f4fa;
  --radial-a:#ffffff; --radial-b:#ffffff;
  --surface:#ffffff; --line:#dbe1ff;
  --text:#0d1326; --text-dim:#2a3a5f; --text-muted:#51618f; --text-invert:#f7f9ff;
}
html[data-theme="cream"]{
  --accent-a:#ff8aa0; --accent-b:#ffd26a; --accent-c:#ffaf6d;
  --bg-1:#fff8ee; --bg-2:#fff4e6; --bg-3:#fff1df;
  --radial-a:#ffffff; --radial-b:#ffffff;
  --surface:#ffffff; --line:#f0e2c8;
  --text:#2b1a10; --text-dim:#4a2f1f; --text-muted:#6a4a30; --text-invert:#fff7ea;
}

/* ================= RESET / LAYOUT ================= */
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; padding:18px; font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:
    radial-gradient(1200px 800px at 20% -10%, var(--radial-a) 0%, transparent 55%),
    radial-gradient(1000px 700px at 120% 20%, var(--radial-b) 0%, transparent 55%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2) 40%, var(--bg-3) 100%);
  color:var(--text); font-size:var(--ui-font-size); display:flex; justify-content:center;
}
.wrapper{ width:100%; max-width:1100px; display:flex; flex-direction:column; gap:16px; }

/* ================= HEADER ================= */
.header{ display:grid; grid-template-columns: 1fr auto; align-items:start; gap:12px; padding:6px 4px 4px; }
.brand{ display:flex; flex-direction:column; gap:4px; }
.brand h1{
  margin:0; font-weight:800; font-size:22px; letter-spacing:.4px;
  background: linear-gradient(90deg, var(--text) 0%, var(--accent-a) 55%, var(--accent-b) 100%);
  -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow: 0 0 24px rgba(169,112,255,.25);
}
.header-sub{ font-size:13px; color:var(--text-muted); font-weight:700 }
.header-right{ display:flex; flex-direction:column; gap:10px; align-items:flex-end; }
.controls-row{ display:flex; gap:8px }

/* ================= BUTTONS ================= */
.btn{
  appearance:none; border:none; cursor:pointer; font-weight:700; color:var(--text);
  padding:10px 14px; border-radius:12px; line-height:1;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.22));
  border:1px solid rgba(138,165,255,.22);
  box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,.03);
  transition: transform .12s ease, box-shadow .2s, background .2s;
}
.btn:hover{ box-shadow: var(--glow-1), var(--shadow); transform: translateY(-1px) }
.btn:active{ transform: translateY(0); box-shadow: var(--btn-press), var(--shadow) }
.btn.primary{ background: linear-gradient(90deg, rgba(169,112,255,.28), rgba(50,255,210,.28)); border-color: rgba(169,112,255,.5); box-shadow: var(--glow-1), var(--glow-2), var(--shadow) }
.btn.ghost{ background: transparent; border-color: rgba(138,165,255,.25) }
.btn.disabled{ opacity:.6; pointer-events:none; filter:saturate(.8) }
.btn.pulse:active{ box-shadow: 0 0 0 10px rgba(169,112,255,.12), var(--shadow) }

/* ================= ROLE TOGGLE (–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π —à–∞—Ä) ================= */
.role-switch{ display:flex; gap:10px; align-items:center; font-weight:700; color:var(--text-dim); justify-self:end }
.role-label{ font-weight:800; transition:color .2s }
.role-label.active{ color:var(--gold) }
.toggle{
  width:74px; height:36px; border-radius:999px; padding:3px; position:relative; cursor:pointer;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18)); border:1px solid rgba(138,165,255,.28);
  box-shadow: inset 0 2px 0 rgba(255,255,255,.06), inset 0 -3px 0 rgba(0,0,0,.2);
}
.toggle .knob{
  width:30px; height:30px; border-radius:999px; position:absolute; top:3px; left:3px; transition:left .18s ease, box-shadow .2s;
  background: radial-gradient(40% 40% at 35% 30%, #ffffff 0%, #e6eefc 35%, #b2c4e6 70%, #8799bb 90%),
              radial-gradient(80% 80% at 70% 70%, rgba(255,255,255,.7), rgba(255,255,255,0));
  box-shadow: 0 10px 18px rgba(0,0,0,.45), 0 0 12px rgba(169,112,255,.35);
}
.toggle.on .knob{ left:41px }

/* ================= MAIN CONTAINER & MENU ================= */
.container{
  width:100%; border-radius:20px; padding:18px;
  background: linear-gradient(180deg, rgba(14,20,46,.72), rgba(10,15,35,.42));
  border:1px solid var(--line); box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,.02) inset; color:var(--text);
}
.panel-top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:14px }
.panel-top h2{ margin:0; font-size:18px; font-weight:800; color:var(--text) }

.menu-grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
}
@media (min-width:900px){
  .menu-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
}
.menu-btn{
  min-height:64px; border-radius:14px; padding:14px 16px; cursor:pointer;
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.22));
  border:1px solid rgba(138,165,255,.22);
  display:flex; flex-direction:column; gap:6px; justify-content:center; align-items:flex-start;
  transition: transform .14s, box-shadow .14s, border-color .2s;
  box-shadow: var(--shadow);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.menu-btn .title{ font-weight:800; font-size:15px; color:var(--text); text-transform:uppercase }
.menu-btn .note{ font-size:12px; color:var(--text-muted); white-space:normal }
.menu-btn:hover{ transform: translateY(-2px); box-shadow: var(--glow-1), var(--shadow); border-color: rgba(169,112,255,.42) }
.menu-btn:active{ transform:translateY(0); box-shadow: var(--btn-press), var(--shadow) }
.menu-btn.primary{ background: linear-gradient(135deg, rgba(169,112,255,.18), rgba(50,255,210,.14)); border-color: rgba(169,112,255,.6); box-shadow: var(--glow-1), var(--glow-2), var(--shadow) }
.menu-btn.violet{ background: linear-gradient(135deg, rgba(169,112,255,.24), rgba(106,140,255,.16)); border-color: rgba(138,165,255,.5); box-shadow: var(--glow-1), var(--shadow) }

/* ================= CARDS / LISTS ================= */
.card{
  background: linear-gradient(180deg, rgba(10,14,30,.92), rgba(6,10,24,.88));
  color:var(--text); border-radius:14px; padding:12px; display:flex; gap:12px; align-items:flex-start;
  border:1px solid rgba(138,165,255,.22); box-shadow: var(--shadow);
}
.avatar{ width:40px; height:40px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; overflow:hidden; flex:0 0 40px }
.avatar img{ width:100%; height:100%; object-fit:cover; border-radius:999px }

/* ================= SCREENS / MODALS ================= */
.screen{
  position:fixed; inset:0; display:none; z-index:140; padding:0 12px; background: rgba(6,9,16,.64);
  align-items:flex-start; justify-content:center; backdrop-filter: blur(6px);
}
.screen.active{ display:flex }
.modal{
  width:100%; max-width:1100px; max-height:86vh; overflow:auto;
  background: linear-gradient(180deg, rgba(18,26,56,.98), rgba(12,18,42,.96));
  color:var(--text); box-shadow: var(--glow-1), var(--shadow); border:1px solid rgba(138,165,255,.28);
  border-radius:0 0 18px 18px; padding:18px 16px; margin-top:12px;
}

/* ================= INPUTS ================= */
.input, textarea, select{
  width:100%; padding:12px; border-radius:12px; border:1px solid rgba(138,165,255,.24);
  background: rgba(12,16,36,.9); color:var(--text); font-size:14px; outline:none;
  transition: box-shadow .2s, border-color .2s, background .2s;
}
textarea{ min-height:110px; resize:vertical }
.input::placeholder, textarea::placeholder{ color:rgba(184,194,255,.6) }
.input:focus, textarea:focus, select:focus{ border-color: rgba(169,112,255,.6); box-shadow: 0 0 0 3px rgba(169,112,255,.18), var(--glow-1); background: rgba(16,20,46,.95) }
.small{ font-size:13px; color:var(--text-muted) }

/* ================= TABS ================= */
.tabs{ display:flex; gap:8px; flex-wrap:wrap }
.tab{
  padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; border:1px solid rgba(138,165,255,.25);
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.16)); color:var(--text)
}
.tab:hover{ box-shadow: var(--glow-1) }
.tab.active{ background: linear-gradient(90deg, rgba(169,112,255,.32), rgba(50,255,210,.24)); border-color: rgba(169,112,255,.6); box-shadow: var(--glow-1), var(--glow-2) }

/* ================= CHAT ================= */
.chat-item{ position:relative; cursor:pointer }
.chat-badge{ margin-left:auto; background:var(--danger); color:#fff; border-radius:999px; font-size:12px; font-weight:800; padding:0 6px; min-width:18px; height:18px; display:flex; align-items:center; justify-content:center }
.chat-modal-header{ display:flex; gap:10px; align-items:center; }
.msgs{ margin-top:8px; max-height:58vh; overflow:auto; padding-right:6px }
.msg-row{ margin-bottom:10px }
.msg-me{ text-align:right }
.msg-me .b{ display:inline-block; background:linear-gradient(90deg, rgba(169,112,255,.95), rgba(50,255,210,.95)); padding:8px 12px; border-radius:10px; color:#0a0f1e; font-weight:800 }
.msg-other .b{ display:inline-block; background:rgba(255,255,255,.08); border:1px solid rgba(138,165,255,.24); padding:8px 12px; border-radius:10px }
.msg-system{ text-align:center; margin:10px 0 14px 0; color:var(--text-muted); font-size:13px }
.msg-img{ display:block; max-width:60%; border-radius:12px; margin-top:6px; border:1px solid rgba(138,165,255,.2) }

/* ================= CITY THREAD ================= */
.post-card{ background: linear-gradient(180deg, rgba(10,14,30,.92), rgba(6,10,24,.88)); border:1px solid rgba(138,165,255,.22); border-radius:14px; padding:12px; box-shadow: var(--shadow); margin-bottom:10px }
.post-img{ width:100%; border-radius:12px; margin-top:8px; max-height:360px; object-fit:cover }
.post-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
.comment{ background:rgba(255,255,255,.06); border:1px solid rgba(138,165,255,.22); border-radius:10px; padding:8px; margin-top:6px }

/* ================= CLICK FX ================= */
.btn, .menu-btn, .tab{
  position:relative;
}
.btn:focus-visible, .menu-btn:focus-visible, .tab:focus-visible{
  outline:none; box-shadow: 0 0 0 3px rgba(169,112,255,.25), var(--shadow);
}
.btn::after, .menu-btn::after{
  content:""; position:absolute; inset:0; border-radius:inherit; opacity:0; transition:opacity .15s;
  box-shadow: 0 0 24px rgba(169,112,255,.5), 0 0 18px rgba(50,255,210,.35) inset;
}
.btn:active::after, .menu-btn:active::after{ opacity:.35 }

/* ================= LIGHT THEMES VISUAL ================= */
html[data-theme="paper"] body,
html[data-theme="cream"] body{
  background:
    radial-gradient(1200px 800px at 20% -10%, var(--bg-2) 0%, transparent 55%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2) 40%, var(--bg-3) 100%);
}
html[data-theme="paper"] .container,
html[data-theme="cream"] .container{
  background: #ffffff; color: var(--text);
  border-color: var(--line);
}
html[data-theme="paper"] .modal,
html[data-theme="cream"] .modal{
  background:#ffffff; color:var(--text); border-color:var(--line);
}
html[data-theme="paper"] .input, html[data-theme="cream"] .input,
html[data-theme="paper"] textarea, html[data-theme="cream"] textarea,
html[data-theme="paper"] select, html[data-theme="cream"] select{
  background:#fff; color:var(--text); border-color:#d8e0f5;
}
html[data-theme="paper"] .menu-btn, html[data-theme="cream"] .menu-btn{
  background:#fff; border-color:#e6e9f6;
}
</style>
</head>
<body>
<div class="wrapper">
  <header class="header">
    <div class="brand">
      <h1>GiD <span style="color:var(--accent-a)">City</span></h1>
      <div id="topCity" class="header-sub">–ì–æ—Ä–æ–¥: ‚Äî</div>
    </div>
    <div class="header-right">
      <div class="controls-row">
        <button id="openNotifications" class="btn btn-with-badge">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifBadge" class="chat-badge" style="display:none">0</span></button>
        <button id="openSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
      <div class="role-switch">
        <span id="roleLabelUser" class="role-label">–°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥</span>
        <div id="roleToggle" class="toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–æ–ª—å"><div class="knob"></div></div>
        <span id="roleLabelWorker" class="role-label">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</span>
      </div>
    </div>
  </header>

  <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
  <main class="container" role="main" aria-live="polite">
    <div class="panel-top"><h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2><div></div></div>
    <div class="menu-grid" id="menuGrid"></div>
  </main>
</div>

<!-- ================= SCREENS ================= -->

<!-- –í—Ö–æ–¥ -->
<section id="authScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–í—Ö–æ–¥</h3><button onclick="closeScreen('authScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <form id="authForm" style="margin-top:12px">
    <div class="form-field"><input id="authLogin" class="input" placeholder="Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" required /></div>
    <div class="form-field" style="margin-top:8px"><input id="authPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password" required /></div>
    <div style="display:flex; gap:8px; margin-top:12px"><button type="submit" class="btn primary">–í–æ–π—Ç–∏</button><button type="button" id="registerBtn" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button></div>
    <div class="small" style="margin-top:10px">–î–µ–º–æ: –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ JSONBin</div>
  </form>
</div></section>

<!-- –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ -->
<section id="createScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3><button onclick="closeScreen('createScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div style="margin-top:10px;">
    <div class="tabs" id="createTabs">
      <div class="tab active" data-val="–°–ü–ï–¶. –ó–ê–ö–ê–ó">–°–ü–ï–¶. –ó–ê–ö–ê–ó</div>
      <div class="tab" data-val="–¢–∞–∫—Å–∏">–¢–∞–∫—Å–∏</div>
      <div class="tab" data-val="–ö—É—Ä—å–µ—Ä">–ö—É—Ä—å–µ—Ä</div>
      <div class="tab" data-val="–î–æ—Å—Ç–∞–≤–∫–∞">–î–æ—Å—Ç–∞–≤–∫–∞</div>
      <div class="tab" data-val="–ê—Ä–µ–Ω–¥–∞/–ü—Ä–æ–¥–∞–∂–∞">–ê—Ä–µ–Ω–¥–∞/–ü—Ä–æ–¥–∞–∂–∞</div>
      <div class="tab" data-val="–ú–∞—Å—Ç–µ—Ä">–ú–∞—Å—Ç–µ—Ä</div>
      <div class="tab" data-val="–ü—Ä–æ—á–∏–µ">–ü—Ä–æ—á–∏–µ</div>
    </div>
    <form id="createForm" style="margin-top:12px">
      <div class="form-field">
        <textarea id="c-desc" class="input" placeholder="–∑–∞–∫–∞–∂–∏ –ª—é–±—É—é —É—Å–ª—É–≥—É –∏ –º—ã –Ω–∞–π–¥–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"></textarea>
      </div>
      <div id="createExtraFields" class="form-field" style="margin-top:8px"></div>

      <!-- –¥–µ–¥–ª–∞–π–Ω —Å–≤–µ—Ä—Ö—É, —Ç–æ—Ç –∂–µ —Ä–∞–∑–º–µ—Ä, —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ -->
      <div class="col" style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <div style="flex:1; min-width:240px"><input id="c-datetime" class="input" type="datetime-local" placeholder="–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è" /></div>
        <div style="flex:1; min-width:240px"><input id="c-budget" class="input" type="number" placeholder="–ë—é–¥–∂–µ—Ç (‚Ç∏)" /></div>
      </div>

      <div style="display:flex; gap:12px; margin-top:14px; align-items:center">
        <button class="btn primary pulse" id="orderNowBtn" type="submit" style="min-width:240px; padding:14px 18px; font-size:15px; background:linear-gradient(90deg,#ffd84d,#ffb34d); color:#2b1a10; border-color:#ffd84d">–ó–ê–ö–ê–ó–ê–¢–¨</button>
        <button class="btn ghost" type="button" onclick="closeScreen('createScreen')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div></section>

<!-- –ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã -->
<section id="findScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´</h3><button onclick="closeScreen('findScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div style="margin-top:8px">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫...">
      <button id="applySearch" class="btn">–ü–æ–∏—Å–∫</button>
    </div>
    <div id="findList" class="list" style="margin-top:12px"></div>
  </div>
</div></section>

<!-- –ú–æ–∏ –∑–∞–∫–∞–∑—ã -->
<section id="mineScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3><button onclick="closeScreen('mineScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div style="margin-top:12px"><div id="mineList" class="list"></div></div>
</div></section>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∑–∞—è–≤–æ–∫ -->
<section id="bidsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 id="bidsModalTitle" style="margin:0">–ó–∞—è–≤–∫–∏</h3><button onclick="closeScreen('bidsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="bidsList" style="margin-top:12px"></div>
</div></section>

<!-- –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä -->
<section id="messengerScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3><button onclick="closeScreen('messengerScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="chatsList" style="margin-top:12px"></div>
</div></section>

<!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
<section id="chatWindow" class="screen"><div class="modal">
  <div class="chat-modal-header">
    <div id="chatWinAvatar" class="avatar"></div>
    <div style="font-weight:800" id="chatWinTitle">–ß–∞—Ç</div>
    <div class="small" id="chatWinSub" style="margin-left:auto"></div>
    <button onclick="closeScreen('chatWindow')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="chatWinMsgs" class="msgs"></div>
  <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
    <label class="btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="padding:10px 12px;">
      üìé
      <input type="file" id="chatAttach" accept="image/*" style="display:none">
    </label>
    <input id="chatWinInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="chatWinSend" class="btn primary" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div></section>

<!-- –û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ -->
<section id="adsScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h3 style="margin:0">–û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥</h3>
      <div style="margin-top:6px"><button id="myAdsOpenBtn" class="btn">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button></div>
    </div>
    <div style="display:flex; gap:8px;">
      <button onclick="closeScreen('adsScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <div style="margin-top:12px; display:flex; gap:12px; align-items:center; justify-content:space-between;">
    <div style="font-weight:800">–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
    <div><button id="createAdBtn" class="btn">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button></div>
  </div>
  <div id="adsList" class="list" style="margin-top:12px; max-height:60vh; overflow:auto"></div>
</div></section>

<section id="myAdsScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
    <button onclick="closeScreen('myAdsScreen'); openScreen('adsScreen');" class="btn ghost">–ù–∞–∑–∞–¥</button>
  </div>
  <div id="myAdsList" class="list" style="margin-top:8px; max-height:66vh; overflow:auto"></div>
</div></section>

<section id="adCreateModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3><button onclick="closeScreen('adCreateModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <form id="adForm" style="margin-top:12px">
    <div class="form-field"><input id="adTitle" class="input" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" required></div>
    <div class="form-field" style="margin-top:8px"><textarea id="adDesc" class="input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"></textarea></div>
    <div style="display:flex; gap:8px; margin-top:8px;"><input id="adPhone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"><input id="adPrice" class="input" placeholder="–¶–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></div>
    <div style="display:flex; gap:8px; margin-top:10px;"><button class="btn primary" type="submit">–°–æ–∑–¥–∞—Ç—å</button><button class="btn ghost" type="button" onclick="closeScreen('adCreateModal')">–û—Ç–º–µ–Ω–∞</button></div>
  </form>
</div></section>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<section id="notificationsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><button onclick="closeScreen('notificationsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="notificationsList" style="margin-top:12px; max-height:58vh; overflow:auto"></div>
  <div style="display:flex; gap:8px; margin-top:12px;"><button id="clearNotifications" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
</div></section>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<section id="settingsModal" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><button onclick="closeScreen('settingsModal')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div style="margin-top:10px">
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
      <button id="openThemes" class="btn">–¢–µ–º—ã</button>
      <select id="citySelect" class="input" style="max-width:260px">
        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî</option>
        <option>–ê–ª–º–∞—Ç—ã</option><option>–ê—Å—Ç–∞–Ω–∞</option><option>–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</option><option>–®—ã–º–∫–µ–Ω—Ç</option><option>–ê–∫—Ç–æ–±–µ</option>
      </select>
      <button id="saveCityBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>
    </div>
    <div style="margin-top:8px"><button id="openProfile" class="btn">–ü—Ä–æ—Ñ–∏–ª—å</button></div>
  </div>
</div></section>

<!-- –ü—Ä–æ—Ñ–∏–ª—å -->
<section id="profileScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ü—Ä–æ—Ñ–∏–ª—å</h3><button onclick="closeScreen('profileScreen'); openScreen('settingsModal');" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div id="profileWrap" style="margin-top:12px"></div>
</div></section>

<!-- –¢–µ–º—ã (—Å–∫—Ä–æ–ª–ª–µ—Ä) -->
<section id="themesScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–¢–µ–º—ã</h3><button onclick="closeScreen('themesScreen')" class="btn ghost">–ù–∞–∑–∞–¥</button></div>
  <div style="margin-top:12px; max-height:66vh; overflow:auto; display:grid; gap:8px;">
    <div class="btn theme-opt" data-theme="violet">–§–∏–æ–ª–µ—Ç</div>
    <div class="btn theme-opt" data-theme="navy">–ù—ç–π–≤–∏</div>
    <div class="btn theme-opt" data-theme="emerald">–≠–º–µ—Ä–∞–ª–¥</div>
    <div class="btn theme-opt" data-theme="sunset">–°–∞–Ω—Å–µ—Ç</div>
    <div class="btn theme-opt" data-theme="lava">–õ–∞–≤–∞</div>
    <div class="btn theme-opt" data-theme="ocean">–û–∫–µ–∞–Ω</div>
    <div class="btn theme-opt" data-theme="paper" style="color:#0d1326;">Paper (—Å–≤–µ—Ç–ª–∞—è)</div>
    <div class="btn theme-opt" data-theme="cream" style="color:#2b1a10;">Cream (—Å–≤–µ—Ç–ª–∞—è)</div>
  </div>
</div></section>

<!-- –ö–æ—à–µ–ª—ë–∫ -->
<section id="walletScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0">–ö–æ—à–µ–ª—ë–∫</h3><button onclick="closeScreen('walletScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  <div id="walletWrap" style="margin-top:12px"></div>
</div></section>

<!-- –ß–∞—Ç –≥–æ—Ä–æ–¥–∞ -->
<section id="cityThreadScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞</h3>
    <button onclick="closeScreen('cityThreadScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div style="margin-top:12px;">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input id="cityPostText" class="input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –º—ã—Å–ª—å—é..." />
      <label class="btn"><input type="file" id="cityPostImage" accept="image/*" style="display:none">–§–æ—Ç–æ</label>
      <button id="cityPostSend" class="btn primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
    <div id="cityPosts" style="margin-top:12px;"></div>
  </div>
</div></section>

<!-- –†–µ–ø–æ—Å—Ç -->
<section id="repostScreen" class="screen"><div class="modal">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">–†–µ–ø–æ—Å—Ç –≤ —á–∞—Ç</h3>
    <button onclick="closeScreen('repostScreen')" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="repostList" style="margin-top:12px"></div>
</div></section>
<script>
/* ================== JSONBIN CLOUD ================== */
/* –í–Ω–∏–º–∞–Ω–∏–µ: –∫–ª—é—á –≤ –∫–ª–∏–µ–Ω—Ç–µ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–º–æ! –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –¥–µ–ª–∞–π—Ç–µ –ø—Ä–æ–∫—Å–∏. */
const JSONBIN = {
  BIN_ID: "6911fbe843b1c97be9a4dc97",
  MASTER_KEY: "$2a$10$tGtoDprB0qjFrz.cAvouWueOIGmsgCpArJqSirVeyyF/3KH1z52ZG",
  url(){ return `https://api.jsonbin.io/v3/b/${this.BIN_ID}`; },
  headers(){ return { "Content-Type":"application/json", "X-Master-Key": this.MASTER_KEY }; },
  async load(){
    const r = await fetch(this.url(), { headers: this.headers() });
    if(!r.ok) throw new Error("Cloud load failed");
    const j = await r.json();
    return j.record || {};
  },
  async save(payload){
    const r = await fetch(this.url(), { method:"PUT", headers: this.headers(), body: JSON.stringify(payload) });
    if(!r.ok) throw new Error("Cloud save failed");
    const j = await r.json();
    return j.record || payload;
  }
};

/* ================== KEYS / HELPERS ================== */
const LS_ORD='gid_orders_cloud', LS_CHAT='gid_chats_cloud', LS_ADS='gid_ads_cloud', LS_PROFILE='gid_profile_v1',
      LS_ROLE='gid_role_v1', LS_CITY='gid_city_v1', LS_NOTIF='gid_notif_v1', LS_WALLET='gid_wallet_v1',
      LS_THEME='gid_theme_v1', LS_CITY_FEED='gid_city_feed_cloud';

const $=id=>document.getElementById(id);
const uid=()=>Math.random().toString(36).slice(2,9);
const nowISO=()=>new Date().toISOString();
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
const displayName=p=>{ if(!p) return '–ì–æ—Å—Ç—å'; const nm=[p.firstName||'', p.lastName||''].join(' ').trim() || p.name || ''; return nm || (p.login||'–ì–æ—Å—Ç—å'); };
const initials=name=>{ if(!name) return '?'; const a=String(name).trim().split(/\s+/); return a.map(x=>x[0]).slice(0,2).join('').toUpperCase(); };

function renderAvatar(el, name, type, data){
  el.innerHTML=''; el.style.background='';
  if(type==='image' && data){ const img=document.createElement('img'); img.src=data; img.alt='avatar'; el.appendChild(img); return; }
  if(type==='emoji' && data){ el.textContent=data; el.style.fontSize='22px'; el.style.lineHeight='40px'; el.style.background='linear-gradient(135deg,#a970ff,#32ffd2)'; return; }
  const pal=['#a970ff','#6a8cff','#32ffd2','#61e6ff','#ffaa6b']; let h=0; for(let i=0;i<(name||'').length;i++)h+=name.charCodeAt(i);
  const a=pal[h%pal.length], b=pal[(h+1)%pal.length]; el.style.background=`linear-gradient(135deg, ${a}, ${b})`; el.textContent=initials(name||'');
}

/* ================== STORE ================== */
const Store={
  getOrders(){try{return JSON.parse(localStorage.getItem(LS_ORD))||[]}catch(e){return[]}}, setOrders(v){localStorage.setItem(LS_ORD,JSON.stringify(v))},
  getChats(){try{return JSON.parse(localStorage.getItem(LS_CHAT))||[]}catch(e){return[]}}, setChats(v){localStorage.setItem(LS_CHAT,JSON.stringify(v))},
  getAds(){try{return JSON.parse(localStorage.getItem(LS_ADS))||[]}catch(e){return[]}}, setAds(v){localStorage.setItem(LS_ADS,JSON.stringify(v))},
  getProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE))||null}catch(e){return null}}, setProfile(p){localStorage.setItem(LS_PROFILE,JSON.stringify(p))},
  getRole(){return localStorage.getItem(LS_ROLE)||'user'}, setRole(r){localStorage.setItem(LS_ROLE,r)},
  getCity(){return localStorage.getItem(LS_CITY)||''}, setCity(c){localStorage.setItem(LS_CITY,c)},
  getNotifs(){try{return JSON.parse(localStorage.getItem(LS_NOTIF))||[]}catch(e){return[]}}, setNotifs(a){localStorage.setItem(LS_NOTIF,JSON.stringify(a))},
  getWallet(){try{return JSON.parse(localStorage.getItem(LS_WALLET))||{balance:0,ops:[]}}catch(e){return{balance:0,ops:[]}}}, setWallet(w){localStorage.setItem(LS_WALLET,JSON.stringify(w))},
  getTheme(){return localStorage.getItem(LS_THEME)||'violet'}, setTheme(t){localStorage.setItem(LS_THEME,t)},
  getCityFeed(){try{return JSON.parse(localStorage.getItem(LS_CITY_FEED))||{}}catch(e){return{}}}, setCityFeed(obj){localStorage.setItem(LS_CITY_FEED,JSON.stringify(obj))}
};

/* ================== CLOUD SYNC (orders, ads, city feed) ================== */
async function cloudLoad(){
  try{
    const cloud = await JSONBIN.load();
    const me=Store.getProfile();
    if(Array.isArray(cloud.orders)) Store.setOrders(cloud.orders);
    if(Array.isArray(cloud.ads)) Store.setAds(cloud.ads);
    if(cloud.cityFeed && typeof cloud.cityFeed==='object') Store.setCityFeed(cloud.cityFeed);
    renderAfterData();
  }catch(e){ console.warn('Cloud load error', e); }
}
async function cloudSave(){
  try{
    const payload={
      orders: Store.getOrders(),
      ads: Store.getAds(),
      cityFeed: Store.getCityFeed()
    };
    await JSONBIN.save(payload);
  }catch(e){ console.warn('Cloud save error', e); }
}

/* ================== UI BASICS ================== */
function openScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const el=$(id); if(el) el.classList.add('active'); window.scrollTo(0,0); }
function closeScreen(id){ const el=$(id); if(el) el.classList.remove('active'); }
function applyTheme(){ document.documentElement.setAttribute('data-theme', Store.getTheme()); }
function updateCityLabel(){ $('topCity').textContent='–ì–æ—Ä–æ–¥: '+(Store.getCity()||'‚Äî'); }
function refreshNotifBadge(){ const n=Store.getNotifs().length; const b=$('notifBadge'); if(n>0){ b.style.display='flex'; b.textContent=n>99?'99+':String(n); } else b.style.display='none'; }
function pushNotif(n){ const arr=Store.getNotifs(); arr.unshift(n); Store.setNotifs(arr); refreshNotifBadge(); }

/* ================== ROLE & MENU ================== */
function setRoleLabels(){
  const role=Store.getRole();
  $('roleLabelUser').classList.toggle('active', role==='user');
  $('roleLabelWorker').classList.toggle('active', role==='worker');
  $('roleToggle').classList.toggle('on', role==='worker');
}
function menuBtn(id,title,note,extraClass){ const d=document.createElement('div'); d.id=id; d.className='menu-btn'+(extraClass?(' '+extraClass):''); d.setAttribute('role','button'); d.innerHTML=`<div class="title">${title}</div><div class="note">${note}</div>`; return d; }
function wireMainButtons(){
  const role=Store.getRole();
  const on=(id,fn)=>{ const el=$(id); if(el){ const clone=el.cloneNode(true); el.parentNode.replaceChild(clone,el); clone.addEventListener('click',fn); } };
  on('btnOrder',()=>{ if(role!=='user'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ ¬´–°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥¬ª.'); return; } openScreen('createScreen'); });
  on('btnFind',()=>{ if(role!=='worker'){ alert('–î–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–æ–ª–∏ ¬´–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞¬ª.'); return; } openScreen('findScreen'); renderFindList(); });
  on('btnMessenger',()=>{ openScreen('messengerScreen'); renderChats(); });
  on('btnWallet',()=>{ openScreen('walletScreen'); renderWallet(); });
  on('btnMine',()=>{ openScreen('mineScreen'); renderMineList(); });
  on('btnAds',()=>{ openScreen('adsScreen'); renderAds(); });
  on('btnCityThread',()=>{ openScreen('cityThreadScreen'); renderCityPosts(); });
}
function applyRoleUI(){
  setRoleLabels();
  const role=Store.getRole();
  const grid=$('menuGrid'); grid.innerHTML='';
  if(role==='user'){ // –°—Ñ–µ—Ä–∞ —É—Å–ª—É–≥
    grid.appendChild(menuBtn('btnOrder','–ó–ê–ö–ê–ó–ê–¢–¨','–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞','primary'));
    grid.appendChild(menuBtn('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π','violet'));
    grid.appendChild(menuBtn('btnReserve','–ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨','–°–ö–û–†–û','disabled'));
    grid.appendChild(menuBtn('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–í–∞—à–∏ –∑–∞—è–≤–∫–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  } else { // –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞
    grid.appendChild(menuBtn('btnFind','–ù–ê–ô–¢–ò –ó–ê–ö–ê–ó–´','–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π','primary'));
    grid.appendChild(menuBtn('btnAds','–û–ë–™–Ø–í–õ–ï–ù–ò–ï –£–°–õ–£–ì','–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π','violet'));
    grid.appendChild(menuBtn('btnCityThread','–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞','–õ–µ–Ω—Ç–∞ –∫–∞–∫ —Å–æ—Ü—Å–µ—Ç—å'));
    grid.appendChild(menuBtn('btnMine','–ú–æ–∏ –∑–∞–∫–∞–∑—ã','–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ/–º–æ–∏'));
    grid.appendChild(menuBtn('btnMessenger','–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä','–î–∏–∞–ª–æ–≥–∏'));
    grid.appendChild(menuBtn('btnWallet','–ö–æ—à–µ–ª—ë–∫','–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'));
  }
  wireMainButtons();
}

/* ================== NOTIFICATIONS ================== */
$('openNotifications').addEventListener('click',()=>{ openScreen('notificationsModal'); renderNotifs(); });
$('clearNotifications').addEventListener('click',()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')){ Store.setNotifs([]); renderNotifs(); refreshNotifBadge(); } });
function renderNotifs(){
  const list=$('notificationsList'); list.innerHTML='';
  const arr=Store.getNotifs();
  if(!arr.length){ list.innerHTML='<div class="small" style="padding:12px">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div>'; return; }
  arr.forEach((n,idx)=>{
    const node=document.createElement('div'); node.className='card'; node.style.cursor='pointer';
    node.innerHTML=`<div style="flex:1"><div style="font-weight:800">${esc(n.title)}</div><div class="small" style="margin-top:6px">${esc(n.body)}</div><div class="small" style="margin-top:8px">${new Date(n.ts).toLocaleString()}</div></div>`;
    node.addEventListener('click',()=>{ try{ routeByNotification(n); const a=Store.getNotifs(); a.splice(idx,1); Store.setNotifs(a); renderNotifs(); refreshNotifBadge(); }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å: '+e.message); } });
    list.appendChild(node);
  });
}
function routeByNotification(n){
  const p=n.payload||{};
  switch(n.type){
    case 'bid': closeScreen('notificationsModal'); openBidsModal(p.orderId); break;
    case 'accepted':
    case 'accepted_owner':
    case 'message':
    case 'admsg':
      closeScreen('notificationsModal'); openChatWindow(p.chatId); break;
    case 'created':
      closeScreen('notificationsModal'); openScreen('mineScreen'); renderMineList(); break;
    default: break;
  }
}

/* ================== FIND (worker) ================== */
function renderFindList(){
  const wrap=$('findList'); if(!wrap) return; wrap.innerHTML='';
  const city=Store.getCity(); let items=Store.getOrders().filter(o=>o.status==='open');
  const q=($('searchInput')?.value||'').toLowerCase().trim();
  if(q) items=items.filter(o=>[o.category,o.desc,o.city].join(' ').toLowerCase().includes(q));
  if(city) items=items.filter(o=>!o.city || o.city===city);
  if(!items.length){ wrap.innerHTML='<div class="small" style="padding:12px">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const card=document.createElement('div'); card.className='card';
    const left=document.createElement('div'); left.style.flex='0 0 40px';
    const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, o.ownerName||'–ó–∞–∫–∞–∑—á–∏–∫'); left.appendChild(av);
    const body=document.createElement('div'); body.style.flex='1';
    body.innerHTML=`<div style="font-weight:800">${esc(o.ownerName||'–ó–∞–∫–∞–∑—á–∏–∫')} ‚Ä¢ ${esc(o.city)} ‚Äî ‚Ç∏ ${Number(o.budget||0).toLocaleString('ru-RU')}</div>
                    <div class="small" style="margin-top:6px">${esc(o.category)} ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: ${o.datetime?.replace('T',' ')||''}</div>
                    <div style="margin-top:8px; white-space:pre-wrap">${esc(o.desc)}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
    const bidBtn=document.createElement('button'); bidBtn.className='btn pulse'; bidBtn.textContent='–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É'; bidBtn.addEventListener('click',()=>openBidDialog(o.id));
    actions.appendChild(bidBtn); body.appendChild(actions);
    card.appendChild(left); card.appendChild(body); wrap.appendChild(card);
  });
}
$('applySearch')?.addEventListener('click',()=>renderFindList());

/* ================== MINE ================== */
function renderMineList(){
  const wrap=$('mineList'); if(!wrap) return; wrap.innerHTML='';
  const profile=Store.getProfile();
  if(!profile){ wrap.innerHTML='<div class="small" style="padding:12px">–í–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å</div>'; return; }
  const items=Store.getOrders().filter(o=>o.ownerId===profile.id);
  if(!items.length){ wrap.innerHTML='<div class="small" style="padding:12px">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
  items.forEach(o=>{
    const card=document.createElement('div'); card.className='card';
    const left=document.createElement('div'); left.style.flex='0 0 40px'; const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, o.ownerName||displayName(profile), profile?.avatarType, profile?.avatarData); left.appendChild(av);
    const body=document.createElement('div'); body.style.flex='1';
    const bidsCount=(o.bids||[]).length; const statusLabel=o.status==='open'?'–û—Ç–∫—Ä—ã—Ç':o.status==='in_progress'?'–í –ø—Ä–æ—Ü–µ—Å—Å–µ':o.status==='done'?'–ó–∞–≤–µ—Ä—à–µ–Ω':'–û—Ç–º–µ–Ω–µ–Ω';
    body.innerHTML=`<div style="font-weight:800">${esc(o.category)} ‚Ä¢ ${esc(o.city)} ${bidsCount?(' ‚Ä¢ <span style="color:#ff9bb0">'+bidsCount+' –∑–∞—è–≤–æ–∫</span>'):''}</div>
                    <div class="small" style="margin-top:6px">–°—Ç–∞—Ç—É—Å: ${statusLabel} ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: ${o.datetime?.replace('T',' ')||''}</div>
                    <div style="margin-top:8px; white-space:pre-wrap">${esc(o.desc)}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
    if(o.status==='open'){ const viewBtn=document.createElement('button'); viewBtn.className='btn pulse'; viewBtn.textContent='–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏'; viewBtn.addEventListener('click',()=>openBidsModal(o.id)); actions.appendChild(viewBtn); }
    if(o.status==='in_progress'){ const openChatBtn=document.createElement('button'); openChatBtn.className='btn'; openChatBtn.textContent='–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç'; openChatBtn.addEventListener('click',()=>{ const chat=Store.getChats().find(c=>c.orderId===o.id); if(chat){ openChatWindow(chat.id); } else alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); }); actions.appendChild(openChatBtn); }
    body.appendChild(actions); card.appendChild(left); card.appendChild(body); wrap.appendChild(card);
  });
}

/* ================== BIDS ================== */
function openBidsModal(orderId){
  const order=Store.getOrders().find(x=>x.id===orderId); if(!order) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  openScreen('bidsModal'); const list=$('bidsList'); list.innerHTML='';
  const header=document.createElement('div'); header.innerHTML=`<div style="font-weight:800">${esc(order.category)} ‚Ä¢ ${esc(order.city)}</div><div class="small">–ó–∞–∫–∞–∑—á–∏–∫: ${esc(order.ownerName)}</div>`; list.appendChild(header);
  const bids=order.bids||[]; if(!bids.length){ list.innerHTML+='<div class="small" style="padding:12px">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
  bids.forEach((b,idx)=>{
    const row=document.createElement('div'); row.className='card';
    const left=document.createElement('div'); left.style.flex='0 0 40px'; const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, b.name||'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'); left.appendChild(av);
    const body=document.createElement('div'); body.style.flex='1';
    body.innerHTML=`<div style="font-weight:800">${esc(b.name)} ‚Äî ‚Ç∏ ${Number(b.price).toLocaleString('ru-RU')}</div>
                    <div class="small" style="margin-top:6px">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–æ: ${new Date(b.createdAt||'').toLocaleString()}</div>
                    <div style="margin-top:8px; white-space:pre-wrap">${esc(b.comment||'')}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
    const accept=document.createElement('button'); accept.className='btn primary pulse'; accept.textContent='–ü—Ä–∏–Ω—è—Ç—å';
    accept.addEventListener('click',async ()=>{
      // –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ + —á–∞—Ç
      const ords=Store.getOrders().map(o=>{
        if(o.id===orderId){ o.status='in_progress'; o.assigned={performerId:b.performerId, performerName:b.name, price:b.price}; }
        return o;
      });
      Store.setOrders(ords);
      const chat={ id:'chat_'+uid(), orderId, title:`${order.category}`, participants:[order.ownerId,b.performerId],
        participantsMeta:{ [order.ownerId]:{id:order.ownerId,name:order.ownerName}, [b.performerId]:{id:b.performerId,name:b.name} },
        meta:{ownerName:order.ownerName, performerName:b.name, context:`${order.category} ‚Ä¢ ${order.city}`},
        messages:[{from:'system', text:`–ß–∞—Ç —Å–æ–∑–¥–∞–Ω –ø–æ –∑–∞–∫–∞–∑—É`, ts: nowISO()}],
        unread:{[order.ownerId]:0,[b.performerId]:1} };
      const chats=Store.getChats(); chats.unshift(chat); Store.setChats(chats);
      pushNotif({ id:'n_'+uid(), type:'accepted', title:'–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞', body:`–û—Ç–∫—Ä—ã—Ç —á–∞—Ç –ø–æ –∑–∞–∫–∞–∑—É "${order.category}"`, payload:{chatId:chat.id, orderId}, ts:nowISO() });
      pushNotif({ id:'n_'+uid(), type:'accepted_owner', title:'–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É', body:`–û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å ${b.name}`, payload:{chatId:chat.id, orderId}, ts:nowISO() });
      await cloudSave();
      closeScreen('bidsModal'); openChatWindow(chat.id); renderMineList(); renderFindList();
    });
    const decline=document.createElement('button'); decline.className='btn'; decline.textContent='–û—Ç–∫–∞–∑–∞—Ç—å';
    decline.addEventListener('click',async ()=>{ const upd=Store.getOrders().map(o=>{ if(o.id===orderId){ o.bids=(o.bids||[]).filter((_,i)=>i!==idx) } return o; }); Store.setOrders(upd); openBidsModal(orderId); renderMineList(); await cloudSave(); });
    actions.appendChild(accept); actions.appendChild(decline); body.appendChild(actions);
    row.appendChild(left); row.appendChild(body); list.appendChild(row);
  });
}

/* –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É */
function openBidDialog(orderId){
  const order=Store.getOrders().find(o=>o.id===orderId); if(!order) return;
  const profile=Store.getProfile()||{id:'u_demo', name:'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'};
  if(order.ownerId===profile.id){ alert('–ù–µ–ª—å–∑—è –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ü–µ–Ω—É –Ω–∞ —Å–≤–æ–π –∑–∞–∫–∞–∑'); return; }
  const price=prompt('–í–∞—à–∞ —Ü–µ–Ω–∞ (‚Ç∏):','1000'); if(!price) return;
  const comment=prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Å—Ä–æ–∫–∏, –¥–µ—Ç–∞–ª–∏):','–ì–æ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞ 2 —á–∞—Å–∞')||'';
  const upd=Store.getOrders().map(o=>{
    if(o.id===orderId){ if(!Array.isArray(o.bids)) o.bids=[]; o.bids.push({price:Number(price),name:displayName(profile), performerId:profile.id, comment, createdAt:nowISO()}); }
    return o;
  });
  Store.setOrders(upd);
  pushNotif({ id:'n_'+uid(), type:'bid', title:'–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', body:`–ù–∞ –≤–∞—à –∑–∞–∫–∞–∑ "${order.category}" –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ ${price}‚Ç∏`, payload:{orderId: order.id}, ts:nowISO() });
  alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
  renderFindList();
  cloudSave();
}

/* ================== CHATS ================== */
function otherMeta(chat){
  const me=(Store.getProfile()?.id)||'u_demo';
  const otherId=(chat.participants||[]).find(p=>p!==me);
  const meta=chat.participantsMeta?.[otherId] || {id:otherId, name: chat.meta?.performerName || chat.meta?.ownerName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'};
  return meta;
}
function chatSubtitle(chat){
  if(chat.orderId) return chat.meta?.context || `–ó–∞–∫–∞–∑ ‚Ä¢ ${chat.title}`;
  if((chat.title||'').startsWith('–û–±—ä—è–≤–ª–µ–Ω–∏–µ:')) return chat.title;
  return chat.title || '–ß–∞—Ç';
}
function renderChats(){
  const wrap=$('chatsList'); wrap.innerHTML='';
  const chats=Store.getChats(); const me=(Store.getProfile()?.id)||'u_demo';
  if(!chats.length){ wrap.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>'; return; }
  chats.forEach(c=>{
    const unread=(c.unread&&me)?(c.unread[me]||0):0;
    const card=document.createElement('div'); card.className='card chat-item'; card.dataset.chatId=c.id;
    const left=document.createElement('div'); left.style.flex='0 0 40px';
    const av=document.createElement('div'); av.className='avatar';
    const om=otherMeta(c); renderAvatar(av, om.name, om.avatarType, om.avatarData); left.appendChild(av);
    const body=document.createElement('div'); body.style.flex='1';
    body.innerHTML=`
      <div style="display:flex; align-items:center; gap:8px">
        <div style="font-weight:800; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${esc(om.name)}</div>
        ${unread?`<div class="chat-badge">${unread}</div>`:''}
      </div>
      <div class="small" style="margin-top:6px">${esc(chatSubtitle(c))}</div>`;
    card.appendChild(left); card.appendChild(body);
    card.addEventListener('click',()=>openChatWindow(c.id));
    wrap.appendChild(card);
  });
}

let __currentChatId=null, __attachDataUrl=null;
function openChatWindow(chatId){
  const chat=Store.getChats().find(c=>c.id===chatId); if(!chat){ alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  __currentChatId=chatId; __attachDataUrl=null; $('chatAttach').value='';
  const om=otherMeta(chat);
  renderAvatar($('chatWinAvatar'), om.name, om.avatarType, om.avatarData);
  $('chatWinTitle').textContent=om.name;
  $('chatWinSub').textContent=chatSubtitle(chat);
  const msgsEl=$('chatWinMsgs'); msgsEl.innerHTML='';
  const meId=(Store.getProfile()?.id)||'u_demo';

  (chat.messages||[]).forEach(m=>{
    if(m.from==='system' || m.fromId==='system'){ const d=document.createElement('div'); d.className='msg-system'; d.textContent=m.text; msgsEl.appendChild(d); return; }
    const mine = (m.fromId? m.fromId===meId : m.from==='me');
    const row=document.createElement('div'); row.className='msg-row'+(mine?' msg-me':' msg-other');
    const bubble=document.createElement('span'); bubble.className='b'; bubble.textContent=m.text||'';
    row.appendChild(bubble);
    if(m.image){ const img=document.createElement('img'); img.src=m.image; img.alt='attach'; img.className='msg-img'; if(mine) img.style.marginLeft='auto'; row.appendChild(img); }
    msgsEl.appendChild(row);
  });
  msgsEl.scrollTop=msgsEl.scrollHeight;

  // —Å–±—Ä–æ—Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  const upd=Store.getChats().map(c=>{ if(c.id===chatId){ c.unread||(c.unread={}); c.unread[meId]=0; } return c; });
  Store.setChats(upd);

  $('chatWinSend').onclick=sendChatMessage;
  $('chatWinInput').onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChatMessage(); } };
  $('chatAttach').onchange=(e)=>{
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ __attachDataUrl=r.result; alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ'); }; r.readAsDataURL(f);
  };
  openScreen('chatWindow');
}
function sendChatMessage(){
  const input=$('chatWinInput'); const v=input.value.trim(); if(!v && !__attachDataUrl || !__currentChatId) return;
  const me=Store.getProfile()||{id:'u_demo', name:'–í—ã'}; const meId=me.id;
  const chats=Store.getChats().map(c=>{
    if(c.id===__currentChatId){
      c.participantsMeta||(c.participantsMeta={}); c.participantsMeta[meId]=me;
      c.messages.push({fromId:meId, text:v, image: __attachDataUrl||null, ts: nowISO()});
      const otherId=(c.participants||[]).find(p=>p!==meId);
      if(otherId){ c.unread||(c.unread={}); c.unread[otherId]=(c.unread[otherId]||0)+1; }
    }
    return c;
  });
  Store.setChats(chats);
  pushNotif({ id:'n_'+uid(), type:'message', title:'–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', body:`–°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ "${chatSubtitle(Store.getChats().find(c=>c.id===__currentChatId)||{})}"`, payload:{chatId:__currentChatId}, ts:nowISO() });
  input.value=''; __attachDataUrl=null; $('chatAttach').value='';
  openChatWindow(__currentChatId);
  renderChats();
}

/* ================== ADS ================== */
function renderAds(){
  const ads=Store.getAds(); const wrap=$('adsList'); wrap.innerHTML=''; if(!ads.length) wrap.innerHTML='<div class="small" style="padding:12px">–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
  ads.forEach(ad=>{
    const card=document.createElement('div'); card.className='card';
    const left=document.createElement('div'); left.style.flex='0 0 40px'; const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, ad.authorName||'?', ad.authorAvatarType, ad.authorAvatarData); left.appendChild(av);
    const body=document.createElement('div'); body.style.flex='1';
    body.innerHTML=`<div style="font-weight:800">${esc(ad.title)}</div><div class="small" style="margin-top:6px">${esc(ad.price?('‚Ç∏ '+ad.price):'')}</div><div style="margin-top:8px; white-space:pre-wrap">${esc(ad.desc)}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
    const contactBtn=document.createElement('button'); contactBtn.className='btn'; contactBtn.textContent='–°–≤—è–∑–∞—Ç—å—Å—è';
    contactBtn.addEventListener('click',()=>{
      const profile=Store.getProfile()||{id:'u_demo', name:'–î–µ–º–æ'};
      const chat={ id:'chat_'+uid(), orderId:null, title:`–û–±—ä—è–≤–ª–µ–Ω–∏–µ: ${ad.title}`, participants:[profile.id, ad.authorId||'u_ad_owner'],
        participantsMeta:{ [profile.id]:profile, [ad.authorId||'u_ad_owner']:{id:ad.authorId||'u_ad_owner', name:ad.authorName||'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', avatarType:ad.authorAvatarType, avatarData:ad.authorAvatarData } },
        meta:{ ownerName:displayName(profile), performerName:ad.authorName||'–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', context:`–û–±—ä—è–≤–ª–µ–Ω–∏–µ: ${ad.title}` },
        messages:[{from:'system', text:`–ß–∞—Ç —Å–æ–∑–¥–∞–Ω –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é`, ts:nowISO()}],
        unread:{[profile.id]:0,[ad.authorId||'u_ad_owner']:1} };
      const chats=Store.getChats(); chats.unshift(chat); Store.setChats(chats);
      pushNotif({ id:'n_'+uid(), type:'admsg', title:'–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é', body:`–ü–æ—Å—Ç—É–ø–∏–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ "${ad.title}"`, payload:{chatId:chat.id, adId:ad.id}, ts:nowISO() });
      openChatWindow(chat.id);
    });
    const phoneBtn=document.createElement('button'); phoneBtn.className='btn'; phoneBtn.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç'; phoneBtn.addEventListener('click',()=>alert(ad.phone?('–¢–µ–ª–µ—Ñ–æ–Ω: '+ad.phone):'–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'));
    actions.appendChild(contactBtn); actions.appendChild(phoneBtn); body.appendChild(actions); card.appendChild(left); card.appendChild(body); wrap.appendChild(card);
  });
}
function renderMyAds(){
  const myAdsWrap=$('myAdsList'); myAdsWrap.innerHTML=''; const profile=Store.getProfile();
  if(!profile){ myAdsWrap.innerHTML='<div class="small" style="padding:12px">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>'; return; }
  const my=Store.getAds().filter(a=>a.authorId===profile.id);
  if(!my.length){ myAdsWrap.innerHTML='<div class="small" style="padding:12px">–£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>'; return; }
  my.forEach(ad=>{
    const card=document.createElement('div'); card.className='card';
    const left=document.createElement('div'); left.style.flex='0 0 40px'; const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, ad.authorName||displayName(profile), profile.avatarType, profile.avatarData); left.appendChild(av);
    const body=document.createElement('div'); body.style.flex='1';
    body.innerHTML=`<div style="font-weight:800">${esc(ad.title)}</div><div class="small" style="margin-top:6px">${esc(ad.price?('‚Ç∏ '+ad.price):'')}</div><div style="margin-top:8px; white-space:pre-wrap">${esc(ad.desc)}</div>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
    const edit=document.createElement('button'); edit.className='btn'; edit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; edit.onclick=()=>editAd(ad.id);
    const del=document.createElement('button'); del.className='btn'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.onclick=async ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')){ Store.setAds(Store.getAds().filter(x=>x.id!==ad.id)); renderMyAds(); await cloudSave(); } };
    actions.appendChild(edit); actions.appendChild(del); body.appendChild(actions);
    card.appendChild(left); card.appendChild(body); myAdsWrap.appendChild(card);
  });
}
$('myAdsOpenBtn').addEventListener('click',()=>{ openScreen('myAdsScreen'); renderMyAds(); });
$('createAdBtn')?.addEventListener('click',()=>{ const p=Store.getProfile(); if(!p) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); openScreen('adCreateModal'); });
$('adForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const title=$('adTitle').value.trim(), desc=$('adDesc').value.trim(), phone=$('adPhone').value.trim(), price=$('adPrice').value.trim();
  if(!title) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  const profile=Store.getProfile()||{id:'u_demo', name:'–î–µ–º–æ'};
  const ad={id:'ad_'+uid(), title, desc, phone, price, authorId: profile.id, authorName: displayName(profile), authorAvatarType:profile.avatarType, authorAvatarData:profile.avatarData, createdAt: nowISO()};
  const arr=Store.getAds(); arr.unshift(ad); Store.setAds(arr);
  alert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ'); closeScreen('adCreateModal'); renderAds(); await cloudSave();
});
function editAd(adId){
  const ad=Store.getAds().find(a=>a.id===adId); if(!ad) return;
  openScreen('adCreateModal'); $('adTitle').value=ad.title; $('adDesc').value=ad.desc; $('adPhone').value=ad.phone||''; $('adPrice').value=ad.price||'';
  $('adForm').onsubmit=async ev=>{ ev.preventDefault(); ad.title=$('adTitle').value.trim(); ad.desc=$('adDesc').value.trim(); ad.phone=$('adPhone').value.trim(); ad.price=$('adPrice').value.trim(); Store.setAds(Store.getAds().map(x=>x.id===ad.id?ad:x)); alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ'); $('adForm').onsubmit=null; closeScreen('adCreateModal'); renderAds(); await cloudSave(); };
}

/* ================== CREATE ORDER ================== */
const CATEGORY_HINTS={
  '–°–ü–ï–¶. –ó–ê–ö–ê–ó':'–û–ø–∏—à–∏—Ç–µ –ª—é–±—É—é –∑–∞–¥–∞—á—É: —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –≥–¥–µ, —Å—Ä–æ–∫–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è.',
  '–¢–∞–∫—Å–∏':'–£–∫–∞–∂–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç: –û—Ç–∫—É–¥–∞ ‚Üí –ö—É–¥–∞, –≤—Ä–µ–º—è –ø–æ–¥–∞—á–∏, –ø–∞—Å—Å–∞–∂–∏—Ä—ã/–±–∞–≥–∞–∂.',
  '–ö—É—Ä—å–µ—Ä':'–ß—Ç–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å, –æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞, –≤–µ—Å/–≥–∞–±–∞—Ä–∏—Ç—ã, –≤—Ä–µ–º—è.',
  '–î–æ—Å—Ç–∞–≤–∫–∞':'–ß—Ç–æ –∫—É–ø–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å, –∞–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞ –∏ –¥–æ—Å—Ç–∞–≤–∫–∏.',
  '–ê—Ä–µ–Ω–¥–∞/–ü—Ä–æ–¥–∞–∂–∞':'–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å: —Ä–∞–π–æ–Ω, –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã/—Å—Ä–æ–∫, –¥–µ—Ç–∞–ª–∏.',
  '–ú–∞—Å—Ç–µ—Ä':'–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ—á–∏–Ω–∏—Ç—å/—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –º–æ–¥–µ–ª—å, —Å–∏–º–ø—Ç–æ–º—ã, –∞–¥—Ä–µ—Å.',
  '–ü—Ä–æ—á–∏–µ':'–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–æ–¥—Ä–æ–±–Ω–æ, –≥–¥–µ –∏ –∫–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å.'
};
const CATEGORY_FIELDS={
  '–¢–∞–∫—Å–∏':()=>`
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input class="input" id="f-from" placeholder="–û—Ç–∫—É–¥–∞">
      <input class="input" id="f-to" placeholder="–ö—É–¥–∞">
    </div>`,
  '–ö—É—Ä—å–µ—Ä':()=>`
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input class="input" id="f-pick" placeholder="–ó–∞–±—Ä–∞—Ç—å (–∞–¥—Ä–µ—Å)">
      <input class="input" id="f-drop" placeholder="–î–æ—Å—Ç–∞–≤–∏—Ç—å (–∞–¥—Ä–µ—Å)">
    </div>`,
  '–î–æ—Å—Ç–∞–≤–∫–∞':()=>`
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input class="input" id="f-what" placeholder="–ß—Ç–æ –∫—É–ø–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å">
      <input class="input" id="f-daddr" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏">
    </div>`,
  '–ê—Ä–µ–Ω–¥–∞/–ü—Ä–æ–¥–∞–∂–∞':()=>`
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input class="input" id="f-district" placeholder="–†–∞–π–æ–Ω">
      <input class="input" id="f-period" placeholder="–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã / —Å—Ä–æ–∫ —Å–¥–µ–ª–∫–∏">
      <input class="input" id="f-rooms" placeholder="–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç">
    </div>`,
  '–ú–∞—Å—Ç–µ—Ä':()=>`
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input class="input" id="f-device" placeholder="–ß—Ç–æ —á–∏–Ω–∏—Ç—å/—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">
      <input class="input" id="f-model" placeholder="–ú–æ–¥–µ–ª—å/–¥–µ—Ç–∞–ª–∏">
    </div>`
};
document.addEventListener('click',e=>{
  const t=e.target.closest('#createTabs .tab'); if(!t) return;
  document.querySelectorAll('#createTabs .tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const cat=t.dataset.val||t.textContent;
  $('c-desc').placeholder=CATEGORY_HINTS[cat] || CATEGORY_HINTS['–°–ü–ï–¶. –ó–ê–ö–ê–ó'];
  $('createExtraFields').innerHTML=(CATEGORY_FIELDS[cat]?.()||'');
});
$('createForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const profile=Store.getProfile(); if(!profile){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); openScreen('authScreen'); return; }
  const activeTab=document.querySelector('#createTabs .tab.active'); const cat=activeTab?.dataset.val||'–ü—Ä–æ—á–∏–µ';
  const desc=$('c-desc').value.trim(); const budget=Number($('c-budget').value||0); const datetime=$('c-datetime').value||'';
  if(!desc||!datetime){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É'); return; }
  let extra='';
  if(cat==='–¢–∞–∫—Å–∏'){ extra=`\n–ú–∞—Ä—à—Ä—É—Ç: ${($('f-from')?.value||'')} ‚Üí ${($('f-to')?.value||'')}`.trim(); }
  if(cat==='–ö—É—Ä—å–µ—Ä'){ extra=`\n–û—Ç–∫—É–¥–∞: ${($('f-pick')?.value||'')} ‚Üí –ö—É–¥–∞: ${($('f-drop')?.value||'')}`.trim(); }
  if(cat==='–î–æ—Å—Ç–∞–≤–∫–∞'){ extra=`\n–ß—Ç–æ: ${($('f-what')?.value||'')} ‚Ä¢ –ê–¥—Ä–µ—Å: ${($('f-daddr')?.value||'')}`.trim(); }
  if(cat==='–ê—Ä–µ–Ω–¥–∞/–ü—Ä–æ–¥–∞–∂–∞'){ extra=`\n–†–∞–π–æ–Ω: ${($('f-district')?.value||'')} ‚Ä¢ –ü–µ—Ä–∏–æ–¥: ${($('f-period')?.value||'')} ‚Ä¢ –ö–æ–º–Ω–∞—Ç: ${($('f-rooms')?.value||'')}`.trim(); }
  if(cat==='–ú–∞—Å—Ç–µ—Ä'){ extra=`\n–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${($('f-device')?.value||'')} ‚Ä¢ –ú–æ–¥–µ–ª—å/–¥–µ—Ç–∞–ª–∏: ${($('f-model')?.value||'')}`.trim(); }
  const fullDesc=desc+(extra?('\n'+extra):'');
  const order={id:'o_'+uid(), category:cat, desc:fullDesc, budget, datetime, city:Store.getCity()||'‚Äî', ownerId:profile.id, ownerName:displayName(profile), bids:[], status:'open', createdAt:nowISO()};
  const arr=Store.getOrders(); arr.unshift(order); Store.setOrders(arr);
  pushNotif({ id:'n_'+uid(), type:'created', title:'–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω', body:`–í–∞—à –∑–∞–∫–∞–∑ "${cat}" –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω`, payload:{orderId:order.id}, ts:nowISO() });
  closeScreen('createScreen'); renderMineList(); renderFindList();
  await cloudSave();
  alert('–ó–∞–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω');
});

/* ================== CITY THREAD (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö —á–µ—Ä–µ–∑ –æ–±–ª–∞–∫–æ) ================== */
let __cityImage=null, __repostPost=null;
$('cityPostImage').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ __cityImage=r.result; alert('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); }; r.readAsDataURL(f); });

function renderCityPosts(){
  const container=$('cityPosts'); container.innerHTML='';
  const city=Store.getCity()||'‚Äî';
  const feed=Store.getCityFeed(); const posts=(feed[city]||[]);
  if(!posts.length){ container.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>'; return; }
  posts.forEach(p=>{
    const card=document.createElement('div'); card.className='post-card'; card.dataset.postId=p.id;
    const name=p.authorName||'–ì–æ—Å—Ç—å';
    const meId=Store.getProfile()?.id;
    const top=`<div style="display:flex; gap:10px; align-items:center;">
      <div class="avatar" style="width:32px; height:32px;" id="postAv_${p.id}"></div>
      <div style="font-weight:800">${esc(name)}</div>
      <div class="small" style="margin-left:auto">${new Date(p.ts).toLocaleString()}</div>
      ${meId && meId===p.authorId ? '<button class="btn ghost" data-act="del" style="margin-left:8px">–£–¥–∞–ª–∏—Ç—å</button>' : ''}
    </div>`;
    card.innerHTML= top+
      `<div style="margin-top:8px; white-space:pre-wrap">${esc(p.text||'')}</div>`+
      (p.image?`<img class="post-img" src="${p.image}" alt="">`:'')+
      `<div class="post-actions">
        <button class="btn" data-act="like">‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è (<span data-likecount>${Object.keys(p.likes?.byUser||{}).length}</span>)</button>
        <button class="btn" data-act="comment">üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" data-act="repost">üîÅ –†–µ–ø–æ—Å—Ç</button>
      </div>
      <div class="comments" style="margin-top:8px; display:none">
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." />
          <button class="btn primary" data-act="sendComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div class="comments-list"></div>
      </div>`;
    container.appendChild(card);
    renderAvatar($('postAv_'+p.id), p.authorName, p.authorAvatarType, p.authorAvatarData);
    const list=card.querySelector('.comments-list');
    (p.comments||[]).forEach(c=>{
      const cEl=document.createElement('div'); cEl.className='comment';
      cEl.innerHTML=`<div style="display:flex; gap:8px; align-items:center;">
        <div class="avatar" style="width:24px; height:24px;" id="cav_${c.id}"></div>
        <div style="font-weight:800">${esc(c.authorName||'')}</div>
        <div class="small" style="margin-left:auto">${new Date(c.ts).toLocaleString()}</div>
      </div>
      <div style="margin-top:6px; white-space:pre-wrap">${esc(c.text)}</div>`;
      list.appendChild(cEl);
      renderAvatar($('cav_'+c.id), c.authorName, c.authorAvatarType, c.authorAvatarData);
    });
    card.addEventListener('click', async (e)=>{
      const btn=e.target.closest('[data-act]'); if(!btn) return;
      const act=btn.dataset.act;
      const city=Store.getCity()||'‚Äî';
      const feed=Store.getCityFeed(); const posts=(feed[city]||[]); const post=posts.find(x=>x.id===p.id); if(!post) return;
      const me=Store.getProfile(); const meId=me?.id;
      if(act==='like'){
        if(!post.likes) post.likes={byUser:{}};
        if(post.likes.byUser[meId]) delete post.likes.byUser[meId]; else post.likes.byUser[meId]=true;
        feed[city]=posts; Store.setCityFeed(feed); (await cloudSave());
        card.querySelector('[data-likecount]').textContent=Object.keys(post.likes.byUser).length;
      }else if(act==='comment'){
        const box=card.querySelector('.comments'); box.style.display=box.style.display==='none'?'block':'none';
      }else if(act==='sendComment'){
        const input=card.querySelector('.comments input'); const text=input.value.trim(); if(!text) return;
        const c={id:'c_'+uid(), authorId:meId, authorName: displayName(me), authorAvatarType:me?.avatarType, authorAvatarData:me?.avatarData, text, ts: nowISO()};
        (post.comments||(post.comments=[])).push(c); feed[city]=posts; Store.setCityFeed(feed); (await cloudSave());
        input.value=''; renderCityPosts();
      }else if(act==='repost'){
        __repostPost=p; openRepostPicker();
      }else if(btn.dataset.act==='del'){
        // —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä
        if(meId!==p.authorId) return;
        if(confirm('–£–¥–∞–ª–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é?')){ const idx=posts.findIndex(x=>x.id===p.id); posts.splice(idx,1); feed[city]=posts; Store.setCityFeed(feed); await cloudSave(); renderCityPosts(); }
      }
    });
  });
}
$('cityPostSend').addEventListener('click', async ()=>{
  const text=$('cityPostText').value.trim(); if(!text && !__cityImage) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
  const city=Store.getCity()||'‚Äî'; const feed=Store.getCityFeed(); const me=Store.getProfile();
  const post={ id:'post_'+uid(), authorId: me?.id, authorName: displayName(me), authorAvatarType:me?.avatarType, authorAvatarData:me?.avatarData, text, image: __cityImage||null, ts: nowISO(), likes:{byUser:{}}, comments:[] };
  feed[city]=[post].concat(feed[city]||[]); Store.setCityFeed(feed);
  $('cityPostText').value=''; __cityImage=null; await cloudSave(); renderCityPosts();
});

/* –†–µ–ø–æ—Å—Ç –≤ —á–∞—Ç */
function openRepostPicker(){
  openScreen('repostScreen');
  const list=$('repostList'); list.innerHTML='';
  const chats=Store.getChats();
  if(!chats.length){ list.innerHTML='<div class="small" style="padding:12px">–ù–µ—Ç —á–∞—Ç–æ–≤ –¥–ª—è —Ä–µ–ø–æ—Å—Ç–∞</div>'; return; }
  chats.forEach(c=>{
    const item=document.createElement('div'); item.className='card'; item.style.cursor='pointer';
    item.innerHTML=`<div style="font-weight:800">${esc(otherMeta(c).name)}</div><div class="small" style="margin-top:6px">${esc(chatSubtitle(c))}</div>`;
    item.addEventListener('click',()=>{ if(!__repostPost) return; repostToChat(c.id, __repostPost); closeScreen('repostScreen'); openChatWindow(c.id); });
    list.appendChild(item);
  });
}
function repostToChat(chatId, post){
  const meId=Store.getProfile()?.id || 'u_demo';
  const chats=Store.getChats().map(c=>{
    if(c.id===chatId){
      const snippet = `üîÅ –†–µ–ø–æ—Å—Ç –∏–∑ "–ß–∞—Ç —Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞" ‚Äî ${Store.getCity()||'‚Äî'}:\n${post.text||''}`;
      c.messages.push({ fromId:meId, text: snippet, ts: nowISO() });
      if(post.image){ c.messages.push({ fromId:meId, text:'[—Ñ–æ—Ç–æ]', image: post.image, ts: nowISO() }); }
      const other=(c.participants||[]).find(p=>p!==meId); if(other){ c.unread||(c.unread={}); c.unread[other]=(c.unread[other]||0)+1; }
    }
    return c;
  });
  Store.setChats(chats);
  pushNotif({ id:'n_'+uid(), type:'message', title:'–†–µ–ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', body:`–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç`, payload:{chatId}, ts:nowISO() });
}

/* ================== SETTINGS / PROFILE / WALLET ================== */
$('openSettings').addEventListener('click',()=>{ openScreen('settingsModal'); $('citySelect').value=Store.getCity()||''; });
$('saveCityBtn').addEventListener('click',async ()=>{ const v=$('citySelect').value.trim(); if(!v) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); Store.setCity(v); updateCityLabel(); await cloudSave(); alert('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); });
$('openProfile').addEventListener('click',()=>{ openScreen('profileScreen'); renderProfile(); });

$('openThemes').addEventListener('click',()=>openScreen('themesScreen'));
document.querySelectorAll('.theme-opt').forEach(btn=>btn.addEventListener('click',()=>{ Store.setTheme(btn.dataset.theme); applyTheme(); }));

function renderProfile(){
  const wrap=$('profileWrap'); wrap.innerHTML=''; const p=Store.getProfile();
  if(!p){ wrap.innerHTML='<div class="small">–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ</div>'; return; }
  const card=document.createElement('div'); card.className='card';
  const left=document.createElement('div'); left.style.flex='0 0 40px'; const av=document.createElement('div'); av.className='avatar'; renderAvatar(av, displayName(p), p.avatarType, p.avatarData); left.appendChild(av);
  const body=document.createElement('div'); body.style.flex='1';
  body.innerHTML=`
    <div style="font-weight:800">${esc(displayName(p))}</div>
    <div class="small" style="margin-top:6px">${esc(p.login||'')}</div>
    <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
      <label class="btn"><input type="file" id="avatarFile" accept="image/*" style="display:none">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
      <button class="btn" id="avatarEmojiBtn">–≠–º–æ–¥–∑–∏</button>
      <button class="btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>
    <div style="margin-top:16px; font-weight:800">–ê–Ω–∫–µ—Ç–∞</div>
    <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:8px; margin-top:8px;">
      <input id="pfName" class="input" placeholder="–ò–º—è" value="${esc(p.firstName||'')}">
      <input id="pfSurname" class="input" placeholder="–§–∞–º–∏–ª–∏—è" value="${esc(p.lastName||'')}">
      <input id="pfPhone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${esc(p.phone||'')}">
      <input id="pfCity" class="input" placeholder="–ì–æ—Ä–æ–¥" value="${esc(Store.getCity()||'')}">
    </div>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button class="btn primary" id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>`;
  card.appendChild(left); card.appendChild(body); wrap.appendChild(card);

  $('avatarFile').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const prof=Store.getProfile(); prof.avatarType='image'; prof.avatarData=r.result; Store.setProfile(prof); renderProfile(); }; r.readAsDataURL(f); });
  $('avatarEmojiBtn').addEventListener('click',()=>{ const emo=prompt('–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, üòé)'); if(!emo) return; const prof=Store.getProfile(); prof.avatarType='emoji'; prof.avatarData=emo; Store.setProfile(prof); renderProfile(); });
  $('logoutBtn').addEventListener('click',()=>{ if(confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')){ localStorage.removeItem(LS_PROFILE); closeScreen('profileScreen'); openScreen('authScreen'); }});
  $('saveProfileBtn').addEventListener('click',async ()=>{ const prof=Store.getProfile(); prof.firstName=$('pfName').value.trim(); prof.lastName=$('pfSurname').value.trim(); prof.phone=$('pfPhone').value.trim(); const city=$('pfCity').value.trim(); if(city){ Store.setCity(city); updateCityLabel(); } prof.name=(prof.firstName||prof.lastName)?[prof.firstName,prof.lastName].join(' ').trim():prof.name; Store.setProfile(prof); alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); renderProfile(); await cloudSave(); });
}

function renderWallet(){
  const wrap=$('walletWrap'); const w=Store.getWallet(); const p=Store.getProfile();
  wrap.innerHTML=`<div class="card"><div style="flex:1">
    <div style="font-weight:800; font-size:18px;">–ë–∞–ª–∞–Ω—Å: ‚Ç∏ ${Number(w.balance||0).toLocaleString('ru-RU')}</div>
    <div class="small" style="margin-top:6px">${esc(displayName(p)||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div>
    <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
      <button class="btn" id="wTopUp">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button class="btn" id="wTransfer">–ü–µ—Ä–µ–≤–æ–¥</button>
      <button class="btn" id="wWithdraw">–°–Ω—è—Ç—å</button>
    </div></div></div>
    <div style="margin-top:12px; font-weight:800">–û–ø–µ—Ä–∞—Ü–∏–∏</div>
    <div id="opsList" style="margin-top:8px;"></div>`;
  const opsList=$('opsList');
  if(!w.ops?.length){ opsList.innerHTML='<div class="small" style="padding:12px">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>'; }
  else{
    w.ops.slice(0,100).forEach(op=>{ const row=document.createElement('div'); row.className='post-card'; row.innerHTML=`<div><div style="font-weight:800">${esc(op.type)} ‚Ä¢ ‚Ç∏ ${Number(op.amount).toLocaleString('ru-RU')}</div><div class="small" style="margin-top:6px">${new Date(op.ts).toLocaleString()} ‚Äî ${esc(op.note||'')}</div></div>`; opsList.appendChild(row); });
  }
  $('wTopUp').onclick=()=>{ const amt=Number(prompt('–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚Ç∏):','1000')||0); if(amt<=0)return; const w=Store.getWallet(); w.balance=(w.balance||0)+amt; (w.ops||(w.ops=[])).unshift({type:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',amount:amt,ts:nowISO(),note:'–í–Ω–µ—Å–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤'}); Store.setWallet(w); renderWallet(); };
  $('wTransfer').onclick=()=>{ const to=prompt('–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–ª–æ–≥–∏–Ω/ID):','u_...'); if(!to)return; const amt=Number(prompt('–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ (‚Ç∏):','500')||0); if(amt<=0)return; const w=Store.getWallet(); if((w.balance||0)<amt){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; } w.balance-=amt; (w.ops||(w.ops=[])).unshift({type:'–ü–µ—Ä–µ–≤–æ–¥',amount:amt,ts:nowISO(),note:`–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${to}`}); Store.setWallet(w); pushNotif({id:'n_'+uid(), type:'wallet', title:'–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', body:`–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ ‚Ç∏ ${amt} –ø–æ–ª—É—á–∞—Ç–µ–ª—é ${to}`, payload:{}, ts:nowISO()}); renderWallet(); };
  $('wWithdraw').onclick=()=>{ const amt=Number(prompt('–°—É–º–º–∞ —Å–Ω—è—Ç–∏—è (‚Ç∏):','500')||0); if(amt<=0)return; const w=Store.getWallet(); if((w.balance||0)<amt){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; } w.balance-=amt; (w.ops||(w.ops=[])).unshift({type:'–°–Ω—è—Ç–∏–µ',amount:amt,ts:nowISO(),note:'–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤'}); Store.setWallet(w); renderWallet(); };
}

/* ================== AUTH ================== */
function initial(){
  applyTheme();
  updateCityLabel();
  refreshNotifBadge();
  if(!Store.getRole()) Store.setRole('user');
  applyRoleUI(); renderFindList(); renderMineList(); renderAds(); renderChats();
  if(!Store.getProfile()) openScreen('authScreen');
  cloudLoad();
}
$('authForm').addEventListener('submit',e=>{
  e.preventDefault();
  const login=$('authLogin').value.trim(), pass=$('authPass').value.trim(); if(!login||!pass) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
  const prof={id:'u_'+uid(), login, name:login.split('@')[0]||login, createdAt:nowISO()}; Store.setProfile(prof);
  alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); closeScreen('authScreen'); renderProfile(); initial();
});
$('registerBtn').addEventListener('click',()=>{ const email=prompt('Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:','user@example.com'); if(!email) return; const prof={id:'u_'+uid(), login:email, name:email.split('@')[0]||email, createdAt:nowISO()}; Store.setProfile(prof); alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ'); closeScreen('authScreen'); initial(); });

/* ================== ROLE TOGGLE ================== */
$('roleToggle').addEventListener('click',()=>{ const role=Store.getRole(); const next=role==='user'?'worker':'user'; Store.setRole(next); applyRoleUI(); });

/* ================== CITY REPOST PICKER ================== */
function renderAfterData(){ renderFindList(); renderMineList(); renderAds(); renderCityPosts(); }

/* ================== NOTIFS BTN (already wired) ================== */
$('openNotifications').addEventListener('click',()=>{ openScreen('notificationsModal'); renderNotifs(); });

/* ================== KICK OFF ================== */
initial();
</script>
</body>
</html>
